vdpa/mlx5: Enable user to add/delete vdpa device

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-331.el8
commit-author Eli Cohen <elic@nvidia.com>
commit 58926c8aab104daa49f35b9fcf664d95c22c8ac7
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-331.el8/58926c8a.failed

Allow to control vdpa device creation and destruction using the vdpa
management tool.

Examples:
1. List the management devices
$ vdpa mgmtdev show
pci/0000:3b:00.1:
  supported_classes net

2. Create vdpa instance
$ vdpa dev add mgmtdev pci/0000:3b:00.1 name vdpa0

3. Show vdpa devices
$ vdpa dev show
vdpa0: type network mgmtdev pci/0000:3b:00.1 vendor_id 5555 max_vqs 16 \
max_vq_size 256

	Signed-off-by: Eli Cohen <elic@nvidia.com>
	Reviewed-by: Parav Pandit <parav@nvidia.com>
	Acked-by: Jason Wang <jasowang@redhat.com>
Link: https://lore.kernel.org/r/20210408091320.4600-1-elic@nvidia.com
	Signed-off-by: Michael S. Tsirkin <mst@redhat.com>
(cherry picked from commit 58926c8aab104daa49f35b9fcf664d95c22c8ac7)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/vdpa/mlx5/net/mlx5_vnet.c
diff --cc drivers/vdpa/mlx5/net/mlx5_vnet.c
index 2c0e601e659c,25533db01f5f..000000000000
--- a/drivers/vdpa/mlx5/net/mlx5_vnet.c
+++ b/drivers/vdpa/mlx5/net/mlx5_vnet.c
@@@ -1986,7 -1999,7 +1995,11 @@@ static int mlx5_vdpa_dev_add(struct vdp
  	max_vqs = min_t(u32, max_vqs, MLX5_MAX_SUPPORTED_VQS);
  
  	ndev = vdpa_alloc_device(struct mlx5_vdpa_net, mvdev.vdev, mdev->device, &mlx5_vdpa_ops,
++<<<<<<< HEAD
 +				 2 * mlx5_vdpa_max_qps(max_vqs), NULL);
++=======
+ 				 name);
++>>>>>>> 58926c8aab10 (vdpa/mlx5: Enable user to add/delete vdpa device)
  	if (IS_ERR(ndev))
  		return PTR_ERR(ndev);
  
@@@ -2013,7 -2026,8 +2026,12 @@@
  	if (err)
  		goto err_res;
  
++<<<<<<< HEAD
 +	err = vdpa_register_device(&mvdev->vdev);
++=======
+ 	mvdev->vdev.mdev = &mgtdev->mgtdev;
+ 	err = _vdpa_register_device(&mvdev->vdev, 2 * mlx5_vdpa_max_qps(max_vqs));
++>>>>>>> 58926c8aab10 (vdpa/mlx5: Enable user to add/delete vdpa device)
  	if (err)
  		goto err_reg;
  
* Unmerged path drivers/vdpa/mlx5/net/mlx5_vnet.c
