gfs2: Use sb_start_intwrite in gfs2_ail_empty_gl

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-331.el8
commit-author Andreas Gruenbacher <agruenba@redhat.com>
commit 15e20a301ab06575482c7ab3b442a6830cec928e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-331.el8/15e20a30.failed

Commit 2e60d7683c8d ("GFS2: update freeze code to use freeze/thaw_super
on all nodes") optimized away the sb_start_intwrite ... sb_end_intwrite
protection for the on-stack transactions in gfs2_ail_empty_gl with no
explanation.  I can't think of a valid reason for doing that, so revert
that change.  This simplifies the next commit.

	Signed-off-by: Andreas Gruenbacher <agruenba@redhat.com>
(cherry picked from commit 15e20a301ab06575482c7ab3b442a6830cec928e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/gfs2/trans.c
diff --cc fs/gfs2/trans.c
index 35084a676633,ae040b570868..000000000000
--- a/fs/gfs2/trans.c
+++ b/fs/gfs2/trans.c
@@@ -100,10 -98,9 +100,16 @@@ void gfs2_trans_end(struct gfs2_sbd *sd
  
  	if (!test_bit(TR_TOUCHED, &tr->tr_flags)) {
  		gfs2_log_release(sdp, tr->tr_reserved);
++<<<<<<< HEAD
 +		if (alloced) {
 +			kfree(tr);
 +			sb_end_intwrite(sdp->sd_vfs);
 +		}
++=======
+ 		if (alloced)
+ 			gfs2_trans_free(sdp, tr);
+ 		sb_end_intwrite(sdp->sd_vfs);
++>>>>>>> 15e20a301ab0 (gfs2: Use sb_start_intwrite in gfs2_ail_empty_gl)
  		return;
  	}
  
diff --git a/fs/gfs2/glops.c b/fs/gfs2/glops.c
index ed31726a32f4..c894026b5407 100644
--- a/fs/gfs2/glops.c
+++ b/fs/gfs2/glops.c
@@ -128,9 +128,12 @@ static int gfs2_ail_empty_gl(struct gfs2_glock *gl)
          * on the stack */
 	tr.tr_reserved = 1 + gfs2_struct2blk(sdp, tr.tr_revokes, sizeof(u64));
 	tr.tr_ip = _RET_IP_;
+	sb_start_intwrite(sdp->sd_vfs);
 	ret = gfs2_log_reserve(sdp, tr.tr_reserved);
-	if (ret < 0)
+	if (ret < 0) {
+		sb_end_intwrite(sdp->sd_vfs);
 		return ret;
+	}
 	WARN_ON_ONCE(current->journal_info);
 	current->journal_info = &tr;
 
* Unmerged path fs/gfs2/trans.c
