gfs2: initialize transaction tr_ailX_lists earlier

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-331.el8
commit-author Bob Peterson <rpeterso@redhat.com>
commit cbcc89b630447ec7836aa2b9242d9bb1725f5a61
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-331.el8/cbcc89b6.failed

Since transactions may be freed shortly after they're created, before
a log_flush occurs, we need to initialize their ail1 and ail2 lists
earlier. Before this patch, the ail1 list was initialized in gfs2_log_flush().
This moves the initialization to the point when the transaction is first
created.

	Signed-off-by: Bob Peterson <rpeterso@redhat.com>
	Signed-off-by: Andreas Gruenbacher <agruenba@redhat.com>
(cherry picked from commit cbcc89b630447ec7836aa2b9242d9bb1725f5a61)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/gfs2/trans.c
diff --cc fs/gfs2/trans.c
index fba688d93b27,62a65ed9a9f5..000000000000
--- a/fs/gfs2/trans.c
+++ b/fs/gfs2/trans.c
@@@ -52,11 -49,11 +52,16 @@@ int gfs2_trans_begin(struct gfs2_sbd *s
  	if (blocks)
  		tr->tr_reserved += 6 + blocks;
  	if (revokes)
 -		tr->tr_reserved += gfs2_struct2blk(sdp, revokes);
 +		tr->tr_reserved += gfs2_struct2blk(sdp, revokes,
 +						   sizeof(u64));
  	INIT_LIST_HEAD(&tr->tr_databuf);
  	INIT_LIST_HEAD(&tr->tr_buf);
++<<<<<<< HEAD
 +	INIT_LIST_HEAD(&tr->tr_list);
++=======
+ 	INIT_LIST_HEAD(&tr->tr_ail1_list);
+ 	INIT_LIST_HEAD(&tr->tr_ail2_list);
++>>>>>>> cbcc89b63044 (gfs2: initialize transaction tr_ailX_lists earlier)
  
  	sb_start_intwrite(sdp->sd_vfs);
  
diff --git a/fs/gfs2/glops.c b/fs/gfs2/glops.c
index 7f45c3c2c845..76a2814c9b34 100644
--- a/fs/gfs2/glops.c
+++ b/fs/gfs2/glops.c
@@ -94,6 +94,8 @@ static int gfs2_ail_empty_gl(struct gfs2_glock *gl)
 	memset(&tr, 0, sizeof(tr));
 	INIT_LIST_HEAD(&tr.tr_buf);
 	INIT_LIST_HEAD(&tr.tr_databuf);
+	INIT_LIST_HEAD(&tr.tr_ail1_list);
+	INIT_LIST_HEAD(&tr.tr_ail2_list);
 	tr.tr_revokes = atomic_read(&gl->gl_ail_count);
 
 	if (!tr.tr_revokes) {
diff --git a/fs/gfs2/log.c b/fs/gfs2/log.c
index 60c486e0225a..e9728336f766 100644
--- a/fs/gfs2/log.c
+++ b/fs/gfs2/log.c
@@ -914,8 +914,6 @@ void gfs2_log_flush(struct gfs2_sbd *sdp, struct gfs2_glock *gl, u32 flags)
 	tr = sdp->sd_log_tr;
 	if (tr) {
 		sdp->sd_log_tr = NULL;
-		INIT_LIST_HEAD(&tr->tr_ail1_list);
-		INIT_LIST_HEAD(&tr->tr_ail2_list);
 		tr->tr_first = sdp->sd_log_flush_head;
 		if (unlikely (state == SFS_FROZEN))
 			if (gfs2_assert_withdraw_delayed(sdp,
* Unmerged path fs/gfs2/trans.c
