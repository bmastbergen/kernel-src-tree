powerpc/pseries/mobility: extract VASI session polling logic

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-331.el8
commit-author Nathan Lynch <nathanl@linux.ibm.com>
commit d9213319b84ee8393475c38361c84151d5c33415
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-331.el8/d9213319.failed

The behavior of rtas_ibm_suspend_me_unsafe() is to return -EAGAIN to
the caller until the specified VASI suspend session state makes the
transition from H_VASI_ENABLED to H_VASI_SUSPENDING. In the interest
of separating concerns to prepare for a new implementation of the
join/suspend sequence, extract VASI session polling logic into a
couple of local functions. Waiting for the session state to reach
H_VASI_SUSPENDING before calling rtas_ibm_suspend_me_unsafe() ensures
that we will never get an EAGAIN result necessitating a retry. No
user-visible change in behavior is intended.

	Signed-off-by: Nathan Lynch <nathanl@linux.ibm.com>
	Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: https://lore.kernel.org/r/20201207215200.1785968-12-nathanl@linux.ibm.com
(cherry picked from commit d9213319b84ee8393475c38361c84151d5c33415)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/powerpc/platforms/pseries/mobility.c
diff --cc arch/powerpc/platforms/pseries/mobility.c
index a1c6b96d4899,573ed48b43d8..000000000000
--- a/arch/powerpc/platforms/pseries/mobility.c
+++ b/arch/powerpc/platforms/pseries/mobility.c
@@@ -357,14 -416,11 +417,21 @@@ static ssize_t migration_store(struct c
  	if (rc)
  		return rc;
  
++<<<<<<< HEAD
 +	stop_topology_update();
 +
 +	do {
 +		rc = rtas_ibm_suspend_me_unsafe(streamid);
 +		if (rc == -EAGAIN)
 +			ssleep(1);
 +	} while (rc == -EAGAIN);
++=======
+ 	rc = wait_for_vasi_session_suspending(streamid);
+ 	if (rc)
+ 		return rc;
++>>>>>>> d9213319b84e (powerpc/pseries/mobility: extract VASI session polling logic)
  
+ 	rc = rtas_ibm_suspend_me_unsafe(streamid);
  	if (rc)
  		return rc;
  
* Unmerged path arch/powerpc/platforms/pseries/mobility.c
