NFSv4.1: nfs4_destroy_session must call rpc_destroy_waitqueue

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-123.el7
Rebuild_CHGLOG: - [fs] nfs: nfs4_destroy_session must call rpc_destroy_waitqueue (Steve Dickson) [1061707]
Rebuild_FUZZ: 96.61%
commit-author Trond Myklebust <trond.myklebust@primarydata.com>
commit 20b9a9024540a775395d5d1f41eec0ec6ec41f9b
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-123.el7/20b9a902.failed

There may still be timers active on the session waitqueues. Make sure
that we kill them before freeing the memory.

	Cc: stable@vger.kernel.org # 3.12+
	Signed-off-by: Trond Myklebust <trond.myklebust@primarydata.com>
(cherry picked from commit 20b9a9024540a775395d5d1f41eec0ec6ec41f9b)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/nfs/nfs4session.c
diff --cc fs/nfs/nfs4session.c
index e0bf666c4c29,e799dc3c3b1d..000000000000
--- a/fs/nfs/nfs4session.c
+++ b/fs/nfs/nfs4session.c
@@@ -420,9 -431,7 +429,13 @@@ void nfs41_update_target_slotid(struct 
  	spin_unlock(&tbl->slot_tbl_lock);
  }
  
++<<<<<<< HEAD
 +#if defined(CONFIG_NFS_V4_1)
 +
 +static void nfs4_destroy_session_slot_tables(struct nfs4_session *session)
++=======
+ static void nfs4_release_session_slot_tables(struct nfs4_session *session)
++>>>>>>> 20b9a9024540 (NFSv4.1: nfs4_destroy_session must call rpc_destroy_waitqueue)
  {
  	nfs4_release_slot_table(&session->fc_slot_table);
  	nfs4_release_slot_table(&session->bc_slot_table);
diff --git a/fs/nfs/nfs4client.c b/fs/nfs/nfs4client.c
index 2b9bfbaab504..4c7a4f4a4da1 100644
--- a/fs/nfs/nfs4client.c
+++ b/fs/nfs/nfs4client.c
@@ -169,7 +169,7 @@ void nfs41_shutdown_client(struct nfs_client *clp)
 void nfs40_shutdown_client(struct nfs_client *clp)
 {
 	if (clp->cl_slot_tbl) {
-		nfs4_release_slot_table(clp->cl_slot_tbl);
+		nfs4_shutdown_slot_table(clp->cl_slot_tbl);
 		kfree(clp->cl_slot_tbl);
 	}
 }
* Unmerged path fs/nfs/nfs4session.c
diff --git a/fs/nfs/nfs4session.h b/fs/nfs/nfs4session.h
index bfb0fe38f024..3f0b3d1b1c4c 100644
--- a/fs/nfs/nfs4session.h
+++ b/fs/nfs/nfs4session.h
@@ -74,7 +74,7 @@ enum nfs4_session_state {
 
 extern int nfs4_setup_slot_table(struct nfs4_slot_table *tbl,
 		unsigned int max_reqs, const char *queue);
-extern void nfs4_release_slot_table(struct nfs4_slot_table *tbl);
+extern void nfs4_shutdown_slot_table(struct nfs4_slot_table *tbl);
 extern struct nfs4_slot *nfs4_alloc_slot(struct nfs4_slot_table *tbl);
 extern void nfs4_free_slot(struct nfs4_slot_table *tbl, struct nfs4_slot *slot);
 extern void nfs4_slot_tbl_drain_complete(struct nfs4_slot_table *tbl);
