ipv6 addrconf: add IFA_F_NOPREFIXROUTE flag to suppress creation of IP6 routes

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-123.el7
Rebuild_CHGLOG: - [net] ipv6: addrconf: add IFA_F_NOPREFIXROUTE flag to suppress creation of IP6 routes (Jiri Pirko) [1052884]
Rebuild_FUZZ: 99.36%
commit-author Thomas Haller <thaller@redhat.com>
commit 761aac737eb11901c382a3f021dead59a26983fc
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-123.el7/761aac73.failed

When adding/modifying an IPv6 address, the userspace application needs
a way to suppress adding a prefix route. This is for example relevant
together with IFA_F_MANAGERTEMPADDR, where userspace creates autoconf
generated addresses, but depending on on-link, no route for the
prefix should be added.

	Signed-off-by: Thomas Haller <thaller@redhat.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 761aac737eb11901c382a3f021dead59a26983fc)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	include/uapi/linux/if_addr.h
#	net/ipv6/addrconf.c
diff --cc include/uapi/linux/if_addr.h
index 23357ab81a77,dea10a87dfd1..000000000000
--- a/include/uapi/linux/if_addr.h
+++ b/include/uapi/linux/if_addr.h
@@@ -44,6 -48,8 +44,11 @@@ enum 
  #define IFA_F_DEPRECATED	0x20
  #define IFA_F_TENTATIVE		0x40
  #define IFA_F_PERMANENT		0x80
++<<<<<<< HEAD
++=======
+ #define IFA_F_MANAGETEMPADDR	0x100
+ #define IFA_F_NOPREFIXROUTE	0x200
++>>>>>>> 761aac737eb1 (ipv6 addrconf: add IFA_F_NOPREFIXROUTE flag to suppress creation of IP6 routes)
  
  struct ifa_cacheinfo {
  	__u32	ifa_prefered;
diff --cc net/ipv6/addrconf.c
index 157713521b56,85100c1ac761..000000000000
--- a/net/ipv6/addrconf.c
+++ b/net/ipv6/addrconf.c
@@@ -3699,7 -3663,11 +3702,15 @@@ static int inet6_addr_modify(struct ine
  	}
  
  	spin_lock_bh(&ifp->lock);
++<<<<<<< HEAD
 +	ifp->flags = (ifp->flags & ~(IFA_F_DEPRECATED | IFA_F_PERMANENT | IFA_F_NODAD | IFA_F_HOMEADDRESS)) | ifa_flags;
++=======
+ 	was_managetempaddr = ifp->flags & IFA_F_MANAGETEMPADDR;
+ 	ifp->flags &= ~(IFA_F_DEPRECATED | IFA_F_PERMANENT | IFA_F_NODAD |
+ 			IFA_F_HOMEADDRESS | IFA_F_MANAGETEMPADDR |
+ 			IFA_F_NOPREFIXROUTE);
+ 	ifp->flags |= ifa_flags;
++>>>>>>> 761aac737eb1 (ipv6 addrconf: add IFA_F_NOPREFIXROUTE flag to suppress creation of IP6 routes)
  	ifp->tstamp = jiffies;
  	ifp->valid_lft = valid_lft;
  	ifp->prefered_lft = prefered_lft;
@@@ -3708,8 -3676,18 +3719,23 @@@
  	if (!(ifp->flags&IFA_F_TENTATIVE))
  		ipv6_ifa_notify(0, ifp);
  
++<<<<<<< HEAD
 +	addrconf_prefix_route(&ifp->addr, ifp->prefix_len, ifp->idev->dev,
 +			      expires, flags);
++=======
+ 	if (!(ifa_flags & IFA_F_NOPREFIXROUTE)) {
+ 		addrconf_prefix_route(&ifp->addr, ifp->prefix_len, ifp->idev->dev,
+ 				      expires, flags);
+ 	}
+ 
+ 	if (was_managetempaddr || ifp->flags & IFA_F_MANAGETEMPADDR) {
+ 		if (was_managetempaddr && !(ifp->flags & IFA_F_MANAGETEMPADDR))
+ 			valid_lft = prefered_lft = 0;
+ 		manage_tempaddrs(ifp->idev, ifp, valid_lft, prefered_lft,
+ 				 !was_managetempaddr, jiffies);
+ 	}
+ 
++>>>>>>> 761aac737eb1 (ipv6 addrconf: add IFA_F_NOPREFIXROUTE flag to suppress creation of IP6 routes)
  	addrconf_verify(0);
  
  	return 0;
@@@ -3752,8 -3730,11 +3778,13 @@@ inet6_rtm_newaddr(struct sk_buff *skb, 
  	if (dev == NULL)
  		return -ENODEV;
  
 -	ifa_flags = tb[IFA_FLAGS] ? nla_get_u32(tb[IFA_FLAGS]) : ifm->ifa_flags;
 -
  	/* We ignore other flags so far. */
++<<<<<<< HEAD
 +	ifa_flags = ifm->ifa_flags & (IFA_F_NODAD | IFA_F_HOMEADDRESS);
++=======
+ 	ifa_flags &= IFA_F_NODAD | IFA_F_HOMEADDRESS | IFA_F_MANAGETEMPADDR |
+ 		     IFA_F_NOPREFIXROUTE;
++>>>>>>> 761aac737eb1 (ipv6 addrconf: add IFA_F_NOPREFIXROUTE flag to suppress creation of IP6 routes)
  
  	ifa = ipv6_get_ifaddr(net, pfx, dev, 1);
  	if (ifa == NULL) {
* Unmerged path include/uapi/linux/if_addr.h
* Unmerged path net/ipv6/addrconf.c
