ALSA: hda - not choose assigned converters for unused pins of Valleyview

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-123.el7
Rebuild_CHGLOG: - [alsa] hda: not choose assigned converters for unused pins of Valleyview (Jaroslav Kysela) [1044022]
Rebuild_FUZZ: 93.43%
commit-author Mengdong Lin <mengdong.lin@intel.com>
commit 023838542dc8a4eac9650f98942671078a4ce73d
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-123.el7/02383854.failed

For Valleyview display codec, if an unused pin chooses an assgined converter
selected by a used pin, playback on the unused pin can also give sound to the
output device of the used pin. It's because data flows from the same convertor
to the display port of the used pin. This issue is same as Haswell.

So this patch avoids using assinged convertors for unused pins.
The related function haswell_config_cvts() is renamed for code reuse.

	Signed-off-by: Mengdong Lin <mengdong.lin@intel.com>
	Signed-off-by: Takashi Iwai <tiwai@suse.de>
(cherry picked from commit 023838542dc8a4eac9650f98942671078a4ce73d)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	sound/pci/hda/patch_hdmi.c
diff --cc sound/pci/hda/patch_hdmi.c
index f36275527fe5,d61cc2ab52af..000000000000
--- a/sound/pci/hda/patch_hdmi.c
+++ b/sound/pci/hda/patch_hdmi.c
@@@ -45,6 -45,9 +45,12 @@@ static bool static_hdmi_pcm
  module_param(static_hdmi_pcm, bool, 0644);
  MODULE_PARM_DESC(static_hdmi_pcm, "Don't restrict PCM parameters per ELD info");
  
++<<<<<<< HEAD
++=======
+ #define is_haswell(codec)  ((codec)->vendor_id == 0x80862807)
+ #define is_valleyview(codec) ((codec)->vendor_id == 0x80862882)
+ 
++>>>>>>> 023838542dc8 (ALSA: hda - not choose assigned converters for unused pins of Valleyview)
  struct hdmi_spec_per_cvt {
  	hda_nid_t cvt_nid;
  	int assigned;
@@@ -1166,33 -1328,44 +1172,38 @@@ static int hdmi_choose_cvt(struct hda_c
  	return 0;
  }
  
++<<<<<<< HEAD
 +static void haswell_config_cvts(struct hda_codec *codec,
 +			int pin_id, int mux_id)
++=======
+ static void not_share_unassigned_cvt(struct hda_codec *codec,
+ 			hda_nid_t pin_nid, int mux_idx)
++>>>>>>> 023838542dc8 (ALSA: hda - not choose assigned converters for unused pins of Valleyview)
  {
  	struct hdmi_spec *spec = codec->spec;
 -	hda_nid_t nid, end_nid;
 -	int cvt_idx, curr;
 -	struct hdmi_spec_per_cvt *per_cvt;
 -
 -	/* configure all pins, including "no physical connection" ones */
 -	end_nid = codec->start_nid + codec->num_nodes;
 -	for (nid = codec->start_nid; nid < end_nid; nid++) {
 -		unsigned int wid_caps = get_wcaps(codec, nid);
 -		unsigned int wid_type = get_wcaps_type(wid_caps);
 +	struct hdmi_spec_per_pin *per_pin;
 +	int pin_idx, mux_idx;
 +	int curr;
 +	int err;
  
 -		if (wid_type != AC_WID_PIN)
 -			continue;
 +	for (pin_idx = 0; pin_idx < spec->num_pins; pin_idx++) {
 +		per_pin = get_pin(spec, pin_idx);
  
 -		if (nid == pin_nid)
 +		if (pin_idx == pin_id)
  			continue;
  
 -		curr = snd_hda_codec_read(codec, nid, 0,
 +		curr = snd_hda_codec_read(codec, per_pin->pin_nid, 0,
  					  AC_VERB_GET_CONNECT_SEL, 0);
 -		if (curr != mux_idx)
 -			continue;
  
 -		/* choose an unassigned converter. The conveters in the
 -		 * connection list are in the same order as in the codec.
 -		 */
 -		for (cvt_idx = 0; cvt_idx < spec->num_cvts; cvt_idx++) {
 -			per_cvt = get_cvt(spec, cvt_idx);
 -			if (!per_cvt->assigned) {
 -				snd_printdd("choose cvt %d for pin nid %d\n",
 -					cvt_idx, nid);
 -				snd_hda_codec_write_cache(codec, nid, 0,
 +		/* Choose another unused converter */
 +		if (curr == mux_id) {
 +			err = hdmi_choose_cvt(codec, pin_idx, NULL, &mux_idx);
 +			if (err < 0)
 +				return;
 +			snd_printdd("HDMI: choose converter %d for pin %d\n", mux_idx, pin_idx);
 +			snd_hda_codec_write_cache(codec, per_pin->pin_nid, 0,
  					    AC_VERB_SET_CONNECT_SEL,
 -					    cvt_idx);
 -				break;
 -			}
 +					    mux_idx);
  		}
  	}
  }
@@@ -1233,8 -1407,8 +1244,13 @@@ static int hdmi_pcm_open(struct hda_pcm
  			    mux_idx);
  
  	/* configure unused pins to choose other converters */
++<<<<<<< HEAD
 +	if (codec->vendor_id == 0x80862807)
 +		haswell_config_cvts(codec, pin_idx, mux_idx);
++=======
+ 	if (is_haswell(codec) || is_valleyview(codec))
+ 		not_share_unassigned_cvt(codec, per_pin->pin_nid, mux_idx);
++>>>>>>> 023838542dc8 (ALSA: hda - not choose assigned converters for unused pins of Valleyview)
  
  	snd_hda_spdif_ctls_assign(codec, pin_idx, per_cvt->cvt_nid);
  
* Unmerged path sound/pci/hda/patch_hdmi.c
