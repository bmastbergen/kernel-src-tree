kvm hypervisor: Simplify kvm_for_each_vcpu with kvm_irq_delivery_to_apic

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-123.el7
Rebuild_CHGLOG: - [virt] kvm: Simplify kvm_for_each_vcpu with kvm_irq_delivery_to_apic (Andrew Jones) [981581]
Rebuild_FUZZ: 91.73%
commit-author Raghavendra K T <raghavendra.kt@linux.vnet.ibm.com>
commit 24d2166beb2f0be7dd29ab6a0841c27bd669eae9
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-123.el7/24d2166b.failed

Note that we are using APIC_DM_REMRD which has reserved usage.
In future if APIC_DM_REMRD usage is standardized, then we should
find some other way or go back to old method.

	Suggested-by: Gleb Natapov <gleb@redhat.com>
	Signed-off-by: Raghavendra K T <raghavendra.kt@linux.vnet.ibm.com>
	Acked-by: Gleb Natapov <gleb@redhat.com>
	Acked-by: Ingo Molnar <mingo@kernel.org>
	Signed-off-by: Gleb Natapov <gleb@redhat.com>
(cherry picked from commit 24d2166beb2f0be7dd29ab6a0841c27bd669eae9)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kvm/x86.c
diff --cc arch/x86/kvm/x86.c
index 851c9688d2c6,cb276e976203..000000000000
--- a/arch/x86/kvm/x86.c
+++ b/arch/x86/kvm/x86.c
@@@ -5519,6 -5588,23 +5519,26 @@@ int kvm_hv_hypercall(struct kvm_vcpu *v
  	return 1;
  }
  
++<<<<<<< HEAD
++=======
+ /*
+  * kvm_pv_kick_cpu_op:  Kick a vcpu.
+  *
+  * @apicid - apicid of vcpu to be kicked.
+  */
+ static void kvm_pv_kick_cpu_op(struct kvm *kvm, unsigned long flags, int apicid)
+ {
+ 	struct kvm_lapic_irq lapic_irq;
+ 
+ 	lapic_irq.shorthand = 0;
+ 	lapic_irq.dest_mode = 0;
+ 	lapic_irq.dest_id = apicid;
+ 
+ 	lapic_irq.delivery_mode = APIC_DM_REMRD;
+ 	kvm_irq_delivery_to_apic(kvm, 0, &lapic_irq, NULL);
+ }
+ 
++>>>>>>> 24d2166beb2f (kvm hypervisor: Simplify kvm_for_each_vcpu with kvm_irq_delivery_to_apic)
  int kvm_emulate_hypercall(struct kvm_vcpu *vcpu)
  {
  	unsigned long nr, a0, a1, a2, a3, ret;
diff --git a/arch/x86/kvm/lapic.c b/arch/x86/kvm/lapic.c
index afc11245827c..48c13c910fb9 100644
--- a/arch/x86/kvm/lapic.c
+++ b/arch/x86/kvm/lapic.c
@@ -706,7 +706,10 @@ out:
 		break;
 
 	case APIC_DM_REMRD:
-		apic_debug("Ignoring delivery mode 3\n");
+		result = 1;
+		vcpu->arch.pv.pv_unhalted = 1;
+		kvm_make_request(KVM_REQ_EVENT, vcpu);
+		kvm_vcpu_kick(vcpu);
 		break;
 
 	case APIC_DM_SMI:
* Unmerged path arch/x86/kvm/x86.c
