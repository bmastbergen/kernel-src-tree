[SCSI] qla4xxx: Print WARN_ONCE() if iSCSI function presence bit removed

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-123.el7
Rebuild_CHGLOG: - [scsi] qla4xxx: Print WARN_ONCE() if iSCSI function presence bit removed (Chad Dupuis) [1049707]
Rebuild_FUZZ: 94.89%
commit-author Vikas Chaudhary <vikas.chaudhary@qlogic.com>
commit a083e8bc839db0098301ebc483b83ff241e4fcdb
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-123.el7/a083e8bc.failed

	Signed-off-by: Vikas Chaudhary <vikas.chaudhary@qlogic.com>
	Reviewed-by: Mike Christie <michaelc@cs.wisc.edu>
	Signed-off-by: James Bottomley <JBottomley@Parallels.com>
(cherry picked from commit a083e8bc839db0098301ebc483b83ff241e4fcdb)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/qla4xxx/ql4_glbl.h
diff --cc drivers/scsi/qla4xxx/ql4_glbl.h
index b8e87b33b48e,b1a19cd8d5b2..000000000000
--- a/drivers/scsi/qla4xxx/ql4_glbl.h
+++ b/drivers/scsi/qla4xxx/ql4_glbl.h
@@@ -277,6 -277,10 +277,13 @@@ int qla4_84xx_config_acb(struct scsi_ql
  int qla4_83xx_ms_mem_write_128b(struct scsi_qla_host *ha,
  				uint64_t addr, uint32_t *data, uint32_t count);
  uint8_t qla4xxx_set_ipaddr_state(uint8_t fw_ipaddr_state);
++<<<<<<< HEAD
++=======
+ int qla4_83xx_get_port_config(struct scsi_qla_host *ha, uint32_t *config);
+ int qla4_83xx_set_port_config(struct scsi_qla_host *ha, uint32_t *config);
+ int qla4_8xxx_check_init_adapter_retry(struct scsi_qla_host *ha);
+ int qla4_83xx_is_detached(struct scsi_qla_host *ha);
++>>>>>>> a083e8bc839d ([SCSI] qla4xxx: Print WARN_ONCE() if iSCSI function presence bit removed)
  
  extern int ql4xextended_error_logging;
  extern int ql4xdontresethba;
diff --git a/drivers/scsi/qla4xxx/ql4_83xx.c b/drivers/scsi/qla4xxx/ql4_83xx.c
index 8196c2f7915c..43c1688d5a98 100644
--- a/drivers/scsi/qla4xxx/ql4_83xx.c
+++ b/drivers/scsi/qla4xxx/ql4_83xx.c
@@ -1664,3 +1664,23 @@ void qla4_83xx_disable_pause(struct scsi_qla_host *ha)
 	__qla4_83xx_disable_pause(ha);
 	ha->isp_ops->idc_unlock(ha);
 }
+
+/**
+ * qla4_83xx_is_detached - Check if we are marked invisible.
+ * @ha: Pointer to host adapter structure.
+ **/
+int qla4_83xx_is_detached(struct scsi_qla_host *ha)
+{
+	uint32_t drv_active;
+
+	drv_active = qla4_8xxx_rd_direct(ha, QLA8XXX_CRB_DRV_ACTIVE);
+
+	if (test_bit(AF_INIT_DONE, &ha->flags) &&
+	    !(drv_active & (1 << ha->func_num))) {
+		DEBUG2(ql4_printk(KERN_INFO, ha, "%s: drv_active = 0x%X\n",
+				  __func__, drv_active));
+		return QLA_SUCCESS;
+	}
+
+	return QLA_ERROR;
+}
* Unmerged path drivers/scsi/qla4xxx/ql4_glbl.h
diff --git a/drivers/scsi/qla4xxx/ql4_os.c b/drivers/scsi/qla4xxx/ql4_os.c
index 05de07a650cc..a88a3d493751 100644
--- a/drivers/scsi/qla4xxx/ql4_os.c
+++ b/drivers/scsi/qla4xxx/ql4_os.c
@@ -4093,6 +4093,11 @@ void qla4_8xxx_watchdog(struct scsi_qla_host *ha)
 	uint32_t dev_state;
 	uint32_t idc_ctrl;
 
+	if (is_qla8032(ha) &&
+	    (qla4_83xx_is_detached(ha) == QLA_SUCCESS))
+		WARN_ONCE(1, "%s: iSCSI function %d marked invisible\n",
+			  __func__, ha->func_num);
+
 	/* don't poll if reset is going on */
 	if (!(test_bit(DPC_RESET_ACTIVE, &ha->dpc_flags) ||
 	    test_bit(DPC_RESET_HA, &ha->dpc_flags) ||
