ALSA: hda - Enable Thinkpad mute/micmute LEDs for Realtek

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-123.el7
Rebuild_CHGLOG: - [alsa] hda: Enable Thinkpad mute/micmute LEDs for Realtek (Jaroslav Kysela) [1044022]
Rebuild_FUZZ: 91.59%
commit-author David Henningsson <david.henningsson@canonical.com>
commit b67ae3f1c97e2e8532ce051f0ed4365e9d796590
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-123.el7/b67ae3f1.failed

Same as we already have for Conexant. Right now it's only enabled
for one machine.

	Tested-by: Hui Wang <hui.wang@canonical.com>
	Signed-off-by: David Henningsson <david.henningsson@canonical.com>
	Signed-off-by: Takashi Iwai <tiwai@suse.de>
(cherry picked from commit b67ae3f1c97e2e8532ce051f0ed4365e9d796590)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	sound/pci/hda/patch_realtek.c
diff --cc sound/pci/hda/patch_realtek.c
index 3e4da3517fc8,02071a58f3f8..000000000000
--- a/sound/pci/hda/patch_realtek.c
+++ b/sound/pci/hda/patch_realtek.c
@@@ -3415,6 -3522,83 +3419,86 @@@ static void alc282_fixup_asus_tx300(str
  	}
  }
  
++<<<<<<< HEAD
++=======
+ static void alc290_fixup_mono_speakers(struct hda_codec *codec,
+ 				       const struct hda_fixup *fix, int action)
+ {
+ 	if (action == HDA_FIXUP_ACT_PRE_PROBE)
+ 		/* Remove DAC node 0x03, as it seems to be
+ 		   giving mono output */
+ 		snd_hda_override_wcaps(codec, 0x03, 0);
+ }
+ 
+ #if IS_ENABLED(CONFIG_THINKPAD_ACPI)
+ 
+ #include <linux/thinkpad_acpi.h>
+ 
+ static int (*led_set_func)(int, bool);
+ 
+ static void update_tpacpi_mute_led(void *private_data, int enabled)
+ {
+ 	if (led_set_func)
+ 		led_set_func(TPACPI_LED_MUTE, !enabled);
+ }
+ 
+ static void update_tpacpi_micmute_led(struct hda_codec *codec,
+ 				      struct snd_ctl_elem_value *ucontrol)
+ {
+ 	if (!ucontrol || !led_set_func)
+ 		return;
+ 	if (strcmp("Capture Switch", ucontrol->id.name) == 0 && ucontrol->id.index == 0) {
+ 		/* TODO: How do I verify if it's a mono or stereo here? */
+ 		bool val = ucontrol->value.integer.value[0] || ucontrol->value.integer.value[1];
+ 		led_set_func(TPACPI_LED_MICMUTE, !val);
+ 	}
+ }
+ 
+ static void alc_fixup_thinkpad_acpi(struct hda_codec *codec,
+ 				  const struct hda_fixup *fix, int action)
+ {
+ 	struct alc_spec *spec = codec->spec;
+ 	bool removefunc = false;
+ 
+ 	if (action == HDA_FIXUP_ACT_PROBE) {
+ 		if (!led_set_func)
+ 			led_set_func = symbol_request(tpacpi_led_set);
+ 		if (!led_set_func) {
+ 			snd_printk(KERN_WARNING "Failed to find thinkpad-acpi symbol tpacpi_led_set\n");
+ 			return;
+ 		}
+ 
+ 		removefunc = true;
+ 		if (led_set_func(TPACPI_LED_MUTE, false) >= 0) {
+ 			spec->gen.vmaster_mute.hook = update_tpacpi_mute_led;
+ 			removefunc = false;
+ 		}
+ 		if (led_set_func(TPACPI_LED_MICMUTE, false) >= 0) {
+ 			if (spec->gen.num_adc_nids > 1)
+ 				snd_printdd("Skipping micmute LED control due to several ADCs");
+ 			else {
+ 				spec->gen.cap_sync_hook = update_tpacpi_micmute_led;
+ 				removefunc = false;
+ 			}
+ 		}
+ 	}
+ 
+ 	if (led_set_func && (action == HDA_FIXUP_ACT_FREE || removefunc)) {
+ 		symbol_put(tpacpi_led_set);
+ 		led_set_func = NULL;
+ 	}
+ }
+ 
+ #else
+ 
+ static void alc_fixup_thinkpad_acpi(struct hda_codec *codec,
+ 				  const struct hda_fixup *fix, int action)
+ {
+ }
+ 
+ #endif
+ 
++>>>>>>> b67ae3f1c97e (ALSA: hda - Enable Thinkpad mute/micmute LEDs for Realtek)
  enum {
  	ALC269_FIXUP_SONY_VAIO,
  	ALC275_FIXUP_SONY_VAIO_GPIO2,
@@@ -3454,6 -3641,8 +3538,11 @@@
  	ALC283_FIXUP_CHROME_BOOK,
  	ALC282_FIXUP_ASUS_TX300,
  	ALC283_FIXUP_INT_MIC,
++<<<<<<< HEAD
++=======
+ 	ALC290_FIXUP_MONO_SPEAKERS,
+ 	ALC269_FIXUP_THINKPAD_ACPI,
++>>>>>>> b67ae3f1c97e (ALSA: hda - Enable Thinkpad mute/micmute LEDs for Realtek)
  };
  
  static const struct hda_fixup alc269_fixups[] = {
@@@ -3723,6 -3934,18 +3812,21 @@@
  		.chained = true,
  		.chain_id = ALC269_FIXUP_LIMIT_INT_MIC_BOOST
  	},
++<<<<<<< HEAD
++=======
+ 	[ALC290_FIXUP_MONO_SPEAKERS] = {
+ 		.type = HDA_FIXUP_FUNC,
+ 		.v.func = alc290_fixup_mono_speakers,
+ 		.chained = true,
+ 		.chain_id = ALC269_FIXUP_DELL3_MIC_NO_PRESENCE,
+ 	},
+ 	[ALC269_FIXUP_THINKPAD_ACPI] = {
+ 		.type = HDA_FIXUP_FUNC,
+ 		.v.func = alc_fixup_thinkpad_acpi,
+ 		.chained = true,
+ 		.chain_id = ALC269_FIXUP_LIMIT_INT_MIC_BOOST
+ 	},
++>>>>>>> b67ae3f1c97e (ALSA: hda - Enable Thinkpad mute/micmute LEDs for Realtek)
  };
  
  static const struct snd_pci_quirk alc269_fixup_tbl[] = {
* Unmerged path sound/pci/hda/patch_realtek.c
