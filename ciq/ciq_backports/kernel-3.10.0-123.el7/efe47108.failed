ALSA: hda - Delay HDMI presence reports while waiting for ELD information

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-123.el7
Rebuild_CHGLOG: - [alsa] hda: Delay HDMI presence reports while waiting for ELD information (Jaroslav Kysela) [1044022]
Rebuild_FUZZ: 93.53%
commit-author Takashi Iwai <tiwai@suse.de>
commit efe4710860fa6ed10dd041f13902f0e06c86e8cc
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-123.el7/efe47108.failed

There is a small gap between the jack detection unsolicited event and
the time the ELD is updated.  When user-space queries the HDMI ELD
immediately after receiving the notification, it might fail because of
this gap.

For avoiding such a problem, this patch tries to delay the HDMI jack
detect notification until ELD information is fully updated.  The
workaround is imperfect, but good enough as a starting point.

	Signed-off-by: Takashi Iwai <tiwai@suse.de>
(cherry picked from commit efe4710860fa6ed10dd041f13902f0e06c86e8cc)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	sound/pci/hda/patch_hdmi.c
diff --cc sound/pci/hda/patch_hdmi.c
index f36275527fe5,ce412d1a15d0..000000000000
--- a/sound/pci/hda/patch_hdmi.c
+++ b/sound/pci/hda/patch_hdmi.c
@@@ -1310,7 -1493,9 +1310,8 @@@ static bool hdmi_present_sense(struct h
  	int present = snd_hda_pin_sense(codec, pin_nid);
  	bool update_eld = false;
  	bool eld_changed = false;
+ 	bool ret;
  
 -	mutex_lock(&per_pin->lock);
  	pin_eld->monitor_present = !!(present & AC_PINSENSE_PRESENCE);
  	if (pin_eld->monitor_present)
  		eld->eld_valid  = !!(present & AC_PINSENSE_ELDV);
@@@ -1366,6 -1559,13 +1367,16 @@@
  		snd_ctl_notify(codec->bus->card,
  			       SNDRV_CTL_EVENT_MASK_VALUE | SNDRV_CTL_EVENT_MASK_INFO,
  			       &per_pin->eld_ctl->id);
++<<<<<<< HEAD
++=======
+  unlock:
+ 	if ((codec->vendor_id & 0xffff0000) == 0x10020000)
+ 		ret = true; /* AMD codecs create ELD by itself */
+ 	else
+ 		ret = !repoll || !pin_eld->monitor_present || pin_eld->eld_valid;
+ 	mutex_unlock(&per_pin->lock);
+ 	return ret;
++>>>>>>> efe4710860fa (ALSA: hda - Delay HDMI presence reports while waiting for ELD information)
  }
  
  static void hdmi_repoll_eld(struct work_struct *work)
* Unmerged path sound/pci/hda/patch_hdmi.c
