cpufreq: check cpufreq driver is valid and cpufreq isn't disabled in cpufreq_get()

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-123.el7
Rebuild_CHGLOG: - [cpufreq] check cpufreq driver is valid and cpufreq isn't disabled in cpufreq_get() (Jan Stancek) [1040409]
Rebuild_FUZZ: 94.19%
commit-author Viresh Kumar <viresh.kumar@linaro.org>
commit 26ca8694344af4c833d22590c5b77d6b9cff0722
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-123.el7/26ca8694.failed

cpufreq_get() can be called from external drivers which might not be aware if
cpufreq driver is registered or not. And so we should actually check if cpufreq
driver is registered or not and also if cpufreq is active or disabled, at the
beginning of cpufreq_get().

Otherwise call to lock_policy_rwsem_read() might hit BUG_ON(!policy).

Reported-and-tested-by: Linus Walleij <linus.walleij@linaro.org>
	Signed-off-by: Viresh Kumar <viresh.kumar@linaro.org>
	Reviewed-by: Srivatsa S. Bhat <srivatsa.bhat@linux.vnet.ibm.com>
	Signed-off-by: Rafael J. Wysocki <rafael.j.wysocki@intel.com>
(cherry picked from commit 26ca8694344af4c833d22590c5b77d6b9cff0722)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/cpufreq/cpufreq.c
diff --cc drivers/cpufreq/cpufreq.c
index 92c36d09d291,04548f7023af..000000000000
--- a/drivers/cpufreq/cpufreq.c
+++ b/drivers/cpufreq/cpufreq.c
@@@ -1336,10 -1459,12 +1336,18 @@@ static unsigned int __cpufreq_get(unsig
  unsigned int cpufreq_get(unsigned int cpu)
  {
  	unsigned int ret_freq = 0;
 +	struct cpufreq_policy *policy = cpufreq_cpu_get(cpu);
  
++<<<<<<< HEAD
 +	if (!policy)
 +		goto out;
++=======
+ 	if (cpufreq_disabled() || !cpufreq_driver)
+ 		return -ENOENT;
+ 
+ 	if (!down_read_trylock(&cpufreq_rwsem))
+ 		return 0;
++>>>>>>> 26ca8694344a (cpufreq: check cpufreq driver is valid and cpufreq isn't disabled in cpufreq_get())
  
  	if (unlikely(lock_policy_rwsem_read(cpu)))
  		goto out_policy;
* Unmerged path drivers/cpufreq/cpufreq.c
