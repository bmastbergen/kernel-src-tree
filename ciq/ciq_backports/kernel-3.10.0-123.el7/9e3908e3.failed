xfs: fix unlock in xfs_bmap_add_attrfork

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-123.el7
commit-author Mark Tinguely <tinguely@sgi.com>
commit 9e3908e342eba6684621e616529669c17e271e7e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-123.el7/9e3908e3.failed

xfs_trans_ijoin() activates the inode in a transaction and
also can specify which lock to free when the transaction is
committed or canceled.

xfs_bmap_add_attrfork call locks and adds the lock to the
transaction but also manually removes the lock. Change the
routine to not add the lock to the transaction and manually
remove lock on completion.

While here, clean up the xfs_trans_cancel flags and goto names.

	Signed-off-by: Mark Tinguely <tinguely@sgi.com>
	Reviewed-by: Christoph Hellwig <hch@lst.de>
	Signed-off-by: Ben Myers <bpm@sgi.com>

(cherry picked from commit 9e3908e342eba6684621e616529669c17e271e7e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/xfs/xfs_bmap.c
diff --cc fs/xfs/xfs_bmap.c
index 55a5051c2985,3ef11b22e750..000000000000
--- a/fs/xfs/xfs_bmap.c
+++ b/fs/xfs/xfs_bmap.c
@@@ -1149,9 -1147,12 +1150,18 @@@ xfs_bmap_add_attrfork
  	blks = XFS_ADDAFORK_SPACE_RES(mp);
  	if (rsvd)
  		tp->t_flags |= XFS_TRANS_RESERVE;
++<<<<<<< HEAD
 +	if ((error = xfs_trans_reserve(tp, blks, XFS_ADDAFORK_LOG_RES(mp), 0,
 +			XFS_TRANS_PERM_LOG_RES, XFS_ADDAFORK_LOG_COUNT)))
 +		goto error0;
++=======
+ 	error = xfs_trans_reserve(tp, &M_RES(mp)->tr_addafork, blks, 0);
+ 	if (error) {
+ 		xfs_trans_cancel(tp, 0);
+ 		return error;
+ 	}
+ 	cancel_flags = XFS_TRANS_RELEASE_LOG_RES;
++>>>>>>> 9e3908e342eb (xfs: fix unlock in xfs_bmap_add_attrfork)
  	xfs_ilock(ip, XFS_ILOCK_EXCL);
  	error = xfs_trans_reserve_quota_nblks(tp, ip, blks, 0, rsvd ?
  			XFS_QMOPT_RES_REGBLKS | XFS_QMOPT_FORCE_RES :
* Unmerged path fs/xfs/xfs_bmap.c
