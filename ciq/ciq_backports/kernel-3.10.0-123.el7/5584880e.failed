x86: xen: Sync the wallclock when the system time is set

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-123.el7
Rebuild_CHGLOG: - [virt] x86/xen: Sync the wallclock when the system time is set (Radim Krcmar) [1003683]
Rebuild_FUZZ: 97.30%
commit-author David Vrabel <david.vrabel@citrix.com>
commit 5584880e44e49c587059801faa2a9f7d22619c48
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-123.el7/5584880e.failed

Currently the Xen wallclock is only updated every 11 minutes if NTP is
synchronized to its clock source (using the sync_cmos_clock() work).
If a guest is started before NTP is synchronized it may see an
incorrect wallclock time.

Use the pvclock_gtod notifier chain to receive a notification when the
system time has changed and update the wallclock to match.

This chain is called on every timer tick and we want to avoid an extra
(expensive) hypercall on every tick.  Because dom0 has historically
never provided a very accurate wallclock and guests do not expect one,
we can do this simply: the wallclock is only updated if the clock was
set.

	Signed-off-by: David Vrabel <david.vrabel@citrix.com>
	Cc: Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>
	Cc: John Stultz <john.stultz@linaro.org>
	Cc: <xen-devel@lists.xen.org>
Link: http://lkml.kernel.org/r/1372329348-20841-5-git-send-email-david.vrabel@citrix.com
	Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
(cherry picked from commit 5584880e44e49c587059801faa2a9f7d22619c48)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/xen/time.c
diff --cc arch/x86/xen/time.c
index 005718656483,3364850d23e6..000000000000
--- a/arch/x86/xen/time.c
+++ b/arch/x86/xen/time.c
@@@ -14,7 -14,7 +14,11 @@@
  #include <linux/kernel_stat.h>
  #include <linux/math64.h>
  #include <linux/gfp.h>
++<<<<<<< HEAD
 +#include <linux/slab.h>
++=======
+ #include <linux/pvclock_gtod.h>
++>>>>>>> 5584880e44e4 (x86: xen: Sync the wallclock when the system time is set)
  
  #include <asm/pvclock.h>
  #include <asm/xen/hypervisor.h>
* Unmerged path arch/x86/xen/time.c
