ALSA: hda - rename function not_share_unassigned_cvt()

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-123.el7
Rebuild_CHGLOG: - [alsa] hda: rename function not_share_unassigned_cvt() (Jaroslav Kysela) [1044022]
Rebuild_FUZZ: 91.09%
commit-author Mengdong Lin <mengdong.lin@intel.com>
commit 300016b960661b4df63690177b22ba5426ff5706
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-123.el7/300016b9.failed

The function name not_share_unassigned_cvt() is opposite to what it does.
This patch renames it to intel_not_share_assigned_cvt(), and addes comments
to explain why some Intel display codecs need this workaround.

	Signed-off-by: Mengdong Lin <mengdong.lin@intel.com>
	Signed-off-by: Takashi Iwai <tiwai@suse.de>
(cherry picked from commit 300016b960661b4df63690177b22ba5426ff5706)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	sound/pci/hda/patch_hdmi.c
diff --cc sound/pci/hda/patch_hdmi.c
index f36275527fe5,e22323f50424..000000000000
--- a/sound/pci/hda/patch_hdmi.c
+++ b/sound/pci/hda/patch_hdmi.c
@@@ -1166,33 -1328,53 +1166,47 @@@ static int hdmi_choose_cvt(struct hda_c
  	return 0;
  }
  
++<<<<<<< HEAD
 +static void haswell_config_cvts(struct hda_codec *codec,
 +			int pin_id, int mux_id)
++=======
+ /* Intel HDMI workaround to fix audio routing issue:
+  * For some Intel display codecs, pins share the same connection list.
+  * So a conveter can be selected by multiple pins and playback on any of these
+  * pins will generate sound on the external display, because audio flows from
+  * the same converter to the display pipeline. Also muting one pin may make
+  * other pins have no sound output.
+  * So this function assures that an assigned converter for a pin is not selected
+  * by any other pins.
+  */
+ static void intel_not_share_assigned_cvt(struct hda_codec *codec,
+ 			hda_nid_t pin_nid, int mux_idx)
++>>>>>>> 300016b96066 (ALSA: hda - rename function not_share_unassigned_cvt())
  {
  	struct hdmi_spec *spec = codec->spec;
 -	hda_nid_t nid, end_nid;
 -	int cvt_idx, curr;
 -	struct hdmi_spec_per_cvt *per_cvt;
 -
 -	/* configure all pins, including "no physical connection" ones */
 -	end_nid = codec->start_nid + codec->num_nodes;
 -	for (nid = codec->start_nid; nid < end_nid; nid++) {
 -		unsigned int wid_caps = get_wcaps(codec, nid);
 -		unsigned int wid_type = get_wcaps_type(wid_caps);
 +	struct hdmi_spec_per_pin *per_pin;
 +	int pin_idx, mux_idx;
 +	int curr;
 +	int err;
  
 -		if (wid_type != AC_WID_PIN)
 -			continue;
 +	for (pin_idx = 0; pin_idx < spec->num_pins; pin_idx++) {
 +		per_pin = get_pin(spec, pin_idx);
  
 -		if (nid == pin_nid)
 +		if (pin_idx == pin_id)
  			continue;
  
 -		curr = snd_hda_codec_read(codec, nid, 0,
 +		curr = snd_hda_codec_read(codec, per_pin->pin_nid, 0,
  					  AC_VERB_GET_CONNECT_SEL, 0);
 -		if (curr != mux_idx)
 -			continue;
  
 -		/* choose an unassigned converter. The conveters in the
 -		 * connection list are in the same order as in the codec.
 -		 */
 -		for (cvt_idx = 0; cvt_idx < spec->num_cvts; cvt_idx++) {
 -			per_cvt = get_cvt(spec, cvt_idx);
 -			if (!per_cvt->assigned) {
 -				snd_printdd("choose cvt %d for pin nid %d\n",
 -					cvt_idx, nid);
 -				snd_hda_codec_write_cache(codec, nid, 0,
 +		/* Choose another unused converter */
 +		if (curr == mux_id) {
 +			err = hdmi_choose_cvt(codec, pin_idx, NULL, &mux_idx);
 +			if (err < 0)
 +				return;
 +			snd_printdd("HDMI: choose converter %d for pin %d\n", mux_idx, pin_idx);
 +			snd_hda_codec_write_cache(codec, per_pin->pin_nid, 0,
  					    AC_VERB_SET_CONNECT_SEL,
 -					    cvt_idx);
 -				break;
 -			}
 +					    mux_idx);
  		}
  	}
  }
@@@ -1233,8 -1416,8 +1247,13 @@@ static int hdmi_pcm_open(struct hda_pcm
  			    mux_idx);
  
  	/* configure unused pins to choose other converters */
++<<<<<<< HEAD
 +	if (codec->vendor_id == 0x80862807)
 +		haswell_config_cvts(codec, pin_idx, mux_idx);
++=======
+ 	if (is_haswell(codec) || is_valleyview(codec))
+ 		intel_not_share_assigned_cvt(codec, per_pin->pin_nid, mux_idx);
++>>>>>>> 300016b96066 (ALSA: hda - rename function not_share_unassigned_cvt())
  
  	snd_hda_spdif_ctls_assign(codec, pin_idx, per_cvt->cvt_nid);
  
* Unmerged path sound/pci/hda/patch_hdmi.c
