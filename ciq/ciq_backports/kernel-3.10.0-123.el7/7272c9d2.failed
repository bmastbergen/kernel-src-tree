drm/radeon: hook up backlight functions for CI and KV family.

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-123.el7
Rebuild_CHGLOG: - [drm] radeon: hook up backlight functions for CI and KV family (Rob Clark) [1054409]
Rebuild_FUZZ: 95.73%
commit-author Samuel Li <samuel.li@amd.com>
commit 7272c9d2286525d4c6bce788243cf2b6f306d15c
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-123.el7/7272c9d2.failed

Fixes crashes when handling atif events due to the lack of a
callback being registered.

	Signed-off-by: Samuel Li <samuel.li@amd.com>
	Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
	Cc: stable@vger.kernel.org
(cherry picked from commit 7272c9d2286525d4c6bce788243cf2b6f306d15c)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/gpu/drm/radeon/radeon_asic.c
diff --cc drivers/gpu/drm/radeon/radeon_asic.c
index a2802b47ee95,e354ce94cdd1..000000000000
--- a/drivers/gpu/drm/radeon/radeon_asic.c
+++ b/drivers/gpu/drm/radeon/radeon_asic.c
@@@ -1911,6 -1907,271 +1911,274 @@@ static struct radeon_asic si_asic = 
  		.set_pcie_lanes = &r600_set_pcie_lanes,
  		.set_clock_gating = NULL,
  		.set_uvd_clocks = &si_set_uvd_clocks,
++<<<<<<< HEAD
++=======
+ 		.get_temperature = &si_get_temp,
+ 	},
+ 	.dpm = {
+ 		.init = &si_dpm_init,
+ 		.setup_asic = &si_dpm_setup_asic,
+ 		.enable = &si_dpm_enable,
+ 		.disable = &si_dpm_disable,
+ 		.pre_set_power_state = &si_dpm_pre_set_power_state,
+ 		.set_power_state = &si_dpm_set_power_state,
+ 		.post_set_power_state = &si_dpm_post_set_power_state,
+ 		.display_configuration_changed = &si_dpm_display_configuration_changed,
+ 		.fini = &si_dpm_fini,
+ 		.get_sclk = &ni_dpm_get_sclk,
+ 		.get_mclk = &ni_dpm_get_mclk,
+ 		.print_power_state = &ni_dpm_print_power_state,
+ 		.debugfs_print_current_performance_level = &si_dpm_debugfs_print_current_performance_level,
+ 		.force_performance_level = &si_dpm_force_performance_level,
+ 		.vblank_too_short = &ni_dpm_vblank_too_short,
+ 	},
+ 	.pflip = {
+ 		.pre_page_flip = &evergreen_pre_page_flip,
+ 		.page_flip = &evergreen_page_flip,
+ 		.post_page_flip = &evergreen_post_page_flip,
+ 	},
+ };
+ 
+ static struct radeon_asic_ring ci_gfx_ring = {
+ 	.ib_execute = &cik_ring_ib_execute,
+ 	.ib_parse = &cik_ib_parse,
+ 	.emit_fence = &cik_fence_gfx_ring_emit,
+ 	.emit_semaphore = &cik_semaphore_ring_emit,
+ 	.cs_parse = NULL,
+ 	.ring_test = &cik_ring_test,
+ 	.ib_test = &cik_ib_test,
+ 	.is_lockup = &cik_gfx_is_lockup,
+ 	.vm_flush = &cik_vm_flush,
+ 	.get_rptr = &radeon_ring_generic_get_rptr,
+ 	.get_wptr = &radeon_ring_generic_get_wptr,
+ 	.set_wptr = &radeon_ring_generic_set_wptr,
+ };
+ 
+ static struct radeon_asic_ring ci_cp_ring = {
+ 	.ib_execute = &cik_ring_ib_execute,
+ 	.ib_parse = &cik_ib_parse,
+ 	.emit_fence = &cik_fence_compute_ring_emit,
+ 	.emit_semaphore = &cik_semaphore_ring_emit,
+ 	.cs_parse = NULL,
+ 	.ring_test = &cik_ring_test,
+ 	.ib_test = &cik_ib_test,
+ 	.is_lockup = &cik_gfx_is_lockup,
+ 	.vm_flush = &cik_vm_flush,
+ 	.get_rptr = &cik_compute_ring_get_rptr,
+ 	.get_wptr = &cik_compute_ring_get_wptr,
+ 	.set_wptr = &cik_compute_ring_set_wptr,
+ };
+ 
+ static struct radeon_asic_ring ci_dma_ring = {
+ 	.ib_execute = &cik_sdma_ring_ib_execute,
+ 	.ib_parse = &cik_ib_parse,
+ 	.emit_fence = &cik_sdma_fence_ring_emit,
+ 	.emit_semaphore = &cik_sdma_semaphore_ring_emit,
+ 	.cs_parse = NULL,
+ 	.ring_test = &cik_sdma_ring_test,
+ 	.ib_test = &cik_sdma_ib_test,
+ 	.is_lockup = &cik_sdma_is_lockup,
+ 	.vm_flush = &cik_dma_vm_flush,
+ 	.get_rptr = &r600_dma_get_rptr,
+ 	.get_wptr = &r600_dma_get_wptr,
+ 	.set_wptr = &r600_dma_set_wptr,
+ };
+ 
+ static struct radeon_asic ci_asic = {
+ 	.init = &cik_init,
+ 	.fini = &cik_fini,
+ 	.suspend = &cik_suspend,
+ 	.resume = &cik_resume,
+ 	.asic_reset = &cik_asic_reset,
+ 	.vga_set_state = &r600_vga_set_state,
+ 	.ioctl_wait_idle = NULL,
+ 	.gui_idle = &r600_gui_idle,
+ 	.mc_wait_for_idle = &evergreen_mc_wait_for_idle,
+ 	.get_xclk = &cik_get_xclk,
+ 	.get_gpu_clock_counter = &cik_get_gpu_clock_counter,
+ 	.gart = {
+ 		.tlb_flush = &cik_pcie_gart_tlb_flush,
+ 		.set_page = &rs600_gart_set_page,
+ 	},
+ 	.vm = {
+ 		.init = &cik_vm_init,
+ 		.fini = &cik_vm_fini,
+ 		.set_page = &cik_sdma_vm_set_page,
+ 	},
+ 	.ring = {
+ 		[RADEON_RING_TYPE_GFX_INDEX] = &ci_gfx_ring,
+ 		[CAYMAN_RING_TYPE_CP1_INDEX] = &ci_cp_ring,
+ 		[CAYMAN_RING_TYPE_CP2_INDEX] = &ci_cp_ring,
+ 		[R600_RING_TYPE_DMA_INDEX] = &ci_dma_ring,
+ 		[CAYMAN_RING_TYPE_DMA1_INDEX] = &ci_dma_ring,
+ 		[R600_RING_TYPE_UVD_INDEX] = &cayman_uvd_ring,
+ 	},
+ 	.irq = {
+ 		.set = &cik_irq_set,
+ 		.process = &cik_irq_process,
+ 	},
+ 	.display = {
+ 		.bandwidth_update = &dce8_bandwidth_update,
+ 		.get_vblank_counter = &evergreen_get_vblank_counter,
+ 		.wait_for_vblank = &dce4_wait_for_vblank,
+ 		.set_backlight_level = &atombios_set_backlight_level,
+ 		.get_backlight_level = &atombios_get_backlight_level,
+ 		.hdmi_enable = &evergreen_hdmi_enable,
+ 		.hdmi_setmode = &evergreen_hdmi_setmode,
+ 	},
+ 	.copy = {
+ 		.blit = NULL,
+ 		.blit_ring_index = RADEON_RING_TYPE_GFX_INDEX,
+ 		.dma = &cik_copy_dma,
+ 		.dma_ring_index = R600_RING_TYPE_DMA_INDEX,
+ 		.copy = &cik_copy_dma,
+ 		.copy_ring_index = R600_RING_TYPE_DMA_INDEX,
+ 	},
+ 	.surface = {
+ 		.set_reg = r600_set_surface_reg,
+ 		.clear_reg = r600_clear_surface_reg,
+ 	},
+ 	.hpd = {
+ 		.init = &evergreen_hpd_init,
+ 		.fini = &evergreen_hpd_fini,
+ 		.sense = &evergreen_hpd_sense,
+ 		.set_polarity = &evergreen_hpd_set_polarity,
+ 	},
+ 	.pm = {
+ 		.misc = &evergreen_pm_misc,
+ 		.prepare = &evergreen_pm_prepare,
+ 		.finish = &evergreen_pm_finish,
+ 		.init_profile = &sumo_pm_init_profile,
+ 		.get_dynpm_state = &r600_pm_get_dynpm_state,
+ 		.get_engine_clock = &radeon_atom_get_engine_clock,
+ 		.set_engine_clock = &radeon_atom_set_engine_clock,
+ 		.get_memory_clock = &radeon_atom_get_memory_clock,
+ 		.set_memory_clock = &radeon_atom_set_memory_clock,
+ 		.get_pcie_lanes = NULL,
+ 		.set_pcie_lanes = NULL,
+ 		.set_clock_gating = NULL,
+ 		.set_uvd_clocks = &cik_set_uvd_clocks,
+ 		.get_temperature = &ci_get_temp,
+ 	},
+ 	.dpm = {
+ 		.init = &ci_dpm_init,
+ 		.setup_asic = &ci_dpm_setup_asic,
+ 		.enable = &ci_dpm_enable,
+ 		.disable = &ci_dpm_disable,
+ 		.pre_set_power_state = &ci_dpm_pre_set_power_state,
+ 		.set_power_state = &ci_dpm_set_power_state,
+ 		.post_set_power_state = &ci_dpm_post_set_power_state,
+ 		.display_configuration_changed = &ci_dpm_display_configuration_changed,
+ 		.fini = &ci_dpm_fini,
+ 		.get_sclk = &ci_dpm_get_sclk,
+ 		.get_mclk = &ci_dpm_get_mclk,
+ 		.print_power_state = &ci_dpm_print_power_state,
+ 		.debugfs_print_current_performance_level = &ci_dpm_debugfs_print_current_performance_level,
+ 		.force_performance_level = &ci_dpm_force_performance_level,
+ 		.vblank_too_short = &ci_dpm_vblank_too_short,
+ 		.powergate_uvd = &ci_dpm_powergate_uvd,
+ 	},
+ 	.pflip = {
+ 		.pre_page_flip = &evergreen_pre_page_flip,
+ 		.page_flip = &evergreen_page_flip,
+ 		.post_page_flip = &evergreen_post_page_flip,
+ 	},
+ };
+ 
+ static struct radeon_asic kv_asic = {
+ 	.init = &cik_init,
+ 	.fini = &cik_fini,
+ 	.suspend = &cik_suspend,
+ 	.resume = &cik_resume,
+ 	.asic_reset = &cik_asic_reset,
+ 	.vga_set_state = &r600_vga_set_state,
+ 	.ioctl_wait_idle = NULL,
+ 	.gui_idle = &r600_gui_idle,
+ 	.mc_wait_for_idle = &evergreen_mc_wait_for_idle,
+ 	.get_xclk = &cik_get_xclk,
+ 	.get_gpu_clock_counter = &cik_get_gpu_clock_counter,
+ 	.gart = {
+ 		.tlb_flush = &cik_pcie_gart_tlb_flush,
+ 		.set_page = &rs600_gart_set_page,
+ 	},
+ 	.vm = {
+ 		.init = &cik_vm_init,
+ 		.fini = &cik_vm_fini,
+ 		.set_page = &cik_sdma_vm_set_page,
+ 	},
+ 	.ring = {
+ 		[RADEON_RING_TYPE_GFX_INDEX] = &ci_gfx_ring,
+ 		[CAYMAN_RING_TYPE_CP1_INDEX] = &ci_cp_ring,
+ 		[CAYMAN_RING_TYPE_CP2_INDEX] = &ci_cp_ring,
+ 		[R600_RING_TYPE_DMA_INDEX] = &ci_dma_ring,
+ 		[CAYMAN_RING_TYPE_DMA1_INDEX] = &ci_dma_ring,
+ 		[R600_RING_TYPE_UVD_INDEX] = &cayman_uvd_ring,
+ 	},
+ 	.irq = {
+ 		.set = &cik_irq_set,
+ 		.process = &cik_irq_process,
+ 	},
+ 	.display = {
+ 		.bandwidth_update = &dce8_bandwidth_update,
+ 		.get_vblank_counter = &evergreen_get_vblank_counter,
+ 		.wait_for_vblank = &dce4_wait_for_vblank,
+ 		.set_backlight_level = &atombios_set_backlight_level,
+ 		.get_backlight_level = &atombios_get_backlight_level,
+ 		.hdmi_enable = &evergreen_hdmi_enable,
+ 		.hdmi_setmode = &evergreen_hdmi_setmode,
+ 	},
+ 	.copy = {
+ 		.blit = NULL,
+ 		.blit_ring_index = RADEON_RING_TYPE_GFX_INDEX,
+ 		.dma = &cik_copy_dma,
+ 		.dma_ring_index = R600_RING_TYPE_DMA_INDEX,
+ 		.copy = &cik_copy_dma,
+ 		.copy_ring_index = R600_RING_TYPE_DMA_INDEX,
+ 	},
+ 	.surface = {
+ 		.set_reg = r600_set_surface_reg,
+ 		.clear_reg = r600_clear_surface_reg,
+ 	},
+ 	.hpd = {
+ 		.init = &evergreen_hpd_init,
+ 		.fini = &evergreen_hpd_fini,
+ 		.sense = &evergreen_hpd_sense,
+ 		.set_polarity = &evergreen_hpd_set_polarity,
+ 	},
+ 	.pm = {
+ 		.misc = &evergreen_pm_misc,
+ 		.prepare = &evergreen_pm_prepare,
+ 		.finish = &evergreen_pm_finish,
+ 		.init_profile = &sumo_pm_init_profile,
+ 		.get_dynpm_state = &r600_pm_get_dynpm_state,
+ 		.get_engine_clock = &radeon_atom_get_engine_clock,
+ 		.set_engine_clock = &radeon_atom_set_engine_clock,
+ 		.get_memory_clock = &radeon_atom_get_memory_clock,
+ 		.set_memory_clock = &radeon_atom_set_memory_clock,
+ 		.get_pcie_lanes = NULL,
+ 		.set_pcie_lanes = NULL,
+ 		.set_clock_gating = NULL,
+ 		.set_uvd_clocks = &cik_set_uvd_clocks,
+ 		.get_temperature = &kv_get_temp,
+ 	},
+ 	.dpm = {
+ 		.init = &kv_dpm_init,
+ 		.setup_asic = &kv_dpm_setup_asic,
+ 		.enable = &kv_dpm_enable,
+ 		.disable = &kv_dpm_disable,
+ 		.pre_set_power_state = &kv_dpm_pre_set_power_state,
+ 		.set_power_state = &kv_dpm_set_power_state,
+ 		.post_set_power_state = &kv_dpm_post_set_power_state,
+ 		.display_configuration_changed = &kv_dpm_display_configuration_changed,
+ 		.fini = &kv_dpm_fini,
+ 		.get_sclk = &kv_dpm_get_sclk,
+ 		.get_mclk = &kv_dpm_get_mclk,
+ 		.print_power_state = &kv_dpm_print_power_state,
+ 		.debugfs_print_current_performance_level = &kv_dpm_debugfs_print_current_performance_level,
+ 		.force_performance_level = &kv_dpm_force_performance_level,
+ 		.powergate_uvd = &kv_dpm_powergate_uvd,
+ 		.enable_bapm = &kv_dpm_enable_bapm,
++>>>>>>> 7272c9d22865 (drm/radeon: hook up backlight functions for CI and KV family.)
  	},
  	.pflip = {
  		.pre_page_flip = &evergreen_pre_page_flip,
* Unmerged path drivers/gpu/drm/radeon/radeon_asic.c
