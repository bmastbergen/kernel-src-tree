s390/mm: page_table_realloc returns failure

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-123.el7
Rebuild_CHGLOG: - [s390] mm: page_table_realloc returns failure (Hendrik Brueckner) [1035261]
Rebuild_FUZZ: 93.83%
commit-author Dominik Dingel <dingel@linux.vnet.ibm.com>
commit be39f1968e33ca641af120a2d659421ad2225dea
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-123.el7/be39f196.failed

There is a possible race between setting has_pgste and reallocation of the
page_table, change the order to fix this.
Also page_table_alloc_pgste can fail, in that case we need to backpropagte this
as -ENOMEM to the caller of page_table_realloc.

Based on a patch by Christian Borntraeger <borntraeger@de.ibm.com>.

	Reviewed-by: Martin Schwidefsky <schwidefsky@de.ibm.com>
	Signed-off-by: Dominik Dingel <dingel@linux.vnet.ibm.com>
	Signed-off-by: Martin Schwidefsky <schwidefsky@de.ibm.com>
(cherry picked from commit be39f1968e33ca641af120a2d659421ad2225dea)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/s390/mm/pgtable.c
diff --cc arch/s390/mm/pgtable.c
index 5064824b0b50,a9be08899b0c..000000000000
--- a/arch/s390/mm/pgtable.c
+++ b/arch/s390/mm/pgtable.c
@@@ -1188,10 -1170,10 +1193,17 @@@ int s390_enable_sie(void
  	/* split thp mappings and disable thp for future mappings */
  	thp_split_mm(mm);
  	/* Reallocate the page tables with pgstes */
++<<<<<<< HEAD
 +	mm->context.has_pgste = 1;
 +	tlb_gather_mmu(&tlb, mm, 0);
 +	page_table_realloc(&tlb, mm, 0, TASK_SIZE);
 +	tlb_finish_mmu(&tlb, 0, -1);
++=======
+ 	tlb_gather_mmu(&tlb, mm, 0, TASK_SIZE);
+ 	if (!page_table_realloc(&tlb, mm, 0, TASK_SIZE))
+ 		mm->context.has_pgste = 1;
+ 	tlb_finish_mmu(&tlb, 0, TASK_SIZE);
++>>>>>>> be39f1968e33 (s390/mm: page_table_realloc returns failure)
  	up_write(&mm->mmap_sem);
  	return mm->context.has_pgste ? 0 : -ENOMEM;
  }
* Unmerged path arch/s390/mm/pgtable.c
