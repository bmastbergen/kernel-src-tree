drm: ast,cirrus,mgag200: use drm_can_sleep

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-123.el7
Rebuild_CHGLOG: - [drm] ast, cirrus, mgag200: use drm_can_sleep (Dave Airlie) [1056989]
Rebuild_FUZZ: 91.36%
commit-author Dave Airlie <airlied@redhat.com>
commit f4b4718b61d1d5a7442a4fd6863ea80c3a10e508
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-123.el7/f4b4718b.failed

these 3 were checking in_interrupt but we have situations where
calling vunmap under this could cause a BUG to be hit in
smp_call_function_many. Use the drm_can_sleep macro instead,
which should stop this path from been taken in this case.

	Cc: stable@vger.kernel.org
	Signed-off-by: Dave Airlie <airlied@redhat.com>
(cherry picked from commit f4b4718b61d1d5a7442a4fd6863ea80c3a10e508)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/gpu/drm/ast/ast_fb.c
#	drivers/gpu/drm/mgag200/mgag200_fb.c
diff --cc drivers/gpu/drm/ast/ast_fb.c
index fbc0823cfa18,3f65dd6676b2..000000000000
--- a/drivers/gpu/drm/ast/ast_fb.c
+++ b/drivers/gpu/drm/ast/ast_fb.c
@@@ -65,7 -65,8 +65,12 @@@ static void ast_dirty_update(struct ast
  	 * then the BO is being moved and we should
  	 * store up the damage until later.
  	 */
++<<<<<<< HEAD
 +	ret = ast_bo_reserve(bo, true);
++=======
+ 	if (!drm_can_sleep())
+ 		ret = ast_bo_reserve(bo, true);
++>>>>>>> f4b4718b61d1 (drm: ast,cirrus,mgag200: use drm_can_sleep)
  	if (ret) {
  		if (ret != -EBUSY)
  			return;
diff --cc drivers/gpu/drm/mgag200/mgag200_fb.c
index 5da824ce9ba1,f9adc27ef32a..000000000000
--- a/drivers/gpu/drm/mgag200/mgag200_fb.c
+++ b/drivers/gpu/drm/mgag200/mgag200_fb.c
@@@ -41,7 -41,8 +41,12 @@@ static void mga_dirty_update(struct mga
  	 * then the BO is being moved and we should
  	 * store up the damage until later.
  	 */
++<<<<<<< HEAD
 +	ret = mgag200_bo_reserve(bo, true);
++=======
+ 	if (!drm_can_sleep())
+ 		ret = mgag200_bo_reserve(bo, true);
++>>>>>>> f4b4718b61d1 (drm: ast,cirrus,mgag200: use drm_can_sleep)
  	if (ret) {
  		if (ret != -EBUSY)
  			return;
* Unmerged path drivers/gpu/drm/ast/ast_fb.c
diff --git a/drivers/gpu/drm/cirrus/cirrus_fbdev.c b/drivers/gpu/drm/cirrus/cirrus_fbdev.c
index b27e95666fab..6c16de3e9295 100644
--- a/drivers/gpu/drm/cirrus/cirrus_fbdev.c
+++ b/drivers/gpu/drm/cirrus/cirrus_fbdev.c
@@ -39,7 +39,7 @@ static void cirrus_dirty_update(struct cirrus_fbdev *afbdev,
 	 * then the BO is being moved and we should
 	 * store up the damage until later.
 	 */
-	if (!in_interrupt())
+	if (!drm_can_sleep())
 		ret = cirrus_bo_reserve(bo, true);
 	if (ret) {
 		if (ret != -EBUSY)
* Unmerged path drivers/gpu/drm/mgag200/mgag200_fb.c
