drm/radeon/kms: unpin fb in atombios crtc disable

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-123.el7
Rebuild_CHGLOG: - [drm] radeon/kms: unpin fb in atombios crtc disable (Jerome Glisse) [1029570]
Rebuild_FUZZ: 95.74%
commit-author Ilija Hadzic <ilijahadzic@gmail.com>
commit 75b871e2d831700d8fd63079eebbbc36b6731bdf
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-123.el7/75b871e2.failed

When drm_helper_disable_unused_functions calls disable
function of the CRTC, it also sets the crtc->fb pointer
to NULL. This can later (when the mode on that CRTC is setup
again from user space) cause ***_do_set_base functions to
"think" that there is no old buffer and skip the unpinning
code. Consequently, the buffer that has been NULL-ified in
drm_helper_disable_unused_functions will never be unpinned
causing a leak in VRAM.

This patch plugs the leak by unpinning the frame buffer
in crtc_disable function.

	Signed-off-by: Ilija Hadzic <ihadzic@research.bell-labs.com>
	Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
(cherry picked from commit 75b871e2d831700d8fd63079eebbbc36b6731bdf)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/gpu/drm/radeon/atombios_crtc.c
diff --cc drivers/gpu/drm/radeon/atombios_crtc.c
index 745664f15c6d,4ad156267381..000000000000
--- a/drivers/gpu/drm/radeon/atombios_crtc.c
+++ b/drivers/gpu/drm/radeon/atombios_crtc.c
@@@ -1839,6 -1910,27 +1839,30 @@@ static void atombios_crtc_disable(struc
  	int i;
  
  	atombios_crtc_dpms(crtc, DRM_MODE_DPMS_OFF);
++<<<<<<< HEAD
++=======
+ 	if (crtc->fb) {
+ 		int r;
+ 		struct radeon_framebuffer *radeon_fb;
+ 		struct radeon_bo *rbo;
+ 
+ 		radeon_fb = to_radeon_framebuffer(crtc->fb);
+ 		rbo = gem_to_radeon_bo(radeon_fb->obj);
+ 		r = radeon_bo_reserve(rbo, false);
+ 		if (unlikely(r))
+ 			DRM_ERROR("failed to reserve rbo before unpin\n");
+ 		else {
+ 			radeon_bo_unpin(rbo);
+ 			radeon_bo_unreserve(rbo);
+ 		}
+ 	}
+ 	/* disable the GRPH */
+ 	if (ASIC_IS_DCE4(rdev))
+ 		WREG32(EVERGREEN_GRPH_ENABLE + radeon_crtc->crtc_offset, 0);
+ 	else if (ASIC_IS_AVIVO(rdev))
+ 		WREG32(AVIVO_D1GRPH_ENABLE + radeon_crtc->crtc_offset, 0);
+ 
++>>>>>>> 75b871e2d831 (drm/radeon/kms: unpin fb in atombios crtc disable)
  	if (ASIC_IS_DCE6(rdev))
  		atombios_powergate_crtc(crtc, ATOM_ENABLE);
  
* Unmerged path drivers/gpu/drm/radeon/atombios_crtc.c
