powerpc: Fix 32-bit frames for signals delivered when transactional

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-123.el7
Rebuild_CHGLOG: - [powerpc] Fix 32-bit frames for signals delivered when transactional (Steve Best) [1059703]
Rebuild_FUZZ: 92.80%
commit-author Paul Mackerras <paulus@samba.org>
commit d765ff23e3181413fb1bed090c8d702165448a84
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-123.el7/d765ff23.failed

Commit d31626f70b61 ("powerpc: Don't corrupt transactional state when
using FP/VMX in kernel") introduced a bug where the uc_link and uc_regs
fields of the ucontext_t that is created to hold the transactional
values of the registers in a 32-bit signal frame didn't get set
correctly.  The reason is that we now clear the MSR_TS bits in the MSR
in save_tm_user_regs(), before the code that sets uc_link and uc_regs.
To fix this, we move the setting of uc_link and uc_regs into the same
if statement that selects whether to call save_tm_user_regs() or
save_user_regs().

	Signed-off-by: Paul Mackerras <paulus@samba.org>
	Signed-off-by: Benjamin Herrenschmidt <benh@kernel.crashing.org>
(cherry picked from commit d765ff23e3181413fb1bed090c8d702165448a84)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/powerpc/kernel/signal_32.c
diff --cc arch/powerpc/kernel/signal_32.c
index 323309963cd3,a67e00aa3caa..000000000000
--- a/arch/powerpc/kernel/signal_32.c
+++ b/arch/powerpc/kernel/signal_32.c
@@@ -1017,19 -1040,7 +1024,23 @@@ int handle_rt_signal32(unsigned long si
  	}
  	regs->link = tramp;
  
++<<<<<<< HEAD
 +#ifdef CONFIG_PPC_TRANSACTIONAL_MEM
 +	if (MSR_TM_ACTIVE(regs->msr)) {
 +		if (__put_user((unsigned long)&rt_sf->uc_transact,
 +			       &rt_sf->uc.uc_link)
 +		    || __put_user((unsigned long)tm_frame, &rt_sf->uc_transact.uc_regs))
 +			goto badframe;
 +	}
 +	else
 +#endif
 +		if (__put_user(0, &rt_sf->uc.uc_link))
 +			goto badframe;
 +
 +	current->thread.fpscr.val = 0;	/* turn off all fp exceptions */
++=======
+ 	current->thread.fp_state.fpscr = 0;	/* turn off all fp exceptions */
++>>>>>>> d765ff23e318 (powerpc: Fix 32-bit frames for signals delivered when transactional)
  
  	/* create a stack frame for the caller of the handler */
  	newsp = ((unsigned long)rt_sf) - (__SIGNAL_FRAMESIZE + 16);
* Unmerged path arch/powerpc/kernel/signal_32.c
