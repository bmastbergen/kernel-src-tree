ALSA: hda - hdmi: Fix programmed active channel count

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-123.el7
Rebuild_CHGLOG: - [alsa] hda/hdmi: Fix programmed active channel count (Jaroslav Kysela) [1044022]
Rebuild_FUZZ: 89.80%
commit-author Anssi Hannula <anssi.hannula@iki.fi>
commit 1df5a06abbaa876ecc01ea84064cdffb4f52a1a1
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-123.el7/1df5a06a.failed

Currently the converter channel count is set to the number of actual
input channels. The audio infoframe channel count field is set
similarly.

However, sometimes the used channel map does not map all input channels
to outputs. Notably, 3 channel modes (e.g. 2.1) require a dummy input
channel so there are 4 input channels. According to the HDA
specification, converter channel count should be programmed according to
the number of _active_ channels.

On Intel HDMI codecs (but not on NVIDIA), setting the converter channel
to a higher value than there are actually mapped channels to HDMI slots
will cause no audio to be output at all.

Note that the effects of this issue are currently partially masked by
other bugs that prevent the driver from actually unmapping channels in
certain cases. For example, if a 4 channel stream is first created and
prepared, it gets a FL,FR,RL,RR mapping (ALSA->HDMI slot mapping 0->0,
1->1, 2->4, 3->5). If one thereafter assigns a FR,FL,FC mapping to it,
the driver will remap 2->3 but fail to unmap 2->4 and 3->5, so there are
still 4 active channels and the issue will not trigger in this case.
These bugs will be fixed separately.

Fix the channel counts in the converter channel count field and in the
audio infoframe channel count field to match the actual number of active
channels.

	Signed-off-by: Anssi Hannula <anssi.hannula@iki.fi>
	Signed-off-by: Takashi Iwai <tiwai@suse.de>
(cherry picked from commit 1df5a06abbaa876ecc01ea84064cdffb4f52a1a1)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	sound/pci/hda/patch_hdmi.c
diff --cc sound/pci/hda/patch_hdmi.c
index 346f23898dd1,4efaca89d805..000000000000
--- a/sound/pci/hda/patch_hdmi.c
+++ b/sound/pci/hda/patch_hdmi.c
@@@ -878,18 -895,25 +879,23 @@@ static bool hdmi_infoframe_uptodate(str
  	return true;
  }
  
 -static void hdmi_setup_audio_infoframe(struct hda_codec *codec,
 -				       struct hdmi_spec_per_pin *per_pin,
 -				       bool non_pcm)
 +static void hdmi_setup_audio_infoframe(struct hda_codec *codec, int pin_idx,
 +				       bool non_pcm,
 +				       struct snd_pcm_substream *substream)
  {
 +	struct hdmi_spec *spec = codec->spec;
 +	struct hdmi_spec_per_pin *per_pin = get_pin(spec, pin_idx);
  	hda_nid_t pin_nid = per_pin->pin_nid;
++<<<<<<< HEAD
 +	int channels = substream->runtime->channels;
++=======
+ 	int channels = per_pin->channels;
+ 	int active_channels;
++>>>>>>> 1df5a06abbaa (ALSA: hda - hdmi: Fix programmed active channel count)
  	struct hdmi_eld *eld;
- 	int ca;
+ 	int ca, ordered_ca;
  	union audio_infoframe ai;
  
 -	if (!channels)
 -		return;
 -
 -	if (is_haswell(codec))
 -		snd_hda_codec_write(codec, pin_nid, 0,
 -					    AC_VERB_SET_AMP_GAIN_MUTE,
 -					    AMP_OUT_UNMUTE);
 -
  	eld = &per_pin->sink_eld;
  	if (!eld->monitor_present)
  		return;
@@@ -1216,9 -1237,10 +1227,10 @@@ static int hdmi_pcm_open(struct hda_pcm
  	per_cvt = get_cvt(spec, cvt_idx);
  	/* Claim converter */
  	per_cvt->assigned = 1;
+ 	per_pin->cvt_nid = per_cvt->cvt_nid;
  	hinfo->nid = per_cvt->cvt_nid;
  
 -	snd_hda_codec_write_cache(codec, per_pin->pin_nid, 0,
 +	snd_hda_codec_write(codec, per_pin->pin_nid, 0,
  			    AC_VERB_SET_CONNECT_SEL,
  			    mux_idx);
  
@@@ -1525,10 -1557,10 +1537,14 @@@ static int generic_hdmi_playback_pcm_pr
  	bool non_pcm;
  
  	non_pcm = check_non_pcm_per_cvt(codec, cvt_nid);
 -	per_pin->channels = substream->runtime->channels;
 -	per_pin->setup = true;
  
++<<<<<<< HEAD
 +	hdmi_set_channel_count(codec, cvt_nid, substream->runtime->channels);
 +
 +	hdmi_setup_audio_infoframe(codec, pin_idx, non_pcm, substream);
++=======
+ 	hdmi_setup_audio_infoframe(codec, per_pin, non_pcm);
++>>>>>>> 1df5a06abbaa (ALSA: hda - hdmi: Fix programmed active channel count)
  
  	return hdmi_setup_stream(codec, cvt_nid, pin_nid, stream_tag, format);
  }
* Unmerged path sound/pci/hda/patch_hdmi.c
