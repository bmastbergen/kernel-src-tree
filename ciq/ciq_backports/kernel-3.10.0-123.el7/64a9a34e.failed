mm: numa: do not automatically migrate KSM pages

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-123.el7
Rebuild_CHGLOG: - [mm] numa: Do not automatically migrate KSM pages (Rik van Riel) [1040200]
Rebuild_FUZZ: 95.65%
commit-author Mel Gorman <mgorman@suse.de>
commit 64a9a34e22896dad430e21a28ad8cb00a756fefc
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-123.el7/64a9a34e.failed

KSM pages can be shared between tasks that are not necessarily related
to each other from a NUMA perspective.  This patch causes those pages to
be ignored by automatic NUMA balancing so they do not migrate and do not
cause unrelated tasks to be grouped together.

	Signed-off-by: Mel Gorman <mgorman@suse.de>
	Reviewed-by: Rik van Riel <riel@redhat.com>
	Cc: Alex Thorlton <athorlton@sgi.com>
	Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
	Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
(cherry picked from commit 64a9a34e22896dad430e21a28ad8cb00a756fefc)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	mm/mprotect.c
diff --cc mm/mprotect.c
index ac7046362258,7332c1785744..000000000000
--- a/mm/mprotect.c
+++ b/mm/mprotect.c
@@@ -65,13 -64,7 +66,17 @@@ static unsigned long change_pte_range(s
  
  				ptent = *pte;
  				page = vm_normal_page(vma, addr, oldpte);
++<<<<<<< HEAD
 +				if (page) {
 +					int this_nid = page_to_nid(page);
 +					if (last_nid == -1)
 +						last_nid = this_nid;
 +					if (last_nid != this_nid)
 +						all_same_node = false;
 +
++=======
+ 				if (page && !PageKsm(page)) {
++>>>>>>> 64a9a34e2289 (mm: numa: do not automatically migrate KSM pages)
  					if (!pte_numa(oldpte)) {
  						ptent = pte_mknuma(ptent);
  						set_pte_at(mm, addr, pte, ptent);
* Unmerged path mm/mprotect.c
