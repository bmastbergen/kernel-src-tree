snd/hda: add runtime suspend/resume on optimus support (v4)

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-123.el7
Rebuild_CHGLOG: - [alsa] snd/hda: add runtime suspend/resume on optimus support (Jaroslav Kysela) [1044022]
Rebuild_FUZZ: 95.58%
commit-author Dave Airlie <airlied@gmail.com>
commit 246efa4a072f3a2e03010ef0b78b0974ec69c377
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-123.el7/246efa4a.failed

Add support for HDMI audio device on VGA cards that powerdown
to D3cold using non-standard ACPI/PCI infrastructure (optimus).

This does a couple of things to make it work:

a) add a set of power ops for the hdmi domain, and enables them
via vga_switcheroo when we are a switcheroo controlled card. This
just replaces the runtime resume operation so that when the card
is in D3cold the userspace pci config space access via sysfs,
the vga switcheroon runtime resume gets called first and it calls
the GPU resume callback before calling the sound card runtime
resume.

b) standard ACPI/PCI stacks won't put a device into D3cold without
an ACPI handle, but since the hdmi audio devices on gpus don't have
an ACPI handle, we need to manually force the device into D3cold
after suspend from the switcheroo path only.

c) don't try and do runtime s/r when the GPU is off.

d) call runtime suspend/resume during switcheroo suspend/resume
this is to make sure the runtime stack knows to try and resume
the hdmi audio device for pci config space access.

v2: fix incorrect runtime call suspend->resume.

v3: rework irq handler to avoid false irq when we are resuming
but haven't runtime resumed yet, don't bother trying D3cold,
it won't work, just set it manually ourselves, move runtime s/r
calls outside the main s/r hook. enable dnyamic pm properly by
dropping reference.

v4: put back irq handler check just wrap it with cap check

	Acked-by: Takashi Iwai <tiwai@suse.de>
	Signed-off-by: Dave Airlie <airlied@redhat.com>
(cherry picked from commit 246efa4a072f3a2e03010ef0b78b0974ec69c377)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	sound/pci/hda/hda_intel.c
diff --cc sound/pci/hda/hda_intel.c
index cfca97ee3127,bf5e58ec1efe..000000000000
--- a/sound/pci/hda/hda_intel.c
+++ b/sound/pci/hda/hda_intel.c
@@@ -2972,6 -2994,14 +2982,17 @@@ static int azx_runtime_resume(struct de
  	struct snd_card *card = dev_get_drvdata(dev);
  	struct azx *chip = card->private_data;
  
++<<<<<<< HEAD
++=======
+ 	if (chip->disabled)
+ 		return 0;
+ 
+ 	if (!(chip->driver_caps & AZX_DCAPS_PM_RUNTIME))
+ 		return 0;
+ 
+ 	if (chip->driver_caps & AZX_DCAPS_I915_POWERWELL)
+ 		hda_display_power(true);
++>>>>>>> 246efa4a072f (snd/hda: add runtime suspend/resume on optimus support (v4))
  	azx_init_pci(chip);
  	azx_init_chip(chip, 1);
  	return 0;
@@@ -3833,6 -3915,8 +3866,11 @@@ static int azx_probe_continue(struct az
  	power_down_all_codecs(chip);
  	azx_notifier_register(chip);
  	azx_add_card_list(chip);
++<<<<<<< HEAD
++=======
+ 	if ((chip->driver_caps & AZX_DCAPS_PM_RUNTIME) || chip->use_vga_switcheroo)
+ 		pm_runtime_put_noidle(&pci->dev);
++>>>>>>> 246efa4a072f (snd/hda: add runtime suspend/resume on optimus support (v4))
  
  	return 0;
  
* Unmerged path sound/pci/hda/hda_intel.c
