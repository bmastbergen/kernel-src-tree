powerpc: Only save/restore SDR1 if in hypervisor mode

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-123.el7
Rebuild_CHGLOG: - [powerpc] Only save/restore SDR1 if in hypervisor mode (Steve Best) [1018639]
Rebuild_FUZZ: 90.72%
commit-author Dan Streetman <ddstreet@ieee.org>
commit 711b5138d54fcfd5e312cea895d6e706a46eff19
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-123.el7/711b5138.failed

Currently, when not in hypervisor mode the kernel
Oopses during suspend or hibernation when accessing
the SDR1 register, because it is only available
in hypervisor mode.  Access to it needs to be
protected in BEGIN/END_FW_FTR_SECTION.

	Signed-off-by: Dan Streetman <ddstreet@ieee.org>
	Cc: Benjamin Herrenschmidt <benh@kernel.crashing.org>
	Reported-by: Jimmy Pan <jipan@redhat.com>
	Tested-by: Jimmy Pan <jipan@redhat.com>
	Signed-off-by: Benjamin Herrenschmidt <benh@kernel.crashing.org>
(cherry picked from commit 711b5138d54fcfd5e312cea895d6e706a46eff19)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/powerpc/kernel/swsusp_asm64.S
diff --cc arch/powerpc/kernel/swsusp_asm64.S
index 86ac1d90d02b,988f38dced0f..000000000000
--- a/arch/powerpc/kernel/swsusp_asm64.S
+++ b/arch/powerpc/kernel/swsusp_asm64.S
@@@ -103,8 -112,17 +103,22 @@@ _GLOBAL(swsusp_arch_suspend
  	SAVE_REGISTER(r30)
  	SAVE_REGISTER(r31)
  	SAVE_SPECIAL(MSR)
++<<<<<<< HEAD
 +	SAVE_SPECIAL(SDR1)
 +	SAVE_SPECIAL(XER)
++=======
+ 	SAVE_SPECIAL(XER)
+ #ifdef CONFIG_PPC_BOOK3S_64
+ BEGIN_FW_FTR_SECTION
+ 	SAVE_SPECIAL(SDR1)
+ END_FW_FTR_SECTION_IFCLR(FW_FEATURE_LPAR)
+ #else
+ 	SAVE_SPR(TCR)
+ 
+ 	/* Save SPRG1, SPRG1 be used save paca */
+ 	SAVE_SPR(SPRG1)
+ #endif
++>>>>>>> 711b5138d54f (powerpc: Only save/restore SDR1 if in hypervisor mode)
  
  	/* we push the stack up 128 bytes but don't store the
  	 * stack pointer on the stack like a real stackframe */
@@@ -211,7 -231,30 +225,31 @@@ nothing_to_copy
  	/* can't use RESTORE_SPECIAL(MSR) */
  	ld	r0, SL_MSR(r11)
  	mtmsrd	r0, 0
+ BEGIN_FW_FTR_SECTION
  	RESTORE_SPECIAL(SDR1)
++<<<<<<< HEAD
++=======
+ END_FW_FTR_SECTION_IFCLR(FW_FEATURE_LPAR)
+ #else
+ 	/* Restore SPRG1, be used to save paca */
+ 	ld	r0, SL_SPRG1(r11)
+ 	mtsprg	1, r0
+ 
+ 	RESTORE_SPECIAL(MSR)
+ 
+ 	/* Restore TCR and clear any pending bits in TSR. */
+ 	RESTORE_SPR(TCR)
+ 	lis	r0, (TSR_ENW | TSR_WIS | TSR_DIS | TSR_FIS)@h
+ 	mtspr	SPRN_TSR, r0
+ 
+ 	/* Kick decrementer */
+ 	li	r0, 1
+ 	mtdec	r0
+ 
+ 	/* Invalidate all tlbs */
+ 	bl	_tlbil_all
+ #endif
++>>>>>>> 711b5138d54f (powerpc: Only save/restore SDR1 if in hypervisor mode)
  	RESTORE_SPECIAL(XER)
  
  	sync
* Unmerged path arch/powerpc/kernel/swsusp_asm64.S
