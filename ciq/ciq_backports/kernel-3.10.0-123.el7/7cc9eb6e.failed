netfilter: SYNPROXY: let unrelated packets continue

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-123.el7
commit-author Jesper Dangaard Brouer <brouer@redhat.com>
commit 7cc9eb6ef78d0dcb97d543ea19966486e98afa0b
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-123.el7/7cc9eb6e.failed

Packets reaching SYNPROXY were default dropped, as they were most
likely invalid (given the recommended state matching).  This
patch, changes SYNPROXY target to let packets, not consumed,
continue being processed by the stack.

This will be more in line other target modules. As it will allow
more flexible configurations of handling, logging or matching on
packets in INVALID states.

	Signed-off-by: Jesper Dangaard Brouer <brouer@redhat.com>
	Acked-by: Patrick McHardy <kaber@trash.net>
	Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
(cherry picked from commit 7cc9eb6ef78d0dcb97d543ea19966486e98afa0b)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/ipv4/netfilter/ipt_SYNPROXY.c
#	net/ipv6/netfilter/ip6t_SYNPROXY.c
diff --cc net/ipv6/netfilter/ip6t_SYNPROXY.c
index 4270a9b145e5,19cfea8dbcaa..000000000000
--- a/net/ipv6/netfilter/ip6t_SYNPROXY.c
+++ b/net/ipv6/netfilter/ip6t_SYNPROXY.c
@@@ -300,11 -300,15 +300,19 @@@ synproxy_tg6(struct sk_buff *skb, cons
  					  XT_SYNPROXY_OPT_ECN);
  
  		synproxy_send_client_synack(skb, th, &opts);
++<<<<<<< HEAD
 +	} else if (th->ack && !(th->fin || th->rst))
++=======
+ 		return NF_DROP;
+ 
+ 	} else if (th->ack && !(th->fin || th->rst || th->syn)) {
++>>>>>>> 7cc9eb6ef78d (netfilter: SYNPROXY: let unrelated packets continue)
  		/* ACK from client */
  		synproxy_recv_client_ack(snet, skb, th, &opts, ntohl(th->seq));
+ 		return NF_DROP;
+ 	}
  
- 	return NF_DROP;
+ 	return XT_CONTINUE;
  }
  
  static unsigned int ipv6_synproxy_hook(unsigned int hooknum,
* Unmerged path net/ipv4/netfilter/ipt_SYNPROXY.c
* Unmerged path net/ipv4/netfilter/ipt_SYNPROXY.c
* Unmerged path net/ipv6/netfilter/ip6t_SYNPROXY.c
