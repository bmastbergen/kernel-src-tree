NFSv4: Fix up nfs4_proc_lookup_mountpoint

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-123.el7
Rebuild_CHGLOG: - [fs] nfs Fix up nfs4_proc_lookup_mountpoint (Jeff Layton) [1007357]
Rebuild_FUZZ: 96.20%
commit-author Trond Myklebust <Trond.Myklebust@netapp.com>
commit b72888cb0ba63b2dfc6c8d3cd78a7fea584bebc6
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-123.el7/b72888cb.failed

Currently, we do not check the return value of client = rpc_clone_client(),
nor do we shut down the resulting cloned rpc_clnt in the case where a
NFS4ERR_WRONGSEC has caused nfs4_proc_lookup_common() to replace the
original value of 'client' (causing a memory leak).

Fix both issues and simplify the code by moving the call to
rpc_clone_client() until after nfs4_proc_lookup_common() has
done its business.

	Reported-by: Andy Adamson <andros@netapp.com>
	Signed-off-by: Trond Myklebust <Trond.Myklebust@netapp.com>
(cherry picked from commit b72888cb0ba63b2dfc6c8d3cd78a7fea584bebc6)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/nfs/nfs4proc.c
diff --cc fs/nfs/nfs4proc.c
index 2a07dca61711,108a774095f7..000000000000
--- a/fs/nfs/nfs4proc.c
+++ b/fs/nfs/nfs4proc.c
@@@ -2926,15 -3071,13 +2926,19 @@@ struct rpc_clnt 
  nfs4_proc_lookup_mountpoint(struct inode *dir, struct qstr *name,
  			    struct nfs_fh *fhandle, struct nfs_fattr *fattr)
  {
+ 	struct rpc_clnt *client = NFS_CLIENT(dir);
  	int status;
- 	struct rpc_clnt *client = rpc_clone_client(NFS_CLIENT(dir));
  
++<<<<<<< HEAD
 +	status = nfs4_proc_lookup_common(&client, dir, name, fhandle, fattr);
 +	if (status < 0) {
 +		rpc_shutdown_client(client);
++=======
+ 	status = nfs4_proc_lookup_common(&client, dir, name, fhandle, fattr, NULL);
+ 	if (status < 0)
++>>>>>>> b72888cb0ba6 (NFSv4: Fix up nfs4_proc_lookup_mountpoint)
  		return ERR_PTR(status);
- 	}
- 	return client;
+ 	return (client == NFS_CLIENT(dir)) ? rpc_clone_client(client) : client;
  }
  
  static int _nfs4_proc_access(struct inode *inode, struct nfs_access_entry *entry)
* Unmerged path fs/nfs/nfs4proc.c
