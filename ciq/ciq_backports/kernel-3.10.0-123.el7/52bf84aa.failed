sched/numa, mm: Remove p->numa_migrate_deferred

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-123.el7
Rebuild_CHGLOG: - [mm] sched/numa: Remove p->numa_migrate_deferred (Rik van Riel) [1049096]
Rebuild_FUZZ: 95.56%
commit-author Rik van Riel <riel@redhat.com>
commit 52bf84aa206cd2c2516dfa3e03b578edf8a3242f
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-123.el7/52bf84aa.failed

Excessive migration of pages can hurt the performance of workloads
that span multiple NUMA nodes.  However, it turns out that the
p->numa_migrate_deferred knob is a really big hammer, which does
reduce migration rates, but does not actually help performance.

Now that the second stage of the automatic numa balancing code
has stabilized, it is time to replace the simplistic migration
deferral code with something smarter.

	Signed-off-by: Rik van Riel <riel@redhat.com>
	Acked-by: Mel Gorman <mgorman@suse.de>
	Signed-off-by: Peter Zijlstra <peterz@infradead.org>
	Cc: Chegu Vinod <chegu_vinod@hp.com>
Link: http://lkml.kernel.org/r/1390860228-21539-2-git-send-email-riel@redhat.com
	Signed-off-by: Ingo Molnar <mingo@kernel.org>
(cherry picked from commit 52bf84aa206cd2c2516dfa3e03b578edf8a3242f)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	Documentation/sysctl/kernel.txt
#	include/linux/sched.h
#	mm/mempolicy.c
diff --cc Documentation/sysctl/kernel.txt
index 77932153d642,760f6e6a2e40..000000000000
--- a/Documentation/sysctl/kernel.txt
+++ b/Documentation/sysctl/kernel.txt
@@@ -373,8 -385,8 +373,13 @@@ guarantee. If the target workload is al
  feature should be disabled. Otherwise, if the system overhead from the
  feature is too high then the rate the kernel samples for NUMA hinting
  faults may be controlled by the numa_balancing_scan_period_min_ms,
++<<<<<<< HEAD
 +numa_balancing_scan_delay_ms, numa_balancing_scan_period_reset,
 +numa_balancing_scan_period_max_ms and numa_balancing_scan_size_mb sysctls.
++=======
+ numa_balancing_scan_delay_ms, numa_balancing_scan_period_max_ms,
+ numa_balancing_scan_size_mb, and numa_balancing_settle_count sysctls.
++>>>>>>> 52bf84aa206c (sched/numa, mm: Remove p->numa_migrate_deferred)
  
  ==============================================================
  
@@@ -416,9 -427,6 +421,12 @@@ rate for each task
  numa_balancing_scan_size_mb is how many megabytes worth of pages are
  scanned for a given scan.
  
++<<<<<<< HEAD
 +numa_balancing_scan_period_reset is a blunt instrument that controls how
 +often a tasks scan delay is reset to detect sudden changes in task behaviour.
 +
++=======
++>>>>>>> 52bf84aa206c (sched/numa, mm: Remove p->numa_migrate_deferred)
  ==============================================================
  
  osrelease, ostype & version:
diff --cc include/linux/sched.h
index 933a94b9c8f9,d572d5ba650f..000000000000
--- a/include/linux/sched.h
+++ b/include/linux/sched.h
@@@ -1347,9 -1454,10 +1347,14 @@@ struct task_struct 
  #endif
  #ifdef CONFIG_NUMA_BALANCING
  	int numa_scan_seq;
 +	int numa_migrate_seq;
  	unsigned int numa_scan_period;
  	unsigned int numa_scan_period_max;
++<<<<<<< HEAD
++=======
+ 	int numa_preferred_nid;
+ 	unsigned long numa_migrate_retry;
++>>>>>>> 52bf84aa206c (sched/numa, mm: Remove p->numa_migrate_deferred)
  	u64 node_stamp;			/* migration stamp  */
  	struct callback_head numa_work;
  
diff --cc mm/mempolicy.c
index f05aa4c2c73c,68d5c7f7164e..000000000000
--- a/mm/mempolicy.c
+++ b/mm/mempolicy.c
@@@ -2337,9 -2404,10 +2337,16 @@@ int mpol_misplaced(struct page *page, s
  		 * it less likely we act on an unlikely task<->page
  		 * relation.
  		 */
++<<<<<<< HEAD
 +		last_nid = page_nid_xchg_last(page, polnid);
 +		if (last_nid != polnid)
 +			goto out;
++=======
+ 		last_cpupid = page_cpupid_xchg_last(page, this_cpupid);
+ 		if (!cpupid_pid_unset(last_cpupid) && cpupid_to_nid(last_cpupid) != thisnid) {
+ 			goto out;
+ 		}
++>>>>>>> 52bf84aa206c (sched/numa, mm: Remove p->numa_migrate_deferred)
  	}
  
  	if (curnid != polnid)
* Unmerged path Documentation/sysctl/kernel.txt
* Unmerged path include/linux/sched.h
* Unmerged path mm/mempolicy.c
