ALSA: hda - block HDMI jack reports while repolling

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-123.el7
Rebuild_CHGLOG: - [alsa] hda: block HDMI jack reports while repolling (Jaroslav Kysela) [1044022]
Rebuild_FUZZ: 90.53%
commit-author David Henningsson <david.henningsson@canonical.com>
commit 464837a7bc0a3495e3490e3bf85099bb2300efbd
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-123.el7/464837a7.failed

This fixes a race condition in case several monitors are being
repolled in parallel.

	Signed-off-by: David Henningsson <david.henningsson@canonical.com>
	Signed-off-by: Takashi Iwai <tiwai@suse.de>
(cherry picked from commit 464837a7bc0a3495e3490e3bf85099bb2300efbd)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	sound/pci/hda/patch_hdmi.c
diff --cc sound/pci/hda/patch_hdmi.c
index f36275527fe5,a96403a828af..000000000000
--- a/sound/pci/hda/patch_hdmi.c
+++ b/sound/pci/hda/patch_hdmi.c
@@@ -1292,8 -1475,9 +1292,9 @@@ static int hdmi_read_pin_conn(struct hd
  	return 0;
  }
  
 -static bool hdmi_present_sense(struct hdmi_spec_per_pin *per_pin, int repoll)
 +static void hdmi_present_sense(struct hdmi_spec_per_pin *per_pin, int repoll)
  {
+ 	struct hda_jack_tbl *jack;
  	struct hda_codec *codec = per_pin->codec;
  	struct hdmi_spec *spec = codec->spec;
  	struct hdmi_eld *eld = &spec->temp_eld;
@@@ -1366,6 -1560,18 +1367,21 @@@
  		snd_ctl_notify(codec->bus->card,
  			       SNDRV_CTL_EVENT_MASK_VALUE | SNDRV_CTL_EVENT_MASK_INFO,
  			       &per_pin->eld_ctl->id);
++<<<<<<< HEAD
++=======
+  unlock:
+ 	if ((codec->vendor_id & 0xffff0000) == 0x10020000)
+ 		ret = true; /* AMD codecs create ELD by itself */
+ 	else
+ 		ret = !repoll || !pin_eld->monitor_present || pin_eld->eld_valid;
+ 
+ 	jack = snd_hda_jack_tbl_get(codec, pin_nid);
+ 	if (jack)
+ 		jack->block_report = !ret;
+ 
+ 	mutex_unlock(&per_pin->lock);
+ 	return ret;
++>>>>>>> 464837a7bc0a (ALSA: hda - block HDMI jack reports while repolling)
  }
  
  static void hdmi_repoll_eld(struct work_struct *work)
* Unmerged path sound/pci/hda/patch_hdmi.c
