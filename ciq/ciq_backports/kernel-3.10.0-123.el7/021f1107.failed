net/mlx4_en: Fix pages never dma unmapped on rx

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-123.el7
Rebuild_CHGLOG: - [ethernet] mlx4: Fix pages never dma unmapped on rx (Steve Best) [1030192]
Rebuild_FUZZ: 91.95%
commit-author Amir Vadai <amirv@mellanox.com>
commit 021f1107ffdae7a82af6c53f4c52654062e365c6
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-123.el7/021f1107.failed

This patch fixes a bug introduced by commit 51151a16 (mlx4: allow
order-0 memory allocations in RX path).

dma_unmap_page never reached because condition to detect last fragment
in page is wrong. offset+frag_stride can't be greater than size, need to
make sure no additional frag will fit in page => compare offset +
frag_stride + next_frag_size instead.
next_frag_size is the same as the current one, since page is shared only
with frags of the same size.

CC: Eric Dumazet <edumazet@google.com>
	Signed-off-by: Amir Vadai <amirv@mellanox.com>
	Acked-by: Eric Dumazet <edumazet@google.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 021f1107ffdae7a82af6c53f4c52654062e365c6)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlx4/en_rx.c
diff --cc drivers/net/ethernet/mellanox/mlx4/en_rx.c
index 8ddd5a99e21b,afe2efa69c86..000000000000
--- a/drivers/net/ethernet/mellanox/mlx4/en_rx.c
+++ b/drivers/net/ethernet/mellanox/mlx4/en_rx.c
@@@ -130,10 -135,12 +130,18 @@@ static void mlx4_en_free_frag(struct ml
  			      int i)
  {
  	const struct mlx4_en_frag_info *frag_info = &priv->frag_info[i];
+ 	u32 next_frag_end = frags[i].page_offset + 2 * frag_info->frag_stride;
  
++<<<<<<< HEAD
 +	if (frags[i].offset + frag_info->frag_stride > frags[i].size)
 +		dma_unmap_page(priv->ddev, frags[i].dma, frags[i].size,
 +					 PCI_DMA_FROMDEVICE);
++=======
+ 
+ 	if (next_frag_end > frags[i].page_size)
+ 		dma_unmap_page(priv->ddev, frags[i].dma, frags[i].page_size,
+ 			       PCI_DMA_FROMDEVICE);
++>>>>>>> 021f1107ffda (net/mlx4_en: Fix pages never dma unmapped on rx)
  
  	if (frags[i].page)
  		put_page(frags[i].page);
* Unmerged path drivers/net/ethernet/mellanox/mlx4/en_rx.c
