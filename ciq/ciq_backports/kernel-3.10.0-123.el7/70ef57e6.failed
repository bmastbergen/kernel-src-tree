mm: exclude memoryless nodes from zone_reclaim

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-123.el7
Rebuild_CHGLOG: - [mm] exclude memoryless nodes from zone_reclaim (Steve Best) [1070491]
Rebuild_FUZZ: 95.45%
commit-author Michal Hocko <mhocko@suse.cz>
commit 70ef57e6c22c3323dce179b7d0d433c479266612
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-123.el7/70ef57e6.failed

We had a report about strange OOM killer strikes on a PPC machine
although there was a lot of swap free and a tons of anonymous memory
which could be swapped out.  In the end it turned out that the OOM was a
side effect of zone reclaim which wasn't unmapping and swapping out and
so the system was pushed to the OOM.  Although this sounds like a bug
somewhere in the kswapd vs.  zone reclaim vs.  direct reclaim
interaction numactl on the said hardware suggests that the zone reclaim
should not have been set in the first place:

  node 0 cpus: 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15
  node 0 size: 0 MB
  node 0 free: 0 MB
  node 2 cpus:
  node 2 size: 7168 MB
  node 2 free: 6019 MB
  node distances:
  node   0   2
  0:  10  40
  2:  40  10

So all the CPUs are associated with Node0 which doesn't have any memory
while Node2 contains all the available memory.  Node distances cause an
automatic zone_reclaim_mode enabling.

Zone reclaim is intended to keep the allocations local but this doesn't
make any sense on the memoryless nodes.  So let's exclude such nodes for
init_zone_allows_reclaim which evaluates zone reclaim behavior and
suitable reclaim_nodes.

	Signed-off-by: Michal Hocko <mhocko@suse.cz>
	Acked-by: David Rientjes <rientjes@google.com>
	Acked-by: Nishanth Aravamudan <nacc@linux.vnet.ibm.com>
	Tested-by: Nishanth Aravamudan <nacc@linux.vnet.ibm.com>
	Acked-by: Mel Gorman <mgorman@suse.de>
	Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
	Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
(cherry picked from commit 70ef57e6c22c3323dce179b7d0d433c479266612)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	mm/page_alloc.c
diff --cc mm/page_alloc.c
index ff41f872a966,336ee925f756..000000000000
--- a/mm/page_alloc.c
+++ b/mm/page_alloc.c
@@@ -4809,8 -4919,13 +4809,18 @@@ void __paginginit free_area_init_node(i
  
  	pgdat->node_id = nid;
  	pgdat->node_start_pfn = node_start_pfn;
++<<<<<<< HEAD
 +	init_zone_allows_reclaim(nid);
 +	calculate_node_totalpages(pgdat, zones_size, zholes_size);
++=======
+ 	if (node_state(nid, N_MEMORY))
+ 		init_zone_allows_reclaim(nid);
+ #ifdef CONFIG_HAVE_MEMBLOCK_NODE_MAP
+ 	get_pfn_range_for_nid(nid, &start_pfn, &end_pfn);
+ #endif
+ 	calculate_node_totalpages(pgdat, start_pfn, end_pfn,
+ 				  zones_size, zholes_size);
++>>>>>>> 70ef57e6c22c (mm: exclude memoryless nodes from zone_reclaim)
  
  	alloc_node_mem_map(pgdat);
  #ifdef CONFIG_FLAT_NODE_MEM_MAP
* Unmerged path mm/page_alloc.c
