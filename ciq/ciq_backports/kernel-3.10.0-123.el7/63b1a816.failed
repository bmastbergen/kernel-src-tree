futexes: Fix futex_hashsize initialization

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-123.el7
commit-author Heiko Carstens <heiko.carstens@de.ibm.com>
commit 63b1a81699c2a45c9f737419b1ec1da0ecf92812
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-123.el7/63b1a816.failed

"futexes: Increase hash table size for better performance"
introduces a new alloc_large_system_hash() call.

alloc_large_system_hash() however may allocate less memory than
requested, e.g. limited by MAX_ORDER.

Hence pass a pointer to alloc_large_system_hash() which will
contain the hash shift when the function returns. Afterwards
correctly set futex_hashsize.

Fixes a crash on s390 where the requested allocation size was
4MB but only 1MB was allocated.

	Signed-off-by: Heiko Carstens <heiko.carstens@de.ibm.com>
	Cc: Darren Hart <dvhart@linux.intel.com>
	Cc: Peter Zijlstra <peterz@infradead.org>
	Cc: Paul E. McKenney <paulmck@linux.vnet.ibm.com>
	Cc: Waiman Long <Waiman.Long@hp.com>
	Cc: Jason Low <jason.low2@hp.com>
	Cc: Davidlohr Bueso <davidlohr@hp.com>
Link: http://lkml.kernel.org/r/20140116135450.GA4345@osiris
	Signed-off-by: Ingo Molnar <mingo@kernel.org>
(cherry picked from commit 63b1a81699c2a45c9f737419b1ec1da0ecf92812)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	kernel/futex.c
diff --cc kernel/futex.c
index 21267342de0e,1ddc4498f1e1..000000000000
--- a/kernel/futex.c
+++ b/kernel/futex.c
@@@ -2841,8 -2844,21 +2841,26 @@@ SYSCALL_DEFINE6(futex, u32 __user *, ua
  static int __init futex_init(void)
  {
  	u32 curval;
++<<<<<<< HEAD
 +	int i;
 +
++=======
+ 	unsigned int futex_shift;
+ 	unsigned long i;
+ 
+ #if CONFIG_BASE_SMALL
+ 	futex_hashsize = 16;
+ #else
+ 	futex_hashsize = roundup_pow_of_two(256 * num_possible_cpus());
+ #endif
+ 
+ 	futex_queues = alloc_large_system_hash("futex", sizeof(*futex_queues),
+ 					       futex_hashsize, 0,
+ 					       futex_hashsize < 256 ? HASH_SMALL : 0,
+ 					       &futex_shift, NULL,
+ 					       futex_hashsize, futex_hashsize);
+ 	futex_hashsize = 1UL << futex_shift;
++>>>>>>> 63b1a81699c2 (futexes: Fix futex_hashsize initialization)
  	/*
  	 * This will fail and we want it. Some arch implementations do
  	 * runtime detection of the futex_atomic_cmpxchg_inatomic()
* Unmerged path kernel/futex.c
