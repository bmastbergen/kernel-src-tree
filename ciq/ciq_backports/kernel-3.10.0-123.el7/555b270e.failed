iscsi-target: Fix connection reset hang with percpu_ida_alloc

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-123.el7
commit-author Nicholas Bellinger <nab@linux-iscsi.org>
commit 555b270e25b0279b98083518a85f4b1da144a181
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-123.el7/555b270e.failed

This patch addresses a bug where connection reset would hang
indefinately once percpu_ida_alloc() was starved for tags, due
to the fact that it always assumed uninterruptible sleep mode.

So now make percpu_ida_alloc() check for signal_pending_state() for
making interruptible sleep optional, and convert iscsit_allocate_cmd()
to set TASK_INTERRUPTIBLE for GFP_KERNEL, or TASK_RUNNING for
GFP_ATOMIC.

	Reported-by: Linus Torvalds <torvalds@linux-foundation.org>
	Cc: Kent Overstreet <kmo@daterainc.com>
	Cc: <stable@vger.kernel.org> #3.12+
	Signed-off-by: Nicholas Bellinger <nab@linux-iscsi.org>
(cherry picked from commit 555b270e25b0279b98083518a85f4b1da144a181)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/target/iscsi/iscsi_target_util.c
#	lib/percpu_ida.c
diff --cc drivers/target/iscsi/iscsi_target_util.c
index 08a3bacef0c5,5477ecabc00e..000000000000
--- a/drivers/target/iscsi/iscsi_target_util.c
+++ b/drivers/target/iscsi/iscsi_target_util.c
@@@ -168,12 -155,19 +168,18 @@@ struct iscsi_cmd *iscsit_alloc_cmd(stru
  struct iscsi_cmd *iscsit_allocate_cmd(struct iscsi_conn *conn, gfp_t gfp_mask)
  {
  	struct iscsi_cmd *cmd;
++<<<<<<< HEAD
++=======
+ 	struct se_session *se_sess = conn->sess->se_sess;
+ 	int size, tag, state = (gfp_mask & __GFP_WAIT) ? TASK_INTERRUPTIBLE :
+ 				TASK_RUNNING;
++>>>>>>> 555b270e25b0 (iscsi-target: Fix connection reset hang with percpu_ida_alloc)
  
 -	tag = percpu_ida_alloc(&se_sess->sess_tag_pool, state);
 -	if (tag < 0)
 +	cmd = conn->conn_transport->iscsit_alloc_cmd(conn, gfp_mask);
 +	if (!cmd) {
 +		pr_err("Unable to allocate memory for struct iscsi_cmd.\n");
  		return NULL;
 -
 -	size = sizeof(struct iscsi_cmd) + conn->conn_transport->priv_size;
 -	cmd = (struct iscsi_cmd *)(se_sess->sess_cmd_map + (tag * size));
 -	memset(cmd, 0, size);
 -
 -	cmd->se_cmd.map_tag = tag;
 +	}
  	cmd->conn = conn;
  	INIT_LIST_HEAD(&cmd->i_conn_node);
  	INIT_LIST_HEAD(&cmd->datain_list);
* Unmerged path lib/percpu_ida.c
* Unmerged path drivers/target/iscsi/iscsi_target_util.c
* Unmerged path lib/percpu_ida.c
