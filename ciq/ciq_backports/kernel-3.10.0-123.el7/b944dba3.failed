NFSv4: Sanity check the server reply in _nfs4_server_capabilities

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-123.el7
Rebuild_CHGLOG: - [fs] nfs: Sanity check the server reply in _nfs4_server_capabilities (Jeff Layton) [1030725]
Rebuild_FUZZ: 98.44%
commit-author Trond Myklebust <Trond.Myklebust@netapp.com>
commit b944dba31d2c23f1cf5d69a66cc3449e0ba78503
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-123.el7/b944dba3.failed

We don't want to be setting capabilities and/or requesting attributes
that are not appropriate for the NFSv4 minor version.

- Ensure that we clear the NFS_CAP_SECURITY_LABEL capability when appropriate
- Ensure that we limit the attribute bitmasks to the mounted_on_fileid
  attribute and less for NFSv4.0
- Ensure that we limit the attribute bitmasks to suppattr_exclcreat and
  less for NFSv4.1
- Ensure that we limit it to change_sec_label or less for NFSv4.2

	Signed-off-by: Trond Myklebust <Trond.Myklebust@netapp.com>
(cherry picked from commit b944dba31d2c23f1cf5d69a66cc3449e0ba78503)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/nfs/nfs4proc.c
diff --cc fs/nfs/nfs4proc.c
index 243e7b5c4025,ed2a0e6b9aed..000000000000
--- a/fs/nfs/nfs4proc.c
+++ b/fs/nfs/nfs4proc.c
@@@ -2541,6 -2766,13 +2558,16 @@@ static int _nfs4_server_capabilities(st
  			server->caps |= NFS_CAP_CTIME;
  		if (res.attr_bitmask[1] & FATTR4_WORD1_TIME_MODIFY)
  			server->caps |= NFS_CAP_MTIME;
++<<<<<<< HEAD
++=======
+ #ifdef CONFIG_NFS_V4_SECURITY_LABEL
+ 		if (res.attr_bitmask[2] & FATTR4_WORD2_SECURITY_LABEL)
+ 			server->caps |= NFS_CAP_SECURITY_LABEL;
+ #endif
+ 		memcpy(server->attr_bitmask_nl, res.attr_bitmask,
+ 				sizeof(server->attr_bitmask));
+ 		server->attr_bitmask_nl[2] &= ~FATTR4_WORD2_SECURITY_LABEL;
++>>>>>>> b944dba31d2c (NFSv4: Sanity check the server reply in _nfs4_server_capabilities)
  
  		memcpy(server->cache_consistency_bitmask, res.attr_bitmask, sizeof(server->cache_consistency_bitmask));
  		server->cache_consistency_bitmask[0] &= FATTR4_WORD0_CHANGE|FATTR4_WORD0_SIZE;
* Unmerged path fs/nfs/nfs4proc.c
diff --git a/include/linux/nfs4.h b/include/linux/nfs4.h
index 3859ddbecb5f..b561973b191b 100644
--- a/include/linux/nfs4.h
+++ b/include/linux/nfs4.h
@@ -396,6 +396,8 @@ enum lock_type4 {
 #define FATTR4_WORD2_LAYOUT_BLKSIZE     (1UL << 1)
 #define FATTR4_WORD2_MDSTHRESHOLD       (1UL << 4)
 #define FATTR4_WORD2_SECURITY_LABEL     (1UL << 16)
+#define FATTR4_WORD2_CHANGE_SECURITY_LABEL \
+					(1UL << 17)
 
 /* MDS threshold bitmap bits */
 #define THRESHOLD_RD                    (1UL << 0)
