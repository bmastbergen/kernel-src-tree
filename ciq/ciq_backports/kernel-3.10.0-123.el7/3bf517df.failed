qlcnic: Fix diagnostic test for all adapters.

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-123.el7
Rebuild_CHGLOG: - [ethernet] qlcnic: Fix diagnostic test for all adapters (Chad Dupuis) [1063848]
Rebuild_FUZZ: 98.88%
commit-author Himanshu Madhani <himanshu.madhani@qlogic.com>
commit 3bf517df0d99f1cf5d369c73ab68e0afe6a3c2f9
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-123.el7/3bf517df.failed

o Driver should re-allocate all Tx queues after completing
  diagnostic tests. This regression was added by commit id
  c2c5e3a0681bb1945c0cb211a5f4baa22cb2cbb3 ("qlcnic: Enable
  diagnostic test for multiple Tx queues.")

	Signed-off-by: Himanshu Madhani <himanshu.madhani@qlogic.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 3bf517df0d99f1cf5d369c73ab68e0afe6a3c2f9)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/qlogic/qlcnic/qlcnic_ethtool.c
#	drivers/net/ethernet/qlogic/qlcnic/qlcnic_main.c
diff --cc drivers/net/ethernet/qlogic/qlcnic/qlcnic_ethtool.c
index 7b0c90efb365,6d3edf6b6a96..000000000000
--- a/drivers/net/ethernet/qlogic/qlcnic/qlcnic_ethtool.c
+++ b/drivers/net/ethernet/qlogic/qlcnic/qlcnic_ethtool.c
@@@ -876,7 -947,8 +876,12 @@@ static int qlcnic_irq_test(struct net_d
  	struct qlcnic_adapter *adapter = netdev_priv(netdev);
  	struct qlcnic_hardware_context *ahw = adapter->ahw;
  	struct qlcnic_cmd_args cmd;
++<<<<<<< HEAD
 +	int ret, max_sds_rings = adapter->max_sds_rings;
++=======
+ 	int ret, drv_sds_rings = adapter->drv_sds_rings;
+ 	int drv_tx_rings = adapter->drv_tx_rings;
++>>>>>>> 3bf517df0d99 (qlcnic: Fix diagnostic test for all adapters.)
  
  	if (qlcnic_83xx_check(adapter))
  		return qlcnic_83xx_interrupt_test(netdev);
@@@ -905,10 -977,11 +910,15 @@@ done
  	qlcnic_free_mbx_args(&cmd);
  
  free_diag_res:
 -	qlcnic_diag_free_res(netdev, drv_sds_rings);
 +	qlcnic_diag_free_res(netdev, max_sds_rings);
  
  clear_diag_irq:
++<<<<<<< HEAD
 +	adapter->max_sds_rings = max_sds_rings;
++=======
+ 	adapter->drv_sds_rings = drv_sds_rings;
+ 	adapter->drv_tx_rings = drv_tx_rings;
++>>>>>>> 3bf517df0d99 (qlcnic: Fix diagnostic test for all adapters.)
  	clear_bit(__QLCNIC_RESETTING, &adapter->state);
  
  	return ret;
diff --cc drivers/net/ethernet/qlogic/qlcnic/qlcnic_main.c
index 6b465cae50af,aa019c398e9b..000000000000
--- a/drivers/net/ethernet/qlogic/qlcnic/qlcnic_main.c
+++ b/drivers/net/ethernet/qlogic/qlcnic/qlcnic_main.c
@@@ -1855,10 -1939,9 +1855,14 @@@ int qlcnic_diag_alloc_res(struct net_de
  
  	qlcnic_detach(adapter);
  
++<<<<<<< HEAD
 +	adapter->max_sds_rings = 1;
++=======
+ 	adapter->drv_sds_rings = QLCNIC_SINGLE_RING;
++>>>>>>> 3bf517df0d99 (qlcnic: Fix diagnostic test for all adapters.)
  	adapter->ahw->diag_test = test;
  	adapter->ahw->linkup = 0;
 +	adapter->max_drv_tx_rings = 1;
  
  	ret = qlcnic_attach(adapter);
  	if (ret) {
* Unmerged path drivers/net/ethernet/qlogic/qlcnic/qlcnic_ethtool.c
* Unmerged path drivers/net/ethernet/qlogic/qlcnic/qlcnic_main.c
