s390/pci: fix removal of nonexistent pci bus

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-123.el7
Rebuild_CHGLOG: - [s390] pci: fix removal of nonexistent pci bus (Hendrik Brueckner) [1059247]
Rebuild_FUZZ: 93.98%
commit-author Sebastian Ott <sebott@linux.vnet.ibm.com>
commit 704268925d32a0457202371a61580af76b94c53a
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-123.el7/70426892.failed

If we remove a pci bus after receiving a hotplug notification we need
to check if the bus is actually present (creation of the pci bus
during an earlier notification may have been failed).

	Reviewed-by: Gerald Schaefer <gerald.schaefer@de.ibm.com>
	Signed-off-by: Sebastian Ott <sebott@linux.vnet.ibm.com>
	Signed-off-by: Martin Schwidefsky <schwidefsky@de.ibm.com>
(cherry picked from commit 704268925d32a0457202371a61580af76b94c53a)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/s390/pci/pci_event.c
diff --cc arch/s390/pci/pci_event.c
index bbbed1e7538f,65ea105f68a1..000000000000
--- a/arch/s390/pci/pci_event.c
+++ b/arch/s390/pci/pci_event.c
@@@ -82,7 -57,73 +82,75 @@@ void zpci_event_error(void *data
  	       pci_name(zdev->pdev), ccdf->pec, ccdf->fid);
  }
  
++<<<<<<< HEAD
++=======
+ void zpci_event_error(void *data)
+ {
+ 	if (zpci_is_enabled())
+ 		__zpci_event_error(data);
+ }
+ 
+ static void __zpci_event_availability(struct zpci_ccdf_avail *ccdf)
+ {
+ 	struct zpci_dev *zdev = get_zdev_by_fid(ccdf->fid);
+ 	struct pci_dev *pdev = zdev ? zdev->pdev : NULL;
+ 	int ret;
+ 
+ 	pr_info("%s: Event 0x%x reconfigured PCI function 0x%x\n",
+ 		pdev ? pci_name(pdev) : "n/a", ccdf->pec, ccdf->fid);
+ 	zpci_err("avail CCDF:\n");
+ 	zpci_err_hex(ccdf, sizeof(*ccdf));
+ 
+ 	switch (ccdf->pec) {
+ 	case 0x0301: /* Standby -> Configured */
+ 		if (!zdev || zdev->state == ZPCI_FN_STATE_CONFIGURED)
+ 			break;
+ 		zdev->state = ZPCI_FN_STATE_CONFIGURED;
+ 		ret = zpci_enable_device(zdev);
+ 		if (ret)
+ 			break;
+ 		pci_rescan_bus(zdev->bus);
+ 		break;
+ 	case 0x0302: /* Reserved -> Standby */
+ 		clp_add_pci_device(ccdf->fid, ccdf->fh, 0);
+ 		break;
+ 	case 0x0303: /* Deconfiguration requested */
+ 		if (pdev)
+ 			pci_stop_and_remove_bus_device(pdev);
+ 
+ 		ret = zpci_disable_device(zdev);
+ 		if (ret)
+ 			break;
+ 
+ 		ret = sclp_pci_deconfigure(zdev->fid);
+ 		zpci_dbg(3, "deconf fid:%x, rc:%d\n", zdev->fid, ret);
+ 		if (!ret)
+ 			zdev->state = ZPCI_FN_STATE_STANDBY;
+ 
+ 		break;
+ 	case 0x0304: /* Configured -> Standby */
+ 		if (pdev)
+ 			pci_stop_and_remove_bus_device(pdev);
+ 
+ 		zpci_disable_device(zdev);
+ 		zdev->state = ZPCI_FN_STATE_STANDBY;
+ 		break;
+ 	case 0x0306: /* 0x308 or 0x302 for multiple devices */
+ 		clp_rescan_pci_devices();
+ 		break;
+ 	case 0x0308: /* Standby -> Reserved */
+ 		if (!zdev)
+ 			break;
+ 		pci_stop_root_bus(zdev->bus);
+ 		pci_remove_root_bus(zdev->bus);
+ 		break;
+ 	default:
+ 		break;
+ 	}
+ }
+ 
++>>>>>>> 704268925d32 (s390/pci: fix removal of nonexistent pci bus)
  void zpci_event_availability(void *data)
  {
 -	if (zpci_is_enabled())
 -		__zpci_event_availability(data);
 +	zpci_event_log_avail(data);
  }
* Unmerged path arch/s390/pci/pci_event.c
