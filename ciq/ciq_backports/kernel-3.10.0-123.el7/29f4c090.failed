target: Fix delayed Task Aborted Status (TAS) handling bug

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-123.el7
Rebuild_CHGLOG: - [target] Fix delayed Task Aborted Status (TAS) handling bug (Andy Grover) [1051179]
Rebuild_FUZZ: 92.59%
commit-author Nicholas Bellinger <nab@linux-iscsi.org>
commit 29f4c090079f442ea2723d292e4e64f0b6ac1f27
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-123.el7/29f4c090.failed

This patch fixes a bug in delayed Task Aborted Status (TAS) handling,
where transport_send_task_abort() was not returning for the case
when the se_tfo->write_pending() callback indicated that last fabric
specific WRITE PDU had not yet been received.

It also adds an explicit cmd->scsi_status = SAM_STAT_TASK_ABORTED
assignment within transport_check_aborted_status() to avoid the case
where se_tfo->queue_status() is called when the SAM_STAT_TASK_ABORTED
assignment + ->queue_status() in transport_send_task_abort() does not
occur once SCF_SENT_DELAYED_TAS has been set.

	Cc: <stable@vger.kernel.org> #3.2+
	Signed-off-by: Nicholas Bellinger <nab@linux-iscsi.org>
(cherry picked from commit 29f4c090079f442ea2723d292e4e64f0b6ac1f27)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/target/target_core_transport.c
diff --cc drivers/target/target_core_transport.c
index 21e315874a54,46d82295fac9..000000000000
--- a/drivers/target/target_core_transport.c
+++ b/drivers/target/target_core_transport.c
@@@ -2794,6 -2682,8 +2794,11 @@@ int transport_check_aborted_status(stru
  		 cmd->t_task_cdb[0], cmd->se_tfo->get_task_tag(cmd));
  
  	cmd->se_cmd_flags |= SCF_SENT_DELAYED_TAS;
++<<<<<<< HEAD
++=======
+ 	cmd->scsi_status = SAM_STAT_TASK_ABORTED;
+ 	trace_target_cmd_complete(cmd);
++>>>>>>> 29f4c090079f (target: Fix delayed Task Aborted Status (TAS) handling bug)
  	cmd->se_tfo->queue_status(cmd);
  
  	return 1;
* Unmerged path drivers/target/target_core_transport.c
