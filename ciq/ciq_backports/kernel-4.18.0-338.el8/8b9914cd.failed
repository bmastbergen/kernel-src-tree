Crypto/chcr: Checking cra_refcnt before unregistering the algorithms

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-338.el8
commit-author Ayush Sawal <ayush.sawal@chelsio.com>
commit 8b9914cd723bfce8dbff65bd135563f887dcb19d
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-338.el8/8b9914cd.failed

This patch puts a check for algorithm unregister, to avoid removal of
driver if the algorithm is under use.

	Signed-off-by: Ayush Sawal <ayush.sawal@chelsio.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 8b9914cd723bfce8dbff65bd135563f887dcb19d)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/crypto/chelsio/chcr_algo.c
diff --cc drivers/crypto/chelsio/chcr_algo.c
index d62afc4ebccc,4c2553672b6f..000000000000
--- a/drivers/crypto/chelsio/chcr_algo.c
+++ b/drivers/crypto/chelsio/chcr_algo.c
@@@ -4383,23 -4390,33 +4383,40 @@@ static int chcr_unregister_alg(void
  
  	for (i = 0; i < ARRAY_SIZE(driver_algs); i++) {
  		switch (driver_algs[i].type & CRYPTO_ALG_TYPE_MASK) {
++<<<<<<< HEAD
 +		case CRYPTO_ALG_TYPE_ABLKCIPHER:
 +			if (driver_algs[i].is_registered)
 +				crypto_unregister_alg(
 +						&driver_algs[i].alg.crypto);
++=======
+ 		case CRYPTO_ALG_TYPE_SKCIPHER:
+ 			if (driver_algs[i].is_registered && refcount_read(
+ 			    &driver_algs[i].alg.skcipher.base.cra_refcnt)
+ 			    == 1) {
+ 				crypto_unregister_skcipher(
+ 						&driver_algs[i].alg.skcipher);
+ 				driver_algs[i].is_registered = 0;
+ 			}
++>>>>>>> 8b9914cd723b (Crypto/chcr: Checking cra_refcnt before unregistering the algorithms)
  			break;
  		case CRYPTO_ALG_TYPE_AEAD:
- 			if (driver_algs[i].is_registered)
+ 			if (driver_algs[i].is_registered && refcount_read(
+ 			    &driver_algs[i].alg.aead.base.cra_refcnt) == 1) {
  				crypto_unregister_aead(
  						&driver_algs[i].alg.aead);
+ 				driver_algs[i].is_registered = 0;
+ 			}
  			break;
  		case CRYPTO_ALG_TYPE_AHASH:
- 			if (driver_algs[i].is_registered)
+ 			if (driver_algs[i].is_registered && refcount_read(
+ 			    &driver_algs[i].alg.hash.halg.base.cra_refcnt)
+ 			    == 1) {
  				crypto_unregister_ahash(
  						&driver_algs[i].alg.hash);
+ 				driver_algs[i].is_registered = 0;
+ 			}
  			break;
  		}
- 		driver_algs[i].is_registered = 0;
  	}
  	return 0;
  }
* Unmerged path drivers/crypto/chelsio/chcr_algo.c
