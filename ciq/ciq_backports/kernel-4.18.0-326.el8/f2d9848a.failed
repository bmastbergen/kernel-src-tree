iommu/arm-smmu: Workaround for Marvell Armada-AP806 SoC erratum #582743

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-326.el8
commit-author Hanna Hawa <hannah@marvell.com>
commit f2d9848aeb9fa71523bbfb226203ffb7d50877d2
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-326.el8/f2d9848a.failed

Due to erratum #582743, the Marvell Armada-AP806 can't access 64bit to
ARM SMMUv2 registers.

Provide implementation relevant hooks:
- split the writeq/readq to two accesses of writel/readl.
- mask the MMU_IDR2.PTFSv8 fields to not use AArch64 format (but
only AARCH32_L) since with AArch64 format 32 bits access is not supported.

Note that most 64-bit registers like TTBRn can be accessed as two 32-bit
halves without issue, and AArch32 format ensures that the register writes
which must be atomic (for TLBI etc.) need only be 32-bit.

	Signed-off-by: Hanna Hawa <hannah@marvell.com>
	Signed-off-by: Gregory CLEMENT <gregory.clement@bootlin.com>
	Signed-off-by: Tomasz Nowicki <tn@semihalf.com>
	Reviewed-by: Robin Murphy <robin.murphy@arm.com>
Link: https://lore.kernel.org/r/20200715070649.18733-3-tn@semihalf.com
	Signed-off-by: Will Deacon <will@kernel.org>
(cherry picked from commit f2d9848aeb9fa71523bbfb226203ffb7d50877d2)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	Documentation/arm64/silicon-errata.txt
#	drivers/iommu/arm-smmu-impl.c
diff --cc Documentation/arm64/silicon-errata.txt
index 3f23ddd715ce,157214d3abe1..000000000000
--- a/Documentation/arm64/silicon-errata.txt
+++ b/Documentation/arm64/silicon-errata.txt
@@@ -42,55 -46,110 +42,63 @@@ file acts as a registry of software wor
  will be updated when new workarounds are committed and backported to
  stable kernels.
  
 -+----------------+-----------------+-----------------+-----------------------------+
  | Implementor    | Component       | Erratum ID      | Kconfig                     |
 -+================+=================+=================+=============================+
 -| Allwinner      | A64/R18         | UNKNOWN1        | SUN50I_ERRATUM_UNKNOWN1     |
 -+----------------+-----------------+-----------------+-----------------------------+
  +----------------+-----------------+-----------------+-----------------------------+
  | ARM            | Cortex-A53      | #826319         | ARM64_ERRATUM_826319        |
 -+----------------+-----------------+-----------------+-----------------------------+
  | ARM            | Cortex-A53      | #827319         | ARM64_ERRATUM_827319        |
 -+----------------+-----------------+-----------------+-----------------------------+
  | ARM            | Cortex-A53      | #824069         | ARM64_ERRATUM_824069        |
 -+----------------+-----------------+-----------------+-----------------------------+
  | ARM            | Cortex-A53      | #819472         | ARM64_ERRATUM_819472        |
 -+----------------+-----------------+-----------------+-----------------------------+
  | ARM            | Cortex-A53      | #845719         | ARM64_ERRATUM_845719        |
 -+----------------+-----------------+-----------------+-----------------------------+
  | ARM            | Cortex-A53      | #843419         | ARM64_ERRATUM_843419        |
 -+----------------+-----------------+-----------------+-----------------------------+
 -| ARM            | Cortex-A55      | #1024718        | ARM64_ERRATUM_1024718       |
 -+----------------+-----------------+-----------------+-----------------------------+
 -| ARM            | Cortex-A55      | #1530923        | ARM64_ERRATUM_1530923       |
 -+----------------+-----------------+-----------------+-----------------------------+
  | ARM            | Cortex-A57      | #832075         | ARM64_ERRATUM_832075        |
 -+----------------+-----------------+-----------------+-----------------------------+
  | ARM            | Cortex-A57      | #852523         | N/A                         |
 -+----------------+-----------------+-----------------+-----------------------------+
  | ARM            | Cortex-A57      | #834220         | ARM64_ERRATUM_834220        |
 -+----------------+-----------------+-----------------+-----------------------------+
  | ARM            | Cortex-A57      | #1319537        | ARM64_ERRATUM_1319367       |
 -+----------------+-----------------+-----------------+-----------------------------+
  | ARM            | Cortex-A72      | #853709         | N/A                         |
 -+----------------+-----------------+-----------------+-----------------------------+
  | ARM            | Cortex-A72      | #1319367        | ARM64_ERRATUM_1319367       |
 -+----------------+-----------------+-----------------+-----------------------------+
  | ARM            | Cortex-A73      | #858921         | ARM64_ERRATUM_858921        |
 -+----------------+-----------------+-----------------+-----------------------------+
 +| ARM            | Cortex-A55      | #1024718        | ARM64_ERRATUM_1024718       |
  | ARM            | Cortex-A76      | #1188873,1418040| ARM64_ERRATUM_1418040       |
 -+----------------+-----------------+-----------------+-----------------------------+
  | ARM            | Cortex-A76      | #1165522        | ARM64_ERRATUM_1165522       |
 -+----------------+-----------------+-----------------+-----------------------------+
  | ARM            | Cortex-A76      | #1286807        | ARM64_ERRATUM_1286807       |
 -+----------------+-----------------+-----------------+-----------------------------+
  | ARM            | Cortex-A76      | #1463225        | ARM64_ERRATUM_1463225       |
 -+----------------+-----------------+-----------------+-----------------------------+
 +| ARM            | Cortex-A55      | #1530923        | ARM64_ERRATUM_1530923       |
 +| ARM            | Neoverse-N1     | #1349291        | N/A                         |
  | ARM            | Neoverse-N1     | #1188873,1418040| ARM64_ERRATUM_1418040       |
 -+----------------+-----------------+-----------------+-----------------------------+
  | ARM            | Neoverse-N1     | #1349291        | N/A                         |
 -+----------------+-----------------+-----------------+-----------------------------+
  | ARM            | Neoverse-N1     | #1542419        | ARM64_ERRATUM_1542419       |
 -+----------------+-----------------+-----------------+-----------------------------+
  | ARM            | MMU-500         | #841119,826419  | N/A                         |
 -+----------------+-----------------+-----------------+-----------------------------+
 -+----------------+-----------------+-----------------+-----------------------------+
 -| Broadcom       | Brahma-B53      | N/A             | ARM64_ERRATUM_845719        |
 -+----------------+-----------------+-----------------+-----------------------------+
 -| Broadcom       | Brahma-B53      | N/A             | ARM64_ERRATUM_843419        |
 -+----------------+-----------------+-----------------+-----------------------------+
 -+----------------+-----------------+-----------------+-----------------------------+
 +|                |                 |                 |                             |
  | Cavium         | ThunderX ITS    | #22375,24313    | CAVIUM_ERRATUM_22375        |
 -+----------------+-----------------+-----------------+-----------------------------+
  | Cavium         | ThunderX ITS    | #23144          | CAVIUM_ERRATUM_23144        |
 -+----------------+-----------------+-----------------+-----------------------------+
  | Cavium         | ThunderX GICv3  | #23154          | CAVIUM_ERRATUM_23154        |
 -+----------------+-----------------+-----------------+-----------------------------+
  | Cavium         | ThunderX GICv3  | #38539          | N/A                         |
 -+----------------+-----------------+-----------------+-----------------------------+
  | Cavium         | ThunderX Core   | #27456          | CAVIUM_ERRATUM_27456        |
 -+----------------+-----------------+-----------------+-----------------------------+
  | Cavium         | ThunderX Core   | #30115          | CAVIUM_ERRATUM_30115        |
 -+----------------+-----------------+-----------------+-----------------------------+
  | Cavium         | ThunderX SMMUv2 | #27704          | N/A                         |
 -+----------------+-----------------+-----------------+-----------------------------+
  | Cavium         | ThunderX2 SMMUv3| #74             | N/A                         |
 -+----------------+-----------------+-----------------+-----------------------------+
  | Cavium         | ThunderX2 SMMUv3| #126            | N/A                         |
 -+----------------+-----------------+-----------------+-----------------------------+
  | Cavium         | ThunderX2 Core  | #219            | CAVIUM_TX2_ERRATUM_219      |
++<<<<<<< HEAD:Documentation/arm64/silicon-errata.txt
 +|                |                 |                 |                             |
 +| NVIDIA         | Carmel Core     | N/A             | NVIDIA_CARMEL_CNP_ERRATUM   |
 +|                |                 |                 |                             |
++=======
+ +----------------+-----------------+-----------------+-----------------------------+
+ +----------------+-----------------+-----------------+-----------------------------+
+ | Marvell        | ARM-MMU-500     | #582743         | N/A                         |
+ +----------------+-----------------+-----------------+-----------------------------+
+ +----------------+-----------------+-----------------+-----------------------------+
++>>>>>>> f2d9848aeb9f (iommu/arm-smmu: Workaround for Marvell Armada-AP806 SoC erratum #582743):Documentation/arm64/silicon-errata.rst
  | Freescale/NXP  | LS2080A/LS1043A | A-008585        | FSL_ERRATUM_A008585         |
 -+----------------+-----------------+-----------------+-----------------------------+
 -+----------------+-----------------+-----------------+-----------------------------+
 +|                |                 |                 |                             |
  | Hisilicon      | Hip0{5,6,7}     | #161010101      | HISILICON_ERRATUM_161010101 |
 -+----------------+-----------------+-----------------+-----------------------------+
  | Hisilicon      | Hip0{6,7}       | #161010701      | N/A                         |
 -+----------------+-----------------+-----------------+-----------------------------+
  | Hisilicon      | Hip0{6,7}       | #161010803      | N/A                         |
 -+----------------+-----------------+-----------------+-----------------------------+
  | Hisilicon      | Hip07           | #161600802      | HISILICON_ERRATUM_161600802 |
 -+----------------+-----------------+-----------------+-----------------------------+
 -| Hisilicon      | Hip08 SMMU PMCG | #162001800      | N/A                         |
 -+----------------+-----------------+-----------------+-----------------------------+
 -+----------------+-----------------+-----------------+-----------------------------+
 +|                |                 |                 |                             |
  | Qualcomm Tech. | Kryo/Falkor v1  | E1003           | QCOM_FALKOR_ERRATUM_1003    |
 -+----------------+-----------------+-----------------+-----------------------------+
 -| Qualcomm Tech. | Kryo/Falkor v1  | E1009           | QCOM_FALKOR_ERRATUM_1009    |
 -+----------------+-----------------+-----------------+-----------------------------+
 +| Qualcomm Tech. | Falkor v1       | E1009           | QCOM_FALKOR_ERRATUM_1009    |
  | Qualcomm Tech. | QDF2400 ITS     | E0065           | QCOM_QDF2400_ERRATUM_0065   |
 -+----------------+-----------------+-----------------+-----------------------------+
  | Qualcomm Tech. | Falkor v{1,2}   | E1041           | QCOM_FALKOR_ERRATUM_1041    |
 -+----------------+-----------------+-----------------+-----------------------------+
 -+----------------+-----------------+-----------------+-----------------------------+
  | Fujitsu        | A64FX           | E#010001        | FUJITSU_ERRATUM_010001      |
 -+----------------+-----------------+-----------------+-----------------------------+
diff --cc drivers/iommu/arm-smmu-impl.c
index 3a1a5d8188d6,c87d825f651e..000000000000
--- a/drivers/iommu/arm-smmu-impl.c
+++ b/drivers/iommu/arm-smmu-impl.c
@@@ -166,9 -209,18 +208,21 @@@ struct arm_smmu_device *arm_smmu_impl_i
  		break;
  	}
  
 -	/* This is implicitly MMU-400 */
 -	if (of_property_read_bool(np, "calxeda,smmu-secure-config-access"))
 +	if (of_property_read_bool(smmu->dev->of_node,
 +				  "calxeda,smmu-secure-config-access"))
  		smmu->impl = &calxeda_impl;
  
++<<<<<<< HEAD
++=======
+ 	if (of_device_is_compatible(np, "qcom,sdm845-smmu-500") ||
+ 	    of_device_is_compatible(np, "qcom,sc7180-smmu-500") ||
+ 	    of_device_is_compatible(np, "qcom,sm8150-smmu-500") ||
+ 	    of_device_is_compatible(np, "qcom,sm8250-smmu-500"))
+ 		return qcom_smmu_impl_init(smmu);
+ 
+ 	if (of_device_is_compatible(np, "marvell,ap806-smmu-500"))
+ 		smmu->impl = &mrvl_mmu500_impl;
+ 
++>>>>>>> f2d9848aeb9f (iommu/arm-smmu: Workaround for Marvell Armada-AP806 SoC erratum #582743)
  	return smmu;
  }
* Unmerged path Documentation/arm64/silicon-errata.txt
* Unmerged path drivers/iommu/arm-smmu-impl.c
