scsi: sbitmap: Silence a debug kernel warning triggered by sbitmap_put()

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-326.el8
commit-author Bart Van Assche <bvanassche@acm.org>
commit 035e9f471691a16c32b389c8b2f236043a2a50d7
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-326.el8/035e9f47.failed

All sbitmap code uses implied preemption protection to update
sb->alloc_hint except sbitmap_put(). Using implied preemption protection is
safe since the value of sb->alloc_hint only affects performance of sbitmap
allocations but not their correctness. Change this_cpu_ptr() in
sbitmap_put() into raw_cpu_ptr() to suppress the following kernel warning
that appears with preemption debugging enabled (CONFIG_DEBUG_PREEMPT):

BUG: using smp_processor_id() in preemptible [00000000] code: scsi_eh_0/152
caller is debug_smp_processor_id+0x17/0x20
CPU: 1 PID: 152 Comm: scsi_eh_0 Tainted: G        W         5.12.0-rc1-dbg+ #6
Call Trace:
 show_stack+0x52/0x58
 dump_stack+0xaf/0xf3
 check_preemption_disabled+0xce/0xd0
 debug_smp_processor_id+0x17/0x20
 scsi_device_unbusy+0x13a/0x1c0 [scsi_mod]
 scsi_finish_command+0x4d/0x290 [scsi_mod]
 scsi_eh_flush_done_q+0x1e7/0x280 [scsi_mod]
 ata_scsi_port_error_handler+0x592/0x750 [libata]
 ata_scsi_error+0x1a0/0x1f0 [libata]
 scsi_error_handler+0x19e/0x330 [scsi_mod]
 kthread+0x222/0x250
 ret_from_fork+0x1f/0x30

Link: https://lore.kernel.org/r/20210317032648.9080-1-bvanassche@acm.org
Fixes: c548e62bcf6a ("scsi: sbitmap: Move allocation hint into sbitmap")
	Cc: Hannes Reinecke <hare@suse.de>
	Cc: Omar Sandoval <osandov@fb.com>
	Reviewed-by: Ming Lei <ming.lei@redhat.com>
	Reviewed-by: Christoph Hellwig <hch@lst.de>
	Signed-off-by: Bart Van Assche <bvanassche@acm.org>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit 035e9f471691a16c32b389c8b2f236043a2a50d7)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	include/linux/sbitmap.h
diff --cc include/linux/sbitmap.h
index 0e5825afa8c1,2713e689ad66..000000000000
--- a/include/linux/sbitmap.h
+++ b/include/linux/sbitmap.h
@@@ -331,6 -315,18 +331,21 @@@ static inline void sbitmap_deferred_cle
  	set_bit(SB_NR_TO_BIT(sb, bitnr), addr);
  }
  
++<<<<<<< HEAD
++=======
+ /*
+  * Pair of sbitmap_get, and this one applies both cleared bit and
+  * allocation hint.
+  */
+ static inline void sbitmap_put(struct sbitmap *sb, unsigned int bitnr)
+ {
+ 	sbitmap_deferred_clear_bit(sb, bitnr);
+ 
+ 	if (likely(sb->alloc_hint && !sb->round_robin && bitnr < sb->depth))
+ 		*raw_cpu_ptr(sb->alloc_hint) = bitnr;
+ }
+ 
++>>>>>>> 035e9f471691 (scsi: sbitmap: Silence a debug kernel warning triggered by sbitmap_put())
  static inline int sbitmap_test_bit(struct sbitmap *sb, unsigned int bitnr)
  {
  	return test_bit(SB_NR_TO_BIT(sb, bitnr), __sbitmap_word(sb, bitnr));
* Unmerged path include/linux/sbitmap.h
