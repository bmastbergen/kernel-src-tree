iommu/amd: Enforce 4k mapping for certain IOMMU data structures

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-326.el8
commit-author Suravee Suthikulpanit <suravee.suthikulpanit@amd.com>
commit 6d39bdee238f9799718653a9d4d61ebf2922e23d
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-326.el8/6d39bdee.failed

AMD IOMMU requires 4k-aligned pages for the event log, the PPR log,
and the completion wait write-back regions. However, when allocating
the pages, they could be part of large mapping (e.g. 2M) page.
This causes #PF due to the SNP RMP hardware enforces the check based
on the page level for these data structures.

So, fix by calling set_memory_4k() on the allocated pages.

Fixes: c69d89aff393 ("iommu/amd: Use 4K page for completion wait write-back semaphore")
	Signed-off-by: Suravee Suthikulpanit <suravee.suthikulpanit@amd.com>
	Cc: Brijesh Singh <brijesh.singh@amd.com>
Link: https://lore.kernel.org/r/20201105145832.3065-1-suravee.suthikulpanit@amd.com
	Signed-off-by: Will Deacon <will@kernel.org>
(cherry picked from commit 6d39bdee238f9799718653a9d4d61ebf2922e23d)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/iommu/amd/init.c
diff --cc drivers/iommu/amd/init.c
index 7c0be7baff0f,23a790f8f550..000000000000
--- a/drivers/iommu/amd/init.c
+++ b/drivers/iommu/amd/init.c
@@@ -851,6 -853,19 +868,22 @@@ static int iommu_init_ga(struct amd_iom
  	return ret;
  }
  
++<<<<<<< HEAD
++=======
+ static int __init alloc_cwwb_sem(struct amd_iommu *iommu)
+ {
+ 	iommu->cmd_sem = iommu_alloc_4k_pages(iommu, GFP_KERNEL | __GFP_ZERO, 1);
+ 
+ 	return iommu->cmd_sem ? 0 : -ENOMEM;
+ }
+ 
+ static void __init free_cwwb_sem(struct amd_iommu *iommu)
+ {
+ 	if (iommu->cmd_sem)
+ 		free_page((unsigned long)iommu->cmd_sem);
+ }
+ 
++>>>>>>> 6d39bdee238f (iommu/amd: Enforce 4k mapping for certain IOMMU data structures)
  static void iommu_enable_xt(struct amd_iommu *iommu)
  {
  #ifdef CONFIG_IRQ_REMAP
* Unmerged path drivers/iommu/amd/init.c
