selftests/bpf: fix bpf_testmod.ko recompilation logic

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-326.el8
commit-author Andrii Nakryiko <andrii@kernel.org>
commit a67079b03165a17f9aceab3dd26b1638af68e0fc
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-326.el8/a67079b0.failed

bpf_testmod.ko build rule declared dependency on VMLINUX_BTF, but the variable
itself was initialized after the rule was declared, which often caused
bpf_testmod.ko to not be re-compiled. Fix by moving VMLINUX_BTF determination
sooner.

Also enforce bpf_testmod.ko recompilation when we detect that vmlinux image
changed by removing bpf_testmod/bpf_testmod.ko. This is necessary to generate
correct module's split BTF. Without it, Kbuild's module build logic might
determine that nothing changed on the kernel side and thus bpf_testmod.ko
shouldn't be rebuilt, so won't re-generate module BTF, which often leads to
module's BTF with wrong string offsets against vmlinux BTF. Removing .ko file
forces Kbuild to re-build the module.

	Reported-by: Alexei Starovoitov <ast@kernel.org>
Fixes: 9f7fa225894c ("selftests/bpf: Add bpf_testmod kernel module for testing")
	Signed-off-by: Andrii Nakryiko <andrii@kernel.org>
Link: https://lore.kernel.org/r/20201211015946.4062098-1-andrii@kernel.org
	Signed-off-by: Alexei Starovoitov <ast@kernel.org>
(cherry picked from commit a67079b03165a17f9aceab3dd26b1638af68e0fc)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/testing/selftests/bpf/Makefile
diff --cc tools/testing/selftests/bpf/Makefile
index 949d3b2cc8b1,8b515a17f44b..000000000000
--- a/tools/testing/selftests/bpf/Makefile
+++ b/tools/testing/selftests/bpf/Makefile
@@@ -136,6 -145,12 +143,15 @@@ $(OUTPUT)/urandom_read: urandom_read.
  	$(call msg,BINARY,,$@)
  	$(Q)$(CC) $(LDFLAGS) -o $@ $< $(LDLIBS) -Wl,--build-id=sha1
  
++<<<<<<< HEAD
++=======
+ $(OUTPUT)/bpf_testmod.ko: $(VMLINUX_BTF) $(wildcard bpf_testmod/Makefile bpf_testmod/*.[ch])
+ 	$(call msg,MOD,,$@)
+ 	$(Q)$(RM) bpf_testmod/bpf_testmod.ko # force re-compilation
+ 	$(Q)$(MAKE) $(submake_extras) -C bpf_testmod
+ 	$(Q)cp bpf_testmod/bpf_testmod.ko $@
+ 
++>>>>>>> a67079b03165 (selftests/bpf: fix bpf_testmod.ko recompilation logic)
  $(OUTPUT)/test_stub.o: test_stub.c $(BPFOBJ)
  	$(call msg,CC,,$@)
  	$(Q)$(CC) -c $(CFLAGS) -o $@ $<
* Unmerged path tools/testing/selftests/bpf/Makefile
