r8152: divide the tx and rx bottom functions

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-326.el8
commit-author Hayes Wang <hayeswang@realtek.com>
commit d2187f8e445403b7aeb08e64c1528761154e9ab3
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-326.el8/d2187f8e.failed

Move the tx bottom function from NAPI to a new tasklet. Then, for
multi-cores, the bottom functions of tx and rx may be run at same
time with different cores. This is used to improve performance.

On x86, Tx/Rx 943/943 Mbits/sec -> 945/944.
For arm platform, Tx/Rx: 917/917 Mbits/sec -> 933/933.

	Signed-off-by: Hayes Wang <hayeswang@realtek.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit d2187f8e445403b7aeb08e64c1528761154e9ab3)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/usb/r8152.c
diff --cc drivers/net/usb/r8152.c
index 94b114beadb7,1aa61610f0bb..000000000000
--- a/drivers/net/usb/r8152.c
+++ b/drivers/net/usb/r8152.c
@@@ -623,10 -619,9 +623,10 @@@ enum rtl8152_flags 
  	RTL8152_LINK_CHG,
  	SELECTIVE_SUSPEND,
  	PHY_RESET,
- 	SCHEDULE_NAPI,
+ 	SCHEDULE_TASKLET,
  	GREEN_ETHERNET,
  	DELL_TB_RX_AGG_BUG,
 +	LENOVO_MACPASSTHRU,
  };
  
  /* Define these values to match your device */
@@@ -4193,7 -4175,9 +4197,13 @@@ static int rtl8152_close(struct net_dev
  #ifdef CONFIG_PM_SLEEP
  	unregister_pm_notifier(&tp->pm_notifier);
  #endif
++<<<<<<< HEAD
 +	napi_disable(&tp->napi);
++=======
+ 	tasklet_disable(&tp->tx_tl);
+ 	if (!test_bit(RTL8152_UNPLUG, &tp->flags))
+ 		napi_disable(&tp->napi);
++>>>>>>> d2187f8e4454 (r8152: divide the tx and rx bottom functions)
  	clear_bit(WORK_ENABLE, &tp->flags);
  	usb_kill_urb(tp->intr_urb);
  	cancel_delayed_work_sync(&tp->schedule);
@@@ -5609,6 -5595,8 +5625,11 @@@ static int rtl8152_probe(struct usb_int
  	return 0;
  
  out1:
++<<<<<<< HEAD
++=======
+ 	netif_napi_del(&tp->napi);
+ 	tasklet_kill(&tp->tx_tl);
++>>>>>>> d2187f8e4454 (r8152: divide the tx and rx bottom functions)
  	usb_set_intfdata(intf, NULL);
  out:
  	free_netdev(netdev);
@@@ -5623,7 -5611,9 +5644,8 @@@ static void rtl8152_disconnect(struct u
  	if (tp) {
  		rtl_set_unplug(tp);
  
 -		netif_napi_del(&tp->napi);
  		unregister_netdev(tp->netdev);
+ 		tasklet_kill(&tp->tx_tl);
  		cancel_delayed_work_sync(&tp->hw_phy_work);
  		tp->rtl_ops.unload(tp);
  		free_netdev(tp->netdev);
* Unmerged path drivers/net/usb/r8152.c
