hugetlb: fix uninitialized subpool pointer

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-326.el8
commit-author Mike Kravetz <mike.kravetz@oracle.com>
commit ff5461176213d5fd5cfb7e981f9add4d856e415a
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-326.el8/ff546117.failed

Gerald Schaefer reported a panic on s390 in hugepage_subpool_put_pages()
with linux-next 5.12.0-20210222.
Call trace:
  hugepage_subpool_put_pages.part.0+0x2c/0x138
  __free_huge_page+0xce/0x310
  alloc_pool_huge_page+0x102/0x120
  set_max_huge_pages+0x13e/0x350
  hugetlb_sysctl_handler_common+0xd8/0x110
  hugetlb_sysctl_handler+0x48/0x58
  proc_sys_call_handler+0x138/0x238
  new_sync_write+0x10e/0x198
  vfs_write.part.0+0x12c/0x238
  ksys_write+0x68/0xf8
  do_syscall+0x82/0xd0
  __do_syscall+0xb4/0xc8
  system_call+0x72/0x98

This is a result of the change which moved the hugetlb page subpool
pointer from page->private to page[1]->private.  When new pages are
allocated from the buddy allocator, the private field of the head
page will be cleared, but the private field of subpages is not modified.
Therefore, old values may remain.

Fix by initializing hugetlb page subpool pointer in prep_new_huge_page().

Link: https://lkml.kernel.org/r/20210223215544.313871-1-mike.kravetz@oracle.com
Fixes: f1280272ae4d ("hugetlb: use page.private for hugetlb specific page flags")
	Signed-off-by: Mike Kravetz <mike.kravetz@oracle.com>
	Reported-by: Gerald Schaefer <gerald.schaefer@linux.ibm.com>
	Reviewed-by: Oscar Salvador <osalvador@suse.de>
	Acked-by: Michal Hocko <mhocko@suse.com>
	Cc: Gerald Schaefer <gerald.schaefer@linux.ibm.com>
	Cc: Muchun Song <songmuchun@bytedance.com>
	Cc: Heiko Carstens <hca@linux.ibm.com>
	Cc: Sven Schnelle <svens@linux.ibm.com>
	Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
	Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
(cherry picked from commit ff5461176213d5fd5cfb7e981f9add4d856e415a)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	mm/hugetlb.c
diff --cc mm/hugetlb.c
index ecbeabd66a23,8e5f494291c6..000000000000
--- a/mm/hugetlb.c
+++ b/mm/hugetlb.c
@@@ -1305,10 -1465,13 +1305,16 @@@ static void prep_new_huge_page(struct h
  {
  	INIT_LIST_HEAD(&page->lru);
  	set_compound_page_dtor(page, HUGETLB_PAGE_DTOR);
++<<<<<<< HEAD
++=======
+ 	hugetlb_set_page_subpool(page, NULL);
+ 	set_hugetlb_cgroup(page, NULL);
+ 	set_hugetlb_cgroup_rsvd(page, NULL);
++>>>>>>> ff5461176213 (hugetlb: fix uninitialized subpool pointer)
  	spin_lock(&hugetlb_lock);
 +	set_hugetlb_cgroup(page, NULL);
  	h->nr_huge_pages++;
  	h->nr_huge_pages_node[nid]++;
 -	ClearHPageFreed(page);
  	spin_unlock(&hugetlb_lock);
  }
  
* Unmerged path mm/hugetlb.c
