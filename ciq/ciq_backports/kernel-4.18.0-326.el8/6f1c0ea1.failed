net: introduce a netdev feature for UDP GRO forwarding

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-326.el8
commit-author Alexander Lobakin <alobakin@pm.me>
commit 6f1c0ea133a6e4a193a7b285efe209664caeea43
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-326.el8/6f1c0ea1.failed

Introduce a new netdev feature, NETIF_F_GRO_UDP_FWD, to allow user
to turn UDP GRO on and off for forwarding.
Defaults to off to not change current datapath.

	Suggested-by: Paolo Abeni <pabeni@redhat.com>
	Signed-off-by: Alexander Lobakin <alobakin@pm.me>
	Signed-off-by: Jakub Kicinski <kuba@kernel.org>
(cherry picked from commit 6f1c0ea133a6e4a193a7b285efe209664caeea43)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	include/linux/netdev_features.h
#	net/ethtool/common.c
diff --cc include/linux/netdev_features.h
index 75804ff60280,c06d6aaba9df..000000000000
--- a/include/linux/netdev_features.h
+++ b/include/linux/netdev_features.h
@@@ -99,6 -80,11 +99,13 @@@ enum 
  
  	NETIF_F_GRO_HW_BIT,		/* Hardware Generic receive offload */
  	NETIF_F_HW_TLS_RECORD_BIT,	/* Offload TLS record */
++<<<<<<< HEAD
++=======
+ 	NETIF_F_GRO_FRAGLIST_BIT,	/* Fraglist GRO */
+ 
+ 	NETIF_F_HW_MACSEC_BIT,		/* Offload MACsec operations */
+ 	NETIF_F_GRO_UDP_FWD_BIT,	/* Allow UDP GRO for forwarding */
++>>>>>>> 6f1c0ea133a6 (net: introduce a netdev feature for UDP GRO forwarding)
  
  	/*
  	 * Add your fresh new feature above and remember to update
@@@ -171,9 -157,29 +178,14 @@@
  #define NETIF_F_HW_TLS_RX	__NETIF_F(HW_TLS_RX)
  #define NETIF_F_GRO_FRAGLIST	__NETIF_F(GRO_FRAGLIST)
  #define NETIF_F_GSO_FRAGLIST	__NETIF_F(GSO_FRAGLIST)
++<<<<<<< HEAD
++=======
+ #define NETIF_F_HW_MACSEC	__NETIF_F(HW_MACSEC)
+ #define NETIF_F_GRO_UDP_FWD	__NETIF_F(GRO_UDP_FWD)
++>>>>>>> 6f1c0ea133a6 (net: introduce a netdev feature for UDP GRO forwarding)
  
 -/* Finds the next feature with the highest number of the range of start till 0.
 - */
 -static inline int find_next_netdev_feature(u64 feature, unsigned long start)
 -{
 -	/* like BITMAP_LAST_WORD_MASK() for u64
 -	 * this sets the most significant 64 - start to 0.
 -	 */
 -	feature &= ~0ULL >> (-start & ((sizeof(feature) * 8) - 1));
 -
 -	return fls64(feature) - 1;
 -}
 -
 -/* This goes for the MSB to the LSB through the set feature bits,
 - * mask_addr should be a u64 and bit an int
 - */
 -#define for_each_netdev_feature(mask_addr, bit)				\
 -	for ((bit) = find_next_netdev_feature((mask_addr),		\
 -					      NETDEV_FEATURE_COUNT);	\
 -	     (bit) >= 0;						\
 -	     (bit) = find_next_netdev_feature((mask_addr), (bit) - 1))
 +#define for_each_netdev_feature(mask_addr, bit)	\
 +	for_each_set_bit(bit, (unsigned long *)mask_addr, NETDEV_FEATURE_COUNT)
  
  /* Features valid for ethtool to change */
  /* = all defined minus driver/device-class-related */
diff --cc net/ethtool/common.c
index 94b9b3252ee9,181220101a6e..000000000000
--- a/net/ethtool/common.c
+++ b/net/ethtool/common.c
@@@ -67,6 -67,8 +67,11 @@@ const char netdev_features_strings[NETD
  	[NETIF_F_HW_TLS_TX_BIT] =	 "tls-hw-tx-offload",
  	[NETIF_F_HW_TLS_RX_BIT] =	 "tls-hw-rx-offload",
  	[NETIF_F_GRO_FRAGLIST_BIT] =	 "rx-gro-list",
++<<<<<<< HEAD
++=======
+ 	[NETIF_F_HW_MACSEC_BIT] =	 "macsec-hw-offload",
+ 	[NETIF_F_GRO_UDP_FWD_BIT] =	 "rx-udp-gro-forwarding",
++>>>>>>> 6f1c0ea133a6 (net: introduce a netdev feature for UDP GRO forwarding)
  };
  
  const char
* Unmerged path include/linux/netdev_features.h
* Unmerged path net/ethtool/common.c
