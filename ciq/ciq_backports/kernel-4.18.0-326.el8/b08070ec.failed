ext4: don't remount read-only with errors=continue on reboot

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-326.el8
commit-author Jan Kara <jack@suse.cz>
commit b08070eca9e247f60ab39d79b2c25d274750441f
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-326.el8/b08070ec.failed

ext4_handle_error() with errors=continue mount option can accidentally
remount the filesystem read-only when the system is rebooting. Fix that.

Fixes: 1dc1097ff60e ("ext4: avoid panic during forced reboot")
	Signed-off-by: Jan Kara <jack@suse.cz>
	Reviewed-by: Andreas Dilger <adilger@dilger.ca>
	Cc: stable@kernel.org
Link: https://lore.kernel.org/r/20201127113405.26867-2-jack@suse.cz
	Signed-off-by: Theodore Ts'o <tytso@mit.edu>
(cherry picked from commit b08070eca9e247f60ab39d79b2c25d274750441f)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/ext4/super.c
diff --cc fs/ext4/super.c
index c2f6cd4b29a3,3ef84e8ab1ae..000000000000
--- a/fs/ext4/super.c
+++ b/fs/ext4/super.c
@@@ -518,16 -671,12 +520,22 @@@ static void ext4_handle_error(struct su
  	if (test_opt(sb, WARN_ON_ERROR))
  		WARN_ON_ONCE(1);
  
- 	if (sb_rdonly(sb))
+ 	if (sb_rdonly(sb) || test_opt(sb, ERRORS_CONT))
  		return;
  
++<<<<<<< HEAD
 +	if (!test_opt(sb, ERRORS_CONT)) {
 +		journal_t *journal = EXT4_SB(sb)->s_journal;
 +
 +		EXT4_SB(sb)->s_mount_flags |= EXT4_MF_FS_ABORTED;
 +		if (journal)
 +			jbd2_journal_abort(journal, -EIO);
 +	}
++=======
+ 	ext4_set_mount_flag(sb, EXT4_MF_FS_ABORTED);
+ 	if (journal)
+ 		jbd2_journal_abort(journal, -EIO);
++>>>>>>> b08070eca9e2 (ext4: don't remount read-only with errors=continue on reboot)
  	/*
  	 * We force ERRORS_RO behavior when system is rebooting. Otherwise we
  	 * could panic during 'reboot -f' as the underlying device got already
* Unmerged path fs/ext4/super.c
