Documentation: kdump: update kdump guide

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-326.el8
commit-author Baoquan He <bhe@redhat.com>
commit b1f4c363666c31f289b26bfc7c38378f0db79b55
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-326.el8/b1f4c363.failed

Some parts of the guide are aged, hence need be updated.

1) The backup area of the 1st 640K on X86_64 has been removed
   by below commits, update the description accordingly.

   commit 7c321eb2b843 ("x86/kdump: Remove the backup region handling")
   commit 6f599d84231f ("x86/kdump: Always reserve the low 1M when the crashkernel option is specified")

2) Sort out the descripiton of "crashkernel syntax" part.

3) And some other minor cleanups.

	Signed-off-by: Baoquan He <bhe@redhat.com>
	Acked-by: Dave Young <dyoung@redhat.com>
Link: https://lore.kernel.org/r/20210609083218.GB591017@MiWiFi-R3L-srv
[jc: added blank line to fix added build warning]
	Signed-off-by: Jonathan Corbet <corbet@lwn.net>
(cherry picked from commit b1f4c363666c31f289b26bfc7c38378f0db79b55)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	Documentation/kdump/kdump.txt
diff --cc Documentation/kdump/kdump.txt
index cc58b182dabf,cb30ca3df27c..000000000000
--- a/Documentation/kdump/kdump.txt
+++ b/Documentation/kdump/kdump.txt
@@@ -126,14 -127,23 +128,29 @@@ dump-capture kernels for enabling kdum
  System kernel config options
  ----------------------------
  
++<<<<<<< HEAD:Documentation/kdump/kdump.txt
 +1) Enable "kexec system call" in "Processor type and features."
 +
 +   CONFIG_KEXEC=y
++=======
+ 1) Enable "kexec system call" or "kexec file based system call" in
+    "Processor type and features."::
+ 
+ 	CONFIG_KEXEC=y or CONFIG_KEXEC_FILE=y
+ 
+    And both of them will select KEXEC_CORE::
+ 
+ 	CONFIG_KEXEC_CORE=y
+ 
+    Subsequently, CRASH_CORE is selected by KEXEC_CORE::
+ 
+ 	CONFIG_CRASH_CORE=y
++>>>>>>> b1f4c363666c (Documentation: kdump: update kdump guide):Documentation/admin-guide/kdump/kdump.rst
  
  2) Enable "sysfs file system support" in "Filesystem" -> "Pseudo
 -   filesystems." This is usually enabled by default::
 +   filesystems." This is usually enabled by default.
  
 -	CONFIG_SYSFS=y
 +   CONFIG_SYSFS=y
  
     Note that "sysfs file system support" might not appear in the "Pseudo
     filesystems" menu if "Configure standard kernel features (for small
@@@ -167,26 -178,30 +184,41 @@@ Dump-capture kernel config options (Arc
  --------------------------------------------------------------------
  
  1) On i386, enable high memory support under "Processor type and
 -   features"::
 -
 -	CONFIG_HIGHMEM64G=y
 +   features":
  
 -   or::
 +   CONFIG_HIGHMEM64G=y
 +   or
 +   CONFIG_HIGHMEM4G
  
 -	CONFIG_HIGHMEM4G
++<<<<<<< HEAD:Documentation/kdump/kdump.txt
 +2) On i386 and x86_64, disable symmetric multi-processing support
 +   under "Processor type and features":
  
 +   CONFIG_SMP=n
++=======
+ 2) With CONFIG_SMP=y, usually nr_cpus=1 need specified on the kernel
+    command line when loading the dump-capture kernel because one
+    CPU is enough for kdump kernel to dump vmcore on most of systems.
+ 
+    However, you can also specify nr_cpus=X to enable multiple processors
+    in kdump kernel. In this case, "disable_cpu_apicid=" is needed to
+    tell kdump kernel which cpu is 1st kernel's BSP. Please refer to
+    admin-guide/kernel-parameters.txt for more details.
++>>>>>>> b1f4c363666c (Documentation: kdump: update kdump guide):Documentation/admin-guide/kdump/kdump.rst
  
-    (If CONFIG_SMP=y, then specify maxcpus=1 on the kernel command line
-    when loading the dump-capture kernel, see section "Load the Dump-capture
-    Kernel".)
+    With CONFIG_SMP=n, the above things are not related.
  
++<<<<<<< HEAD:Documentation/kdump/kdump.txt
 +3) If one wants to build and use a relocatable kernel,
 +   Enable "Build a relocatable kernel" support under "Processor type and
 +   features"
++=======
+ 3) A relocatable kernel is suggested to be built by default. If not yet,
+    enable "Build a relocatable kernel" support under "Processor type and
+    features"::
++>>>>>>> b1f4c363666c (Documentation: kdump: update kdump guide):Documentation/admin-guide/kdump/kdump.rst
  
 -	CONFIG_RELOCATABLE=y
 +   CONFIG_RELOCATABLE=y
  
  4) Use a suitable value for "Physical address where the kernel is
     loaded" (under "Processor type and features"). This only appears when
@@@ -230,17 -245,15 +262,18 @@@ Dump-capture kernel config options (Arc
    as a dump-capture kernel if desired.
  
    The crashkernel region can be automatically placed by the system
++<<<<<<< HEAD:Documentation/kdump/kdump.txt
 +  kernel at run time. This is done by specifying the base address as 0,
 +  or omitting it all together.
++=======
+   kernel at runtime. This is done by specifying the base address as 0,
+   or omitting it all together::
++>>>>>>> b1f4c363666c (Documentation: kdump: update kdump guide):Documentation/admin-guide/kdump/kdump.rst
  
 -	crashkernel=256M@0
 -
 -  or::
 -
 -	crashkernel=256M
 +  crashkernel=256M@0
 +  or
 +  crashkernel=256M
  
-   If the start address is specified, note that the start address of the
-   kernel will be aligned to 64Mb, so if the start address is not then
-   any space below the alignment point will be wasted.
- 
  Dump-capture kernel config options (Arch Dependent, arm)
  ----------------------------------------------------------
  
@@@ -256,53 -269,12 +289,59 @@@ Dump-capture kernel config options (Arc
    on non-VHE systems even if it is configured. This is because the CPU
    will not be reset to EL2 on panic.
  
- Extended crashkernel syntax
+ crashkernel syntax
  ===========================
+ 1) crashkernel=size@offset
  
++<<<<<<< HEAD:Documentation/kdump/kdump.txt
 +While the "crashkernel=size[@offset]" syntax is sufficient for most
 +configurations, sometimes it's handy to have the reserved memory dependent
 +on the value of System RAM -- that's mostly for distributors that pre-setup
 +the kernel command line to avoid a unbootable system after some memory has
 +been removed from the machine.
 +
 +The syntax is:
 +
 +    crashkernel=<range1>:<size1>[,<range2>:<size2>,...][@offset]
 +    range=start-[end]
 +
 +For example:
 +
 +    crashkernel=512M-2G:64M,2G-:128M
 +
 +This would mean:
 +
 +    1) if the RAM is smaller than 512M, then don't reserve anything
 +       (this is the "rescue" case)
 +    2) if the RAM size is between 512M and 2G (exclusive), then reserve 64M
 +    3) if the RAM size is larger than 2G, then reserve 128M
 +
 +Or you can use crashkernel=auto if you have enough memory.  The threshold
 +is 1G on x86_64, 2G on arm64, ppc64 and ppc64le. The threshold is 4G for s390x.
 +If your system memory is less than the threshold crashkernel=auto will not
 +reserve memory.
 +
 +The automatically reserved memory size varies based on architecture.
 +The size changes according to system memory size like below:
 +    x86_64: 1G-4G:160M,4G-64G:192M,64G-1T:256M,1T-:512M
 +    s390x:  1G-4G:160M,4G-64G:192M,64G-1T:256M,1T-:512M
 +    arm64:  2G-:448M
 +    ppc64:  2G-4G:384M,4G-16G:512M,16G-64G:1G,64G-128G:2G,128G-:4G
 +
 +
 +Boot into System Kernel
 +=======================
 +
 +1) Update the boot loader (such as grub, yaboot, or lilo) configuration
 +   files as necessary.
 +
 +2) Boot the system kernel with the boot parameter "crashkernel=Y@X",
 +   where Y specifies how much memory to reserve for the dump-capture kernel
 +   and X specifies the beginning of this reserved memory. For example,
++=======
+    Here 'size' specifies how much memory to reserve for the dump-capture kernel
+    and 'offset' specifies the beginning of this reserved memory. For example,
++>>>>>>> b1f4c363666c (Documentation: kdump: update kdump guide):Documentation/admin-guide/kdump/kdump.rst
     "crashkernel=64M@16M" tells the system kernel to reserve 64 MB of memory
     starting at physical address 0x01000000 (16MB) for the dump-capture kernel.
  
@@@ -337,17 -375,28 +442,24 @@@ can choose to load the uncompressed vml
  of dump-capture kernel. Following is the summary.
  
  For i386 and x86_64:
++<<<<<<< HEAD:Documentation/kdump/kdump.txt
 +	- Use vmlinux if kernel is not relocatable.
 +	- Use bzImage/vmlinuz if kernel is relocatable.
++=======
+ 
+ 	- Use bzImage/vmlinuz if kernel is relocatable.
+ 	- Use vmlinux if kernel is not relocatable.
+ 
++>>>>>>> b1f4c363666c (Documentation: kdump: update kdump guide):Documentation/admin-guide/kdump/kdump.rst
  For ppc64:
 -
  	- Use vmlinux
 -
  For ia64:
 -
  	- Use vmlinux or vmlinuz.gz
 -
  For s390x:
 -
  	- Use image or bzImage
 -
  For arm:
 -
  	- Use zImage
 -
  For arm64:
 -
  	- Use vmlinux or Image
  
  If you are using an uncompressed vmlinux image then use following command
@@@ -387,19 -436,24 +499,34 @@@ Following are the arch specific comman
  loading dump-capture kernel.
  
  For i386, x86_64 and ia64:
++<<<<<<< HEAD:Documentation/kdump/kdump.txt
 +	"1 irqpoll maxcpus=1 reset_devices"
++=======
+ 
+ 	"1 irqpoll nr_cpus=1 reset_devices"
++>>>>>>> b1f4c363666c (Documentation: kdump: update kdump guide):Documentation/admin-guide/kdump/kdump.rst
  
  For ppc64:
 -
  	"1 maxcpus=1 noirqdistrib reset_devices"
  
  For s390x:
++<<<<<<< HEAD:Documentation/kdump/kdump.txt
 +	"1 maxcpus=1 cgroup_disable=memory"
++=======
+ 
+ 	"1 nr_cpus=1 cgroup_disable=memory"
++>>>>>>> b1f4c363666c (Documentation: kdump: update kdump guide):Documentation/admin-guide/kdump/kdump.rst
  
  For arm:
 -
  	"1 maxcpus=1 reset_devices"
  
  For arm64:
++<<<<<<< HEAD:Documentation/kdump/kdump.txt
 +	"1 maxcpus=1 reset_devices"
++=======
+ 
+ 	"1 nr_cpus=1 reset_devices"
++>>>>>>> b1f4c363666c (Documentation: kdump: update kdump guide):Documentation/admin-guide/kdump/kdump.rst
  
  Notes on loading the dump-capture kernel:
  
@@@ -526,6 -584,10 +657,10 @@@ This will cause a kdump to occur at th
  Contact
  =======
  
++<<<<<<< HEAD:Documentation/kdump/kdump.txt
 +Vivek Goyal (vgoyal@redhat.com)
 +Maneesh Soni (maneesh@in.ibm.com)
++=======
+ - kexec@lists.infradead.org
++>>>>>>> b1f4c363666c (Documentation: kdump: update kdump guide):Documentation/admin-guide/kdump/kdump.rst
  
 -GDB macros
 -==========
 -
 -.. include:: gdbmacros.txt
 -   :literal:
* Unmerged path Documentation/kdump/kdump.txt
