net: Introduce peer to peer one step PTP time stamping.

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-326.el8
commit-author Richard Cochran <richardcochran@gmail.com>
commit b6fd7b96366769651ab23988607ce9c5c9042cdb
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-326.el8/b6fd7b96.failed

The 1588 standard defines one step operation for both Sync and
PDelay_Resp messages.  Up until now, hardware with P2P one step has
been rare, and kernel support was lacking.  This patch adds support of
the mode in anticipation of new hardware developments.

	Signed-off-by: Richard Cochran <richardcochran@gmail.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit b6fd7b96366769651ab23988607ce9c5c9042cdb)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/microchip/lan743x_ptp.c
#	include/uapi/linux/net_tstamp.h
diff --cc include/uapi/linux/net_tstamp.h
index 2306a7d8c7ee,f96e650d0af9..000000000000
--- a/include/uapi/linux/net_tstamp.h
+++ b/include/uapi/linux/net_tstamp.h
@@@ -91,8 -91,13 +91,18 @@@ enum hwtstamp_tx_types 
  	 */
  	HWTSTAMP_TX_ONESTEP_SYNC,
  
++<<<<<<< HEAD
 +	/* add new constants above here */
 +	__HWTSTAMP_TX_CNT
++=======
+ 	/*
+ 	 * Same as HWTSTAMP_TX_ONESTEP_SYNC, but also enables time
+ 	 * stamp insertion directly into PDelay_Resp packets. In this
+ 	 * case, neither transmitted Sync nor PDelay_Resp packets will
+ 	 * receive a time stamp via the socket error queue.
+ 	 */
+ 	HWTSTAMP_TX_ONESTEP_P2P,
++>>>>>>> b6fd7b963667 (net: Introduce peer to peer one step PTP time stamping.)
  };
  
  /* possible values for hwtstamp_config->rx_filter */
* Unmerged path drivers/net/ethernet/microchip/lan743x_ptp.c
diff --git a/drivers/net/ethernet/broadcom/bnx2x/bnx2x_main.c b/drivers/net/ethernet/broadcom/bnx2x/bnx2x_main.c
index 87e01dd6115c..160be14afe40 100644
--- a/drivers/net/ethernet/broadcom/bnx2x/bnx2x_main.c
+++ b/drivers/net/ethernet/broadcom/bnx2x/bnx2x_main.c
@@ -15425,6 +15425,7 @@ int bnx2x_configure_ptp_filters(struct bnx2x *bp)
 		REG_WR(bp, rule, BNX2X_PTP_TX_ON_RULE_MASK);
 		break;
 	case HWTSTAMP_TX_ONESTEP_SYNC:
+	case HWTSTAMP_TX_ONESTEP_P2P:
 		BNX2X_ERR("One-step timestamping is not supported\n");
 		return -ERANGE;
 	}
diff --git a/drivers/net/ethernet/mellanox/mlxsw/spectrum_ptp.c b/drivers/net/ethernet/mellanox/mlxsw/spectrum_ptp.c
index f0065466fb7c..ca8090a28dec 100644
--- a/drivers/net/ethernet/mellanox/mlxsw/spectrum_ptp.c
+++ b/drivers/net/ethernet/mellanox/mlxsw/spectrum_ptp.c
@@ -902,6 +902,7 @@ static int mlxsw_sp_ptp_get_message_types(const struct hwtstamp_config *config,
 		egr_types = 0xff;
 		break;
 	case HWTSTAMP_TX_ONESTEP_SYNC:
+	case HWTSTAMP_TX_ONESTEP_P2P:
 		return -ERANGE;
 	default:
 		return -EINVAL;
* Unmerged path drivers/net/ethernet/microchip/lan743x_ptp.c
diff --git a/drivers/net/ethernet/qlogic/qede/qede_ptp.c b/drivers/net/ethernet/qlogic/qede/qede_ptp.c
index 3a4f4f447042..8c28fabb0ff6 100644
--- a/drivers/net/ethernet/qlogic/qede/qede_ptp.c
+++ b/drivers/net/ethernet/qlogic/qede/qede_ptp.c
@@ -222,6 +222,7 @@ static int qede_ptp_cfg_filters(struct qede_dev *edev)
 		break;
 
 	case HWTSTAMP_TX_ONESTEP_SYNC:
+	case HWTSTAMP_TX_ONESTEP_P2P:
 		DP_ERR(edev, "One-step timestamping is not supported\n");
 		return -ERANGE;
 	}
* Unmerged path include/uapi/linux/net_tstamp.h
diff --git a/net/core/dev_ioctl.c b/net/core/dev_ioctl.c
index 5a55f7dc3cc9..97abf1f3f2b0 100644
--- a/net/core/dev_ioctl.c
+++ b/net/core/dev_ioctl.c
@@ -176,6 +176,7 @@ static int net_hwtstamp_validate(struct ifreq *ifr)
 	case HWTSTAMP_TX_OFF:
 	case HWTSTAMP_TX_ON:
 	case HWTSTAMP_TX_ONESTEP_SYNC:
+	case HWTSTAMP_TX_ONESTEP_P2P:
 		tx_type_valid = 1;
 		break;
 	case __HWTSTAMP_TX_CNT:
