iommu: Add iommu_dma_free_cpu_cached_iovas()

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-326.el8
commit-author Tom Murphy <murphyt7@tcd.ie>
commit 230309d08b871e439f8618db3610f2cc9b5f7c72
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-326.el8/230309d0.failed

Add a iommu_dma_free_cpu_cached_iovas function to allow drivers which
use the dma-iommu ops to free cached cpu iovas.

	Signed-off-by: Tom Murphy <murphyt7@tcd.ie>
	Signed-off-by: Lu Baolu <baolu.lu@linux.intel.com>
	Tested-by: Logan Gunthorpe <logang@deltatee.com>
Link: https://lore.kernel.org/r/20201124082057.2614359-3-baolu.lu@linux.intel.com
	Signed-off-by: Will Deacon <will@kernel.org>
(cherry picked from commit 230309d08b871e439f8618db3610f2cc9b5f7c72)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/iommu/dma-iommu.c
diff --cc drivers/iommu/dma-iommu.c
index ebea1484c24c,de521e22bafb..000000000000
--- a/drivers/iommu/dma-iommu.c
+++ b/drivers/iommu/dma-iommu.c
@@@ -61,7 -49,26 +61,30 @@@ struct iommu_dma_cookie 
  	struct iommu_domain		*fq_domain;
  };
  
++<<<<<<< HEAD
 +static DEFINE_STATIC_KEY_FALSE(iommu_deferred_attach_enabled);
++=======
+ void iommu_dma_free_cpu_cached_iovas(unsigned int cpu,
+ 		struct iommu_domain *domain)
+ {
+ 	struct iommu_dma_cookie *cookie = domain->iova_cookie;
+ 	struct iova_domain *iovad = &cookie->iovad;
+ 
+ 	free_cpu_cached_iovas(cpu, iovad);
+ }
+ 
+ static void iommu_dma_entry_dtor(unsigned long data)
+ {
+ 	struct page *freelist = (struct page *)data;
+ 
+ 	while (freelist) {
+ 		unsigned long p = (unsigned long)page_address(freelist);
+ 
+ 		freelist = freelist->freelist;
+ 		free_page(p);
+ 	}
+ }
++>>>>>>> 230309d08b87 (iommu: Add iommu_dma_free_cpu_cached_iovas())
  
  static inline size_t cookie_msi_granule(struct iommu_dma_cookie *cookie)
  {
* Unmerged path drivers/iommu/dma-iommu.c
diff --git a/include/linux/dma-iommu.h b/include/linux/dma-iommu.h
index b3cc3fb84079..ac901a25af9b 100644
--- a/include/linux/dma-iommu.h
+++ b/include/linux/dma-iommu.h
@@ -48,6 +48,9 @@ void iommu_dma_compose_msi_msg(struct msi_desc *desc,
 
 void iommu_dma_get_resv_regions(struct device *dev, struct list_head *list);
 
+void iommu_dma_free_cpu_cached_iovas(unsigned int cpu,
+		struct iommu_domain *domain);
+
 #else /* CONFIG_IOMMU_DMA */
 
 struct iommu_domain;
@@ -89,5 +92,10 @@ static inline void iommu_dma_get_resv_regions(struct device *dev, struct list_he
 {
 }
 
+static inline void iommu_dma_free_cpu_cached_iovas(unsigned int cpu,
+		struct iommu_domain *domain)
+{
+}
+
 #endif	/* CONFIG_IOMMU_DMA */
 #endif	/* __DMA_IOMMU_H */
