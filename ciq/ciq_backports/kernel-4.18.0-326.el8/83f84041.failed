powerpc/83xx: Move PHB discovery

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-326.el8
commit-author Oliver O'Halloran <oohall@gmail.com>
commit 83f84041ff1cf6c23fc38861218af2d4ca2d9b38
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-326.el8/83f84041.failed

	Signed-off-by: Oliver O'Halloran <oohall@gmail.com>
	Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: https://lore.kernel.org/r/20201103043523.916109-10-oohall@gmail.com
(cherry picked from commit 83f84041ff1cf6c23fc38861218af2d4ca2d9b38)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/powerpc/platforms/83xx/km83xx.c
#	arch/powerpc/platforms/83xx/misc.c
#	arch/powerpc/platforms/83xx/mpc832x_mds.c
#	arch/powerpc/platforms/83xx/mpc832x_rdb.c
#	arch/powerpc/platforms/83xx/mpc836x_mds.c
#	arch/powerpc/platforms/83xx/mpc836x_rdk.c
diff --cc arch/powerpc/platforms/83xx/km83xx.c
index d8642a4afc74,108e1e4d2683..000000000000
--- a/arch/powerpc/platforms/83xx/km83xx.c
+++ b/arch/powerpc/platforms/83xx/km83xx.c
@@@ -182,7 -180,8 +182,12 @@@ define_machine(mpc83xx_km) 
  	.name		= "mpc83xx-km-platform",
  	.probe		= mpc83xx_km_probe,
  	.setup_arch	= mpc83xx_km_setup_arch,
++<<<<<<< HEAD
 +	.init_IRQ	= mpc83xx_ipic_and_qe_init_IRQ,
++=======
+ 	.discover_phbs	= mpc83xx_setup_pci,
+ 	.init_IRQ	= mpc83xx_ipic_init_IRQ,
++>>>>>>> 83f84041ff1c (powerpc/83xx: Move PHB discovery)
  	.get_irq	= ipic_get_irq,
  	.restart	= mpc83xx_restart,
  	.time_init	= mpc83xx_time_init,
diff --cc arch/powerpc/platforms/83xx/misc.c
index 2b6589fe812d,3285dabcf923..000000000000
--- a/arch/powerpc/platforms/83xx/misc.c
+++ b/arch/powerpc/platforms/83xx/misc.c
@@@ -149,7 -124,14 +149,18 @@@ void __init mpc83xx_setup_arch(void
  	if (ppc_md.progress)
  		ppc_md.progress("mpc83xx_setup_arch()", 0);
  
++<<<<<<< HEAD
 +	mpc83xx_setup_pci();
++=======
+ 	if (!__map_without_bats) {
+ 		phys_addr_t immrbase = get_immrbase();
+ 		int immrsize = IS_ALIGNED(immrbase, SZ_2M) ? SZ_2M : SZ_1M;
+ 		unsigned long va = fix_to_virt(FIX_IMMR_BASE);
+ 
+ 		setbat(-1, va, immrbase, immrsize, PAGE_KERNEL_NCG);
+ 		update_bats();
+ 	}
++>>>>>>> 83f84041ff1c (powerpc/83xx: Move PHB discovery)
  }
  
  int machine_check_83xx(struct pt_regs *regs)
diff --cc arch/powerpc/platforms/83xx/mpc832x_mds.c
index 74c154e67c8b,850d566ef900..000000000000
--- a/arch/powerpc/platforms/83xx/mpc832x_mds.c
+++ b/arch/powerpc/platforms/83xx/mpc832x_mds.c
@@@ -106,7 -101,8 +106,12 @@@ define_machine(mpc832x_mds) 
  	.name 		= "MPC832x MDS",
  	.probe 		= mpc832x_sys_probe,
  	.setup_arch 	= mpc832x_sys_setup_arch,
++<<<<<<< HEAD
 +	.init_IRQ	= mpc83xx_ipic_and_qe_init_IRQ,
++=======
+ 	.discover_phbs	= mpc83xx_setup_pci,
+ 	.init_IRQ	= mpc83xx_ipic_init_IRQ,
++>>>>>>> 83f84041ff1c (powerpc/83xx: Move PHB discovery)
  	.get_irq 	= ipic_get_irq,
  	.restart 	= mpc83xx_restart,
  	.time_init 	= mpc83xx_time_init,
diff --cc arch/powerpc/platforms/83xx/mpc832x_rdb.c
index 438986593873,b6133a237a70..000000000000
--- a/arch/powerpc/platforms/83xx/mpc832x_rdb.c
+++ b/arch/powerpc/platforms/83xx/mpc832x_rdb.c
@@@ -224,7 -219,8 +224,12 @@@ define_machine(mpc832x_rdb) 
  	.name		= "MPC832x RDB",
  	.probe		= mpc832x_rdb_probe,
  	.setup_arch	= mpc832x_rdb_setup_arch,
++<<<<<<< HEAD
 +	.init_IRQ	= mpc83xx_ipic_and_qe_init_IRQ,
++=======
+ 	.discover_phbs  = mpc83xx_setup_pci,
+ 	.init_IRQ	= mpc83xx_ipic_init_IRQ,
++>>>>>>> 83f84041ff1c (powerpc/83xx: Move PHB discovery)
  	.get_irq	= ipic_get_irq,
  	.restart	= mpc83xx_restart,
  	.time_init	= mpc83xx_time_init,
diff --cc arch/powerpc/platforms/83xx/mpc836x_mds.c
index fd44dd03e1f3,da4cf52cb55b..000000000000
--- a/arch/powerpc/platforms/83xx/mpc836x_mds.c
+++ b/arch/powerpc/platforms/83xx/mpc836x_mds.c
@@@ -213,7 -201,8 +213,12 @@@ define_machine(mpc836x_mds) 
  	.name		= "MPC836x MDS",
  	.probe		= mpc836x_mds_probe,
  	.setup_arch	= mpc836x_mds_setup_arch,
++<<<<<<< HEAD
 +	.init_IRQ	= mpc83xx_ipic_and_qe_init_IRQ,
++=======
+ 	.discover_phbs  = mpc83xx_setup_pci,
+ 	.init_IRQ	= mpc83xx_ipic_init_IRQ,
++>>>>>>> 83f84041ff1c (powerpc/83xx: Move PHB discovery)
  	.get_irq	= ipic_get_irq,
  	.restart	= mpc83xx_restart,
  	.time_init	= mpc83xx_time_init,
diff --cc arch/powerpc/platforms/83xx/mpc836x_rdk.c
index 93f024fd9b45,3427ad0d9d38..000000000000
--- a/arch/powerpc/platforms/83xx/mpc836x_rdk.c
+++ b/arch/powerpc/platforms/83xx/mpc836x_rdk.c
@@@ -46,7 -41,8 +46,12 @@@ define_machine(mpc836x_rdk) 
  	.name		= "MPC836x RDK",
  	.probe		= mpc836x_rdk_probe,
  	.setup_arch	= mpc836x_rdk_setup_arch,
++<<<<<<< HEAD
 +	.init_IRQ	= mpc83xx_ipic_and_qe_init_IRQ,
++=======
+ 	.discover_phbs  = mpc83xx_setup_pci,
+ 	.init_IRQ	= mpc83xx_ipic_init_IRQ,
++>>>>>>> 83f84041ff1c (powerpc/83xx: Move PHB discovery)
  	.get_irq	= ipic_get_irq,
  	.restart	= mpc83xx_restart,
  	.time_init	= mpc83xx_time_init,
diff --git a/arch/powerpc/platforms/83xx/asp834x.c b/arch/powerpc/platforms/83xx/asp834x.c
index 575afd6eb36a..fd2b5be64927 100644
--- a/arch/powerpc/platforms/83xx/asp834x.c
+++ b/arch/powerpc/platforms/83xx/asp834x.c
@@ -48,6 +48,7 @@ define_machine(asp834x) {
 	.name			= "ASP8347E",
 	.probe			= asp834x_probe,
 	.setup_arch		= asp834x_setup_arch,
+	.discover_phbs		= mpc83xx_setup_pci,
 	.init_IRQ		= mpc83xx_ipic_init_IRQ,
 	.get_irq		= ipic_get_irq,
 	.restart		= mpc83xx_restart,
* Unmerged path arch/powerpc/platforms/83xx/km83xx.c
* Unmerged path arch/powerpc/platforms/83xx/misc.c
diff --git a/arch/powerpc/platforms/83xx/mpc830x_rdb.c b/arch/powerpc/platforms/83xx/mpc830x_rdb.c
index 272c41c387b9..a8dc74f9a3c5 100644
--- a/arch/powerpc/platforms/83xx/mpc830x_rdb.c
+++ b/arch/powerpc/platforms/83xx/mpc830x_rdb.c
@@ -52,6 +52,7 @@ define_machine(mpc830x_rdb) {
 	.name			= "MPC830x RDB",
 	.probe			= mpc830x_rdb_probe,
 	.setup_arch		= mpc830x_rdb_setup_arch,
+	.discover_phbs		= mpc83xx_setup_pci,
 	.init_IRQ		= mpc83xx_ipic_init_IRQ,
 	.get_irq		= ipic_get_irq,
 	.restart		= mpc83xx_restart,
diff --git a/arch/powerpc/platforms/83xx/mpc831x_rdb.c b/arch/powerpc/platforms/83xx/mpc831x_rdb.c
index fd80fd570e67..40df83dc1b5d 100644
--- a/arch/powerpc/platforms/83xx/mpc831x_rdb.c
+++ b/arch/powerpc/platforms/83xx/mpc831x_rdb.c
@@ -52,6 +52,7 @@ define_machine(mpc831x_rdb) {
 	.name			= "MPC831x RDB",
 	.probe			= mpc831x_rdb_probe,
 	.setup_arch		= mpc831x_rdb_setup_arch,
+	.discover_phbs		= mpc83xx_setup_pci,
 	.init_IRQ		= mpc83xx_ipic_init_IRQ,
 	.get_irq		= ipic_get_irq,
 	.restart		= mpc83xx_restart,
* Unmerged path arch/powerpc/platforms/83xx/mpc832x_mds.c
* Unmerged path arch/powerpc/platforms/83xx/mpc832x_rdb.c
diff --git a/arch/powerpc/platforms/83xx/mpc834x_itx.c b/arch/powerpc/platforms/83xx/mpc834x_itx.c
index 73a5267df497..3e7ca622b8ed 100644
--- a/arch/powerpc/platforms/83xx/mpc834x_itx.c
+++ b/arch/powerpc/platforms/83xx/mpc834x_itx.c
@@ -74,6 +74,7 @@ define_machine(mpc834x_itx) {
 	.name			= "MPC834x ITX",
 	.probe			= mpc834x_itx_probe,
 	.setup_arch		= mpc834x_itx_setup_arch,
+	.discover_phbs  	= mpc83xx_setup_pci,
 	.init_IRQ		= mpc83xx_ipic_init_IRQ,
 	.get_irq		= ipic_get_irq,
 	.restart		= mpc83xx_restart,
diff --git a/arch/powerpc/platforms/83xx/mpc834x_mds.c b/arch/powerpc/platforms/83xx/mpc834x_mds.c
index 009cfc18a4ee..1fd9a32cc0c1 100644
--- a/arch/powerpc/platforms/83xx/mpc834x_mds.c
+++ b/arch/powerpc/platforms/83xx/mpc834x_mds.c
@@ -95,6 +95,7 @@ define_machine(mpc834x_mds) {
 	.name			= "MPC834x MDS",
 	.probe			= mpc834x_mds_probe,
 	.setup_arch		= mpc834x_mds_setup_arch,
+	.discover_phbs  	= mpc83xx_setup_pci,
 	.init_IRQ		= mpc83xx_ipic_init_IRQ,
 	.get_irq		= ipic_get_irq,
 	.restart		= mpc83xx_restart,
* Unmerged path arch/powerpc/platforms/83xx/mpc836x_mds.c
* Unmerged path arch/powerpc/platforms/83xx/mpc836x_rdk.c
diff --git a/arch/powerpc/platforms/83xx/mpc837x_mds.c b/arch/powerpc/platforms/83xx/mpc837x_mds.c
index 3b34cc1f626c..5e41cfa1a53e 100644
--- a/arch/powerpc/platforms/83xx/mpc837x_mds.c
+++ b/arch/powerpc/platforms/83xx/mpc837x_mds.c
@@ -97,6 +97,7 @@ define_machine(mpc837x_mds) {
 	.name			= "MPC837x MDS",
 	.probe			= mpc837x_mds_probe,
 	.setup_arch		= mpc837x_mds_setup_arch,
+	.discover_phbs  	= mpc83xx_setup_pci,
 	.init_IRQ		= mpc83xx_ipic_init_IRQ,
 	.get_irq		= ipic_get_irq,
 	.restart		= mpc83xx_restart,
diff --git a/arch/powerpc/platforms/83xx/mpc837x_rdb.c b/arch/powerpc/platforms/83xx/mpc837x_rdb.c
index 0c55fa6af2d5..217609bad169 100644
--- a/arch/powerpc/platforms/83xx/mpc837x_rdb.c
+++ b/arch/powerpc/platforms/83xx/mpc837x_rdb.c
@@ -77,6 +77,7 @@ define_machine(mpc837x_rdb) {
 	.name			= "MPC837x RDB/WLAN",
 	.probe			= mpc837x_rdb_probe,
 	.setup_arch		= mpc837x_rdb_setup_arch,
+	.discover_phbs  	= mpc83xx_setup_pci,
 	.init_IRQ		= mpc83xx_ipic_init_IRQ,
 	.get_irq		= ipic_get_irq,
 	.restart		= mpc83xx_restart,
