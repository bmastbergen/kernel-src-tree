iommu/arm-smmu-v3: Add support for PCI PASID

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-326.el8
commit-author Jean-Philippe Brucker <jean-philippe@linaro.org>
commit 058c59a047d61601abf503563bbea818ee645c09
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-326.el8/058c59a0.failed

Enable PASID for PCI devices that support it. Initialize PASID early in
add_device() because it must be enabled before ATS.

	Tested-by: Zhangfei Gao <zhangfei.gao@linaro.org>
	Reviewed-by: Jonathan Cameron <Jonathan.Cameron@huawei.com>
	Signed-off-by: Jean-Philippe Brucker <jean-philippe@linaro.org>
	Signed-off-by: Will Deacon <will@kernel.org>
(cherry picked from commit 058c59a047d61601abf503563bbea818ee645c09)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/iommu/arm-smmu-v3.c
diff --cc drivers/iommu/arm-smmu-v3.c
index 04fd07a8d02d,6b76df37025e..000000000000
--- a/drivers/iommu/arm-smmu-v3.c
+++ b/drivers/iommu/arm-smmu-v3.c
@@@ -2910,15 -2892,30 +2967,35 @@@ static struct iommu_device *arm_smmu_pr
  		master->ssid_bits = min_t(u8, master->ssid_bits,
  					  CTXDESC_LINEAR_CDMAX);
  
++<<<<<<< HEAD
 +	return &smmu->iommu;
 +
++=======
+ 	ret = iommu_device_link(&smmu->iommu, dev);
+ 	if (ret)
+ 		goto err_disable_pasid;
+ 
+ 	group = iommu_group_get_for_dev(dev);
+ 	if (IS_ERR(group)) {
+ 		ret = PTR_ERR(group);
+ 		goto err_unlink;
+ 	}
+ 
+ 	iommu_group_put(group);
+ 	return 0;
+ 
+ err_unlink:
+ 	iommu_device_unlink(&smmu->iommu, dev);
+ err_disable_pasid:
+ 	arm_smmu_disable_pasid(master);
++>>>>>>> 058c59a047d6 (iommu/arm-smmu-v3: Add support for PCI PASID)
  err_free_master:
  	kfree(master);
 -	fwspec->iommu_priv = NULL;
 -	return ret;
 +	dev_iommu_priv_set(dev, NULL);
 +	return ERR_PTR(ret);
  }
  
 -static void arm_smmu_remove_device(struct device *dev)
 +static void arm_smmu_release_device(struct device *dev)
  {
  	struct iommu_fwspec *fwspec = dev_iommu_fwspec_get(dev);
  	struct arm_smmu_master *master;
@@@ -2926,8 -2924,12 +3003,14 @@@
  	if (!fwspec || fwspec->ops != &arm_smmu_ops)
  		return;
  
 -	master = fwspec->iommu_priv;
 -	smmu = master->smmu;
 +	master = dev_iommu_priv_get(dev);
  	arm_smmu_detach_dev(master);
++<<<<<<< HEAD
++=======
+ 	iommu_group_remove_device(dev);
+ 	iommu_device_unlink(&smmu->iommu, dev);
+ 	arm_smmu_disable_pasid(master);
++>>>>>>> 058c59a047d6 (iommu/arm-smmu-v3: Add support for PCI PASID)
  	kfree(master);
  	iommu_fwspec_free(dev);
  }
* Unmerged path drivers/iommu/arm-smmu-v3.c
