dma-iommu: implement ->alloc_noncontiguous

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-326.el8
commit-author Christoph Hellwig <hch@lst.de>
commit e817ee5f2f95ca58a3b961ae4acfd3885e830b9c
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-326.el8/e817ee5f.failed

Implement support for allocating a non-contiguous DMA region.

	Signed-off-by: Christoph Hellwig <hch@lst.de>
	Reviewed-by: Tomasz Figa <tfiga@chromium.org>
	Tested-by: Ricardo Ribalda <ribalda@chromium.org>
(cherry picked from commit e817ee5f2f95ca58a3b961ae4acfd3885e830b9c)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/iommu/dma-iommu.c
diff --cc drivers/iommu/dma-iommu.c
index fe135a263f73,1946422e4ac7..000000000000
--- a/drivers/iommu/dma-iommu.c
+++ b/drivers/iommu/dma-iommu.c
@@@ -711,6 -707,33 +711,36 @@@ static void *iommu_dma_alloc_remap(stru
  			< size)
  		goto out_free_sg;
  
++<<<<<<< HEAD
++=======
+ 	sgt->sgl->dma_address = iova;
+ 	sgt->sgl->dma_length = size;
+ 	return pages;
+ 
+ out_free_sg:
+ 	sg_free_table(sgt);
+ out_free_iova:
+ 	iommu_dma_free_iova(cookie, iova, size, NULL);
+ out_free_pages:
+ 	__iommu_dma_free_pages(pages, count);
+ 	return NULL;
+ }
+ 
+ static void *iommu_dma_alloc_remap(struct device *dev, size_t size,
+ 		dma_addr_t *dma_handle, gfp_t gfp, pgprot_t prot,
+ 		unsigned long attrs)
+ {
+ 	struct page **pages;
+ 	struct sg_table sgt;
+ 	void *vaddr;
+ 
+ 	pages = __iommu_dma_alloc_noncontiguous(dev, size, &sgt, gfp, prot,
+ 						attrs);
+ 	if (!pages)
+ 		return NULL;
+ 	*dma_handle = sgt.sgl->dma_address;
+ 	sg_free_table(&sgt);
++>>>>>>> e817ee5f2f95 (dma-iommu: implement ->alloc_noncontiguous)
  	vaddr = dma_common_pages_remap(pages, size, prot,
  			__builtin_return_address(0));
  	if (!vaddr)
@@@ -1236,6 -1284,19 +1297,15 @@@ static int iommu_dma_get_sgtable(struc
  static const struct dma_map_ops iommu_dma_ops = {
  	.alloc			= iommu_dma_alloc,
  	.free			= iommu_dma_free,
++<<<<<<< HEAD
++=======
+ 	.alloc_pages		= dma_common_alloc_pages,
+ 	.free_pages		= dma_common_free_pages,
+ #ifdef CONFIG_DMA_REMAP
+ 	.alloc_noncontiguous	= iommu_dma_alloc_noncontiguous,
+ 	.free_noncontiguous	= iommu_dma_free_noncontiguous,
+ #endif
++>>>>>>> e817ee5f2f95 (dma-iommu: implement ->alloc_noncontiguous)
  	.mmap			= iommu_dma_mmap,
  	.get_sgtable		= iommu_dma_get_sgtable,
  	.map_page		= iommu_dma_map_page,
* Unmerged path drivers/iommu/dma-iommu.c
