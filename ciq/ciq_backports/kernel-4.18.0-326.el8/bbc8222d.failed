net/mlx5: E-Switch, Read PF mac address

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-326.el8
commit-author Parav Pandit <parav@nvidia.com>
commit bbc8222dc49db8d49add0f27bcac33f4b92193dc
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-326.el8/bbc8222d.failed

External controller PF's MAC address is not read from the device during
vport setup. Fail to read this results in showing all zeros to user
while the factory programmed MAC is a valid value.

$ devlink port show eth1 -jp
{
    "port": {
        "pci/0000:03:00.0/196608": {
            "type": "eth",
            "netdev": "eth1",
            "flavour": "pcipf",
            "controller": 1,
            "pfnum": 0,
            "splittable": false,
            "function": {
                "hw_addr": "00:00:00:00:00:00"
            }
        }
    }
}

Hence, read it when enabling a vport.

After the fix,

$ devlink port show eth1 -jp
{
    "port": {
        "pci/0000:03:00.0/196608": {
            "type": "eth",
            "netdev": "eth1",
            "flavour": "pcipf",
            "controller": 1,
            "pfnum": 0,
            "splittable": false,
            "function": {
                "hw_addr": "98:03:9b:a0:60:11"
            }
        }
    }
}

Fixes: f099fde16db3 ("net/mlx5: E-switch, Support querying port function mac address")
	Signed-off-by: Bodong Wang <bodong@nvidia.com>
	Signed-off-by: Parav Pandit <parav@nvidia.com>
	Reviewed-by: Alaa Hleihel <alaa@nvidia.com>
	Signed-off-by: Saeed Mahameed <saeedm@nvidia.com>
(cherry picked from commit bbc8222dc49db8d49add0f27bcac33f4b92193dc)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlx5/core/eswitch.c
diff --cc drivers/net/ethernet/mellanox/mlx5/core/eswitch.c
index 9401dab3a137,97e6cb6f13c1..000000000000
--- a/drivers/net/ethernet/mellanox/mlx5/core/eswitch.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/eswitch.c
@@@ -1304,6 -1047,19 +1304,22 @@@ int mlx5_esw_vport_enable(struct mlx5_e
  	    (!vport_num && mlx5_core_is_ecpf(esw->dev)))
  		vport->info.trusted = true;
  
++<<<<<<< HEAD
++=======
+ 	if (!mlx5_esw_is_manager_vport(esw, vport->vport) &&
+ 	    MLX5_CAP_GEN(esw->dev, vhca_resource_manager)) {
+ 		ret = mlx5_esw_vport_vhca_id_set(esw, vport_num);
+ 		if (ret)
+ 			goto err_vhca_mapping;
+ 	}
+ 
+ 	/* External controller host PF has factory programmed MAC.
+ 	 * Read it from the device.
+ 	 */
+ 	if (mlx5_core_is_ecpf(esw->dev) && vport_num == MLX5_VPORT_PF)
+ 		mlx5_query_nic_vport_mac_address(esw->dev, vport_num, true, vport->info.mac);
+ 
++>>>>>>> bbc8222dc49d (net/mlx5: E-Switch, Read PF mac address)
  	esw_vport_change_handle_locked(vport);
  
  	esw->enabled_vports++;
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/eswitch.c
