r8152: Re-order napi_disable in rtl8152_close

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-326.el8
commit-author Prashant Malani <pmalani@chromium.org>
commit 84811412464d66fcf73661a279aa1d7985166495
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-326.el8/84811412.failed

Both rtl_work_func_t() and rtl8152_close() call napi_disable().
Since the two calls aren't protected by a lock, if the close
function starts executing before the work function, we can get into a
situation where the napi_disable() function is called twice in
succession (first by rtl8152_close(), then by set_carrier()).

In such a situation, the second call would loop indefinitely, since
rtl8152_close() doesn't call napi_enable() to clear the NAPI_STATE_SCHED
bit.

The rtl8152_close() function in turn issues a
cancel_delayed_work_sync(), and so it would wait indefinitely for the
rtl_work_func_t() to complete. Since rtl8152_close() is called by a
process holding rtnl_lock() which is requested by other processes, this
eventually leads to a system deadlock and crash.

Re-order the napi_disable() call to occur after the work function
disabling and urb cancellation calls are issued.

Change-Id: I6ef0b703fc214998a037a68f722f784e1d07815e
	Reported-by: http://crbug.com/1017928
	Signed-off-by: Prashant Malani <pmalani@chromium.org>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 84811412464d66fcf73661a279aa1d7985166495)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/usb/r8152.c
diff --cc drivers/net/usb/r8152.c
index eacec38c3c98,4d34c01826f3..000000000000
--- a/drivers/net/usb/r8152.c
+++ b/drivers/net/usb/r8152.c
@@@ -5248,7 -4282,7 +5248,11 @@@ static int rtl8152_close(struct net_dev
  #ifdef CONFIG_PM_SLEEP
  	unregister_pm_notifier(&tp->pm_notifier);
  #endif
++<<<<<<< HEAD
 +	napi_disable(&tp->napi);
++=======
+ 	tasklet_disable(&tp->tx_tl);
++>>>>>>> 84811412464d (r8152: Re-order napi_disable in rtl8152_close)
  	clear_bit(WORK_ENABLE, &tp->flags);
  	usb_kill_urb(tp->intr_urb);
  	cancel_delayed_work_sync(&tp->schedule);
* Unmerged path drivers/net/usb/r8152.c
