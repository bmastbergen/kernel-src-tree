cpupower: Update family checks when decoding HW pstates

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-326.el8
commit-author Nathan Fontenot <nathan.fontenot@amd.com>
commit 23765b82a808da416b70b41d711468e723531e6a
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-326.el8/23765b82.failed

The family checks in get_cof() and get_did() need to use the
correct MSR format depending on the family. Add a cpupower
capability for using the pstatedef (family 17h and newer) to
control this instead of direct family checks.

	Signed-off-by: Nathan Fontenot <nathan.fontenot@amd.com>
	Reviewed-by: Robert Richter <rrichter@amd.com>
	Signed-off-by: Shuah Khan <skhan@linuxfoundation.org>
(cherry picked from commit 23765b82a808da416b70b41d711468e723531e6a)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/power/cpupower/utils/helpers/amd.c
#	tools/power/cpupower/utils/helpers/cpuid.c
#	tools/power/cpupower/utils/helpers/helpers.h
diff --cc tools/power/cpupower/utils/helpers/amd.c
index 9607ada5b29a,b4731daa6820..000000000000
--- a/tools/power/cpupower/utils/helpers/amd.c
+++ b/tools/power/cpupower/utils/helpers/amd.c
@@@ -43,12 -45,12 +43,19 @@@ static int get_did(int family, union ms
  {
  	int t;
  
++<<<<<<< HEAD
 +	if (family == 0x12)
 +		t = pstate.val & 0xf;
 +	else if (family == 0x17)
 +		t = pstate.fam17h_bits.did;
++=======
+ 	if (cpupower_cpu_info.caps & CPUPOWER_CAP_AMD_PSTATEDEF)
+ 		t = pstate.pstatedef.did;
+ 	else if (family == 0x12)
+ 		t = pstate.val & 0xf;
++>>>>>>> 23765b82a808 (cpupower: Update family checks when decoding HW pstates)
  	else
 -		t = pstate.pstate.did;
 +		t = pstate.bits.did;
  
  	return t;
  }
@@@ -59,8 -61,8 +66,13 @@@ static int get_cof(int family, union ms
  	int fid, did, cof;
  
  	did = get_did(family, pstate);
++<<<<<<< HEAD
 +	if (family == 0x17) {
 +		fid = pstate.fam17h_bits.fid;
++=======
+ 	if (cpupower_cpu_info.caps & CPUPOWER_CAP_AMD_PSTATEDEF) {
+ 		fid = pstate.pstatedef.fid;
++>>>>>>> 23765b82a808 (cpupower: Update family checks when decoding HW pstates)
  		cof = 200 * fid / did;
  	} else {
  		t = 0x10;
diff --cc tools/power/cpupower/utils/helpers/cpuid.c
index 03b44a124d65,db2e88ceb67b..000000000000
--- a/tools/power/cpupower/utils/helpers/cpuid.c
+++ b/tools/power/cpupower/utils/helpers/cpuid.c
@@@ -124,11 -125,22 +124,30 @@@ out
  	if (cpuid_level >= 6 && (cpuid_ecx(6) & 0x1))
  		cpu_info->caps |= CPUPOWER_CAP_APERF;
  
++<<<<<<< HEAD
 +	/* AMD Boost state enable/disable register */
 +	if (cpu_info->vendor == X86_VENDOR_AMD) {
 +		if (ext_cpuid_level >= 0x80000007 &&
 +		    (cpuid_edx(0x80000007) & (1 << 9)))
 +			cpu_info->caps |= CPUPOWER_CAP_AMD_CPB;
++=======
+ 	/* AMD or Hygon Boost state enable/disable register */
+ 	if (cpu_info->vendor == X86_VENDOR_AMD ||
+ 	    cpu_info->vendor == X86_VENDOR_HYGON) {
+ 		if (ext_cpuid_level >= 0x80000007) {
+ 			if (cpuid_edx(0x80000007) & (1 << 9))
+ 				cpu_info->caps |= CPUPOWER_CAP_AMD_CPB;
+ 
+ 			if ((cpuid_edx(0x80000007) & (1 << 7)) &&
+ 			    cpu_info->family != 0x14) {
+ 				/* HW pstate was not implemented in family 0x14 */
+ 				cpu_info->caps |= CPUPOWER_CAP_AMD_HW_PSTATE;
+ 
+ 				if (cpu_info->family >= 0x17)
+ 					cpu_info->caps |= CPUPOWER_CAP_AMD_PSTATEDEF;
+ 			}
+ 		}
++>>>>>>> 23765b82a808 (cpupower: Update family checks when decoding HW pstates)
  
  		if (ext_cpuid_level >= 0x80000008 &&
  		    cpuid_ebx(0x80000008) & (1 << 4))
diff --cc tools/power/cpupower/utils/helpers/helpers.h
index 51ad213a4566,e4dc44ced770..000000000000
--- a/tools/power/cpupower/utils/helpers/helpers.h
+++ b/tools/power/cpupower/utils/helpers/helpers.h
@@@ -70,6 -70,8 +70,11 @@@ enum cpupower_cpu_vendor {X86_VENDOR_UN
  #define CPUPOWER_CAP_IS_SNB		0x00000020
  #define CPUPOWER_CAP_INTEL_IDA		0x00000040
  #define CPUPOWER_CAP_AMD_RDPRU		0x00000080
++<<<<<<< HEAD
++=======
+ #define CPUPOWER_CAP_AMD_HW_PSTATE	0x00000100
+ #define CPUPOWER_CAP_AMD_PSTATEDEF	0x00000200
++>>>>>>> 23765b82a808 (cpupower: Update family checks when decoding HW pstates)
  
  #define CPUPOWER_AMD_CPBDIS		0x02000000
  
* Unmerged path tools/power/cpupower/utils/helpers/amd.c
* Unmerged path tools/power/cpupower/utils/helpers/cpuid.c
* Unmerged path tools/power/cpupower/utils/helpers/helpers.h
