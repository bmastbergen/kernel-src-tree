ALSA: usb-audio: Add DJM450 to Pioneer format quirk

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-326.el8
commit-author Olivia Mackintosh <livvy@base.nu>
commit 3b85f5fc75d564a9eb4171dcb6b8687b080cd4d5
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-326.el8/3b85f5fc.failed

Like the DJM-750, ensure that the format control message is passed to
the device when opening a stream. It seems as though fmt->sync_ep is not
always set when this function is called hence the passing of the value
at the call site. If this can be fixed, fmt->sync_up should be used as
the wvalue.

There doesn't seem to be a "cpu_to_le24" type function defined hence for
the open code but I did see a similar thing done in Bluez lib. Perhaps
we can get these definitions defined in byteorder.h. See hci_cpu_to_le24
in include/net/bluetooth/hci.h:2543 for similar usage.

	Signed-off-by: Olivia Mackintosh <livvy@base.nu>
Link: https://lore.kernel.org/r/20210202134225.3217-2-livvy@base.nu
	Signed-off-by: Takashi Iwai <tiwai@suse.de>
(cherry picked from commit 3b85f5fc75d564a9eb4171dcb6b8687b080cd4d5)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	sound/usb/quirks.c
diff --cc sound/usb/quirks.c
index 581db82b9cb7,9ba4682ebc48..000000000000
--- a/sound/usb/quirks.c
+++ b/sound/usb/quirks.c
@@@ -1485,27 -1470,20 +1485,44 @@@ static void set_format_emu_quirk(struc
  	subs->pkt_offset_adj = (emu_samplerate_id >= EMU_QUIRK_SR_176400HZ) ? 4 : 0;
  }
  
++<<<<<<< HEAD
 +
 +/*
 + * Pioneer DJ DJM-900NXS2
 + * Device needs to know the sample rate each time substream is started
 + */
 +static int pioneer_djm_set_format_quirk(struct snd_usb_substream *subs)
 +{
 +
 +	/* Convert sample rate value to little endian */
 +	u8 sr[3];
 +
 +	sr[0] = subs->cur_rate & 0xff;
 +	sr[1] = (subs->cur_rate >> 8) & 0xff;
 +	sr[2] = (subs->cur_rate >> 16) & 0xff;
 +
 +	/* Configure device */
 +	usb_set_interface(subs->dev, 0, 1);
 +	snd_usb_ctl_msg(subs->stream->chip->dev,
 +		usb_rcvctrlpipe(subs->stream->chip->dev, 0),
 +		0x01, 0x22, 0x0100, 0x0082, &sr, 0x0003);
 +
++=======
+ static int pioneer_djm_set_format_quirk(struct snd_usb_substream *subs,
+ 					u16 windex)
+ {
+ 	unsigned int cur_rate = subs->data_endpoint->cur_rate;
+ 	u8 sr[3];
+ 	// Convert to little endian
+ 	sr[0] = cur_rate & 0xff;
+ 	sr[1] = (cur_rate >> 8) & 0xff;
+ 	sr[2] = (cur_rate >> 16) & 0xff;
+ 	usb_set_interface(subs->dev, 0, 1);
+ 	// we should derive windex from fmt-sync_ep but it's not set
+ 	snd_usb_ctl_msg(subs->stream->chip->dev,
+ 		usb_rcvctrlpipe(subs->stream->chip->dev, 0),
+ 		0x01, 0x22, 0x0100, windex, &sr, 0x0003);
++>>>>>>> 3b85f5fc75d5 (ALSA: usb-audio: Add DJM450 to Pioneer format quirk)
  	return 0;
  }
  
* Unmerged path sound/usb/quirks.c
