perf: Add build id data in mmap2 event

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-326.el8
commit-author Jiri Olsa <jolsa@kernel.org>
commit 88a16a1309333e43d328621ece3e9fa37027e8eb
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-326.el8/88a16a13.failed

Adding support to carry build id data in mmap2 event.

The build id data replaces maj/min/ino/ino_generation
fields, which are also used to identify map's binary,
so it's ok to replace them with build id data:

  union {
          struct {
                  u32       maj;
                  u32       min;
                  u64       ino;
                  u64       ino_generation;
          };
          struct {
                  u8        build_id_size;
                  u8        __reserved_1;
                  u16       __reserved_2;
                  u8        build_id[20];
          };
  };

Replaced maj/min/ino/ino_generation fields give us size
of 24 bytes. We use 20 bytes for build id data, 1 byte
for size and rest is unused.

There's new misc bit for mmap2 to signal there's build
id data in it:

  #define PERF_RECORD_MISC_MMAP_BUILD_ID   (1 << 14)

	Signed-off-by: Jiri Olsa <jolsa@kernel.org>
	Signed-off-by: Alexei Starovoitov <ast@kernel.org>
	Acked-by: Peter Zijlstra (Intel) <peterz@infradead.org>
Link: https://lore.kernel.org/bpf/20210114134044.1418404-4-jolsa@kernel.org
(cherry picked from commit 88a16a1309333e43d328621ece3e9fa37027e8eb)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	include/uapi/linux/perf_event.h
#	kernel/events/core.c
diff --cc include/uapi/linux/perf_event.h
index 72f783ce7bd8,cb6f84103560..000000000000
--- a/include/uapi/linux/perf_event.h
+++ b/include/uapi/linux/perf_event.h
@@@ -385,10 -386,8 +385,15 @@@ struct perf_event_attr 
  				aux_output     :  1, /* generate AUX records instead of events */
  				cgroup         :  1, /* include cgroup events */
  				text_poke      :  1, /* include text poke events */
++<<<<<<< HEAD
 +				__reserved_1   : 30;
 +#else
 +				__reserved_1   : 35;
 +#endif /*  __GENKSYMS__ */
++=======
+ 				build_id       :  1, /* use build id in mmap2 events */
+ 				__reserved_1   : 29;
++>>>>>>> 88a16a130933 (perf: Add build id data in mmap2 event)
  
  	union {
  		__u32		wakeup_events;	  /* wakeup every n events */
diff --cc kernel/events/core.c
index dfaf9a30d869,c37401e3e5f7..000000000000
--- a/kernel/events/core.c
+++ b/kernel/events/core.c
@@@ -50,6 -51,9 +50,12 @@@
  #include <linux/proc_ns.h>
  #include <linux/mount.h>
  #include <linux/min_heap.h>
++<<<<<<< HEAD
++=======
+ #include <linux/highmem.h>
+ #include <linux/pgtable.h>
+ #include <linux/buildid.h>
++>>>>>>> 88a16a130933 (perf: Add build id data in mmap2 event)
  
  #include "internal.h"
  
* Unmerged path include/uapi/linux/perf_event.h
* Unmerged path kernel/events/core.c
