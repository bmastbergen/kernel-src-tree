mm: slab: provide krealloc_array()

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-326.el8
commit-author Bartosz Golaszewski <bgolaszewski@baylibre.com>
commit f0dbd2bd1c22c6670e83ddcd46a9beb8b575e86d
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-326.el8/f0dbd2bd.failed

When allocating an array of elements, users should check for
multiplication overflow or preferably use one of the provided helpers
like: kmalloc_array().

There's no krealloc_array() counterpart but there are many users who use
regular krealloc() to reallocate arrays.  Let's provide an actual
krealloc_array() implementation.

While at it: add some documentation regarding krealloc.

Link: https://lkml.kernel.org/r/20201109110654.12547-3-brgl@bgdev.pl
	Signed-off-by: Bartosz Golaszewski <bgolaszewski@baylibre.com>
	Acked-by: Vlastimil Babka <vbabka@suse.cz>
	Cc: Alexander Shishkin <alexander.shishkin@linux.intel.com>
	Cc: Andy Shevchenko <andriy.shevchenko@linux.intel.com>
	Cc: Borislav Petkov <bp@alien8.de>
	Cc: Borislav Petkov <bp@suse.de>
	Cc: Christian Knig <christian.koenig@amd.com>
	Cc: Christoph Lameter <cl@linux.com>
	Cc: Daniel Vetter <daniel@ffwll.ch>
	Cc: Daniel Vetter <daniel.vetter@ffwll.ch>
	Cc: David Airlie <airlied@linux.ie>
	Cc: David Rientjes <rientjes@google.com>
	Cc: Gustavo Padovan <gustavo@padovan.org>
	Cc: James Morse <james.morse@arm.com>
	Cc: Jaroslav Kysela <perex@perex.cz>
	Cc: Jason Wang <jasowang@redhat.com>
	Cc: Joonsoo Kim <iamjoonsoo.kim@lge.com>
	Cc: Linus Walleij <linus.walleij@linaro.org>
	Cc: Maarten Lankhorst <maarten.lankhorst@linux.intel.com>
	Cc: Mauro Carvalho Chehab <mchehab@kernel.org>
	Cc: Maxime Ripard <mripard@kernel.org>
	Cc: "Michael S . Tsirkin" <mst@redhat.com>
	Cc: Pekka Enberg <penberg@kernel.org>
	Cc: Robert Richter <rric@kernel.org>
	Cc: Sumit Semwal <sumit.semwal@linaro.org>
	Cc: Takashi Iwai <tiwai@suse.com>
	Cc: Takashi Iwai <tiwai@suse.de>
	Cc: Thomas Zimmermann <tzimmermann@suse.de>
	Cc: Tony Luck <tony.luck@intel.com>
	Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
	Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
(cherry picked from commit f0dbd2bd1c22c6670e83ddcd46a9beb8b575e86d)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	Documentation/core-api/memory-allocation.rst
* Unmerged path Documentation/core-api/memory-allocation.rst
* Unmerged path Documentation/core-api/memory-allocation.rst
diff --git a/include/linux/slab.h b/include/linux/slab.h
index d6fd8adf3c89..a0c91c122060 100644
--- a/include/linux/slab.h
+++ b/include/linux/slab.h
@@ -596,6 +596,24 @@ static inline void *kmalloc_array(size_t n, size_t size, gfp_t flags)
 	return __kmalloc(bytes, flags);
 }
 
+/**
+ * krealloc_array - reallocate memory for an array.
+ * @p: pointer to the memory chunk to reallocate
+ * @new_n: new number of elements to alloc
+ * @new_size: new size of a single member of the array
+ * @flags: the type of memory to allocate (see kmalloc)
+ */
+static __must_check inline void *
+krealloc_array(void *p, size_t new_n, size_t new_size, gfp_t flags)
+{
+	size_t bytes;
+
+	if (unlikely(check_mul_overflow(new_n, new_size, &bytes)))
+		return NULL;
+
+	return krealloc(p, bytes, flags);
+}
+
 /**
  * kcalloc - allocate memory for an array. The memory is set to zero.
  * @n: number of elements.
