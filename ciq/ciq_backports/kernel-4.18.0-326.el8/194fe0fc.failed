ASoC: SOF: pci: move DSP_CONFIG use to platform-specific drivers

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-326.el8
commit-author Pierre-Louis Bossart <pierre-louis.bossart@linux.intel.com>
commit 194fe0fc3422d695a277cf9ccb39fa35c9c7d00a
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-326.el8/194fe0fc.failed

There is no reason why we should call the intel_dspcfg helpers from
common code, this should be moved in Intel-specific code and only
called from platforms where a conflict may occur with the HDaudio or
SST/Skylake driver.

	Suggested-by: Arnd Bergmann <arnd@arndb.de>
	Signed-off-by: Pierre-Louis Bossart <pierre-louis.bossart@linux.intel.com>
	Reviewed-by: Kai Vehmanen <kai.vehmanen@linux.intel.com>
	Reviewed-by: Guennadi Liakhovetski <guennadi.liakhovetski@linux.intel.com>
	Reviewed-by: Bard Liao <bard.liao@intel.com>
	Acked-by: Mark Brown <broonie@kernel.org>
	Acked-by: Vinod Koul <vkoul@kernel.org>
Link: https://lore.kernel.org/r/20210302003125.1178419-5-pierre-louis.bossart@linux.intel.com
	Signed-off-by: Takashi Iwai <tiwai@suse.de>
(cherry picked from commit 194fe0fc3422d695a277cf9ccb39fa35c9c7d00a)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	sound/soc/sof/intel/hda.c
#	sound/soc/sof/intel/pci-apl.c
#	sound/soc/sof/intel/pci-cnl.c
#	sound/soc/sof/intel/pci-icl.c
#	sound/soc/sof/intel/pci-tgl.c
diff --cc sound/soc/sof/intel/hda.c
index 3c3023948214,995a8c427177..000000000000
--- a/sound/soc/sof/intel/hda.c
+++ b/sound/soc/sof/intel/hda.c
@@@ -1258,4 -1260,23 +1260,26 @@@ void hda_machine_select(struct snd_sof_
  		dev_warn(sdev->dev, "warning: No matching ASoC machine driver found\n");
  }
  
+ int hda_pci_intel_probe(struct pci_dev *pci, const struct pci_device_id *pci_id)
+ {
+ 	int ret;
+ 
+ 	ret = snd_intel_dsp_driver_probe(pci);
+ 	if (ret != SND_INTEL_DSP_DRIVER_ANY && ret != SND_INTEL_DSP_DRIVER_SOF) {
+ 		dev_dbg(&pci->dev, "SOF PCI driver not selected, aborting probe\n");
+ 		return -ENODEV;
+ 	}
+ 
+ 	return sof_pci_probe(pci, pci_id);
+ }
+ EXPORT_SYMBOL_NS(hda_pci_intel_probe, SND_SOC_SOF_INTEL_HDA_COMMON);
+ 
  MODULE_LICENSE("Dual BSD/GPL");
++<<<<<<< HEAD
++=======
+ MODULE_IMPORT_NS(SND_SOC_SOF_PCI_DEV);
+ MODULE_IMPORT_NS(SND_SOC_SOF_HDA_AUDIO_CODEC);
+ MODULE_IMPORT_NS(SND_SOC_SOF_HDA_AUDIO_CODEC_I915);
+ MODULE_IMPORT_NS(SND_SOC_SOF_XTENSA);
+ MODULE_IMPORT_NS(SOUNDWIRE_INTEL_INIT);
++>>>>>>> 194fe0fc3422 (ASoC: SOF: pci: move DSP_CONFIG use to platform-specific drivers)
* Unmerged path sound/soc/sof/intel/pci-apl.c
* Unmerged path sound/soc/sof/intel/pci-cnl.c
* Unmerged path sound/soc/sof/intel/pci-icl.c
* Unmerged path sound/soc/sof/intel/pci-tgl.c
* Unmerged path sound/soc/sof/intel/hda.c
diff --git a/sound/soc/sof/intel/hda.h b/sound/soc/sof/intel/hda.h
index da83e7d958c5..9bfb13e35d4c 100644
--- a/sound/soc/sof/intel/hda.h
+++ b/sound/soc/sof/intel/hda.h
@@ -759,4 +759,7 @@ void hda_machine_select(struct snd_sof_dev *sdev);
 void hda_set_mach_params(const struct snd_soc_acpi_mach *mach,
 			 struct device *dev);
 
+/* PCI driver selection and probe */
+int hda_pci_intel_probe(struct pci_dev *pci, const struct pci_device_id *pci_id);
+
 #endif
* Unmerged path sound/soc/sof/intel/pci-apl.c
* Unmerged path sound/soc/sof/intel/pci-cnl.c
* Unmerged path sound/soc/sof/intel/pci-icl.c
* Unmerged path sound/soc/sof/intel/pci-tgl.c
diff --git a/sound/soc/sof/sof-pci-dev.c b/sound/soc/sof/sof-pci-dev.c
index 674071d01867..b74ecbc56325 100644
--- a/sound/soc/sof/sof-pci-dev.c
+++ b/sound/soc/sof/sof-pci-dev.c
@@ -13,7 +13,6 @@
 #include <linux/module.h>
 #include <linux/pci.h>
 #include <linux/pm_runtime.h>
-#include <sound/intel-dsp-config.h>
 #include <sound/soc-acpi.h>
 #include <sound/soc-acpi-intel-match.h>
 #include <sound/sof.h>
@@ -333,13 +332,6 @@ static int sof_pci_probe(struct pci_dev *pci,
 	const struct snd_sof_dsp_ops *ops;
 	int ret;
 
-	if (IS_REACHABLE(CONFIG_SND_INTEL_DSP_CONFIG)) {
-		ret = snd_intel_dsp_driver_probe(pci);
-		if (ret != SND_INTEL_DSP_DRIVER_ANY && ret != SND_INTEL_DSP_DRIVER_SOF) {
-			dev_dbg(&pci->dev, "SOF PCI driver not selected, aborting probe\n");
-			return -ENODEV;
-		}
-	}
 	dev_dbg(&pci->dev, "PCI DSP detected");
 
 	/* get ops for platform */
