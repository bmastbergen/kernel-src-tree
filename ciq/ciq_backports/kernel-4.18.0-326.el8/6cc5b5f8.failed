xfs: Refactor xfs_attr_try_sf_addname

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-326.el8
commit-author Allison Collins <allison.henderson@oracle.com>
commit 6cc5b5f89840cfe85cbd14e20500f25353a7f241
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-326.el8/6cc5b5f8.failed

To help pre-simplify xfs_attr_set_args, we need to hoist transaction
handling up, while modularizing the adjacent code down into helpers. In
this patch, hoist the commit in xfs_attr_try_sf_addname up into the
calling function, and also pull the attr list creation down.

	Signed-off-by: Allison Collins <allison.henderson@oracle.com>
	Reviewed-by: Darrick J. Wong <darrick.wong@oracle.com>
	Reviewed-by: Amir Goldstein <amir73il@gmail.com>
	Reviewed-by: Brian Foster <bfoster@redhat.com>
	Reviewed-by: Chandan Rajendra <chandanrlinux@gmail.com>
	Signed-off-by: Darrick J. Wong <darrick.wong@oracle.com>
	Acked-by: Dave Chinner <dchinner@redhat.com>
(cherry picked from commit 6cc5b5f89840cfe85cbd14e20500f25353a7f241)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/xfs/libxfs/xfs_attr.c
diff --cc fs/xfs/libxfs/xfs_attr.c
index fc6f3556f9cb,9e57409edc55..000000000000
--- a/fs/xfs/libxfs/xfs_attr.c
+++ b/fs/xfs/libxfs/xfs_attr.c
@@@ -212,17 -218,11 +215,20 @@@ xfs_attr_set_args
  	 * If the attribute list is non-existent or a shortform list,
  	 * upgrade it to a single-leaf-block attribute list.
  	 */
 -	if (dp->i_afp->if_format == XFS_DINODE_FMT_LOCAL ||
 -	    (dp->i_afp->if_format == XFS_DINODE_FMT_EXTENTS &&
 -	     dp->i_afp->if_nextents == 0)) {
 +	if (dp->i_d.di_aformat == XFS_DINODE_FMT_LOCAL ||
 +	    (dp->i_d.di_aformat == XFS_DINODE_FMT_EXTENTS &&
 +	     dp->i_d.di_anextents == 0)) {
  
  		/*
++<<<<<<< HEAD
 +		 * Build initial attribute list (if required).
 +		 */
 +		if (dp->i_d.di_aformat == XFS_DINODE_FMT_EXTENTS)
 +			xfs_attr_shortform_create(args);
 +
 +		/*
++=======
++>>>>>>> 6cc5b5f89840 (xfs: Refactor xfs_attr_try_sf_addname)
  		 * Try to add the attr to the attribute list in the inode.
  		 */
  		error = xfs_attr_try_sf_addname(dp, args);
* Unmerged path fs/xfs/libxfs/xfs_attr.c
