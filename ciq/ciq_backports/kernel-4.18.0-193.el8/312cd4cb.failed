NFS/flexfiles: Simplify ff_layout_get_ds_cred()

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-193.el8
commit-author Trond Myklebust <trond.myklebust@hammerspace.com>
commit 312cd4cb126a7936ad25306d14209fa6fd00f30a
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-193.el8/312cd4cb.failed

Pass in a pointer to the mirror rather than forcing another
array access.

	Signed-off-by: Trond Myklebust <trond.myklebust@hammerspace.com>
(cherry picked from commit 312cd4cb126a7936ad25306d14209fa6fd00f30a)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/nfs/flexfilelayout/flexfilelayout.h
#	fs/nfs/flexfilelayout/flexfilelayoutdev.c
diff --cc fs/nfs/flexfilelayout/flexfilelayout.h
index 2baeecfcf13c,e0b2c3deae5a..000000000000
--- a/fs/nfs/flexfilelayout/flexfilelayout.h
+++ b/fs/nfs/flexfilelayout/flexfilelayout.h
@@@ -214,12 -215,12 +214,18 @@@ nfs4_ff_layout_prepare_ds(struct pnfs_l
  			  bool fail_return);
  
  struct rpc_clnt *
 -nfs4_ff_find_or_create_ds_client(struct nfs4_ff_layout_mirror *mirror,
 +nfs4_ff_find_or_create_ds_client(struct pnfs_layout_segment *lseg,
 +				 u32 ds_idx,
  				 struct nfs_client *ds_clp,
  				 struct inode *inode);
++<<<<<<< HEAD
 +struct rpc_cred *ff_layout_get_ds_cred(struct pnfs_layout_segment *lseg,
 +				       u32 ds_idx, struct rpc_cred *mdscred);
++=======
+ const struct cred *ff_layout_get_ds_cred(struct nfs4_ff_layout_mirror *mirror,
+ 					 const struct pnfs_layout_range *range,
+ 					 const struct cred *mdscred);
++>>>>>>> 312cd4cb126a (NFS/flexfiles: Simplify ff_layout_get_ds_cred())
  bool ff_layout_avoid_mds_available_ds(struct pnfs_layout_segment *lseg);
  bool ff_layout_avoid_read_on_rw(struct pnfs_layout_segment *lseg);
  
diff --cc fs/nfs/flexfilelayout/flexfilelayoutdev.c
index 17fa3223959f,1673935074cc..000000000000
--- a/fs/nfs/flexfilelayout/flexfilelayoutdev.c
+++ b/fs/nfs/flexfilelayout/flexfilelayoutdev.c
@@@ -454,19 -445,19 +454,28 @@@ out
  	return ds;
  }
  
++<<<<<<< HEAD
 +struct rpc_cred *
 +ff_layout_get_ds_cred(struct pnfs_layout_segment *lseg, u32 ds_idx,
 +		      struct rpc_cred *mdscred)
 +{
 +	struct nfs4_ff_layout_mirror *mirror = FF_LAYOUT_COMP(lseg, ds_idx);
 +	struct rpc_cred *cred;
++=======
+ const struct cred *
+ ff_layout_get_ds_cred(struct nfs4_ff_layout_mirror *mirror,
+ 		      const struct pnfs_layout_range *range,
+ 		      const struct cred *mdscred)
+ {
+ 	const struct cred *cred;
++>>>>>>> 312cd4cb126a (NFS/flexfiles: Simplify ff_layout_get_ds_cred())
  
  	if (mirror && !mirror->mirror_ds->ds_versions[0].tightly_coupled) {
- 		cred = ff_layout_get_mirror_cred(mirror, lseg->pls_range.iomode);
+ 		cred = ff_layout_get_mirror_cred(mirror, range->iomode);
  		if (!cred)
 -			cred = get_cred(mdscred);
 +			cred = get_rpccred(mdscred);
  	} else {
 -		cred = get_cred(mdscred);
 +		cred = get_rpccred(mdscred);
  	}
  	return cred;
  }
diff --git a/fs/nfs/flexfilelayout/flexfilelayout.c b/fs/nfs/flexfilelayout/flexfilelayout.c
index e73fa899eaa9..5d1efe89208a 100644
--- a/fs/nfs/flexfilelayout/flexfilelayout.c
+++ b/fs/nfs/flexfilelayout/flexfilelayout.c
@@ -1737,7 +1737,7 @@ ff_layout_read_pagelist(struct nfs_pgio_header *hdr)
 	if (IS_ERR(ds_clnt))
 		goto out_failed;
 
-	ds_cred = ff_layout_get_ds_cred(lseg, idx, hdr->cred);
+	ds_cred = ff_layout_get_ds_cred(mirror, &lseg->pls_range, hdr->cred);
 	if (!ds_cred)
 		goto out_failed;
 
@@ -1800,7 +1800,7 @@ ff_layout_write_pagelist(struct nfs_pgio_header *hdr, int sync)
 	if (IS_ERR(ds_clnt))
 		goto out_failed;
 
-	ds_cred = ff_layout_get_ds_cred(lseg, idx, hdr->cred);
+	ds_cred = ff_layout_get_ds_cred(mirror, &lseg->pls_range, hdr->cred);
 	if (!ds_cred)
 		goto out_failed;
 
@@ -1883,7 +1883,7 @@ static int ff_layout_initiate_commit(struct nfs_commit_data *data, int how)
 	if (IS_ERR(ds_clnt))
 		goto out_err;
 
-	ds_cred = ff_layout_get_ds_cred(lseg, idx, data->cred);
+	ds_cred = ff_layout_get_ds_cred(mirror, &lseg->pls_range, data->cred);
 	if (!ds_cred)
 		goto out_err;
 
* Unmerged path fs/nfs/flexfilelayout/flexfilelayout.h
* Unmerged path fs/nfs/flexfilelayout/flexfilelayoutdev.c
