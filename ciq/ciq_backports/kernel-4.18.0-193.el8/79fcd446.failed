drm/amdgpu: Fix memory leak

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-193.el8
commit-author xinhui pan <xinhui.pan@amd.com>
commit 79fcd446e7e182c52c2c808c76f8de3eb6714349
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-193.el8/79fcd446.failed

drm_gem_object_put() should be paired with drm_gem_object_lookup().

All gem objs are saved in fb->base.obj[]. Need put the old first before
assign a new obj.

Trigger VRAM leak by running command below
$ service gdm restart

	Signed-off-by: xinhui pan <xinhui.pan@amd.com>
	Acked-by: Alex Deucher <alexander.deucher@amd.com>
	Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
(cherry picked from commit 79fcd446e7e182c52c2c808c76f8de3eb6714349)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/gpu/drm/amd/amdgpu/amdgpu_display.c
diff --cc drivers/gpu/drm/amd/amdgpu/amdgpu_display.c
index b083b219b1a9,b05301e1815c..000000000000
--- a/drivers/gpu/drm/amd/amdgpu/amdgpu_display.c
+++ b/drivers/gpu/drm/amd/amdgpu/amdgpu_display.c
@@@ -512,14 -925,41 +512,24 @@@ int amdgpu_display_framebuffer_init(str
  				    const struct drm_mode_fb_cmd2 *mode_cmd,
  				    struct drm_gem_object *obj)
  {
 -	int ret, i;
 -
 -	/*
 -	 * This needs to happen before modifier conversion as that might change
 -	 * the number of planes.
 -	 */
 -	for (i = 1; i < rfb->base.format->num_planes; ++i) {
 -		if (mode_cmd->handles[i] != mode_cmd->handles[0]) {
 -			drm_dbg_kms(dev, "Plane 0 and %d have different BOs: %u vs. %u\n",
 -				    i, mode_cmd->handles[0], mode_cmd->handles[i]);
 -			ret = -EINVAL;
 -			return ret;
 -		}
 -	}
 -
 -	ret = amdgpu_display_get_fb_info(rfb, &rfb->tiling_flags, &rfb->tmz_surface);
 -	if (ret)
 +	int ret;
 +	rfb->base.obj[0] = obj;
 +	drm_helper_mode_fill_fb_struct(dev, &rfb->base, mode_cmd);
 +	ret = drm_framebuffer_init(dev, &rfb->base, &amdgpu_fb_funcs);
 +	if (ret) {
 +		rfb->base.obj[0] = NULL;
  		return ret;
 -
 -	if (dev->mode_config.allow_fb_modifiers &&
 -	    !(rfb->base.flags & DRM_MODE_FB_MODIFIERS)) {
 -		ret = convert_tiling_flags_to_modifier(rfb);
 -		if (ret) {
 -			drm_dbg_kms(dev, "Failed to convert tiling flags 0x%llX to a modifier",
 -				    rfb->tiling_flags);
 -			return ret;
 -		}
  	}
++<<<<<<< HEAD
++=======
+ 
+ 	for (i = 1; i < rfb->base.format->num_planes; ++i) {
+ 		drm_gem_object_get(rfb->base.obj[0]);
+ 		drm_gem_object_put(rfb->base.obj[i]);
+ 		rfb->base.obj[i] = rfb->base.obj[0];
+ 	}
+ 
++>>>>>>> 79fcd446e7e1 (drm/amdgpu: Fix memory leak)
  	return 0;
  }
  
* Unmerged path drivers/gpu/drm/amd/amdgpu/amdgpu_display.c
