bnxt_en: Refactor logic to re-enable SRIOV after firmware reset detected.

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-193.el8
Rebuild_CHGLOG: - [netdrv] bnxt_en: Refactor logic to re-enable SRIOV after firmware reset detected (Jonathan Toppins) [1801868]
Rebuild_FUZZ: 99.31%
commit-author Michael Chan <michael.chan@broadcom.com>
commit c16d4ee0e397163fe7ceac281eaa952e63fadec7
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-193.el8/c16d4ee0.failed

Put the current logic in bnxt_open() to re-enable SRIOV after detecting
firmware reset into a new function bnxt_reenable_sriov().  This call
needs to be invoked in the firmware reset path also in the next patch.

	Signed-off-by: Michael Chan <michael.chan@broadcom.com>
	Signed-off-by: Jakub Kicinski <kuba@kernel.org>
(cherry picked from commit c16d4ee0e397163fe7ceac281eaa952e63fadec7)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/broadcom/bnxt/bnxt.c
diff --cc drivers/net/ethernet/broadcom/bnxt/bnxt.c
index 3fd9beafbaf6,0253a8f43ac8..000000000000
--- a/drivers/net/ethernet/broadcom/bnxt/bnxt.c
+++ b/drivers/net/ethernet/broadcom/bnxt/bnxt.c
@@@ -8790,12 -9257,25 +8801,23 @@@ static int bnxt_open(struct net_device 
  	struct bnxt *bp = netdev_priv(dev);
  	int rc;
  
 -	if (test_bit(BNXT_STATE_ABORT_ERR, &bp->state)) {
 -		netdev_err(bp->dev, "A previous firmware reset did not complete, aborting\n");
 -		return -ENODEV;
 -	}
 -
 -	rc = bnxt_hwrm_if_change(bp, true);
 -	if (rc)
 -		return rc;
 +	bnxt_hwrm_if_change(bp, true);
  	rc = __bnxt_open_nic(bp, true, true);
 -	if (rc) {
 +	if (rc)
  		bnxt_hwrm_if_change(bp, false);
++<<<<<<< HEAD
 +
 +	bnxt_hwmon_open(bp);
++=======
+ 	} else {
+ 		if (test_and_clear_bit(BNXT_STATE_FW_RESET_DET, &bp->state)) {
+ 			bnxt_reenable_sriov(bp);
+ 			if (!test_bit(BNXT_STATE_IN_FW_RESET, &bp->state))
+ 				bnxt_ulp_start(bp, 0);
+ 		}
+ 		bnxt_hwmon_open(bp);
+ 	}
++>>>>>>> c16d4ee0e397 (bnxt_en: Refactor logic to re-enable SRIOV after firmware reset detected.)
  
  	return rc;
  }
* Unmerged path drivers/net/ethernet/broadcom/bnxt/bnxt.c
