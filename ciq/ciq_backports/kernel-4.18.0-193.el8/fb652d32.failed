RDMA/mlx5: Remove VF representor profile

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-193.el8
commit-author Mark Bloch <markb@mellanox.com>
commit fb652d3299023c8fd1af13c9f897c3e3d8a424d3
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-193.el8/fb652d32.failed

Now that we have a single IB device with multiple ports we can remove the
VF representor profile.

	Signed-off-by: Mark Bloch <markb@mellanox.com>
	Signed-off-by: Leon Romanovsky <leonro@mellanox.com>
	Signed-off-by: Jason Gunthorpe <jgg@mellanox.com>
(cherry picked from commit fb652d3299023c8fd1af13c9f897c3e3d8a424d3)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/hw/mlx5/ib_rep.c
#	drivers/infiniband/hw/mlx5/main.c
diff --cc drivers/infiniband/hw/mlx5/ib_rep.c
index 95ac97af6166,cbcc40d776b9..000000000000
--- a/drivers/infiniband/hw/mlx5/ib_rep.c
+++ b/drivers/infiniband/hw/mlx5/ib_rep.c
@@@ -6,63 -6,23 +6,66 @@@
  #include "ib_rep.h"
  #include "srq.h"
  
++<<<<<<< HEAD
 +static const struct mlx5_ib_profile rep_profile = {
 +	STAGE_CREATE(MLX5_IB_STAGE_INIT,
 +		     mlx5_ib_stage_init_init,
 +		     mlx5_ib_stage_init_cleanup),
 +	STAGE_CREATE(MLX5_IB_STAGE_FLOW_DB,
 +		     mlx5_ib_stage_rep_flow_db_init,
 +		     NULL),
 +	STAGE_CREATE(MLX5_IB_STAGE_CAPS,
 +		     mlx5_ib_stage_caps_init,
 +		     NULL),
 +	STAGE_CREATE(MLX5_IB_STAGE_NON_DEFAULT_CB,
 +		     mlx5_ib_stage_rep_non_default_cb,
 +		     NULL),
 +	STAGE_CREATE(MLX5_IB_STAGE_ROCE,
 +		     mlx5_ib_stage_rep_roce_init,
 +		     mlx5_ib_stage_rep_roce_cleanup),
 +	STAGE_CREATE(MLX5_IB_STAGE_SRQ,
 +		     mlx5_init_srq_table,
 +		     mlx5_cleanup_srq_table),
 +	STAGE_CREATE(MLX5_IB_STAGE_DEVICE_RESOURCES,
 +		     mlx5_ib_stage_dev_res_init,
 +		     mlx5_ib_stage_dev_res_cleanup),
 +	STAGE_CREATE(MLX5_IB_STAGE_COUNTERS,
 +		     mlx5_ib_stage_counters_init,
 +		     mlx5_ib_stage_counters_cleanup),
 +	STAGE_CREATE(MLX5_IB_STAGE_BFREG,
 +		     mlx5_ib_stage_bfrag_init,
 +		     mlx5_ib_stage_bfrag_cleanup),
 +	STAGE_CREATE(MLX5_IB_STAGE_PRE_IB_REG_UMR,
 +		     NULL,
 +		     mlx5_ib_stage_pre_ib_reg_umr_cleanup),
 +	STAGE_CREATE(MLX5_IB_STAGE_IB_REG,
 +		     mlx5_ib_stage_ib_reg_init,
 +		     mlx5_ib_stage_ib_reg_cleanup),
 +	STAGE_CREATE(MLX5_IB_STAGE_POST_IB_REG_UMR,
 +		     mlx5_ib_stage_post_ib_reg_umr_init,
 +		     NULL),
 +};
 +
++=======
++>>>>>>> fb652d329902 (RDMA/mlx5: Remove VF representor profile)
  static int
 -mlx5_ib_set_vport_rep(struct mlx5_core_dev *dev, struct mlx5_eswitch_rep *rep)
 +mlx5_ib_nic_rep_load(struct mlx5_core_dev *dev, struct mlx5_eswitch_rep *rep)
  {
  	struct mlx5_ib_dev *ibdev;
 -	int vport_index;
  
 -	ibdev = mlx5_ib_get_uplink_ibdev(dev->priv.eswitch);
 -	vport_index = ibdev->free_port++;
 +	ibdev = mlx5_ib_rep_to_dev(rep);
 +	if (!__mlx5_ib_add(ibdev, ibdev->profile))
 +		return -EINVAL;
 +	return 0;
 +}
  
 -	ibdev->port[vport_index].rep = rep;
 -	write_lock(&ibdev->port[vport_index].roce.netdev_lock);
 -	ibdev->port[vport_index].roce.netdev =
 -		mlx5_ib_get_rep_netdev(dev->priv.eswitch, rep->vport);
 -	write_unlock(&ibdev->port[vport_index].roce.netdev_lock);
 +static void
 +mlx5_ib_nic_rep_unload(struct mlx5_eswitch_rep *rep)
 +{
 +	struct mlx5_ib_dev *ibdev;
  
 -	return 0;
 +	ibdev = mlx5_ib_rep_to_dev(rep);
 +	__mlx5_ib_remove(ibdev, ibdev->profile, MLX5_IB_STAGE_MAX);
  }
  
  static int
diff --cc drivers/infiniband/hw/mlx5/main.c
index 245cb37cd76b,a3248f6419a8..000000000000
--- a/drivers/infiniband/hw/mlx5/main.c
+++ b/drivers/infiniband/hw/mlx5/main.c
@@@ -5841,10 -5886,9 +5841,10 @@@ static void mlx5_ib_stage_init_cleanup(
  		srcu_barrier(&dev->mr_srcu);
  		cleanup_srcu_struct(&dev->mr_srcu);
  	}
 +	kfree(dev->port);
  }
  
- int mlx5_ib_stage_init_init(struct mlx5_ib_dev *dev)
+ static int mlx5_ib_stage_init_init(struct mlx5_ib_dev *dev)
  {
  	struct mlx5_core_dev *mdev = dev->mdev;
  	int err;
@@@ -6269,12 -6302,7 +6255,16 @@@ static const struct ib_device_ops mlx5_
  	.get_hw_stats = mlx5_ib_get_hw_stats,
  };
  
++<<<<<<< HEAD
 +static void mlx5_ib_stage_odp_cleanup(struct mlx5_ib_dev *dev)
 +{
 +	mlx5_ib_odp_cleanup_one(dev);
 +}
 +
 +int mlx5_ib_stage_counters_init(struct mlx5_ib_dev *dev)
++=======
+ static int mlx5_ib_stage_counters_init(struct mlx5_ib_dev *dev)
++>>>>>>> fb652d329902 (RDMA/mlx5: Remove VF representor profile)
  {
  	if (MLX5_CAP_GEN(dev->mdev, max_qp_cnt)) {
  		ib_set_device_ops(&dev->ib_dev, &mlx5_ib_dev_hw_stats_ops);
* Unmerged path drivers/infiniband/hw/mlx5/ib_rep.c
* Unmerged path drivers/infiniband/hw/mlx5/main.c
diff --git a/drivers/infiniband/hw/mlx5/mlx5_ib.h b/drivers/infiniband/hw/mlx5/mlx5_ib.h
index d77f0cb4a75e..41668d867b85 100644
--- a/drivers/infiniband/hw/mlx5/mlx5_ib.h
+++ b/drivers/infiniband/hw/mlx5/mlx5_ib.h
@@ -1231,23 +1231,6 @@ static inline void mlx5_ib_invalidate_range(struct ib_umem_odp *umem_odp,
 #endif /* CONFIG_INFINIBAND_ON_DEMAND_PAGING */
 
 /* Needed for rep profile */
-int mlx5_ib_stage_init_init(struct mlx5_ib_dev *dev);
-void mlx5_ib_stage_init_cleanup(struct mlx5_ib_dev *dev);
-int mlx5_ib_stage_rep_flow_db_init(struct mlx5_ib_dev *dev);
-int mlx5_ib_stage_caps_init(struct mlx5_ib_dev *dev);
-int mlx5_ib_stage_rep_non_default_cb(struct mlx5_ib_dev *dev);
-int mlx5_ib_stage_rep_roce_init(struct mlx5_ib_dev *dev);
-void mlx5_ib_stage_rep_roce_cleanup(struct mlx5_ib_dev *dev);
-int mlx5_ib_stage_dev_res_init(struct mlx5_ib_dev *dev);
-void mlx5_ib_stage_dev_res_cleanup(struct mlx5_ib_dev *dev);
-int mlx5_ib_stage_counters_init(struct mlx5_ib_dev *dev);
-void mlx5_ib_stage_counters_cleanup(struct mlx5_ib_dev *dev);
-int mlx5_ib_stage_bfrag_init(struct mlx5_ib_dev *dev);
-void mlx5_ib_stage_bfrag_cleanup(struct mlx5_ib_dev *dev);
-void mlx5_ib_stage_pre_ib_reg_umr_cleanup(struct mlx5_ib_dev *dev);
-int mlx5_ib_stage_ib_reg_init(struct mlx5_ib_dev *dev);
-void mlx5_ib_stage_ib_reg_cleanup(struct mlx5_ib_dev *dev);
-int mlx5_ib_stage_post_ib_reg_umr_init(struct mlx5_ib_dev *dev);
 void __mlx5_ib_remove(struct mlx5_ib_dev *dev,
 		      const struct mlx5_ib_profile *profile,
 		      int stage);
