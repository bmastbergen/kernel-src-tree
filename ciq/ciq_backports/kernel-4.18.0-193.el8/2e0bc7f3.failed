nfp: flower: encode mac indexes with pre-tunnel rule check

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-193.el8
commit-author John Hurley <john.hurley@netronome.com>
commit 2e0bc7f3cb5553812f5808ede2cea746aabfbd03
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-193.el8/2e0bc7f3.failed

When a tunnel packet arrives on the NFP card, its destination MAC is
looked up and MAC index returned for it. This index can help verify the
tunnel by, for example, ensuring that the packet arrived on the expected
port. If the packet is destined for a known MAC that is not connected to a
given physical port then the mac index can have a global value (e.g. when
a series of bonded ports shared the same MAC).

If the packet is to be detunneled at a bridge device or internal port like
an Open vSwitch VLAN port, then it should first match a 'pre-tunnel' rule
to direct it to that internal port.

Use the MAC index to indicate if a packet should match a pre-tunnel rule
before decap is allowed. Do this by tracking the number of internal ports
associated with a MAC address and, if the number if >0, set a bit in the
mac_index to forward the packet to the pre-tunnel table before continuing
with decap.

	Signed-off-by: John Hurley <john.hurley@netronome.com>
	Reviewed-by: Simon Horman <simon.horman@netronome.com>
	Acked-by: Jakub Kicinski <jakub.kicinski@netronome.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 2e0bc7f3cb5553812f5808ede2cea746aabfbd03)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/netronome/nfp/flower/tunnel_conf.c
diff --cc drivers/net/ethernet/netronome/nfp/flower/tunnel_conf.c
index 353833ffcf69,def8c198b016..000000000000
--- a/drivers/net/ethernet/netronome/nfp/flower/tunnel_conf.c
+++ b/drivers/net/ethernet/netronome/nfp/flower/tunnel_conf.c
@@@ -15,6 -15,24 +15,27 @@@
  
  #define NFP_FL_MAX_ROUTES               32
  
++<<<<<<< HEAD
++=======
+ #define NFP_TUN_PRE_TUN_RULE_LIMIT	32
+ #define NFP_TUN_PRE_TUN_RULE_DEL	0x1
+ #define NFP_TUN_PRE_TUN_IDX_BIT		0x8
+ 
+ /**
+  * struct nfp_tun_pre_run_rule - rule matched before decap
+  * @flags:		options for the rule offset
+  * @port_idx:		index of destination MAC address for the rule
+  * @vlan_tci:		VLAN info associated with MAC
+  * @host_ctx_id:	stats context of rule to update
+  */
+ struct nfp_tun_pre_tun_rule {
+ 	__be32 flags;
+ 	__be16 port_idx;
+ 	__be16 vlan_tci;
+ 	__be32 host_ctx_id;
+ };
+ 
++>>>>>>> 2e0bc7f3cb55 (nfp: flower: encode mac indexes with pre-tunnel rule check)
  /**
   * struct nfp_tun_active_tuns - periodic message of active tunnels
   * @seq:		sequence number of the message
* Unmerged path drivers/net/ethernet/netronome/nfp/flower/tunnel_conf.c
