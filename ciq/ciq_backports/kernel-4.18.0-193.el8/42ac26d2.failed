powerpc: add machine check safe copy_to_user

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-193.el8
commit-author Santosh Sivaraj <santosh@fossix.org>
commit 42ac26d253ebe7a5f409443f2fbd239d66b65f57
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-193.el8/42ac26d2.failed

Use  memcpy_mcsafe() implementation to define copy_to_user_mcsafe()

	Signed-off-by: Santosh Sivaraj <santosh@fossix.org>
	Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: https://lore.kernel.org/r/20190820081352.8641-8-santosh@fossix.org
(cherry picked from commit 42ac26d253ebe7a5f409443f2fbd239d66b65f57)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/powerpc/Kconfig
diff --cc arch/powerpc/Kconfig
index 40466f86cda5,78f52030e76a..000000000000
--- a/arch/powerpc/Kconfig
+++ b/arch/powerpc/Kconfig
@@@ -126,18 -125,22 +126,23 @@@ config PP
  	select ARCH_HAS_ELF_RANDOMIZE
  	select ARCH_HAS_FORTIFY_SOURCE
  	select ARCH_HAS_GCOV_PROFILE_ALL
 -	select ARCH_HAS_KCOV
 -	select ARCH_HAS_HUGEPD			if HUGETLB_PAGE
 -	select ARCH_HAS_MMIOWB			if PPC64
  	select ARCH_HAS_PHYS_TO_DMA
 -	select ARCH_HAS_PMEM_API
 -	select ARCH_HAS_PTE_DEVMAP		if PPC_BOOK3S_64
 +	select ARCH_HAS_PMEM_API                if PPC64
  	select ARCH_HAS_PTE_SPECIAL
  	select ARCH_HAS_MEMBARRIER_CALLBACKS
 -	select ARCH_HAS_SCALED_CPUTIME		if VIRT_CPU_ACCOUNTING_NATIVE && PPC64
 +	select ARCH_HAS_SCALED_CPUTIME		if VIRT_CPU_ACCOUNTING_NATIVE
 +	select ARCH_HAS_SG_CHAIN
  	select ARCH_HAS_STRICT_KERNEL_RWX	if ((PPC_BOOK3S_64 || PPC32) && !RELOCATABLE && !HIBERNATION)
  	select ARCH_HAS_TICK_BROADCAST		if GENERIC_CLOCKEVENTS_BROADCAST
++<<<<<<< HEAD
 +	select ARCH_HAS_UACCESS_FLUSHCACHE	if PPC64
++=======
+ 	select ARCH_HAS_UACCESS_FLUSHCACHE
+ 	select ARCH_HAS_UACCESS_MCSAFE		if PPC64
++>>>>>>> 42ac26d253eb (powerpc: add machine check safe copy_to_user)
  	select ARCH_HAS_UBSAN_SANITIZE_ALL
 +	select ARCH_HAS_ZONE_DEVICE		if PPC_BOOK3S_64
  	select ARCH_HAVE_NMI_SAFE_CMPXCHG
 -	select ARCH_KEEP_MEMBLOCK
  	select ARCH_MIGHT_HAVE_PC_PARPORT
  	select ARCH_MIGHT_HAVE_PC_SERIO
  	select ARCH_OPTIONAL_KERNEL_RWX		if ARCH_HAS_STRICT_KERNEL_RWX
* Unmerged path arch/powerpc/Kconfig
diff --git a/arch/powerpc/include/asm/uaccess.h b/arch/powerpc/include/asm/uaccess.h
index baeb6ac2c2b1..961ea1e25a54 100644
--- a/arch/powerpc/include/asm/uaccess.h
+++ b/arch/powerpc/include/asm/uaccess.h
@@ -363,6 +363,20 @@ static inline unsigned long raw_copy_to_user(void __user *to,
 	return __copy_tofrom_user(to, (__force const void __user *)from, n);
 }
 
+static __always_inline unsigned long __must_check
+copy_to_user_mcsafe(void __user *to, const void *from, unsigned long n)
+{
+	if (likely(check_copy_size(from, n, true))) {
+		if (access_ok(to, n)) {
+			allow_write_to_user(to, n);
+			n = memcpy_mcsafe((void *)to, from, n);
+			prevent_write_to_user(to, n);
+		}
+	}
+
+	return n;
+}
+
 extern unsigned long __clear_user(void __user *addr, unsigned long size);
 
 static inline unsigned long clear_user(void __user *addr, unsigned long size)
