RDMA/mlx5: Allow DEVX and raw creation flow on reps

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-193.el8
commit-author Mark Bloch <markb@mellanox.com>
commit 7f575103b04246246e76de4f182475174124dd03
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-193.el8/7f575103.failed

Remove the limitations that were in place and provide support for DEVX and
raw flow creation on reps.

	Signed-off-by: Mark Bloch <markb@mellanox.com>
	Reviewed-by: Maor Gottlieb <maorg@mellanox.com>
	Signed-off-by: Leon Romanovsky <leonro@mellanox.com>
	Signed-off-by: Jason Gunthorpe <jgg@mellanox.com>
(cherry picked from commit 7f575103b04246246e76de4f182475174124dd03)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/hw/mlx5/devx.c
#	drivers/infiniband/hw/mlx5/flow.c
diff --cc drivers/infiniband/hw/mlx5/devx.c
index 3b2ec02bb5ba,d627f44bc84d..000000000000
--- a/drivers/infiniband/hw/mlx5/devx.c
+++ b/drivers/infiniband/hw/mlx5/devx.c
@@@ -1717,7 -1906,7 +1717,11 @@@ static bool devx_is_supported(struct ib
  {
  	struct mlx5_ib_dev *dev = to_mdev(device);
  
++<<<<<<< HEAD
 +	return !dev->rep && MLX5_CAP_GEN(dev->mdev, log_max_uctx);
++=======
+ 	return MLX5_CAP_GEN(dev->mdev, log_max_uctx);
++>>>>>>> 7f575103b042 (RDMA/mlx5: Allow DEVX and raw creation flow on reps)
  }
  
  const struct uapi_definition mlx5_ib_devx_defs[] = {
diff --cc drivers/infiniband/hw/mlx5/flow.c
index ff89d4f5e84a,1fc302d41a53..000000000000
--- a/drivers/infiniband/hw/mlx5/flow.c
+++ b/drivers/infiniband/hw/mlx5/flow.c
@@@ -670,15 -670,9 +670,17 @@@ DECLARE_UVERBS_NAMED_OBJECT(MLX5_IB_OBJ
  			    &UVERBS_METHOD(MLX5_IB_METHOD_FLOW_MATCHER_CREATE),
  			    &UVERBS_METHOD(MLX5_IB_METHOD_FLOW_MATCHER_DESTROY));
  
++<<<<<<< HEAD
 +static bool flow_is_supported(struct ib_device *device)
 +{
 +	return !to_mdev(device)->rep;
 +}
 +
++=======
++>>>>>>> 7f575103b042 (RDMA/mlx5: Allow DEVX and raw creation flow on reps)
  const struct uapi_definition mlx5_ib_flow_defs[] = {
  	UAPI_DEF_CHAIN_OBJ_TREE_NAMED(
- 		MLX5_IB_OBJECT_FLOW_MATCHER,
- 		UAPI_DEF_IS_OBJ_SUPPORTED(flow_is_supported)),
+ 		MLX5_IB_OBJECT_FLOW_MATCHER),
  	UAPI_DEF_CHAIN_OBJ_TREE(
  		UVERBS_OBJECT_FLOW,
  		&mlx5_ib_fs),
* Unmerged path drivers/infiniband/hw/mlx5/devx.c
* Unmerged path drivers/infiniband/hw/mlx5/flow.c
diff --git a/drivers/infiniband/hw/mlx5/main.c b/drivers/infiniband/hw/mlx5/main.c
index 4d780fff17de..f5d5671c3180 100644
--- a/drivers/infiniband/hw/mlx5/main.c
+++ b/drivers/infiniband/hw/mlx5/main.c
@@ -6540,6 +6540,9 @@ static const struct mlx5_ib_profile nic_rep_profile = {
 	STAGE_CREATE(MLX5_IB_STAGE_PRE_IB_REG_UMR,
 		     NULL,
 		     mlx5_ib_stage_pre_ib_reg_umr_cleanup),
+	STAGE_CREATE(MLX5_IB_STAGE_WHITELIST_UID,
+		     mlx5_ib_stage_devx_init,
+		     mlx5_ib_stage_devx_cleanup),
 	STAGE_CREATE(MLX5_IB_STAGE_IB_REG,
 		     mlx5_ib_stage_ib_reg_init,
 		     mlx5_ib_stage_ib_reg_cleanup),
