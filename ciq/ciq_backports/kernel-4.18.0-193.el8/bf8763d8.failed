powerpc/iommu: Use device_iommu_mapped()

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-193.el8
commit-author Joerg Roedel <jroedel@suse.de>
commit bf8763d8f8376e98ea2a8e0fc4803f25ff91393e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-193.el8/bf8763d8.failed

Use the new function to replace the open-coded iommu check.

	Cc: Benjamin Herrenschmidt <benh@kernel.crashing.org>
	Cc: Paul Mackerras <paulus@samba.org>
	Cc: Russell Currey <ruscur@russell.cc>
	Cc: Sam Bobroff <sbobroff@linux.ibm.com>
	Acked-by: Robin Murphy <robin.murphy@arm.com>
	Signed-off-by: Joerg Roedel <jroedel@suse.de>
(cherry picked from commit bf8763d8f8376e98ea2a8e0fc4803f25ff91393e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/powerpc/kernel/iommu.c
diff --cc arch/powerpc/kernel/iommu.c
index 832e34da8440,48d58d1dcac2..000000000000
--- a/arch/powerpc/kernel/iommu.c
+++ b/arch/powerpc/kernel/iommu.c
@@@ -1118,4 -1138,31 +1118,34 @@@ void iommu_del_device(struct device *de
  	iommu_group_remove_device(dev);
  }
  EXPORT_SYMBOL_GPL(iommu_del_device);
++<<<<<<< HEAD
++=======
+ 
+ static int tce_iommu_bus_notifier(struct notifier_block *nb,
+                 unsigned long action, void *data)
+ {
+         struct device *dev = data;
+ 
+         switch (action) {
+         case BUS_NOTIFY_ADD_DEVICE:
+                 return iommu_add_device(dev);
+         case BUS_NOTIFY_DEL_DEVICE:
+                 if (device_iommu_mapped(dev))
+                         iommu_del_device(dev);
+                 return 0;
+         default:
+                 return 0;
+         }
+ }
+ 
+ static struct notifier_block tce_iommu_bus_nb = {
+         .notifier_call = tce_iommu_bus_notifier,
+ };
+ 
+ int __init tce_iommu_bus_notifier_init(void)
+ {
+         bus_register_notifier(&pci_bus_type, &tce_iommu_bus_nb);
+         return 0;
+ }
++>>>>>>> bf8763d8f837 (powerpc/iommu: Use device_iommu_mapped())
  #endif /* CONFIG_IOMMU_API */
diff --git a/arch/powerpc/kernel/eeh.c b/arch/powerpc/kernel/eeh.c
index 528caf857428..57d5c0668a4d 100644
--- a/arch/powerpc/kernel/eeh.c
+++ b/arch/powerpc/kernel/eeh.c
@@ -1499,7 +1499,7 @@ static int dev_has_iommu_table(struct device *dev, void *data)
 	if (!dev)
 		return 0;
 
-	if (dev->iommu_group) {
+	if (device_iommu_mapped(dev)) {
 		*ppdev = pdev;
 		return 1;
 	}
* Unmerged path arch/powerpc/kernel/iommu.c
