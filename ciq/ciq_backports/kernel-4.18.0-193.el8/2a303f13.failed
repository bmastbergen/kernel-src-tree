net/mlx5e: IPoIB, use separate stats groups

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-193.el8
commit-author Saeed Mahameed <saeedm@mellanox.com>
commit 2a303f13f9cda5a8f5729ccb84b211c1ef6bed92
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-193.el8/2a303f13.failed

Don't copy all of the stats groups used for mlx5e ethernet NIC profile,
have a separate stats groups for IPoIB with the set of the needed stats
only.

	Signed-off-by: Saeed Mahameed <saeedm@mellanox.com>
(cherry picked from commit 2a303f13f9cda5a8f5729ccb84b211c1ef6bed92)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlx5/core/en_stats.c
#	drivers/net/ethernet/mellanox/mlx5/core/ipoib/ipoib.c
diff --cc drivers/net/ethernet/mellanox/mlx5/core/en_stats.c
index f68b345df892,ee5041747575..000000000000
--- a/drivers/net/ethernet/mellanox/mlx5/core/en_stats.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/en_stats.c
@@@ -1519,104 -1698,46 +1519,126 @@@ static int mlx5e_grp_channels_fill_stat
  	return idx;
  }
  
++<<<<<<< HEAD
++=======
+ static MLX5E_DECLARE_STATS_GRP_OP_UPDATE_STATS(channels) { return; }
+ 
+ MLX5E_DEFINE_STATS_GRP(sw, 0);
+ MLX5E_DEFINE_STATS_GRP(qcnt, MLX5E_NDO_UPDATE_STATS);
+ MLX5E_DEFINE_STATS_GRP(vnic_env, 0);
+ MLX5E_DEFINE_STATS_GRP(vport, MLX5E_NDO_UPDATE_STATS);
+ MLX5E_DEFINE_STATS_GRP(802_3, MLX5E_NDO_UPDATE_STATS);
+ MLX5E_DEFINE_STATS_GRP(2863, 0);
+ MLX5E_DEFINE_STATS_GRP(2819, 0);
+ MLX5E_DEFINE_STATS_GRP(phy, 0);
+ MLX5E_DEFINE_STATS_GRP(pcie, 0);
+ MLX5E_DEFINE_STATS_GRP(per_prio, 0);
+ MLX5E_DEFINE_STATS_GRP(pme, 0);
+ MLX5E_DEFINE_STATS_GRP(channels, 0);
+ MLX5E_DEFINE_STATS_GRP(per_port_buff_congest, 0);
+ static MLX5E_DEFINE_STATS_GRP(eth_ext, 0);
+ static MLX5E_DEFINE_STATS_GRP(ipsec, 0);
+ static MLX5E_DEFINE_STATS_GRP(tls, 0);
+ 
++>>>>>>> 2a303f13f9cd (net/mlx5e: IPoIB, use separate stats groups)
  /* The stats groups order is opposite to the update_stats() order calls */
 -mlx5e_stats_grp_t mlx5e_nic_stats_grps[] = {
 -	&MLX5E_STATS_GRP(sw),
 -	&MLX5E_STATS_GRP(qcnt),
 -	&MLX5E_STATS_GRP(vnic_env),
 -	&MLX5E_STATS_GRP(vport),
 -	&MLX5E_STATS_GRP(802_3),
 -	&MLX5E_STATS_GRP(2863),
 -	&MLX5E_STATS_GRP(2819),
 -	&MLX5E_STATS_GRP(phy),
 -	&MLX5E_STATS_GRP(eth_ext),
 -	&MLX5E_STATS_GRP(pcie),
 -	&MLX5E_STATS_GRP(per_prio),
 -	&MLX5E_STATS_GRP(pme),
 -	&MLX5E_STATS_GRP(ipsec),
 -	&MLX5E_STATS_GRP(tls),
 -	&MLX5E_STATS_GRP(channels),
 -	&MLX5E_STATS_GRP(per_port_buff_congest),
 +const struct mlx5e_stats_grp mlx5e_stats_grps[] = {
 +	{
 +		.get_num_stats = mlx5e_grp_sw_get_num_stats,
 +		.fill_strings = mlx5e_grp_sw_fill_strings,
 +		.fill_stats = mlx5e_grp_sw_fill_stats,
 +		.update_stats = mlx5e_grp_sw_update_stats,
 +	},
 +	{
 +		.get_num_stats = mlx5e_grp_q_get_num_stats,
 +		.fill_strings = mlx5e_grp_q_fill_strings,
 +		.fill_stats = mlx5e_grp_q_fill_stats,
 +		.update_stats_mask = MLX5E_NDO_UPDATE_STATS,
 +		.update_stats = mlx5e_grp_q_update_stats,
 +	},
 +	{
 +		.get_num_stats = mlx5e_grp_vnic_env_get_num_stats,
 +		.fill_strings = mlx5e_grp_vnic_env_fill_strings,
 +		.fill_stats = mlx5e_grp_vnic_env_fill_stats,
 +		.update_stats = mlx5e_grp_vnic_env_update_stats,
 +	},
 +	{
 +		.get_num_stats = mlx5e_grp_vport_get_num_stats,
 +		.fill_strings = mlx5e_grp_vport_fill_strings,
 +		.fill_stats = mlx5e_grp_vport_fill_stats,
 +		.update_stats_mask = MLX5E_NDO_UPDATE_STATS,
 +		.update_stats = mlx5e_grp_vport_update_stats,
 +	},
 +	{
 +		.get_num_stats = mlx5e_grp_802_3_get_num_stats,
 +		.fill_strings = mlx5e_grp_802_3_fill_strings,
 +		.fill_stats = mlx5e_grp_802_3_fill_stats,
 +		.update_stats_mask = MLX5E_NDO_UPDATE_STATS,
 +		.update_stats = mlx5e_grp_802_3_update_stats,
 +	},
 +	{
 +		.get_num_stats = mlx5e_grp_2863_get_num_stats,
 +		.fill_strings = mlx5e_grp_2863_fill_strings,
 +		.fill_stats = mlx5e_grp_2863_fill_stats,
 +		.update_stats = mlx5e_grp_2863_update_stats,
 +	},
 +	{
 +		.get_num_stats = mlx5e_grp_2819_get_num_stats,
 +		.fill_strings = mlx5e_grp_2819_fill_strings,
 +		.fill_stats = mlx5e_grp_2819_fill_stats,
 +		.update_stats = mlx5e_grp_2819_update_stats,
 +	},
 +	{
 +		.get_num_stats = mlx5e_grp_phy_get_num_stats,
 +		.fill_strings = mlx5e_grp_phy_fill_strings,
 +		.fill_stats = mlx5e_grp_phy_fill_stats,
 +		.update_stats = mlx5e_grp_phy_update_stats,
 +	},
 +	{
 +		.get_num_stats = mlx5e_grp_eth_ext_get_num_stats,
 +		.fill_strings = mlx5e_grp_eth_ext_fill_strings,
 +		.fill_stats = mlx5e_grp_eth_ext_fill_stats,
 +		.update_stats = mlx5e_grp_eth_ext_update_stats,
 +	},
 +	{
 +		.get_num_stats = mlx5e_grp_pcie_get_num_stats,
 +		.fill_strings = mlx5e_grp_pcie_fill_strings,
 +		.fill_stats = mlx5e_grp_pcie_fill_stats,
 +		.update_stats = mlx5e_grp_pcie_update_stats,
 +	},
 +	{
 +		.get_num_stats = mlx5e_grp_per_prio_get_num_stats,
 +		.fill_strings = mlx5e_grp_per_prio_fill_strings,
 +		.fill_stats = mlx5e_grp_per_prio_fill_stats,
 +		.update_stats = mlx5e_grp_per_prio_update_stats,
 +	},
 +	{
 +		.get_num_stats = mlx5e_grp_pme_get_num_stats,
 +		.fill_strings = mlx5e_grp_pme_fill_strings,
 +		.fill_stats = mlx5e_grp_pme_fill_stats,
 +	},
 +	{
 +		.get_num_stats = mlx5e_grp_ipsec_get_num_stats,
 +		.fill_strings = mlx5e_grp_ipsec_fill_strings,
 +		.fill_stats = mlx5e_grp_ipsec_fill_stats,
 +		.update_stats = mlx5e_grp_ipsec_update_stats,
 +	},
 +	{
 +		.get_num_stats = mlx5e_grp_tls_get_num_stats,
 +		.fill_strings = mlx5e_grp_tls_fill_strings,
 +		.fill_stats = mlx5e_grp_tls_fill_stats,
 +	},
 +	{
 +		.get_num_stats = mlx5e_grp_channels_get_num_stats,
 +		.fill_strings = mlx5e_grp_channels_fill_strings,
 +		.fill_stats = mlx5e_grp_channels_fill_stats,
 +	},
 +	{
 +		.get_num_stats = mlx5e_grp_per_port_buffer_congest_get_num_stats,
 +		.fill_strings = mlx5e_grp_per_port_buffer_congest_fill_strings,
 +		.fill_stats = mlx5e_grp_per_port_buffer_congest_fill_stats,
 +		.update_stats = mlx5e_grp_per_port_buffer_congest_update_stats,
 +	},
  };
  
 -unsigned int mlx5e_nic_stats_grps_num(struct mlx5e_priv *priv)
 -{
 -	return ARRAY_SIZE(mlx5e_nic_stats_grps);
 -}
 +const int mlx5e_num_stats_grps = ARRAY_SIZE(mlx5e_stats_grps);
diff --cc drivers/net/ethernet/mellanox/mlx5/core/ipoib/ipoib.c
index e01a916f296c,56078b23f1a0..000000000000
--- a/drivers/net/ethernet/mellanox/mlx5/core/ipoib/ipoib.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/ipoib/ipoib.c
@@@ -435,6 -456,9 +457,12 @@@ static const struct mlx5e_profile mlx5i
  	.rx_handlers.handle_rx_cqe       = mlx5i_handle_rx_cqe,
  	.rx_handlers.handle_rx_cqe_mpwqe = NULL, /* Not supported */
  	.max_tc		   = MLX5I_MAX_NUM_TC,
++<<<<<<< HEAD
++=======
+ 	.rq_groups	   = MLX5E_NUM_RQ_GROUPS(REGULAR),
+ 	.stats_grps        = mlx5i_stats_grps,
+ 	.stats_grps_num    = mlx5i_stats_grps_num,
++>>>>>>> 2a303f13f9cd (net/mlx5e: IPoIB, use separate stats groups)
  };
  
  /* mlx5i netdev NDos */
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/en_stats.c
diff --git a/drivers/net/ethernet/mellanox/mlx5/core/en_stats.h b/drivers/net/ethernet/mellanox/mlx5/core/en_stats.h
index 1e151c97c07b..784e36d6f63f 100644
--- a/drivers/net/ethernet/mellanox/mlx5/core/en_stats.h
+++ b/drivers/net/ethernet/mellanox/mlx5/core/en_stats.h
@@ -289,4 +289,18 @@ extern const int mlx5e_num_stats_grps;
 
 void mlx5e_grp_802_3_update_stats(struct mlx5e_priv *priv);
 
+extern MLX5E_DECLARE_STATS_GRP(sw);
+extern MLX5E_DECLARE_STATS_GRP(qcnt);
+extern MLX5E_DECLARE_STATS_GRP(vnic_env);
+extern MLX5E_DECLARE_STATS_GRP(vport);
+extern MLX5E_DECLARE_STATS_GRP(802_3);
+extern MLX5E_DECLARE_STATS_GRP(2863);
+extern MLX5E_DECLARE_STATS_GRP(2819);
+extern MLX5E_DECLARE_STATS_GRP(phy);
+extern MLX5E_DECLARE_STATS_GRP(pcie);
+extern MLX5E_DECLARE_STATS_GRP(per_prio);
+extern MLX5E_DECLARE_STATS_GRP(pme);
+extern MLX5E_DECLARE_STATS_GRP(channels);
+extern MLX5E_DECLARE_STATS_GRP(per_port_buff_congest);
+
 #endif /* __MLX5_EN_STATS_H__ */
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/ipoib/ipoib.c
