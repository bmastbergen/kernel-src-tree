RDMA: Fix double-free in srq creation error flow

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-193.el8
commit-author Jack Morgenstein <jackm@dev.mellanox.co.il>
commit 3eca7fc2d8d1275d9cf0c709f0937becbfcf6d96
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-193.el8/3eca7fc2.failed

The cited commit introduced a double-free of the srq buffer in the error
flow of procedure __uverbs_create_xsrq().

The problem is that ib_destroy_srq_user() called in the error flow also
frees the srq buffer.

Thus, if uverbs_response() fails in __uverbs_create_srq(), the srq buffer
will be freed twice.

	Cc: <stable@vger.kernel.org>
Fixes: 68e326dea1db ("RDMA: Handle SRQ allocations by IB/core")
Link: https://lore.kernel.org/r/20190916071154.20383-5-leon@kernel.org
	Signed-off-by: Jack Morgenstein <jackm@dev.mellanox.co.il>
	Signed-off-by: Leon Romanovsky <leonro@mellanox.com>
	Reviewed-by: Jason Gunthorpe <jgg@mellanox.com>
	Signed-off-by: Jason Gunthorpe <jgg@mellanox.com>
(cherry picked from commit 3eca7fc2d8d1275d9cf0c709f0937becbfcf6d96)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/core/uverbs_cmd.c
diff --cc drivers/infiniband/core/uverbs_cmd.c
index dc12bbe9281b,13af88da5f79..000000000000
--- a/drivers/infiniband/core/uverbs_cmd.c
+++ b/drivers/infiniband/core/uverbs_cmd.c
@@@ -3449,11 -3478,14 +3449,19 @@@ static int __uverbs_create_xsrq(struct 
  		uobj_put_obj_read(attr.ext.cq);
  
  	uobj_put_obj_read(pd);
 -	return uobj_alloc_commit(&obj->uevent.uobject, attrs);
 +	return uobj_alloc_commit(&obj->uevent.uobject);
  
  err_copy:
++<<<<<<< HEAD
 +	ib_destroy_srq(srq);
 +
++=======
+ 	ib_destroy_srq_user(srq, uverbs_get_cleared_udata(attrs));
+ 	/* It was released in ib_destroy_srq_user */
+ 	srq = NULL;
+ err_free:
+ 	kfree(srq);
++>>>>>>> 3eca7fc2d8d1 (RDMA: Fix double-free in srq creation error flow)
  err_put:
  	uobj_put_obj_read(pd);
  
* Unmerged path drivers/infiniband/core/uverbs_cmd.c
