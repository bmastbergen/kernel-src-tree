RDMA/counter: Allow manual mode configuration support

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-193.el8
commit-author Mark Zhang <markz@mellanox.com>
commit 1bd8e0a9d0fd1be03d2833a0c15ac676bdf275d8
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-193.el8/1bd8e0a9.failed

In manual mode a QP is bound to a counter manually. If counter is not
specified then a new one will be allocated.

Manual mode is enabled when user binds a QP, and disabled when the last
manually bound QP is unbound.

When auto-mode is turned off and there are counters left, manual mode is
enabled so that the user is able to access these counters.

	Signed-off-by: Mark Zhang <markz@mellanox.com>
	Reviewed-by: Majd Dibbiny <majd@mellanox.com>
	Signed-off-by: Leon Romanovsky <leonro@mellanox.com>
	Signed-off-by: Jason Gunthorpe <jgg@mellanox.com>
(cherry picked from commit 1bd8e0a9d0fd1be03d2833a0c15ac676bdf275d8)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/core/counters.c
#	include/rdma/rdma_counter.h
#	include/uapi/rdma/rdma_netlink.h
diff --cc include/uapi/rdma/rdma_netlink.h
index 213452ef94a5,ec86fab3d040..000000000000
--- a/include/uapi/rdma/rdma_netlink.h
+++ b/include/uapi/rdma/rdma_netlink.h
@@@ -462,4 -523,36 +462,39 @@@ enum rdma_nldev_attr 
  	 */
  	RDMA_NLDEV_ATTR_MAX
  };
++<<<<<<< HEAD
++=======
+ 
+ /*
+  * Supported counter bind modes. All modes are mutual-exclusive.
+  */
+ enum rdma_nl_counter_mode {
+ 	RDMA_COUNTER_MODE_NONE,
+ 
+ 	/*
+ 	 * A qp is bound with a counter automatically during initialization
+ 	 * based on the auto mode (e.g., qp type, ...)
+ 	 */
+ 	RDMA_COUNTER_MODE_AUTO,
+ 
+ 	/*
+ 	 * Which qp are bound with which counter is explicitly specified
+ 	 * by the user
+ 	 */
+ 	RDMA_COUNTER_MODE_MANUAL,
+ 
+ 	/*
+ 	 * Always the end
+ 	 */
+ 	RDMA_COUNTER_MODE_MAX,
+ };
+ 
+ /*
+  * Supported criteria in counter auto mode.
+  * Currently only "qp type" is supported
+  */
+ enum rdma_nl_counter_mask {
+ 	RDMA_COUNTER_MASK_QP_TYPE = 1,
+ };
++>>>>>>> 1bd8e0a9d0fd (RDMA/counter: Allow manual mode configuration support)
  #endif /* _UAPI_RDMA_NETLINK_H */
* Unmerged path drivers/infiniband/core/counters.c
* Unmerged path include/rdma/rdma_counter.h
* Unmerged path drivers/infiniband/core/counters.c
* Unmerged path include/rdma/rdma_counter.h
* Unmerged path include/uapi/rdma/rdma_netlink.h
