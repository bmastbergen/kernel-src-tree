netfilter: conntrack: fix removal of conntrack entries when l4tracker is removed

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-193.el8
commit-author Florian Westphal <fw@strlen.de>
commit 1c117d3b721a2678020d522ff1bf33984d4f0a5a
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-193.el8/1c117d3b.failed

nf_ct_l4proto_unregister_one() leaves conntracks added by
to-be-removed tracker behind, nf_ct_l4proto_unregister has to iterate
for each protocol to be removed.

v2: call nf_ct_iterate_destroy without holding nf_ct_proto_mutex.

Fixes: 2c41f33c1b703 ("netfilter: move table iteration out of netns exit paths")
	Signed-off-by: Florian Westphal <fw@strlen.de>
	Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
(cherry picked from commit 1c117d3b721a2678020d522ff1bf33984d4f0a5a)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/netfilter/nf_conntrack_proto.c
diff --cc net/netfilter/nf_conntrack_proto.c
index d5bded366ff5,9f14b0df6960..000000000000
--- a/net/netfilter/nf_conntrack_proto.c
+++ b/net/netfilter/nf_conntrack_proto.c
@@@ -499,8 -331,26 +501,31 @@@ void nf_ct_l4proto_pernet_unregister_on
  }
  EXPORT_SYMBOL_GPL(nf_ct_l4proto_pernet_unregister_one);
  
++<<<<<<< HEAD
 +int nf_ct_l4proto_register(const struct nf_conntrack_l4proto * const l4proto[],
 +			   unsigned int num_proto)
++=======
+ static void
+ nf_ct_l4proto_unregister(const struct nf_conntrack_l4proto * const l4proto[],
+ 			 unsigned int num_proto)
+ {
+ 	int i;
+ 
+ 	mutex_lock(&nf_ct_proto_mutex);
+ 	for (i = 0; i < num_proto; i++)
+ 		__nf_ct_l4proto_unregister_one(l4proto[i]);
+ 	mutex_unlock(&nf_ct_proto_mutex);
+ 
+ 	synchronize_net();
+ 
+ 	for (i = 0; i < num_proto; i++)
+ 		nf_ct_iterate_destroy(kill_l4proto, (void *)l4proto[i]);
+ }
+ 
+ static int
+ nf_ct_l4proto_register(const struct nf_conntrack_l4proto * const l4proto[],
+ 		       unsigned int num_proto)
++>>>>>>> 1c117d3b721a (netfilter: conntrack: fix removal of conntrack entries when l4tracker is removed)
  {
  	int ret = -EINVAL, ver;
  	unsigned int i;
* Unmerged path net/netfilter/nf_conntrack_proto.c
