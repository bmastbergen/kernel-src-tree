x86/tsc: Use TSC as sched clock early

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-193.el8
Rebuild_CHGLOG: - [x86] tsc: Use TSC as sched clock early (Al Stone) [1739729 1725581]
Rebuild_FUZZ: 94.29%
commit-author Pavel Tatashin <pasha.tatashin@oracle.com>
commit 4763f03d3d186ce8a1125844790152d76804ad60
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-193.el8/4763f03d.failed

All prerequesites for enabling TSC as sched clock early in the boot
process are available now:

 - Early attempt of TSC calibration

 - Early availablity of static branch patching

If TSC frequency can be established in the early calibration, enable the
static key which switches sched clock to use TSC.

[ tglx: Massaged changelog ]

	Signed-off-by: Pavel Tatashin <pasha.tatashin@oracle.com>
	Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
	Cc: steven.sistare@oracle.com
	Cc: daniel.m.jordan@oracle.com
	Cc: linux@armlinux.org.uk
	Cc: schwidefsky@de.ibm.com
	Cc: heiko.carstens@de.ibm.com
	Cc: john.stultz@linaro.org
	Cc: sboyd@codeaurora.org
	Cc: hpa@zytor.com
	Cc: douly.fnst@cn.fujitsu.com
	Cc: peterz@infradead.org
	Cc: prarit@redhat.com
	Cc: feng.tang@intel.com
	Cc: pmladek@suse.com
	Cc: gnomes@lxorguk.ukuu.org.uk
	Cc: linux-s390@vger.kernel.org
	Cc: boris.ostrovsky@oracle.com
	Cc: jgross@suse.com
	Cc: pbonzini@redhat.com
Link: https://lkml.kernel.org/r/20180719205545.16512-22-pasha.tatashin@oracle.com

(cherry picked from commit 4763f03d3d186ce8a1125844790152d76804ad60)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kernel/tsc.c
diff --cc arch/x86/kernel/tsc.c
index d8de174f9493,9277ae9b68b3..000000000000
--- a/arch/x86/kernel/tsc.c
+++ b/arch/x86/kernel/tsc.c
@@@ -1390,6 -1404,11 +1390,14 @@@ void __init tsc_early_init(void
  	if (!determine_cpu_tsc_frequencies())
  		return;
  	loops_per_jiffy = get_loops_per_jiffy();
++<<<<<<< HEAD
++=======
+ 
+ 	/* Sanitize TSC ADJUST before cyc2ns gets initialized */
+ 	tsc_store_and_check_tsc_adjust(true);
+ 	cyc2ns_init_boot_cpu();
+ 	static_branch_enable(&__use_tsc);
++>>>>>>> 4763f03d3d18 (x86/tsc: Use TSC as sched clock early)
  }
  
  void __init tsc_init(void)
* Unmerged path arch/x86/kernel/tsc.c
