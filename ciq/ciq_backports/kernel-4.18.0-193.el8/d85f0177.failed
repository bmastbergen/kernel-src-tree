net: tls, fix sk_write_space NULL write when tx disabled

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-193.el8
Rebuild_CHGLOG: - [net] tls, fix sk_write_space NULL write when tx disabled (Sabrina Dubroca) [1760375]
Rebuild_FUZZ: 95.33%
commit-author John Fastabend <john.fastabend@gmail.com>
commit d85f01775850a35eae47a0090839baf510c1ef12
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-193.el8/d85f0177.failed

The ctx->sk_write_space pointer is only set when TLS tx mode is enabled.
When running without TX mode its a null pointer but we still set the
sk sk_write_space pointer on close().

Fix the close path to only overwrite sk->sk_write_space when the current
pointer is to the tls_write_space function indicating the tls module should
clean it up properly as well.

	Reported-by: Hillf Danton <hdanton@sina.com>
	Cc: Ying Xue <ying.xue@windriver.com>
	Cc: Andrey Konovalov <andreyknvl@google.com>
Fixes: 57c722e932cfb ("net/tls: swap sk_write_space on close")
	Signed-off-by: John Fastabend <john.fastabend@gmail.com>
	Reviewed-by: Jakub Kicinski <jakub.kicinski@netronome.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit d85f01775850a35eae47a0090839baf510c1ef12)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/tls/tls_main.c
diff --cc net/tls/tls_main.c
index 797e39e87f9c,43252a801c3f..000000000000
--- a/net/tls/tls_main.c
+++ b/net/tls/tls_main.c
@@@ -305,6 -304,13 +305,16 @@@ static void tls_sk_proto_close(struct s
  	if (ctx->tx_conf != TLS_BASE || ctx->rx_conf != TLS_BASE)
  		tls_sk_proto_cleanup(sk, ctx, timeo);
  
++<<<<<<< HEAD
++=======
+ 	write_lock_bh(&sk->sk_callback_lock);
+ 	if (free_ctx)
+ 		icsk->icsk_ulp_data = NULL;
+ 	sk->sk_prot = ctx->sk_proto;
+ 	if (sk->sk_write_space == tls_write_space)
+ 		sk->sk_write_space = ctx->sk_write_space;
+ 	write_unlock_bh(&sk->sk_callback_lock);
++>>>>>>> d85f01775850 (net: tls, fix sk_write_space NULL write when tx disabled)
  	release_sock(sk);
  	if (ctx->tx_conf == TLS_SW)
  		tls_sw_free_ctx_tx(ctx);
* Unmerged path net/tls/tls_main.c
