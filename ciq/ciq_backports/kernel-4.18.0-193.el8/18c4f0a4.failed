scsi: core: don't hold device refcount in IO path

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-193.el8
commit-author Ming Lei <ming.lei@redhat.com>
commit 18c4f0a42b08ced680aa287a9cf3c94b6f9a752f
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-193.el8/18c4f0a4.failed

scsi_device's refcount is always grabbed in IO path.

Turns out it isn't necessary, because blk_queue_cleanup() will drain any
in-flight IOs, then cancel timeout/requeue work, and SCSI's requeue_work is
canceled too in __scsi_remove_device().

Also scsi_device won't go away until blk_cleanup_queue() is done.

So don't hold the refcount in IO path, especially the refcount isn't
required in IO path since blk_queue_enter() / blk_queue_exit() is
introduced in the legacy block layer.

	Cc: Dongli Zhang <dongli.zhang@oracle.com>
	Cc: James Smart <james.smart@broadcom.com>
	Cc: Bart Van Assche <bart.vanassche@wdc.com>
	Cc: linux-scsi@vger.kernel.org,
	Cc: Martin K . Petersen <martin.petersen@oracle.com>,
	Cc: Christoph Hellwig <hch@lst.de>,
	Cc: James E . J . Bottomley <jejb@linux.vnet.ibm.com>,
	Cc: jianchao wang <jianchao.w.wang@oracle.com>
	Reviewed-by: Bart Van Assche <bvanassche@acm.org>
	Reviewed-by: Hannes Reinecke <hare@suse.com>
	Signed-off-by: Ming Lei <ming.lei@redhat.com>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit 18c4f0a42b08ced680aa287a9cf3c94b6f9a752f)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/scsi_lib.c
diff --cc drivers/scsi/scsi_lib.c
index e96e465c7f98,6b2570a5642d..000000000000
--- a/drivers/scsi/scsi_lib.c
+++ b/drivers/scsi/scsi_lib.c
@@@ -643,8 -604,6 +628,11 @@@ static bool scsi_end_request(struct req
  		blk_mq_run_hw_queues(q, true);
  
  	percpu_ref_put(&q->q_usage_counter);
++<<<<<<< HEAD
 +
 +	put_device(&sdev->sdev_gendev);
++=======
++>>>>>>> 18c4f0a42b08 (scsi: core: don't hold device refcount in IO path)
  	return false;
  }
  
* Unmerged path drivers/scsi/scsi_lib.c
