net: phy: micrel: add Asym Pause workaround for KSZ9021

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-193.el8
Rebuild_CHGLOG: - [netdrv] phy: micrel: add Asym Pause workaround for KSZ9021 (Petr Oros) [1772010]
Rebuild_FUZZ: 95.24%
commit-author Hans Andersson <hans.andersson@cellavision.se>
commit 407d8098cb1ab338199f4753162799a488d87d23
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-193.el8/407d8098.failed

The Micrel KSZ9031 PHY may fail to establish a link when the Asymmetric
Pause capability is set. This issue is described in a Silicon Errata
(DS80000691D or DS80000692D), which advises to always disable the
capability.

Micrel KSZ9021 has no errata, but has the same issue with Asymmetric Pause.
This patch apply the same workaround as the one for KSZ9031.

Fixes: 3aed3e2a143c ("net: phy: micrel: add Asym Pause workaround")
	Signed-off-by: Hans Andersson <hans.andersson@cellavision.se>
	Reviewed-by: Andrew Lunn <andrew@lunn.ch>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 407d8098cb1ab338199f4753162799a488d87d23)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/phy/micrel.c
diff --cc drivers/net/phy/micrel.c
index 52d52619256a,2fea5541c35a..000000000000
--- a/drivers/net/phy/micrel.c
+++ b/drivers/net/phy/micrel.c
@@@ -727,6 -751,33 +727,36 @@@ static int ksz8873mll_read_status(struc
  	return 0;
  }
  
++<<<<<<< HEAD
++=======
+ static int ksz9031_get_features(struct phy_device *phydev)
+ {
+ 	int ret;
+ 
+ 	ret = genphy_read_abilities(phydev);
+ 	if (ret < 0)
+ 		return ret;
+ 
+ 	/* Silicon Errata Sheet (DS80000691D or DS80000692D):
+ 	 * Whenever the device's Asymmetric Pause capability is set to 1,
+ 	 * link-up may fail after a link-up to link-down transition.
+ 	 *
+ 	 * The Errata Sheet is for ksz9031, but ksz9021 has the same issue
+ 	 *
+ 	 * Workaround:
+ 	 * Do not enable the Asymmetric Pause capability bit.
+ 	 */
+ 	linkmode_clear_bit(ETHTOOL_LINK_MODE_Asym_Pause_BIT, phydev->supported);
+ 
+ 	/* We force setting the Pause capability as the core will force the
+ 	 * Asymmetric Pause capability to 1 otherwise.
+ 	 */
+ 	linkmode_set_bit(ETHTOOL_LINK_MODE_Pause_BIT, phydev->supported);
+ 
+ 	return 0;
+ }
+ 
++>>>>>>> 407d8098cb1a (net: phy: micrel: add Asym Pause workaround for KSZ9021)
  static int ksz9031_read_status(struct phy_device *phydev)
  {
  	int err;
@@@ -1033,10 -1075,10 +1063,11 @@@ static struct phy_driver ksphy_driver[
  	.phy_id		= PHY_ID_KSZ9021,
  	.phy_id_mask	= 0x000ffffe,
  	.name		= "Micrel KSZ9021 Gigabit PHY",
 -	/* PHY_GBIT_FEATURES */
 +	.features	= PHY_GBIT_FEATURES,
 +	.flags		= PHY_HAS_INTERRUPT,
  	.driver_data	= &ksz9021_type,
  	.probe		= kszphy_probe,
+ 	.get_features	= ksz9031_get_features,
  	.config_init	= ksz9021_config_init,
  	.ack_interrupt	= kszphy_ack_interrupt,
  	.config_intr	= kszphy_config_intr,
* Unmerged path drivers/net/phy/micrel.c
