net: phy: add GBit master / slave error detection

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-193.el8
Rebuild_CHGLOG: - [netdrv] phy: add GBit master / slave error detection (Petr Oros) [1772010]
Rebuild_FUZZ: 94.62%
commit-author Heiner Kallweit <hkallweit1@gmail.com>
commit b8f8c8eb408b36ad55dd41a616b3f51998880fb6
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-193.el8/b8f8c8eb.failed

Certain PHY's have issues when operating in GBit slave mode and can
be forced to master mode. Examples are RTL8211C, also the Micrel PHY
driver has a DT setting to force master mode.
If two such chips are link partners the autonegotiation will fail.
Standard defines a self-clearing on read, latched-high bit to
indicate this error. Check this bit to inform the user.

	Signed-off-by: Heiner Kallweit <hkallweit1@gmail.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit b8f8c8eb408b36ad55dd41a616b3f51998880fb6)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/phy/phy_device.c
diff --cc drivers/net/phy/phy_device.c
index 2090f13889ae,db1172db1e7c..000000000000
--- a/drivers/net/phy/phy_device.c
+++ b/drivers/net/phy/phy_device.c
@@@ -1740,8 -1555,16 +1740,21 @@@ int genphy_read_status(struct phy_devic
  			if (adv < 0)
  				return adv;
  
++<<<<<<< HEAD
 +			mii_stat1000_mod_linkmode_lpa_t(phydev->lp_advertising,
 +							lpagb);
++=======
+ 			if (lpagb & LPA_1000MSFAIL) {
+ 				if (adv & CTL1000_ENABLE_MASTER)
+ 					phydev_err(phydev, "Master/Slave resolution failed, maybe conflicting manual settings?\n");
+ 				else
+ 					phydev_err(phydev, "Master/Slave resolution failed\n");
+ 				return -ENOLINK;
+ 			}
+ 
+ 			phydev->lp_advertising =
+ 				mii_stat1000_to_ethtool_lpa_t(lpagb);
++>>>>>>> b8f8c8eb408b (net: phy: add GBit master / slave error detection)
  			common_adv_gb = lpagb & adv << 2;
  		}
  
* Unmerged path drivers/net/phy/phy_device.c
diff --git a/include/uapi/linux/mii.h b/include/uapi/linux/mii.h
index b5c2fdcf23fd..a506216591d6 100644
--- a/include/uapi/linux/mii.h
+++ b/include/uapi/linux/mii.h
@@ -136,6 +136,7 @@
 #define CTL1000_ENABLE_MASTER	0x1000
 
 /* 1000BASE-T Status register */
+#define LPA_1000MSFAIL		0x8000	/* Master/Slave resolution failure */
 #define LPA_1000LOCALRXOK	0x2000	/* Link partner local receiver status */
 #define LPA_1000REMRXOK		0x1000	/* Link partner remote receiver status */
 #define LPA_1000FULL		0x0800	/* Link partner 1000BASE-T full duplex */
