net/mlx5: E-Switch, Pass metadata from FDB to eswitch manager

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-193.el8
Rebuild_CHGLOG: - [netdrv] mlx5: E-Switch, Pass metadata from FDB to eswitch manager (Alaa Hleihel) [1724327 1724336]
Rebuild_FUZZ: 96.61%
commit-author Jianbo Liu <jianbol@mellanox.com>
commit c1286050cf47170fbce7edc3787ab577a882863b
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-193.el8/c1286050.failed

In order to do matching on metadata in slow path when demuxing traffic
to representors, explicitly enable the feature that allows HW to pass
metadata REG_C_0 from FDB to eswitch manager NIC_RX table.

	Signed-off-by: Jianbo Liu <jianbol@mellanox.com>
	Reviewed-by: Roi Dayan <roid@mellanox.com>
	Reviewed-by: Mark Bloch <markb@mellanox.com>
	Signed-off-by: Saeed Mahameed <saeedm@mellanox.com>
(cherry picked from commit c1286050cf47170fbce7edc3787ab577a882863b)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlx5/core/eswitch_offloads.c
diff --cc drivers/net/ethernet/mellanox/mlx5/core/eswitch_offloads.c
index 2a02050a09e7,178ff9b05258..000000000000
--- a/drivers/net/ethernet/mellanox/mlx5/core/eswitch_offloads.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/eswitch_offloads.c
@@@ -1613,7 -2030,17 +1666,21 @@@ int esw_offloads_init(struct mlx5_eswit
  	if (err)
  		return err;
  
++<<<<<<< HEAD
 +	err = esw_offloads_load_reps(esw, nvports);
++=======
+ 	if (mlx5_eswitch_vport_match_metadata_enabled(esw)) {
+ 		err = mlx5_eswitch_enable_passing_vport_metadata(esw);
+ 		if (err)
+ 			goto err_vport_metadata;
+ 	}
+ 
+ 	/* Only load special vports reps. VF reps will be loaded in
+ 	 * context of functions_changed event handler through real
+ 	 * or emulated event.
+ 	 */
+ 	err = esw_offloads_load_special_vport(esw);
++>>>>>>> c1286050cf47 (net/mlx5: E-Switch, Pass metadata from FDB to eswitch manager)
  	if (err)
  		goto err_reps;
  
@@@ -1644,10 -2089,14 +1714,16 @@@ static int esw_offloads_stop(struct mlx
  	return err;
  }
  
 -void esw_offloads_cleanup(struct mlx5_eswitch *esw)
 +void esw_offloads_cleanup(struct mlx5_eswitch *esw, int nvports)
  {
 -	esw_functions_changed_event_cleanup(esw);
 -	mlx5_rdma_disable_roce(esw->dev);
  	esw_offloads_devcom_cleanup(esw);
++<<<<<<< HEAD
 +	esw_offloads_unload_reps(esw, nvports);
++=======
+ 	esw_offloads_unload_all_reps(esw, esw->esw_funcs.num_vfs);
+ 	if (mlx5_eswitch_vport_match_metadata_enabled(esw))
+ 		mlx5_eswitch_disable_passing_vport_metadata(esw);
++>>>>>>> c1286050cf47 (net/mlx5: E-Switch, Pass metadata from FDB to eswitch manager)
  	esw_offloads_steering_cleanup(esw);
  }
  
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/eswitch_offloads.c
