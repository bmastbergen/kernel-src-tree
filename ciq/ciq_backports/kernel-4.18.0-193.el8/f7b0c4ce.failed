iommu/vt-d: Flush IOTLB for untrusted device in time

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-193.el8
Rebuild_CHGLOG: - [iommu] vt-d: Flush IOTLB for untrusted device in time (Jerry Snitselaar) [1742234]
Rebuild_FUZZ: 93.88%
commit-author Lu Baolu <baolu.lu@linux.intel.com>
commit f7b0c4ce8cb3c09cb3cbfc0c663268bf99e5fa9c
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-193.el8/f7b0c4ce.failed

By default, for performance consideration, Intel IOMMU
driver won't flush IOTLB immediately after a buffer is
unmapped. It schedules a thread and flushes IOTLB in a
batched mode. This isn't suitable for untrusted device
since it still can access the memory even if it isn't
supposed to do so.

	Cc: Ashok Raj <ashok.raj@intel.com>
	Cc: Jacob Pan <jacob.jun.pan@linux.intel.com>
	Signed-off-by: Lu Baolu <baolu.lu@linux.intel.com>
	Tested-by: Xu Pengfei <pengfei.xu@intel.com>
	Tested-by: Mika Westerberg <mika.westerberg@intel.com>
	Signed-off-by: Joerg Roedel <jroedel@suse.de>
(cherry picked from commit f7b0c4ce8cb3c09cb3cbfc0c663268bf99e5fa9c)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/iommu/intel-iommu.c
diff --cc drivers/iommu/intel-iommu.c
index 940779fd0ec3,d93c4bd7de75..000000000000
--- a/drivers/iommu/intel-iommu.c
+++ b/drivers/iommu/intel-iommu.c
@@@ -3685,10 -3729,8 +3685,11 @@@ static void intel_unmap(struct device *
  	unsigned long iova_pfn;
  	struct intel_iommu *iommu;
  	struct page *freelist;
+ 	struct pci_dev *pdev = NULL;
  
 +	if (iommu_no_mapping(dev))
 +		return;
 +
  	domain = find_domain(dev);
  	BUG_ON(!domain);
  
@@@ -3700,8 -3742,10 +3701,15 @@@
  	start_pfn = mm_to_dma_pfn(iova_pfn);
  	last_pfn = start_pfn + nrpages - 1;
  
++<<<<<<< HEAD
 +	pr_debug("Device %s unmapping: pfn %lx-%lx\n",
 +		 dev_name(dev), start_pfn, last_pfn);
++=======
+ 	if (dev_is_pci(dev))
+ 		pdev = to_pci_dev(dev);
+ 
+ 	dev_dbg(dev, "Device unmapping: pfn %lx-%lx\n", start_pfn, last_pfn);
++>>>>>>> f7b0c4ce8cb3 (iommu/vt-d: Flush IOTLB for untrusted device in time)
  
  	freelist = domain_unmap(domain, start_pfn, last_pfn);
  
* Unmerged path drivers/iommu/intel-iommu.c
