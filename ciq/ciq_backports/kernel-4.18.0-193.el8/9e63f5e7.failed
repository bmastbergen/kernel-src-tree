mt76: mt7603: use napi polling for tx cleanup

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-193.el8
commit-author Lorenzo Bianconi <lorenzo@kernel.org>
commit 9e63f5e76b5638f51f50e7815914daf879af5b30
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-193.el8/9e63f5e7.failed

This allows tx scheduling and tx cleanup to run concurrently

	Signed-off-by: Lorenzo Bianconi <lorenzo@kernel.org>
	Signed-off-by: Felix Fietkau <nbd@nbd.name>
(cherry picked from commit 9e63f5e76b5638f51f50e7815914daf879af5b30)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/wireless/mediatek/mt76/mt7603/core.c
#	drivers/net/wireless/mediatek/mt76/mt7603/dma.c
#	drivers/net/wireless/mediatek/mt76/mt7603/mac.c
diff --cc drivers/net/wireless/mediatek/mt76/mt7603/core.c
index cbb948675674,e7ee58e3379c..000000000000
--- a/drivers/net/wireless/mediatek/mt76/mt7603/core.c
+++ b/drivers/net/wireless/mediatek/mt76/mt7603/core.c
@@@ -46,7 -35,7 +46,11 @@@ irqreturn_t mt7603_irq_handler(int irq
  
  	if (intr & MT_INT_TX_DONE_ALL) {
  		mt7603_irq_disable(dev, MT_INT_TX_DONE_ALL);
++<<<<<<< HEAD
 +		tasklet_schedule(&dev->tx_tasklet);
++=======
+ 		napi_schedule(&dev->mt76.tx_napi);
++>>>>>>> 9e63f5e76b56 (mt76: mt7603: use napi polling for tx cleanup)
  	}
  
  	if (intr & MT_INT_RX_DONE(0)) {
diff --cc drivers/net/wireless/mediatek/mt76/mt7603/dma.c
index b3ae0aaea62a,54314f6803c5..000000000000
--- a/drivers/net/wireless/mediatek/mt76/mt7603/dma.c
+++ b/drivers/net/wireless/mediatek/mt76/mt7603/dma.c
@@@ -144,7 -154,15 +153,19 @@@ static int mt7603_poll_tx(struct napi_s
  	for (i = MT_TXQ_MCU; i >= 0; i--)
  		mt76_queue_tx_cleanup(dev, i, false);
  
++<<<<<<< HEAD
 +	mt7603_irq_enable(dev, MT_INT_TX_DONE_ALL);
++=======
+ 	if (napi_complete_done(napi, 0))
+ 		mt7603_irq_enable(dev, MT_INT_TX_DONE_ALL);
+ 
+ 	for (i = MT_TXQ_MCU; i >= 0; i--)
+ 		mt76_queue_tx_cleanup(dev, i, false);
+ 
+ 	tasklet_schedule(&dev->mt76.tx_tasklet);
+ 
+ 	return 0;
++>>>>>>> 9e63f5e76b56 (mt76: mt7603: use napi polling for tx cleanup)
  }
  
  int mt7603_dma_init(struct mt7603_dev *dev)
@@@ -223,6 -249,7 +252,11 @@@ void mt7603_dma_cleanup(struct mt7603_d
  		   MT_WPDMA_GLO_CFG_RX_DMA_EN |
  		   MT_WPDMA_GLO_CFG_TX_WRITEBACK_DONE);
  
++<<<<<<< HEAD
 +	tasklet_kill(&dev->tx_tasklet);
++=======
+ 	tasklet_kill(&dev->mt76.tx_tasklet);
+ 	netif_napi_del(&dev->mt76.tx_napi);
++>>>>>>> 9e63f5e76b56 (mt76: mt7603: use napi polling for tx cleanup)
  	mt76_dma_cleanup(&dev->mt76);
  }
diff --cc drivers/net/wireless/mediatek/mt76/mt7603/mac.c
index 260a72176cf4,0ccba5926b68..000000000000
--- a/drivers/net/wireless/mediatek/mt76/mt7603/mac.c
+++ b/drivers/net/wireless/mediatek/mt76/mt7603/mac.c
@@@ -1276,10 -1278,11 +1276,11 @@@ static void mt7603_mac_watchdog_reset(s
  	/* lock/unlock all queues to ensure that no tx is pending */
  	mt76_txq_schedule_all(&dev->mt76);
  
 -	tasklet_disable(&dev->mt76.tx_tasklet);
 -	tasklet_disable(&dev->mt76.pre_tbtt_tasklet);
 +	tasklet_disable(&dev->tx_tasklet);
 +	tasklet_disable(&dev->pre_tbtt_tasklet);
  	napi_disable(&dev->mt76.napi[0]);
  	napi_disable(&dev->mt76.napi[1]);
+ 	napi_disable(&dev->mt76.tx_napi);
  
  	mutex_lock(&dev->mt76.mutex);
  
@@@ -1323,10 -1326,11 +1324,16 @@@ skip_dma_reset
  	clear_bit(MT76_RESET, &dev->mt76.state);
  	mutex_unlock(&dev->mt76.mutex);
  
++<<<<<<< HEAD
 +	tasklet_enable(&dev->tx_tasklet);
 +	tasklet_schedule(&dev->tx_tasklet);
++=======
+ 	tasklet_enable(&dev->mt76.tx_tasklet);
+ 	napi_enable(&dev->mt76.tx_napi);
+ 	napi_schedule(&dev->mt76.tx_napi);
++>>>>>>> 9e63f5e76b56 (mt76: mt7603: use napi polling for tx cleanup)
  
 -	tasklet_enable(&dev->mt76.pre_tbtt_tasklet);
 +	tasklet_enable(&dev->pre_tbtt_tasklet);
  	mt7603_beacon_set_timer(dev, -1, beacon_int);
  
  	napi_enable(&dev->mt76.napi[0]);
* Unmerged path drivers/net/wireless/mediatek/mt76/mt7603/core.c
* Unmerged path drivers/net/wireless/mediatek/mt76/mt7603/dma.c
* Unmerged path drivers/net/wireless/mediatek/mt76/mt7603/mac.c
