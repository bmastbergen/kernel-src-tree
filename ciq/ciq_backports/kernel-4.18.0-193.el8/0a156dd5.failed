NFS/flexfiles: Avoid unnecessary layout invalidations

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-193.el8
commit-author Trond Myklebust <trond.myklebust@hammerspace.com>
commit 0a156dd58274b0b847118966365203955288f4c6
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-193.el8/0a156dd5.failed

In ff_layout_mirror_valid() we may not want to invalidate the layout
segment despite the call to GETDEVICEINFO failing. The reason is that
a read may still be able to make progress on another mirror.

So instead we let the caller (in this case nfs4_ff_layout_prepare_ds())
decide whether or not it needs to invalidate.

	Signed-off-by: Trond Myklebust <trond.myklebust@hammerspace.com>
(cherry picked from commit 0a156dd58274b0b847118966365203955288f4c6)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/nfs/flexfilelayout/flexfilelayoutdev.c
diff --cc fs/nfs/flexfilelayout/flexfilelayoutdev.c
index e54f4fb6813a,92efb5692eb3..000000000000
--- a/fs/nfs/flexfilelayout/flexfilelayoutdev.c
+++ b/fs/nfs/flexfilelayout/flexfilelayoutdev.c
@@@ -417,15 -415,8 +416,20 @@@ nfs4_ff_layout_prepare_ds(struct pnfs_l
  	unsigned int max_payload;
  	int status;
  
++<<<<<<< HEAD
 +	if (!ff_layout_mirror_valid(lseg, mirror, true)) {
 +		pr_err_ratelimited("NFS: %s: No data server for offset index %d\n",
 +			__func__, ds_idx);
 +		goto out;
 +	}
 +
 +	devid = &mirror->mirror_ds->id_node;
 +	if (ff_layout_test_devid_unavailable(devid))
 +		goto out_fail;
++=======
+ 	if (!ff_layout_mirror_valid(lseg, mirror, true))
+ 		goto noconnect;
++>>>>>>> 0a156dd58274 (NFS/flexfiles: Avoid unnecessary layout invalidations)
  
  	ds = mirror->mirror_ds->ds;
  	/* matching smp_wmb() in _nfs4_pnfs_v3/4_ds_connect */
@@@ -452,7 -443,7 +456,11 @@@
  			mirror->mirror_ds->ds_versions[0].wsize = max_payload;
  		goto out;
  	}
++<<<<<<< HEAD
 +out_fail:
++=======
+ noconnect:
++>>>>>>> 0a156dd58274 (NFS/flexfiles: Avoid unnecessary layout invalidations)
  	ff_layout_track_ds_error(FF_LAYOUT_FROM_HDR(lseg->pls_layout),
  				 mirror, lseg->pls_range.offset,
  				 lseg->pls_range.length, NFS4ERR_NXIO,
* Unmerged path fs/nfs/flexfilelayout/flexfilelayoutdev.c
