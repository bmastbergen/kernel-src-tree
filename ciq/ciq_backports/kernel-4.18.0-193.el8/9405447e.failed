arm64: Avoid Cavium TX2 erratum 219 when switching TTBR

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-193.el8
Rebuild_CHGLOG: - [arm64] Avoid Cavium TX2 erratum 219 when switching TTBR (Auger Eric) [1771633]
Rebuild_FUZZ: 93.20%
commit-author Marc Zyngier <marc.zyngier@arm.com>
commit 9405447ef79bc93101373e130f72e9e6cbf17dbb
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-193.el8/9405447e.failed

As a PRFM instruction racing against a TTBR update can have undesirable
effects on TX2, NOP-out such PRFM on cores that are affected by
the TX2-219 erratum.

	Cc: <stable@vger.kernel.org>
	Signed-off-by: Marc Zyngier <marc.zyngier@arm.com>
	Signed-off-by: Will Deacon <will@kernel.org>
(cherry picked from commit 9405447ef79bc93101373e130f72e9e6cbf17dbb)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/arm64/include/asm/cpucaps.h
#	arch/arm64/kernel/cpu_errata.c
diff --cc arch/arm64/include/asm/cpucaps.h
index 1a8df16d556c,ac1dbca3d0cd..000000000000
--- a/arch/arm64/include/asm/cpucaps.h
+++ b/arch/arm64/include/asm/cpucaps.h
@@@ -51,11 -40,21 +51,26 @@@
  #define ARM64_SSBD				30
  #define ARM64_MISMATCHED_CACHE_TYPE		31
  #define ARM64_HAS_STAGE2_FWB			32
 -#define ARM64_HAS_CRC32				33
 +#define ARM64_WORKAROUND_1188873		33
  #define ARM64_SSBS				34
 -#define ARM64_WORKAROUND_1418040		35
 +#define ARM64_WORKAROUND_1165522		35
  #define ARM64_HAS_SB				36
++<<<<<<< HEAD
 +
 +#define ARM64_NCAPS				37
++=======
+ #define ARM64_WORKAROUND_1165522		37
+ #define ARM64_HAS_ADDRESS_AUTH_ARCH		38
+ #define ARM64_HAS_ADDRESS_AUTH_IMP_DEF		39
+ #define ARM64_HAS_GENERIC_AUTH_ARCH		40
+ #define ARM64_HAS_GENERIC_AUTH_IMP_DEF		41
+ #define ARM64_HAS_IRQ_PRIO_MASKING		42
+ #define ARM64_HAS_DCPODP			43
+ #define ARM64_WORKAROUND_1463225		44
+ #define ARM64_WORKAROUND_CAVIUM_TX2_219_TVM	45
+ #define ARM64_WORKAROUND_CAVIUM_TX2_219_PRFM	46
+ 
+ #define ARM64_NCAPS				47
++>>>>>>> 9405447ef79b (arm64: Avoid Cavium TX2 erratum 219 when switching TTBR)
  
  #endif /* __ASM_CPUCAPS_H */
diff --cc arch/arm64/kernel/cpu_errata.c
index feeb8962a8d8,a19bb3e4bcfb..000000000000
--- a/arch/arm64/kernel/cpu_errata.c
+++ b/arch/arm64/kernel/cpu_errata.c
@@@ -828,6 -869,27 +828,30 @@@ const struct arm64_cpu_capabilities arm
  		ERRATA_MIDR_RANGE(MIDR_CORTEX_A76, 0, 0, 2, 0),
  	},
  #endif
++<<<<<<< HEAD
++=======
+ #ifdef CONFIG_ARM64_ERRATUM_1463225
+ 	{
+ 		.desc = "ARM erratum 1463225",
+ 		.capability = ARM64_WORKAROUND_1463225,
+ 		.type = ARM64_CPUCAP_LOCAL_CPU_ERRATUM,
+ 		.matches = has_cortex_a76_erratum_1463225,
+ 	},
+ #endif
+ #ifdef CONFIG_CAVIUM_TX2_ERRATUM_219
+ 	{
+ 		.desc = "Cavium ThunderX2 erratum 219 (KVM guest sysreg trapping)",
+ 		.capability = ARM64_WORKAROUND_CAVIUM_TX2_219_TVM,
+ 		ERRATA_MIDR_RANGE_LIST(tx2_family_cpus),
+ 		.matches = needs_tx2_tvm_workaround,
+ 	},
+ 	{
+ 		.desc = "Cavium ThunderX2 erratum 219 (PRFM removal)",
+ 		.capability = ARM64_WORKAROUND_CAVIUM_TX2_219_PRFM,
+ 		ERRATA_MIDR_RANGE_LIST(tx2_family_cpus),
+ 	},
+ #endif
++>>>>>>> 9405447ef79b (arm64: Avoid Cavium TX2 erratum 219 when switching TTBR)
  	{
  	}
  };
* Unmerged path arch/arm64/include/asm/cpucaps.h
* Unmerged path arch/arm64/kernel/cpu_errata.c
diff --git a/arch/arm64/kernel/entry.S b/arch/arm64/kernel/entry.S
index 864ada8a265a..030c19b37bc1 100644
--- a/arch/arm64/kernel/entry.S
+++ b/arch/arm64/kernel/entry.S
@@ -962,7 +962,9 @@ alternative_insn isb, nop, ARM64_WORKAROUND_QCOM_FALKOR_E1003
 #else
 	ldr	x30, =vectors
 #endif
+alternative_if_not ARM64_WORKAROUND_CAVIUM_TX2_219_PRFM
 	prfm	plil1strm, [x30, #(1b - tramp_vectors)]
+alternative_else_nop_endif
 	msr	vbar_el1, x30
 	add	x30, x30, #(1b - tramp_vectors)
 	isb
