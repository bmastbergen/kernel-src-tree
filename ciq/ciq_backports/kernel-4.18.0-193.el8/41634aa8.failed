mt76: only schedule txqs from the tx tasklet

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-193.el8
commit-author Felix Fietkau <nbd@nbd.name>
commit 41634aa8d6db9346121f58eed5d94511cdcb0976
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-193.el8/41634aa8.failed

Reduces lock contention from the tx path and improves performance

	Signed-off-by: Felix Fietkau <nbd@nbd.name>
(cherry picked from commit 41634aa8d6db9346121f58eed5d94511cdcb0976)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/wireless/mediatek/mt76/mt76x02_mmio.c
diff --cc drivers/net/wireless/mediatek/mt76/mt76x02_mmio.c
index 617934565818,af308c0ef395..000000000000
--- a/drivers/net/wireless/mediatek/mt76/mt76x02_mmio.c
+++ b/drivers/net/wireless/mediatek/mt76/mt76x02_mmio.c
@@@ -157,33 -154,18 +157,41 @@@ static void mt76x02_process_tx_status_f
  static void mt76x02_tx_tasklet(unsigned long data)
  {
  	struct mt76x02_dev *dev = (struct mt76x02_dev *)data;
 -	int i;
  
 +	mt76x02_mac_poll_tx_status(dev, false);
  	mt76x02_process_tx_status_fifo(dev);
  
 +	mt76_txq_schedule_all(&dev->mt76);
 +}
 +
 +static int mt76x02_poll_tx(struct napi_struct *napi, int budget)
 +{
 +	struct mt76x02_dev *dev = container_of(napi, struct mt76x02_dev,
 +					       mt76.tx_napi);
 +	int i;
 +
 +	mt76x02_mac_poll_tx_status(dev, false);
 +
 +	for (i = MT_TXQ_MCU; i >= 0; i--)
 +		mt76_queue_tx_cleanup(dev, i, false);
 +
++<<<<<<< HEAD
 +	if (napi_complete_done(napi, 0))
 +		mt76x02_irq_enable(dev, MT_INT_TX_DONE_ALL);
 +
  	for (i = MT_TXQ_MCU; i >= 0; i--)
  		mt76_queue_tx_cleanup(dev, i, false);
  
 +	tasklet_schedule(&dev->mt76.tx_tasklet);
 +
 +	return 0;
++=======
+ 	mt76x02_mac_poll_tx_status(dev, false);
+ 
+ 	mt76_txq_schedule_all(&dev->mt76);
+ 
+ 	mt76x02_irq_enable(dev, MT_INT_TX_DONE_ALL);
++>>>>>>> 41634aa8d6db (mt76: only schedule txqs from the tx tasklet)
  }
  
  int mt76x02_dma_init(struct mt76x02_dev *dev)
diff --git a/drivers/net/wireless/mediatek/mt76/mt7603/dma.c b/drivers/net/wireless/mediatek/mt76/mt7603/dma.c
index b3ae0aaea62a..ff81c229f227 100644
--- a/drivers/net/wireless/mediatek/mt76/mt7603/dma.c
+++ b/drivers/net/wireless/mediatek/mt76/mt7603/dma.c
@@ -144,6 +144,8 @@ mt7603_tx_tasklet(unsigned long data)
 	for (i = MT_TXQ_MCU; i >= 0; i--)
 		mt76_queue_tx_cleanup(dev, i, false);
 
+	mt76_txq_schedule_all(&dev->mt76);
+
 	mt7603_irq_enable(dev, MT_INT_TX_DONE_ALL);
 }
 
* Unmerged path drivers/net/wireless/mediatek/mt76/mt76x02_mmio.c
