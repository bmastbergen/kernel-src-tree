nfp: flower: prevent ingress block binds on internal ports

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-193.el8
commit-author John Hurley <john.hurley@netronome.com>
commit 739d7c5752b255e89ddbb1b0474f3b88ef5cd343
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-193.el8/739d7c57.failed

Internal port TC offload is implemented through user-space applications
(such as OvS) by adding filters at egress via TC clsact qdiscs. Indirect
block offload support in the NFP driver accepts both ingress qdisc binds
and egress binds if the device is an internal port. However, clsact sends
bind notification for both ingress and egress block binds which can lead
to the driver registering multiple callbacks and receiving multiple
notifications of new filters.

Fix this by rejecting ingress block bind callbacks when the port is
internal and only adding filter callbacks for egress binds.

Fixes: 4d12ba42787b ("nfp: flower: allow offloading of matches on 'internal' ports")
	Signed-off-by: John Hurley <john.hurley@netronome.com>
	Reviewed-by: Jakub Kicinski <jakub.kicinski@netronome.com>
	Signed-off-by: Jakub Kicinski <jakub.kicinski@netronome.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 739d7c5752b255e89ddbb1b0474f3b88ef5cd343)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/netronome/nfp/flower/offload.c
diff --cc drivers/net/ethernet/netronome/nfp/flower/offload.c
index bd314048341c,457bdc60f3ee..000000000000
--- a/drivers/net/ethernet/netronome/nfp/flower/offload.c
+++ b/drivers/net/ethernet/netronome/nfp/flower/offload.c
@@@ -1501,11 -1407,12 +1501,18 @@@ nfp_flower_setup_indr_tc_block(struct n
  {
  	struct nfp_flower_indr_block_cb_priv *cb_priv;
  	struct nfp_flower_priv *priv = app->priv;
 -	struct flow_block_cb *block_cb;
 +	int err;
  
++<<<<<<< HEAD
 +	if (f->binder_type != TCF_BLOCK_BINDER_TYPE_CLSACT_INGRESS &&
 +	    !(f->binder_type == TCF_BLOCK_BINDER_TYPE_CLSACT_EGRESS &&
 +	      nfp_flower_internal_port_can_offload(app, netdev)))
++=======
+ 	if ((f->binder_type != FLOW_BLOCK_BINDER_TYPE_CLSACT_INGRESS &&
+ 	     !nfp_flower_internal_port_can_offload(app, netdev)) ||
+ 	    (f->binder_type != FLOW_BLOCK_BINDER_TYPE_CLSACT_EGRESS &&
+ 	     nfp_flower_internal_port_can_offload(app, netdev)))
++>>>>>>> 739d7c5752b2 (nfp: flower: prevent ingress block binds on internal ports)
  		return -EOPNOTSUPP;
  
  	switch (f->command) {
* Unmerged path drivers/net/ethernet/netronome/nfp/flower/offload.c
