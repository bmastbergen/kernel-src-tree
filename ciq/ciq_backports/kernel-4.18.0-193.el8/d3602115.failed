iommu: set group default domain before creating direct mappings

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-193.el8
Rebuild_CHGLOG: - [iommu] set group default domain before creating direct mappings (Jerry Snitselaar) [1778041]
Rebuild_FUZZ: 94.12%
commit-author Jerry Snitselaar <jsnitsel@redhat.com>
commit d360211524bece6db9920f32c91808235290b51c
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-193.el8/d3602115.failed

iommu_group_create_direct_mappings uses group->default_domain, but
right after it is called, request_default_domain_for_dev calls
iommu_domain_free for the default domain, and sets the group default
domain to a different domain. Move the
iommu_group_create_direct_mappings call to after the group default
domain is set, so the direct mappings get associated with that domain.

	Cc: Joerg Roedel <jroedel@suse.de>
	Cc: Lu Baolu <baolu.lu@linux.intel.com>
	Cc: iommu@lists.linux-foundation.org
	Cc: stable@vger.kernel.org
Fixes: 7423e01741dd ("iommu: Add API to request DMA domain for device")
	Signed-off-by: Jerry Snitselaar <jsnitsel@redhat.com>
	Reviewed-by: Lu Baolu <baolu.lu@linux.intel.com>
	Signed-off-by: Joerg Roedel <jroedel@suse.de>
(cherry picked from commit d360211524bece6db9920f32c91808235290b51c)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/iommu/iommu.c
diff --cc drivers/iommu/iommu.c
index 051af54ceafa,fa908179b80b..000000000000
--- a/drivers/iommu/iommu.c
+++ b/drivers/iommu/iommu.c
@@@ -1975,12 -2282,15 +1975,23 @@@ int iommu_request_dm_for_dev(struct dev
  		goto out;
  	}
  
++<<<<<<< HEAD
 +	/* Make the direct mapped domain the default for this group */
++=======
+ 	/* Make the domain the default for this group */
++>>>>>>> d360211524be (iommu: set group default domain before creating direct mappings)
  	if (group->default_domain)
  		iommu_domain_free(group->default_domain);
 -	group->default_domain = domain;
 +	group->default_domain = dm_domain;
  
++<<<<<<< HEAD
 +	pr_info("Using direct mapping for device %s\n", dev_name(dev));
++=======
+ 	iommu_group_create_direct_mappings(group, dev);
+ 
+ 	dev_info(dev, "Using iommu %s mapping\n",
+ 		 type == IOMMU_DOMAIN_DMA ? "dma" : "direct");
++>>>>>>> d360211524be (iommu: set group default domain before creating direct mappings)
  
  	ret = 0;
  out:
* Unmerged path drivers/iommu/iommu.c
