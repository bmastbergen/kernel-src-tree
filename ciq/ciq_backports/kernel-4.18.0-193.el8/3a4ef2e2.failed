RDMA/rdmavt: Catch use-after-free access of AH structures

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-193.el8
commit-author Leon Romanovsky <leon@kernel.org>
commit 3a4ef2e2b5cf9a34bcc66c0d33f7eba180a14535
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-193.el8/3a4ef2e2.failed

Prior to commit d345691471b4 ("RDMA: Handle AH allocations by IB/core"),
AH destroy path is rdmavt returned -EBUSY warning to application and
caused to potential leakage of kernel memory of AH structure.

After that commit, the AH structure is always freed but such early return
in driver code can potentially cause to use-after-free error.

Add warning to catch such situation to help driver developers to fix AH
release path.

	Signed-off-by: Leon Romanovsky <leonro@mellanox.com>
	Signed-off-by: Jason Gunthorpe <jgg@mellanox.com>
(cherry picked from commit 3a4ef2e2b5cf9a34bcc66c0d33f7eba180a14535)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/sw/rdmavt/ah.c
diff --cc drivers/infiniband/sw/rdmavt/ah.c
index fc10e4e26ca7,0e147b32cbe9..000000000000
--- a/drivers/infiniband/sw/rdmavt/ah.c
+++ b/drivers/infiniband/sw/rdmavt/ah.c
@@@ -147,8 -141,7 +147,12 @@@ int rvt_destroy_ah(struct ib_ah *ibah, 
  	struct rvt_ah *ah = ibah_to_rvtah(ibah);
  	unsigned long flags;
  
++<<<<<<< HEAD
 +	if (atomic_read(&ah->refcount) != 0)
 +		return -EBUSY;
++=======
+ 	WARN_ON_ONCE(atomic_read(&ah->refcount));
++>>>>>>> 3a4ef2e2b5cf (RDMA/rdmavt: Catch use-after-free access of AH structures)
  
  	spin_lock_irqsave(&dev->n_ahs_lock, flags);
  	dev->n_ahs_allocated--;
* Unmerged path drivers/infiniband/sw/rdmavt/ah.c
