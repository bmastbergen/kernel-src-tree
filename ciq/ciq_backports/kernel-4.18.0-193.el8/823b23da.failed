IB/core: Allow vlan link local address based RoCE GIDs

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-193.el8
commit-author Parav Pandit <parav@mellanox.com>
commit 823b23da71132b80d9f41ab667c68b112455f3b6
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-193.el8/823b23da.failed

IPv6 link local address for a VLAN netdevice has nothing to do with its
resemblance with the default GID, because VLAN link local GID is in
different layer 2 domain.

Now that RoCE MAD packet processing and route resolution consider the
right GID index, there is no need for an unnecessary check which prevents
the addition of vlan based IPv6 link local GIDs.

	Signed-off-by: Parav Pandit <parav@mellanox.com>
	Reviewed-by: Daniel Jurgens <danielj@mellanox.com>
	Signed-off-by: Leon Romanovsky <leonro@mellanox.com>
	Signed-off-by: Jason Gunthorpe <jgg@mellanox.com>
(cherry picked from commit 823b23da71132b80d9f41ab667c68b112455f3b6)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/core/cache.c
diff --cc drivers/infiniband/core/cache.c
index f50de4cb4cd9,7499e7016e38..000000000000
--- a/drivers/infiniband/core/cache.c
+++ b/drivers/infiniband/core/cache.c
@@@ -543,32 -543,11 +543,36 @@@ out_unlock
  int ib_cache_gid_add(struct ib_device *ib_dev, u8 port,
  		     union ib_gid *gid, struct ib_gid_attr *attr)
  {
- 	struct net_device *idev;
- 	unsigned long mask;
- 	int ret;
+ 	unsigned long mask = GID_ATTR_FIND_MASK_GID |
+ 			     GID_ATTR_FIND_MASK_GID_TYPE |
+ 			     GID_ATTR_FIND_MASK_NETDEV;
  
++<<<<<<< HEAD
 +	if (ib_dev->ops.get_netdev) {
 +		idev = ib_dev->ops.get_netdev(ib_dev, port);
 +		if (idev && attr->ndev != idev) {
 +			union ib_gid default_gid;
 +
 +			/* Adding default GIDs in not permitted */
 +			make_default_gid(idev, &default_gid);
 +			if (!memcmp(gid, &default_gid, sizeof(*gid))) {
 +				dev_put(idev);
 +				return -EPERM;
 +			}
 +		}
 +		if (idev)
 +			dev_put(idev);
 +	}
 +
 +	mask = GID_ATTR_FIND_MASK_GID |
 +	       GID_ATTR_FIND_MASK_GID_TYPE |
 +	       GID_ATTR_FIND_MASK_NETDEV;
 +
 +	ret = __ib_cache_gid_add(ib_dev, port, gid, attr, mask, false);
 +	return ret;
++=======
+ 	return __ib_cache_gid_add(ib_dev, port, gid, attr, mask, false);
++>>>>>>> 823b23da7113 (IB/core: Allow vlan link local address based RoCE GIDs)
  }
  
  static int
* Unmerged path drivers/infiniband/core/cache.c
