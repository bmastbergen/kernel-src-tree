perf tools report: Add custom scripts to script menu

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-193.el8
commit-author Andi Kleen <ak@linux.intel.com>
commit e3b74de50a5f8bbfacbd772874c8b5d9220ebcdb
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-193.el8/e3b74de5.failed

Add a way to define custom scripts through ~/.perfconfig, which are then
added to the scripts menu. The scripts get the same arguments as 'perf
script', in particular -i, --cpu, --tid.

	Signed-off-by: Andi Kleen <ak@linux.intel.com>
	Acked-by: Jiri Olsa <jolsa@kernel.org>
Link: http://lkml.kernel.org/r/20190311144502.15423-10-andi@firstfloor.org
	Signed-off-by: Arnaldo Carvalho de Melo <acme@redhat.com>
(cherry picked from commit e3b74de50a5f8bbfacbd772874c8b5d9220ebcdb)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/perf/Documentation/perf-config.txt
diff --cc tools/perf/Documentation/perf-config.txt
index 86f3dcc15f83,95054a8176a2..000000000000
--- a/tools/perf/Documentation/perf-config.txt
+++ b/tools/perf/Documentation/perf-config.txt
@@@ -584,6 -584,20 +584,23 @@@ llvm.*:
  	llvm.opts::
  		Options passed to llc.
  
++<<<<<<< HEAD
++=======
+ samples.*::
+ 
+ 	samples.context::
+ 		Define how many ns worth of time to show
+ 		around samples in perf report sample context browser.
+ 
+ scripts.*::
+ 
+ 	Any option defines a script that is added to the scripts menu
+ 	in the interactive perf browser and whose output is displayed.
+ 	The name of the option is the name, the value is a script command line.
+ 	The script gets the same options passed as a full perf script,
+ 	in particular -i perfdata file, --cpu, --tid
+ 
++>>>>>>> e3b74de50a5f (perf tools report: Add custom scripts to script menu)
  SEE ALSO
  --------
  linkperf:perf[1]
* Unmerged path tools/perf/Documentation/perf-config.txt
diff --git a/tools/perf/ui/browsers/scripts.c b/tools/perf/ui/browsers/scripts.c
index 3da257a5a275..fccf7288c08a 100644
--- a/tools/perf/ui/browsers/scripts.c
+++ b/tools/perf/ui/browsers/scripts.c
@@ -6,6 +6,7 @@
 #include "../../util/symbol.h"
 #include "../browser.h"
 #include "../libslang.h"
+#include "config.h"
 
 #define SCRIPT_NAMELEN	128
 #define SCRIPT_MAX_NO	64
@@ -53,6 +54,24 @@ static int add_script_option(const char *name, const char *opt,
 	return 0;
 }
 
+static int scripts_config(const char *var, const char *value, void *data)
+{
+	struct script_config *c = data;
+
+	if (!strstarts(var, "scripts."))
+		return -1;
+	if (c->index >= SCRIPT_MAX_NO)
+		return -1;
+	c->names[c->index] = strdup(var + 7);
+	if (!c->names[c->index])
+		return -1;
+	if (asprintf(&c->paths[c->index], "%s %s", value,
+		     c->extra_format) < 0)
+		return -1;
+	c->index++;
+	return 0;
+}
+
 /*
  * When success, will copy the full path of the selected script
  * into  the buffer pointed by script_name, and return 0.
@@ -87,6 +106,7 @@ static int list_scripts(char *script_name, bool *custom,
 			  &scriptc);
 	add_script_option("Show individual samples with source", "-F +srcline,+srccode",
 			  &scriptc);
+	perf_config(scripts_config, &scriptc);
 	custom_perf = scriptc.index;
 	add_script_option("Show samples with custom perf script arguments", "", &scriptc);
 	i = scriptc.index;
