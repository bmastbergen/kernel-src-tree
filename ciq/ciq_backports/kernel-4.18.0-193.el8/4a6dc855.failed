RDMA/mlx5: Free IB device on remove

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-193.el8
commit-author Mark Bloch <markb@mellanox.com>
commit 4a6dc8552ab2f670fdff317a5ac1bc42f85a8772
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-193.el8/4a6dc855.failed

Simplify the code and move the deallocation of the IB device into the
remove function.

	Signed-off-by: Mark Bloch <markb@mellanox.com>
	Signed-off-by: Leon Romanovsky <leonro@mellanox.com>
	Signed-off-by: Jason Gunthorpe <jgg@mellanox.com>
(cherry picked from commit 4a6dc8552ab2f670fdff317a5ac1bc42f85a8772)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/hw/mlx5/ib_rep.c
#	drivers/infiniband/hw/mlx5/main.c
diff --cc drivers/infiniband/hw/mlx5/ib_rep.c
index 95ac97af6166,87d553396fb4..000000000000
--- a/drivers/infiniband/hw/mlx5/ib_rep.c
+++ b/drivers/infiniband/hw/mlx5/ib_rep.c
@@@ -78,10 -65,8 +78,13 @@@ mlx5_ib_vport_rep_load(struct mlx5_core
  	ibdev->mdev = dev;
  	ibdev->num_ports = max(MLX5_CAP_GEN(dev, num_ports),
  			       MLX5_CAP_GEN(dev, num_vhca_ports));
++<<<<<<< HEAD
 +	if (!__mlx5_ib_add(ibdev, &rep_profile)) {
 +		ib_dealloc_device(&ibdev->ib_dev);
++=======
+ 	if (!__mlx5_ib_add(ibdev, profile))
++>>>>>>> 4a6dc8552ab2 (RDMA/mlx5: Free IB device on remove)
  		return -EINVAL;
- 	}
  
  	rep->rep_if[REP_IB].priv = ibdev;
  
diff --cc drivers/infiniband/hw/mlx5/main.c
index 5fcf98302272,23f31069ec0a..000000000000
--- a/drivers/infiniband/hw/mlx5/main.c
+++ b/drivers/infiniband/hw/mlx5/main.c
@@@ -6632,12 -6640,7 +6634,16 @@@ static void mlx5_ib_remove(struct mlx5_
  	}
  
  	dev = context;
++<<<<<<< HEAD
 +	if (dev->profile == &nic_rep_profile)
 +		mlx5_ib_unregister_vport_reps(dev);
 +	else
 +		__mlx5_ib_remove(dev, dev->profile, MLX5_IB_STAGE_MAX);
 +
 +	ib_dealloc_device((struct ib_device *)dev);
++=======
+ 	__mlx5_ib_remove(dev, dev->profile, MLX5_IB_STAGE_MAX);
++>>>>>>> 4a6dc8552ab2 (RDMA/mlx5: Free IB device on remove)
  }
  
  static struct mlx5_interface mlx5_ib_interface = {
* Unmerged path drivers/infiniband/hw/mlx5/ib_rep.c
* Unmerged path drivers/infiniband/hw/mlx5/main.c
