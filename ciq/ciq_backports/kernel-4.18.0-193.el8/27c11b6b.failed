net/mlx5e: Do not rewrite fields with the same match

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-193.el8
Rebuild_CHGLOG: - [netdrv] mlx5e: Do not rewrite fields with the same match (Alaa Hleihel) [1724335]
Rebuild_FUZZ: 96.00%
commit-author Eli Britstein <elibr@mellanox.com>
commit 27c11b6b844cd9473330ff29ddb55a535d2dd14a
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-193.el8/27c11b6b.failed

If we have a match for the same value of a rewrite field, there is no
point for the rewrite. In order to save rewrite actions, and avoid
entirely rewrite actions (if all rewrites are the same), ignore such
rewrite fields.

	Signed-off-by: Eli Britstein <elibr@mellanox.com>
	Reviewed-by: Roi Dayan <roid@mellanox.com>
	Signed-off-by: Saeed Mahameed <saeedm@mellanox.com>
(cherry picked from commit 27c11b6b844cd9473330ff29ddb55a535d2dd14a)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlx5/core/en_tc.c
diff --cc drivers/net/ethernet/mellanox/mlx5/core/en_tc.c
index 72ee5c5daa3d,ff9756c3dee5..000000000000
--- a/drivers/net/ethernet/mellanox/mlx5/core/en_tc.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/en_tc.c
@@@ -2888,10 -2894,20 +2950,25 @@@ static int parse_tc_fdb_actions(struct 
  
  	if (hdrs[TCA_PEDIT_KEY_EX_CMD_SET].pedits ||
  	    hdrs[TCA_PEDIT_KEY_EX_CMD_ADD].pedits) {
++<<<<<<< HEAD
 +		err = alloc_tc_pedit_action(priv, MLX5_FLOW_NAMESPACE_FDB,
 +					    parse_attr, hdrs, extack);
++=======
+ 		err = alloc_tc_pedit_action(priv, MLX5_FLOW_NAMESPACE_KERNEL,
+ 					    parse_attr, hdrs, &action, extack);
++>>>>>>> 27c11b6b844c (net/mlx5e: Do not rewrite fields with the same match)
  		if (err)
  			return err;
+ 		/* in case all pedit actions are skipped, remove the MOD_HDR
+ 		 * flag. we might have set split_count either by pedit or
+ 		 * pop/push. if there is no pop/push either, reset it too.
+ 		 */
+ 		if (parse_attr->num_mod_hdr_actions == 0) {
+ 			action &= ~MLX5_FLOW_CONTEXT_ACTION_MOD_HDR;
+ 			if (!((action & MLX5_FLOW_CONTEXT_ACTION_VLAN_POP) ||
+ 			      (action & MLX5_FLOW_CONTEXT_ACTION_VLAN_PUSH)))
+ 				attr->split_count = 0;
+ 		}
  	}
  
  	attr->action = action;
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/en_tc.c
