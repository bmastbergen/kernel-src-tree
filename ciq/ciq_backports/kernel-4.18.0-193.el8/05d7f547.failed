genetlink: do not validate dump requests if there is no policy

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-193.el8
commit-author Michal Kubecek <mkubecek@suse.cz>
commit 05d7f547bea1872e711ee97bd46aace6cf61c42b
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-193.el8/05d7f547.failed

Unlike do requests, dump genetlink requests now perform strict validation
by default even if the genetlink family does not set policy and maxtype
because it does validation and parsing on its own (e.g. because it wants to
allow different message format for different commands). While the null
policy will be ignored, maxtype (which would be zero) is still checked so
that any attribute will fail validation.

The solution is to only call __nla_validate() from genl_family_rcv_msg()
if family->maxtype is set.

Fixes: ef6243acb478 ("genetlink: optionally validate strictly/dumps")
	Signed-off-by: Michal Kubecek <mkubecek@suse.cz>
	Reviewed-by: Johannes Berg <johannes@sipsolutions.net>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 05d7f547bea1872e711ee97bd46aace6cf61c42b)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/netlink/genetlink.c
diff --cc net/netlink/genetlink.c
index f0ec068e1d02,efccd1ac9a66..000000000000
--- a/net/netlink/genetlink.c
+++ b/net/netlink/genetlink.c
@@@ -536,6 -536,28 +536,31 @@@ static int genl_family_rcv_msg(const st
  		if (ops->dumpit == NULL)
  			return -EOPNOTSUPP;
  
++<<<<<<< HEAD
++=======
+ 		if (!(ops->validate & GENL_DONT_VALIDATE_DUMP)) {
+ 			int hdrlen = GENL_HDRLEN + family->hdrsize;
+ 
+ 			if (nlh->nlmsg_len < nlmsg_msg_size(hdrlen))
+ 				return -EINVAL;
+ 
+ 			if (family->maxattr) {
+ 				unsigned int validate = NL_VALIDATE_STRICT;
+ 
+ 				if (ops->validate &
+ 				    GENL_DONT_VALIDATE_DUMP_STRICT)
+ 					validate = NL_VALIDATE_LIBERAL;
+ 				rc = __nla_validate(nlmsg_attrdata(nlh, hdrlen),
+ 						    nlmsg_attrlen(nlh, hdrlen),
+ 						    family->maxattr,
+ 						    family->policy,
+ 						    validate, extack);
+ 				if (rc)
+ 					return rc;
+ 			}
+ 		}
+ 
++>>>>>>> 05d7f547bea1 (genetlink: do not validate dump requests if there is no policy)
  		if (!family->parallel_ops) {
  			struct netlink_dump_control c = {
  				.module = family->module,
* Unmerged path net/netlink/genetlink.c
