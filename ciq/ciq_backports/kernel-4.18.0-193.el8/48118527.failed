RDMA/restrack: Reduce scope of synchronization lock while updating DB

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-193.el8
commit-author Leon Romanovsky <leon@kernel.org>
commit 48118527186fb255461ebf3685ab0f1c2680bd9c
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-193.el8/48118527.failed

XArray uses internal lock for updates to XArray. This means that our
external RW lock is needed to ensure that entry is not deleted while we
are performing iteration over list.

	Signed-off-by: Leon Romanovsky <leonro@mellanox.com>
	Signed-off-by: Jason Gunthorpe <jgg@mellanox.com>
(cherry picked from commit 48118527186fb255461ebf3685ab0f1c2680bd9c)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/core/restrack.c
diff --cc drivers/infiniband/core/restrack.c
index bfd36820ee66,076ef6475df8..000000000000
--- a/drivers/infiniband/core/restrack.c
+++ b/drivers/infiniband/core/restrack.c
@@@ -179,11 -209,12 +179,19 @@@ static void rdma_restrack_add(struct rd
  
  	kref_init(&res->kref);
  	init_completion(&res->comp);
 +	res->valid = true;
  
++<<<<<<< HEAD
 +	down_write(&dev->res.rwsem);
 +	hash_add(dev->res.hash, &res->node, res->type);
 +	up_write(&dev->res.rwsem);
++=======
+ 	ret = rt_xa_alloc_cyclic(&dev->res.xa[res->type], &res->id, res,
+ 				 &dev->res.next_id[res->type]);
+ 
+ 	if (!ret)
+ 		res->valid = true;
++>>>>>>> 48118527186f (RDMA/restrack: Reduce scope of synchronization lock while updating DB)
  }
  
  /**
* Unmerged path drivers/infiniband/core/restrack.c
diff --git a/include/rdma/restrack.h b/include/rdma/restrack.h
index 7e9d9a881f70..4dce601e5ad1 100644
--- a/include/rdma/restrack.h
+++ b/include/rdma/restrack.h
@@ -58,7 +58,8 @@ struct rdma_restrack_entry;
  */
 struct rdma_restrack_root {
 	/*
-	 * @rwsem: Read/write lock to protect lists
+	 * @rwsem: Read/write lock to protect erase of entry.
+	 * Lists and insertions are protected by XArray internal lock.
 	 */
 	struct rw_semaphore	rwsem;
 	/**
