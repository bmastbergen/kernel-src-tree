iommu/vt-d: Reserve a domain id for FL and PT modes

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-193.el8
Rebuild_CHGLOG: - [iommu] vt-d: Reserve a domain id for FL and PT modes (Jerry Snitselaar) [1742234]
Rebuild_FUZZ: 93.75%
commit-author Lu Baolu <baolu.lu@linux.intel.com>
commit 3b33d4ab3217337f648f7ff3e57e755e6444c748
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-193.el8/3b33d4ab.failed

Vt-d spec rev3.0 (section 6.2.3.1) requires that each pasid
entry for first-level or pass-through translation should be
programmed with a domain id different from those used for
second-level or nested translation. It is recommended that
software could use a same domain id for all first-only and
pass-through translations.

This reserves a domain id for first-level and pass-through
translations.

	Cc: Ashok Raj <ashok.raj@intel.com>
	Cc: Jacob Pan <jacob.jun.pan@linux.intel.com>
	Cc: Kevin Tian <kevin.tian@intel.com>
	Cc: Liu Yi L <yi.l.liu@intel.com>
	Cc: Sanjay Kumar <sanjay.k.kumar@intel.com>
	Signed-off-by: Lu Baolu <baolu.lu@linux.intel.com>
	Signed-off-by: Joerg Roedel <jroedel@suse.de>
(cherry picked from commit 3b33d4ab3217337f648f7ff3e57e755e6444c748)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/iommu/intel-pasid.h
diff --cc drivers/iommu/intel-pasid.h
index 1fb5e12b029a,03c1612d173c..000000000000
--- a/drivers/iommu/intel-pasid.h
+++ b/drivers/iommu/intel-pasid.h
@@@ -11,10 -11,24 +11,28 @@@
  #define __INTEL_PASID_H
  
  #define PASID_MIN			0x1
++<<<<<<< HEAD
 +#define PASID_MAX			0x20000
++=======
+ #define PASID_MAX			0x100000
+ #define PASID_PTE_MASK			0x3F
+ #define PASID_PTE_PRESENT		1
+ #define PDE_PFN_MASK			PAGE_MASK
+ #define PASID_PDE_SHIFT			6
+ 
+ /*
+  * Domain ID reserved for pasid entries programmed for first-level
+  * only and pass-through transfer modes.
+  */
+ #define FLPT_DEFAULT_DID		1
+ 
+ struct pasid_dir_entry {
+ 	u64 val;
+ };
++>>>>>>> 3b33d4ab3217 (iommu/vt-d: Reserve a domain id for FL and PT modes)
  
  struct pasid_entry {
 -	u64 val[8];
 +	u64 val;
  };
  
  /* The representative of a PASID table */
diff --git a/drivers/iommu/intel-iommu.c b/drivers/iommu/intel-iommu.c
index adcf92a2e17f..91a341043d0e 100644
--- a/drivers/iommu/intel-iommu.c
+++ b/drivers/iommu/intel-iommu.c
@@ -1644,6 +1644,16 @@ static int iommu_init_domains(struct intel_iommu *iommu)
 	 */
 	set_bit(0, iommu->domain_ids);
 
+	/*
+	 * Vt-d spec rev3.0 (section 6.2.3.1) requires that each pasid
+	 * entry for first-level or pass-through translation modes should
+	 * be programmed with a domain id different from those used for
+	 * second-level or nested translation. We reserve a domain id for
+	 * this purpose.
+	 */
+	if (sm_supported(iommu))
+		set_bit(FLPT_DEFAULT_DID, iommu->domain_ids);
+
 	return 0;
 }
 
* Unmerged path drivers/iommu/intel-pasid.h
