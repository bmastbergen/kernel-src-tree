perf trace: Beautify 'fsconfig' arguments

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-193.el8
commit-author Arnaldo Carvalho de Melo <acme@redhat.com>
commit dcc6fd64f2e9448ccc1c3e1ccd46a9ff5286b861
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-193.el8/dcc6fd64.failed

Use existing beautifiers for the first arg, fd, assigned using the
heuristic that looks for syscall arg names and associates SCA_FD with
'fd' named argumes, and wire up the recently introduced fsconfig cmd
table generator.

Now it should be possible to just use:

   perf trace -e fsconfig

As root and see all fsconfig syscalls with its args beautified, more
work needed to look at the command and according to it handle the 'key',
'value' and 'aux' args, using the 'fcntl' and 'futex' beautifiers as a
starting point to see how to suppress sets of these last three args that
may not be used by the 'cmd' arg, etc.

  # cat sys_fsconfig.c
  #define _GNU_SOURCE         /* See feature_test_macros(7) */
  #include <unistd.h>
  #include <sys/syscall.h>   /* For SYS_xxx definitions */
  #include <fcntl.h>

  #define __NR_fsconfig 431

  enum fsconfig_command {
  	FSCONFIG_SET_FLAG	= 0,	/* Set parameter, supplying no value */
  	FSCONFIG_SET_STRING	= 1,	/* Set parameter, supplying a string value */
  	FSCONFIG_SET_BINARY	= 2,	/* Set parameter, supplying a binary blob value */
  	FSCONFIG_SET_PATH	= 3,	/* Set parameter, supplying an object by path */
  	FSCONFIG_SET_PATH_EMPTY	= 4,	/* Set parameter, supplying an object by (empty) path */
  	FSCONFIG_SET_FD		= 5,	/* Set parameter, supplying an object by fd */
  	FSCONFIG_CMD_CREATE	= 6,	/* Invoke superblock creation */
  	FSCONFIG_CMD_RECONFIGURE = 7,	/* Invoke superblock reconfiguration */
  };

  static inline int sys_fsconfig(int fd, int cmd, const char *key, const void *value, int aux)
  {
  	syscall(__NR_fsconfig, fd, cmd, key, value, aux);
  }

  int main(int argc, char *argv[])
  {
  	int fd = 0, aux = 0;

  	open("/foo", 0);
  	sys_fsconfig(fd++, FSCONFIG_SET_FLAG,	     "/foo1", "/bar1", aux++);
  	sys_fsconfig(fd++, FSCONFIG_SET_STRING,	     "/foo2", "/bar2", aux++);
  	sys_fsconfig(fd++, FSCONFIG_SET_BINARY,	     "/foo3", "/bar3", aux++);
  	sys_fsconfig(fd++, FSCONFIG_SET_PATH,	     "/foo4", "/bar4", aux++);
  	sys_fsconfig(fd++, FSCONFIG_SET_PATH_EMPTY,  "/foo5", "/bar5", aux++);
  	sys_fsconfig(fd++, FSCONFIG_SET_FD,	     "/foo6", "/bar6", aux++);
  	sys_fsconfig(fd++, FSCONFIG_CMD_CREATE,	     "/foo7", "/bar7", aux++);
  	sys_fsconfig(fd++, FSCONFIG_CMD_RECONFIGURE, "/foo8", "/bar8", aux++);
  	return 0;
  }
  # trace -e fsconfig ./sys_fsconfig
  fsconfig(0, FSCONFIG_SET_FLAG, 0x40201b, 0x402015, 0) = -1 EINVAL (Invalid argument)
  fsconfig(1, FSCONFIG_SET_STRING, 0x402027, 0x402021, 1) = -1 EINVAL (Invalid argument)
  fsconfig(2, FSCONFIG_SET_BINARY, 0x402033, 0x40202d, 2) = -1 EINVAL (Invalid argument)
  fsconfig(3, FSCONFIG_SET_PATH, 0x40203f, 0x402039, 3) = -1 EBADF (Bad file descriptor)
  fsconfig(4, FSCONFIG_SET_PATH_EMPTY, 0x40204b, 0x402045, 4) = -1 EBADF (Bad file descriptor)
  fsconfig(5, FSCONFIG_SET_FD, 0x402057, 0x402051, 5) = -1 EINVAL (Invalid argument)
  fsconfig(6, FSCONFIG_CMD_CREATE, 0x402063, 0x40205d, 6) = -1 EINVAL (Invalid argument)
  fsconfig(7, FSCONFIG_CMD_RECONFIGURE, 0x40206f, 0x402069, 7) = -1 EINVAL (Invalid argument)
  #

	Cc: Adrian Hunter <adrian.hunter@intel.com>
	Cc: Al Viro <viro@zeniv.linux.org.uk>
	Cc: Brendan Gregg <brendan.d.gregg@gmail.com>
	Cc: Jiri Olsa <jolsa@kernel.org>
	Cc: Luis Cláudio Gonçalves <lclaudio@redhat.com>
	Cc: Namhyung Kim <namhyung@kernel.org>
Link: https://lkml.kernel.org/n/tip-fb04b76cm59zfuv1wzu40uxy@git.kernel.org
	Signed-off-by: Arnaldo Carvalho de Melo <acme@redhat.com>
(cherry picked from commit dcc6fd64f2e9448ccc1c3e1ccd46a9ff5286b861)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/perf/Makefile.perf
#	tools/perf/builtin-trace.c
diff --cc tools/perf/Makefile.perf
index 06b927ee6ee3,22e92a9ee871..000000000000
--- a/tools/perf/Makefile.perf
+++ b/tools/perf/Makefile.perf
@@@ -419,6 -419,18 +419,21 @@@ fadvise_advice_tbl := $(srctree)/tools/
  $(fadvise_advice_array): $(linux_uapi_dir)/in.h $(fadvise_advice_tbl)
  	$(Q)$(SHELL) '$(fadvise_advice_tbl)' $(linux_uapi_dir) > $@
  
++<<<<<<< HEAD
++=======
+ fspick_arrays := $(beauty_outdir)/fspick_arrays.c
+ fspick_tbls := $(srctree)/tools/perf/trace/beauty/fspick.sh
+ 
+ $(fspick_arrays): $(linux_uapi_dir)/fs.h $(fspick_tbls)
+ 	$(Q)$(SHELL) '$(fspick_tbls)' $(linux_uapi_dir) > $@
+ 
+ fsconfig_arrays := $(beauty_outdir)/fsconfig_arrays.c
+ fsconfig_tbls := $(srctree)/tools/perf/trace/beauty/fsconfig.sh
+ 
+ $(fsconfig_arrays): $(linux_uapi_dir)/fs.h $(fsconfig_tbls)
+ 	$(Q)$(SHELL) '$(fsconfig_tbls)' $(linux_uapi_dir) > $@
+ 
++>>>>>>> dcc6fd64f2e9 (perf trace: Beautify 'fsconfig' arguments)
  pkey_alloc_access_rights_array := $(beauty_outdir)/pkey_alloc_access_rights_array.c
  asm_generic_hdr_dir := $(srctree)/tools/include/uapi/asm-generic/
  pkey_alloc_access_rights_tbl := $(srctree)/tools/perf/trace/beauty/pkey_alloc_access_rights.sh
@@@ -628,6 -646,8 +643,11 @@@ build-dir   = $(if $(__build-dir),$(__b
  
  prepare: $(OUTPUT)PERF-VERSION-FILE $(OUTPUT)common-cmds.h archheaders $(drm_ioctl_array) \
  	$(fadvise_advice_array) \
++<<<<<<< HEAD
++=======
+ 	$(fsconfig_arrays) \
+ 	$(fspick_arrays) \
++>>>>>>> dcc6fd64f2e9 (perf trace: Beautify 'fsconfig' arguments)
  	$(pkey_alloc_access_rights_array) \
  	$(sndrv_pcm_ioctl_array) \
  	$(sndrv_ctl_ioctl_array) \
@@@ -922,6 -943,8 +942,11 @@@ clean:: $(LIBTRACEEVENT)-clean $(LIBAPI
  		$(OUTPUT)tests/llvm-src-{base,kbuild,prologue,relocation}.c \
  		$(OUTPUT)pmu-events/pmu-events.c \
  		$(OUTPUT)$(fadvise_advice_array) \
++<<<<<<< HEAD
++=======
+ 		$(OUTPUT)$(fsconfig_arrays) \
+ 		$(OUTPUT)$(fspick_arrays) \
++>>>>>>> dcc6fd64f2e9 (perf trace: Beautify 'fsconfig' arguments)
  		$(OUTPUT)$(madvise_behavior_array) \
  		$(OUTPUT)$(mmap_flags_array) \
  		$(OUTPUT)$(mount_flags_array) \
diff --cc tools/perf/builtin-trace.c
index f5b3a1e9c1dd,87b6dd3c33f5..000000000000
--- a/tools/perf/builtin-trace.c
+++ b/tools/perf/builtin-trace.c
@@@ -713,6 -717,12 +717,15 @@@ static struct syscall_fmt 
  		   [2] = { .scnprintf =  SCA_FCNTL_ARG, /* arg */ }, }, },
  	{ .name	    = "flock",
  	  .arg = { [1] = { .scnprintf = SCA_FLOCK, /* cmd */ }, }, },
++<<<<<<< HEAD
++=======
+ 	{ .name     = "fsconfig",
+ 	  .arg = { [1] = STRARRAY(cmd, fsconfig_cmds), }, },
+ 	{ .name     = "fspick",
+ 	  .arg = { [0] = { .scnprintf = SCA_FDAT,	  /* dfd */ },
+ 		   [1] = { .scnprintf = SCA_FILENAME,	  /* path */ },
+ 		   [2] = { .scnprintf = SCA_FSPICK_FLAGS, /* flags */ }, }, },
++>>>>>>> dcc6fd64f2e9 (perf trace: Beautify 'fsconfig' arguments)
  	{ .name	    = "fstat", .alias = "newfstat", },
  	{ .name	    = "fstatat", .alias = "newfstatat", },
  	{ .name	    = "futex",
* Unmerged path tools/perf/Makefile.perf
* Unmerged path tools/perf/builtin-trace.c
