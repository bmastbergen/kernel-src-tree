blk-mq: simplify blk_mq_make_request()

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-193.el8
commit-author Bart Van Assche <bvanassche@acm.org>
commit 970d168de636ddac8221cbd4a11d7678943e7379
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-193.el8/970d168d.failed

Move the blk_mq_bio_to_request() call in front of the if-statement.

	Cc: Hannes Reinecke <hare@suse.com>
	Cc: Omar Sandoval <osandov@fb.com>
	Reviewed-by: Minwoo Im <minwoo.im.dev@gmail.com>
	Reviewed-by: Christoph Hellwig <hch@lst.de>
	Reviewed-by: Ming Lei <ming.lei@redhat.com>
	Signed-off-by: Bart Van Assche <bvanassche@acm.org>
	Signed-off-by: Jens Axboe <axboe@kernel.dk>
(cherry picked from commit 970d168de636ddac8221cbd4a11d7678943e7379)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	block/blk-mq.c
diff --cc block/blk-mq.c
index 49d6c08f6c9f,e5ef40c603ca..000000000000
--- a/block/blk-mq.c
+++ b/block/blk-mq.c
@@@ -1972,11 -1971,10 +1972,16 @@@ static blk_qc_t blk_mq_make_request(str
  
  	cookie = request_to_qc_t(data.hctx, rq);
  
+ 	blk_mq_bio_to_request(rq, bio, nr_segs);
+ 
  	plug = current->plug;
  	if (unlikely(is_flush_fua)) {
++<<<<<<< HEAD
 +		blk_mq_put_ctx(data.ctx);
 +		blk_mq_bio_to_request(rq, bio);
 +
++=======
++>>>>>>> 970d168de636 (blk-mq: simplify blk_mq_make_request())
  		/* bypass scheduler for flush rq */
  		blk_insert_flush(rq);
  		blk_mq_run_hw_queue(data.hctx, true);
@@@ -1988,9 -1986,6 +1993,12 @@@
  		unsigned int request_count = plug->rq_count;
  		struct request *last = NULL;
  
++<<<<<<< HEAD
 +		blk_mq_put_ctx(data.ctx);
 +		blk_mq_bio_to_request(rq, bio);
 +
++=======
++>>>>>>> 970d168de636 (blk-mq: simplify blk_mq_make_request())
  		if (!request_count)
  			trace_block_plug(q);
  		else
@@@ -2004,8 -1999,6 +2012,11 @@@
  
  		blk_add_rq_to_plug(plug, rq);
  	} else if (plug && !blk_queue_nomerges(q)) {
++<<<<<<< HEAD
 +		blk_mq_bio_to_request(rq, bio);
 +
++=======
++>>>>>>> 970d168de636 (blk-mq: simplify blk_mq_make_request())
  		/*
  		 * We do limited plugging. If the bio can be merged, do that.
  		 * Otherwise the existing request in the plug list will be
@@@ -2032,12 -2023,8 +2043,17 @@@
  		}
  	} else if ((q->nr_hw_queues > 1 && is_sync) || (!q->elevator &&
  			!data.hctx->dispatch_busy)) {
++<<<<<<< HEAD
 +		blk_mq_put_ctx(data.ctx);
 +		blk_mq_bio_to_request(rq, bio);
  		blk_mq_try_issue_directly(data.hctx, rq, &cookie);
  	} else {
 +		blk_mq_put_ctx(data.ctx);
 +		blk_mq_bio_to_request(rq, bio);
++=======
++		blk_mq_try_issue_directly(data.hctx, rq, &cookie);
++	} else {
++>>>>>>> 970d168de636 (blk-mq: simplify blk_mq_make_request())
  		blk_mq_sched_insert_request(rq, false, true, true);
  	}
  
* Unmerged path block/blk-mq.c
