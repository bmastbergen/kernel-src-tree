nl80211: Disallow setting of HT for channel 14

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-193.el8
commit-author Masashi Honma <masashi.honma@gmail.com>
commit ec649fed66bb242cca145ab364485c5a126efc53
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-193.el8/ec649fed.failed

This patch disables setting of HT20 and more for channel 14 because
the channel is only for IEEE 802.11b.

The patch for net/wireless/util.c was unit-tested.

The patch for net/wireless/chan.c was tested with iw command.

Before this patch.
$ sudo iw dev <ifname> set channel 14 HT20
$

After this patch.
$ sudo iw dev <ifname> set channel 14 HT20
kernel reports: invalid channel definition
command failed: Invalid argument (-22)
$

	Signed-off-by: Masashi Honma <masashi.honma@gmail.com>
Link: https://lore.kernel.org/r/20191021075045.2719-1-masashi.honma@gmail.com
[clean up the code, use != instead of equivalent >]
	Signed-off-by: Johannes Berg <johannes.berg@intel.com>
(cherry picked from commit ec649fed66bb242cca145ab364485c5a126efc53)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/wireless/chan.c
diff --cc net/wireless/chan.c
index 7c9d204838d4,fcac5c6366e1..000000000000
--- a/net/wireless/chan.c
+++ b/net/wireless/chan.c
@@@ -112,6 -204,15 +112,18 @@@ bool cfg80211_chandef_valid(const struc
  		return false;
  	}
  
++<<<<<<< HEAD
++=======
+ 	/* channel 14 is only for IEEE 802.11b */
+ 	if (chandef->center_freq1 == 2484 &&
+ 	    chandef->width != NL80211_CHAN_WIDTH_20_NOHT)
+ 		return false;
+ 
+ 	if (cfg80211_chandef_is_edmg(chandef) &&
+ 	    !cfg80211_edmg_chandef_valid(chandef))
+ 		return false;
+ 
++>>>>>>> ec649fed66bb (nl80211: Disallow setting of HT for channel 14)
  	return true;
  }
  EXPORT_SYMBOL(cfg80211_chandef_valid);
* Unmerged path net/wireless/chan.c
diff --git a/net/wireless/util.c b/net/wireless/util.c
index e1579a104c07..b4b47b64ab4c 100644
--- a/net/wireless/util.c
+++ b/net/wireless/util.c
@@ -1509,7 +1509,8 @@ bool ieee80211_chandef_to_operating_class(struct cfg80211_chan_def *chandef,
 	}
 
 	if (freq == 2484) {
-		if (chandef->width > NL80211_CHAN_WIDTH_40)
+		/* channel 14 is only for IEEE 802.11b */
+		if (chandef->width != NL80211_CHAN_WIDTH_20_NOHT)
 			return false;
 
 		*op_class = 82; /* channel 14 */
