powerpc/fsl: Add nospectre_v2 command line argument

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-193.el8
Rebuild_CHGLOG: - [powerpc] fsl: Add nospectre_v2 command line argument (Gustavo Duarte) [1777686]
Rebuild_FUZZ: 91.49%
commit-author Diana Craciun <diana.craciun@nxp.com>
commit f633a8ad636efb5d4bba1a047d4a0f1ef719aa06
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-193.el8/f633a8ad.failed

When the command line argument is present, the Spectre variant 2
mitigations are disabled.

	Signed-off-by: Diana Craciun <diana.craciun@nxp.com>
	Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
(cherry picked from commit f633a8ad636efb5d4bba1a047d4a0f1ef719aa06)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/powerpc/include/asm/setup.h
diff --cc arch/powerpc/include/asm/setup.h
index 1fffbba8d6a5,65676e2325b8..000000000000
--- a/arch/powerpc/include/asm/setup.h
+++ b/arch/powerpc/include/asm/setup.h
@@@ -67,6 -67,13 +67,16 @@@ void do_barrier_nospec_fixups_range(boo
  static inline void do_barrier_nospec_fixups_range(bool enable, void *start, void *end) { };
  #endif
  
++<<<<<<< HEAD
++=======
+ #ifdef CONFIG_PPC_FSL_BOOK3E
+ void setup_spectre_v2(void);
+ #else
+ static inline void setup_spectre_v2(void) {};
+ #endif
+ void do_btb_flush_fixups(void);
+ 
++>>>>>>> f633a8ad636e (powerpc/fsl: Add nospectre_v2 command line argument)
  #endif /* !__ASSEMBLY__ */
  
  #endif	/* _ASM_POWERPC_SETUP_H */
* Unmerged path arch/powerpc/include/asm/setup.h
diff --git a/arch/powerpc/kernel/security.c b/arch/powerpc/kernel/security.c
index d465307cccdd..97ffe686ea4f 100644
--- a/arch/powerpc/kernel/security.c
+++ b/arch/powerpc/kernel/security.c
@@ -27,6 +27,10 @@ static enum count_cache_flush_type count_cache_flush_type = COUNT_CACHE_FLUSH_NO
 
 bool barrier_nospec_enabled;
 static bool no_nospec;
+static bool btb_flush_enabled;
+#ifdef CONFIG_PPC_FSL_BOOK3E
+static bool no_spectrev2;
+#endif
 
 static void enable_barrier_nospec(bool enable)
 {
@@ -102,6 +106,23 @@ static __init int barrier_nospec_debugfs_init(void)
 device_initcall(barrier_nospec_debugfs_init);
 #endif /* CONFIG_DEBUG_FS */
 
+#ifdef CONFIG_PPC_FSL_BOOK3E
+static int __init handle_nospectre_v2(char *p)
+{
+	no_spectrev2 = true;
+
+	return 0;
+}
+early_param("nospectre_v2", handle_nospectre_v2);
+void setup_spectre_v2(void)
+{
+	if (no_spectrev2)
+		do_btb_flush_fixups();
+	else
+		btb_flush_enabled = true;
+}
+#endif /* CONFIG_PPC_FSL_BOOK3E */
+
 #ifdef CONFIG_PPC_BOOK3S_64
 ssize_t cpu_show_meltdown(struct device *dev, struct device_attribute *attr, char *buf)
 {
