powerpc/pseries: Move mm/book3s64/vphn.c under platforms/pseries/

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-193.el8
Rebuild_CHGLOG: - [powerpc] pseries: Move mm/book3s64/vphn.c under platforms/pseries/ (Gustavo Duarte) [1723870]
Rebuild_FUZZ: 93.44%
commit-author Naveen N. Rao <naveen.n.rao@linux.vnet.ibm.com>
commit 5a1ea4774ddc2c6bc3ba1415880091eccf1a901e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-193.el8/5a1ea477.failed

hcall_vphn() is specific to pseries and will be used in a subsequent
patch. So, move it to a more appropriate place under
arch/powerpc/platforms/pseries. Also merge vphn.h into lppaca.h
and update vphn selftest to use the new files.

	Signed-off-by: Naveen N. Rao <naveen.n.rao@linux.vnet.ibm.com>
	Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
(cherry picked from commit 5a1ea4774ddc2c6bc3ba1415880091eccf1a901e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/powerpc/mm/book3s64/Makefile
#	arch/powerpc/mm/book3s64/vphn.c
#	arch/powerpc/mm/numa.c
#	arch/powerpc/mm/vphn.c
#	arch/powerpc/mm/vphn.h
#	arch/powerpc/platforms/pseries/vphn.c
#	tools/testing/selftests/powerpc/vphn/vphn.c
#	tools/testing/selftests/powerpc/vphn/vphn.h
diff --cc arch/powerpc/mm/numa.c
index 935a8bc08267,50fadc99897b..000000000000
--- a/arch/powerpc/mm/numa.c
+++ b/arch/powerpc/mm/numa.c
@@@ -1073,9 -1067,6 +1073,12 @@@ u64 memory_hotplug_max(void
  
  /* Virtual Processor Home Node (VPHN) support */
  #ifdef CONFIG_PPC_SPLPAR
++<<<<<<< HEAD
 +
 +#include "vphn.h"
 +
++=======
++>>>>>>> 5a1ea4774ddc (powerpc/pseries: Move mm/book3s64/vphn.c under platforms/pseries/)
  struct topology_update_data {
  	struct topology_update_data *next;
  	unsigned int cpu;
diff --cc tools/testing/selftests/powerpc/vphn/vphn.c
index 186b906e66d5,5b5fbddccabd..000000000000
--- a/tools/testing/selftests/powerpc/vphn/vphn.c
+++ b/tools/testing/selftests/powerpc/vphn/vphn.c
* Unmerged path arch/powerpc/mm/book3s64/Makefile
* Unmerged path arch/powerpc/mm/book3s64/vphn.c
* Unmerged path arch/powerpc/mm/vphn.c
* Unmerged path arch/powerpc/mm/vphn.h
* Unmerged path arch/powerpc/platforms/pseries/vphn.c
* Unmerged path tools/testing/selftests/powerpc/vphn/vphn.h
diff --git a/arch/powerpc/include/asm/lppaca.h b/arch/powerpc/include/asm/lppaca.h
index e45b7293414d..f5195b4d9ffb 100644
--- a/arch/powerpc/include/asm/lppaca.h
+++ b/arch/powerpc/include/asm/lppaca.h
@@ -18,6 +18,29 @@
  */
 #ifndef _ASM_POWERPC_LPPACA_H
 #define _ASM_POWERPC_LPPACA_H
+
+/*
+ * The below VPHN macros are outside the __KERNEL__ check since these are
+ * used for compiling the vphn selftest in userspace
+ */
+
+/* The H_HOME_NODE_ASSOCIATIVITY h_call returns 6 64-bit registers. */
+#define VPHN_REGISTER_COUNT 6
+
+/*
+ * 6 64-bit registers unpacked into up to 24 be32 associativity values. To
+ * form the complete property we have to add the length in the first cell.
+ */
+#define VPHN_ASSOC_BUFSIZE (VPHN_REGISTER_COUNT*sizeof(u64)/sizeof(u16) + 1)
+
+/*
+ * The H_HOME_NODE_ASSOCIATIVITY hcall takes two values for flags:
+ * 1 for retrieving associativity information for a guest cpu
+ * 2 for retrieving associativity information for a host/hypervisor cpu
+ */
+#define VPHN_FLAG_VCPU	1
+#define VPHN_FLAG_PCPU	2
+
 #ifdef __KERNEL__
 
 /*
@@ -179,6 +202,7 @@ extern void (*dtl_consumer)(struct dtl_entry *entry, u64 index);
 
 extern void register_dtl_buffer(int cpu);
 extern void alloc_dtl_buffers(void);
+extern long hcall_vphn(unsigned long cpu, u64 flags, __be32 *associativity);
 
 #endif /* CONFIG_PPC_BOOK3S */
 #endif /* __KERNEL__ */
* Unmerged path arch/powerpc/mm/book3s64/Makefile
* Unmerged path arch/powerpc/mm/book3s64/vphn.c
* Unmerged path arch/powerpc/mm/numa.c
* Unmerged path arch/powerpc/mm/vphn.c
* Unmerged path arch/powerpc/mm/vphn.h
diff --git a/arch/powerpc/platforms/pseries/Makefile b/arch/powerpc/platforms/pseries/Makefile
index a43ec843c8e2..ab3d59aeacca 100644
--- a/arch/powerpc/platforms/pseries/Makefile
+++ b/arch/powerpc/platforms/pseries/Makefile
@@ -25,6 +25,7 @@ obj-$(CONFIG_LPARCFG)		+= lparcfg.o
 obj-$(CONFIG_IBMVIO)		+= vio.o
 obj-$(CONFIG_IBMEBUS)		+= ibmebus.o
 obj-$(CONFIG_PAPR_SCM)		+= papr_scm.o
+obj-$(CONFIG_PPC_SPLPAR)	+= vphn.o
 
 ifdef CONFIG_PPC_PSERIES
 obj-$(CONFIG_SUSPEND)		+= suspend.o
* Unmerged path arch/powerpc/platforms/pseries/vphn.c
diff --git a/tools/testing/selftests/powerpc/vphn/Makefile b/tools/testing/selftests/powerpc/vphn/Makefile
index fb82068c9fda..26e147431036 100644
--- a/tools/testing/selftests/powerpc/vphn/Makefile
+++ b/tools/testing/selftests/powerpc/vphn/Makefile
@@ -1,6 +1,6 @@
 TEST_GEN_PROGS := test-vphn
 
-CFLAGS += -m64
+CFLAGS += -m64 -I$(CURDIR)
 
 top_srcdir = ../../../../..
 include ../../lib.mk
diff --git a/tools/testing/selftests/powerpc/vphn/asm/lppaca.h b/tools/testing/selftests/powerpc/vphn/asm/lppaca.h
new file mode 120000
index 000000000000..942b1d00999c
--- /dev/null
+++ b/tools/testing/selftests/powerpc/vphn/asm/lppaca.h
@@ -0,0 +1 @@
+../../../../../../arch/powerpc/include/asm/lppaca.h
\ No newline at end of file
* Unmerged path tools/testing/selftests/powerpc/vphn/vphn.c
* Unmerged path tools/testing/selftests/powerpc/vphn/vphn.h
