mm/gup: add FOLL_LONGTERM capability to GUP fast

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-193.el8
commit-author Ira Weiny <ira.weiny@intel.com>
commit 7af75561e17132b20b5bc047d222f34b3e7a3e6e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-193.el8/7af75561.failed

DAX pages were previously unprotected from longterm pins when users called
get_user_pages_fast().

Use the new FOLL_LONGTERM flag to check for DEVMAP pages and fall back to
regular GUP processing if a DEVMAP page is encountered.

[ira.weiny@intel.com: v3]
  Link: http://lkml.kernel.org/r/20190328084422.29911-5-ira.weiny@intel.com
Link: http://lkml.kernel.org/r/20190328084422.29911-5-ira.weiny@intel.com
Link: http://lkml.kernel.org/r/20190317183438.2057-5-ira.weiny@intel.com
	Signed-off-by: Ira Weiny <ira.weiny@intel.com>
	Reviewed-by: Andrew Morton <akpm@linux-foundation.org>
	Cc: Aneesh Kumar K.V <aneesh.kumar@linux.ibm.com>
	Cc: Benjamin Herrenschmidt <benh@kernel.crashing.org>
	Cc: Borislav Petkov <bp@alien8.de>
	Cc: Dan Williams <dan.j.williams@intel.com>
	Cc: "David S. Miller" <davem@davemloft.net>
	Cc: Heiko Carstens <heiko.carstens@de.ibm.com>
	Cc: Ingo Molnar <mingo@redhat.com>
	Cc: James Hogan <jhogan@kernel.org>
	Cc: Jason Gunthorpe <jgg@ziepe.ca>
	Cc: John Hubbard <jhubbard@nvidia.com>
	Cc: "Kirill A. Shutemov" <kirill.shutemov@linux.intel.com>
	Cc: Martin Schwidefsky <schwidefsky@de.ibm.com>
	Cc: Michal Hocko <mhocko@kernel.org>
	Cc: Paul Mackerras <paulus@samba.org>
	Cc: Peter Zijlstra <peterz@infradead.org>
	Cc: Ralf Baechle <ralf@linux-mips.org>
	Cc: Rich Felker <dalias@libc.org>
	Cc: Thomas Gleixner <tglx@linutronix.de>
	Cc: Yoshinori Sato <ysato@users.sourceforge.jp>
	Cc: Mike Marshall <hubcap@omnibond.com>
	Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
	Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
(cherry picked from commit 7af75561e17132b20b5bc047d222f34b3e7a3e6e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	mm/gup.c
diff --cc mm/gup.c
index 8b7fa3004551,8e0a0a3a2b2d..000000000000
--- a/mm/gup.c
+++ b/mm/gup.c
@@@ -2060,8 -2135,8 +2092,13 @@@ int get_user_pages_fast(unsigned long s
  		start += nr << PAGE_SHIFT;
  		pages += nr;
  
++<<<<<<< HEAD
 +		ret = get_user_pages_unlocked(start, nr_pages - nr, pages,
 +				write ? FOLL_WRITE : 0);
++=======
+ 		ret = __gup_longterm_unlocked(start, nr_pages - nr,
+ 					      gup_flags, pages);
++>>>>>>> 7af75561e171 (mm/gup: add FOLL_LONGTERM capability to GUP fast)
  
  		/* Have to be a bit careful with return values */
  		if (nr > 0) {
* Unmerged path mm/gup.c
