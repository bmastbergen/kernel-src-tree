iommu/amd: Move gart fallback to amd_iommu_init

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-193.el8
Rebuild_CHGLOG: - [iommu] amd: Move gart fallback to amd_iommu_init (Jerry Snitselaar) [1742234]
Rebuild_FUZZ: 93.18%
commit-author Kevin Mitchell <kevmitch@arista.com>
commit bf4bff46eac151c3fd299741d71c4216e45b5d8b
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-193.el8/bf4bff46.failed

The fallback to the GART driver in the case amd_iommu doesn't work was
executed in a function called free_iommu_resources, which didn't really
make sense. This was even being called twice if amd_iommu=off was
specified on the command line.

The only complication is that it needs to be verified that amd_iommu has
fully relinquished control by calling free_iommu_resources and emptying
the amd_iommu_list.

	Signed-off-by: Kevin Mitchell <kevmitch@arista.com>
	Signed-off-by: Joerg Roedel <jroedel@suse.de>
(cherry picked from commit bf4bff46eac151c3fd299741d71c4216e45b5d8b)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/iommu/amd_iommu_init.c
diff --cc drivers/iommu/amd_iommu_init.c
index c1c77340a209,b90e26effe0a..000000000000
--- a/drivers/iommu/amd_iommu_init.c
+++ b/drivers/iommu/amd_iommu_init.c
@@@ -2844,6 -2758,19 +2835,22 @@@ static int __init amd_iommu_init(void
  		}
  	}
  
++<<<<<<< HEAD
++=======
+ #ifdef CONFIG_GART_IOMMU
+ 	if (ret && list_empty(&amd_iommu_list)) {
+ 		/*
+ 		 * We failed to initialize the AMD IOMMU - try fallback
+ 		 * to GART if possible.
+ 		 */
+ 		gart_iommu_init();
+ 	}
+ #endif
+ 
+ 	for_each_iommu(iommu)
+ 		amd_iommu_debugfs_setup(iommu);
+ 
++>>>>>>> bf4bff46eac1 (iommu/amd: Move gart fallback to amd_iommu_init)
  	return ret;
  }
  
* Unmerged path drivers/iommu/amd_iommu_init.c
