drm: Free the writeback_job when it with an empty fb

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-193.el8
commit-author Lowry Li (Arm Technology China) <Lowry.Li@arm.com>
commit 8581d51055a08cc6eb061c8856062290e8582ce4
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-193.el8/8581d510.failed

Adds the check if the writeback_job with an empty fb, then it should
be freed in atomic_check phase.

With this change, the driver users will not check empty fb case any more.
So refined accordingly.

	Signed-off-by: Lowry Li (Arm Technology China) <lowry.li@arm.com>
	Reviewed-by: Liviu Dudau <liviu.dudau@arm.com>
	Reviewed-by: James Qian Wang (Arm Technology China) <james.qian.wang@arm.com>
	Signed-off-by: james qian wang (Arm Technology China) <james.qian.wang@arm.com>
Link: https://patchwork.freedesktop.org/patch/msgid/1564571048-15029-2-git-send-email-lowry.li@arm.com
(cherry picked from commit 8581d51055a08cc6eb061c8856062290e8582ce4)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/gpu/drm/arm/display/komeda/komeda_wb_connector.c
#	drivers/gpu/drm/arm/malidp_mw.c
#	drivers/gpu/drm/rcar-du/rcar_du_writeback.c
#	drivers/gpu/drm/vc4/vc4_txp.c
* Unmerged path drivers/gpu/drm/arm/display/komeda/komeda_wb_connector.c
* Unmerged path drivers/gpu/drm/arm/malidp_mw.c
* Unmerged path drivers/gpu/drm/rcar-du/rcar_du_writeback.c
* Unmerged path drivers/gpu/drm/vc4/vc4_txp.c
* Unmerged path drivers/gpu/drm/arm/display/komeda/komeda_wb_connector.c
* Unmerged path drivers/gpu/drm/arm/malidp_mw.c
diff --git a/drivers/gpu/drm/drm_atomic.c b/drivers/gpu/drm/drm_atomic.c
index 5eb40130fafb..3a3cf463e02c 100644
--- a/drivers/gpu/drm/drm_atomic.c
+++ b/drivers/gpu/drm/drm_atomic.c
@@ -424,10 +424,15 @@ static int drm_atomic_connector_check(struct drm_connector *connector,
 		return -EINVAL;
 	}
 
-	if (writeback_job->out_fence && !writeback_job->fb) {
-		DRM_DEBUG_ATOMIC("[CONNECTOR:%d:%s] requesting out-fence without framebuffer\n",
-				 connector->base.id, connector->name);
-		return -EINVAL;
+	if (!writeback_job->fb) {
+		if (writeback_job->out_fence) {
+			DRM_DEBUG_ATOMIC("[CONNECTOR:%d:%s] requesting out-fence without framebuffer\n",
+					 connector->base.id, connector->name);
+			return -EINVAL;
+		}
+
+		drm_writeback_cleanup_job(writeback_job);
+		state->writeback_job = NULL;
 	}
 
 	return 0;
* Unmerged path drivers/gpu/drm/rcar-du/rcar_du_writeback.c
* Unmerged path drivers/gpu/drm/vc4/vc4_txp.c
