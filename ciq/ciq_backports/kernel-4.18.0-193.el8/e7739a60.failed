net/mlx5e: Fix possible modify header actions memory leak

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-193.el8
Rebuild_CHGLOG: - [netdrv] mlx5e: Fix possible modify header actions memory leak (Alaa Hleihel) [1724335]
Rebuild_FUZZ: 96.36%
commit-author Eli Britstein <elibr@mellanox.com>
commit e7739a60712a041516f74c8917a0b3e5f1e4f01e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-193.el8/e7739a60.failed

The cited commit could disable the modify header flag, but did not free
the allocated memory for the modify header actions. Fix it.

Fixes: 27c11b6b844cd ("net/mlx5e: Do not rewrite fields with the same match")
	Signed-off-by: Eli Britstein <elibr@mellanox.com>
	Reviewed-by: Roi Dayan <roid@mellanox.com>
	Signed-off-by: Saeed Mahameed <saeedm@mellanox.com>
(cherry picked from commit e7739a60712a041516f74c8917a0b3e5f1e4f01e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlx5/core/en_tc.c
diff --cc drivers/net/ethernet/mellanox/mlx5/core/en_tc.c
index f1e908e953ff,31cd02f11499..000000000000
--- a/drivers/net/ethernet/mellanox/mlx5/core/en_tc.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/en_tc.c
@@@ -2495,9 -2561,16 +2495,19 @@@ static int parse_tc_nic_actions(struct 
  	if (hdrs[TCA_PEDIT_KEY_EX_CMD_SET].pedits ||
  	    hdrs[TCA_PEDIT_KEY_EX_CMD_ADD].pedits) {
  		err = alloc_tc_pedit_action(priv, MLX5_FLOW_NAMESPACE_KERNEL,
 -					    parse_attr, hdrs, &action, extack);
 +					    parse_attr, hdrs, extack);
  		if (err)
  			return err;
++<<<<<<< HEAD
++=======
+ 		/* in case all pedit actions are skipped, remove the MOD_HDR
+ 		 * flag.
+ 		 */
+ 		if (parse_attr->num_mod_hdr_actions == 0) {
+ 			action &= ~MLX5_FLOW_CONTEXT_ACTION_MOD_HDR;
+ 			kfree(parse_attr->mod_hdr_actions);
+ 		}
++>>>>>>> e7739a60712a (net/mlx5e: Fix possible modify header actions memory leak)
  	}
  
  	attr->action = action;
@@@ -2925,9 -2998,20 +2935,23 @@@ static int parse_tc_fdb_actions(struct 
  	if (hdrs[TCA_PEDIT_KEY_EX_CMD_SET].pedits ||
  	    hdrs[TCA_PEDIT_KEY_EX_CMD_ADD].pedits) {
  		err = alloc_tc_pedit_action(priv, MLX5_FLOW_NAMESPACE_FDB,
 -					    parse_attr, hdrs, &action, extack);
 +					    parse_attr, hdrs, extack);
  		if (err)
  			return err;
++<<<<<<< HEAD
++=======
+ 		/* in case all pedit actions are skipped, remove the MOD_HDR
+ 		 * flag. we might have set split_count either by pedit or
+ 		 * pop/push. if there is no pop/push either, reset it too.
+ 		 */
+ 		if (parse_attr->num_mod_hdr_actions == 0) {
+ 			action &= ~MLX5_FLOW_CONTEXT_ACTION_MOD_HDR;
+ 			kfree(parse_attr->mod_hdr_actions);
+ 			if (!((action & MLX5_FLOW_CONTEXT_ACTION_VLAN_POP) ||
+ 			      (action & MLX5_FLOW_CONTEXT_ACTION_VLAN_PUSH)))
+ 				attr->split_count = 0;
+ 		}
++>>>>>>> e7739a60712a (net/mlx5e: Fix possible modify header actions memory leak)
  	}
  
  	attr->action = action;
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/en_tc.c
