printk: Split the code for storing a message into the log buffer

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-193.el8
commit-author Petr Mladek <pmladek@suse.com>
commit ba552399954dde1b388f7749fecad5c349216981
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-193.el8/ba552399.failed

It is just a preparation step. The patch does not change
the existing behavior.

Link: http://lkml.kernel.org/r/20180627140817.27764-2-pmladek@suse.com
To: Steven Rostedt <rostedt@goodmis.org>
	Cc: Peter Zijlstra <peterz@infradead.org>
	Cc: Tetsuo Handa <penguin-kernel@I-love.SAKURA.ne.jp>
	Cc: Sergey Senozhatsky <sergey.senozhatsky.work@gmail.com>
	Cc: linux-kernel@vger.kernel.org
	Cc: stable@vger.kernel.org
	Acked-by: Sergey Senozhatsky <sergey.senozhatsky@gmail.com>
	Signed-off-by: Petr Mladek <pmladek@suse.com>
(cherry picked from commit ba552399954dde1b388f7749fecad5c349216981)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	kernel/printk/printk.c
diff --cc kernel/printk/printk.c
index 51ead2145c03,a844c611b17c..000000000000
--- a/kernel/printk/printk.c
+++ b/kernel/printk/printk.c
@@@ -1897,11 -1874,29 +1885,36 @@@ int vprintk_store(int facility, int lev
  	if (dict)
  		lflags |= LOG_PREFIX|LOG_NEWLINE;
  
++<<<<<<< HEAD
 +	if (suppress_message_printing(level))
 +		lflags |= LOG_NOCONS;
 +
 +	printed_len = log_output(facility, level, lflags, dict, dictlen, text, text_len);
++=======
+ 	return log_output(facility, level, lflags,
+ 			  dict, dictlen, text, text_len);
+ }
++>>>>>>> ba552399954d (printk: Split the code for storing a message into the log buffer)
  
+ asmlinkage int vprintk_emit(int facility, int level,
+ 			    const char *dict, size_t dictlen,
+ 			    const char *fmt, va_list args)
+ {
+ 	int printed_len;
+ 	bool in_sched = false;
+ 	unsigned long flags;
+ 
+ 	if (level == LOGLEVEL_SCHED) {
+ 		level = LOGLEVEL_DEFAULT;
+ 		in_sched = true;
+ 	}
+ 
+ 	boot_delay_msec(level);
+ 	printk_delay();
+ 
+ 	/* This stops the holder of console_sem just where we want him */
+ 	logbuf_lock_irqsave(flags);
+ 	printed_len = vprintk_store(facility, level, dict, dictlen, fmt, args);
  	logbuf_unlock_irqrestore(flags);
  
  	/* If called from the scheduler, we can not call up(). */
* Unmerged path kernel/printk/printk.c
