tools build feature: Check if get_current_dir_name() is available

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-193.el8
commit-author Arnaldo Carvalho de Melo <acme@redhat.com>
commit 8feb8efef97a134933620071e0b6384cb3238b4e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-193.el8/8feb8efe.failed

As the namespace support code will use this, which is not available in
some non _GNU_SOURCE libraries such as Android's bionic used in my
container build tests (r12b and r15c at the moment).

	Cc: Adrian Hunter <adrian.hunter@intel.com>
	Cc: David Ahern <dsahern@gmail.com>
	Cc: Jiri Olsa <jolsa@kernel.org>
	Cc: Namhyung Kim <namhyung@kernel.org>
	Cc: Wang Nan <wangnan0@huawei.com>
Link: https://lkml.kernel.org/n/tip-x56ypm940pwclwu45d7jfj47@git.kernel.org
	Signed-off-by: Arnaldo Carvalho de Melo <acme@redhat.com>
(cherry picked from commit 8feb8efef97a134933620071e0b6384cb3238b4e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/build/feature/Makefile
#	tools/perf/Makefile.config
diff --cc tools/build/feature/Makefile
index 6368c2ca59af,304b984f11b9..000000000000
--- a/tools/build/feature/Makefile
+++ b/tools/build/feature/Makefile
@@@ -5,9 -5,9 +5,10 @@@ FILES
           test-bionic.bin                        \
           test-dwarf.bin                         \
           test-dwarf_getlocations.bin            \
 +         test-eventfd.bin                       \
           test-fortify-source.bin                \
           test-sync-compare-and-swap.bin         \
+          test-get_current_dir_name.bin          \
           test-glibc.bin                         \
           test-gtk2.bin                          \
           test-gtk2-infobar.bin                  \
@@@ -105,7 -102,7 +106,11 @@@ $(OUTPUT)test-bionic.bin
  $(OUTPUT)test-libelf.bin:
  	$(BUILD) -lelf
  
++<<<<<<< HEAD
 +$(OUTPUT)test-eventfd.bin:
++=======
+ $(OUTPUT)test-get_current_dir_name.bin:
++>>>>>>> 8feb8efef97a (tools build feature: Check if get_current_dir_name() is available)
  	$(BUILD)
  
  $(OUTPUT)test-glibc.bin:
diff --cc tools/perf/Makefile.config
index 36005a3ebce0,a0e8c23f9125..000000000000
--- a/tools/perf/Makefile.config
+++ b/tools/perf/Makefile.config
@@@ -323,10 -299,11 +323,18 @@@ ifndef NO_BIONI
    endif
  endif
  
++<<<<<<< HEAD
 +ifeq ($(feature-eventfd), 1)
 +  CFLAGS += -DHAVE_EVENTFD
 +endif
 +
++=======
+ ifeq ($(feature-get_current_dir_name), 1)
+   CFLAGS += -DHAVE_GET_CURRENT_DIR_NAME
+ endif
+ 
+ 
++>>>>>>> 8feb8efef97a (tools build feature: Check if get_current_dir_name() is available)
  ifdef NO_LIBELF
    NO_DWARF := 1
    NO_DEMANGLE := 1
diff --git a/tools/build/Makefile.feature b/tools/build/Makefile.feature
index c13a69d78773..361207387b1b 100644
--- a/tools/build/Makefile.feature
+++ b/tools/build/Makefile.feature
@@ -34,6 +34,7 @@ FEATURE_TESTS_BASIC :=                  \
         eventfd                         \
         fortify-source                  \
         sync-compare-and-swap           \
+        get_current_dir_name            \
         glibc                           \
         gtk2                            \
         gtk2-infobar                    \
* Unmerged path tools/build/feature/Makefile
diff --git a/tools/build/feature/test-all.c b/tools/build/feature/test-all.c
index eb95e6e5a536..a59c53705093 100644
--- a/tools/build/feature/test-all.c
+++ b/tools/build/feature/test-all.c
@@ -34,6 +34,10 @@
 # include "test-libelf-mmap.c"
 #undef main
 
+#define main main_test_get_current_dir_name
+# include "test-get_current_dir_name.c"
+#undef main
+
 #define main main_test_glibc
 # include "test-glibc.c"
 #undef main
@@ -190,6 +194,7 @@ int main(int argc, char *argv[])
 	main_test_hello();
 	main_test_libelf();
 	main_test_libelf_mmap();
+	main_test_get_current_dir_name();
 	main_test_glibc();
 	main_test_dwarf();
 	main_test_dwarf_getlocations();
diff --git a/tools/build/feature/test-get_current_dir_name.c b/tools/build/feature/test-get_current_dir_name.c
new file mode 100644
index 000000000000..573000f93212
--- /dev/null
+++ b/tools/build/feature/test-get_current_dir_name.c
@@ -0,0 +1,10 @@
+// SPDX-License-Identifier: GPL-2.0
+#define _GNU_SOURCE
+#include <unistd.h>
+#include <stdlib.h>
+
+int main(void)
+{
+	free(get_current_dir_name());
+	return 0;
+}
* Unmerged path tools/perf/Makefile.config
diff --git a/tools/perf/util/Build b/tools/perf/util/Build
index c4cd5217b90e..a36e6e5a6f4f 100644
--- a/tools/perf/util/Build
+++ b/tools/perf/util/Build
@@ -10,6 +10,7 @@ libperf-y += evlist.o
 libperf-y += evsel.o
 libperf-y += evsel_fprintf.o
 libperf-y += find_bit.o
+libperf-y += get_current_dir_name.o
 libperf-y += kallsyms.o
 libperf-y += levenshtein.o
 libperf-y += llvm-utils.o
diff --git a/tools/perf/util/get_current_dir_name.c b/tools/perf/util/get_current_dir_name.c
new file mode 100644
index 000000000000..267aa609a582
--- /dev/null
+++ b/tools/perf/util/get_current_dir_name.c
@@ -0,0 +1,18 @@
+// SPDX-License-Identifier: GPL-2.0
+// Copyright (C) 2018, Red Hat Inc, Arnaldo Carvalho de Melo <acme@redhat.com>
+//
+#ifndef HAVE_GET_CURRENT_DIR_NAME
+#include "util.h"
+#include <unistd.h>
+#include <stdlib.h>
+#include <stdlib.h>
+
+/* Android's 'bionic' library, for one, doesn't have this */
+
+char *get_current_dir_name(void)
+{
+	char pwd[PATH_MAX];
+
+	return getcwd(pwd, sizeof(pwd)) == NULL ? NULL : strdup(pwd);
+}
+#endif // HAVE_GET_CURRENT_DIR_NAME
diff --git a/tools/perf/util/util.h b/tools/perf/util/util.h
index 30f22b425cc3..09c1b0f91f65 100644
--- a/tools/perf/util/util.h
+++ b/tools/perf/util/util.h
@@ -60,6 +60,10 @@ int fetch_kernel_version(unsigned int *puint,
 
 const char *perf_tip(const char *dirpath);
 
+#ifndef HAVE_GET_CURRENT_DIR_NAME
+char *get_current_dir_name(void);
+#endif
+
 #ifndef HAVE_SCHED_GETCPU_SUPPORT
 int sched_getcpu(void);
 #endif
