RDMA/mlx5: Consider eswitch encap mode

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-193.el8
commit-author Maor Gottlieb <maorg@mellanox.com>
commit cecae747b6208d40d08f8336393345093536b124
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-193.el8/cecae747.failed

When flow steering is created, then the encap support should
consider the eswitch encap mode. If the eswitch flow table (FDB)
supports encap then it shouldn't be supported on NIC RX flow tables.

Fixes: 4adda1122c490 ('RDMA/mlx5: Enable decap and packet reformat on flow tables')
	Signed-off-by: Maor Gottlieb <maorg@mellanox.com>
	Reviewed-by: Petr Vorel <pvorel@suse.cz>
	Signed-off-by: Leon Romanovsky <leonro@mellanox.com>
	Signed-off-by: Doug Ledford <dledford@redhat.com>
(cherry picked from commit cecae747b6208d40d08f8336393345093536b124)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/hw/mlx5/main.c
diff --cc drivers/infiniband/hw/mlx5/main.c
index e4be98e9109a,6a69be02ed0d..000000000000
--- a/drivers/infiniband/hw/mlx5/main.c
+++ b/drivers/infiniband/hw/mlx5/main.c
@@@ -3172,10 -3273,10 +3176,17 @@@ static struct mlx5_ib_flow_prio *get_fl
  		if (ft_type == MLX5_IB_FT_RX) {
  			fn_type = MLX5_FLOW_NAMESPACE_BYPASS;
  			prio = &dev->flow_db->prios[priority];
++<<<<<<< HEAD
 +			if (!dev->rep &&
 +			    MLX5_CAP_FLOWTABLE_NIC_RX(dev->mdev, decap))
 +				flags |= MLX5_FLOW_TABLE_TUNNEL_EN_DECAP;
 +			if (!dev->rep &&
++=======
+ 			if (!dev->is_rep && !esw_encap &&
+ 			    MLX5_CAP_FLOWTABLE_NIC_RX(dev->mdev, decap))
+ 				flags |= MLX5_FLOW_TABLE_TUNNEL_EN_DECAP;
+ 			if (!dev->is_rep && !esw_encap &&
++>>>>>>> cecae747b620 (RDMA/mlx5: Consider eswitch encap mode)
  			    MLX5_CAP_FLOWTABLE_NIC_RX(dev->mdev,
  					reformat_l3_tunnel_to_l2))
  				flags |= MLX5_FLOW_TABLE_TUNNEL_EN_REFORMAT;
@@@ -3185,7 -3286,7 +3196,11 @@@
  							      log_max_ft_size));
  			fn_type = MLX5_FLOW_NAMESPACE_EGRESS;
  			prio = &dev->flow_db->egress_prios[priority];
++<<<<<<< HEAD
 +			if (!dev->rep &&
++=======
+ 			if (!dev->is_rep && !esw_encap &&
++>>>>>>> cecae747b620 (RDMA/mlx5: Consider eswitch encap mode)
  			    MLX5_CAP_FLOWTABLE_NIC_TX(dev->mdev, reformat))
  				flags |= MLX5_FLOW_TABLE_TUNNEL_EN_REFORMAT;
  		}
* Unmerged path drivers/infiniband/hw/mlx5/main.c
