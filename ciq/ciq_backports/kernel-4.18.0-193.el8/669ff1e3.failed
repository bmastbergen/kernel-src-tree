RDMA/mlx5: Add vport metadata matching for IB representors

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-193.el8
commit-author Jianbo Liu <jianbol@mellanox.com>
commit 669ff1e32f334e6a09e523db94989b96da4a4710
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-193.el8/669ff1e3.failed

If vport metadata matching is enabled in eswitch, the rule created
must be changed to match on the metadata, instead of source port.

	Signed-off-by: Jianbo Liu <jianbol@mellanox.com>
	Reviewed-by: Roi Dayan <roid@mellanox.com>
	Reviewed-by: Mark Bloch <markb@mellanox.com>
	Signed-off-by: Saeed Mahameed <saeedm@mellanox.com>
(cherry picked from commit 669ff1e32f334e6a09e523db94989b96da4a4710)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/hw/mlx5/main.c
diff --cc drivers/infiniband/hw/mlx5/main.c
index 53992d0700dc,602ac3feea5d..000000000000
--- a/drivers/infiniband/hw/mlx5/main.c
+++ b/drivers/infiniband/hw/mlx5/main.c
@@@ -3425,16 -3553,16 +3456,29 @@@ static struct mlx5_ib_flow_handler *_cr
  	if (!flow_is_multicast_only(flow_attr))
  		set_underlay_qp(dev, spec, underlay_qpn);
  
++<<<<<<< HEAD
 +	if (dev->rep) {
 +		void *misc;
 +
 +		misc = MLX5_ADDR_OF(fte_match_param, spec->match_value,
 +				    misc_parameters);
 +		MLX5_SET(fte_match_set_misc, misc, source_port,
 +			 dev->rep->vport);
 +		misc = MLX5_ADDR_OF(fte_match_param, spec->match_criteria,
 +				    misc_parameters);
 +		MLX5_SET_TO_ONES(fte_match_set_misc, misc, source_port);
++=======
+ 	if (dev->is_rep) {
+ 		struct mlx5_eswitch_rep *rep;
+ 
+ 		rep = dev->port[flow_attr->port - 1].rep;
+ 		if (!rep) {
+ 			err = -EINVAL;
+ 			goto free;
+ 		}
+ 
+ 		mlx5_ib_set_rule_source_port(dev, spec, rep);
++>>>>>>> 669ff1e32f33 (RDMA/mlx5: Add vport metadata matching for IB representors)
  	}
  
  	spec->match_criteria_enable = get_match_criteria_enable(spec->match_criteria);
* Unmerged path drivers/infiniband/hw/mlx5/main.c
