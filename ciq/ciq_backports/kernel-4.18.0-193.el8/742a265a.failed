powerpc/fadump: register kernel metadata address with opal

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-193.el8
commit-author Hari Bathini <hbathini@linux.ibm.com>
commit 742a265accd3e3afcc8e7b17f409c93c1de8be85
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-193.el8/742a265a.failed

OPAL allows registering address with it in the first kernel and
retrieving it after MPIPL. Setup kernel metadata and register its
address with OPAL to use it for processing the crash dump.

	Signed-off-by: Hari Bathini <hbathini@linux.ibm.com>
	Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: https://lore.kernel.org/r/156821345011.5656.13567765019032928471.stgit@hbathini.in.ibm.com
(cherry picked from commit 742a265accd3e3afcc8e7b17f409c93c1de8be85)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/powerpc/include/asm/fadump-internal.h
#	arch/powerpc/kernel/fadump.c
#	arch/powerpc/platforms/powernv/opal-fadump.c
diff --cc arch/powerpc/include/asm/fadump-internal.h
index f8097510e03f,5262c764c5fc..000000000000
--- a/arch/powerpc/include/asm/fadump-internal.h
+++ b/arch/powerpc/include/asm/fadump-internal.h
@@@ -99,6 -106,22 +101,25 @@@ struct fw_dump 
  	unsigned long	dump_active:1;
  	unsigned long	dump_registered:1;
  	unsigned long	nocma:1;
++<<<<<<< HEAD
++=======
+ 
+ 	struct fadump_ops	*ops;
+ };
+ 
+ struct fadump_ops {
+ 	u64	(*fadump_init_mem_struct)(struct fw_dump *fadump_conf);
+ 	u64	(*fadump_get_metadata_size)(void);
+ 	int	(*fadump_setup_metadata)(struct fw_dump *fadump_conf);
+ 	int	(*fadump_register)(struct fw_dump *fadump_conf);
+ 	int	(*fadump_unregister)(struct fw_dump *fadump_conf);
+ 	int	(*fadump_invalidate)(struct fw_dump *fadump_conf);
+ 	int	(*fadump_process)(struct fw_dump *fadump_conf);
+ 	void	(*fadump_region_show)(struct fw_dump *fadump_conf,
+ 				      struct seq_file *m);
+ 	void	(*fadump_trigger)(struct fadump_crash_info_header *fdh,
+ 				  const char *msg);
++>>>>>>> 742a265accd3 (powerpc/fadump: register kernel metadata address with opal)
  };
  
  /* Helper functions */
diff --cc arch/powerpc/kernel/fadump.c
index 56526469b148,7e7056382d98..000000000000
--- a/arch/powerpc/kernel/fadump.c
+++ b/arch/powerpc/kernel/fadump.c
@@@ -459,11 -349,10 +463,12 @@@ int __init fadump_reserve_mem(void
  		return 0;
  
  	if (!fw_dump.fadump_supported) {
 -		pr_info("Firmware-Assisted Dump is not supported on this hardware\n");
 -		goto error_out;
 +		printk(KERN_INFO "Firmware-assisted dump is not supported on"
 +				" this hardware\n");
 +		fw_dump.fadump_enabled = 0;
 +		return 0;
  	}
+ 
  	/*
  	 * Initialize boot memory size
  	 * If dump is active then we have already calculated the size during
@@@ -549,23 -427,39 +554,48 @@@
  			if (memblock_is_region_memory(base, size) &&
  			    !memblock_is_region_reserved(base, size))
  				break;
 -
 -			base += size;
  		}
++<<<<<<< HEAD
 +		if ((base > (memory_boundary - size)) ||
 +		    memblock_reserve(base, size)) {
 +			pr_err("Failed to reserve memory\n");
 +			return 0;
++=======
+ 
+ 		if (base > (mem_boundary - size)) {
+ 			pr_err("Failed to find memory chunk for reservation!\n");
+ 			goto error_out;
+ 		}
+ 		fw_dump.reserve_dump_area_start = base;
+ 
+ 		/*
+ 		 * Calculate the kernel metadata address and register it with
+ 		 * f/w if the platform supports.
+ 		 */
+ 		if (fw_dump.ops->fadump_setup_metadata &&
+ 		    (fw_dump.ops->fadump_setup_metadata(&fw_dump) < 0))
+ 			goto error_out;
+ 
+ 		if (memblock_reserve(base, size)) {
+ 			pr_err("Failed to reserve memory!\n");
+ 			goto error_out;
++>>>>>>> 742a265accd3 (powerpc/fadump: register kernel metadata address with opal)
  		}
  
 -		pr_info("Reserved %lldMB of memory at %#016llx (System RAM: %lldMB)\n",
 -			(size >> 20), base, (memblock_phys_mem_size() >> 20));
 +		pr_info("Reserved %ldMB of memory at %ldMB for firmware-"
 +			"assisted dump (System RAM: %ldMB)\n",
 +			(unsigned long)(size >> 20),
 +			(unsigned long)(base >> 20),
 +			(unsigned long)(memblock_phys_mem_size() >> 20));
  
++<<<<<<< HEAD
 +		fw_dump.reserve_dump_area_start = base;
 +		return fadump_cma_init();
++=======
+ 		ret = fadump_cma_init();
++>>>>>>> 742a265accd3 (powerpc/fadump: register kernel metadata address with opal)
  	}
 -
 -	return ret;
 -error_out:
 -	fw_dump.fadump_enabled = 0;
 -	return 0;
 +	return 1;
  }
  
  unsigned long __init arch_reserved_kernel_pages(void)
* Unmerged path arch/powerpc/platforms/powernv/opal-fadump.c
* Unmerged path arch/powerpc/include/asm/fadump-internal.h
* Unmerged path arch/powerpc/kernel/fadump.c
* Unmerged path arch/powerpc/platforms/powernv/opal-fadump.c
diff --git a/arch/powerpc/platforms/powernv/opal-fadump.h b/arch/powerpc/platforms/powernv/opal-fadump.h
new file mode 100644
index 000000000000..0b83d895485c
--- /dev/null
+++ b/arch/powerpc/platforms/powernv/opal-fadump.h
@@ -0,0 +1,39 @@
+/* SPDX-License-Identifier: GPL-2.0-or-later */
+/*
+ * Firmware-Assisted Dump support on POWER platform (OPAL).
+ *
+ * Copyright 2019, Hari Bathini, IBM Corporation.
+ */
+
+#ifndef _POWERNV_OPAL_FADUMP_H
+#define _POWERNV_OPAL_FADUMP_H
+
+/*
+ * OPAL FADump metadata structure format version
+ *
+ * OPAL FADump kernel metadata structure stores kernel metadata needed to
+ * register-for/process crash dump. Format version is used to keep a tab on
+ * the changes in the structure format. The changes, if any, to the format
+ * are expected to be minimal and backward compatible.
+ */
+#define OPAL_FADUMP_VERSION			0x1
+
+/* Maximum number of memory regions kernel supports */
+#define OPAL_FADUMP_MAX_MEM_REGS		128
+
+/*
+ * OPAL FADump kernel metadata
+ *
+ * The address of this structure will be registered with f/w for retrieving
+ * and processing during crash dump.
+ */
+struct opal_fadump_mem_struct {
+	u8	version;
+	u8	reserved[3];
+	u16	region_cnt;		/* number of regions */
+	u16	registered_regions;	/* Regions registered for MPIPL */
+	u64	fadumphdr_addr;
+	struct opal_mpipl_region	rgn[OPAL_FADUMP_MAX_MEM_REGS];
+} __packed;
+
+#endif /* _POWERNV_OPAL_FADUMP_H */
