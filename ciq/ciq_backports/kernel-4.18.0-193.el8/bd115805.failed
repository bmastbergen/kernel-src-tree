mt76: mt7603: enable/disable pre_tbtt_tasklet in mt7603_set_channel

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-193.el8
commit-author Lorenzo Bianconi <lorenzo@kernel.org>
commit bd115805e86a6d18b18e2cf97e9cc7af361cb72a
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-193.el8/bd115805.failed

Disable pre_tbtt_tasklet tasklet before setting the operating channel.
Enable/disable beacon_timer in mt7603_set_channel

	Signed-off-by: Lorenzo Bianconi <lorenzo@kernel.org>
	Signed-off-by: Felix Fietkau <nbd@nbd.name>
(cherry picked from commit bd115805e86a6d18b18e2cf97e9cc7af361cb72a)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/wireless/mediatek/mt76/mt7603/main.c
diff --cc drivers/net/wireless/mediatek/mt76/mt7603/main.c
index ce4a5b71b958,0a0334dc40d5..000000000000
--- a/drivers/net/wireless/mediatek/mt76/mt7603/main.c
+++ b/drivers/net/wireless/mediatek/mt76/mt7603/main.c
@@@ -132,7 -132,8 +132,12 @@@ mt7603_set_channel(struct mt7603_dev *d
  	u8 bw = MT_BW_20;
  	bool failed = false;
  
++<<<<<<< HEAD
 +	cancel_delayed_work_sync(&dev->mac_work);
++=======
+ 	cancel_delayed_work_sync(&dev->mt76.mac_work);
+ 	tasklet_disable(&dev->mt76.pre_tbtt_tasklet);
++>>>>>>> bd115805e86a (mt76: mt7603: enable/disable pre_tbtt_tasklet in mt7603_set_channel)
  
  	mutex_lock(&dev->mt76.mutex);
  	set_bit(MT76_RESET, &dev->mt76.state);
@@@ -186,10 -188,14 +192,14 @@@
  	mt7603_init_edcca(dev);
  
  out:
+ 	if (!(mt76_hw(dev)->conf.flags & IEEE80211_CONF_OFFCHANNEL))
+ 		mt7603_beacon_set_timer(dev, -1, dev->mt76.beacon_int);
  	mutex_unlock(&dev->mt76.mutex);
  
+ 	tasklet_enable(&dev->mt76.pre_tbtt_tasklet);
+ 
  	if (failed)
 -		mt7603_mac_work(&dev->mt76.mac_work.work);
 +		mt7603_mac_work(&dev->mac_work.work);
  
  	return ret;
  }
@@@ -544,7 -549,6 +553,10 @@@ mt7603_sw_scan_complete(struct ieee8021
  	struct mt7603_dev *dev = hw->priv;
  
  	clear_bit(MT76_SCANNING, &dev->mt76.state);
++<<<<<<< HEAD
 +	mt7603_beacon_set_timer(dev, -1, dev->beacon_int);
++=======
++>>>>>>> bd115805e86a (mt76: mt7603: enable/disable pre_tbtt_tasklet in mt7603_set_channel)
  }
  
  static void
diff --git a/drivers/net/wireless/mediatek/mt76/mt7603/beacon.c b/drivers/net/wireless/mediatek/mt76/mt7603/beacon.c
index 4dcb465095d1..cd1feea22bea 100644
--- a/drivers/net/wireless/mediatek/mt76/mt7603/beacon.c
+++ b/drivers/net/wireless/mediatek/mt76/mt7603/beacon.c
@@ -73,6 +73,9 @@ void mt7603_pre_tbtt_tasklet(unsigned long arg)
 	struct sk_buff *skb;
 	int i, nframes;
 
+	if (mt76_hw(dev)->conf.flags & IEEE80211_CONF_OFFCHANNEL)
+		return;
+
 	data.dev = dev;
 	__skb_queue_head_init(&data.q);
 
* Unmerged path drivers/net/wireless/mediatek/mt76/mt7603/main.c
