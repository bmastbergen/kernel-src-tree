s390/qeth: dynamically allocate diag cmds

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-193.el8
commit-author Julian Wiedmann <jwi@linux.ibm.com>
commit 5cfbe10a000aec92003d72061d250aa7a95bc02a
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-193.el8/5cfbe10a.failed

Add a new wrapper that allocates DIAG cmds of the right size, and fills
in the common fields.

	Signed-off-by: Julian Wiedmann <jwi@linux.ibm.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 5cfbe10a000aec92003d72061d250aa7a95bc02a)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/s390/net/qeth_core.h
#	drivers/s390/net/qeth_core_main.c
diff --cc drivers/s390/net/qeth_core.h
index 21a09e1fd4dc,b99fe6b043aa..000000000000
--- a/drivers/s390/net/qeth_core.h
+++ b/drivers/s390/net/qeth_core.h
@@@ -968,6 -996,22 +968,25 @@@ int qeth_send_ipa_cmd(struct qeth_card 
  		  void *);
  struct qeth_cmd_buffer *qeth_get_ipacmd_buffer(struct qeth_card *,
  			enum qeth_ipa_cmds, enum qeth_prot_versions);
++<<<<<<< HEAD
++=======
+ struct qeth_cmd_buffer *qeth_ipa_alloc_cmd(struct qeth_card *card,
+ 					   enum qeth_ipa_cmds cmd_code,
+ 					   enum qeth_prot_versions prot,
+ 					   unsigned int data_length);
+ struct qeth_cmd_buffer *qeth_alloc_cmd(struct qeth_channel *channel,
+ 				       unsigned int length, unsigned int ccws,
+ 				       long timeout);
+ struct qeth_cmd_buffer *qeth_get_setassparms_cmd(struct qeth_card *card,
+ 						 enum qeth_ipa_funcs ipa_func,
+ 						 u16 cmd_code,
+ 						 unsigned int data_length,
+ 						 enum qeth_prot_versions prot);
+ struct qeth_cmd_buffer *qeth_get_diag_cmd(struct qeth_card *card,
+ 					  enum qeth_diags_cmds sub_cmd,
+ 					  unsigned int data_length);
+ 
++>>>>>>> 5cfbe10a000a (s390/qeth: dynamically allocate diag cmds)
  struct sk_buff *qeth_core_get_next_skb(struct qeth_card *,
  		struct qeth_qdio_buffer *, struct qdio_buffer_element **, int *,
  		struct qeth_hdr **);
diff --cc drivers/s390/net/qeth_core_main.c
index e5a472487595,22074890835e..000000000000
--- a/drivers/s390/net/qeth_core_main.c
+++ b/drivers/s390/net/qeth_core_main.c
@@@ -3083,15 -3074,11 +3102,16 @@@ static int qeth_query_setdiagass_cb(str
  static int qeth_query_setdiagass(struct qeth_card *card)
  {
  	struct qeth_cmd_buffer *iob;
- 	struct qeth_ipa_cmd    *cmd;
  
++<<<<<<< HEAD
 +	QETH_DBF_TEXT(SETUP, 2, "qdiagass");
 +	iob = qeth_get_ipacmd_buffer(card, IPA_CMD_SET_DIAG_ASS, 0);
++=======
+ 	QETH_CARD_TEXT(card, 2, "qdiagass");
+ 	iob = qeth_get_diag_cmd(card, QETH_DIAGS_CMD_QUERY, 0);
++>>>>>>> 5cfbe10a000a (s390/qeth: dynamically allocate diag cmds)
  	if (!iob)
  		return -ENOMEM;
- 	cmd = __ipa_cmd(iob);
- 	cmd->data.diagass.subcmd_len = 16;
- 	cmd->data.diagass.subcmd = QETH_DIAGS_CMD_QUERY;
  	return qeth_send_ipa_cmd(card, iob, qeth_query_setdiagass_cb, NULL);
  }
  
@@@ -3138,8 -3125,8 +3158,13 @@@ int qeth_hw_trap(struct qeth_card *card
  	struct qeth_cmd_buffer *iob;
  	struct qeth_ipa_cmd *cmd;
  
++<<<<<<< HEAD
 +	QETH_DBF_TEXT(SETUP, 2, "diagtrap");
 +	iob = qeth_get_ipacmd_buffer(card, IPA_CMD_SET_DIAG_ASS, 0);
++=======
+ 	QETH_CARD_TEXT(card, 2, "diagtrap");
+ 	iob = qeth_get_diag_cmd(card, QETH_DIAGS_CMD_TRAP, 64);
++>>>>>>> 5cfbe10a000a (s390/qeth: dynamically allocate diag cmds)
  	if (!iob)
  		return -ENOMEM;
  	cmd = __ipa_cmd(iob);
* Unmerged path drivers/s390/net/qeth_core.h
* Unmerged path drivers/s390/net/qeth_core_main.c
diff --git a/drivers/s390/net/qeth_core_mpc.h b/drivers/s390/net/qeth_core_mpc.h
index 1bc97ffba037..905abfd2c499 100644
--- a/drivers/s390/net/qeth_core_mpc.h
+++ b/drivers/s390/net/qeth_core_mpc.h
@@ -600,6 +600,11 @@ struct qeth_ipacmd_diagass {
 	__u8   cdata[64];
 } __attribute__ ((packed));
 
+#define DIAG_HDR_LEN		offsetofend(struct qeth_ipacmd_diagass, ext)
+#define DIAG_SUB_HDR_LEN	(offsetofend(struct qeth_ipacmd_diagass, ext) -\
+				 offsetof(struct qeth_ipacmd_diagass, \
+					  subcmd_len))
+
 /* VNIC Characteristics IPA Command: *****************************************/
 /* IPA commands/sub commands for VNICC */
 #define IPA_VNICC_QUERY_CHARS		0x00000000L
diff --git a/drivers/s390/net/qeth_l3_main.c b/drivers/s390/net/qeth_l3_main.c
index 5b94b0ad9e01..f9375d86ae20 100644
--- a/drivers/s390/net/qeth_l3_main.c
+++ b/drivers/s390/net/qeth_l3_main.c
@@ -1098,12 +1098,10 @@ qeth_diags_trace(struct qeth_card *card, enum qeth_diags_trace_cmds diags_cmd)
 
 	QETH_DBF_TEXT(SETUP, 2, "diagtrac");
 
-	iob = qeth_get_ipacmd_buffer(card, IPA_CMD_SET_DIAG_ASS, 0);
+	iob = qeth_get_diag_cmd(card, QETH_DIAGS_CMD_TRACE, 0);
 	if (!iob)
 		return -ENOMEM;
 	cmd = __ipa_cmd(iob);
-	cmd->data.diagass.subcmd_len = 16;
-	cmd->data.diagass.subcmd = QETH_DIAGS_CMD_TRACE;
 	cmd->data.diagass.type = QETH_DIAGS_TYPE_HIPERSOCKET;
 	cmd->data.diagass.action = diags_cmd;
 	return qeth_send_ipa_cmd(card, iob, qeth_diags_trace_cb, NULL);
