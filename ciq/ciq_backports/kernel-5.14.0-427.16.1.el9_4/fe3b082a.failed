memory: tegra: Add SID override programming for MC clients

jira LE-1907
Rebuild_History Non-Buildable kernel-5.14.0-427.16.1.el9_4
commit-author Ashish Mhetre <amhetre@nvidia.com>
commit fe3b082a6eb8b1526ed7397c849d6b2a6baeb6a1
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-5.14.0-427.16.1.el9_4/fe3b082a.failed

For some devices the bootloader/firmware may set up the device in
bypass. Memory clients like display needs kernel to program SID after
resume because bootloader/firmware programs the SID of display device to
bypass. In order to make sure that kernel IOMMU mappings for these
devices work after resume, add SID override programming support for all
memory clients on memory controller resume.

This partially reverts 'commit ef86b2c2807f ("memory: tegra: Remove
clients SID override programming")'

	Signed-off-by: Ashish Mhetre <amhetre@nvidia.com>
Link: https://lore.kernel.org/r/20231107112713.21399-1-amhetre@nvidia.com
	Signed-off-by: Krzysztof Kozlowski <krzysztof.kozlowski@linaro.org>
(cherry picked from commit fe3b082a6eb8b1526ed7397c849d6b2a6baeb6a1)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	include/soc/tegra/mc.h
diff --cc include/soc/tegra/mc.h
index a5ef84944a06,af1d73a7f0cd..000000000000
--- a/include/soc/tegra/mc.h
+++ b/include/soc/tegra/mc.h
@@@ -185,7 -162,6 +185,10 @@@ struct tegra_mc_ops 
  	 */
  	int (*probe)(struct tegra_mc *mc);
  	void (*remove)(struct tegra_mc *mc);
++<<<<<<< HEAD
 +	int (*suspend)(struct tegra_mc *mc);
++=======
++>>>>>>> fe3b082a6eb8 (memory: tegra: Add SID override programming for MC clients)
  	int (*resume)(struct tegra_mc *mc);
  	irqreturn_t (*handle_irq)(int irq, void *data);
  	int (*probe_device)(struct tegra_mc *mc, struct device *dev);
diff --git a/drivers/memory/tegra/tegra186.c b/drivers/memory/tegra/tegra186.c
index 7bb73f06fad3..255abcb810be 100644
--- a/drivers/memory/tegra/tegra186.c
+++ b/drivers/memory/tegra/tegra186.c
@@ -135,9 +135,23 @@ static int tegra186_mc_probe_device(struct tegra_mc *mc, struct device *dev)
 	return 0;
 }
 
+static int tegra186_mc_resume(struct tegra_mc *mc)
+{
+	unsigned int i;
+
+	for (i = 0; i < mc->soc->num_clients; i++) {
+		const struct tegra_mc_client *client = &mc->soc->clients[i];
+
+		tegra186_mc_client_sid_override(mc, client, client->sid);
+	}
+
+	return 0;
+}
+
 const struct tegra_mc_ops tegra186_mc_ops = {
 	.probe = tegra186_mc_probe,
 	.remove = tegra186_mc_remove,
+	.resume = tegra186_mc_resume,
 	.probe_device = tegra186_mc_probe_device,
 	.handle_irq = tegra30_mc_handle_irq,
 };
* Unmerged path include/soc/tegra/mc.h
