xfs: verify AGI unlinked list contains valid blocks

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1127.el7
commit-author Dave Chinner <dchinner@redhat.com>
commit 9f96cc958e8ae9864e6d597a5f3e80b5fca35ae4
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1127.el7/9f96cc95.failed

The heads of tha AGI unlinked list are only scanned on debug
kernels when the verifier runs. Change that to always scan the heads
and validate that the inode numbers are valid.

	Signed-off-by: Dave Chinner <dchinner@redhat.com>
	Reviewed-by: Darrick J. Wong <darrick.wong@oracle.com>
	Signed-off-by: Darrick J. Wong <darrick.wong@oracle.com>
(cherry picked from commit 9f96cc958e8ae9864e6d597a5f3e80b5fca35ae4)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/xfs/libxfs/xfs_ialloc.c
diff --cc fs/xfs/libxfs/xfs_ialloc.c
index 8a6e2ce84589,48296adbb0fb..000000000000
--- a/fs/xfs/libxfs/xfs_ialloc.c
+++ b/fs/xfs/libxfs/xfs_ialloc.c
@@@ -2473,21 -2477,7 +2473,25 @@@ xfs_ialloc_log_agi
  	}
  }
  
++<<<<<<< HEAD
 +#ifdef DEBUG
 +STATIC void
 +xfs_check_agi_unlinked(
 +	struct xfs_agi		*agi)
 +{
 +	int			i;
 +
 +	for (i = 0; i < XFS_AGI_UNLINKED_BUCKETS; i++)
 +		ASSERT(agi->agi_unlinked[i]);
 +}
 +#else
 +#define xfs_check_agi_unlinked(agi)
 +#endif
 +
 +static bool
++=======
+ static xfs_failaddr_t
++>>>>>>> 9f96cc958e8a (xfs: verify AGI unlinked list contains valid blocks)
  xfs_agi_verify(
  	struct xfs_buf	*bp)
  {
@@@ -2526,10 -2517,16 +2531,21 @@@
  	 * so we can detect and avoid this problem.
  	 */
  	if (bp->b_pag && be32_to_cpu(agi->agi_seqno) != bp->b_pag->pag_agno)
 -		return __this_address;
 +		return false;
  
++<<<<<<< HEAD
 +	xfs_check_agi_unlinked(agi);
 +	return true;
++=======
+ 	for (i = 0; i < XFS_AGI_UNLINKED_BUCKETS; i++) {
+ 		if (agi->agi_unlinked[i] == NULLAGINO)
+ 			continue;
+ 		if (!xfs_verify_ino(mp, be32_to_cpu(agi->agi_unlinked[i])))
+ 			return __this_address;
+ 	}
+ 
+ 	return NULL;
++>>>>>>> 9f96cc958e8a (xfs: verify AGI unlinked list contains valid blocks)
  }
  
  static void
* Unmerged path fs/xfs/libxfs/xfs_ialloc.c
