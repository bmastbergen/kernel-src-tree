dm log writes: make sure super sector log updates are written in order

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1127.el7
commit-author zhangyi (F) <yi.zhang@huawei.com>
commit 211ad4b733037f66f9be0a79eade3da7ab11cbb8
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1127.el7/211ad4b7.failed

Currently, although we submit super bios in order (and super.nr_entries
is incremented by each logged entry), submit_bio() is async so each
super sector may not be written to log device in order and then the
final nr_entries may be smaller than it should be.

This problem can be reproduced by the xfstests generic/455 with ext4:

  QA output created by 455
 -Silence is golden
 +mark 'end' does not exist

Fix this by serializing submission of super sectors to make sure each
is written to the log disk in order.

Fixes: 0e9cebe724597 ("dm: add log writes target")
	Cc: stable@vger.kernel.org
	Signed-off-by: zhangyi (F) <yi.zhang@huawei.com>
	Suggested-by: Josef Bacik <josef@toxicpanda.com>
	Reviewed-by: Josef Bacik <josef@toxicpanda.com>
	Signed-off-by: Mike Snitzer <snitzer@redhat.com>
(cherry picked from commit 211ad4b733037f66f9be0a79eade3da7ab11cbb8)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/md/dm-log-writes.c
diff --cc drivers/md/dm-log-writes.c
index 6205eb67b951,e549392e0ea5..000000000000
--- a/drivers/md/dm-log-writes.c
+++ b/drivers/md/dm-log-writes.c
@@@ -216,12 -222,13 +226,20 @@@ static int write_metadata(struct log_wr
  		DMERR("Couldn't alloc log bio");
  		goto error;
  	}
++<<<<<<< HEAD
 +	bio->bi_size = 0;
 +	bio->bi_sector = sector;
 +	bio->bi_bdev = lc->logdev->bdev;
 +	bio->bi_end_io = log_end_io;
++=======
+ 	bio->bi_iter.bi_size = 0;
+ 	bio->bi_iter.bi_sector = sector;
+ 	bio_set_dev(bio, lc->logdev->bdev);
+ 	bio->bi_end_io = (sector == WRITE_LOG_SUPER_SECTOR) ?
+ 			  log_end_super : log_end_io;
++>>>>>>> 211ad4b73303 (dm log writes: make sure super sector log updates are written in order)
  	bio->bi_private = lc;
 -	bio_set_op_attrs(bio, REQ_OP_WRITE, 0);
 +	set_bit(BIO_UPTODATE, &bio->bi_flags);
  
  	page = alloc_page(GFP_KERNEL);
  	if (!page) {
* Unmerged path drivers/md/dm-log-writes.c
