scsi: lpfc: Fix missing wakeups on abort threads

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1127.el7
commit-author James Smart <jsmart2021@gmail.com>
commit 4eb01535886644d79a58fe652e0782a194bc3402
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1127.el7/4eb01535.failed

Abort thread wakeups, on some wqe types, are not happening.  The thread
wakeup logic is dependent upon the LPFC_DRIVER_ABORTED flag. However, on
these wqes, the completion handler running prior to the io completion
routine ends up clearing the flag.

Rework the wakeup logic to look at a non-null waitq element which must be
set if the abort thread is waiting. This is reverting the change in the
indicated patch.

Fixes: c2017260eea2d ("scsi: lpfc: Rework locking on SCSI io completion")
	Signed-off-by: Dick Kennedy <dick.kennedy@broadcom.com>
	Signed-off-by: James Smart <jsmart2021@gmail.com>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit 4eb01535886644d79a58fe652e0782a194bc3402)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/lpfc/lpfc_scsi.c
diff --cc drivers/scsi/lpfc/lpfc_scsi.c
index 04ee49be350d,a497b2c0cb79..000000000000
--- a/drivers/scsi/lpfc/lpfc_scsi.c
+++ b/drivers/scsi/lpfc/lpfc_scsi.c
@@@ -4317,13 -3874,16 +4317,23 @@@ lpfc_scsi_cmd_iocb_cmpl(struct lpfc_hb
  	cmd->scsi_done(cmd);
  
  	/*
 -	 * If there is an abort thread waiting for command completion
 +	 * If there is a thread waiting for command completion
  	 * wake up the thread.
  	 */
++<<<<<<< HEAD
 +	spin_lock_irqsave(shost->host_lock, flags);
 +	if (lpfc_cmd->waitq)
 +		wake_up(lpfc_cmd->waitq);
 +	spin_unlock_irqrestore(shost->host_lock, flags);
++=======
+ 	spin_lock(&lpfc_cmd->buf_lock);
+ 	lpfc_cmd->cur_iocbq.iocb_flag &= ~LPFC_DRIVER_ABORTED;
+ 	if (lpfc_cmd->waitq) {
+ 		wake_up(lpfc_cmd->waitq);
+ 		lpfc_cmd->waitq = NULL;
+ 	}
+ 	spin_unlock(&lpfc_cmd->buf_lock);
++>>>>>>> 4eb015358866 (scsi: lpfc: Fix missing wakeups on abort threads)
  
  	lpfc_release_scsi_buf(phba, lpfc_cmd);
  }
* Unmerged path drivers/scsi/lpfc/lpfc_scsi.c
