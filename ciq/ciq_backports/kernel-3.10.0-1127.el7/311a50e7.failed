drm/i915: Add support for mandatory cmdparsing

jira LE-1907
cve CVE-2019-0155
Rebuild_History Non-Buildable kernel-3.10.0-1127.el7
commit-author Jon Bloomfield <jon.bloomfield@intel.com>
commit 311a50e76a33d1e029563c24b2ff6db0c02b5afe
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1127.el7/311a50e7.failed

The existing cmdparser for gen7 can be bypassed by specifying
batch_len=0 in the execbuf call. This is safe because bypassing
simply reduces the cmd-set available.

In a later patch we will introduce cmdparsing for gen9, as a
security measure, which must be strictly enforced since without
it we are vulnerable to DoS attacks.

Introduce the concept of 'required' cmd parsing that cannot be
bypassed by submitting zero-length bb's.

v2: rebase (Mika)
v2: rebase (Mika)
v3: fix conflict on engine flags (Mika)

	Signed-off-by: Jon Bloomfield <jon.bloomfield@intel.com>
	Cc: Tony Luck <tony.luck@intel.com>
	Cc: Dave Airlie <airlied@redhat.com>
	Cc: Takashi Iwai <tiwai@suse.de>
	Cc: Tyler Hicks <tyhicks@canonical.com>
	Signed-off-by: Mika Kuoppala <mika.kuoppala@linux.intel.com>
	Reviewed-by: Chris Wilson <chris.p.wilson@intel.com>
(cherry picked from commit 311a50e76a33d1e029563c24b2ff6db0c02b5afe)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/gpu/drm/i915/gt/intel_engine_types.h
#	drivers/gpu/drm/i915/i915_cmd_parser.c
diff --cc drivers/gpu/drm/i915/i915_cmd_parser.c
index d4cc643c45f7,832b1ac282c0..000000000000
--- a/drivers/gpu/drm/i915/i915_cmd_parser.c
+++ b/drivers/gpu/drm/i915/i915_cmd_parser.c
@@@ -1316,8 -1316,8 +1316,13 @@@ int i915_cmd_parser_get_version(struct 
  	bool active = false;
  
  	/* If the command parser is not enabled, report 0 - unsupported */
++<<<<<<< HEAD
 +	for_each_engine(engine, dev_priv, id) {
 +		if (intel_engine_needs_cmd_parser(engine)) {
++=======
+ 	for_each_uabi_engine(engine, dev_priv) {
+ 		if (intel_engine_using_cmd_parser(engine)) {
++>>>>>>> 311a50e76a33 (drm/i915: Add support for mandatory cmdparsing)
  			active = true;
  			break;
  		}
* Unmerged path drivers/gpu/drm/i915/gt/intel_engine_types.h
* Unmerged path drivers/gpu/drm/i915/gt/intel_engine_types.h
* Unmerged path drivers/gpu/drm/i915/i915_cmd_parser.c
diff --git a/drivers/gpu/drm/i915/i915_gem_execbuffer.c b/drivers/gpu/drm/i915/i915_gem_execbuffer.c
index 48276ddd0ab4..a26a80997dd6 100644
--- a/drivers/gpu/drm/i915/i915_gem_execbuffer.c
+++ b/drivers/gpu/drm/i915/i915_gem_execbuffer.c
@@ -311,7 +311,8 @@ static inline u64 gen8_noncanonical_addr(u64 address)
 
 static inline bool eb_use_cmdparser(const struct i915_execbuffer *eb)
 {
-	return intel_engine_needs_cmd_parser(eb->engine) && eb->batch_len;
+	return intel_engine_requires_cmd_parser(eb->engine) ||
+		(intel_engine_using_cmd_parser(eb->engine) && eb->batch_len);
 }
 
 static int eb_create(struct i915_execbuffer *eb)
