net/mlx5: Fix the order of fc_stats cleanup

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1127.el7
commit-author Gavi Teitz <gavi@mellanox.com>
commit b1b9f97a0937211dbca638c476ac47ee39875661
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1127.el7/b1b9f97a.failed

Previously, mlx5_cleanup_fc_stats() would cleanup the flow counter
pool beofre releasing all the counters to it, which would result in
flow counter bulks not getting freed. Resolve this by changing the
order in which elements of fc_stats are cleaned up, so that the flow
counter pool is cleaned up after all the counters are released.

Also move cleanup actions for freeing the bulk query memory and
destroying the idr to the end of mlx5_cleanup_fc_stats().

	Signed-off-by: Gavi Teitz <gavi@mellanox.com>
	Reviewed-by: Roi Dayan <roid@mellanox.com>
	Reviewed-by: Vlad Buslov <vladbu@mellanox.com>
	Signed-off-by: Saeed Mahameed <saeedm@mellanox.com>
(cherry picked from commit b1b9f97a0937211dbca638c476ac47ee39875661)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlx5/core/fs_counters.c
diff --cc drivers/net/ethernet/mellanox/mlx5/core/fs_counters.c
index f9e2815fb542,ab69effb056d..000000000000
--- a/drivers/net/ethernet/mellanox/mlx5/core/fs_counters.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/fs_counters.c
@@@ -352,14 -406,16 +352,25 @@@ void mlx5_cleanup_fc_stats(struct mlx5_
  	destroy_workqueue(dev->priv.fc_stats.wq);
  	dev->priv.fc_stats.wq = NULL;
  
++<<<<<<< HEAD
 +	idr_destroy_ext(&fc_stats->counters_idr);
 +
++=======
++>>>>>>> b1b9f97a0937 (net/mlx5: Fix the order of fc_stats cleanup)
  	tmplist = llist_del_all(&fc_stats->addlist);
  	llist_for_each_entry_safe(counter, tmp, tmplist, addlist)
 -		mlx5_fc_release(dev, counter);
 +		mlx5_free_fc(dev, counter);
  
  	list_for_each_entry_safe(counter, tmp, &fc_stats->counters, list)
++<<<<<<< HEAD
 +		mlx5_free_fc(dev, counter);
++=======
+ 		mlx5_fc_release(dev, counter);
+ 
+ 	mlx5_fc_pool_cleanup(&fc_stats->fc_pool);
+ 	idr_destroy(&fc_stats->counters_idr);
+ 	kfree(fc_stats->bulk_query_out);
++>>>>>>> b1b9f97a0937 (net/mlx5: Fix the order of fc_stats cleanup)
  }
  
  int mlx5_fc_query(struct mlx5_core_dev *dev, struct mlx5_fc *counter,
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/fs_counters.c
