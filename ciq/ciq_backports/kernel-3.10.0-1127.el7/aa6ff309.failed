scsi: lpfc: Fix BFS crash with DIX enabled

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1127.el7
commit-author James Smart <jsmart2021@gmail.com>
commit aa6ff309187256ee542a8cf47adbfcfdaa888c46
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1127.el7/aa6ff309.failed

Crashes in scsi_queue_rq or in dma_unmap_direct_sg during BFS when lpfc has
lpfc_enable_bg=1.

lpfc is setting DIX and prot sg after scsi_add_host_with_dma() has been
called. The scsi_host_set_prot() and scsi_host_set_guard() routines need to
be called before scsi_add_host_with_dma().

Revise the calling sequence to set the protection/guard data before calling
scsi_add_host_with_dma().

	Signed-off-by: Dick Kennedy <dick.kennedy@broadcom.com>
	Signed-off-by: James Smart <jsmart2021@gmail.com>
	Reviewed-by: Ewan D. Milne <emilne@redhat.com>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit aa6ff309187256ee542a8cf47adbfcfdaa888c46)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/lpfc/lpfc_init.c
diff --cc drivers/scsi/lpfc/lpfc_init.c
index 3fb469d75f42,a2b827dd36ff..000000000000
--- a/drivers/scsi/lpfc/lpfc_init.c
+++ b/drivers/scsi/lpfc/lpfc_init.c
@@@ -93,6 -93,8 +93,11 @@@ static void lpfc_sli4_cq_event_release_
  static void lpfc_sli4_disable_intr(struct lpfc_hba *);
  static uint32_t lpfc_sli4_enable_intr(struct lpfc_hba *, uint32_t);
  static void lpfc_sli4_oas_verify(struct lpfc_hba *phba);
++<<<<<<< HEAD
++=======
+ static uint16_t lpfc_find_cpu_handle(struct lpfc_hba *, uint16_t, int);
+ static void lpfc_setup_bg(struct lpfc_hba *, struct Scsi_Host *);
++>>>>>>> aa6ff3091872 (scsi: lpfc: Fix BFS crash with DIX enabled)
  
  static struct scsi_transport_template *lpfc_transport_template = NULL;
  static struct scsi_transport_template *lpfc_vport_transport_template = NULL;
@@@ -3994,15 -4343,15 +3999,18 @@@ lpfc_create_port(struct lpfc_hba *phba
  	INIT_LIST_HEAD(&vport->rcv_buffer_list);
  	spin_lock_init(&vport->work_port_lock);
  
 -	timer_setup(&vport->fc_disctmo, lpfc_disc_timeout, 0);
 +	setup_timer(&vport->fc_disctmo, lpfc_disc_timeout,
 +			(unsigned long)vport);
  
 -	timer_setup(&vport->els_tmofunc, lpfc_els_timeout, 0);
 +	setup_timer(&vport->els_tmofunc, lpfc_els_timeout,
 +			(unsigned long)vport);
  
 -	timer_setup(&vport->delayed_disc_tmo, lpfc_delayed_disc_tmo, 0);
 +	setup_timer(&vport->delayed_disc_tmo, lpfc_delayed_disc_tmo,
 +			(unsigned long)vport);
  
+ 	if (phba->sli3_options & LPFC_SLI3_BG_ENABLED)
+ 		lpfc_setup_bg(phba, shost);
+ 
  	error = scsi_add_host_with_dma(shost, dev, &phba->pcidev->dev);
  	if (error)
  		goto out_put_shost;
* Unmerged path drivers/scsi/lpfc/lpfc_init.c
