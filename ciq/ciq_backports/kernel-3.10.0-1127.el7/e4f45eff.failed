xfs: check directory bestfree information in the verifier

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1127.el7
commit-author Darrick J. Wong <darrick.wong@oracle.com>
commit e4f45eff86fdbafd8e0ba072fd52422e32e5b5ac
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1127.el7/e4f45eff.failed

Create a variant of xfs_dir2_data_freefind that is suitable for use in a
verifier.  Because _freefind is called by the verifier, we simply
duplicate the _freefind function, convert the ASSERTs to return
__this_address, and modify the verifier to call our new function.  Once
we've made it impossible for directory blocks with bad bestfree data to
make it into the filesystem we can remove the DEBUG code from the
regular _freefind function.

Underlying argument: corruption of on-disk metadata should return
-EFSCORRUPTED instead of blowing ASSERTs.

	Signed-off-by: Darrick J. Wong <darrick.wong@oracle.com>
	Reviewed-by: Dave Chinner <dchinner@redhat.com>
(cherry picked from commit e4f45eff86fdbafd8e0ba072fd52422e32e5b5ac)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/xfs/libxfs/xfs_dir2_data.c
diff --cc fs/xfs/libxfs/xfs_dir2_data.c
index 14eb9e9f3cfd,2c16bb4f2155..000000000000
--- a/fs/xfs/libxfs/xfs_dir2_data.c
+++ b/fs/xfs/libxfs/xfs_dir2_data.c
@@@ -138,14 -152,18 +143,23 @@@ __xfs_dir3_data_check
  		 * doesn't need to be there.
  		 */
  		if (be16_to_cpu(dup->freetag) == XFS_DIR2_DATA_FREE_TAG) {
+ 			xfs_failaddr_t	fa;
+ 
  			if (lastfree != 0)
 -				return __this_address;
 +				return false;
  			if (endp < p + be16_to_cpu(dup->length))
 -				return __this_address;
 +				return false;
  			if (be16_to_cpu(*xfs_dir2_data_unused_tag_p(dup)) !=
  			    (char *)dup - (char *)hdr)
++<<<<<<< HEAD
 +				return false;
 +			dfp = xfs_dir2_data_freefind(hdr, bf, dup);
++=======
+ 				return __this_address;
+ 			fa = xfs_dir2_data_freefind_verify(hdr, bf, dup, &dfp);
+ 			if (fa)
+ 				return fa;
++>>>>>>> e4f45eff86fd (xfs: check directory bestfree information in the verifier)
  			if (dfp) {
  				i = (int)(dfp - bf);
  				if ((freeseen & (1 << i)) != 0)
* Unmerged path fs/xfs/libxfs/xfs_dir2_data.c
