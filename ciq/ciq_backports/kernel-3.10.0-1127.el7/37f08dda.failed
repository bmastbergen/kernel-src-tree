vmalloc: allow to account vmalloc to memcg

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1127.el7
commit-author Vladimir Davydov <vdavydov@virtuozzo.com>
commit 37f08dda29dac8a595999b8d3eaa9bf0f763dd9d
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1127.el7/37f08dda.failed

Make vmalloc family functions allocate vmalloc area pages with
alloc_kmem_pages so that if __GFP_ACCOUNT is set they will be accounted
to memcg.  This is needed, at least, to account alloc_fdmem allocations.

	Signed-off-by: Vladimir Davydov <vdavydov@virtuozzo.com>
	Acked-by: Johannes Weiner <hannes@cmpxchg.org>
	Cc: Michal Hocko <mhocko@kernel.org>
	Cc: Tejun Heo <tj@kernel.org>
	Cc: Greg Thelen <gthelen@google.com>
	Cc: Christoph Lameter <cl@linux.com>
	Cc: Pekka Enberg <penberg@kernel.org>
	Cc: David Rientjes <rientjes@google.com>
	Cc: Joonsoo Kim <iamjoonsoo.kim@lge.com>
	Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
	Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
(cherry picked from commit 37f08dda29dac8a595999b8d3eaa9bf0f763dd9d)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	mm/vmalloc.c
diff --cc mm/vmalloc.c
index 90de46594b5f,9a58f9a1874d..000000000000
--- a/mm/vmalloc.c
+++ b/mm/vmalloc.c
@@@ -1628,12 -1606,11 +1628,19 @@@ static void *__vmalloc_area_node(struc
  
  	for (i = 0; i < area->nr_pages; i++) {
  		struct page *page;
 +		gfp_t tmp_mask = gfp_mask | __GFP_NOWARN;
  
++<<<<<<< HEAD
 +		if (node < 0)
 +			page = alloc_page(tmp_mask);
 +		else
 +			page = alloc_pages_node(node, tmp_mask, order);
++=======
+ 		if (node == NUMA_NO_NODE)
+ 			page = alloc_kmem_pages(alloc_mask, order);
+ 		else
+ 			page = alloc_kmem_pages_node(node, alloc_mask, order);
++>>>>>>> 37f08dda29da (vmalloc: allow to account vmalloc to memcg)
  
  		if (unlikely(!page)) {
  			/* Successfully allocated i pages, free them in __vunmap() */
* Unmerged path mm/vmalloc.c
