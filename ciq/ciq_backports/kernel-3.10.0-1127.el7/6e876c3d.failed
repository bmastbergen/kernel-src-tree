jbd2: fix invalid descriptor block checksum

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1127.el7
commit-author luojiajun <luojiajun3@huawei.com>
commit 6e876c3dd205d30b0db6850e97a03d75457df007
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1127.el7/6e876c3d.failed

In jbd2_journal_commit_transaction(), if we are in abort mode,
we may flush the buffer without setting descriptor block checksum
by goto start_journal_io. Then fs is mounted,
jbd2_descriptor_block_csum_verify() failed.

[  271.379811] EXT4-fs (vdd): shut down requested (2)
[  271.381827] Aborting journal on device vdd-8.
[  271.597136] JBD2: Invalid checksum recovering block 22199 in log
[  271.598023] JBD2: recovery failed
[  271.598484] EXT4-fs (vdd): error loading journal

Fix this problem by keep setting descriptor block checksum if the
descriptor buffer is not NULL.

This checksum problem can be reproduced by xfstests generic/388.

	Signed-off-by: luojiajun <luojiajun3@huawei.com>
	Signed-off-by: Theodore Ts'o <tytso@mit.edu>
	Reviewed-by: Jan Kara <jack@suse.cz>
(cherry picked from commit 6e876c3dd205d30b0db6850e97a03d75457df007)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/jbd2/commit.c
diff --cc fs/jbd2/commit.c
index 31a070a5dac7,efd0ce9489ae..000000000000
--- a/fs/jbd2/commit.c
+++ b/fs/jbd2/commit.c
@@@ -722,9 -694,11 +722,16 @@@ void jbd2_journal_commit_transaction(jo
                             the last tag we set up. */
  
  			tag->t_flags |= cpu_to_be16(JBD2_FLAG_LAST_TAG);
++<<<<<<< HEAD
 +
 +			jbd2_descr_block_csum_set(journal, descriptor);
++=======
++>>>>>>> 6e876c3dd205 (jbd2: fix invalid descriptor block checksum)
  start_journal_io:
+ 			if (descriptor)
+ 				jbd2_descriptor_block_csum_set(journal,
+ 							descriptor);
+ 
  			for (i = 0; i < bufs; i++) {
  				struct buffer_head *bh = wbuf[i];
  				/*
* Unmerged path fs/jbd2/commit.c
