device-dax: Set page->index

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1127.el7
commit-author Dan Williams <dan.j.williams@intel.com>
commit 35de299547d1c3300e078f9f7c6eb01dadae47f9
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1127.el7/35de2995.failed

In support of enabling memory_failure() handling for device-dax
mappings, set ->index to the pgoff of the page. The rmap implementation
requires ->index to bound the search through the vma interval tree.

The ->index value is never cleared. There is no possibility for the
page to become associated with another pgoff while the device is
enabled. When the device is disabled the 'struct page' array for the
device is destroyed and ->index is reinitialized to zero.

	Reviewed-by: Jan Kara <jack@suse.cz>
	Signed-off-by: Dan Williams <dan.j.williams@intel.com>
	Signed-off-by: Dave Jiang <dave.jiang@intel.com>
(cherry picked from commit 35de299547d1c3300e078f9f7c6eb01dadae47f9)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/dax/device.c
diff --cc drivers/dax/device.c
index 571ef367efdd,361a11089591..000000000000
--- a/drivers/dax/device.c
+++ b/drivers/dax/device.c
@@@ -434,6 -413,29 +434,32 @@@ static int dev_dax_huge_fault(struct vm
  	default:
  		rc = VM_FAULT_SIGBUS;
  	}
++<<<<<<< HEAD
++=======
+ 
+ 	if (rc == VM_FAULT_NOPAGE) {
+ 		unsigned long i;
+ 		pgoff_t pgoff;
+ 
+ 		/*
+ 		 * In the device-dax case the only possibility for a
+ 		 * VM_FAULT_NOPAGE result is when device-dax capacity is
+ 		 * mapped. No need to consider the zero page, or racing
+ 		 * conflicting mappings.
+ 		 */
+ 		pgoff = linear_page_index(vmf->vma, vmf->address
+ 				& ~(fault_size - 1));
+ 		for (i = 0; i < fault_size / PAGE_SIZE; i++) {
+ 			struct page *page;
+ 
+ 			page = pfn_to_page(pfn_t_to_pfn(pfn) + i);
+ 			if (page->mapping)
+ 				continue;
+ 			page->mapping = filp->f_mapping;
+ 			page->index = pgoff + i;
+ 		}
+ 	}
++>>>>>>> 35de299547d1 (device-dax: Set page->index)
  	dax_read_unlock(id);
  
  	return rc;
* Unmerged path drivers/dax/device.c
