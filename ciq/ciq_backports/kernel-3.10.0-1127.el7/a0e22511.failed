s390: add support for IBM z15 machines

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1127.el7
commit-author Martin Schwidefsky <schwidefsky@de.ibm.com>
commit a0e2251132995b962281aa80ab54a9288f9e0b6b
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1127.el7/a0e22511.failed

Add detection for machine types 0x8562 and 8x8561 and set the ELF platform
name to z15. Add the miscellaneous-instruction-extension 3 facility to
the list of facilities for z15.

And allow to generate code that only runs on a z15 machine.

	Reviewed-by: Christian Borntraeger <borntraeger@de.ibm.com>
	Signed-off-by: Martin Schwidefsky <schwidefsky@de.ibm.com>
	Signed-off-by: Heiko Carstens <heiko.carstens@de.ibm.com>
(cherry picked from commit a0e2251132995b962281aa80ab54a9288f9e0b6b)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/s390/Kconfig
#	arch/s390/Makefile
#	arch/s390/tools/gen_facilities.c
diff --cc arch/s390/Kconfig
index ebaf45ac4e5d,8c5b05d91106..000000000000
--- a/arch/s390/Kconfig
+++ b/arch/s390/Kconfig
@@@ -192,16 -233,17 +192,27 @@@ config HAVE_MARCH_Z13_FEATURE
  	def_bool n
  	select HAVE_MARCH_ZEC12_FEATURES
  
++<<<<<<< HEAD
++=======
+ config HAVE_MARCH_Z14_FEATURES
+ 	def_bool n
+ 	select HAVE_MARCH_Z13_FEATURES
+ 
+ config HAVE_MARCH_Z15_FEATURES
+ 	def_bool n
+ 	select HAVE_MARCH_Z14_FEATURES
+ 
++>>>>>>> a0e225113299 (s390: add support for IBM z15 machines)
  choice
  	prompt "Processor type"
 -	default MARCH_Z196
 +	default MARCH_G5
 +
 +config MARCH_G5
 +	bool "System/390 model G5 and G6"
 +	depends on !64BIT
 +	help
 +	  Select this to build a 31 bit kernel that works
 +	  on all ESA/390 and z/Architecture machines.
  
  config MARCH_Z900
  	bool "IBM zSeries model z800 and z900"
@@@ -252,18 -297,31 +263,26 @@@ config MARCH_ZEC1
  	  older machines.
  
  config MARCH_Z13
 -	bool "IBM z13s and z13"
 -	select HAVE_MARCH_Z13_FEATURES
 -	help
 -	  Select this to enable optimizations for IBM z13s and z13 (2965 and
 -	  2964 series). The kernel will be slightly faster but will not work on
 -	  older machines.
 -
 -config MARCH_Z14
 -	bool "IBM z14 ZR1 and z14"
 -	select HAVE_MARCH_Z14_FEATURES
 +	bool "IBM z13"
 +	select HAVE_MARCH_Z13_FEATURES if 64BIT
  	help
 -	  Select this to enable optimizations for IBM z14 ZR1 and z14 (3907
 -	  and 3906 series). The kernel will be slightly faster but will not
 -	  work on older machines.
 +	  Select this to enable optimizations for IBM z13 (2964 series).
 +	  The kernel will be slightly faster but will not work on older
 +	  machines.
  
+ config MARCH_Z15
+ 	bool "IBM z15"
+ 	select HAVE_MARCH_Z15_FEATURES
+ 	help
+ 	  Select this to enable optimizations for IBM z15 (8562
+ 	  and 8561 series). The kernel will be slightly faster but will not
+ 	  work on older machines.
+ 
  endchoice
  
 +config MARCH_G5_TUNE
 +	def_bool TUNE_G5 || MARCH_G5 && TUNE_DEFAULT
 +
  config MARCH_Z900_TUNE
  	def_bool TUNE_Z900 || MARCH_Z900 && TUNE_DEFAULT
  
@@@ -285,6 -343,12 +304,15 @@@ config MARCH_ZEC12_TUN
  config MARCH_Z13_TUNE
  	def_bool TUNE_Z13 || MARCH_Z13 && TUNE_DEFAULT
  
++<<<<<<< HEAD
++=======
+ config MARCH_Z14_TUNE
+ 	def_bool TUNE_Z14 || MARCH_Z14 && TUNE_DEFAULT
+ 
+ config MARCH_Z15_TUNE
+ 	def_bool TUNE_Z15 || MARCH_Z15 && TUNE_DEFAULT
+ 
++>>>>>>> a0e225113299 (s390: add support for IBM z15 machines)
  choice
  	prompt "Tune code generation"
  	default TUNE_DEFAULT
@@@ -326,6 -390,12 +354,15 @@@ config TUNE_ZEC1
  config TUNE_Z13
  	bool "IBM z13"
  
++<<<<<<< HEAD
++=======
+ config TUNE_Z14
+ 	bool "IBM z14"
+ 
+ config TUNE_Z15
+ 	bool "IBM z15"
+ 
++>>>>>>> a0e225113299 (s390: add support for IBM z15 machines)
  endchoice
  
  config 64BIT
diff --cc arch/s390/Makefile
index a1209ffc5263,478b645b20dd..000000000000
--- a/arch/s390/Makefile
+++ b/arch/s390/Makefile
@@@ -43,6 -44,10 +43,13 @@@ mflags-$(CONFIG_MARCH_Z10)    := -march
  mflags-$(CONFIG_MARCH_Z196)   := -march=z196
  mflags-$(CONFIG_MARCH_ZEC12)  := -march=zEC12
  mflags-$(CONFIG_MARCH_Z13)    := -march=z13
++<<<<<<< HEAD
++=======
+ mflags-$(CONFIG_MARCH_Z14)    := -march=z14
+ mflags-$(CONFIG_MARCH_Z15)    := -march=z15
+ 
+ export CC_FLAGS_MARCH := $(mflags-y)
++>>>>>>> a0e225113299 (s390: add support for IBM z15 machines)
  
  aflags-y += $(mflags-y)
  cflags-y += $(mflags-y)
@@@ -55,9 -59,10 +62,14 @@@ cflags-$(CONFIG_MARCH_Z10_TUNE)		+= -mt
  cflags-$(CONFIG_MARCH_Z196_TUNE)	+= -mtune=z196
  cflags-$(CONFIG_MARCH_ZEC12_TUNE)	+= -mtune=zEC12
  cflags-$(CONFIG_MARCH_Z13_TUNE)		+= -mtune=z13
++<<<<<<< HEAD
++=======
+ cflags-$(CONFIG_MARCH_Z14_TUNE)		+= -mtune=z14
+ cflags-$(CONFIG_MARCH_Z15_TUNE)		+= -mtune=z15
++>>>>>>> a0e225113299 (s390: add support for IBM z15 machines)
  
 -cflags-y += -Wa,-I$(srctree)/arch/$(ARCH)/include
 +#KBUILD_IMAGE is necessary for make rpm
 +KBUILD_IMAGE	:=arch/s390/boot/image
  
  #
  # Prevent tail-call optimizations, to get clearer backtraces:
* Unmerged path arch/s390/tools/gen_facilities.c
* Unmerged path arch/s390/Kconfig
* Unmerged path arch/s390/Makefile
diff --git a/arch/s390/kernel/setup.c b/arch/s390/kernel/setup.c
index 4f2bc9c92d24..534d0a5a5506 100644
--- a/arch/s390/kernel/setup.c
+++ b/arch/s390/kernel/setup.c
@@ -1010,6 +1010,10 @@ static void __init setup_hwcaps(void)
 	case 0x3907:
 		strcpy(elf_platform, "z14");
 		break;
+	case 0x8561:
+	case 0x8562:
+		strcpy(elf_platform, "z15");
+		break;
 	}
 
 	/*
* Unmerged path arch/s390/tools/gen_facilities.c
