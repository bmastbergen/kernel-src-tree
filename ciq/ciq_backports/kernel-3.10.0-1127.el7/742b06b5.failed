jbd2: check superblock mapped prior to committing

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1127.el7
commit-author Jiufei Xue <jiufei.xue@linux.alibaba.com>
commit 742b06b5628f2cd23cb51a034cb54dc33c6162c5
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1127.el7/742b06b5.failed

We hit a BUG at fs/buffer.c:3057 if we detached the nbd device
before unmounting ext4 filesystem.

The typical chain of events leading to the BUG:
jbd2_write_superblock
  submit_bh
    submit_bh_wbc
      BUG_ON(!buffer_mapped(bh));

The block device is removed and all the pages are invalidated. JBD2
was trying to write journal superblock to the block device which is
no longer present.

Fix this by checking the journal superblock's buffer head prior to
submitting.

	Reported-by: Eric Ren <renzhen@linux.alibaba.com>
	Signed-off-by: Jiufei Xue <jiufei.xue@linux.alibaba.com>
	Signed-off-by: Theodore Ts'o <tytso@mit.edu>
	Reviewed-by: Jan Kara <jack@suse.cz>
	Cc: stable@kernel.org
(cherry picked from commit 742b06b5628f2cd23cb51a034cb54dc33c6162c5)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/jbd2/journal.c
diff --cc fs/jbd2/journal.c
index 6aa7507dace9,37e16d969925..000000000000
--- a/fs/jbd2/journal.c
+++ b/fs/jbd2/journal.c
@@@ -1361,10 -1350,13 +1361,18 @@@ static int jbd2_write_superblock(journa
  	journal_superblock_t *sb = journal->j_superblock;
  	int ret;
  
++<<<<<<< HEAD
 +	trace_jbd2_write_superblock(journal, write_op);
++=======
+ 	/* Buffer got discarded which means block device got invalidated */
+ 	if (!buffer_mapped(bh))
+ 		return -EIO;
+ 
+ 	trace_jbd2_write_superblock(journal, write_flags);
++>>>>>>> 742b06b5628f (jbd2: check superblock mapped prior to committing)
  	if (!(journal->j_flags & JBD2_BARRIER))
 -		write_flags &= ~(REQ_FUA | REQ_PREFLUSH);
 +		write_op &= ~(REQ_FUA | REQ_FLUSH);
 +	lock_buffer(bh);
  	if (buffer_write_io_error(bh)) {
  		/*
  		 * Oh, dear.  A previous attempt to write the journal
* Unmerged path fs/jbd2/journal.c
