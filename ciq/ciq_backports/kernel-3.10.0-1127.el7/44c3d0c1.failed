ipv6: fix a lockdep splat

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1127.el7
commit-author Eric Dumazet <edumazet@google.com>
commit 44c3d0c1c0a880354e9de5d94175742e2c7c9683
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1127.el7/44c3d0c1.failed

Silence lockdep false positive about rcu_dereference() being
used in the wrong context.

First one should use rcu_dereference_protected() as we own the spinlock.

Second one should be a normal assignation, as no barrier is needed.

Fixes: 18367681a10bd ("ipv6 flowlabel: Convert np->ipv6_fl_list to RCU.")
	Reported-by: Dave Jones <davej@codemonkey.org.uk>
	Signed-off-by: Eric Dumazet <edumazet@google.com>
	Acked-by: Hannes Frederic Sowa <hannes@stressinduktion.org>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 44c3d0c1c0a880354e9de5d94175742e2c7c9683)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/ipv6/ip6_flowlabel.c
diff --cc net/ipv6/ip6_flowlabel.c
index 2ec0ef61a773,dc2db4f7b182..000000000000
--- a/net/ipv6/ip6_flowlabel.c
+++ b/net/ipv6/ip6_flowlabel.c
@@@ -502,9 -529,19 +502,14 @@@ int ipv6_flowlabel_opt(struct sock *sk
  
  	switch (freq.flr_action) {
  	case IPV6_FL_A_PUT:
 -		if (freq.flr_flags & IPV6_FL_F_REFLECT) {
 -			if (sk->sk_protocol != IPPROTO_TCP)
 -				return -ENOPROTOOPT;
 -			if (!np->repflow)
 -				return -ESRCH;
 -			np->flow_label = 0;
 -			np->repflow = 0;
 -			return 0;
 -		}
  		spin_lock_bh(&ip6_sk_fl_lock);
  		for (sflp = &np->ipv6_fl_list;
++<<<<<<< HEAD
 +		     (sfl = rcu_dereference(*sflp))!=NULL;
++=======
+ 		     (sfl = rcu_dereference_protected(*sflp,
+ 						      lockdep_is_held(&ip6_sk_fl_lock))) != NULL;
++>>>>>>> 44c3d0c1c0a8 (ipv6: fix a lockdep splat)
  		     sflp = &sfl->next) {
  			if (sfl->fl->label == freq.flr_label) {
  				if (freq.flr_label == (np->flow_label&IPV6_FLOWLABEL_MASK))
* Unmerged path net/ipv6/ip6_flowlabel.c
