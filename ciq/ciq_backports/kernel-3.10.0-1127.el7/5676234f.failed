scsi: target/iblock: Fix overrun in WRITE SAME emulation

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1127.el7
Rebuild_CHGLOG: - [scsi] target/iblock: Fix overrun in WRITE SAME emulation (Maurizio Lombardi) [1729507]
Rebuild_FUZZ: 94.34%
commit-author Roman Bolshakov <r.bolshakov@yadro.com>
commit 5676234f20fef02f6ca9bd66c63a8860fce62645
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1127.el7/5676234f.failed

WRITE SAME corrupts data on the block device behind iblock if the command
is emulated. The emulation code issues (M - 1) * N times more bios than
requested, where M is the number of 512 blocks per real block size and N is
the NUMBER OF LOGICAL BLOCKS specified in WRITE SAME command. So, for a
device with 4k blocks, 7 * N more LBAs gets written after the requested
range.

The issue happens because the number of 512 byte sectors to be written is
decreased one by one while the real bios are typically from 1 to 8 512 byte
sectors per bio.

Fixes: c66ac9db8d4a ("[SCSI] target: Add LIO target core v4.0.0-rc6")
	Cc: <stable@vger.kernel.org>
	Signed-off-by: Roman Bolshakov <r.bolshakov@yadro.com>
	Reviewed-by: Bart Van Assche <bvanassche@acm.org>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit 5676234f20fef02f6ca9bd66c63a8860fce62645)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/target/target_core_iblock.c
diff --cc drivers/target/target_core_iblock.c
index 21adae3c0ce3,efebacd36101..000000000000
--- a/drivers/target/target_core_iblock.c
+++ b/drivers/target/target_core_iblock.c
@@@ -507,11 -514,11 +507,16 @@@ iblock_execute_write_same(struct se_cm
  		}
  
  		/* Always in 512 byte units for Linux/Block */
++<<<<<<< HEAD
 +		block_lba += sg->length >> IBLOCK_LBA_SHIFT;
 +		sectors -= 1;
++=======
+ 		block_lba += sg->length >> SECTOR_SHIFT;
+ 		sectors -= sg->length >> SECTOR_SHIFT;
++>>>>>>> 5676234f20fe (scsi: target/iblock: Fix overrun in WRITE SAME emulation)
  	}
  
 -	iblock_submit_bios(&list);
 +	iblock_submit_bios(&list, WRITE);
  	return 0;
  
  fail_put_bios:
* Unmerged path drivers/target/target_core_iblock.c
