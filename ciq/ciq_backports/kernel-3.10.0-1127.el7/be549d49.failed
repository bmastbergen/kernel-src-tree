scsi: core: set result when the command cannot be dispatched

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1127.el7
commit-author Jaesoo Lee <jalee@purestorage.com>
commit be549d49115422f846b6d96ee8fd7173a5f7ceb0
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1127.el7/be549d49.failed

When SCSI blk-mq is enabled, there is a bug in handling errors in
scsi_queue_rq.  Specifically, the bug is not setting result field of
scsi_request correctly when the dispatch of the command has been
failed. Since the upper layer code including the sg_io ioctl expects to
receive any error status from result field of scsi_request, the error is
silently ignored and this could cause data corruptions for some
applications.

Fixes: d285203cf647 ("scsi: add support for a blk-mq based I/O path.")
	Cc: <stable@vger.kernel.org>
	Signed-off-by: Jaesoo Lee <jalee@purestorage.com>
	Reviewed-by: Hannes Reinecke <hare@suse.com>
	Reviewed-by: Bart Van Assche <bvanassche@acm.org>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit be549d49115422f846b6d96ee8fd7173a5f7ceb0)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/scsi_lib.c
diff --cc drivers/scsi/scsi_lib.c
index 5e5119713e3e,07dfc17d4824..000000000000
--- a/drivers/scsi/scsi_lib.c
+++ b/drivers/scsi/scsi_lib.c
@@@ -1919,14 -1698,20 +1919,22 @@@ out_dec_target_busy
  out_put_budget:
  	scsi_mq_put_budget(hctx);
  	switch (ret) {
 -	case BLK_STS_OK:
 -		break;
 -	case BLK_STS_RESOURCE:
 +	case BLK_MQ_RQ_QUEUE_BUSY:
  		if (atomic_read(&sdev->device_busy) ||
  		    scsi_device_blocked(sdev))
 -			ret = BLK_STS_DEV_RESOURCE;
 +			ret = BLK_MQ_RQ_QUEUE_DEV_BUSY;
  		break;
++<<<<<<< HEAD
 +	case BLK_MQ_RQ_QUEUE_ERROR:
++=======
+ 	default:
+ 		if (unlikely(!scsi_device_online(sdev)))
+ 			scsi_req(req)->result = DID_NO_CONNECT << 16;
+ 		else
+ 			scsi_req(req)->result = DID_ERROR << 16;
++>>>>>>> be549d491154 (scsi: core: set result when the command cannot be dispatched)
  		/*
- 		 * Make sure to release all allocated ressources when
+ 		 * Make sure to release all allocated resources when
  		 * we hit an error, as we will never see this command
  		 * again.
  		 */
* Unmerged path drivers/scsi/scsi_lib.c
