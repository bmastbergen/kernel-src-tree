scsi: iscsi: set auth_protocol back to NULL if CHAP_A value is not supported

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1127.el7
Rebuild_CHGLOG: - [scsi] iscsi: set auth_protocol back to NULL if CHAP_A value is not supported (Maurizio Lombardi) [1726689]
Rebuild_FUZZ: 95.89%
commit-author Maurizio Lombardi <mlombard@redhat.com>
commit 5dd6c49339126c2c8df2179041373222362d6e49
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1127.el7/5dd6c493.failed

If the CHAP_A value is not supported, the chap_server_open() function
should free the auth_protocol pointer and set it to NULL, or we will leave
a dangling pointer around.

[   66.010905] Unsupported CHAP_A value
[   66.011660] Security negotiation failed.
[   66.012443] iSCSI Login negotiation failed.
[   68.413924] general protection fault: 0000 [#1] SMP PTI
[   68.414962] CPU: 0 PID: 1562 Comm: targetcli Kdump: loaded Not tainted 4.18.0-80.el8.x86_64 #1
[   68.416589] Hardware name: Red Hat KVM, BIOS 0.5.1 01/01/2011
[   68.417677] RIP: 0010:__kmalloc_track_caller+0xc2/0x210

	Signed-off-by: Maurizio Lombardi <mlombard@redhat.com>
	Reviewed-by: Chris Leech <cleech@redhat.com>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit 5dd6c49339126c2c8df2179041373222362d6e49)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/target/iscsi/iscsi_target_auth.c
diff --cc drivers/target/iscsi/iscsi_target_auth.c
index 4e08540165b7,e2fa3a3bc81d..000000000000
--- a/drivers/target/iscsi/iscsi_target_auth.c
+++ b/drivers/target/iscsi/iscsi_target_auth.c
@@@ -122,6 -132,7 +128,10 @@@ static struct iscsi_chap *chap_server_o
  	case CHAP_DIGEST_UNKNOWN:
  	default:
  		pr_err("Unsupported CHAP_A value\n");
++<<<<<<< HEAD
++=======
+ 		chap_close(conn);
++>>>>>>> 5dd6c4933912 (scsi: iscsi: set auth_protocol back to NULL if CHAP_A value is not supported)
  		return NULL;
  	}
  
@@@ -135,7 -146,10 +145,14 @@@
  	/*
  	 * Generate Challenge.
  	 */
++<<<<<<< HEAD
 +	chap_gen_challenge(conn, 1, aic_str, aic_len);
++=======
+ 	if (chap_gen_challenge(conn, 1, aic_str, aic_len) < 0) {
+ 		chap_close(conn);
+ 		return NULL;
+ 	}
++>>>>>>> 5dd6c4933912 (scsi: iscsi: set auth_protocol back to NULL if CHAP_A value is not supported)
  
  	return chap;
  }
* Unmerged path drivers/target/iscsi/iscsi_target_auth.c
