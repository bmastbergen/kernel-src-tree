ext4: avoid panic during forced reboot

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1127.el7
commit-author Jan Kara <jack@suse.cz>
commit 1dc1097ff60e4105216da7cd0aa99032b039a994
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1127.el7/1dc1097f.failed

When admin calls "reboot -f" - i.e., does a hard system reboot by
directly calling reboot(2) - ext4 filesystem mounted with errors=panic
can panic the system. This happens because the underlying device gets
disabled without unmounting the filesystem and thus some syscall running
in parallel to reboot(2) can result in the filesystem getting IO errors.

This is somewhat surprising to the users so try improve the behavior by
switching to errors=remount-ro behavior when the system is running
reboot(2).

	Signed-off-by: Jan Kara <jack@suse.cz>
	Signed-off-by: Theodore Ts'o <tytso@mit.edu>
(cherry picked from commit 1dc1097ff60e4105216da7cd0aa99032b039a994)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/ext4/super.c
diff --cc fs/ext4/super.c
index b5f3a4a5cbaf,1a5729d8f9ec..000000000000
--- a/fs/ext4/super.c
+++ b/fs/ext4/super.c
@@@ -403,9 -478,8 +414,14 @@@ static void ext4_handle_error(struct su
  		 * before ->s_flags update
  		 */
  		smp_wmb();
++<<<<<<< HEAD
 +		sb->s_flags |= MS_RDONLY;
 +	}
 +	if (test_opt(sb, ERRORS_PANIC)) {
++=======
+ 		sb->s_flags |= SB_RDONLY;
+ 	} else if (test_opt(sb, ERRORS_PANIC)) {
++>>>>>>> 1dc1097ff60e (ext4: avoid panic during forced reboot)
  		if (EXT4_SB(sb)->s_journal &&
  		  !(EXT4_SB(sb)->s_journal->j_flags & JBD2_REC_ERR))
  			return;
* Unmerged path fs/ext4/super.c
