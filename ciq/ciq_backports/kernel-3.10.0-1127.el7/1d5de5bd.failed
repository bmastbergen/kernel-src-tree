scsi: sd: Quiesce warning if device does not report optimal I/O size

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1127.el7
commit-author Martin K. Petersen <martin.petersen@oracle.com>
commit 1d5de5bd311be7cd54f02f7cd164f0349a75c876
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1127.el7/1d5de5bd.failed

Commit a83da8a4509d ("scsi: sd: Optimal I/O size should be a multiple
of physical block size") split one conditional into several separate
statements in an effort to provide more accurate warning messages when
a device reports a nonsensical value. However, this reorganization
accidentally dropped the precondition of the reported value being
larger than zero. This lead to a warning getting emitted on devices
that do not report an optimal I/O size at all.

Remain silent if a device does not report an optimal I/O size.

Fixes: a83da8a4509d ("scsi: sd: Optimal I/O size should be a multiple of physical block size")
	Cc: Randy Dunlap <rdunlap@infradead.org>
	Cc: <stable@vger.kernel.org>
	Reported-by: Hussam Al-Tayeb <ht990332@gmx.com>
	Tested-by: Hussam Al-Tayeb <ht990332@gmx.com>
	Reviewed-by: Bart Van Assche <bvanassche@acm.org>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit 1d5de5bd311be7cd54f02f7cd164f0349a75c876)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/sd.c
diff --cc drivers/scsi/sd.c
index f65a22cbf36e,2b2bc4b49d78..000000000000
--- a/drivers/scsi/sd.c
+++ b/drivers/scsi/sd.c
@@@ -2819,6 -3045,72 +2819,75 @@@ static void sd_read_write_same(struct s
  		sdkp->ws10 = 1;
  }
  
++<<<<<<< HEAD
++=======
+ static void sd_read_security(struct scsi_disk *sdkp, unsigned char *buffer)
+ {
+ 	struct scsi_device *sdev = sdkp->device;
+ 
+ 	if (!sdev->security_supported)
+ 		return;
+ 
+ 	if (scsi_report_opcode(sdev, buffer, SD_BUF_SIZE,
+ 			SECURITY_PROTOCOL_IN) == 1 &&
+ 	    scsi_report_opcode(sdev, buffer, SD_BUF_SIZE,
+ 			SECURITY_PROTOCOL_OUT) == 1)
+ 		sdkp->security = 1;
+ }
+ 
+ /*
+  * Determine the device's preferred I/O size for reads and writes
+  * unless the reported value is unreasonably small, large, not a
+  * multiple of the physical block size, or simply garbage.
+  */
+ static bool sd_validate_opt_xfer_size(struct scsi_disk *sdkp,
+ 				      unsigned int dev_max)
+ {
+ 	struct scsi_device *sdp = sdkp->device;
+ 	unsigned int opt_xfer_bytes =
+ 		logical_to_bytes(sdp, sdkp->opt_xfer_blocks);
+ 
+ 	if (sdkp->opt_xfer_blocks == 0)
+ 		return false;
+ 
+ 	if (sdkp->opt_xfer_blocks > dev_max) {
+ 		sd_first_printk(KERN_WARNING, sdkp,
+ 				"Optimal transfer size %u logical blocks " \
+ 				"> dev_max (%u logical blocks)\n",
+ 				sdkp->opt_xfer_blocks, dev_max);
+ 		return false;
+ 	}
+ 
+ 	if (sdkp->opt_xfer_blocks > SD_DEF_XFER_BLOCKS) {
+ 		sd_first_printk(KERN_WARNING, sdkp,
+ 				"Optimal transfer size %u logical blocks " \
+ 				"> sd driver limit (%u logical blocks)\n",
+ 				sdkp->opt_xfer_blocks, SD_DEF_XFER_BLOCKS);
+ 		return false;
+ 	}
+ 
+ 	if (opt_xfer_bytes < PAGE_SIZE) {
+ 		sd_first_printk(KERN_WARNING, sdkp,
+ 				"Optimal transfer size %u bytes < " \
+ 				"PAGE_SIZE (%u bytes)\n",
+ 				opt_xfer_bytes, (unsigned int)PAGE_SIZE);
+ 		return false;
+ 	}
+ 
+ 	if (opt_xfer_bytes & (sdkp->physical_block_size - 1)) {
+ 		sd_first_printk(KERN_WARNING, sdkp,
+ 				"Optimal transfer size %u bytes not a " \
+ 				"multiple of physical block size (%u bytes)\n",
+ 				opt_xfer_bytes, sdkp->physical_block_size);
+ 		return false;
+ 	}
+ 
+ 	sd_first_printk(KERN_INFO, sdkp, "Optimal transfer size %u bytes\n",
+ 			opt_xfer_bytes);
+ 	return true;
+ }
+ 
++>>>>>>> 1d5de5bd311b (scsi: sd: Quiesce warning if device does not report optimal I/O size)
  /**
   *	sd_revalidate_disk - called the first time a new disk is seen,
   *	performs disk spin up, read_capacity, etc.
* Unmerged path drivers/scsi/sd.c
