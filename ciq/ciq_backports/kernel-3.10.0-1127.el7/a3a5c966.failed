evm: Don't update hmacs in user ns mounts

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1127.el7
commit-author Seth Forshee <seth.forshee@canonical.com>
commit a3a5c966a664dfde0393dd366c2cb916962d164f
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1127.el7/a3a5c966.failed

The kernel should not calculate new hmacs for mounts done by
non-root users. Update evm_calc_hmac_or_hash() to refuse to
calculate new hmacs for mounts for non-init user namespaces.

	Cc: linux-integrity@vger.kernel.org
	Cc: linux-security-module@vger.kernel.org
	Cc: linux-kernel@vger.kernel.org
	Cc: James Morris <james.l.morris@oracle.com>
	Cc: Mimi Zohar <zohar@linux.vnet.ibm.com>
	Cc: "Serge E. Hallyn" <serge@hallyn.com>
	Signed-off-by: Seth Forshee <seth.forshee@canonical.com>
	Signed-off-by: Dongsu Park <dongsu@kinvolk.io>
	Signed-off-by: Eric W. Biederman <ebiederm@xmission.com>
(cherry picked from commit a3a5c966a664dfde0393dd366c2cb916962d164f)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	security/integrity/evm/evm_crypto.c
diff --cc security/integrity/evm/evm_crypto.c
index e90ab0e20db8,facf9cdd577d..000000000000
--- a/security/integrity/evm/evm_crypto.c
+++ b/security/integrity/evm/evm_crypto.c
@@@ -136,9 -198,12 +136,14 @@@ static int evm_calc_hmac_or_hash(struc
  	char *xattr_value = NULL;
  	int error;
  	int size;
 -	bool ima_present = false;
  
++<<<<<<< HEAD
 +	if (!inode->i_op->getxattr)
++=======
+ 	if (!(inode->i_opflags & IOP_XATTR) ||
+ 	    inode->i_sb->s_user_ns != &init_user_ns)
++>>>>>>> a3a5c966a664 (evm: Don't update hmacs in user ns mounts)
  		return -EOPNOTSUPP;
 -
  	desc = init_desc(type);
  	if (IS_ERR(desc))
  		return PTR_ERR(desc);
* Unmerged path security/integrity/evm/evm_crypto.c
