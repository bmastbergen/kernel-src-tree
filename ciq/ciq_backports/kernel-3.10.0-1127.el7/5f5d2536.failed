net/mlx5: E-Switch, Use correct flags when configuring vlan

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1127.el7
commit-author Bodong Wang <bodong@mellanox.com>
commit 5f5d2536be8d5b5d3df925228ce7a6f4054d5956
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1127.el7/5f5d2536.failed

Before the offending commit, vlan will be configured if either vlan
or qos is set. After the change with new set flags, function callers
should provide flags accordingly.

Fixes: e33dfe316cf3 ("net/mlx5: E-Switch, Allow fine tuning of eswitch vport push/pop vlan")
	Signed-off-by: Bodong Wang <bodong@mellanox.com>
	Signed-off-by: Saeed Mahameed <saeedm@mellanox.com>
(cherry picked from commit 5f5d2536be8d5b5d3df925228ce7a6f4054d5956)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlx5/core/eswitch.c
diff --cc drivers/net/ethernet/mellanox/mlx5/core/eswitch.c
index 7a65b2da3f8b,0c75219d91b5..000000000000
--- a/drivers/net/ethernet/mellanox/mlx5/core/eswitch.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/eswitch.c
@@@ -1456,18 -1553,28 +1456,33 @@@ static void esw_apply_vport_conf(struc
  				 struct mlx5_vport *vport)
  {
  	int vport_num = vport->vport;
+ 	int flags;
  
 -	if (esw->manager_vport == vport_num)
 +	if (!vport_num)
  		return;
  
  	mlx5_modify_vport_admin_state(esw->dev,
  				      MLX5_VPORT_STATE_OP_MOD_ESW_VPORT,
 -				      vport_num, 1,
 +				      vport_num,
  				      vport->info.link_state);
++<<<<<<< HEAD
 +	mlx5_modify_nic_vport_mac_address(esw->dev, vport_num, vport->info.mac);
 +	mlx5_modify_nic_vport_node_guid(esw->dev, vport_num, vport->info.node_guid);
++=======
+ 
+ 	/* Host PF has its own mac/guid. */
+ 	if (vport_num) {
+ 		mlx5_modify_nic_vport_mac_address(esw->dev, vport_num,
+ 						  vport->info.mac);
+ 		mlx5_modify_nic_vport_node_guid(esw->dev, vport_num,
+ 						vport->info.node_guid);
+ 	}
+ 
+ 	flags = (vport->info.vlan || vport->info.qos) ?
+ 		SET_VLAN_STRIP | SET_VLAN_INSERT : 0;
++>>>>>>> 5f5d2536be8d (net/mlx5: E-Switch, Use correct flags when configuring vlan)
  	modify_esw_vport_cvlan(esw->dev, vport_num, vport->info.vlan, vport->info.qos,
- 			       (vport->info.vlan || vport->info.qos));
+ 			       flags);
  
  	/* Only legacy mode needs ACLs */
  	if (esw->mode == SRIOV_LEGACY) {
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/eswitch.c
