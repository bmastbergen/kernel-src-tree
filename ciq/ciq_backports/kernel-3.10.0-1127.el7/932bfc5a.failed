s390/cpumsf: Check for CPU Measurement sampling

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1127.el7
commit-author Thomas Richter <tmricht@linux.ibm.com>
commit 932bfc5aae08f3cb20c1c9f051542f5933710151
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1127.el7/932bfc5a.failed

s390 IBM z15 introduces a check if the CPU Mesurement Facility
sampling is temporarily unavailable. If this is the case return -EBUSY
and abort the setup of CPU Measuement facility sampling.

	Signed-off-by: Thomas Richter <tmricht@linux.ibm.com>
	Reviewed-by: Christian Borntraeger <borntraeger@de.ibm.com>
	Signed-off-by: Vasily Gorbik <gor@linux.ibm.com>
(cherry picked from commit 932bfc5aae08f3cb20c1c9f051542f5933710151)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/s390/include/asm/cpu_mf.h
diff --cc arch/s390/include/asm/cpu_mf.h
index c4dc34e462d3,753669bfbe99..000000000000
--- a/arch/s390/include/asm/cpu_mf.h
+++ b/arch/s390/include/asm/cpu_mf.h
@@@ -32,8 -27,9 +32,10 @@@
  #define CPU_MF_INT_SF_MASK	(CPU_MF_INT_SF_IAE|CPU_MF_INT_SF_ISE|	\
  				 CPU_MF_INT_SF_PRA|CPU_MF_INT_SF_SACA|	\
  				 CPU_MF_INT_SF_LSDA)
 +#define CPU_MF_INT_RI_MASK	(CPU_MF_INT_RI_HALTED|CPU_MF_INT_RI_BUF_FULL)
  
+ #define CPU_MF_SF_RIBM_NOTAV	0x1		/* Sampling unavailable */
+ 
  /* CPU measurement facility support */
  static inline int cpum_cf_avail(void)
  {
@@@ -75,8 -71,9 +77,14 @@@ struct hws_qsi_info_block {	    /* Bit(
  	unsigned long max_sampl_rate; /* 16-23: maximum sampling interval*/
  	unsigned long tear;	    /* 24-31: TEAR contents		 */
  	unsigned long dear;	    /* 32-39: DEAR contents		 */
++<<<<<<< HEAD
 +	unsigned int rsvrd0;	    /* 40-43: reserved			 */
 +	unsigned int cpu_speed;     /* 44-47: CPU speed 		 */
++=======
+ 	unsigned int rsvrd0:24;	    /* 40-42: reserved			 */
+ 	unsigned int ribm:8;	    /* 43: Reserved by IBM		 */
+ 	unsigned int cpu_speed;     /* 44-47: CPU speed			 */
++>>>>>>> 932bfc5aae08 (s390/cpumsf: Check for CPU Measurement sampling)
  	unsigned long long rsvrd1;  /* 48-55: reserved			 */
  	unsigned long long rsvrd2;  /* 56-63: reserved			 */
  } __packed;
* Unmerged path arch/s390/include/asm/cpu_mf.h
diff --git a/arch/s390/kernel/perf_cpum_sf.c b/arch/s390/kernel/perf_cpum_sf.c
index 521b44f733ce..4c2a9609d3c1 100644
--- a/arch/s390/kernel/perf_cpum_sf.c
+++ b/arch/s390/kernel/perf_cpum_sf.c
@@ -719,6 +719,12 @@ static int __hw_perf_event_init(struct perf_event *event)
 		goto out;
 	}
 
+	if (si.ribm & CPU_MF_SF_RIBM_NOTAV) {
+		pr_warn("CPU Measurement Facility sampling is temporarily not available\n");
+		err = -EBUSY;
+		goto out;
+	}
+
 	/* Always enable basic sampling */
 	SAMPL_FLAGS(hwc) = PERF_CPUM_SF_BASIC_MODE;
 
