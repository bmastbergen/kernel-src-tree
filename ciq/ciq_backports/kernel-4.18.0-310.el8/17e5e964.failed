KVM: SVM: Don't set current_vmcb->cpu when switching vmcb

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-310.el8
commit-author Sean Christopherson <seanjc@google.com>
commit 17e5e964eee05a3ee434cf0958ecce741a6874b1
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-310.el8/17e5e964.failed

Do not update the new vmcb's last-run cpu when switching to a different
vmcb.  If the vCPU is migrated between its last run and a vmcb switch,
e.g. for nested VM-Exit, then setting the cpu without marking the vmcb
dirty will lead to KVM running the vCPU on a different physical cpu with
stale clean bit settings.

                          vcpu->cpu    current_vmcb->cpu    hardware
  pre_svm_run()           cpu0         cpu0                 cpu0,clean
  kvm_arch_vcpu_load()    cpu1         cpu0                 cpu0,clean
  svm_switch_vmcb()       cpu1         cpu1                 cpu0,clean
  pre_svm_run()           cpu1         cpu1                 kaboom

Simply delete the offending code; unlike VMX, which needs to update the
cpu at switch time due to the need to do VMPTRLD, SVM only cares about
which cpu last ran the vCPU.

Fixes: af18fa775d07 ("KVM: nSVM: Track the physical cpu of the vmcb vmrun through the vmcb")
	Cc: Cathy Avery <cavery@redhat.com>
	Signed-off-by: Sean Christopherson <seanjc@google.com>
Message-Id: <20210406171811.4043363-2-seanjc@google.com>
	Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
(cherry picked from commit 17e5e964eee05a3ee434cf0958ecce741a6874b1)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kvm/svm/svm.c
diff --cc arch/x86/kvm/svm/svm.c
index b60ae08fb034,04ef49d3862d..000000000000
--- a/arch/x86/kvm/svm/svm.c
+++ b/arch/x86/kvm/svm/svm.c
@@@ -1305,6 -1306,13 +1305,16 @@@ static void svm_vcpu_reset(struct kvm_v
  		avic_update_vapic_bar(svm, APIC_DEFAULT_PHYS_BASE);
  }
  
++<<<<<<< HEAD
++=======
+ void svm_switch_vmcb(struct vcpu_svm *svm, struct kvm_vmcb_info *target_vmcb)
+ {
+ 	svm->current_vmcb = target_vmcb;
+ 	svm->vmcb = target_vmcb->ptr;
+ 	svm->vmcb_pa = target_vmcb->pa;
+ }
+ 
++>>>>>>> 17e5e964eee0 (KVM: SVM: Don't set current_vmcb->cpu when switching vmcb)
  static int svm_create_vcpu(struct kvm_vcpu *vcpu)
  {
  	struct vcpu_svm *svm;
* Unmerged path arch/x86/kvm/svm/svm.c
