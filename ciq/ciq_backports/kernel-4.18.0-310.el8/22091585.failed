Bluetooth: Adding driver and quirk defs for multi-role LE

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-310.el8
commit-author Alain Michaud <alainm@chromium.org>
commit 220915857e29795ae5ba4222806268b4a99c19c1
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-310.el8/22091585.failed

This change adds the relevant driver and quirk to allow drivers to
report the le_states as being trustworthy.

This has historically been disabled as controllers did not reliably
support this. In particular, this will be used to relax this condition
for controllers that have been well tested and reliable.

	/* Most controller will fail if we try to create new connections
	 * while we have an existing one in slave role.
	 */
	if (hdev->conn_hash.le_num_slave > 0)
		return NULL;

	Signed-off-by: Alain Michaud <alainm@chromium.org>
	Signed-off-by: Marcel Holtmann <marcel@holtmann.org>
(cherry picked from commit 220915857e29795ae5ba4222806268b4a99c19c1)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/bluetooth/btusb.c
diff --cc drivers/bluetooth/btusb.c
index b32b2643519d,9a0ac333c886..000000000000
--- a/drivers/bluetooth/btusb.c
+++ b/drivers/bluetooth/btusb.c
@@@ -73,7 -58,7 +73,11 @@@ static struct usb_driver btusb_driver
  #define BTUSB_CW6622		0x100000
  #define BTUSB_MEDIATEK		0x200000
  #define BTUSB_WIDEBAND_SPEECH	0x400000
++<<<<<<< HEAD
 +#define BTUSB_INTEL_NEWGEN	0x2000000
++=======
+ #define BTUSB_VALID_LE_STATES   0x800000
++>>>>>>> 220915857e29 (Bluetooth: Adding driver and quirk defs for multi-role LE)
  
  static const struct usb_device_id btusb_table[] = {
  	/* Generic Bluetooth USB device */
* Unmerged path drivers/bluetooth/btusb.c
diff --git a/include/net/bluetooth/hci.h b/include/net/bluetooth/hci.h
index 233f2ad2a5ed..888ed698ee49 100644
--- a/include/net/bluetooth/hci.h
+++ b/include/net/bluetooth/hci.h
@@ -217,6 +217,15 @@ enum {
 	 * This quirk must be set before hci_register_dev is called.
 	 */
 	HCI_QUIRK_WIDEBAND_SPEECH_SUPPORTED,
+
+	/* When this quirk is set, the controller has validated that
+	 * LE states reported through the HCI_LE_READ_SUPPORTED_STATES are
+	 * valid.  This mechanism is necessary as many controllers have
+	 * been seen has having trouble initiating a connectable
+	 * advertisement despite the state combination being reported as
+	 * supported.
+	 */
+	HCI_QUIRK_VALID_LE_STATES,
 };
 
 /* HCI device flags */
