RDMA: Move more uverbs_cmd_mask settings to the core

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-310.el8
commit-author Jason Gunthorpe <jgg@nvidia.com>
commit 44ce37bc8bf30283d16c5e5f20964b638bebd429
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-310.el8/44ce37bc.failed

These functions all depend on the driver providing a specific op:

- REREG_MR is rereg_user_mr(). bnxt_re set this without providing the op
- ATTACH/DEATCH_MCAST is attach_mcast()/detach_mcast(). usnic set this
  without providing the op
- OPEN_QP doesn't involve the driver but requires a XRCD. qedr provides
  xrcd but forgot to set it, usnic doesn't provide XRCD but set it anyhow.
- OPEN/CLOSE_XRCD are the ops alloc_xrcd()/dealloc_xrcd()
- CREATE_SRQ/DESTROY_SRQ are the ops create_srq()/destroy_srq()
- QUERY/MODIFY_SRQ is op query_srq()/modify_srq(). hns sets this but
  sometimes supplies a NULL op.
- RESIZE_CQ is op resize_cq(). bnxt_re sets this boes doesn't supply an op
- ALLOC/DEALLOC_MW is alloc_mw()/dealloc_mw(). cxgb4 provided an
  (now deleted) implementation but no userspace

All drivers were checked that no drivers provide the op without also
setting uverbs_cmd_mask so this should have no functional change.

Link: https://lore.kernel.org/r/4-v1-caa70ba3d1ab+1436e-ucmd_mask_jgg@nvidia.com
	Signed-off-by: Jason Gunthorpe <jgg@nvidia.com>
(cherry picked from commit 44ce37bc8bf30283d16c5e5f20964b638bebd429)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/core/device.c
#	drivers/infiniband/hw/bnxt_re/main.c
#	drivers/infiniband/hw/hns/hns_roce_main.c
#	drivers/infiniband/hw/mlx4/main.c
#	drivers/infiniband/hw/mlx5/main.c
#	drivers/infiniband/hw/mthca/mthca_provider.c
#	drivers/infiniband/hw/ocrdma/ocrdma_main.c
#	drivers/infiniband/hw/qedr/main.c
#	drivers/infiniband/hw/usnic/usnic_ib_main.c
#	drivers/infiniband/sw/rdmavt/vt.c
#	drivers/infiniband/sw/rxe/rxe_verbs.c
diff --cc drivers/infiniband/core/device.c
index 30a7bf1c3b41,9e925369215c..000000000000
--- a/drivers/infiniband/core/device.c
+++ b/drivers/infiniband/core/device.c
@@@ -601,9 -601,45 +602,51 @@@ struct ib_device *_ib_alloc_device(size
  	init_completion(&device->unreg_completion);
  	INIT_WORK(&device->unregistration_work, ib_unregister_work);
  
++<<<<<<< HEAD
 +	spin_lock_init(&device->cq_pools_lock);
 +	for (i = 0; i < ARRAY_SIZE(device->cq_pools); i++)
 +		INIT_LIST_HEAD(&device->cq_pools[i]);
++=======
+ 	device->uverbs_cmd_mask =
+ 		BIT_ULL(IB_USER_VERBS_CMD_ALLOC_MW) |
+ 		BIT_ULL(IB_USER_VERBS_CMD_ALLOC_PD) |
+ 		BIT_ULL(IB_USER_VERBS_CMD_ATTACH_MCAST) |
+ 		BIT_ULL(IB_USER_VERBS_CMD_CLOSE_XRCD) |
+ 		BIT_ULL(IB_USER_VERBS_CMD_CREATE_COMP_CHANNEL) |
+ 		BIT_ULL(IB_USER_VERBS_CMD_CREATE_CQ) |
+ 		BIT_ULL(IB_USER_VERBS_CMD_CREATE_QP) |
+ 		BIT_ULL(IB_USER_VERBS_CMD_CREATE_SRQ) |
+ 		BIT_ULL(IB_USER_VERBS_CMD_DEALLOC_MW) |
+ 		BIT_ULL(IB_USER_VERBS_CMD_DEALLOC_PD) |
+ 		BIT_ULL(IB_USER_VERBS_CMD_DEREG_MR) |
+ 		BIT_ULL(IB_USER_VERBS_CMD_DESTROY_CQ) |
+ 		BIT_ULL(IB_USER_VERBS_CMD_DESTROY_QP) |
+ 		BIT_ULL(IB_USER_VERBS_CMD_DESTROY_SRQ) |
+ 		BIT_ULL(IB_USER_VERBS_CMD_DETACH_MCAST) |
+ 		BIT_ULL(IB_USER_VERBS_CMD_GET_CONTEXT) |
+ 		BIT_ULL(IB_USER_VERBS_CMD_MODIFY_QP) |
+ 		BIT_ULL(IB_USER_VERBS_CMD_MODIFY_SRQ) |
+ 		BIT_ULL(IB_USER_VERBS_CMD_OPEN_QP) |
+ 		BIT_ULL(IB_USER_VERBS_CMD_OPEN_XRCD) |
+ 		BIT_ULL(IB_USER_VERBS_CMD_QUERY_DEVICE) |
+ 		BIT_ULL(IB_USER_VERBS_CMD_QUERY_PORT) |
+ 		BIT_ULL(IB_USER_VERBS_CMD_QUERY_QP) |
+ 		BIT_ULL(IB_USER_VERBS_CMD_QUERY_SRQ) |
+ 		BIT_ULL(IB_USER_VERBS_CMD_REG_MR) |
+ 		BIT_ULL(IB_USER_VERBS_CMD_REREG_MR) |
+ 		BIT_ULL(IB_USER_VERBS_CMD_RESIZE_CQ);
+ 
+ 	device->uverbs_ex_cmd_mask =
+ 		BIT_ULL(IB_USER_VERBS_EX_CMD_CREATE_FLOW) |
+ 		BIT_ULL(IB_USER_VERBS_EX_CMD_CREATE_RWQ_IND_TBL) |
+ 		BIT_ULL(IB_USER_VERBS_EX_CMD_CREATE_WQ) |
+ 		BIT_ULL(IB_USER_VERBS_EX_CMD_DESTROY_FLOW) |
+ 		BIT_ULL(IB_USER_VERBS_EX_CMD_DESTROY_RWQ_IND_TBL) |
+ 		BIT_ULL(IB_USER_VERBS_EX_CMD_DESTROY_WQ) |
+ 		BIT_ULL(IB_USER_VERBS_EX_CMD_MODIFY_CQ) |
+ 		BIT_ULL(IB_USER_VERBS_EX_CMD_MODIFY_WQ) |
+ 		BIT_ULL(IB_USER_VERBS_EX_CMD_QUERY_DEVICE);
++>>>>>>> 44ce37bc8bf3 (RDMA: Move more uverbs_cmd_mask settings to the core)
  
  	return device;
  }
diff --cc drivers/infiniband/hw/bnxt_re/main.c
index 53aee5a42ab8,47ebbba4a207..000000000000
--- a/drivers/infiniband/hw/bnxt_re/main.c
+++ b/drivers/infiniband/hw/bnxt_re/main.c
@@@ -702,27 -702,7 +702,31 @@@ static int bnxt_re_register_ib(struct b
  	ibdev->local_dma_lkey = BNXT_QPLIB_RSVD_LKEY;
  
  	/* User space */
++<<<<<<< HEAD
 +	ibdev->uverbs_cmd_mask =
 +			(1ull << IB_USER_VERBS_CMD_GET_CONTEXT)		|
 +			(1ull << IB_USER_VERBS_CMD_QUERY_DEVICE)	|
 +			(1ull << IB_USER_VERBS_CMD_QUERY_PORT)		|
 +			(1ull << IB_USER_VERBS_CMD_ALLOC_PD)		|
 +			(1ull << IB_USER_VERBS_CMD_DEALLOC_PD)		|
 +			(1ull << IB_USER_VERBS_CMD_REG_MR)		|
 +			(1ull << IB_USER_VERBS_CMD_REREG_MR)		|
 +			(1ull << IB_USER_VERBS_CMD_DEREG_MR)		|
 +			(1ull << IB_USER_VERBS_CMD_CREATE_COMP_CHANNEL) |
 +			(1ull << IB_USER_VERBS_CMD_CREATE_CQ)		|
 +			(1ull << IB_USER_VERBS_CMD_RESIZE_CQ)		|
 +			(1ull << IB_USER_VERBS_CMD_DESTROY_CQ)		|
 +			(1ull << IB_USER_VERBS_CMD_CREATE_QP)		|
 +			(1ull << IB_USER_VERBS_CMD_MODIFY_QP)		|
 +			(1ull << IB_USER_VERBS_CMD_QUERY_QP)		|
 +			(1ull << IB_USER_VERBS_CMD_DESTROY_QP)		|
 +			(1ull << IB_USER_VERBS_CMD_CREATE_SRQ)		|
 +			(1ull << IB_USER_VERBS_CMD_MODIFY_SRQ)		|
 +			(1ull << IB_USER_VERBS_CMD_QUERY_SRQ)		|
 +			(1ull << IB_USER_VERBS_CMD_DESTROY_SRQ)		|
++=======
+ 	ibdev->uverbs_cmd_mask |=
++>>>>>>> 44ce37bc8bf3 (RDMA: Move more uverbs_cmd_mask settings to the core)
  			(1ull << IB_USER_VERBS_CMD_CREATE_AH)		|
  			(1ull << IB_USER_VERBS_CMD_MODIFY_AH)		|
  			(1ull << IB_USER_VERBS_CMD_QUERY_AH)		|
diff --cc drivers/infiniband/hw/hns/hns_roce_main.c
index 8b1f50f7c10f,a56de14626af..000000000000
--- a/drivers/infiniband/hw/hns/hns_roce_main.c
+++ b/drivers/infiniband/hw/hns/hns_roce_main.c
@@@ -470,36 -485,32 +470,53 @@@ static int hns_roce_register_device(str
  
  	ib_dev = &hr_dev->ib_dev;
  
 -	ib_dev->node_type = RDMA_NODE_IB_CA;
 -	ib_dev->dev.parent = dev;
 -
 -	ib_dev->phys_port_cnt = hr_dev->caps.num_ports;
 -	ib_dev->local_dma_lkey = hr_dev->caps.reserved_lkey;
 -	ib_dev->num_comp_vectors = hr_dev->caps.num_comp_vectors;
 +	ib_dev->node_type		= RDMA_NODE_IB_CA;
 +	ib_dev->dev.parent		= dev;
 +
 +	ib_dev->phys_port_cnt		= hr_dev->caps.num_ports;
 +	ib_dev->local_dma_lkey		= hr_dev->caps.reserved_lkey;
 +	ib_dev->num_comp_vectors	= hr_dev->caps.num_comp_vectors;
 +	ib_dev->uverbs_cmd_mask		=
 +		(1ULL << IB_USER_VERBS_CMD_GET_CONTEXT) |
 +		(1ULL << IB_USER_VERBS_CMD_QUERY_DEVICE) |
 +		(1ULL << IB_USER_VERBS_CMD_QUERY_PORT) |
 +		(1ULL << IB_USER_VERBS_CMD_ALLOC_PD) |
 +		(1ULL << IB_USER_VERBS_CMD_DEALLOC_PD) |
 +		(1ULL << IB_USER_VERBS_CMD_REG_MR) |
 +		(1ULL << IB_USER_VERBS_CMD_DEREG_MR) |
 +		(1ULL << IB_USER_VERBS_CMD_CREATE_COMP_CHANNEL) |
 +		(1ULL << IB_USER_VERBS_CMD_CREATE_CQ) |
 +		(1ULL << IB_USER_VERBS_CMD_DESTROY_CQ) |
 +		(1ULL << IB_USER_VERBS_CMD_CREATE_QP) |
 +		(1ULL << IB_USER_VERBS_CMD_MODIFY_QP) |
 +		(1ULL << IB_USER_VERBS_CMD_QUERY_QP) |
 +		(1ULL << IB_USER_VERBS_CMD_DESTROY_QP);
 +
 +	ib_dev->uverbs_ex_cmd_mask |=
 +		(1ULL << IB_USER_VERBS_EX_CMD_MODIFY_CQ);
  
- 	if (hr_dev->caps.flags & HNS_ROCE_CAP_FLAG_REREG_MR) {
- 		ib_dev->uverbs_cmd_mask |= (1ULL << IB_USER_VERBS_CMD_REREG_MR);
+ 	if (hr_dev->caps.flags & HNS_ROCE_CAP_FLAG_REREG_MR)
  		ib_set_device_ops(ib_dev, &hns_roce_dev_mr_ops);
+ 
++<<<<<<< HEAD
++=======
+ 	/* MW */
+ 	if (hr_dev->caps.flags & HNS_ROCE_CAP_FLAG_MW)
+ 		ib_set_device_ops(ib_dev, &hns_roce_dev_mw_ops);
+ 
+ 	/* FRMR */
+ 	if (hr_dev->caps.flags & HNS_ROCE_CAP_FLAG_FRMR)
+ 		ib_set_device_ops(ib_dev, &hns_roce_dev_frmr_ops);
+ 
+ 	/* SRQ */
+ 	if (hr_dev->caps.flags & HNS_ROCE_CAP_FLAG_SRQ) {
+ 		ib_dev->uverbs_cmd_mask |=
+ 				(1ULL << IB_USER_VERBS_CMD_POST_SRQ_RECV);
+ 		ib_set_device_ops(ib_dev, &hns_roce_dev_srq_ops);
+ 		ib_set_device_ops(ib_dev, hr_dev->hw->hns_roce_dev_srq_ops);
  	}
  
++>>>>>>> 44ce37bc8bf3 (RDMA: Move more uverbs_cmd_mask settings to the core)
  	ib_set_device_ops(ib_dev, hr_dev->hw->hns_roce_dev_ops);
  	ib_set_device_ops(ib_dev, &hns_roce_dev_ops);
  	for (i = 0; i < hr_dev->caps.num_ports; i++) {
diff --cc drivers/infiniband/hw/mlx4/main.c
index 83d23bae44ad,63007ece56b4..000000000000
--- a/drivers/infiniband/hw/mlx4/main.c
+++ b/drivers/infiniband/hw/mlx4/main.c
@@@ -2655,31 -2657,8 +2655,36 @@@ static void *mlx4_ib_add(struct mlx4_de
  	ibdev->ib_dev.num_comp_vectors	= dev->caps.num_comp_vectors;
  	ibdev->ib_dev.dev.parent	= &dev->persist->pdev->dev;
  
++<<<<<<< HEAD
 +	ibdev->ib_dev.uverbs_cmd_mask	=
 +		(1ull << IB_USER_VERBS_CMD_GET_CONTEXT)		|
 +		(1ull << IB_USER_VERBS_CMD_QUERY_DEVICE)	|
 +		(1ull << IB_USER_VERBS_CMD_QUERY_PORT)		|
 +		(1ull << IB_USER_VERBS_CMD_ALLOC_PD)		|
 +		(1ull << IB_USER_VERBS_CMD_DEALLOC_PD)		|
 +		(1ull << IB_USER_VERBS_CMD_REG_MR)		|
 +		(1ull << IB_USER_VERBS_CMD_REREG_MR)		|
 +		(1ull << IB_USER_VERBS_CMD_DEREG_MR)		|
 +		(1ull << IB_USER_VERBS_CMD_CREATE_COMP_CHANNEL)	|
 +		(1ull << IB_USER_VERBS_CMD_CREATE_CQ)		|
 +		(1ull << IB_USER_VERBS_CMD_RESIZE_CQ)		|
 +		(1ull << IB_USER_VERBS_CMD_DESTROY_CQ)		|
 +		(1ull << IB_USER_VERBS_CMD_CREATE_QP)		|
 +		(1ull << IB_USER_VERBS_CMD_MODIFY_QP)		|
 +		(1ull << IB_USER_VERBS_CMD_QUERY_QP)		|
 +		(1ull << IB_USER_VERBS_CMD_DESTROY_QP)		|
 +		(1ull << IB_USER_VERBS_CMD_ATTACH_MCAST)	|
 +		(1ull << IB_USER_VERBS_CMD_DETACH_MCAST)	|
 +		(1ull << IB_USER_VERBS_CMD_CREATE_SRQ)		|
 +		(1ull << IB_USER_VERBS_CMD_MODIFY_SRQ)		|
 +		(1ull << IB_USER_VERBS_CMD_QUERY_SRQ)		|
 +		(1ull << IB_USER_VERBS_CMD_DESTROY_SRQ)		|
 +		(1ull << IB_USER_VERBS_CMD_CREATE_XSRQ)		|
 +		(1ull << IB_USER_VERBS_CMD_OPEN_QP);
++=======
+ 	ibdev->ib_dev.uverbs_cmd_mask |=
+ 		(1ull << IB_USER_VERBS_CMD_CREATE_XSRQ);
++>>>>>>> 44ce37bc8bf3 (RDMA: Move more uverbs_cmd_mask settings to the core)
  
  	ib_set_device_ops(&ibdev->ib_dev, &mlx4_ib_dev_ops);
  	ibdev->ib_dev.uverbs_ex_cmd_mask |=
@@@ -2692,28 -2669,14 +2697,21 @@@
  	    ((mlx4_ib_port_link_layer(&ibdev->ib_dev, 1) ==
  	    IB_LINK_LAYER_ETHERNET) ||
  	    (mlx4_ib_port_link_layer(&ibdev->ib_dev, 2) ==
 -	    IB_LINK_LAYER_ETHERNET)))
 +	    IB_LINK_LAYER_ETHERNET))) {
 +		ibdev->ib_dev.uverbs_ex_cmd_mask |=
 +			(1ull << IB_USER_VERBS_EX_CMD_CREATE_WQ)	  |
 +			(1ull << IB_USER_VERBS_EX_CMD_MODIFY_WQ)	  |
 +			(1ull << IB_USER_VERBS_EX_CMD_DESTROY_WQ)	  |
 +			(1ull << IB_USER_VERBS_EX_CMD_CREATE_RWQ_IND_TBL) |
 +			(1ull << IB_USER_VERBS_EX_CMD_DESTROY_RWQ_IND_TBL);
  		ib_set_device_ops(&ibdev->ib_dev, &mlx4_ib_dev_wq_ops);
 +	}
  
  	if (dev->caps.flags & MLX4_DEV_CAP_FLAG_MEM_WINDOW ||
- 	    dev->caps.bmme_flags & MLX4_BMME_FLAG_TYPE_2_WIN) {
- 		ibdev->ib_dev.uverbs_cmd_mask |=
- 			(1ull << IB_USER_VERBS_CMD_ALLOC_MW) |
- 			(1ull << IB_USER_VERBS_CMD_DEALLOC_MW);
+ 	    dev->caps.bmme_flags & MLX4_BMME_FLAG_TYPE_2_WIN)
  		ib_set_device_ops(&ibdev->ib_dev, &mlx4_ib_dev_mw_ops);
- 	}
  
  	if (dev->caps.flags & MLX4_DEV_CAP_FLAG_XRC) {
- 		ibdev->ib_dev.uverbs_cmd_mask |=
- 			(1ull << IB_USER_VERBS_CMD_OPEN_XRCD) |
- 			(1ull << IB_USER_VERBS_CMD_CLOSE_XRCD);
  		ib_set_device_ops(&ibdev->ib_dev, &mlx4_ib_dev_xrc_ops);
  	}
  
diff --cc drivers/infiniband/hw/mlx5/main.c
index 97d5f414e693,b17c2c8758f2..000000000000
--- a/drivers/infiniband/hw/mlx5/main.c
+++ b/drivers/infiniband/hw/mlx5/main.c
@@@ -4150,41 -4139,14 +4150,46 @@@ static int mlx5_ib_stage_caps_init(stru
  	struct mlx5_core_dev *mdev = dev->mdev;
  	int err;
  
 -	dev->ib_dev.uverbs_cmd_mask |=
 +	dev->ib_dev.uverbs_cmd_mask	=
 +		(1ull << IB_USER_VERBS_CMD_GET_CONTEXT)		|
 +		(1ull << IB_USER_VERBS_CMD_QUERY_DEVICE)	|
 +		(1ull << IB_USER_VERBS_CMD_QUERY_PORT)		|
 +		(1ull << IB_USER_VERBS_CMD_ALLOC_PD)		|
 +		(1ull << IB_USER_VERBS_CMD_DEALLOC_PD)		|
  		(1ull << IB_USER_VERBS_CMD_CREATE_AH)		|
  		(1ull << IB_USER_VERBS_CMD_DESTROY_AH)		|
++<<<<<<< HEAD
 +		(1ull << IB_USER_VERBS_CMD_REG_MR)		|
 +		(1ull << IB_USER_VERBS_CMD_REREG_MR)		|
 +		(1ull << IB_USER_VERBS_CMD_DEREG_MR)		|
 +		(1ull << IB_USER_VERBS_CMD_CREATE_COMP_CHANNEL)	|
 +		(1ull << IB_USER_VERBS_CMD_CREATE_CQ)		|
 +		(1ull << IB_USER_VERBS_CMD_RESIZE_CQ)		|
 +		(1ull << IB_USER_VERBS_CMD_DESTROY_CQ)		|
 +		(1ull << IB_USER_VERBS_CMD_CREATE_QP)		|
 +		(1ull << IB_USER_VERBS_CMD_MODIFY_QP)		|
 +		(1ull << IB_USER_VERBS_CMD_QUERY_QP)		|
 +		(1ull << IB_USER_VERBS_CMD_DESTROY_QP)		|
 +		(1ull << IB_USER_VERBS_CMD_ATTACH_MCAST)	|
 +		(1ull << IB_USER_VERBS_CMD_DETACH_MCAST)	|
 +		(1ull << IB_USER_VERBS_CMD_CREATE_SRQ)		|
 +		(1ull << IB_USER_VERBS_CMD_MODIFY_SRQ)		|
 +		(1ull << IB_USER_VERBS_CMD_QUERY_SRQ)		|
 +		(1ull << IB_USER_VERBS_CMD_DESTROY_SRQ)		|
 +		(1ull << IB_USER_VERBS_CMD_CREATE_XSRQ)		|
 +		(1ull << IB_USER_VERBS_CMD_OPEN_QP);
 +	dev->ib_dev.uverbs_ex_cmd_mask =
 +		(1ull << IB_USER_VERBS_EX_CMD_QUERY_DEVICE)	|
++=======
+ 		(1ull << IB_USER_VERBS_CMD_CREATE_XSRQ);
+ 	dev->ib_dev.uverbs_ex_cmd_mask |=
++>>>>>>> 44ce37bc8bf3 (RDMA: Move more uverbs_cmd_mask settings to the core)
  		(1ull << IB_USER_VERBS_EX_CMD_CREATE_CQ)	|
  		(1ull << IB_USER_VERBS_EX_CMD_CREATE_QP)	|
 -		(1ull << IB_USER_VERBS_EX_CMD_MODIFY_QP);
 +		(1ull << IB_USER_VERBS_EX_CMD_MODIFY_QP)	|
 +		(1ull << IB_USER_VERBS_EX_CMD_MODIFY_CQ)	|
 +		(1ull << IB_USER_VERBS_EX_CMD_CREATE_FLOW)	|
 +		(1ull << IB_USER_VERBS_EX_CMD_DESTROY_FLOW);
  
  	if (MLX5_CAP_GEN(mdev, ipoib_enhanced_offloads) &&
  	    IS_ENABLED(CONFIG_MLX5_CORE_IPOIB))
diff --cc drivers/infiniband/hw/mthca/mthca_provider.c
index 368e0268177f,ea4a8deabfb6..000000000000
--- a/drivers/infiniband/hw/mthca/mthca_provider.c
+++ b/drivers/infiniband/hw/mthca/mthca_provider.c
@@@ -1153,24 -1158,6 +1153,27 @@@ int mthca_register_device(struct mthca_
  	if (ret)
  		return ret;
  
++<<<<<<< HEAD
 +	dev->ib_dev.uverbs_cmd_mask	 =
 +		(1ull << IB_USER_VERBS_CMD_GET_CONTEXT)		|
 +		(1ull << IB_USER_VERBS_CMD_QUERY_DEVICE)	|
 +		(1ull << IB_USER_VERBS_CMD_QUERY_PORT)		|
 +		(1ull << IB_USER_VERBS_CMD_ALLOC_PD)		|
 +		(1ull << IB_USER_VERBS_CMD_DEALLOC_PD)		|
 +		(1ull << IB_USER_VERBS_CMD_REG_MR)		|
 +		(1ull << IB_USER_VERBS_CMD_DEREG_MR)		|
 +		(1ull << IB_USER_VERBS_CMD_CREATE_COMP_CHANNEL)	|
 +		(1ull << IB_USER_VERBS_CMD_CREATE_CQ)		|
 +		(1ull << IB_USER_VERBS_CMD_RESIZE_CQ)		|
 +		(1ull << IB_USER_VERBS_CMD_DESTROY_CQ)		|
 +		(1ull << IB_USER_VERBS_CMD_CREATE_QP)		|
 +		(1ull << IB_USER_VERBS_CMD_QUERY_QP)		|
 +		(1ull << IB_USER_VERBS_CMD_MODIFY_QP)		|
 +		(1ull << IB_USER_VERBS_CMD_DESTROY_QP)		|
 +		(1ull << IB_USER_VERBS_CMD_ATTACH_MCAST)	|
 +		(1ull << IB_USER_VERBS_CMD_DETACH_MCAST);
++=======
++>>>>>>> 44ce37bc8bf3 (RDMA: Move more uverbs_cmd_mask settings to the core)
  	dev->ib_dev.node_type            = RDMA_NODE_IB_CA;
  	dev->ib_dev.phys_port_cnt        = dev->limits.num_ports;
  	dev->ib_dev.num_comp_vectors     = 1;
diff --cc drivers/infiniband/hw/ocrdma/ocrdma_main.c
index c15cfc6cef81,b5c8b5a9a093..000000000000
--- a/drivers/infiniband/hw/ocrdma/ocrdma_main.c
+++ b/drivers/infiniband/hw/ocrdma/ocrdma_main.c
@@@ -205,23 -204,8 +205,27 @@@ static int ocrdma_register_device(struc
  	BUILD_BUG_ON(sizeof(OCRDMA_NODE_DESC) > IB_DEVICE_NODE_DESC_MAX);
  	memcpy(dev->ibdev.node_desc, OCRDMA_NODE_DESC,
  	       sizeof(OCRDMA_NODE_DESC));
++<<<<<<< HEAD
 +	dev->ibdev.uverbs_cmd_mask =
 +	    OCRDMA_UVERBS(GET_CONTEXT) |
 +	    OCRDMA_UVERBS(QUERY_DEVICE) |
 +	    OCRDMA_UVERBS(QUERY_PORT) |
 +	    OCRDMA_UVERBS(ALLOC_PD) |
 +	    OCRDMA_UVERBS(DEALLOC_PD) |
 +	    OCRDMA_UVERBS(REG_MR) |
 +	    OCRDMA_UVERBS(DEREG_MR) |
 +	    OCRDMA_UVERBS(CREATE_COMP_CHANNEL) |
 +	    OCRDMA_UVERBS(CREATE_CQ) |
 +	    OCRDMA_UVERBS(RESIZE_CQ) |
 +	    OCRDMA_UVERBS(DESTROY_CQ) |
++=======
+ 	dev->ibdev.uverbs_cmd_mask |=
++>>>>>>> 44ce37bc8bf3 (RDMA: Move more uverbs_cmd_mask settings to the core)
  	    OCRDMA_UVERBS(REQ_NOTIFY_CQ) |
 +	    OCRDMA_UVERBS(CREATE_QP) |
 +	    OCRDMA_UVERBS(MODIFY_QP) |
 +	    OCRDMA_UVERBS(QUERY_QP) |
 +	    OCRDMA_UVERBS(DESTROY_QP) |
  	    OCRDMA_UVERBS(POLL_CQ) |
  	    OCRDMA_UVERBS(POST_SEND) |
  	    OCRDMA_UVERBS(POST_RECV);
diff --cc drivers/infiniband/hw/qedr/main.c
index bf098224e118,a092e73eb39b..000000000000
--- a/drivers/infiniband/hw/qedr/main.c
+++ b/drivers/infiniband/hw/qedr/main.c
@@@ -249,27 -248,9 +248,32 @@@ static int qedr_register_device(struct 
  	dev->ibdev.node_guid = dev->attr.node_guid;
  	memcpy(dev->ibdev.node_desc, QEDR_NODE_DESC, sizeof(QEDR_NODE_DESC));
  
++<<<<<<< HEAD
 +	dev->ibdev.uverbs_cmd_mask = QEDR_UVERBS(GET_CONTEXT) |
 +				     QEDR_UVERBS(QUERY_DEVICE) |
 +				     QEDR_UVERBS(QUERY_PORT) |
 +				     QEDR_UVERBS(ALLOC_PD) |
 +				     QEDR_UVERBS(DEALLOC_PD) |
 +				     QEDR_UVERBS(CREATE_COMP_CHANNEL) |
 +				     QEDR_UVERBS(CREATE_CQ) |
 +				     QEDR_UVERBS(RESIZE_CQ) |
 +				     QEDR_UVERBS(DESTROY_CQ) |
 +				     QEDR_UVERBS(REQ_NOTIFY_CQ) |
 +				     QEDR_UVERBS(CREATE_QP) |
 +				     QEDR_UVERBS(MODIFY_QP) |
 +				     QEDR_UVERBS(QUERY_QP) |
 +				     QEDR_UVERBS(DESTROY_QP) |
 +				     QEDR_UVERBS(CREATE_SRQ) |
 +				     QEDR_UVERBS(DESTROY_SRQ) |
 +				     QEDR_UVERBS(QUERY_SRQ) |
 +				     QEDR_UVERBS(MODIFY_SRQ) |
++=======
+ 	dev->ibdev.uverbs_cmd_mask |=
+ 				     QEDR_UVERBS(REQ_NOTIFY_CQ) |
++>>>>>>> 44ce37bc8bf3 (RDMA: Move more uverbs_cmd_mask settings to the core)
  				     QEDR_UVERBS(POST_SRQ_RECV) |
 +				     QEDR_UVERBS(REG_MR) |
 +				     QEDR_UVERBS(DEREG_MR) |
  				     QEDR_UVERBS(POLL_CQ) |
  				     QEDR_UVERBS(POST_SEND) |
  				     QEDR_UVERBS(POST_RECV);
diff --cc drivers/infiniband/hw/usnic/usnic_ib_main.c
index 73966edf92b7,1b63a491fa72..000000000000
--- a/drivers/infiniband/hw/usnic/usnic_ib_main.c
+++ b/drivers/infiniband/hw/usnic/usnic_ib_main.c
@@@ -388,25 -398,6 +388,28 @@@ static void *usnic_ib_device_add(struc
  	us_ibdev->ib_dev.num_comp_vectors = USNIC_IB_NUM_COMP_VECTORS;
  	us_ibdev->ib_dev.dev.parent = &dev->dev;
  
++<<<<<<< HEAD
 +	us_ibdev->ib_dev.uverbs_cmd_mask =
 +		(1ull << IB_USER_VERBS_CMD_GET_CONTEXT) |
 +		(1ull << IB_USER_VERBS_CMD_QUERY_DEVICE) |
 +		(1ull << IB_USER_VERBS_CMD_QUERY_PORT) |
 +		(1ull << IB_USER_VERBS_CMD_ALLOC_PD) |
 +		(1ull << IB_USER_VERBS_CMD_DEALLOC_PD) |
 +		(1ull << IB_USER_VERBS_CMD_REG_MR) |
 +		(1ull << IB_USER_VERBS_CMD_DEREG_MR) |
 +		(1ull << IB_USER_VERBS_CMD_CREATE_COMP_CHANNEL) |
 +		(1ull << IB_USER_VERBS_CMD_CREATE_CQ) |
 +		(1ull << IB_USER_VERBS_CMD_DESTROY_CQ) |
 +		(1ull << IB_USER_VERBS_CMD_CREATE_QP) |
 +		(1ull << IB_USER_VERBS_CMD_MODIFY_QP) |
 +		(1ull << IB_USER_VERBS_CMD_QUERY_QP) |
 +		(1ull << IB_USER_VERBS_CMD_DESTROY_QP) |
 +		(1ull << IB_USER_VERBS_CMD_ATTACH_MCAST) |
 +		(1ull << IB_USER_VERBS_CMD_DETACH_MCAST) |
 +		(1ull << IB_USER_VERBS_CMD_OPEN_QP);
 +
++=======
++>>>>>>> 44ce37bc8bf3 (RDMA: Move more uverbs_cmd_mask settings to the core)
  	ib_set_device_ops(&us_ibdev->ib_dev, &usnic_dev_ops);
  
  	rdma_set_device_sysfs_group(&us_ibdev->ib_dev, &usnic_attr_group);
diff --cc drivers/infiniband/sw/rdmavt/vt.c
index 2d534c450f3c,77afd06166fc..000000000000
--- a/drivers/infiniband/sw/rdmavt/vt.c
+++ b/drivers/infiniband/sw/rdmavt/vt.c
@@@ -601,26 -598,10 +601,23 @@@ int rvt_register_device(struct rvt_dev_
  		(1ull << IB_USER_VERBS_CMD_MODIFY_AH)           |
  		(1ull << IB_USER_VERBS_CMD_QUERY_AH)            |
  		(1ull << IB_USER_VERBS_CMD_DESTROY_AH)          |
++<<<<<<< HEAD
 +		(1ull << IB_USER_VERBS_CMD_REG_MR)              |
 +		(1ull << IB_USER_VERBS_CMD_DEREG_MR)            |
 +		(1ull << IB_USER_VERBS_CMD_CREATE_COMP_CHANNEL) |
 +		(1ull << IB_USER_VERBS_CMD_CREATE_CQ)           |
 +		(1ull << IB_USER_VERBS_CMD_RESIZE_CQ)           |
 +		(1ull << IB_USER_VERBS_CMD_DESTROY_CQ)          |
++=======
++>>>>>>> 44ce37bc8bf3 (RDMA: Move more uverbs_cmd_mask settings to the core)
  		(1ull << IB_USER_VERBS_CMD_POLL_CQ)             |
  		(1ull << IB_USER_VERBS_CMD_REQ_NOTIFY_CQ)       |
 +		(1ull << IB_USER_VERBS_CMD_CREATE_QP)           |
 +		(1ull << IB_USER_VERBS_CMD_QUERY_QP)            |
 +		(1ull << IB_USER_VERBS_CMD_MODIFY_QP)           |
 +		(1ull << IB_USER_VERBS_CMD_DESTROY_QP)          |
  		(1ull << IB_USER_VERBS_CMD_POST_SEND)           |
  		(1ull << IB_USER_VERBS_CMD_POST_RECV)           |
- 		(1ull << IB_USER_VERBS_CMD_ATTACH_MCAST)        |
- 		(1ull << IB_USER_VERBS_CMD_DETACH_MCAST)        |
- 		(1ull << IB_USER_VERBS_CMD_CREATE_SRQ)          |
- 		(1ull << IB_USER_VERBS_CMD_MODIFY_SRQ)          |
- 		(1ull << IB_USER_VERBS_CMD_QUERY_SRQ)           |
- 		(1ull << IB_USER_VERBS_CMD_DESTROY_SRQ)         |
  		(1ull << IB_USER_VERBS_CMD_POST_SRQ_RECV);
  	rdi->ibdev.node_type = RDMA_NODE_IB_CA;
  	if (!rdi->ibdev.num_comp_vectors)
diff --cc drivers/infiniband/sw/rxe/rxe_verbs.c
index 6f655b55dded,02b7f92ac878..000000000000
--- a/drivers/infiniband/sw/rxe/rxe_verbs.c
+++ b/drivers/infiniband/sw/rxe/rxe_verbs.c
@@@ -1126,33 -1128,14 +1126,40 @@@ int rxe_register_device(struct rxe_dev 
  	dev->local_dma_lkey = 0;
  	addrconf_addr_eui48((unsigned char *)&dev->node_guid,
  			    rxe->ndev->dev_addr);
 +	dev->dev.dma_ops = &dma_virt_ops;
  	dev->dev.dma_parms = &rxe->dma_parms;
 -	dma_set_max_seg_size(&dev->dev, UINT_MAX);
 -	dma_set_coherent_mask(&dev->dev, dma_get_required_mask(&dev->dev));
 -
 +	rxe->dma_parms = (struct device_dma_parameters)
 +		{ .max_segment_size = SZ_2G };
 +	dma_coerce_mask_and_coherent(&dev->dev,
 +				     dma_get_required_mask(&dev->dev));
 +
++<<<<<<< HEAD
 +	dev->uverbs_cmd_mask = BIT_ULL(IB_USER_VERBS_CMD_GET_CONTEXT)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_CREATE_COMP_CHANNEL)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_QUERY_DEVICE)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_QUERY_PORT)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_ALLOC_PD)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_DEALLOC_PD)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_CREATE_SRQ)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_MODIFY_SRQ)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_QUERY_SRQ)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_DESTROY_SRQ)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_POST_SRQ_RECV)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_CREATE_QP)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_MODIFY_QP)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_QUERY_QP)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_DESTROY_QP)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_POST_SEND)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_POST_RECV)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_CREATE_CQ)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_RESIZE_CQ)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_DESTROY_CQ)
++=======
+ 	dev->uverbs_cmd_mask |=
+ 	    BIT_ULL(IB_USER_VERBS_CMD_POST_SRQ_RECV)
+ 	    | BIT_ULL(IB_USER_VERBS_CMD_POST_SEND)
+ 	    | BIT_ULL(IB_USER_VERBS_CMD_POST_RECV)
++>>>>>>> 44ce37bc8bf3 (RDMA: Move more uverbs_cmd_mask settings to the core)
  	    | BIT_ULL(IB_USER_VERBS_CMD_POLL_CQ)
  	    | BIT_ULL(IB_USER_VERBS_CMD_PEEK_CQ)
  	    | BIT_ULL(IB_USER_VERBS_CMD_REQ_NOTIFY_CQ)
* Unmerged path drivers/infiniband/core/device.c
diff --git a/drivers/infiniband/core/uverbs_cmd.c b/drivers/infiniband/core/uverbs_cmd.c
index 5076cac0253f..8bdb49f8616f 100644
--- a/drivers/infiniband/core/uverbs_cmd.c
+++ b/drivers/infiniband/core/uverbs_cmd.c
@@ -3993,8 +3993,7 @@ const struct uapi_definition uverbs_def_write_intf[] = {
 		DECLARE_UVERBS_WRITE(
 			IB_USER_VERBS_CMD_CLOSE_XRCD,
 			ib_uverbs_close_xrcd,
-			UAPI_DEF_WRITE_I(struct ib_uverbs_close_xrcd),
-			UAPI_DEF_METHOD_NEEDS_FN(dealloc_xrcd)),
+			UAPI_DEF_WRITE_I(struct ib_uverbs_close_xrcd)),
 		DECLARE_UVERBS_WRITE(IB_USER_VERBS_CMD_OPEN_QP,
 				     ib_uverbs_open_qp,
 				     UAPI_DEF_WRITE_UDATA_IO(
@@ -4004,8 +4003,9 @@ const struct uapi_definition uverbs_def_write_intf[] = {
 				     ib_uverbs_open_xrcd,
 				     UAPI_DEF_WRITE_UDATA_IO(
 					     struct ib_uverbs_open_xrcd,
-					     struct ib_uverbs_open_xrcd_resp),
-				     UAPI_DEF_METHOD_NEEDS_FN(alloc_xrcd))),
+					     struct ib_uverbs_open_xrcd_resp)),
+		UAPI_DEF_OBJ_NEEDS_FN(alloc_xrcd),
+		UAPI_DEF_OBJ_NEEDS_FN(dealloc_xrcd)),
 
 	{},
 };
* Unmerged path drivers/infiniband/hw/bnxt_re/main.c
diff --git a/drivers/infiniband/hw/cxgb4/provider.c b/drivers/infiniband/hw/cxgb4/provider.c
index 14acc29b648f..ac633e17cd20 100644
--- a/drivers/infiniband/hw/cxgb4/provider.c
+++ b/drivers/infiniband/hw/cxgb4/provider.c
@@ -549,10 +549,7 @@ void c4iw_register_device(struct work_struct *work)
 	    (1ull << IB_USER_VERBS_CMD_POLL_CQ) |
 	    (1ull << IB_USER_VERBS_CMD_DESTROY_QP) |
 	    (1ull << IB_USER_VERBS_CMD_POST_SEND) |
-	    (1ull << IB_USER_VERBS_CMD_POST_RECV) |
-	    (1ull << IB_USER_VERBS_CMD_CREATE_SRQ) |
-	    (1ull << IB_USER_VERBS_CMD_MODIFY_SRQ) |
-	    (1ull << IB_USER_VERBS_CMD_DESTROY_SRQ);
+	    (1ull << IB_USER_VERBS_CMD_POST_RECV);
 	dev->ibdev.node_type = RDMA_NODE_RNIC;
 	BUILD_BUG_ON(sizeof(C4IW_NODE_DESC) > IB_DEVICE_NODE_DESC_MAX);
 	memcpy(dev->ibdev.node_desc, C4IW_NODE_DESC, sizeof(C4IW_NODE_DESC));
* Unmerged path drivers/infiniband/hw/hns/hns_roce_main.c
* Unmerged path drivers/infiniband/hw/mlx4/main.c
* Unmerged path drivers/infiniband/hw/mlx5/main.c
* Unmerged path drivers/infiniband/hw/mthca/mthca_provider.c
* Unmerged path drivers/infiniband/hw/ocrdma/ocrdma_main.c
* Unmerged path drivers/infiniband/hw/qedr/main.c
* Unmerged path drivers/infiniband/hw/usnic/usnic_ib_main.c
diff --git a/drivers/infiniband/hw/vmw_pvrdma/pvrdma_main.c b/drivers/infiniband/hw/vmw_pvrdma/pvrdma_main.c
index 10e67283b9db..dc0a33f3b07f 100644
--- a/drivers/infiniband/hw/vmw_pvrdma/pvrdma_main.c
+++ b/drivers/infiniband/hw/vmw_pvrdma/pvrdma_main.c
@@ -250,10 +250,6 @@ static int pvrdma_register_device(struct pvrdma_dev *dev)
 	/* Check if SRQ is supported by backend */
 	if (dev->dsr->caps.max_srq) {
 		dev->ib_dev.uverbs_cmd_mask |=
-			(1ull << IB_USER_VERBS_CMD_CREATE_SRQ)	|
-			(1ull << IB_USER_VERBS_CMD_MODIFY_SRQ)	|
-			(1ull << IB_USER_VERBS_CMD_QUERY_SRQ)	|
-			(1ull << IB_USER_VERBS_CMD_DESTROY_SRQ)	|
 			(1ull << IB_USER_VERBS_CMD_POST_SRQ_RECV);
 
 		ib_set_device_ops(&dev->ib_dev, &pvrdma_dev_srq_ops);
* Unmerged path drivers/infiniband/sw/rdmavt/vt.c
* Unmerged path drivers/infiniband/sw/rxe/rxe_verbs.c
diff --git a/drivers/infiniband/sw/siw/siw_main.c b/drivers/infiniband/sw/siw/siw_main.c
index 3b707def889f..d8d6e5a178cb 100644
--- a/drivers/infiniband/sw/siw/siw_main.c
+++ b/drivers/infiniband/sw/siw/siw_main.c
@@ -365,11 +365,7 @@ static struct siw_device *siw_device_create(struct net_device *netdev)
 		(1ull << IB_USER_VERBS_CMD_DESTROY_QP) |
 		(1ull << IB_USER_VERBS_CMD_POST_SEND) |
 		(1ull << IB_USER_VERBS_CMD_POST_RECV) |
-		(1ull << IB_USER_VERBS_CMD_CREATE_SRQ) |
-		(1ull << IB_USER_VERBS_CMD_POST_SRQ_RECV) |
-		(1ull << IB_USER_VERBS_CMD_MODIFY_SRQ) |
-		(1ull << IB_USER_VERBS_CMD_QUERY_SRQ) |
-		(1ull << IB_USER_VERBS_CMD_DESTROY_SRQ);
+		(1ull << IB_USER_VERBS_CMD_POST_SRQ_RECV);
 
 	base_dev->node_type = RDMA_NODE_RNIC;
 	memcpy(base_dev->node_desc, SIW_NODE_DESC_COMMON,
