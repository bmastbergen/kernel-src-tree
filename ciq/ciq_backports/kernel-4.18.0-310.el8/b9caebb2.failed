RDMA/usnic: Remove the query_pkey callback

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-310.el8
commit-author Kamal Heib <kamalheib1@gmail.com>
commit b9caebb290d298a114ed6426e644db9a09560055
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-310.el8/b9caebb2.failed

Now that the query_pkey() isn't mandatory by the RDMA core, this callback
can be removed from the usnic provider. The libfabric userspace never
touches the pkey.

Link: https://lore.kernel.org/r/20200820125346.111902-1-kamalheib1@gmail.com
	Signed-off-by: Kamal Heib <kamalheib1@gmail.com>
	Signed-off-by: Jason Gunthorpe <jgg@nvidia.com>
(cherry picked from commit b9caebb290d298a114ed6426e644db9a09560055)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/hw/usnic/usnic_ib_verbs.c
#	drivers/infiniband/hw/usnic/usnic_ib_verbs.h
diff --cc drivers/infiniband/hw/usnic/usnic_ib_verbs.c
index b8dca2ea9769,02a49f661c8d..000000000000
--- a/drivers/infiniband/hw/usnic/usnic_ib_verbs.c
+++ b/drivers/infiniband/hw/usnic/usnic_ib_verbs.c
@@@ -437,26 -436,6 +436,29 @@@ int usnic_ib_query_gid(struct ib_devic
  	return 0;
  }
  
++<<<<<<< HEAD
 +struct net_device *usnic_get_netdev(struct ib_device *device, u8 port_num)
 +{
 +	struct usnic_ib_dev *us_ibdev = to_usdev(device);
 +
 +	if (us_ibdev->netdev)
 +		dev_hold(us_ibdev->netdev);
 +
 +	return us_ibdev->netdev;
 +}
 +
 +int usnic_ib_query_pkey(struct ib_device *ibdev, u8 port, u16 index,
 +				u16 *pkey)
 +{
 +	if (index > 0)
 +		return -EINVAL;
 +
 +	*pkey = 0xffff;
 +	return 0;
 +}
 +
++=======
++>>>>>>> b9caebb290d2 (RDMA/usnic: Remove the query_pkey callback)
  int usnic_ib_alloc_pd(struct ib_pd *ibpd, struct ib_udata *udata)
  {
  	struct usnic_ib_pd *pd = to_upd(ibpd);
diff --cc drivers/infiniband/hw/usnic/usnic_ib_verbs.h
index cdbb94937a41,9195f2b901ce..000000000000
--- a/drivers/infiniband/hw/usnic/usnic_ib_verbs.h
+++ b/drivers/infiniband/hw/usnic/usnic_ib_verbs.h
@@@ -48,11 -48,8 +48,14 @@@ int usnic_ib_query_qp(struct ib_qp *qp
  				struct ib_qp_init_attr *qp_init_attr);
  int usnic_ib_query_gid(struct ib_device *ibdev, u8 port, int index,
  				union ib_gid *gid);
++<<<<<<< HEAD
 +struct net_device *usnic_get_netdev(struct ib_device *device, u8 port_num);
 +int usnic_ib_query_pkey(struct ib_device *ibdev, u8 port, u16 index,
 +				u16 *pkey);
++=======
++>>>>>>> b9caebb290d2 (RDMA/usnic: Remove the query_pkey callback)
  int usnic_ib_alloc_pd(struct ib_pd *ibpd, struct ib_udata *udata);
 -void usnic_ib_dealloc_pd(struct ib_pd *pd, struct ib_udata *udata);
 +int usnic_ib_dealloc_pd(struct ib_pd *pd, struct ib_udata *udata);
  struct ib_qp *usnic_ib_create_qp(struct ib_pd *pd,
  					struct ib_qp_init_attr *init_attr,
  					struct ib_udata *udata);
diff --git a/drivers/infiniband/hw/usnic/usnic_ib_main.c b/drivers/infiniband/hw/usnic/usnic_ib_main.c
index 73966edf92b7..1bcd4ea7ab7c 100644
--- a/drivers/infiniband/hw/usnic/usnic_ib_main.c
+++ b/drivers/infiniband/hw/usnic/usnic_ib_main.c
@@ -302,7 +302,6 @@ static int usnic_port_immutable(struct ib_device *ibdev, u8 port_num,
 	if (err)
 		return err;
 
-	immutable->pkey_tbl_len = attr.pkey_tbl_len;
 	immutable->gid_tbl_len = attr.gid_tbl_len;
 
 	return 0;
@@ -343,7 +342,6 @@ static const struct ib_device_ops usnic_dev_ops = {
 	.modify_qp = usnic_ib_modify_qp,
 	.query_device = usnic_ib_query_device,
 	.query_gid = usnic_ib_query_gid,
-	.query_pkey = usnic_ib_query_pkey,
 	.query_port = usnic_ib_query_port,
 	.query_qp = usnic_ib_query_qp,
 	.reg_user_mr = usnic_ib_reg_mr,
* Unmerged path drivers/infiniband/hw/usnic/usnic_ib_verbs.c
* Unmerged path drivers/infiniband/hw/usnic/usnic_ib_verbs.h
