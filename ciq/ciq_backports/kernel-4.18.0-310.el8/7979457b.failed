net: bridge: vlan: Add a schedule point during VLAN processing

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-310.el8
commit-author Ido Schimmel <idosch@mellanox.com>
commit 7979457b1d3a069cd857f5bd69e070e30223dd0c
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-310.el8/7979457b.failed

User space can request to delete a range of VLANs from a bridge slave in
one netlink request. For each deleted VLAN the FDB needs to be traversed
in order to flush all the affected entries.

If a large range of VLANs is deleted and the number of FDB entries is
large or the FDB lock is contented, it is possible for the kernel to
loop through the deleted VLANs for a long time. In case preemption is
disabled, this can result in a soft lockup.

Fix this by adding a schedule point after each VLAN is deleted to yield
the CPU, if needed. This is safe because the VLANs are traversed in
process context.

Fixes: bdced7ef7838 ("bridge: support for multiple vlans and vlan ranges in setlink and dellink requests")
	Signed-off-by: Ido Schimmel <idosch@mellanox.com>
	Reported-by: Stefan Priebe - Profihost AG <s.priebe@profihost.ag>
	Tested-by: Stefan Priebe - Profihost AG <s.priebe@profihost.ag>
	Acked-by: Nikolay Aleksandrov <nikolay@cumulusnetworks.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 7979457b1d3a069cd857f5bd69e070e30223dd0c)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/bridge/br_netlink.c
diff --cc net/bridge/br_netlink.c
index 39fb100d1f98,a0f5dbee8f9c..000000000000
--- a/net/bridge/br_netlink.c
+++ b/net/bridge/br_netlink.c
@@@ -594,7 -600,25 +594,23 @@@ static int br_process_vlan_info(struct 
  					   extack);
  			if (err)
  				break;
++<<<<<<< HEAD
++=======
+ 			if (curr_change) {
+ 				*changed = curr_change;
+ 				if (!v_change_start)
+ 					v_change_start = v;
+ 			} else {
+ 				/* nothing to notify yet */
+ 				if (!v_change_start)
+ 					continue;
+ 				br_vlan_notify(br, p, v_change_start,
+ 					       v - 1, rtm_cmd);
+ 				v_change_start = 0;
+ 			}
+ 			cond_resched();
++>>>>>>> 7979457b1d3a (net: bridge: vlan: Add a schedule point during VLAN processing)
  		}
 -		/* v_change_start is set only if the last/whole range changed */
 -		if (v_change_start)
 -			br_vlan_notify(br, p, v_change_start,
 -				       v - 1, rtm_cmd);
 -
  		*vinfo_last = NULL;
  
  		return err;
* Unmerged path net/bridge/br_netlink.c
