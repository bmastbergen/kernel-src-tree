devlink: introduce flash update overwrite mask

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-310.el8
commit-author Jacob Keller <jacob.e.keller@intel.com>
commit 5d5b4128c4caae34ddcd9b2dc30ac4d6155617a3
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-310.el8/5d5b4128.failed

Sections of device flash may contain settings or device identifying
information. When performing a flash update, it is generally expected
that these settings and identifiers are not overwritten.

However, it may sometimes be useful to allow overwriting these fields
when performing a flash update. Some examples include, 1) customizing
the initial device config on first programming, such as overwriting
default device identifying information, or 2) reverting a device
configuration to known good state provided in the new firmware image, or
3) in case it is suspected that current firmware logic for managing the
preservation of fields during an update is broken.

Although some devices are able to completely separate these types of
settings and fields into separate components, this is not true for all
hardware.

To support controlling this behavior, a new
DEVLINK_ATTR_FLASH_UPDATE_OVERWRITE_MASK is defined. This is an
nla_bitfield32 which will define what subset of fields in a component
should be overwritten during an update.

If no bits are specified, or of the overwrite mask is not provided, then
an update should not overwrite anything, and should maintain the
settings and identifiers as they are in the previous image.

If the overwrite mask has the DEVLINK_FLASH_OVERWRITE_SETTINGS bit set,
then the device should be configured to overwrite any of the settings in
the requested component with settings found in the provided image.

Similarly, if the DEVLINK_FLASH_OVERWRITE_IDENTIFIERS bit is set, the
device should be configured to overwrite any device identifiers in the
requested component with the identifiers from the image.

Multiple overwrite modes may be combined to indicate that a combination
of the set of fields that should be overwritten.

Drivers which support the new overwrite mask must set the
DEVLINK_SUPPORT_FLASH_UPDATE_OVERWRITE_MASK in the
supported_flash_update_params field of their devlink_ops.

	Signed-off-by: Jacob Keller <jacob.e.keller@intel.com>
	Reviewed-by: Jakub Kicinski <kuba@kernel.org>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 5d5b4128c4caae34ddcd9b2dc30ac4d6155617a3)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	include/net/devlink.h
#	net/core/devlink.c
diff --cc include/net/devlink.h
index 5414aff70555,7339bf9ba6b4..000000000000
--- a/include/net/devlink.h
+++ b/include/net/devlink.h
@@@ -546,6 -550,24 +546,27 @@@ enum devlink_param_generic_id 
  /* Firmware bundle identifier */
  #define DEVLINK_INFO_VERSION_GENERIC_FW_BUNDLE_ID	"fw.bundle_id"
  
++<<<<<<< HEAD
++=======
+ /**
+  * struct devlink_flash_update_params - Flash Update parameters
+  * @file_name: the name of the flash firmware file to update from
+  * @component: the flash component to update
+  *
+  * With the exception of file_name, drivers must opt-in to parameters by
+  * setting the appropriate bit in the supported_flash_update_params field in
+  * their devlink_ops structure.
+  */
+ struct devlink_flash_update_params {
+ 	const char *file_name;
+ 	const char *component;
+ 	u32 overwrite_mask;
+ };
+ 
+ #define DEVLINK_SUPPORT_FLASH_UPDATE_COMPONENT		BIT(0)
+ #define DEVLINK_SUPPORT_FLASH_UPDATE_OVERWRITE_MASK	BIT(1)
+ 
++>>>>>>> 5d5b4128c4ca (devlink: introduce flash update overwrite mask)
  struct devlink_region;
  struct devlink_info_req;
  
diff --cc net/core/devlink.c
index 26026761598e,7a38f9e25922..000000000000
--- a/net/core/devlink.c
+++ b/net/core/devlink.c
@@@ -3153,22 -3147,45 +3153,46 @@@ EXPORT_SYMBOL_GPL(devlink_flash_update_
  static int devlink_nl_cmd_flash_update(struct sk_buff *skb,
  				       struct genl_info *info)
  {
++<<<<<<< HEAD
 +	struct devlink *devlink = info->user_ptr[0];
 +	const char *file_name, *component;
 +	struct nlattr *nla_component;
++=======
+ 	struct nlattr *nla_component, *nla_overwrite_mask;
+ 	struct devlink_flash_update_params params = {};
+ 	struct devlink *devlink = info->user_ptr[0];
+ 	u32 supported_params;
++>>>>>>> 5d5b4128c4ca (devlink: introduce flash update overwrite mask)
  
  	if (!devlink->ops->flash_update)
  		return -EOPNOTSUPP;
  
  	if (!info->attrs[DEVLINK_ATTR_FLASH_UPDATE_FILE_NAME])
  		return -EINVAL;
 -
 -	supported_params = devlink->ops->supported_flash_update_params;
 -
 -	params.file_name = nla_data(info->attrs[DEVLINK_ATTR_FLASH_UPDATE_FILE_NAME]);
 +	file_name = nla_data(info->attrs[DEVLINK_ATTR_FLASH_UPDATE_FILE_NAME]);
  
  	nla_component = info->attrs[DEVLINK_ATTR_FLASH_UPDATE_COMPONENT];
 -	if (nla_component) {
 -		if (!(supported_params & DEVLINK_SUPPORT_FLASH_UPDATE_COMPONENT)) {
 -			NL_SET_ERR_MSG_ATTR(info->extack, nla_component,
 -					    "component update is not supported by this device");
 -			return -EOPNOTSUPP;
 -		}
 -		params.component = nla_data(nla_component);
 -	}
 +	component = nla_component ? nla_data(nla_component) : NULL;
  
++<<<<<<< HEAD
 +	return devlink->ops->flash_update(devlink, file_name, component,
 +					  info->extack);
++=======
+ 	nla_overwrite_mask = info->attrs[DEVLINK_ATTR_FLASH_UPDATE_OVERWRITE_MASK];
+ 	if (nla_overwrite_mask) {
+ 		struct nla_bitfield32 sections;
+ 
+ 		if (!(supported_params & DEVLINK_SUPPORT_FLASH_UPDATE_OVERWRITE_MASK)) {
+ 			NL_SET_ERR_MSG_ATTR(info->extack, nla_overwrite_mask,
+ 					    "overwrite settings are not supported by this device");
+ 			return -EOPNOTSUPP;
+ 		}
+ 		sections = nla_get_bitfield32(nla_overwrite_mask);
+ 		params.overwrite_mask = sections.value & sections.selector;
+ 	}
+ 
+ 	return devlink->ops->flash_update(devlink, &params, info->extack);
++>>>>>>> 5d5b4128c4ca (devlink: introduce flash update overwrite mask)
  }
  
  static const struct devlink_param devlink_param_generic[] = {
diff --git a/Documentation/networking/devlink/devlink-flash.rst b/Documentation/networking/devlink/devlink-flash.rst
index 40a87c0222cb..603e732f00cc 100644
--- a/Documentation/networking/devlink/devlink-flash.rst
+++ b/Documentation/networking/devlink/devlink-flash.rst
@@ -16,6 +16,34 @@ Note that the file name is a path relative to the firmware loading path
 (usually ``/lib/firmware/``). Drivers may send status updates to inform
 user space about the progress of the update operation.
 
+Overwrite Mask
+==============
+
+The ``devlink-flash`` command allows optionally specifying a mask indicating
+how the device should handle subsections of flash components when updating.
+This mask indicates the set of sections which are allowed to be overwritten.
+
+.. list-table:: List of overwrite mask bits
+   :widths: 5 95
+
+   * - Name
+     - Description
+   * - ``DEVLINK_FLASH_OVERWRITE_SETTINGS``
+     - Indicates that the device should overwrite settings in the components
+       being updated with the settings found in the provided image.
+   * - ``DEVLINK_FLASH_OVERWRITE_IDENTIFIERS``
+     - Indicates that the device should overwrite identifiers in the
+       components being updated with the identifiers found in the provided
+       image. This includes MAC addresses, serial IDs, and similar device
+       identifiers.
+
+Multiple overwrite bits may be combined and requested together. If no bits
+are provided, it is expected that the device only update firmware binaries
+in the components being updated. Settings and identifiers are expected to be
+preserved across the update. A device may not support every combination and
+the driver for such a device must reject any combination which cannot be
+faithfully implemented.
+
 Firmware Loading
 ================
 
* Unmerged path include/net/devlink.h
diff --git a/include/uapi/linux/devlink.h b/include/uapi/linux/devlink.h
index a9e01b701959..dfdea6d89fef 100644
--- a/include/uapi/linux/devlink.h
+++ b/include/uapi/linux/devlink.h
@@ -230,6 +230,28 @@ enum {
 	DEVLINK_ATTR_STATS_MAX = __DEVLINK_ATTR_STATS_MAX - 1
 };
 
+/* Specify what sections of a flash component can be overwritten when
+ * performing an update. Overwriting of firmware binary sections is always
+ * implicitly assumed to be allowed.
+ *
+ * Each section must be documented in
+ * Documentation/networking/devlink/devlink-flash.rst
+ *
+ */
+enum {
+	DEVLINK_FLASH_OVERWRITE_SETTINGS_BIT,
+	DEVLINK_FLASH_OVERWRITE_IDENTIFIERS_BIT,
+
+	__DEVLINK_FLASH_OVERWRITE_MAX_BIT,
+	DEVLINK_FLASH_OVERWRITE_MAX_BIT = __DEVLINK_FLASH_OVERWRITE_MAX_BIT - 1
+};
+
+#define DEVLINK_FLASH_OVERWRITE_SETTINGS _BITUL(DEVLINK_FLASH_OVERWRITE_SETTINGS_BIT)
+#define DEVLINK_FLASH_OVERWRITE_IDENTIFIERS _BITUL(DEVLINK_FLASH_OVERWRITE_IDENTIFIERS_BIT)
+
+#define DEVLINK_SUPPORTED_FLASH_OVERWRITE_SECTIONS \
+	(_BITUL(__DEVLINK_FLASH_OVERWRITE_MAX_BIT) - 1)
+
 /**
  * enum devlink_trap_action - Packet trap action.
  * @DEVLINK_TRAP_ACTION_DROP: Packet is dropped by the device and a copy is not
@@ -465,6 +487,7 @@ enum devlink_attr {
 	__RH_RESERVED_DEVLINK_ATTR_PORT_CONTROLLER_NUMBER,	/* u32 */
 
 	DEVLINK_ATTR_FLASH_UPDATE_STATUS_TIMEOUT,	/* u64 */
+	DEVLINK_ATTR_FLASH_UPDATE_OVERWRITE_MASK,	/* bitfield32 */
 
 	/* add new attributes above here, update the policy in devlink.c */
 
* Unmerged path net/core/devlink.c
