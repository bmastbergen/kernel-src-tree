RDMA: Remove AH from uverbs_cmd_mask

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-310.el8
commit-author Jason Gunthorpe <jgg@nvidia.com>
commit 676a80adba0131e1603ef3de5f73a19a0d3d0e65
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-310.el8/676a80ad.failed

Drivers that need a uverbs AH should instead set the create_user_ah() op
similar to reg_user_mr(). MODIFY_AH and QUERY_AH cmds were never
implemented so are just deleted.

Link: https://lore.kernel.org/r/11-v1-caa70ba3d1ab+1436e-ucmd_mask_jgg@nvidia.com
	Signed-off-by: Jason Gunthorpe <jgg@nvidia.com>
(cherry picked from commit 676a80adba0131e1603ef3de5f73a19a0d3d0e65)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/core/device.c
#	drivers/infiniband/hw/bnxt_re/main.c
#	drivers/infiniband/hw/efa/efa_main.c
#	drivers/infiniband/hw/mlx5/main.c
#	drivers/infiniband/sw/rdmavt/vt.c
#	drivers/infiniband/sw/rxe/rxe_verbs.c
diff --cc drivers/infiniband/core/device.c
index 30a7bf1c3b41,ce26564d4edf..000000000000
--- a/drivers/infiniband/core/device.c
+++ b/drivers/infiniband/core/device.c
@@@ -601,10 -601,37 +601,44 @@@ struct ib_device *_ib_alloc_device(size
  	init_completion(&device->unreg_completion);
  	INIT_WORK(&device->unregistration_work, ib_unregister_work);
  
++<<<<<<< HEAD
 +	spin_lock_init(&device->cq_pools_lock);
 +	for (i = 0; i < ARRAY_SIZE(device->cq_pools); i++)
 +		INIT_LIST_HEAD(&device->cq_pools[i]);
 +
++=======
+ 	device->uverbs_cmd_mask =
+ 		BIT_ULL(IB_USER_VERBS_CMD_ALLOC_MW) |
+ 		BIT_ULL(IB_USER_VERBS_CMD_ALLOC_PD) |
+ 		BIT_ULL(IB_USER_VERBS_CMD_ATTACH_MCAST) |
+ 		BIT_ULL(IB_USER_VERBS_CMD_CLOSE_XRCD) |
+ 		BIT_ULL(IB_USER_VERBS_CMD_CREATE_AH) |
+ 		BIT_ULL(IB_USER_VERBS_CMD_CREATE_COMP_CHANNEL) |
+ 		BIT_ULL(IB_USER_VERBS_CMD_CREATE_CQ) |
+ 		BIT_ULL(IB_USER_VERBS_CMD_CREATE_QP) |
+ 		BIT_ULL(IB_USER_VERBS_CMD_CREATE_SRQ) |
+ 		BIT_ULL(IB_USER_VERBS_CMD_CREATE_XSRQ) |
+ 		BIT_ULL(IB_USER_VERBS_CMD_DEALLOC_MW) |
+ 		BIT_ULL(IB_USER_VERBS_CMD_DEALLOC_PD) |
+ 		BIT_ULL(IB_USER_VERBS_CMD_DEREG_MR) |
+ 		BIT_ULL(IB_USER_VERBS_CMD_DESTROY_AH) |
+ 		BIT_ULL(IB_USER_VERBS_CMD_DESTROY_CQ) |
+ 		BIT_ULL(IB_USER_VERBS_CMD_DESTROY_QP) |
+ 		BIT_ULL(IB_USER_VERBS_CMD_DESTROY_SRQ) |
+ 		BIT_ULL(IB_USER_VERBS_CMD_DETACH_MCAST) |
+ 		BIT_ULL(IB_USER_VERBS_CMD_GET_CONTEXT) |
+ 		BIT_ULL(IB_USER_VERBS_CMD_MODIFY_QP) |
+ 		BIT_ULL(IB_USER_VERBS_CMD_MODIFY_SRQ) |
+ 		BIT_ULL(IB_USER_VERBS_CMD_OPEN_QP) |
+ 		BIT_ULL(IB_USER_VERBS_CMD_OPEN_XRCD) |
+ 		BIT_ULL(IB_USER_VERBS_CMD_QUERY_DEVICE) |
+ 		BIT_ULL(IB_USER_VERBS_CMD_QUERY_PORT) |
+ 		BIT_ULL(IB_USER_VERBS_CMD_QUERY_QP) |
+ 		BIT_ULL(IB_USER_VERBS_CMD_QUERY_SRQ) |
+ 		BIT_ULL(IB_USER_VERBS_CMD_REG_MR) |
+ 		BIT_ULL(IB_USER_VERBS_CMD_REREG_MR) |
+ 		BIT_ULL(IB_USER_VERBS_CMD_RESIZE_CQ);
++>>>>>>> 676a80adba01 (RDMA: Remove AH from uverbs_cmd_mask)
  	return device;
  }
  EXPORT_SYMBOL(_ib_alloc_device);
diff --cc drivers/infiniband/hw/bnxt_re/main.c
index 53aee5a42ab8,838744b6811b..000000000000
--- a/drivers/infiniband/hw/bnxt_re/main.c
+++ b/drivers/infiniband/hw/bnxt_re/main.c
@@@ -701,35 -702,6 +702,38 @@@ static int bnxt_re_register_ib(struct b
  	ibdev->dev.parent = &rdev->en_dev->pdev->dev;
  	ibdev->local_dma_lkey = BNXT_QPLIB_RSVD_LKEY;
  
++<<<<<<< HEAD
 +	/* User space */
 +	ibdev->uverbs_cmd_mask =
 +			(1ull << IB_USER_VERBS_CMD_GET_CONTEXT)		|
 +			(1ull << IB_USER_VERBS_CMD_QUERY_DEVICE)	|
 +			(1ull << IB_USER_VERBS_CMD_QUERY_PORT)		|
 +			(1ull << IB_USER_VERBS_CMD_ALLOC_PD)		|
 +			(1ull << IB_USER_VERBS_CMD_DEALLOC_PD)		|
 +			(1ull << IB_USER_VERBS_CMD_REG_MR)		|
 +			(1ull << IB_USER_VERBS_CMD_REREG_MR)		|
 +			(1ull << IB_USER_VERBS_CMD_DEREG_MR)		|
 +			(1ull << IB_USER_VERBS_CMD_CREATE_COMP_CHANNEL) |
 +			(1ull << IB_USER_VERBS_CMD_CREATE_CQ)		|
 +			(1ull << IB_USER_VERBS_CMD_RESIZE_CQ)		|
 +			(1ull << IB_USER_VERBS_CMD_DESTROY_CQ)		|
 +			(1ull << IB_USER_VERBS_CMD_CREATE_QP)		|
 +			(1ull << IB_USER_VERBS_CMD_MODIFY_QP)		|
 +			(1ull << IB_USER_VERBS_CMD_QUERY_QP)		|
 +			(1ull << IB_USER_VERBS_CMD_DESTROY_QP)		|
 +			(1ull << IB_USER_VERBS_CMD_CREATE_SRQ)		|
 +			(1ull << IB_USER_VERBS_CMD_MODIFY_SRQ)		|
 +			(1ull << IB_USER_VERBS_CMD_QUERY_SRQ)		|
 +			(1ull << IB_USER_VERBS_CMD_DESTROY_SRQ)		|
 +			(1ull << IB_USER_VERBS_CMD_CREATE_AH)		|
 +			(1ull << IB_USER_VERBS_CMD_MODIFY_AH)		|
 +			(1ull << IB_USER_VERBS_CMD_QUERY_AH)		|
 +			(1ull << IB_USER_VERBS_CMD_DESTROY_AH);
 +	/* POLL_CQ and REQ_NOTIFY_CQ is directly handled in libbnxt_re */
 +
 +
++=======
++>>>>>>> 676a80adba01 (RDMA: Remove AH from uverbs_cmd_mask)
  	rdma_set_device_sysfs_group(ibdev, &bnxt_re_dev_attr_group);
  	ib_set_device_ops(ibdev, &bnxt_re_dev_ops);
  	ret = ib_device_set_netdev(&rdev->ibdev, rdev->netdev, 1);
diff --cc drivers/infiniband/hw/efa/efa_main.c
index 92d701146320,2b3da85fb43c..000000000000
--- a/drivers/infiniband/hw/efa/efa_main.c
+++ b/drivers/infiniband/hw/efa/efa_main.c
@@@ -308,30 -309,9 +309,33 @@@ static int efa_ib_device_add(struct efa
  	dev->ibdev.num_comp_vectors = 1;
  	dev->ibdev.dev.parent = &pdev->dev;
  
++<<<<<<< HEAD
 +	dev->ibdev.uverbs_cmd_mask =
 +		(1ull << IB_USER_VERBS_CMD_GET_CONTEXT) |
 +		(1ull << IB_USER_VERBS_CMD_QUERY_DEVICE) |
 +		(1ull << IB_USER_VERBS_CMD_QUERY_PORT) |
 +		(1ull << IB_USER_VERBS_CMD_ALLOC_PD) |
 +		(1ull << IB_USER_VERBS_CMD_DEALLOC_PD) |
 +		(1ull << IB_USER_VERBS_CMD_REG_MR) |
 +		(1ull << IB_USER_VERBS_CMD_DEREG_MR) |
 +		(1ull << IB_USER_VERBS_CMD_CREATE_COMP_CHANNEL) |
 +		(1ull << IB_USER_VERBS_CMD_CREATE_CQ) |
 +		(1ull << IB_USER_VERBS_CMD_DESTROY_CQ) |
 +		(1ull << IB_USER_VERBS_CMD_CREATE_QP) |
 +		(1ull << IB_USER_VERBS_CMD_MODIFY_QP) |
 +		(1ull << IB_USER_VERBS_CMD_QUERY_QP) |
 +		(1ull << IB_USER_VERBS_CMD_DESTROY_QP) |
 +		(1ull << IB_USER_VERBS_CMD_CREATE_AH) |
 +		(1ull << IB_USER_VERBS_CMD_DESTROY_AH);
 +
 +	dev->ibdev.uverbs_ex_cmd_mask =
 +		(1ull << IB_USER_VERBS_EX_CMD_QUERY_DEVICE);
 +
++=======
++>>>>>>> 676a80adba01 (RDMA: Remove AH from uverbs_cmd_mask)
  	ib_set_device_ops(&dev->ibdev, &efa_dev_ops);
  
 -	err = ib_register_device(&dev->ibdev, "efa_%d", &pdev->dev);
 +	err = ib_register_device(&dev->ibdev, "efa_%d");
  	if (err)
  		goto err_release_doorbell_bar;
  
diff --cc drivers/infiniband/hw/mlx5/main.c
index 97d5f414e693,e07ad30f0aca..000000000000
--- a/drivers/infiniband/hw/mlx5/main.c
+++ b/drivers/infiniband/hw/mlx5/main.c
@@@ -4150,42 -4140,6 +4151,45 @@@ static int mlx5_ib_stage_caps_init(stru
  	struct mlx5_core_dev *mdev = dev->mdev;
  	int err;
  
++<<<<<<< HEAD
 +	dev->ib_dev.uverbs_cmd_mask	=
 +		(1ull << IB_USER_VERBS_CMD_GET_CONTEXT)		|
 +		(1ull << IB_USER_VERBS_CMD_QUERY_DEVICE)	|
 +		(1ull << IB_USER_VERBS_CMD_QUERY_PORT)		|
 +		(1ull << IB_USER_VERBS_CMD_ALLOC_PD)		|
 +		(1ull << IB_USER_VERBS_CMD_DEALLOC_PD)		|
 +		(1ull << IB_USER_VERBS_CMD_CREATE_AH)		|
 +		(1ull << IB_USER_VERBS_CMD_DESTROY_AH)		|
 +		(1ull << IB_USER_VERBS_CMD_REG_MR)		|
 +		(1ull << IB_USER_VERBS_CMD_REREG_MR)		|
 +		(1ull << IB_USER_VERBS_CMD_DEREG_MR)		|
 +		(1ull << IB_USER_VERBS_CMD_CREATE_COMP_CHANNEL)	|
 +		(1ull << IB_USER_VERBS_CMD_CREATE_CQ)		|
 +		(1ull << IB_USER_VERBS_CMD_RESIZE_CQ)		|
 +		(1ull << IB_USER_VERBS_CMD_DESTROY_CQ)		|
 +		(1ull << IB_USER_VERBS_CMD_CREATE_QP)		|
 +		(1ull << IB_USER_VERBS_CMD_MODIFY_QP)		|
 +		(1ull << IB_USER_VERBS_CMD_QUERY_QP)		|
 +		(1ull << IB_USER_VERBS_CMD_DESTROY_QP)		|
 +		(1ull << IB_USER_VERBS_CMD_ATTACH_MCAST)	|
 +		(1ull << IB_USER_VERBS_CMD_DETACH_MCAST)	|
 +		(1ull << IB_USER_VERBS_CMD_CREATE_SRQ)		|
 +		(1ull << IB_USER_VERBS_CMD_MODIFY_SRQ)		|
 +		(1ull << IB_USER_VERBS_CMD_QUERY_SRQ)		|
 +		(1ull << IB_USER_VERBS_CMD_DESTROY_SRQ)		|
 +		(1ull << IB_USER_VERBS_CMD_CREATE_XSRQ)		|
 +		(1ull << IB_USER_VERBS_CMD_OPEN_QP);
 +	dev->ib_dev.uverbs_ex_cmd_mask =
 +		(1ull << IB_USER_VERBS_EX_CMD_QUERY_DEVICE)	|
 +		(1ull << IB_USER_VERBS_EX_CMD_CREATE_CQ)	|
 +		(1ull << IB_USER_VERBS_EX_CMD_CREATE_QP)	|
 +		(1ull << IB_USER_VERBS_EX_CMD_MODIFY_QP)	|
 +		(1ull << IB_USER_VERBS_EX_CMD_MODIFY_CQ)	|
 +		(1ull << IB_USER_VERBS_EX_CMD_CREATE_FLOW)	|
 +		(1ull << IB_USER_VERBS_EX_CMD_DESTROY_FLOW);
 +
++=======
++>>>>>>> 676a80adba01 (RDMA: Remove AH from uverbs_cmd_mask)
  	if (MLX5_CAP_GEN(mdev, ipoib_enhanced_offloads) &&
  	    IS_ENABLED(CONFIG_MLX5_CORE_IPOIB))
  		ib_set_device_ops(&dev->ib_dev,
diff --cc drivers/infiniband/sw/rdmavt/vt.c
index 2d534c450f3c,43fbc4e54edf..000000000000
--- a/drivers/infiniband/sw/rdmavt/vt.c
+++ b/drivers/infiniband/sw/rdmavt/vt.c
@@@ -591,36 -594,11 +592,40 @@@ int rvt_register_device(struct rvt_dev_
  	 * exactly which functions rdmavt supports, nor do they know the ABI
  	 * version, so we do all of this sort of stuff here.
  	 */
++<<<<<<< HEAD
 +	rdi->ibdev.uverbs_cmd_mask =
 +		(1ull << IB_USER_VERBS_CMD_GET_CONTEXT)         |
 +		(1ull << IB_USER_VERBS_CMD_QUERY_DEVICE)        |
 +		(1ull << IB_USER_VERBS_CMD_QUERY_PORT)          |
 +		(1ull << IB_USER_VERBS_CMD_ALLOC_PD)            |
 +		(1ull << IB_USER_VERBS_CMD_DEALLOC_PD)          |
 +		(1ull << IB_USER_VERBS_CMD_CREATE_AH)           |
 +		(1ull << IB_USER_VERBS_CMD_MODIFY_AH)           |
 +		(1ull << IB_USER_VERBS_CMD_QUERY_AH)            |
 +		(1ull << IB_USER_VERBS_CMD_DESTROY_AH)          |
 +		(1ull << IB_USER_VERBS_CMD_REG_MR)              |
 +		(1ull << IB_USER_VERBS_CMD_DEREG_MR)            |
 +		(1ull << IB_USER_VERBS_CMD_CREATE_COMP_CHANNEL) |
 +		(1ull << IB_USER_VERBS_CMD_CREATE_CQ)           |
 +		(1ull << IB_USER_VERBS_CMD_RESIZE_CQ)           |
 +		(1ull << IB_USER_VERBS_CMD_DESTROY_CQ)          |
++=======
+ 	rdi->ibdev.uverbs_cmd_mask |=
++>>>>>>> 676a80adba01 (RDMA: Remove AH from uverbs_cmd_mask)
  		(1ull << IB_USER_VERBS_CMD_POLL_CQ)             |
  		(1ull << IB_USER_VERBS_CMD_REQ_NOTIFY_CQ)       |
 +		(1ull << IB_USER_VERBS_CMD_CREATE_QP)           |
 +		(1ull << IB_USER_VERBS_CMD_QUERY_QP)            |
 +		(1ull << IB_USER_VERBS_CMD_MODIFY_QP)           |
 +		(1ull << IB_USER_VERBS_CMD_DESTROY_QP)          |
  		(1ull << IB_USER_VERBS_CMD_POST_SEND)           |
  		(1ull << IB_USER_VERBS_CMD_POST_RECV)           |
 +		(1ull << IB_USER_VERBS_CMD_ATTACH_MCAST)        |
 +		(1ull << IB_USER_VERBS_CMD_DETACH_MCAST)        |
 +		(1ull << IB_USER_VERBS_CMD_CREATE_SRQ)          |
 +		(1ull << IB_USER_VERBS_CMD_MODIFY_SRQ)          |
 +		(1ull << IB_USER_VERBS_CMD_QUERY_SRQ)           |
 +		(1ull << IB_USER_VERBS_CMD_DESTROY_SRQ)         |
  		(1ull << IB_USER_VERBS_CMD_POST_SRQ_RECV);
  	rdi->ibdev.node_type = RDMA_NODE_IB_CA;
  	if (!rdi->ibdev.num_comp_vectors)
diff --cc drivers/infiniband/sw/rxe/rxe_verbs.c
index 6f655b55dded,c282b9a92712..000000000000
--- a/drivers/infiniband/sw/rxe/rxe_verbs.c
+++ b/drivers/infiniband/sw/rxe/rxe_verbs.c
@@@ -1126,45 -1138,11 +1127,49 @@@ int rxe_register_device(struct rxe_dev 
  	dev->local_dma_lkey = 0;
  	addrconf_addr_eui48((unsigned char *)&dev->node_guid,
  			    rxe->ndev->dev_addr);
 +	dev->dev.dma_ops = &dma_virt_ops;
  	dev->dev.dma_parms = &rxe->dma_parms;
 -	dma_set_max_seg_size(&dev->dev, UINT_MAX);
 -	dma_set_coherent_mask(&dev->dev, dma_get_required_mask(&dev->dev));
 -
 +	rxe->dma_parms = (struct device_dma_parameters)
 +		{ .max_segment_size = SZ_2G };
 +	dma_coerce_mask_and_coherent(&dev->dev,
 +				     dma_get_required_mask(&dev->dev));
 +
++<<<<<<< HEAD
 +	dev->uverbs_cmd_mask = BIT_ULL(IB_USER_VERBS_CMD_GET_CONTEXT)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_CREATE_COMP_CHANNEL)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_QUERY_DEVICE)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_QUERY_PORT)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_ALLOC_PD)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_DEALLOC_PD)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_CREATE_SRQ)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_MODIFY_SRQ)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_QUERY_SRQ)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_DESTROY_SRQ)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_POST_SRQ_RECV)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_CREATE_QP)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_MODIFY_QP)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_QUERY_QP)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_DESTROY_QP)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_POST_SEND)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_POST_RECV)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_CREATE_CQ)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_RESIZE_CQ)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_DESTROY_CQ)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_POLL_CQ)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_PEEK_CQ)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_REQ_NOTIFY_CQ)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_REG_MR)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_DEREG_MR)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_CREATE_AH)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_MODIFY_AH)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_QUERY_AH)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_DESTROY_AH)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_ATTACH_MCAST)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_DETACH_MCAST)
 +	    ;
++=======
+ 	dev->uverbs_cmd_mask |= BIT_ULL(IB_USER_VERBS_CMD_REQ_NOTIFY_CQ);
++>>>>>>> 676a80adba01 (RDMA: Remove AH from uverbs_cmd_mask)
  
  	ib_set_device_ops(dev, &rxe_dev_ops);
  	err = ib_device_set_netdev(&rxe->ib_dev, rxe->ndev, 1);
* Unmerged path drivers/infiniband/core/device.c
diff --git a/drivers/infiniband/core/uverbs_cmd.c b/drivers/infiniband/core/uverbs_cmd.c
index 5076cac0253f..49a8680515fb 100644
--- a/drivers/infiniband/core/uverbs_cmd.c
+++ b/drivers/infiniband/core/uverbs_cmd.c
@@ -3687,13 +3687,13 @@ const struct uapi_definition uverbs_def_write_intf[] = {
 				     ib_uverbs_create_ah,
 				     UAPI_DEF_WRITE_UDATA_IO(
 					     struct ib_uverbs_create_ah,
-					     struct ib_uverbs_create_ah_resp),
-				     UAPI_DEF_METHOD_NEEDS_FN(create_ah)),
+					     struct ib_uverbs_create_ah_resp)),
 		DECLARE_UVERBS_WRITE(
 			IB_USER_VERBS_CMD_DESTROY_AH,
 			ib_uverbs_destroy_ah,
-			UAPI_DEF_WRITE_I(struct ib_uverbs_destroy_ah),
-			UAPI_DEF_METHOD_NEEDS_FN(destroy_ah))),
+			UAPI_DEF_WRITE_I(struct ib_uverbs_destroy_ah)),
+		UAPI_DEF_OBJ_NEEDS_FN(create_user_ah),
+		UAPI_DEF_OBJ_NEEDS_FN(destroy_ah)),
 
 	DECLARE_UVERBS_OBJECT(
 		UVERBS_OBJECT_COMP_CHANNEL,
diff --git a/drivers/infiniband/core/verbs.c b/drivers/infiniband/core/verbs.c
index 2987ce861954..a07240673df5 100644
--- a/drivers/infiniband/core/verbs.c
+++ b/drivers/infiniband/core/verbs.c
@@ -533,7 +533,10 @@ static struct ib_ah *_rdma_create_ah(struct ib_pd *pd,
 	init_attr.flags = flags;
 	init_attr.xmit_slave = xmit_slave;
 
-	ret = device->ops.create_ah(ah, &init_attr, udata);
+	if (udata)
+		ret = device->ops.create_user_ah(ah, &init_attr, udata);
+	else
+		ret = device->ops.create_ah(ah, &init_attr, NULL);
 	if (ret) {
 		kfree(ah);
 		return ERR_PTR(ret);
* Unmerged path drivers/infiniband/hw/bnxt_re/main.c
* Unmerged path drivers/infiniband/hw/efa/efa_main.c
* Unmerged path drivers/infiniband/hw/mlx5/main.c
diff --git a/drivers/infiniband/hw/ocrdma/ocrdma_main.c b/drivers/infiniband/hw/ocrdma/ocrdma_main.c
index c15cfc6cef81..05f42db342e6 100644
--- a/drivers/infiniband/hw/ocrdma/ocrdma_main.c
+++ b/drivers/infiniband/hw/ocrdma/ocrdma_main.c
@@ -154,6 +154,7 @@ static const struct ib_device_ops ocrdma_dev_ops = {
 	.create_ah = ocrdma_create_ah,
 	.create_cq = ocrdma_create_cq,
 	.create_qp = ocrdma_create_qp,
+	.create_user_ah = ocrdma_create_ah,
 	.dealloc_pd = ocrdma_dealloc_pd,
 	.dealloc_ucontext = ocrdma_dealloc_ucontext,
 	.dereg_mr = ocrdma_dereg_mr,
@@ -226,12 +227,6 @@ static int ocrdma_register_device(struct ocrdma_dev *dev)
 	    OCRDMA_UVERBS(POST_SEND) |
 	    OCRDMA_UVERBS(POST_RECV);
 
-	dev->ibdev.uverbs_cmd_mask |=
-	    OCRDMA_UVERBS(CREATE_AH) |
-	     OCRDMA_UVERBS(MODIFY_AH) |
-	     OCRDMA_UVERBS(QUERY_AH) |
-	     OCRDMA_UVERBS(DESTROY_AH);
-
 	dev->ibdev.node_type = RDMA_NODE_IB_CA;
 	dev->ibdev.phys_port_cnt = 1;
 	dev->ibdev.num_comp_vectors = dev->eq_cnt;
diff --git a/drivers/infiniband/sw/rdmavt/ah.c b/drivers/infiniband/sw/rdmavt/ah.c
index b938c4ffa99a..f9754dcd250b 100644
--- a/drivers/infiniband/sw/rdmavt/ah.c
+++ b/drivers/infiniband/sw/rdmavt/ah.c
@@ -129,7 +129,6 @@ int rvt_create_ah(struct ib_ah *ibah, struct rdma_ah_init_attr *init_attr,
  * rvt_destory_ah - Destory an address handle
  * @ibah: address handle
  * @destroy_flags: destroy address handle flags (see enum rdma_destroy_ah_flags)
- *
  * Return: 0 on success
  */
 int rvt_destroy_ah(struct ib_ah *ibah, u32 destroy_flags)
* Unmerged path drivers/infiniband/sw/rdmavt/vt.c
* Unmerged path drivers/infiniband/sw/rxe/rxe_verbs.c
diff --git a/include/rdma/ib_verbs.h b/include/rdma/ib_verbs.h
index a63d25a22e2f..9cf1168a4ef4 100644
--- a/include/rdma/ib_verbs.h
+++ b/include/rdma/ib_verbs.h
@@ -2402,6 +2402,8 @@ struct ib_device_ops {
 	int (*dealloc_pd)(struct ib_pd *pd, struct ib_udata *udata);
 	int (*create_ah)(struct ib_ah *ah, struct rdma_ah_init_attr *attr,
 			 struct ib_udata *udata);
+	int (*create_user_ah)(struct ib_ah *ah, struct rdma_ah_init_attr *attr,
+			      struct ib_udata *udata);
 	int (*modify_ah)(struct ib_ah *ah, struct rdma_ah_attr *ah_attr);
 	int (*query_ah)(struct ib_ah *ah, struct rdma_ah_attr *ah_attr);
 	int (*destroy_ah)(struct ib_ah *ah, u32 flags);
