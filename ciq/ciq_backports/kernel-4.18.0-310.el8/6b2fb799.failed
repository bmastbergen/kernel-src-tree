fuse: optimize writepages search

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-310.el8
commit-author Maxim Patlasov <mpatlasov@virtuozzo.com>
commit 6b2fb79963fbed7db3ef850926d913518fd5c62f
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-310.el8/6b2fb799.failed

Re-work fi->writepages, replacing list with rb-tree.  This improves
performance because kernel fuse iterates through fi->writepages for each
writeback page and typical number of entries is about 800 (for 100MB of
fuse writeback).

Before patch:

10240+0 records in
10240+0 records out
10737418240 bytes (11 GB) copied, 41.3473 s, 260 MB/s

 2  1      0 57445400  40416 6323676    0    0    33 374743 8633 19210  1  8 88  3  0

  29.86%  [kernel]               [k] _raw_spin_lock
  26.62%  [fuse]                 [k] fuse_page_is_writeback

After patch:

10240+0 records in
10240+0 records out
10737418240 bytes (11 GB) copied, 21.4954 s, 500 MB/s

 2  9      0 53676040  31744 10265984    0    0    64 854790 10956 48387  1  6 88  6  0

  23.55%  [kernel]             [k] copy_user_enhanced_fast_string
   9.87%  [kernel]             [k] __memcpy
   3.10%  [kernel]             [k] _raw_spin_lock

	Signed-off-by: Maxim Patlasov <mpatlasov@virtuozzo.com>
	Signed-off-by: Vasily Averin <vvs@virtuozzo.com>
	Signed-off-by: Miklos Szeredi <mszeredi@redhat.com>
(cherry picked from commit 6b2fb79963fbed7db3ef850926d913518fd5c62f)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/fuse/file.c
diff --cc fs/fuse/file.c
index 1b617c09a013,15812a8b3834..000000000000
--- a/fs/fuse/file.c
+++ b/fs/fuse/file.c
@@@ -3477,8 -3441,5 +3513,12 @@@ void fuse_init_file_inode(struct inode 
  	INIT_LIST_HEAD(&fi->queued_writes);
  	fi->writectr = 0;
  	init_waitqueue_head(&fi->page_waitq);
++<<<<<<< HEAD
 +	INIT_LIST_HEAD(&fi->writepages);
 +
 +	if (IS_ENABLED(CONFIG_FUSE_DAX))
 +		fuse_dax_inode_init(inode);
++=======
+ 	fi->writepages = RB_ROOT;
++>>>>>>> 6b2fb79963fb (fuse: optimize writepages search)
  }
* Unmerged path fs/fuse/file.c
diff --git a/fs/fuse/fuse_i.h b/fs/fuse/fuse_i.h
index b27c2ea34315..5fef7349866a 100644
--- a/fs/fuse/fuse_i.h
+++ b/fs/fuse/fuse_i.h
@@ -111,7 +111,7 @@ struct fuse_inode {
 			wait_queue_head_t page_waitq;
 
 			/* List of writepage requestst (pending or sent) */
-			struct list_head writepages;
+			struct rb_root writepages;
 		};
 
 		/* readdir cache (directory only) */
