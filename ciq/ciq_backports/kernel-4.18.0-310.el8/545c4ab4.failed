RDMA/rxe: Fix errant WARN_ONCE in rxe_completer()

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-310.el8
commit-author Bob Pearson <rpearsonhpe@gmail.com>
commit 545c4ab463c2224557e56b2609f88ed5be265405
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-310.el8/545c4ab4.failed

In rxe_comp.c in rxe_completer() the function free_pkt() did not clear skb
which triggered a warning at 'done:' and could possibly at 'exit:'. The
WARN_ONCE() calls are not actually needed.  The call to free_pkt() is
moved to the end to clearly show that all skbs are freed.

Fixes: 899aba891cab ("RDMA/rxe: Fix FIXME in rxe_udp_encap_recv()")
Link: https://lore.kernel.org/r/20210304192048.2958-1-rpearson@hpe.com
	Signed-off-by: Bob Pearson <rpearsonhpe@gmail.com>
	Signed-off-by: Jason Gunthorpe <jgg@nvidia.com>
(cherry picked from commit 545c4ab463c2224557e56b2609f88ed5be265405)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/sw/rxe/rxe_comp.c
diff --cc drivers/infiniband/sw/rxe/rxe_comp.c
index 2adc7956726d,17a361b8dbb1..000000000000
--- a/drivers/infiniband/sw/rxe/rxe_comp.c
+++ b/drivers/infiniband/sw/rxe/rxe_comp.c
@@@ -624,11 -640,6 +628,14 @@@ int rxe_completer(void *arg
  			break;
  
  		case COMPST_DONE:
++<<<<<<< HEAD
 +			if (pkt) {
 +				rxe_drop_ref(pkt->qp);
 +				kfree_skb(skb);
 +				skb = NULL;
 +			}
++=======
++>>>>>>> 545c4ab463c2 (RDMA/rxe: Fix errant WARN_ONCE in rxe_completer())
  			goto done;
  
  		case COMPST_EXIT:
@@@ -670,15 -685,8 +681,18 @@@
  			 * retry sequence, unless this is a timeout.
  			 */
  			if (qp->comp.started_retry &&
++<<<<<<< HEAD
 +			    !qp->comp.timeout_retry) {
 +				if (pkt) {
 +					rxe_drop_ref(pkt->qp);
 +					kfree_skb(skb);
 +					skb = NULL;
 +				}
 +
++=======
+ 			    !qp->comp.timeout_retry)
++>>>>>>> 545c4ab463c2 (RDMA/rxe: Fix errant WARN_ONCE in rxe_completer())
  				goto done;
- 			}
  
  			if (qp->comp.retry_cnt > 0) {
  				if (qp->comp.retry_cnt != 7)
@@@ -699,13 -707,6 +713,16 @@@
  					qp->comp.started_retry = 1;
  					rxe_run_task(&qp->req.task, 0);
  				}
++<<<<<<< HEAD
 +
 +				if (pkt) {
 +					rxe_drop_ref(pkt->qp);
 +					kfree_skb(skb);
 +					skb = NULL;
 +				}
 +
++=======
++>>>>>>> 545c4ab463c2 (RDMA/rxe: Fix errant WARN_ONCE in rxe_completer())
  				goto done;
  
  			} else {
@@@ -726,10 -727,8 +743,15 @@@
  				mod_timer(&qp->rnr_nak_timer,
  					  jiffies + rnrnak_jiffies(aeth_syn(pkt)
  						& ~AETH_TYPE_MASK));
++<<<<<<< HEAD
 +				rxe_drop_ref(pkt->qp);
 +				kfree_skb(skb);
 +				skb = NULL;
 +				goto exit;
++=======
+ 				ret = -EAGAIN;
+ 				goto done;
++>>>>>>> 545c4ab463c2 (RDMA/rxe: Fix errant WARN_ONCE in rxe_completer())
  			} else {
  				rxe_counter_inc(rxe,
  						RXE_CNT_RNR_RETRY_EXCEEDED);
@@@ -742,14 -741,8 +764,19 @@@
  			WARN_ON_ONCE(wqe->status == IB_WC_SUCCESS);
  			do_complete(qp, wqe);
  			rxe_qp_error(qp);
++<<<<<<< HEAD
 +
 +			if (pkt) {
 +				rxe_drop_ref(pkt->qp);
 +				kfree_skb(skb);
 +				skb = NULL;
 +			}
 +
 +			goto exit;
++=======
+ 			ret = -EAGAIN;
+ 			goto done;
++>>>>>>> 545c4ab463c2 (RDMA/rxe: Fix errant WARN_ONCE in rxe_completer())
  		}
  	}
  
* Unmerged path drivers/infiniband/sw/rxe/rxe_comp.c
