KVM/SVM: Move vmenter.S exception fixups out of line

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-310.el8
commit-author Uros Bizjak <ubizjak@gmail.com>
commit 7531b47c8a358405e713b8070055c365f3172d74
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-310.el8/7531b47c.failed

Avoid jump by moving exception fixups out of line.

	Cc: Sean Christopherson <seanjc@google.com>
	Cc: Paolo Bonzini <pbonzini@redhat.com>
	Signed-off-by: Uros Bizjak <ubizjak@gmail.com>
Message-Id: <20210226125621.111723-1-ubizjak@gmail.com>
	Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
(cherry picked from commit 7531b47c8a358405e713b8070055c365f3172d74)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kvm/svm/vmenter.S
diff --cc arch/x86/kvm/svm/vmenter.S
index 850bdb9dc08c,4fa17df123cd..000000000000
--- a/arch/x86/kvm/svm/vmenter.S
+++ b/arch/x86/kvm/svm/vmenter.S
@@@ -79,28 -79,10 +79,27 @@@ ENTRY(__svm_vcpu_run
  
  	/* Enter guest mode */
  	sti
 +1:	vmload %_ASM_AX
 +	jmp 3f
 +2:	cmpb $0, kvm_rebooting
 +	jne 3f
 +	ud2
 +	_ASM_EXTABLE(1b, 2b)
  
- 3:	vmrun %_ASM_AX
- 	jmp 5f
- 4:	cmpb $0, kvm_rebooting
- 	jne 5f
- 	ud2
- 	_ASM_EXTABLE(3b, 4b)
+ 1:	vmrun %_ASM_AX
  
++<<<<<<< HEAD
 +5:	vmsave %_ASM_AX
 +	jmp 7f
 +6:	cmpb $0, kvm_rebooting
 +	jne 7f
 +	ud2
 +	_ASM_EXTABLE(5b, 6b)
 +7:
 +	cli
++=======
+ 2:	cli
++>>>>>>> 7531b47c8a35 (KVM/SVM: Move vmenter.S exception fixups out of line)
  
  #ifdef CONFIG_RETPOLINE
  	/* IMPORTANT: Stuff the RSB immediately after VM-Exit, before RET! */
@@@ -167,4 -149,65 +166,69 @@@
  #endif
  	pop %_ASM_BP
  	ret
++<<<<<<< HEAD
 +ENDPROC(__svm_vcpu_run)
++=======
+ 
+ 3:	cmpb $0, kvm_rebooting
+ 	jne 2b
+ 	ud2
+ 
+ 	_ASM_EXTABLE(1b, 3b)
+ 
+ SYM_FUNC_END(__svm_vcpu_run)
+ 
+ /**
+  * __svm_sev_es_vcpu_run - Run a SEV-ES vCPU via a transition to SVM guest mode
+  * @vmcb_pa:	unsigned long
+  */
+ SYM_FUNC_START(__svm_sev_es_vcpu_run)
+ 	push %_ASM_BP
+ #ifdef CONFIG_X86_64
+ 	push %r15
+ 	push %r14
+ 	push %r13
+ 	push %r12
+ #else
+ 	push %edi
+ 	push %esi
+ #endif
+ 	push %_ASM_BX
+ 
+ 	/* Move @vmcb to RAX. */
+ 	mov %_ASM_ARG1, %_ASM_AX
+ 
+ 	/* Enter guest mode */
+ 	sti
+ 
+ 1:	vmrun %_ASM_AX
+ 
+ 2:	cli
+ 
+ #ifdef CONFIG_RETPOLINE
+ 	/* IMPORTANT: Stuff the RSB immediately after VM-Exit, before RET! */
+ 	FILL_RETURN_BUFFER %_ASM_AX, RSB_CLEAR_LOOPS, X86_FEATURE_RETPOLINE
+ #endif
+ 
+ 	pop %_ASM_BX
+ 
+ #ifdef CONFIG_X86_64
+ 	pop %r12
+ 	pop %r13
+ 	pop %r14
+ 	pop %r15
+ #else
+ 	pop %esi
+ 	pop %edi
+ #endif
+ 	pop %_ASM_BP
+ 	ret
+ 
+ 3:	cmpb $0, kvm_rebooting
+ 	jne 2b
+ 	ud2
+ 
+ 	_ASM_EXTABLE(1b, 3b)
+ 
+ SYM_FUNC_END(__svm_sev_es_vcpu_run)
++>>>>>>> 7531b47c8a35 (KVM/SVM: Move vmenter.S exception fixups out of line)
* Unmerged path arch/x86/kvm/svm/vmenter.S
