Revert "vhost-vdpa: fix page pinning leakage in error path"

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-310.el8
commit-author Michael S. Tsirkin <mst@redhat.com>
commit 5e1a3149eec8675c2767cc465903f5e4829de5b0
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-310.el8/5e1a3149.failed

This reverts commit 7ed9e3d97c32d969caded2dfb6e67c1a2cc5a0b1.

The patch creates a DoS risk since it can result in a high order memory
allocation.

Fixes: 7ed9e3d97c32d ("vhost-vdpa: fix page pinning leakage in error path")
	Cc: stable@vger.kernel.org
	Signed-off-by: Michael S. Tsirkin <mst@redhat.com>
(cherry picked from commit 5e1a3149eec8675c2767cc465903f5e4829de5b0)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/vhost/vdpa.c
diff --cc drivers/vhost/vdpa.c
index 5a58938b1b8b,ec223da70a73..000000000000
--- a/drivers/vhost/vdpa.c
+++ b/drivers/vhost/vdpa.c
@@@ -628,7 -628,7 +628,11 @@@ static int vhost_vdpa_process_iotlb_upd
  	if (!npages)
  		return -EINVAL;
  
++<<<<<<< HEAD
 +	down_read(&dev->mm->mmap_sem);
++=======
+ 	mmap_read_lock(dev->mm);
++>>>>>>> 5e1a3149eec8 (Revert "vhost-vdpa: fix page pinning leakage in error path")
  
  	locked = atomic64_add_return(npages, &dev->mm->pinned_vm);
  	lock_limit = rlimit(RLIMIT_MEMLOCK) >> PAGE_SHIFT;
@@@ -643,7 -643,7 +647,11 @@@
  
  	while (npages) {
  		pinned = min_t(unsigned long, npages, list_size);
++<<<<<<< HEAD
 +		ret = get_user_pages(cur_base, pinned,
++=======
+ 		ret = pin_user_pages(cur_base, pinned,
++>>>>>>> 5e1a3149eec8 (Revert "vhost-vdpa: fix page pinning leakage in error path")
  				     gup_flags, page_list, NULL);
  		if (ret != pinned)
  			goto out;
@@@ -681,7 -681,7 +689,11 @@@ out
  		vhost_vdpa_unmap(v, msg->iova, msg->size);
  		atomic64_sub(npages, &dev->mm->pinned_vm);
  	}
++<<<<<<< HEAD
 +	up_read(&dev->mm->mmap_sem);
++=======
+ 	mmap_read_unlock(dev->mm);
++>>>>>>> 5e1a3149eec8 (Revert "vhost-vdpa: fix page pinning leakage in error path")
  	free_page((unsigned long)page_list);
  	return ret;
  }
* Unmerged path drivers/vhost/vdpa.c
