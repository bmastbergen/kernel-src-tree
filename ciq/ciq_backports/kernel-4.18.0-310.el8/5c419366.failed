RDMA/rxe,siw: Restore uverbs_cmd_mask IB_USER_VERBS_CMD_POST_SEND

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-310.el8
commit-author Jason Gunthorpe <jgg@nvidia.com>
commit 5c4193669b6f20b990f99cb8e15cdea80f865ac1
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-310.el8/5c419366.failed

These two drivers open code the call to POST_SEND and do not use the
rdma-core wrapper to do it, thus their usages was missed during the audit.

Both drivers use this as a doorbell to signal the kernel to start DMA.

Fixes: 628c02bf38aa ("RDMA: Remove uverbs cmds from drivers that don't use them")
Link: https://lore.kernel.org/r/0-v1-4608c5610afa+fb-uverbs_cmd_post_send_fix_jgg@nvidia.com
	Reported-by: Bob Pearson <rpearsonhpe@gmail.com>
	Signed-off-by: Jason Gunthorpe <jgg@nvidia.com>
(cherry picked from commit 5c4193669b6f20b990f99cb8e15cdea80f865ac1)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/sw/rxe/rxe_verbs.c
diff --cc drivers/infiniband/sw/rxe/rxe_verbs.c
index 6f655b55dded,209c7b3fab97..000000000000
--- a/drivers/infiniband/sw/rxe/rxe_verbs.c
+++ b/drivers/infiniband/sw/rxe/rxe_verbs.c
@@@ -1126,45 -1138,12 +1126,50 @@@ int rxe_register_device(struct rxe_dev 
  	dev->local_dma_lkey = 0;
  	addrconf_addr_eui48((unsigned char *)&dev->node_guid,
  			    rxe->ndev->dev_addr);
 +	dev->dev.dma_ops = &dma_virt_ops;
  	dev->dev.dma_parms = &rxe->dma_parms;
 -	dma_set_max_seg_size(&dev->dev, UINT_MAX);
 -	dma_set_coherent_mask(&dev->dev, dma_get_required_mask(&dev->dev));
 -
 +	rxe->dma_parms = (struct device_dma_parameters)
 +		{ .max_segment_size = SZ_2G };
 +	dma_coerce_mask_and_coherent(&dev->dev,
 +				     dma_get_required_mask(&dev->dev));
 +
++<<<<<<< HEAD
 +	dev->uverbs_cmd_mask = BIT_ULL(IB_USER_VERBS_CMD_GET_CONTEXT)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_CREATE_COMP_CHANNEL)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_QUERY_DEVICE)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_QUERY_PORT)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_ALLOC_PD)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_DEALLOC_PD)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_CREATE_SRQ)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_MODIFY_SRQ)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_QUERY_SRQ)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_DESTROY_SRQ)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_POST_SRQ_RECV)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_CREATE_QP)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_MODIFY_QP)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_QUERY_QP)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_DESTROY_QP)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_POST_SEND)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_POST_RECV)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_CREATE_CQ)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_RESIZE_CQ)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_DESTROY_CQ)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_POLL_CQ)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_PEEK_CQ)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_REQ_NOTIFY_CQ)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_REG_MR)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_DEREG_MR)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_CREATE_AH)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_MODIFY_AH)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_QUERY_AH)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_DESTROY_AH)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_ATTACH_MCAST)
 +	    | BIT_ULL(IB_USER_VERBS_CMD_DETACH_MCAST)
 +	    ;
++=======
+ 	dev->uverbs_cmd_mask |= BIT_ULL(IB_USER_VERBS_CMD_POST_SEND) |
+ 				BIT_ULL(IB_USER_VERBS_CMD_REQ_NOTIFY_CQ);
++>>>>>>> 5c4193669b6f (RDMA/rxe,siw: Restore uverbs_cmd_mask IB_USER_VERBS_CMD_POST_SEND)
  
  	ib_set_device_ops(dev, &rxe_dev_ops);
  	err = ib_device_set_netdev(&rxe->ib_dev, rxe->ndev, 1);
* Unmerged path drivers/infiniband/sw/rxe/rxe_verbs.c
diff --git a/drivers/infiniband/sw/siw/siw_main.c b/drivers/infiniband/sw/siw/siw_main.c
index 3b707def889f..1dff9b64f05a 100644
--- a/drivers/infiniband/sw/siw/siw_main.c
+++ b/drivers/infiniband/sw/siw/siw_main.c
@@ -371,6 +371,8 @@ static struct siw_device *siw_device_create(struct net_device *netdev)
 		(1ull << IB_USER_VERBS_CMD_QUERY_SRQ) |
 		(1ull << IB_USER_VERBS_CMD_DESTROY_SRQ);
 
+	base_dev->uverbs_cmd_mask |= BIT_ULL(IB_USER_VERBS_CMD_POST_SEND);
+
 	base_dev->node_type = RDMA_NODE_RNIC;
 	memcpy(base_dev->node_desc, SIW_NODE_DESC_COMMON,
 	       sizeof(SIW_NODE_DESC_COMMON));
