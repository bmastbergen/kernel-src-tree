fuse: connection remove fix

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-310.el8
commit-author Miklos Szeredi <mszeredi@redhat.com>
commit 413daa1a3f4a50af7172a862f391867711e9bc04
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-310.el8/413daa1a.failed

Re-add lost removal of fc from fuse_conn_list and the control filesystem.

	Reported-by: kernel test robot <rong.a.chen@intel.com>
Fixes: fcee216beb9c ("fuse: split fuse_mount off of fuse_conn")
	Signed-off-by: Miklos Szeredi <mszeredi@redhat.com>
(cherry picked from commit 413daa1a3f4a50af7172a862f391867711e9bc04)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/fuse/inode.c
diff --cc fs/fuse/inode.c
index ad83ccd9accc,e21034ae1466..000000000000
--- a/fs/fuse/inode.c
+++ b/fs/fuse/inode.c
@@@ -1389,29 -1523,52 +1389,60 @@@ static int fuse_init_fs_context(struct 
  	return 0;
  }
  
 -bool fuse_mount_remove(struct fuse_mount *fm)
 +static void fuse_sb_destroy(struct super_block *sb)
  {
 -	struct fuse_conn *fc = fm->fc;
 -	bool last = false;
 +	struct fuse_conn *fc = get_fuse_conn_super(sb);
  
 -	down_write(&fc->killsb);
 -	list_del_init(&fm->fc_entry);
 -	if (list_empty(&fc->mounts))
 -		last = true;
 -	up_write(&fc->killsb);
 +	if (fc) {
 +		if (fc->destroy)
 +			fuse_send_destroy(fc);
  
 -	return last;
 -}
 -EXPORT_SYMBOL_GPL(fuse_mount_remove);
 +		fuse_abort_conn(fc);
 +		fuse_wait_aborted(fc);
  
++<<<<<<< HEAD
 +		down_write(&fc->killsb);
 +		fc->sb = NULL;
 +		up_write(&fc->killsb);
++=======
+ void fuse_conn_destroy(struct fuse_mount *fm)
+ {
+ 	struct fuse_conn *fc = fm->fc;
+ 
+ 	if (fc->destroy)
+ 		fuse_send_destroy(fm);
+ 
+ 	fuse_abort_conn(fc);
+ 	fuse_wait_aborted(fc);
+ 
+ 	if (!list_empty(&fc->entry)) {
+ 		mutex_lock(&fuse_mutex);
+ 		list_del(&fc->entry);
+ 		fuse_ctl_remove_conn(fc);
+ 		mutex_unlock(&fuse_mutex);
+ 	}
+ }
+ EXPORT_SYMBOL_GPL(fuse_conn_destroy);
+ 
+ static void fuse_kill_sb_anon(struct super_block *sb)
+ {
+ 	struct fuse_mount *fm = get_fuse_mount_super(sb);
+ 	bool last;
+ 
+ 	if (fm) {
+ 		last = fuse_mount_remove(fm);
+ 		if (last)
+ 			fuse_conn_destroy(fm);
++>>>>>>> 413daa1a3f4a (fuse: connection remove fix)
  	}
 +}
 +
 +void fuse_kill_sb_anon(struct super_block *sb)
 +{
 +	fuse_sb_destroy(sb);
  	kill_anon_super(sb);
  }
 +EXPORT_SYMBOL_GPL(fuse_kill_sb_anon);
  
  static struct file_system_type fuse_fs_type = {
  	.owner		= THIS_MODULE,
* Unmerged path fs/fuse/inode.c
