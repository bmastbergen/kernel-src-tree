cifs: allow syscalls to be restarted in __smb_send_rqst()

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-310.el8
commit-author Paulo Alcantara <pc@cjr.nz>
commit 6988a619f5b79e4efadea6e19dcfe75fbcd350b5
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-310.el8/6988a619.failed

A customer has reported that several files in their multi-threaded app
were left with size of 0 because most of the read(2) calls returned
-EINTR and they assumed no bytes were read.  Obviously, they could
have fixed it by simply retrying on -EINTR.

We noticed that most of the -EINTR on read(2) were due to real-time
signals sent by glibc to process wide credential changes (SIGRT_1),
and its signal handler had been established with SA_RESTART, in which
case those calls could have been automatically restarted by the
kernel.

Let the kernel decide to whether or not restart the syscalls when
there is a signal pending in __smb_send_rqst() by returning
-ERESTARTSYS.  If it can't, it will return -EINTR anyway.

	Signed-off-by: Paulo Alcantara (SUSE) <pc@cjr.nz>
CC: Stable <stable@vger.kernel.org>
	Reviewed-by: Ronnie Sahlberg <lsahlber@redhat.com>
	Reviewed-by: Pavel Shilovsky <pshilov@microsoft.com>
	Signed-off-by: Steve French <stfrench@microsoft.com>
(cherry picked from commit 6988a619f5b79e4efadea6e19dcfe75fbcd350b5)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/cifs/transport.c
diff --cc fs/cifs/transport.c
index a15f75f9595d,36b2ece43403..000000000000
--- a/fs/cifs/transport.c
+++ b/fs/cifs/transport.c
@@@ -339,9 -338,9 +339,15 @@@ __smb_send_rqst(struct TCP_Server_Info 
  	if (ssocket == NULL)
  		return -EAGAIN;
  
++<<<<<<< HEAD
 +	if (fatal_signal_pending(current)) {
 +		cifs_dbg(FYI, "signal pending before send request\n");
 +		return -EINTR;
++=======
+ 	if (signal_pending(current)) {
+ 		cifs_dbg(FYI, "signal pending before send request\n");
+ 		return -ERESTARTSYS;
++>>>>>>> 6988a619f5b7 (cifs: allow syscalls to be restarted in __smb_send_rqst())
  	}
  
  	/* cork the socket */
* Unmerged path fs/cifs/transport.c
