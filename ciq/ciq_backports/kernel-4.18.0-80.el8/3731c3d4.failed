dma-mapping: always build the direct mapping code

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-80.el8
commit-author Christoph Hellwig <hch@lst.de>
commit 3731c3d4774e38b9d91c01943e1e6a243c1776be
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-80.el8/3731c3d4.failed

All architectures except for sparc64 use the dma-direct code in some
form, and even for sparc64 we had the discussion of a direct mapping
mode a while ago.  In preparation for directly calling the direct
mapping code don't bother having it optionally but always build the
code in.  This is a minor hardship for some powerpc and arm configs
that don't pull it in yet (although they should in a relase ot two),
and sparc64 which currently doesn't need it at all, but it will
reduce the ifdef mess we'd otherwise need significantly.

	Signed-off-by: Christoph Hellwig <hch@lst.de>
	Acked-by: Jesper Dangaard Brouer <brouer@redhat.com>
	Tested-by: Jesper Dangaard Brouer <brouer@redhat.com>
	Tested-by: Tony Luck <tony.luck@intel.com>
(cherry picked from commit 3731c3d4774e38b9d91c01943e1e6a243c1776be)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/arc/Kconfig
#	arch/arm/Kconfig
#	arch/arm64/Kconfig
#	arch/c6x/Kconfig
#	arch/csky/Kconfig
#	arch/m68k/Kconfig
#	arch/nds32/Kconfig
#	arch/nios2/Kconfig
#	arch/openrisc/Kconfig
#	arch/parisc/Kconfig
#	arch/sparc/Kconfig
#	arch/unicore32/Kconfig
#	arch/xtensa/Kconfig
#	kernel/dma/Kconfig
#	kernel/dma/Makefile
diff --cc arch/arc/Kconfig
index 5151d81476a1,7deaabeb531a..000000000000
--- a/arch/arc/Kconfig
+++ b/arch/arc/Kconfig
@@@ -16,8 -17,6 +16,11 @@@ config AR
  	select BUILDTIME_EXTABLE_SORT
  	select CLONE_BACKWARDS
  	select COMMON_CLK
++<<<<<<< HEAD
 +	select DMA_NONCOHERENT_OPS
 +	select DMA_NONCOHERENT_MMAP
++=======
++>>>>>>> 3731c3d4774e (dma-mapping: always build the direct mapping code)
  	select GENERIC_ATOMIC64 if !ISA_ARCV2 || !(ARC_HAS_LL64 && ARC_HAS_LLSC)
  	select GENERIC_CLOCKEVENTS
  	select GENERIC_FIND_FIRST_BIT
diff --cc arch/arm/Kconfig
index 843edfd000be,586fc30b23bd..000000000000
--- a/arch/arm/Kconfig
+++ b/arch/arm/Kconfig
@@@ -28,7 -30,7 +28,11 @@@ config AR
  	select CLONE_BACKWARDS
  	select CPU_PM if (SUSPEND || CPU_IDLE)
  	select DCACHE_WORD_ACCESS if HAVE_EFFICIENT_UNALIGNED_ACCESS
++<<<<<<< HEAD
 +	select DMA_DIRECT_OPS if !MMU
++=======
+ 	select DMA_REMAP if MMU
++>>>>>>> 3731c3d4774e (dma-mapping: always build the direct mapping code)
  	select EDAC_SUPPORT
  	select EDAC_ATOMIC_SCRUB
  	select GENERIC_ALLOCATOR
diff --cc arch/arm64/Kconfig
index 5b4fd63f9948,2092080240b0..000000000000
--- a/arch/arm64/Kconfig
+++ b/arch/arm64/Kconfig
@@@ -75,8 -78,9 +75,12 @@@ config ARM6
  	select CLONE_BACKWARDS
  	select COMMON_CLK
  	select CPU_PM if (SUSPEND || CPU_IDLE)
 -	select CRC32
  	select DCACHE_WORD_ACCESS
++<<<<<<< HEAD
 +	select DMA_DIRECT_OPS
++=======
+ 	select DMA_DIRECT_REMAP
++>>>>>>> 3731c3d4774e (dma-mapping: always build the direct mapping code)
  	select EDAC_SUPPORT
  	select FRAME_POINTER
  	select GENERIC_ALLOCATOR
diff --cc arch/c6x/Kconfig
index bf59855628ac,456e154674d1..000000000000
--- a/arch/c6x/Kconfig
+++ b/arch/c6x/Kconfig
@@@ -9,7 -9,6 +9,10 @@@ config C6
  	select ARCH_HAS_SYNC_DMA_FOR_CPU
  	select ARCH_HAS_SYNC_DMA_FOR_DEVICE
  	select CLKDEV_LOOKUP
++<<<<<<< HEAD
 +	select DMA_NONCOHERENT_OPS
++=======
++>>>>>>> 3731c3d4774e (dma-mapping: always build the direct mapping code)
  	select GENERIC_ATOMIC64
  	select GENERIC_IRQ_SHOW
  	select HAVE_ARCH_TRACEHOOK
diff --cc arch/m68k/Kconfig
index 785612b576f7,8a5868e9a3a0..000000000000
--- a/arch/m68k/Kconfig
+++ b/arch/m68k/Kconfig
@@@ -24,6 -26,7 +24,10 @@@ config M68
  	select MODULES_USE_ELF_RELA
  	select OLD_SIGSUSPEND3
  	select OLD_SIGACTION
++<<<<<<< HEAD
++=======
+ 	select ARCH_DISCARD_MEMBLOCK
++>>>>>>> 3731c3d4774e (dma-mapping: always build the direct mapping code)
  
  config CPU_BIG_ENDIAN
  	def_bool y
diff --cc arch/nds32/Kconfig
index 34f7222c5efe,1af6bbae7220..000000000000
--- a/arch/nds32/Kconfig
+++ b/arch/nds32/Kconfig
@@@ -11,7 -11,6 +11,10 @@@ config NDS3
  	select CLKSRC_MMIO
  	select CLONE_BACKWARDS
  	select COMMON_CLK
++<<<<<<< HEAD
 +	select DMA_NONCOHERENT_OPS
++=======
++>>>>>>> 3731c3d4774e (dma-mapping: always build the direct mapping code)
  	select GENERIC_ATOMIC64
  	select GENERIC_CPU_DEVICES
  	select GENERIC_CLOCKEVENTS
diff --cc arch/nios2/Kconfig
index 3d4ec88f1db1,f6c4b0f49997..000000000000
--- a/arch/nios2/Kconfig
+++ b/arch/nios2/Kconfig
@@@ -1,6 -1,9 +1,12 @@@
  # SPDX-License-Identifier: GPL-2.0
  config NIOS2
  	def_bool y
++<<<<<<< HEAD
++=======
+ 	select ARCH_HAS_SYNC_DMA_FOR_CPU
+ 	select ARCH_HAS_SYNC_DMA_FOR_DEVICE
+ 	select ARCH_NO_SWAP
++>>>>>>> 3731c3d4774e (dma-mapping: always build the direct mapping code)
  	select TIMER_OF
  	select GENERIC_ATOMIC64
  	select GENERIC_CLOCKEVENTS
diff --cc arch/openrisc/Kconfig
index 9ecad05bfc73,d0feebad5a8f..000000000000
--- a/arch/openrisc/Kconfig
+++ b/arch/openrisc/Kconfig
@@@ -6,6 -6,7 +6,10 @@@
  
  config OPENRISC
  	def_bool y
++<<<<<<< HEAD
++=======
+ 	select ARCH_HAS_SYNC_DMA_FOR_DEVICE
++>>>>>>> 3731c3d4774e (dma-mapping: always build the direct mapping code)
  	select OF
  	select OF_EARLY_FLATTREE
  	select IRQ_DOMAIN
diff --cc arch/parisc/Kconfig
index e7705dde953f,6e1b71da0e71..000000000000
--- a/arch/parisc/Kconfig
+++ b/arch/parisc/Kconfig
@@@ -187,6 -183,9 +187,12 @@@ config PA2
  config PA11
  	def_bool y
  	depends on PA7000 || PA7100LC || PA7200 || PA7300LC
++<<<<<<< HEAD
++=======
+ 	select ARCH_HAS_SYNC_DMA_FOR_CPU
+ 	select ARCH_HAS_SYNC_DMA_FOR_DEVICE
+ 	select DMA_NONCOHERENT_CACHE_SYNC
++>>>>>>> 3731c3d4774e (dma-mapping: always build the direct mapping code)
  
  config PREFETCH
  	def_bool y
diff --cc arch/sparc/Kconfig
index 0f535debf802,f5bb9ded1d18..000000000000
--- a/arch/sparc/Kconfig
+++ b/arch/sparc/Kconfig
@@@ -48,6 -47,7 +48,10 @@@ config SPAR
  
  config SPARC32
  	def_bool !64BIT
++<<<<<<< HEAD
++=======
+ 	select ARCH_HAS_SYNC_DMA_FOR_CPU
++>>>>>>> 3731c3d4774e (dma-mapping: always build the direct mapping code)
  	select GENERIC_ATOMIC64
  	select CLZ_TAB
  	select HAVE_UID16
diff --cc arch/unicore32/Kconfig
index 03f991e44288,2681027d7bff..000000000000
--- a/arch/unicore32/Kconfig
+++ b/arch/unicore32/Kconfig
@@@ -4,7 -4,6 +4,10 @@@ config UNICORE3
  	select ARCH_HAS_DEVMEM_IS_ALLOWED
  	select ARCH_MIGHT_HAVE_PC_PARPORT
  	select ARCH_MIGHT_HAVE_PC_SERIO
++<<<<<<< HEAD
 +	select HAVE_MEMBLOCK
++=======
++>>>>>>> 3731c3d4774e (dma-mapping: always build the direct mapping code)
  	select HAVE_GENERIC_DMA_COHERENT
  	select HAVE_KERNEL_GZIP
  	select HAVE_KERNEL_BZIP2
diff --cc arch/xtensa/Kconfig
index d575e8701955,36338e7564a3..000000000000
--- a/arch/xtensa/Kconfig
+++ b/arch/xtensa/Kconfig
@@@ -10,6 -9,7 +10,10 @@@ config XTENS
  	select BUILDTIME_EXTABLE_SORT
  	select CLONE_BACKWARDS
  	select COMMON_CLK
++<<<<<<< HEAD
++=======
+ 	select DMA_REMAP if MMU
++>>>>>>> 3731c3d4774e (dma-mapping: always build the direct mapping code)
  	select GENERIC_ATOMIC64
  	select GENERIC_CLOCKEVENTS
  	select GENERIC_IRQ_SHOW
diff --cc kernel/dma/Kconfig
index 1b1d63b3634b,ca88b867e7fe..000000000000
--- a/kernel/dma/Kconfig
+++ b/kernel/dma/Kconfig
@@@ -26,22 -29,14 +26,33 @@@ config ARCH_HAS_SYNC_DMA_FOR_CP
  config ARCH_HAS_SYNC_DMA_FOR_CPU_ALL
  	bool
  
++<<<<<<< HEAD
 +config DMA_DIRECT_OPS
 +	bool
 +	depends on HAS_DMA
 +
 +config DMA_NONCOHERENT_OPS
 +	bool
 +	depends on HAS_DMA
 +	select DMA_DIRECT_OPS
 +
 +config DMA_NONCOHERENT_MMAP
 +	bool
 +	depends on DMA_NONCOHERENT_OPS
 +
 +config DMA_NONCOHERENT_CACHE_SYNC
 +	bool
 +	depends on DMA_NONCOHERENT_OPS
++=======
+ config ARCH_HAS_DMA_COHERENT_TO_PFN
+ 	bool
+ 
+ config ARCH_HAS_DMA_MMAP_PGPROT
+ 	bool
+ 
+ config DMA_NONCOHERENT_CACHE_SYNC
+ 	bool
++>>>>>>> 3731c3d4774e (dma-mapping: always build the direct mapping code)
  
  config DMA_VIRT_OPS
  	bool
@@@ -49,5 -44,12 +60,15 @@@
  
  config SWIOTLB
  	bool
- 	select DMA_DIRECT_OPS
  	select NEED_DMA_MAP_STATE
++<<<<<<< HEAD
++=======
+ 
+ config DMA_REMAP
+ 	depends on MMU
+ 	bool
+ 
+ config DMA_DIRECT_REMAP
+ 	bool
+ 	select DMA_REMAP
++>>>>>>> 3731c3d4774e (dma-mapping: always build the direct mapping code)
diff --cc kernel/dma/Makefile
index 6de44e4eb454,a626f643cd63..000000000000
--- a/kernel/dma/Makefile
+++ b/kernel/dma/Makefile
@@@ -1,10 -1,8 +1,13 @@@
  # SPDX-License-Identifier: GPL-2.0
  
- obj-$(CONFIG_HAS_DMA)			+= mapping.o
+ obj-$(CONFIG_HAS_DMA)			+= mapping.o direct.o
  obj-$(CONFIG_DMA_CMA)			+= contiguous.o
  obj-$(CONFIG_HAVE_GENERIC_DMA_COHERENT) += coherent.o
++<<<<<<< HEAD
 +obj-$(CONFIG_DMA_DIRECT_OPS)		+= direct.o
 +obj-$(CONFIG_DMA_NONCOHERENT_OPS)	+= noncoherent.o
++=======
++>>>>>>> 3731c3d4774e (dma-mapping: always build the direct mapping code)
  obj-$(CONFIG_DMA_VIRT_OPS)		+= virt.o
  obj-$(CONFIG_DMA_API_DEBUG)		+= debug.o
  obj-$(CONFIG_SWIOTLB)			+= swiotlb.o
* Unmerged path arch/csky/Kconfig
diff --git a/arch/alpha/Kconfig b/arch/alpha/Kconfig
index 04a4a138ed13..024d13f6b8cd 100644
--- a/arch/alpha/Kconfig
+++ b/arch/alpha/Kconfig
@@ -204,7 +204,6 @@ config ALPHA_EIGER
 config ALPHA_JENSEN
 	bool "Jensen"
 	depends on BROKEN
-	select DMA_DIRECT_OPS
 	help
 	  DEC PC 150 AXP (aka Jensen): This is a very old Digital system - one
 	  of the first-generation Alpha systems. A number of these systems
* Unmerged path arch/arc/Kconfig
* Unmerged path arch/arm/Kconfig
* Unmerged path arch/arm64/Kconfig
* Unmerged path arch/c6x/Kconfig
* Unmerged path arch/csky/Kconfig
diff --git a/arch/h8300/Kconfig b/arch/h8300/Kconfig
index 091d6d04b5e5..f8d3fde08190 100644
--- a/arch/h8300/Kconfig
+++ b/arch/h8300/Kconfig
@@ -23,7 +23,6 @@ config H8300
 	select HAVE_ARCH_KGDB
 	select HAVE_ARCH_HASH
 	select CPU_NO_EFFICIENT_FFS
-	select DMA_DIRECT_OPS
 
 config CPU_BIG_ENDIAN
 	def_bool y
* Unmerged path arch/m68k/Kconfig
* Unmerged path arch/nds32/Kconfig
* Unmerged path arch/nios2/Kconfig
* Unmerged path arch/openrisc/Kconfig
* Unmerged path arch/parisc/Kconfig
diff --git a/arch/riscv/Kconfig b/arch/riscv/Kconfig
index 4764fdeb4f1f..a7cb305262bb 100644
--- a/arch/riscv/Kconfig
+++ b/arch/riscv/Kconfig
@@ -19,7 +19,6 @@ config RISCV
 	select ARCH_WANT_FRAME_POINTERS
 	select CLONE_BACKWARDS
 	select COMMON_CLK
-	select DMA_DIRECT_OPS
 	select GENERIC_CLOCKEVENTS
 	select GENERIC_CPU_DEVICES
 	select GENERIC_IRQ_SHOW
diff --git a/arch/s390/Kconfig b/arch/s390/Kconfig
index 03252aebf43b..0a7e60f16b07 100644
--- a/arch/s390/Kconfig
+++ b/arch/s390/Kconfig
@@ -131,7 +131,6 @@ config S390
 	select HAVE_COPY_THREAD_TLS
 	select HAVE_DEBUG_KMEMLEAK
 	select HAVE_DMA_CONTIGUOUS
-	select DMA_DIRECT_OPS
 	select HAVE_DYNAMIC_FTRACE
 	select HAVE_DYNAMIC_FTRACE_WITH_REGS
 	select HAVE_EFFICIENT_UNALIGNED_ACCESS
* Unmerged path arch/sparc/Kconfig
* Unmerged path arch/unicore32/Kconfig
diff --git a/arch/x86/Kconfig b/arch/x86/Kconfig
index 49a7cac0a30f..308573a7b2e9 100644
--- a/arch/x86/Kconfig
+++ b/arch/x86/Kconfig
@@ -89,7 +89,6 @@ config X86
 	select CLOCKSOURCE_VALIDATE_LAST_CYCLE
 	select CLOCKSOURCE_WATCHDOG
 	select DCACHE_WORD_ACCESS
-	select DMA_DIRECT_OPS
 	select EDAC_ATOMIC_SCRUB
 	select EDAC_SUPPORT
 	select GENERIC_CLOCKEVENTS
* Unmerged path arch/xtensa/Kconfig
* Unmerged path kernel/dma/Kconfig
* Unmerged path kernel/dma/Makefile
