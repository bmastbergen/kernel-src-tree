block: Expose queue nr_zones in sysfs

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-80.el8
commit-author Damien Le Moal <damien.lemoal@wdc.com>
commit 965b652e901886ea54f93c60027b5be76328d958
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-80.el8/965b652e.failed

Expose through sysfs the nr_zones field of struct request_queue.
Exposing this value helps in debugging disk issues as well as
facilitating scripts based use of the disk (e.g. blktests).

For zoned block devices, the nr_zones field indicates the total number
of zones of the device calculated using the known disk capacity and
zone size. This number of zones is always 0 for regular block devices.

Since nr_zones is defined conditionally with CONFIG_BLK_DEV_ZONED,
introduce the blk_queue_nr_zones() function to return the correct value
for any device, regardless if CONFIG_BLK_DEV_ZONED is set.

	Reviewed-by: Christoph Hellwig <hch@lst.de>
	Reviewed-by: Hannes Reinecke <hare@suse.com>
	Signed-off-by: Damien Le Moal <damien.lemoal@wdc.com>
	Signed-off-by: Jens Axboe <axboe@kernel.dk>
(cherry picked from commit 965b652e901886ea54f93c60027b5be76328d958)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	include/linux/blkdev.h
diff --cc include/linux/blkdev.h
index 375f33a02fea,6bb845f9601a..000000000000
--- a/include/linux/blkdev.h
+++ b/include/linux/blkdev.h
@@@ -807,6 -810,12 +807,15 @@@ static inline unsigned int blk_queue_zo
  	return blk_queue_is_zoned(q) ? q->limits.chunk_sectors : 0;
  }
  
++<<<<<<< HEAD
++=======
+ #ifdef CONFIG_BLK_DEV_ZONED
+ static inline unsigned int blk_queue_nr_zones(struct request_queue *q)
+ {
+ 	return blk_queue_is_zoned(q) ? q->nr_zones : 0;
+ }
+ 
++>>>>>>> 965b652e9018 (block: Expose queue nr_zones in sysfs)
  static inline unsigned int blk_queue_zone_no(struct request_queue *q,
  					     sector_t sector)
  {
@@@ -822,6 -831,12 +831,15 @@@ static inline bool blk_queue_zone_is_se
  		return false;
  	return test_bit(blk_queue_zone_no(q, sector), q->seq_zones_bitmap);
  }
++<<<<<<< HEAD
++=======
+ #else /* CONFIG_BLK_DEV_ZONED */
+ static inline unsigned int blk_queue_nr_zones(struct request_queue *q)
+ {
+ 	return 0;
+ }
+ #endif /* CONFIG_BLK_DEV_ZONED */
++>>>>>>> 965b652e9018 (block: Expose queue nr_zones in sysfs)
  
  static inline bool rq_is_sync(struct request *rq)
  {
diff --git a/block/blk-sysfs.c b/block/blk-sysfs.c
index 1b35b7758245..45fbe60491d4 100644
--- a/block/blk-sysfs.c
+++ b/block/blk-sysfs.c
@@ -300,6 +300,11 @@ static ssize_t queue_zoned_show(struct request_queue *q, char *page)
 	}
 }
 
+static ssize_t queue_nr_zones_show(struct request_queue *q, char *page)
+{
+	return queue_var_show(blk_queue_nr_zones(q), page);
+}
+
 static ssize_t queue_nomerges_show(struct request_queue *q, char *page)
 {
 	return queue_var_show((blk_queue_nomerges(q) << 1) |
@@ -637,6 +642,11 @@ static struct queue_sysfs_entry queue_zoned_entry = {
 	.show = queue_zoned_show,
 };
 
+static struct queue_sysfs_entry queue_nr_zones_entry = {
+	.attr = {.name = "nr_zones", .mode = 0444 },
+	.show = queue_nr_zones_show,
+};
+
 static struct queue_sysfs_entry queue_nomerges_entry = {
 	.attr = {.name = "nomerges", .mode = 0644 },
 	.show = queue_nomerges_show,
@@ -727,6 +737,7 @@ static struct attribute *default_attrs[] = {
 	&queue_write_zeroes_max_entry.attr,
 	&queue_nonrot_entry.attr,
 	&queue_zoned_entry.attr,
+	&queue_nr_zones_entry.attr,
 	&queue_nomerges_entry.attr,
 	&queue_rq_affinity_entry.attr,
 	&queue_iostats_entry.attr,
* Unmerged path include/linux/blkdev.h
