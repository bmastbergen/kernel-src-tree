blk-mq: enable IO poll if .nr_queues of type poll > 0

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-80.el8
commit-author Ming Lei <ming.lei@redhat.com>
commit cd19181bf9ad4b7f40f2a4e0355d052109c76529
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-80.el8/cd19181b.failed

The queue mapping of type poll only exists when set->map[HCTX_TYPE_POLL].nr_queues
is bigger than zero, so enhance the constraint by checking .nr_queues of type poll
before enabling IO poll.

Otherwise IO race & timeout can be observed when running block/007.

	Cc: Jeff Moyer <jmoyer@redhat.com>
	Cc: Christoph Hellwig <hch@lst.de>
	Signed-off-by: Ming Lei <ming.lei@redhat.com>
	Signed-off-by: Jens Axboe <axboe@kernel.dk>
(cherry picked from commit cd19181bf9ad4b7f40f2a4e0355d052109c76529)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	block/blk-sysfs.c
diff --cc block/blk-sysfs.c
index b8a7832d6c94,0619c8922893..000000000000
--- a/block/blk-sysfs.c
+++ b/block/blk-sysfs.c
@@@ -405,7 -402,8 +405,12 @@@ static ssize_t queue_poll_store(struct 
  	unsigned long poll_on;
  	ssize_t ret;
  
++<<<<<<< HEAD
 +	if (!q->mq_ops || !q->mq_ops->poll)
++=======
+ 	if (!q->tag_set || q->tag_set->nr_maps <= HCTX_TYPE_POLL ||
+ 	    !q->tag_set->map[HCTX_TYPE_POLL].nr_queues)
++>>>>>>> cd19181bf9ad (blk-mq: enable IO poll if .nr_queues of type poll > 0)
  		return -EINVAL;
  
  	ret = queue_var_store(&poll_on, page, count);
diff --git a/block/blk-mq.c b/block/blk-mq.c
index 91f431966b0c..3cc01066ff26 100644
--- a/block/blk-mq.c
+++ b/block/blk-mq.c
@@ -2784,7 +2784,8 @@ struct request_queue *blk_mq_init_allocated_queue(struct blk_mq_tag_set *set,
 	q->tag_set = set;
 
 	q->queue_flags |= QUEUE_FLAG_MQ_DEFAULT;
-	if (set->nr_maps > HCTX_TYPE_POLL)
+	if (set->nr_maps > HCTX_TYPE_POLL &&
+	    set->map[HCTX_TYPE_POLL].nr_queues)
 		blk_queue_flag_set(QUEUE_FLAG_POLL, q);
 
 	if (!(set->flags & BLK_MQ_F_SG_MERGE))
* Unmerged path block/blk-sysfs.c
