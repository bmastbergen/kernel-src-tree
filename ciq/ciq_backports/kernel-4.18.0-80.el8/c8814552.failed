net: sched: act_skbmod: remove dependency on rtnl lock

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-80.el8
Rebuild_CHGLOG: - [net] sched: act_skbmod: remove dependency on rtnl lock (Ivan Vecera) [1638022]
Rebuild_FUZZ: 95.15%
commit-author Vlad Buslov <vladbu@mellanox.com>
commit c8814552fe51358f5fc46bc1c4aa4bb68454f4eb
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-80.el8/c8814552.failed

Move read of skbmod_p rcu pointer to be protected by tcf spinlock. Use tcf
spinlock to protect private skbmod data from concurrent modification during
dump.

	Signed-off-by: Vlad Buslov <vladbu@mellanox.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit c8814552fe51358f5fc46bc1c4aa4bb68454f4eb)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/sched/act_skbmod.c
diff --cc net/sched/act_skbmod.c
index f58fe4aa104d,e9c86ade3b40..000000000000
--- a/net/sched/act_skbmod.c
+++ b/net/sched/act_skbmod.c
@@@ -153,11 -156,9 +153,10 @@@ static int tcf_skbmod_init(struct net *
  
  	d = to_skbmod(*a);
  
- 	ASSERT_RTNL();
  	p = kzalloc(sizeof(struct tcf_skbmod_params), GFP_KERNEL);
  	if (unlikely(!p)) {
 -		tcf_idr_release(*a, bind);
 +		if (ret == ACT_P_CREATED)
 +			tcf_idr_release(*a, bind);
  		return -ENOMEM;
  	}
  
@@@ -203,12 -204,11 +202,17 @@@ static int tcf_skbmod_dump(struct sk_bu
  {
  	struct tcf_skbmod *d = to_skbmod(a);
  	unsigned char *b = skb_tail_pointer(skb);
- 	struct tcf_skbmod_params  *p = rtnl_dereference(d->skbmod_p);
+ 	struct tcf_skbmod_params  *p;
  	struct tc_skbmod opt = {
  		.index   = d->tcf_index,
++<<<<<<< HEAD
 +		.refcnt  = d->tcf_refcnt - ref,
 +		.bindcnt = d->tcf_bindcnt - bind,
 +		.action  = d->tcf_action,
++=======
+ 		.refcnt  = refcount_read(&d->tcf_refcnt) - ref,
+ 		.bindcnt = atomic_read(&d->tcf_bindcnt) - bind,
++>>>>>>> c8814552fe51 (net: sched: act_skbmod: remove dependency on rtnl lock)
  	};
  	struct tcf_t t;
  
* Unmerged path net/sched/act_skbmod.c
