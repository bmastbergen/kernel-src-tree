drm/amdgpu: Suppress keypresses from ACPI_VIDEO events

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-80.el8
commit-author Lyude Paul <lyude@redhat.com>
commit 582f58de36834096a91cc1de2540c2f7269f850d
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-80.el8/582f58de.failed

Currently we return NOTIFY_DONE for any event which we don't think is
ours. However, many laptops will send more then just an ATIF event and
will also send an ACPI_VIDEO_NOTIFY_PROBE event as well. Since we don't
check for this, we return NOTIFY_DONE which causes a keypress for the
ACPI event to be propogated to userspace. This is the equivalent of
someone pressing the display key on a laptop every time there's a
hotplug event.

So, check for ACPI_VIDEO_NOTIFY_PROBE events and suppress keypresses
from them.

	Signed-off-by: Lyude Paul <lyude@redhat.com>
	Cc: stable@vger.kernel.org
	Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
(cherry picked from commit 582f58de36834096a91cc1de2540c2f7269f850d)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/gpu/drm/amd/amdgpu/amdgpu_acpi.c
diff --cc drivers/gpu/drm/amd/amdgpu/amdgpu_acpi.c
index 0d8c3fc6eace,7f0afc526419..000000000000
--- a/drivers/gpu/drm/amd/amdgpu/amdgpu_acpi.c
+++ b/drivers/gpu/drm/amd/amdgpu/amdgpu_acpi.c
@@@ -373,48 -375,59 +375,58 @@@ static int amdgpu_atif_handler(struct a
  	if (strcmp(event->device_class, ACPI_VIDEO_CLASS) != 0)
  		return NOTIFY_DONE;
  
+ 	/* Is this actually our event? */
  	if (!atif ||
  	    !atif->notification_cfg.enabled ||
- 	    event->type != atif->notification_cfg.command_code)
- 		/* Not our event */
- 		return NOTIFY_DONE;
+ 	    event->type != atif->notification_cfg.command_code) {
+ 		/* These events will generate keypresses otherwise */
+ 		if (event->type == ACPI_VIDEO_NOTIFY_PROBE)
+ 			return NOTIFY_BAD;
+ 		else
+ 			return NOTIFY_DONE;
+ 	}
  
 -	if (atif->functions.sbios_requests) {
 -		struct atif_sbios_requests req;
 +	/* Check pending SBIOS requests */
 +	count = amdgpu_atif_get_sbios_requests(atif, &req);
  
 -		/* Check pending SBIOS requests */
 -		count = amdgpu_atif_get_sbios_requests(atif, &req);
 +	if (count <= 0)
 +		return NOTIFY_DONE;
  
++<<<<<<< HEAD
 +	DRM_DEBUG_DRIVER("ATIF: %d pending SBIOS requests\n", count);
++=======
+ 		if (count <= 0)
+ 			return NOTIFY_BAD;
++>>>>>>> 582f58de3683 (drm/amdgpu: Suppress keypresses from ACPI_VIDEO events)
  
 -		DRM_DEBUG_DRIVER("ATIF: %d pending SBIOS requests\n", count);
 -
 -		/* todo: add DC handling */
 -		if ((req.pending & ATIF_PANEL_BRIGHTNESS_CHANGE_REQUEST) &&
 -		    !amdgpu_device_has_dc_support(adev)) {
 -			struct amdgpu_encoder *enc = atif->encoder_for_bl;
 +	if (req.pending & ATIF_PANEL_BRIGHTNESS_CHANGE_REQUEST) {
 +		struct amdgpu_encoder *enc = atif->encoder_for_bl;
  
 -			if (enc) {
 -				struct amdgpu_encoder_atom_dig *dig = enc->enc_priv;
 +		if (enc) {
 +			struct amdgpu_encoder_atom_dig *dig = enc->enc_priv;
  
 -				DRM_DEBUG_DRIVER("Changing brightness to %d\n",
 -						 req.backlight_level);
 +			DRM_DEBUG_DRIVER("Changing brightness to %d\n",
 +					req.backlight_level);
  
 -				amdgpu_display_backlight_set_level(adev, enc, req.backlight_level);
 +			amdgpu_display_backlight_set_level(adev, enc, req.backlight_level);
  
  #if defined(CONFIG_BACKLIGHT_CLASS_DEVICE) || defined(CONFIG_BACKLIGHT_CLASS_DEVICE_MODULE)
 -				backlight_force_update(dig->bl_dev,
 -						       BACKLIGHT_UPDATE_HOTKEY);
 +			backlight_force_update(dig->bl_dev,
 +					       BACKLIGHT_UPDATE_HOTKEY);
  #endif
 -			}
  		}
 -		if (req.pending & ATIF_DGPU_DISPLAY_EVENT) {
 -			if ((adev->flags & AMD_IS_PX) &&
 -			    amdgpu_atpx_dgpu_req_power_for_displays()) {
 -				pm_runtime_get_sync(adev->ddev->dev);
 -				/* Just fire off a uevent and let userspace tell us what to do */
 -				drm_helper_hpd_irq_event(adev->ddev);
 -				pm_runtime_mark_last_busy(adev->ddev->dev);
 -				pm_runtime_put_autosuspend(adev->ddev->dev);
 -			}
 +	}
 +	if (req.pending & ATIF_DGPU_DISPLAY_EVENT) {
 +		if ((adev->flags & AMD_IS_PX) &&
 +		    amdgpu_atpx_dgpu_req_power_for_displays()) {
 +			pm_runtime_get_sync(adev->ddev->dev);
 +			/* Just fire off a uevent and let userspace tell us what to do */
 +			drm_helper_hpd_irq_event(adev->ddev);
 +			pm_runtime_mark_last_busy(adev->ddev->dev);
 +			pm_runtime_put_autosuspend(adev->ddev->dev);
  		}
 -		/* TODO: check other events */
  	}
 +	/* TODO: check other events */
  
  	/* We've handled the event, stop the notifier chain. The ACPI interface
  	 * overloads ACPI_VIDEO_NOTIFY_PROBE, we don't want to send that to
* Unmerged path drivers/gpu/drm/amd/amdgpu/amdgpu_acpi.c
