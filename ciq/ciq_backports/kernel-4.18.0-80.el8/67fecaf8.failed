RDMA/core: Fix unwinding flow in case of error to register device

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-80.el8
commit-author Parav Pandit <parav@mellanox.com>
commit 67fecaf8e9cc28812042f61194ac0e0a9737f897
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-80.el8/67fecaf8.failed

If port pkey list initialization fails, free the port_immutable memory
during cleanup path. Currently it is missed out.

If cache setup fails, free the pkey list during cleanup path.

Fixes: d291f1a65 ("IB/core: Enforce PKey security on QPs")
	Signed-off-by: Parav Pandit <parav@mellanox.com>
	Reviewed-by: Daniel Jurgens <danielj@mellanox.com>
	Signed-off-by: Leon Romanovsky <leonro@mellanox.com>
	Signed-off-by: Doug Ledford <dledford@redhat.com>
(cherry picked from commit 67fecaf8e9cc28812042f61194ac0e0a9737f897)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/core/device.c
diff --cc drivers/infiniband/core/device.c
index 6fa4c59dc7a7,d175b94ae952..000000000000
--- a/drivers/infiniband/core/device.c
+++ b/drivers/infiniband/core/device.c
@@@ -516,19 -544,23 +516,30 @@@ int ib_register_device(struct ib_devic
  
  	ret = setup_port_pkey_list(device);
  	if (ret) {
++<<<<<<< HEAD
 +		pr_warn("Couldn't create per port_pkey_list\n");
 +		goto out;
++=======
+ 		dev_warn(&device->dev, "Couldn't create per port_pkey_list\n");
+ 		goto port_cleanup;
++>>>>>>> 67fecaf8e9cc (RDMA/core: Fix unwinding flow in case of error to register device)
  	}
  
  	ret = ib_cache_setup_one(device);
  	if (ret) {
++<<<<<<< HEAD
 +		pr_warn("Couldn't set up InfiniBand P_Key/GID cache\n");
 +		goto port_cleanup;
++=======
+ 		dev_warn(&device->dev,
+ 			 "Couldn't set up InfiniBand P_Key/GID cache\n");
+ 		goto pkey_cleanup;
++>>>>>>> 67fecaf8e9cc (RDMA/core: Fix unwinding flow in case of error to register device)
  	}
  
 -	device->index = __dev_new_index();
 -
  	ret = ib_device_register_rdmacg(device);
  	if (ret) {
 -		dev_warn(&device->dev,
 -			 "Couldn't register device with rdma cgroup\n");
 +		pr_warn("Couldn't register device with rdma cgroup\n");
  		goto cache_cleanup;
  	}
  
* Unmerged path drivers/infiniband/core/device.c
