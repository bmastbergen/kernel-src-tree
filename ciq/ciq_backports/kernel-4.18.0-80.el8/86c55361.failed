net: sched: cls_flower: dump offload count value

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-80.el8
Rebuild_CHGLOG: - [net] sched: cls_flower: dump offload count value (Ivan Vecera) [1638022]
Rebuild_FUZZ: 94.51%
commit-author Vlad Buslov <vladbu@mellanox.com>
commit 86c55361e569400b6286f30283a9c143a18c20d9
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-80.el8/86c55361.failed

Change flower in_hw_count type to fixed-size u32 and dump it as
TCA_FLOWER_IN_HW_COUNT. This change is necessary to properly test shared
blocks and re-offload functionality.

	Signed-off-by: Vlad Buslov <vladbu@mellanox.com>
	Acked-by: Jiri Pirko <jiri@mellanox.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 86c55361e569400b6286f30283a9c143a18c20d9)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	include/uapi/linux/pkt_cls.h
diff --cc include/uapi/linux/pkt_cls.h
index c8a24861d4c8,401d0c1e612d..000000000000
--- a/include/uapi/linux/pkt_cls.h
+++ b/include/uapi/linux/pkt_cls.h
@@@ -475,6 -475,16 +475,19 @@@ enum 
  	TCA_FLOWER_KEY_CVLAN_PRIO,	/* u8   */
  	TCA_FLOWER_KEY_CVLAN_ETH_TYPE,	/* be16 */
  
++<<<<<<< HEAD
++=======
+ 	TCA_FLOWER_KEY_ENC_IP_TOS,	/* u8 */
+ 	TCA_FLOWER_KEY_ENC_IP_TOS_MASK,	/* u8 */
+ 	TCA_FLOWER_KEY_ENC_IP_TTL,	/* u8 */
+ 	TCA_FLOWER_KEY_ENC_IP_TTL_MASK,	/* u8 */
+ 
+ 	TCA_FLOWER_KEY_ENC_OPTS,
+ 	TCA_FLOWER_KEY_ENC_OPTS_MASK,
+ 
+ 	TCA_FLOWER_IN_HW_COUNT,
+ 
++>>>>>>> 86c55361e569 (net: sched: cls_flower: dump offload count value)
  	__TCA_FLOWER_MAX,
  };
  
diff --git a/include/net/sch_generic.h b/include/net/sch_generic.h
index a9ce6f99e7f3..2df6be241460 100644
--- a/include/net/sch_generic.h
+++ b/include/net/sch_generic.h
@@ -360,7 +360,7 @@ static inline void tcf_block_offload_dec(struct tcf_block *block, u32 *flags)
 }
 
 static inline void
-tc_cls_offload_cnt_update(struct tcf_block *block, unsigned int *cnt,
+tc_cls_offload_cnt_update(struct tcf_block *block, u32 *cnt,
 			  u32 *flags, bool add)
 {
 	if (add) {
* Unmerged path include/uapi/linux/pkt_cls.h
diff --git a/net/sched/cls_flower.c b/net/sched/cls_flower.c
index 3dac61f8b53a..2dd6df3a6f46 100644
--- a/net/sched/cls_flower.c
+++ b/net/sched/cls_flower.c
@@ -95,7 +95,7 @@ struct cls_fl_filter {
 	struct list_head list;
 	u32 handle;
 	u32 flags;
-	unsigned int in_hw_count;
+	u32 in_hw_count;
 	struct rcu_work rwork;
 	struct net_device *hw_dev;
 };
@@ -1624,6 +1624,9 @@ static int fl_dump(struct net *net, struct tcf_proto *tp, void *fh,
 	if (f->flags && nla_put_u32(skb, TCA_FLOWER_FLAGS, f->flags))
 		goto nla_put_failure;
 
+	if (nla_put_u32(skb, TCA_FLOWER_IN_HW_COUNT, f->in_hw_count))
+		goto nla_put_failure;
+
 	if (tcf_exts_dump(skb, &f->exts))
 		goto nla_put_failure;
 
