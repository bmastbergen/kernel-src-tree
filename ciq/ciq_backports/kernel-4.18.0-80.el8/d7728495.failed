net: sched: act_sample: remove dependency on rtnl lock

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-80.el8
Rebuild_CHGLOG: - [net] sched: act_sample: remove dependency on rtnl lock (Ivan Vecera) [1638022]
Rebuild_FUZZ: 95.15%
commit-author Vlad Buslov <vladbu@mellanox.com>
commit d7728495665601658c7f94f3b5fa4e3f54d71c18
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-80.el8/d7728495.failed

Use tcf spinlock to protect private sample action data from concurrent
modification during dump and init.

	Signed-off-by: Vlad Buslov <vladbu@mellanox.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit d7728495665601658c7f94f3b5fa4e3f54d71c18)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/sched/act_sample.c
diff --cc net/sched/act_sample.c
index f17d3a84eb7f,81071afe1b43..000000000000
--- a/net/sched/act_sample.c
+++ b/net/sched/act_sample.c
@@@ -81,8 -86,8 +82,13 @@@ static int tcf_sample_init(struct net *
  	s->psample_group_num = nla_get_u32(tb[TCA_SAMPLE_PSAMPLE_GROUP]);
  	psample_group = psample_group_get(net, s->psample_group_num);
  	if (!psample_group) {
++<<<<<<< HEAD
 +		if (ret == ACT_P_CREATED)
 +			tcf_idr_release(*a, bind);
++=======
+ 		spin_unlock(&s->tcf_lock);
+ 		tcf_idr_release(*a, bind);
++>>>>>>> d77284956656 (net: sched: act_sample: remove dependency on rtnl lock)
  		return -ENOMEM;
  	}
  	RCU_INIT_POINTER(s->psample_group, psample_group);
@@@ -173,9 -178,8 +181,14 @@@ static int tcf_sample_dump(struct sk_bu
  	struct tcf_sample *s = to_sample(a);
  	struct tc_sample opt = {
  		.index      = s->tcf_index,
++<<<<<<< HEAD
 +		.action     = s->tcf_action,
 +		.refcnt     = s->tcf_refcnt - ref,
 +		.bindcnt    = s->tcf_bindcnt - bind,
++=======
+ 		.refcnt     = refcount_read(&s->tcf_refcnt) - ref,
+ 		.bindcnt    = atomic_read(&s->tcf_bindcnt) - bind,
++>>>>>>> d77284956656 (net: sched: act_sample: remove dependency on rtnl lock)
  	};
  	struct tcf_t t;
  
* Unmerged path net/sched/act_sample.c
