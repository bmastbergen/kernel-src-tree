net: hns3: Fix desc num set to default when setting channel

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-80.el8
commit-author Yunsheng Lin <linyunsheng@huawei.com>
commit 128b900de7df567ca7ca063bf5da4ed0f357db8c
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-80.el8/128b900d.failed

When user set the channel num using "ethtool -L ethX", the desc num
of BD will set to default value, which will cause desc num set by
user lost problem.

This patch fixes it by restoring the desc num set by user when setting
channel num.

Fixes: 09f2af6405b8 ("net: hns3: add support to modify tqps number")
	Signed-off-by: Yunsheng Lin <linyunsheng@huawei.com>
	Signed-off-by: Peng Li <lipeng321@huawei.com>
	Signed-off-by: Salil Mehta <salil.mehta@huawei.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 128b900de7df567ca7ca063bf5da4ed0f357db8c)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge_main.c
diff --cc drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge_main.c
index 517b4515da02,8577dfc799ad..000000000000
--- a/drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge_main.c
+++ b/drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge_main.c
@@@ -1269,18 -1261,15 +1269,18 @@@ static int hclge_map_tqps_to_func(struc
  	req->tqp_vid = cpu_to_le16(tqp_vid);
  
  	ret = hclge_cmd_send(&hdev->hw, &desc, 1);
 -	if (ret)
 -		dev_err(&hdev->pdev->dev, "TQP map failed %d.\n", ret);
 +	if (ret) {
 +		dev_err(&hdev->pdev->dev, "TQP map failed %d.\n",
 +			ret);
 +		return ret;
 +	}
  
 -	return ret;
 +	return 0;
  }
  
- static int  hclge_assign_tqp(struct hclge_vport *vport,
- 			     struct hnae3_queue **tqp, u16 num_tqps)
+ static int  hclge_assign_tqp(struct hclge_vport *vport)
  {
+ 	struct hnae3_knic_private_info *kinfo = &vport->nic.kinfo;
  	struct hclge_dev *hdev = vport->back;
  	int i, alloced;
  
@@@ -1333,13 -1324,11 +1335,18 @@@ static int hclge_knic_setup(struct hclg
  	if (!kinfo->tqp)
  		return -ENOMEM;
  
++<<<<<<< HEAD
 +	ret = hclge_assign_tqp(vport, kinfo->tqp, kinfo->num_tqps);
 +	if (ret) {
++=======
+ 	ret = hclge_assign_tqp(vport);
+ 	if (ret)
++>>>>>>> 128b900de7df (net: hns3: Fix desc num set to default when setting channel)
  		dev_err(&hdev->pdev->dev, "fail to assign TQPs %d.\n", ret);
 +		return -EINVAL;
 +	}
  
 -	return ret;
 +	return 0;
  }
  
  static int hclge_map_tqp_to_vport(struct hclge_dev *hdev,
@@@ -5927,9 -5935,10 +5934,9 @@@ static int hclge_set_channels(struct hn
  	u32 *rss_indir;
  	int ret, i;
  
 -	/* Free old tqps, and reallocate with new tqp number when nic setup */
  	hclge_release_tqp(vport);
  
- 	ret = hclge_knic_setup(vport, new_tqps_num);
+ 	ret = hclge_knic_setup(vport, new_tqps_num, kinfo->num_desc);
  	if (ret) {
  		dev_err(&hdev->pdev->dev, "setup nic fail, ret =%d\n", ret);
  		return ret;
* Unmerged path drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge_main.c
