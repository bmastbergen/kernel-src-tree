rcu: Switch ->tick_nohz_enabled_snap to rcu_data structure

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-80.el8
commit-author Paul E. McKenney <paulmck@linux.vnet.ibm.com>
commit 0fd79e7521bc944522c3c97f40f3d25619e329f4
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-80.el8/0fd79e75.failed

This commit removes ->tick_nohz_enabled_snap from the rcu_dynticks
structure and updates the code to access it from the rcu_data
structure.

	Signed-off-by: Paul E. McKenney <paulmck@linux.vnet.ibm.com>
(cherry picked from commit 0fd79e7521bc944522c3c97f40f3d25619e329f4)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	kernel/rcu/tree_plugin.h
diff --cc kernel/rcu/tree_plugin.h
index 6d38152e918f,6511032371c1..000000000000
--- a/kernel/rcu/tree_plugin.h
+++ b/kernel/rcu/tree_plugin.h
@@@ -1686,10 -1681,9 +1686,10 @@@ int rcu_needs_cpu(u64 basemono, u64 *ne
  static void rcu_prepare_for_idle(void)
  {
  	bool needwake;
- 	struct rcu_data *rdp;
+ 	struct rcu_data *rdp = this_cpu_ptr(&rcu_data);
  	struct rcu_dynticks *rdtp = this_cpu_ptr(&rcu_dynticks);
  	struct rcu_node *rnp;
 +	struct rcu_state *rsp;
  	int tne;
  
  	lockdep_assert_irqs_disabled();
@@@ -1727,10 -1721,7 +1727,14 @@@
  	if (rdtp->last_accelerate == jiffies)
  		return;
  	rdtp->last_accelerate = jiffies;
++<<<<<<< HEAD
 +	for_each_rcu_flavor(rsp) {
 +		rdp = this_cpu_ptr(&rcu_data);
 +		if (!rcu_segcblist_pend_cbs(&rdp->cblist))
 +			continue;
++=======
+ 	if (rcu_segcblist_pend_cbs(&rdp->cblist)) {
++>>>>>>> 0fd79e7521bc (rcu: Switch ->tick_nohz_enabled_snap to rcu_data structure)
  		rnp = rdp->mynode;
  		raw_spin_lock_rcu_node(rnp); /* irqs already disabled. */
  		needwake = rcu_accelerate_cbs(rnp, rdp);
diff --git a/kernel/rcu/tree.h b/kernel/rcu/tree.h
index 971069b043e9..3a9d18253e65 100644
--- a/kernel/rcu/tree.h
+++ b/kernel/rcu/tree.h
@@ -54,7 +54,6 @@ struct rcu_dynticks {
 				    /* Last jiffy CBs were accelerated. */
 	unsigned long last_advance_all;
 				    /* Last jiffy CBs were all advanced. */
-	int tick_nohz_enabled_snap; /* Previously seen value from sysfs. */
 #endif /* #ifdef CONFIG_RCU_FAST_NO_HZ */
 };
 
* Unmerged path kernel/rcu/tree_plugin.h
