net: sched: act_tunnel_key: remove dependency on rtnl lock

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-80.el8
Rebuild_CHGLOG: - [net] sched: act_tunnel_key: remove dependency on rtnl lock (Ivan Vecera) [1638022]
Rebuild_FUZZ: 95.50%
commit-author Vlad Buslov <vladbu@mellanox.com>
commit 729e01260989cc06c8a78491b46545793aef323a
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-80.el8/729e0126.failed

Use tcf lock to protect tunnel key action struct private data from
concurrent modification in init and dump. Use rcu swap operation to
reassign params pointer under protection of tcf lock. (old params value is
not used by init, so there is no need of standalone rcu dereference step)

Remove rtnl lock assertion that is no longer required.

	Signed-off-by: Vlad Buslov <vladbu@mellanox.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 729e01260989cc06c8a78491b46545793aef323a)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/sched/act_tunnel_key.c
diff --cc net/sched/act_tunnel_key.c
index 1670ff5d2af5,ba2ae9f75ef5..000000000000
--- a/net/sched/act_tunnel_key.c
+++ b/net/sched/act_tunnel_key.c
@@@ -349,11 -345,9 +348,10 @@@ static int tunnel_key_init(struct net *
  
  	t = to_tunnel_key(*a);
  
- 	ASSERT_RTNL();
  	params_new = kzalloc(sizeof(*params_new), GFP_KERNEL);
  	if (unlikely(!params_new)) {
 -		tcf_idr_release(*a, bind);
 +		if (ret == ACT_P_CREATED)
 +			tcf_idr_release(*a, bind);
  		NL_SET_ERR_MSG(extack, "Cannot allocate tunnel key parameters");
  		return -ENOMEM;
  	}
@@@ -485,9 -480,8 +482,14 @@@ static int tunnel_key_dump(struct sk_bu
  	struct tcf_tunnel_key_params *params;
  	struct tc_tunnel_key opt = {
  		.index    = t->tcf_index,
++<<<<<<< HEAD
 +		.refcnt   = t->tcf_refcnt - ref,
 +		.bindcnt  = t->tcf_bindcnt - bind,
 +		.action   = t->tcf_action,
++=======
+ 		.refcnt   = refcount_read(&t->tcf_refcnt) - ref,
+ 		.bindcnt  = atomic_read(&t->tcf_bindcnt) - bind,
++>>>>>>> 729e01260989 (net: sched: act_tunnel_key: remove dependency on rtnl lock)
  	};
  	struct tcf_t tm;
  
* Unmerged path net/sched/act_tunnel_key.c
