net: sched: act_vlan: remove dependency on rtnl lock

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-80.el8
Rebuild_CHGLOG: - [net] sched: act_vlan: remove dependency on rtnl lock (Ivan Vecera) [1638022]
Rebuild_FUZZ: 94.95%
commit-author Vlad Buslov <vladbu@mellanox.com>
commit 764e9a24480f6ffba5493fb21e6a7b030d6b8b67
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-80.el8/764e9a24.failed

Use tcf spinlock to protect vlan action private data from concurrent
modification during dump and init. Use rcu swap operation to reassign
params pointer under protection of tcf lock. (old params value is not used
by init, so there is no need of standalone rcu dereference step)

Remove rtnl assertion that is no longer necessary.

	Signed-off-by: Vlad Buslov <vladbu@mellanox.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 764e9a24480f6ffba5493fb21e6a7b030d6b8b67)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/sched/act_vlan.c
diff --cc net/sched/act_vlan.c
index c71fc085e1cd,5bde17fe3608..000000000000
--- a/net/sched/act_vlan.c
+++ b/net/sched/act_vlan.c
@@@ -195,11 -202,9 +195,10 @@@ static int tcf_vlan_init(struct net *ne
  
  	v = to_vlan(*a);
  
- 	ASSERT_RTNL();
  	p = kzalloc(sizeof(*p), GFP_KERNEL);
  	if (!p) {
 -		tcf_idr_release(*a, bind);
 +		if (ret == ACT_P_CREATED)
 +			tcf_idr_release(*a, bind);
  		return -ENOMEM;
  	}
  
@@@ -237,13 -241,11 +235,18 @@@ static int tcf_vlan_dump(struct sk_buf
  {
  	unsigned char *b = skb_tail_pointer(skb);
  	struct tcf_vlan *v = to_vlan(a);
- 	struct tcf_vlan_params *p = rtnl_dereference(v->vlan_p);
+ 	struct tcf_vlan_params *p;
  	struct tc_vlan opt = {
  		.index    = v->tcf_index,
++<<<<<<< HEAD
 +		.refcnt   = v->tcf_refcnt - ref,
 +		.bindcnt  = v->tcf_bindcnt - bind,
 +		.action   = v->tcf_action,
 +		.v_action = p->tcfv_action,
++=======
+ 		.refcnt   = refcount_read(&v->tcf_refcnt) - ref,
+ 		.bindcnt  = atomic_read(&v->tcf_bindcnt) - bind,
++>>>>>>> 764e9a24480f (net: sched: act_vlan: remove dependency on rtnl lock)
  	};
  	struct tcf_t t;
  
* Unmerged path net/sched/act_vlan.c
