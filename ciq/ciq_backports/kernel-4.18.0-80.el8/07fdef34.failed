iommu/arm-smmu-v3: Implement flush_iotlb_all hook

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-80.el8
commit-author Zhen Lei <thunder.leizhen@huawei.com>
commit 07fdef34d2be6811f00c6f9e4e2a1483cf86696c
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-80.el8/07fdef34.failed

.flush_iotlb_all is currently stubbed to arm_smmu_iotlb_sync() since the
only time it would ever need to actually do anything is for callers
doing their own explicit batching, e.g.:

	iommu_unmap_fast(domain, ...);
	iommu_unmap_fast(domain, ...);
	iommu_iotlb_flush_all(domain, ...);

where since io-pgtable still issues the TLBI commands implicitly in the
unmap instead of implementing .iotlb_range_add, the "flush" only needs
to ensure completion of those already-in-flight invalidations.

However, we're about to start using it in anger with flush queues, so
let's get a proper implementation wired up.

	Signed-off-by: Zhen Lei <thunder.leizhen@huawei.com>
	Reviewed-by: Robin Murphy <robin.murphy@arm.com>
[rm: document why it wasn't a bug]
	Signed-off-by: Robin Murphy <robin.murphy@arm.com>
	Signed-off-by: Will Deacon <will.deacon@arm.com>
(cherry picked from commit 07fdef34d2be6811f00c6f9e4e2a1483cf86696c)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/iommu/arm-smmu-v3.c
diff --cc drivers/iommu/arm-smmu-v3.c
index ce799042b2f4,f10c852479fc..000000000000
--- a/drivers/iommu/arm-smmu-v3.c
+++ b/drivers/iommu/arm-smmu-v3.c
@@@ -2006,8 -2016,7 +2014,12 @@@ static struct iommu_ops arm_smmu_ops = 
  	.attach_dev		= arm_smmu_attach_dev,
  	.map			= arm_smmu_map,
  	.unmap			= arm_smmu_unmap,
++<<<<<<< HEAD
 +	.map_sg			= default_iommu_map_sg,
 +	.flush_iotlb_all	= arm_smmu_iotlb_sync,
++=======
+ 	.flush_iotlb_all	= arm_smmu_flush_iotlb_all,
++>>>>>>> 07fdef34d2be (iommu/arm-smmu-v3: Implement flush_iotlb_all hook)
  	.iotlb_sync		= arm_smmu_iotlb_sync,
  	.iova_to_phys		= arm_smmu_iova_to_phys,
  	.add_device		= arm_smmu_add_device,
* Unmerged path drivers/iommu/arm-smmu-v3.c
