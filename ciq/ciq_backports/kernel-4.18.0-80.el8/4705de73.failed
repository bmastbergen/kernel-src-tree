blkcg: put back rcu lock in blkcg_bio_issue_check()

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-80.el8
commit-author Dennis Zhou <dennis@kernel.org>
commit 4705de735b3383792c84a92e57508d6865caa85f
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-80.el8/4705de73.failed

I was a little overzealous in removing the rcu_read_lock() call from
blkcg_bio_issue_check() and it broke blk-throttle. Put it back.

Fixes: e35403a034bf ("blkcg: associate blkg when associating a device")
	Signed-off-by: Dennis Zhou <dennis@kernel.org>
	Signed-off-by: Jens Axboe <axboe@kernel.dk>
(cherry picked from commit 4705de735b3383792c84a92e57508d6865caa85f)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	include/linux/blk-cgroup.h
diff --cc include/linux/blk-cgroup.h
index 8bf2308b920c,bf13ecb0fe4f..000000000000
--- a/include/linux/blk-cgroup.h
+++ b/include/linux/blk-cgroup.h
@@@ -845,20 -765,18 +845,26 @@@ static inline bool blkcg_bio_issue_chec
  	bool throtl = false;
  
  	rcu_read_lock();
++<<<<<<< HEAD
++=======
+ 
+ 	if (!bio->bi_blkg) {
+ 		char b[BDEVNAME_SIZE];
 -
 -		WARN_ONCE(1,
 -			  "no blkg associated for bio on block-device: %s\n",
 -			  bio_devname(bio, b));
 -		bio_associate_blkg(bio);
++>>>>>>> 4705de735b33 (blkcg: put back rcu lock in blkcg_bio_issue_check())
 +
 +	/* associate blkcg if bio hasn't attached one */
 +	bio_associate_blkcg(bio, NULL);
 +	blkcg = bio_blkcg(bio);
 +
 +	blkg = blkg_lookup(blkcg, q);
 +	if (unlikely(!blkg)) {
 +		spin_lock_irq(q->queue_lock);
 +		blkg = blkg_lookup_create(blkcg, q);
 +		if (IS_ERR(blkg))
 +			blkg = NULL;
 +		spin_unlock_irq(q->queue_lock);
  	}
  
 -	blkg = bio->bi_blkg;
 -
  	throtl = blk_throtl_bio(q, blkg, bio);
  
  	if (!throtl) {
@@@ -874,6 -791,8 +880,11 @@@
  		blkg_rwstat_add(&blkg->stat_ios, bio->bi_opf, 1);
  	}
  
++<<<<<<< HEAD
++=======
+ 	blkcg_bio_issue_init(bio);
+ 
++>>>>>>> 4705de735b33 (blkcg: put back rcu lock in blkcg_bio_issue_check())
  	rcu_read_unlock();
  	return !throtl;
  }
* Unmerged path include/linux/blk-cgroup.h
