powerpc/powernv: Rework TCE level allocation

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-80.el8
commit-author Alexey Kardashevskiy <aik@ozlabs.ru>
commit 9bc98c8a43c4900ee63b160f805c65051e35d917
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-80.el8/9bc98c8a.failed

This moves actual pages allocation to a separate function which is going
to be reused later in on-demand TCE allocation.

While we are at it, remove unnecessary level size round up as the caller
does this already.

	Reviewed-by: David Gibson <david@gibson.dropbear.id.au>
	Signed-off-by: Alexey Kardashevskiy <aik@ozlabs.ru>
	Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
(cherry picked from commit 9bc98c8a43c4900ee63b160f805c65051e35d917)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/powerpc/platforms/powernv/pci-ioda-tce.c
diff --cc arch/powerpc/platforms/powernv/pci-ioda-tce.c
index 726b8693f5ae,123c49925b46..000000000000
--- a/arch/powerpc/platforms/powernv/pci-ioda-tce.c
+++ b/arch/powerpc/platforms/powernv/pci-ioda-tce.c
@@@ -31,9 -31,26 +31,30 @@@ void pnv_pci_setup_iommu_table(struct i
  	tbl->it_type = TCE_PCI;
  }
  
++<<<<<<< HEAD
 +static __be64 *pnv_tce(struct iommu_table *tbl, long idx)
++=======
+ static __be64 *pnv_alloc_tce_level(int nid, unsigned int shift)
+ {
+ 	struct page *tce_mem = NULL;
+ 	__be64 *addr;
+ 
+ 	tce_mem = alloc_pages_node(nid, GFP_KERNEL, shift - PAGE_SHIFT);
+ 	if (!tce_mem) {
+ 		pr_err("Failed to allocate a TCE memory, level shift=%d\n",
+ 				shift);
+ 		return NULL;
+ 	}
+ 	addr = page_address(tce_mem);
+ 	memset(addr, 0, 1UL << shift);
+ 
+ 	return addr;
+ }
+ 
+ static __be64 *pnv_tce(struct iommu_table *tbl, bool user, long idx)
++>>>>>>> 9bc98c8a43c4 (powerpc/powernv: Rework TCE level allocation)
  {
 -	__be64 *tmp = user ? tbl->it_userspace : (__be64 *) tbl->it_base;
 +	__be64 *tmp = ((__be64 *)tbl->it_base);
  	int  level = tbl->it_indirect_levels;
  	const long shift = ilog2(tbl->it_level_size);
  	unsigned long mask = (tbl->it_level_size - 1) << (level * shift);
* Unmerged path arch/powerpc/platforms/powernv/pci-ioda-tce.c
