net: sched: always take reference to action

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-80.el8
Rebuild_CHGLOG: - [net] sched: always take reference to action (Ivan Vecera) [1638022]
Rebuild_FUZZ: 93.83%
commit-author Vlad Buslov <vladbu@mellanox.com>
commit 3f7c72bc4227b169ba2c924a7987324e24bbc4b2
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-80.el8/3f7c72bc.failed

Without rtnl lock protection it is no longer safe to use pointer to tc
action without holding reference to it. (it can be destroyed concurrently)

Remove unsafe action idr lookup function. Instead of it, implement safe tcf
idr check function that atomically looks up action in idr and increments
its reference and bind counters. Implement both action search and check
using new safe function

Reference taken by idr check is temporal and should not be accounted by
userspace clients (both logically and to preserver current API behavior).
Subtract temporal reference when dumping action to userspace using existing
tca_get_fill function arguments.

	Reviewed-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
	Signed-off-by: Vlad Buslov <vladbu@mellanox.com>
	Signed-off-by: Jiri Pirko <jiri@mellanox.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 3f7c72bc4227b169ba2c924a7987324e24bbc4b2)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/sched/act_api.c
diff --cc net/sched/act_api.c
index 73ad94033b10,aa304d36fee0..000000000000
--- a/net/sched/act_api.c
+++ b/net/sched/act_api.c
@@@ -299,17 -315,7 +303,21 @@@ EXPORT_SYMBOL(tcf_idr_search)
  bool tcf_idr_check(struct tc_action_net *tn, u32 index, struct tc_action **a,
  		   int bind)
  {
++<<<<<<< HEAD
 +	struct tcf_idrinfo *idrinfo = tn->idrinfo;
 +	struct tc_action *p = tcf_idr_lookup(index, idrinfo);
 +
 +	if (index && p) {
 +		if (bind)
 +			p->tcfa_bindcnt++;
 +		p->tcfa_refcnt++;
 +		*a = p;
 +		return true;
 +	}
 +	return false;
++=======
+ 	return __tcf_idr_check(tn, index, a, bind);
++>>>>>>> 3f7c72bc4227 (net: sched: always take reference to action)
  }
  EXPORT_SYMBOL(tcf_idr_check);
  
* Unmerged path net/sched/act_api.c
