net/sched: cls_fw: Fix improper refcount update leads to use-after-free

jira LE-1907
cve CVE-2023-3776
Rebuild_History Non-Buildable kernel-3.10.0-1160.105.1.el7
commit-author M A Ramdhan <ramdhan@starlabs.sg>
commit 0323bce598eea038714f941ce2b22541c46d488f
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1160.105.1.el7/0323bce5.failed

In the event of a failure in tcf_change_indev(), fw_set_parms() will
immediately return an error after incrementing or decrementing
reference counter in tcf_bind_filter().  If attacker can control
reference counter to zero and make reference freed, leading to
use after free.

In order to prevent this, move the point of possible failure above the
point where the TC_FW_CLASSID is handled.

Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
	Reported-by: M A Ramdhan <ramdhan@starlabs.sg>
	Signed-off-by: M A Ramdhan <ramdhan@starlabs.sg>
	Acked-by: Jamal Hadi Salim <jhs@mojatatu.com>
	Reviewed-by: Pedro Tammela <pctammela@mojatatu.com>
Message-ID: <20230705161530.52003-1-ramdhan@starlabs.sg>
	Signed-off-by: Jakub Kicinski <kuba@kernel.org>
(cherry picked from commit 0323bce598eea038714f941ce2b22541c46d488f)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/sched/cls_fw.c
diff --cc net/sched/cls_fw.c
index e05043266620,8641f8059317..000000000000
--- a/net/sched/cls_fw.c
+++ b/net/sched/cls_fw.c
@@@ -218,15 -212,9 +218,18 @@@ static int fw_set_parms(struct net *net
  	if (err < 0)
  		return err;
  
++<<<<<<< HEAD
 +	if (tb[TCA_FW_CLASSID]) {
 +		f->res.classid = nla_get_u32(tb[TCA_FW_CLASSID]);
 +		tcf_bind_filter(tp, &f->res, base);
 +	}
 +
 +#ifdef CONFIG_NET_CLS_IND
++=======
++>>>>>>> 0323bce598ee (net/sched: cls_fw: Fix improper refcount update leads to use-after-free)
  	if (tb[TCA_FW_INDEV]) {
  		int ret;
 -		ret = tcf_change_indev(net, tb[TCA_FW_INDEV], extack);
 +		ret = tcf_change_indev(net, tb[TCA_FW_INDEV]);
  		if (ret < 0)
  			return ret;
  		f->ifindex = ret;
* Unmerged path net/sched/cls_fw.c
