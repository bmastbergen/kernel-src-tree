fanotify: Move locking inside get_one_event()

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-365.el8
commit-author Jan Kara <jack@suse.cz>
commit 8c5544666c9d88046bfd60aa7d5fea5c6d3d59bd
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-365.el8/8c554466.failed

get_one_event() has a single caller and that just locks
notification_lock around the call. Move locking inside get_one_event()
as that will make using ->response field for permission event state
easier.

	Reviewed-by: Amir Goldstein <amir73il@gmail.com>
	Signed-off-by: Jan Kara <jack@suse.cz>
(cherry picked from commit 8c5544666c9d88046bfd60aa7d5fea5c6d3d59bd)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/notify/fanotify/fanotify_user.c
diff --cc fs/notify/fanotify/fanotify_user.c
index 48689619c0fd,121c84fc55ee..000000000000
--- a/fs/notify/fanotify/fanotify_user.c
+++ b/fs/notify/fanotify/fanotify_user.c
@@@ -57,19 -69,28 +55,41 @@@ struct kmem_cache *fanotify_perm_event_
  static struct fsnotify_event *get_one_event(struct fsnotify_group *group,
  					    size_t count)
  {
++<<<<<<< HEAD
 +	assert_spin_locked(&group->notification_lock);
++=======
+ 	size_t event_size = FAN_EVENT_METADATA_LEN;
+ 	struct fsnotify_event *fsn_event = NULL;
++>>>>>>> 8c5544666c9d (fanotify: Move locking inside get_one_event())
  
  	pr_debug("%s: group=%p count=%zd\n", __func__, group, count);
  
+ 	spin_lock(&group->notification_lock);
  	if (fsnotify_notify_queue_is_empty(group))
- 		return NULL;
+ 		goto out;
  
++<<<<<<< HEAD
 +	if (FAN_EVENT_METADATA_LEN > count)
 +		return ERR_PTR(-EINVAL);
 +
 +	/* held the notification_lock the whole time, so this is the
 +	 * same event we peeked above */
 +	return fsnotify_remove_first_event(group);
++=======
+ 	if (FAN_GROUP_FLAG(group, FAN_REPORT_FID)) {
+ 		event_size += fanotify_event_info_len(
+ 			FANOTIFY_E(fsnotify_peek_first_event(group)));
+ 	}
+ 
+ 	if (event_size > count) {
+ 		fsn_event = ERR_PTR(-EINVAL);
+ 		goto out;
+ 	}
+ 	fsn_event = fsnotify_remove_first_event(group);
+ out:
+ 	spin_unlock(&group->notification_lock);
+ 	return fsn_event;
++>>>>>>> 8c5544666c9d (fanotify: Move locking inside get_one_event())
  }
  
  static int create_fd(struct fsnotify_group *group,
* Unmerged path fs/notify/fanotify/fanotify_user.c
