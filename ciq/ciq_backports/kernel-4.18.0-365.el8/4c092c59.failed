swiotlb-xen: fix late init retry

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-365.el8
commit-author Jan Beulich <jbeulich@suse.com>
commit 4c092c59015f7adf0f07685f869edb96d997a756
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-365.el8/4c092c59.failed

The commit referenced below removed the assignment of "bytes" from
xen_swiotlb_init() without - like done for xen_swiotlb_init_early() -
adding an assignment on the retry path, thus leading to excessively
sized allocations upon retries.

Fixes: 2d29960af0be ("swiotlb: dynamically allocate io_tlb_default_mem")
	Signed-off-by: Jan Beulich <jbeulich@suse.com>
	Cc: stable@vger.kernel.org
	Reviewed-by: Christoph Hellwig <hch@lst.de>

Link: https://lore.kernel.org/r/778299d6-9cfd-1c13-026e-25ee5d14ecb3@suse.com
	Signed-off-by: Juergen Gross <jgross@suse.com>
(cherry picked from commit 4c092c59015f7adf0f07685f869edb96d997a756)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/xen/swiotlb-xen.c
diff --cc drivers/xen/swiotlb-xen.c
index 8ccd85660984,dbb18dc956f3..000000000000
--- a/drivers/xen/swiotlb-xen.c
+++ b/drivers/xen/swiotlb-xen.c
@@@ -227,24 -202,17 +227,31 @@@ retry
  		m_ret = XEN_SWIOTLB_EFIXUP;
  		goto error;
  	}
 -	rc = swiotlb_late_init_with_tbl(start, nslabs);
 -	if (rc)
 -		return rc;
 -	swiotlb_set_max_segment(PAGE_SIZE);
 -	return 0;
 +	if (early) {
 +		if (swiotlb_init_with_tbl(start, nslabs,
 +			 verbose))
 +			panic("Cannot allocate SWIOTLB buffer");
 +		rc = 0;
 +	} else
 +		rc = swiotlb_late_init_with_tbl(start, nslabs);
 +
 +	if (!rc)
 +		swiotlb_set_max_segment(PAGE_SIZE);
 +
 +	return rc;
  error:
  	if (repeat--) {
++<<<<<<< HEAD
 +		nslabs = max(1024UL, /* Min is 2MB */
 +					(nslabs >> 1));
 +		pr_info("Lowering to %luMB\n",
 +			(nslabs << IO_TLB_SHIFT) >> 20);
++=======
+ 		/* Min is 2MB */
+ 		nslabs = max(1024UL, (nslabs >> 1));
+ 		bytes = nslabs << IO_TLB_SHIFT;
+ 		pr_info("Lowering to %luMB\n", bytes >> 20);
++>>>>>>> 4c092c59015f (swiotlb-xen: fix late init retry)
  		goto retry;
  	}
  	pr_err("%s (rc:%d)\n", xen_swiotlb_error(m_ret), rc);
* Unmerged path drivers/xen/swiotlb-xen.c
