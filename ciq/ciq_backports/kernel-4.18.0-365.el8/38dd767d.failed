kasan: allow VMAP_STACK for HW_TAGS mode

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-365.el8
commit-author Andrey Konovalov <andreyknvl@google.com>
commit 38dd767daed1af5b5751441b95c4b28767a34fe3
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-365.el8/38dd767d.failed

Even though hardware tag-based mode currently doesn't support checking
vmalloc allocations, it doesn't use shadow memory and works with
VMAP_STACK as is. Change VMAP_STACK definition accordingly.

Link: https://lkml.kernel.org/r/ecdb2a1658ebd88eb276dee2493518ac0e82de41.1606162397.git.andreyknvl@google.com
Link: https://linux-review.googlesource.com/id/I3552cbc12321dec82cd7372676e9372a2eb452ac
	Signed-off-by: Andrey Konovalov <andreyknvl@google.com>
	Reviewed-by: Marco Elver <elver@google.com>
	Acked-by: Catalin Marinas <catalin.marinas@arm.com>
	Reviewed-by: Dmitry Vyukov <dvyukov@google.com>
	Tested-by: Vincenzo Frascino <vincenzo.frascino@arm.com>
	Cc: Alexander Potapenko <glider@google.com>
	Cc: Andrey Ryabinin <aryabinin@virtuozzo.com>
	Cc: Branislav Rankov <Branislav.Rankov@arm.com>
	Cc: Evgenii Stepanov <eugenis@google.com>
	Cc: Kevin Brodsky <kevin.brodsky@arm.com>
	Cc: Vasily Gorbik <gor@linux.ibm.com>
	Cc: Will Deacon <will.deacon@arm.com>
	Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
	Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
(cherry picked from commit 38dd767daed1af5b5751441b95c4b28767a34fe3)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/Kconfig
diff --cc arch/Kconfig
index 9daac07317f6,78c6f05b10f9..000000000000
--- a/arch/Kconfig
+++ b/arch/Kconfig
@@@ -974,16 -975,17 +974,28 @@@ config HAVE_ARCH_VMAP_STAC
  config VMAP_STACK
  	default y
  	bool "Use a virtually-mapped stack"
++<<<<<<< HEAD
 +	depends on HAVE_ARCH_VMAP_STACK && !KASAN
 +	---help---
++=======
+ 	depends on HAVE_ARCH_VMAP_STACK
+ 	depends on !KASAN || KASAN_HW_TAGS || KASAN_VMALLOC
+ 	help
++>>>>>>> 38dd767daed1 (kasan: allow VMAP_STACK for HW_TAGS mode)
  	  Enable this if you want the use virtually-mapped kernel stacks
  	  with guard pages.  This causes kernel stack overflows to be
  	  caught immediately rather than causing difficult-to-diagnose
  	  corruption.
  
++<<<<<<< HEAD
 +	  This is presently incompatible with KASAN because KASAN expects
 +	  the stack to map directly to the KASAN shadow map using a formula
 +	  that is incorrect if the stack is in vmalloc space.
++=======
+ 	  To use this with software KASAN modes, the architecture must support
+ 	  backing virtual mappings with real shadow memory, and KASAN_VMALLOC
+ 	  must be enabled.
++>>>>>>> 38dd767daed1 (kasan: allow VMAP_STACK for HW_TAGS mode)
  
  config ARCH_OPTIONAL_KERNEL_RWX
  	def_bool n
* Unmerged path arch/Kconfig
