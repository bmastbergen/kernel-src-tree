KVM: arm64: selftests: Add guest support to get the vcpuid

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-365.el8
commit-author Raghavendra Rao Ananta <rananta@google.com>
commit 17229bdc86c9e618e8832b5ca8451e367e07511b
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-365.el8/17229bdc.failed

At times, such as when in the interrupt handler, the guest wants
to get the vcpuid that it's running on to pull the per-cpu private
data. As a result, introduce guest_get_vcpuid() that returns the
vcpuid of the calling vcpu. The interface is architecture
independent, but defined only for arm64 as of now.

	Suggested-by: Reiji Watanabe <reijiw@google.com>
	Signed-off-by: Raghavendra Rao Ananta <rananta@google.com>
	Reviewed-by: Ricardo Koller <ricarkol@google.com>
	Reviewed-by: Reiji Watanabe <reijiw@google.com>
	Reviewed-by: Andrew Jones <drjones@redhat.com>
	Signed-off-by: Marc Zyngier <maz@kernel.org>
Link: https://lore.kernel.org/r/20211007233439.1826892-11-rananta@google.com
(cherry picked from commit 17229bdc86c9e618e8832b5ca8451e367e07511b)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/testing/selftests/kvm/lib/aarch64/processor.c
diff --cc tools/testing/selftests/kvm/lib/aarch64/processor.c
index a8751035968e,b4eeeafd2a70..000000000000
--- a/tools/testing/selftests/kvm/lib/aarch64/processor.c
+++ b/tools/testing/selftests/kvm/lib/aarch64/processor.c
@@@ -273,10 -273,11 +273,18 @@@ void aarch64_vcpu_setup(struct kvm_vm *
  	tcr_el1 |= (1 << 8) | (1 << 10) | (3 << 12);
  	tcr_el1 |= (64 - vm->va_bits) /* T0SZ */;
  
++<<<<<<< HEAD
 +	set_reg(vm, vcpuid, ARM64_SYS_REG(SCTLR_EL1), sctlr_el1);
 +	set_reg(vm, vcpuid, ARM64_SYS_REG(TCR_EL1), tcr_el1);
 +	set_reg(vm, vcpuid, ARM64_SYS_REG(MAIR_EL1), DEFAULT_MAIR_EL1);
 +	set_reg(vm, vcpuid, ARM64_SYS_REG(TTBR0_EL1), vm->pgd);
++=======
+ 	set_reg(vm, vcpuid, KVM_ARM64_SYS_REG(SYS_SCTLR_EL1), sctlr_el1);
+ 	set_reg(vm, vcpuid, KVM_ARM64_SYS_REG(SYS_TCR_EL1), tcr_el1);
+ 	set_reg(vm, vcpuid, KVM_ARM64_SYS_REG(SYS_MAIR_EL1), DEFAULT_MAIR_EL1);
+ 	set_reg(vm, vcpuid, KVM_ARM64_SYS_REG(SYS_TTBR0_EL1), vm->pgd);
+ 	set_reg(vm, vcpuid, KVM_ARM64_SYS_REG(SYS_TPIDR_EL1), vcpuid);
++>>>>>>> 17229bdc86c9 (KVM: arm64: selftests: Add guest support to get the vcpuid)
  }
  
  void vcpu_dump(FILE *stream, struct kvm_vm *vm, uint32_t vcpuid, uint8_t indent)
diff --git a/tools/testing/selftests/kvm/include/kvm_util.h b/tools/testing/selftests/kvm/include/kvm_util.h
index 010b59b13917..bcf05f5381ed 100644
--- a/tools/testing/selftests/kvm/include/kvm_util.h
+++ b/tools/testing/selftests/kvm/include/kvm_util.h
@@ -400,4 +400,6 @@ uint64_t get_ucall(struct kvm_vm *vm, uint32_t vcpu_id, struct ucall *uc);
 int vm_get_stats_fd(struct kvm_vm *vm);
 int vcpu_get_stats_fd(struct kvm_vm *vm, uint32_t vcpuid);
 
+uint32_t guest_get_vcpuid(void);
+
 #endif /* SELFTEST_KVM_UTIL_H */
* Unmerged path tools/testing/selftests/kvm/lib/aarch64/processor.c
