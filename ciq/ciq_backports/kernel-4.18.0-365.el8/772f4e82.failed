netfilter: nf_tables: fix double-free on set expression from the error path

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-365.el8
commit-author Pablo Neira Ayuso <pablo@netfilter.org>
commit 772f4e82b3ffa1eb7412cd531f718a96a0e5474b
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-365.el8/772f4e82.failed

After copying the expression to the set element extension, release the
expression and reset the pointer to avoid a double-free from the error
path.

Fixes: 409444522976 ("netfilter: nf_tables: add elements with stateful expressions")
	Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
(cherry picked from commit 772f4e82b3ffa1eb7412cd531f718a96a0e5474b)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/netfilter/nf_tables_api.c
diff --cc net/netfilter/nf_tables_api.c
index 13b98da99069,29ad33e52dbb..000000000000
--- a/net/netfilter/nf_tables_api.c
+++ b/net/netfilter/nf_tables_api.c
@@@ -5106,6 -5130,11 +5106,14 @@@ static int nft_add_set_elem(struct nft_
  		*nft_set_ext_obj(ext) = obj;
  		obj->use++;
  	}
++<<<<<<< HEAD
++=======
+ 	if (expr) {
+ 		memcpy(nft_set_ext_expr(ext), expr, expr->ops->size);
+ 		kfree(expr);
+ 		expr = NULL;
+ 	}
++>>>>>>> 772f4e82b3ff (netfilter: nf_tables: fix double-free on set expression from the error path)
  
  	trans = nft_trans_elem_alloc(ctx, NFT_MSG_NEWSETELEM, set);
  	if (trans == NULL)
* Unmerged path net/netfilter/nf_tables_api.c
