sched,x86: Fix L2 cache mask

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-365.el8
commit-author Peter Zijlstra <peterz@infradead.org>
commit 55409ac5c371c6403012d5f4df5e7c6cf0e7dce6
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-365.el8/55409ac5.failed

Currently AMD/Hygon do not populate l2c_id, this means that for SMT
enabled systems they report an L2 per thread. This is ofcourse not
true but was harmless so far.

However, since commit: 66558b730f25 ("sched: Add cluster scheduler
level for x86") the scheduler topology setup requires:

  SMT <= L2 <= LLC

Which leads to noisy warnings and possibly weird behaviour on affected
chips.

Therefore change the topology generation such that if l2c_id is not
populated it follows the SMT topology, thereby satisfying the
constraint.

Fixes: 66558b730f25 ("sched: Add cluster scheduler level for x86")
	Reported-by: Tom Lendacky <thomas.lendacky@amd.com>
	Signed-off-by: Peter Zijlstra (Intel) <peterz@infradead.org>
	Tested-by: Tom Lendacky <thomas.lendacky@amd.com>
(cherry picked from commit 55409ac5c371c6403012d5f4df5e7c6cf0e7dce6)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kernel/smpboot.c
diff --cc arch/x86/kernel/smpboot.c
index dd82f1c0186c,f80f4595ed41..000000000000
--- a/arch/x86/kernel/smpboot.c
+++ b/arch/x86/kernel/smpboot.c
@@@ -482,6 -466,21 +482,24 @@@ static bool match_die(struct cpuinfo_x8
  	return false;
  }
  
++<<<<<<< HEAD
++=======
+ static bool match_l2c(struct cpuinfo_x86 *c, struct cpuinfo_x86 *o)
+ {
+ 	int cpu1 = c->cpu_index, cpu2 = o->cpu_index;
+ 
+ 	/* If the arch didn't set up l2c_id, fall back to SMT */
+ 	if (per_cpu(cpu_l2c_id, cpu1) == BAD_APICID)
+ 		return match_smt(c, o);
+ 
+ 	/* Do not match if L2 cache id does not match: */
+ 	if (per_cpu(cpu_l2c_id, cpu1) != per_cpu(cpu_l2c_id, cpu2))
+ 		return false;
+ 
+ 	return topology_sane(c, o, "l2c");
+ }
+ 
++>>>>>>> 55409ac5c371 (sched,x86: Fix L2 cache mask)
  /*
   * Unlike the other levels, we do not enforce keeping a
   * multicore group inside a NUMA node.  If this happens, we will
* Unmerged path arch/x86/kernel/smpboot.c
