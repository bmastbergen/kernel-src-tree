drm/i915/fb: move intel_fb_align_height() to intel_fb.c

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-365.el8
commit-author Jani Nikula <jani.nikula@intel.com>
commit b8db261187439c42d18036d661a95e68de76550e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-365.el8/b8db2611.failed

Split out fb related stuff from intel_display.c to intel_fb.c.

	Reviewed-by: Rodrigo Vivi <rodrigo.vivi@intel.com>
	Signed-off-by: Jani Nikula <jani.nikula@intel.com>
Link: https://patchwork.freedesktop.org/patch/msgid/7c97d29eeff676b510eafd242e2a6d7c8ed4a3a6.1629721467.git.jani.nikula@intel.com
(cherry picked from commit b8db261187439c42d18036d661a95e68de76550e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/gpu/drm/i915/display/intel_display.c
#	drivers/gpu/drm/i915/display/intel_fb.c
#	drivers/gpu/drm/i915/display/intel_fb.h
diff --cc drivers/gpu/drm/i915/display/intel_display.c
index 19f6e7572c75,ddc6bd436b01..000000000000
--- a/drivers/gpu/drm/i915/display/intel_display.c
+++ b/drivers/gpu/drm/i915/display/intel_display.c
@@@ -1160,108 -879,6 +1160,111 @@@ intel_format_info_is_yuv_semiplanar(con
  	       info->num_planes == (is_ccs_modifier(modifier) ? 4 : 2);
  }
  
++<<<<<<< HEAD
 +static bool is_semiplanar_uv_plane(const struct drm_framebuffer *fb,
 +				   int color_plane)
 +{
 +	return intel_format_info_is_yuv_semiplanar(fb->format, fb->modifier) &&
 +	       color_plane == 1;
 +}
 +
 +static unsigned int
 +intel_tile_width_bytes(const struct drm_framebuffer *fb, int color_plane)
 +{
 +	struct drm_i915_private *dev_priv = to_i915(fb->dev);
 +	unsigned int cpp = fb->format->cpp[color_plane];
 +
 +	switch (fb->modifier) {
 +	case DRM_FORMAT_MOD_LINEAR:
 +		return intel_tile_size(dev_priv);
 +	case I915_FORMAT_MOD_X_TILED:
 +		if (IS_GEN(dev_priv, 2))
 +			return 128;
 +		else
 +			return 512;
 +	case I915_FORMAT_MOD_Y_TILED_CCS:
 +		if (is_ccs_plane(fb, color_plane))
 +			return 128;
 +		fallthrough;
 +	case I915_FORMAT_MOD_Y_TILED_GEN12_RC_CCS:
 +	case I915_FORMAT_MOD_Y_TILED_GEN12_RC_CCS_CC:
 +	case I915_FORMAT_MOD_Y_TILED_GEN12_MC_CCS:
 +		if (is_ccs_plane(fb, color_plane))
 +			return 64;
 +		fallthrough;
 +	case I915_FORMAT_MOD_Y_TILED:
 +		if (IS_GEN(dev_priv, 2) || HAS_128_BYTE_Y_TILING(dev_priv))
 +			return 128;
 +		else
 +			return 512;
 +	case I915_FORMAT_MOD_Yf_TILED_CCS:
 +		if (is_ccs_plane(fb, color_plane))
 +			return 128;
 +		fallthrough;
 +	case I915_FORMAT_MOD_Yf_TILED:
 +		switch (cpp) {
 +		case 1:
 +			return 64;
 +		case 2:
 +		case 4:
 +			return 128;
 +		case 8:
 +		case 16:
 +			return 256;
 +		default:
 +			MISSING_CASE(cpp);
 +			return cpp;
 +		}
 +		break;
 +	default:
 +		MISSING_CASE(fb->modifier);
 +		return cpp;
 +	}
 +}
 +
 +static unsigned int
 +intel_tile_height(const struct drm_framebuffer *fb, int color_plane)
 +{
 +	if (is_gen12_ccs_plane(fb, color_plane))
 +		return 1;
 +
 +	return intel_tile_size(to_i915(fb->dev)) /
 +		intel_tile_width_bytes(fb, color_plane);
 +}
 +
 +/* Return the tile dimensions in pixel units */
 +static void intel_tile_dims(const struct drm_framebuffer *fb, int color_plane,
 +			    unsigned int *tile_width,
 +			    unsigned int *tile_height)
 +{
 +	unsigned int tile_width_bytes = intel_tile_width_bytes(fb, color_plane);
 +	unsigned int cpp = fb->format->cpp[color_plane];
 +
 +	*tile_width = tile_width_bytes / cpp;
 +	*tile_height = intel_tile_height(fb, color_plane);
 +}
 +
 +static unsigned int intel_tile_row_size(const struct drm_framebuffer *fb,
 +					int color_plane)
 +{
 +	unsigned int tile_width, tile_height;
 +
 +	intel_tile_dims(fb, color_plane, &tile_width, &tile_height);
 +
 +	return fb->pitches[color_plane] * tile_height;
 +}
 +
 +unsigned int
 +intel_fb_align_height(const struct drm_framebuffer *fb,
 +		      int color_plane, unsigned int height)
 +{
 +	unsigned int tile_height = intel_tile_height(fb, color_plane);
 +
 +	return ALIGN(height, tile_height);
 +}
 +
++=======
++>>>>>>> b8db26118743 (drm/i915/fb: move intel_fb_align_height() to intel_fb.c)
  unsigned int intel_rotation_info_size(const struct intel_rotation_info *rot_info)
  {
  	unsigned int size = 0;
* Unmerged path drivers/gpu/drm/i915/display/intel_fb.c
* Unmerged path drivers/gpu/drm/i915/display/intel_fb.h
* Unmerged path drivers/gpu/drm/i915/display/intel_display.c
diff --git a/drivers/gpu/drm/i915/display/intel_display.h b/drivers/gpu/drm/i915/display/intel_display.h
index 76f8a805b0a3..c328f8d4a84c 100644
--- a/drivers/gpu/drm/i915/display/intel_display.h
+++ b/drivers/gpu/drm/i915/display/intel_display.h
@@ -538,8 +538,6 @@ void intel_init_display_hooks(struct drm_i915_private *dev_priv);
 unsigned int intel_fb_xy_to_linear(int x, int y,
 				   const struct intel_plane_state *state,
 				   int plane);
-unsigned int intel_fb_align_height(const struct drm_framebuffer *fb,
-				   int color_plane, unsigned int height);
 void intel_add_fb_offsets(int *x, int *y,
 			  const struct intel_plane_state *state, int plane);
 unsigned int intel_rotation_info_size(const struct intel_rotation_info *rot_info);
* Unmerged path drivers/gpu/drm/i915/display/intel_fb.c
* Unmerged path drivers/gpu/drm/i915/display/intel_fb.h
diff --git a/drivers/gpu/drm/i915/display/intel_fbdev.c b/drivers/gpu/drm/i915/display/intel_fbdev.c
index 84f853f113b9..312dde5a3cf5 100644
--- a/drivers/gpu/drm/i915/display/intel_fbdev.c
+++ b/drivers/gpu/drm/i915/display/intel_fbdev.c
@@ -43,6 +43,7 @@
 
 #include "i915_drv.h"
 #include "intel_display_types.h"
+#include "intel_fb.h"
 #include "intel_fbdev.h"
 #include "intel_frontbuffer.h"
 
