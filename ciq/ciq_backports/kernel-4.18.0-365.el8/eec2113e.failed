x86/fpu/amx: Define AMX state components and have it used for boot-time checks

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-365.el8
commit-author Chang S. Bae <chang.seok.bae@intel.com>
commit eec2113eabd92b7bfbaf1033fa82dc8eb4951203
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-365.el8/eec2113e.failed

The XSTATE initialization uses check_xstate_against_struct() to sanity
check the size of XSTATE-enabled features. AMX is a XSAVE-enabled feature,
and its size is not hard-coded but discoverable at run-time via CPUID.

The AMX state is composed of state components 17 and 18, which are all user
state components. The first component is the XTILECFG state of a 64-byte
tile-related control register. The state component 18, called XTILEDATA,
contains the actual tile data, and the state size varies on
implementations. The architectural maximum, as defined in the CPUID(0x1d,
1): EAX[15:0], is a byte less than 64KB. The first implementation supports
8KB.

Check the XTILEDATA state size dynamically. The feature introduces the new
tile register, TMM. Define one register struct only and read the number of
registers from CPUID. Cross-check the overall size with CPUID again.

	Signed-off-by: Chang S. Bae <chang.seok.bae@intel.com>
	Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
	Signed-off-by: Borislav Petkov <bp@suse.de>
Link: https://lore.kernel.org/r/20211021225527.10184-21-chang.seok.bae@intel.com
(cherry picked from commit eec2113eabd92b7bfbaf1033fa82dc8eb4951203)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kernel/fpu/xstate.c
diff --cc arch/x86/kernel/fpu/xstate.c
index f744359fb635,3372da871a40..000000000000
--- a/arch/x86/kernel/fpu/xstate.c
+++ b/arch/x86/kernel/fpu/xstate.c
@@@ -45,28 -51,32 +45,53 @@@ static const char *xfeature_names[] 
  	"Protection Keys User registers",
  	"PASID state",
  	"unknown xstate feature"	,
+ 	"unknown xstate feature"	,
+ 	"unknown xstate feature"	,
+ 	"unknown xstate feature"	,
+ 	"unknown xstate feature"	,
+ 	"unknown xstate feature"	,
+ 	"AMX Tile config"		,
+ 	"AMX Tile data"			,
+ 	"unknown xstate feature"	,
  };
  
++<<<<<<< HEAD
 +static short xsave_cpuid_features[] __initdata = {
 +	X86_FEATURE_FPU,
 +	X86_FEATURE_XMM,
 +	X86_FEATURE_AVX,
 +	X86_FEATURE_MPX,
 +	X86_FEATURE_MPX,
 +	X86_FEATURE_AVX512F,
 +	X86_FEATURE_AVX512F,
 +	X86_FEATURE_AVX512F,
 +	X86_FEATURE_INTEL_PT,
 +	X86_FEATURE_PKU,
 +	X86_FEATURE_ENQCMD,
++=======
+ static unsigned short xsave_cpuid_features[] __initdata = {
+ 	[XFEATURE_FP]				= X86_FEATURE_FPU,
+ 	[XFEATURE_SSE]				= X86_FEATURE_XMM,
+ 	[XFEATURE_YMM]				= X86_FEATURE_AVX,
+ 	[XFEATURE_BNDREGS]			= X86_FEATURE_MPX,
+ 	[XFEATURE_BNDCSR]			= X86_FEATURE_MPX,
+ 	[XFEATURE_OPMASK]			= X86_FEATURE_AVX512F,
+ 	[XFEATURE_ZMM_Hi256]			= X86_FEATURE_AVX512F,
+ 	[XFEATURE_Hi16_ZMM]			= X86_FEATURE_AVX512F,
+ 	[XFEATURE_PT_UNIMPLEMENTED_SO_FAR]	= X86_FEATURE_INTEL_PT,
+ 	[XFEATURE_PKRU]				= X86_FEATURE_PKU,
+ 	[XFEATURE_PASID]			= X86_FEATURE_ENQCMD,
+ 	[XFEATURE_XTILE_CFG]			= X86_FEATURE_AMX_TILE,
+ 	[XFEATURE_XTILE_DATA]			= X86_FEATURE_AMX_TILE,
++>>>>>>> eec2113eabd9 (x86/fpu/amx: Define AMX state components and have it used for boot-time checks)
  };
  
 +/*
 + * This represents the full set of bits that should ever be set in a kernel
 + * XSAVE buffer, both supervisor and user xstates.
 + */
 +u64 xfeatures_mask_all __ro_after_init;
 +
  static unsigned int xstate_offsets[XFEATURE_MAX] __ro_after_init =
  	{ [ 0 ... XFEATURE_MAX - 1] = -1};
  static unsigned int xstate_sizes[XFEATURE_MAX] __ro_after_init =
diff --git a/arch/x86/include/asm/cpufeatures.h b/arch/x86/include/asm/cpufeatures.h
index cb4a789820ec..d0f5b59135b9 100644
--- a/arch/x86/include/asm/cpufeatures.h
+++ b/arch/x86/include/asm/cpufeatures.h
@@ -294,6 +294,7 @@
 /* Intel-defined CPU features, CPUID level 0x00000007:1 (EAX), word 12 */
 #define X86_FEATURE_AVX_VNNI		(12*32+ 4) /* AVX VNNI instructions */
 #define X86_FEATURE_AVX512_BF16		(12*32+ 5) /* AVX512 BFLOAT16 instructions */
+#define X86_FEATURE_AMX_TILE		(18*32+24) /* AMX tile Support */
 
 /* AMD-defined CPU features, CPUID level 0x80000008 (EBX), word 13 */
 #define X86_FEATURE_CLZERO		(13*32+ 0) /* CLZERO instruction */
diff --git a/arch/x86/include/asm/fpu/types.h b/arch/x86/include/asm/fpu/types.h
index 696fdf451047..a83983841b72 100644
--- a/arch/x86/include/asm/fpu/types.h
+++ b/arch/x86/include/asm/fpu/types.h
@@ -122,6 +122,9 @@ enum xfeature {
 	XFEATURE_RSRVD_COMP_13,
 	XFEATURE_RSRVD_COMP_14,
 	XFEATURE_LBR,
+	XFEATURE_RSRVD_COMP_16,
+	XFEATURE_XTILE_CFG,
+	XFEATURE_XTILE_DATA,
 
 	XFEATURE_MAX,
 };
@@ -138,12 +141,21 @@ enum xfeature {
 #define XFEATURE_MASK_PKRU		(1 << XFEATURE_PKRU)
 #define XFEATURE_MASK_PASID		(1 << XFEATURE_PASID)
 #define XFEATURE_MASK_LBR		(1 << XFEATURE_LBR)
+#define XFEATURE_MASK_XTILE_CFG		(1 << XFEATURE_XTILE_CFG)
+#define XFEATURE_MASK_XTILE_DATA	(1 << XFEATURE_XTILE_DATA)
 
 #define XFEATURE_MASK_FPSSE		(XFEATURE_MASK_FP | XFEATURE_MASK_SSE)
 #define XFEATURE_MASK_AVX512		(XFEATURE_MASK_OPMASK \
 					 | XFEATURE_MASK_ZMM_Hi256 \
 					 | XFEATURE_MASK_Hi16_ZMM)
 
+#ifdef CONFIG_X86_64
+# define XFEATURE_MASK_XTILE		(XFEATURE_MASK_XTILE_DATA \
+					 | XFEATURE_MASK_XTILE_CFG)
+#else
+# define XFEATURE_MASK_XTILE		(0)
+#endif
+
 #define FIRST_EXTENDED_XFEATURE	XFEATURE_YMM
 
 struct reg_128_bit {
@@ -155,6 +167,9 @@ struct reg_256_bit {
 struct reg_512_bit {
 	u8	regbytes[512/8];
 };
+struct reg_1024_byte {
+	u8	regbytes[1024];
+};
 
 /*
  * State component 2:
@@ -257,6 +272,23 @@ struct arch_lbr_state {
 	u64 ler_to;
 	u64 ler_info;
 	struct lbr_entry		entries[];
+};
+
+/*
+ * State component 17: 64-byte tile configuration register.
+ */
+struct xtile_cfg {
+	u64				tcfg[8];
+} __packed;
+
+/*
+ * State component 18: 1KB tile data register.
+ * Each register represents 16 64-byte rows of the matrix
+ * data. But the number of registers depends on the actual
+ * implementation.
+ */
+struct xtile_data {
+	struct reg_1024_byte		tmm;
 } __packed;
 
 /*
diff --git a/arch/x86/include/asm/fpu/xstate.h b/arch/x86/include/asm/fpu/xstate.h
index 2df5bd667a43..cc10bb1b7cc2 100644
--- a/arch/x86/include/asm/fpu/xstate.h
+++ b/arch/x86/include/asm/fpu/xstate.h
@@ -14,6 +14,8 @@
 
 #define XSTATE_CPUID		0x0000000d
 
+#define TILE_CPUID		0x0000001d
+
 #define FXSAVE_SIZE	512
 
 #define XSAVE_HDR_SIZE	    64
* Unmerged path arch/x86/kernel/fpu/xstate.c
