netfilter: nf_tables: add elements with stateful expressions

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-365.el8
commit-author Pablo Neira Ayuso <pablo@netfilter.org>
commit 4094445229760d0d31a4190dfe88fe815c9fc34e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-365.el8/40944452.failed

Update nft_add_set_elem() to handle the NFTA_SET_ELEM_EXPR netlink
attribute. This patch allows users to to add elements with stateful
expressions.

	Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
(cherry picked from commit 4094445229760d0d31a4190dfe88fe815c9fc34e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/netfilter/nf_tables_api.c
diff --cc net/netfilter/nf_tables_api.c
index 46f06df75a7d,f92fb6003745..000000000000
--- a/net/netfilter/nf_tables_api.c
+++ b/net/netfilter/nf_tables_api.c
@@@ -4982,6 -4949,23 +4983,26 @@@ static int nft_add_set_elem(struct nft_
  		timeout = set->timeout;
  	}
  
++<<<<<<< HEAD
++=======
+ 	expiration = 0;
+ 	if (nla[NFTA_SET_ELEM_EXPIRATION] != NULL) {
+ 		if (!(set->flags & NFT_SET_TIMEOUT))
+ 			return -EINVAL;
+ 		err = nf_msecs_to_jiffies64(nla[NFTA_SET_ELEM_EXPIRATION],
+ 					    &expiration);
+ 		if (err)
+ 			return err;
+ 	}
+ 
+ 	if (nla[NFTA_SET_ELEM_EXPR] != NULL) {
+ 		expr = nft_set_elem_expr_alloc(ctx, set,
+ 					       nla[NFTA_SET_ELEM_EXPR]);
+ 		if (IS_ERR(expr))
+ 			return PTR_ERR(expr);
+ 	}
+ 
++>>>>>>> 409444522976 (netfilter: nf_tables: add elements with stateful expressions)
  	err = nft_setelem_parse_key(ctx, set, &elem.key.val,
  				    nla[NFTA_SET_ELEM_KEY]);
  	if (err < 0)
* Unmerged path net/netfilter/nf_tables_api.c
