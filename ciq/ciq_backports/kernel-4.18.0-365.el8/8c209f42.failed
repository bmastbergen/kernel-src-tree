drm/i915/adl_p: Add initial ADL_P Workarounds

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-365.el8
commit-author Clint Taylor <clinton.a.taylor@intel.com>
commit 8c209f42cb3a209c366bae2956c98d8ed0514773
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-365.el8/8c209f42.failed

Most of the context WA are already implemented.
Adding adl_p platform tag to reflect so.

v2: adjust comments for clarity (MattR)

BSpec: 54369
	Cc: Matt Roper <matthew.d.roper@intel.com>
	Cc: Aditya Swarup <aditya.swarup@intel.com>
	Reviewed-by: Matt Roper <matthew.d.roper@intel.com>
	Signed-off-by: Radhakrishna Sripada <radhakrishna.sripada@intel.com>
	Signed-off-by: Anusha Srivatsa <anusha.srivatsa@intel.com>
	Signed-off-by: Madhumitha Tolakanahalli Pradeep <madhumitha.tolakanahalli.pradeep@intel.com>
	Signed-off-by: Jos√© Roberto de Souza <jose.souza@intel.com>
	Signed-off-by: Swathi Dhanavanthri <swathi.dhanavanthri@intel.com>
	Signed-off-by: Clint Taylor <clinton.a.taylor@intel.com>
Link: https://patchwork.freedesktop.org/patch/msgid/20210608174721.17593-1-clinton.a.taylor@intel.com
(cherry picked from commit 8c209f42cb3a209c366bae2956c98d8ed0514773)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/gpu/drm/i915/gt/intel_workarounds.c
diff --cc drivers/gpu/drm/i915/gt/intel_workarounds.c
index 2529c4645e42,977a76e648e0..000000000000
--- a/drivers/gpu/drm/i915/gt/intel_workarounds.c
+++ b/drivers/gpu/drm/i915/gt/intel_workarounds.c
@@@ -611,16 -610,46 +611,17 @@@ static void icl_ctx_workarounds_init(st
  static void gen12_ctx_workarounds_init(struct intel_engine_cs *engine,
  				       struct i915_wa_list *wal)
  {
 -	gen12_ctx_gt_tuning_init(engine, wal);
 -
  	/*
- 	 * Wa_1409142259:tgl
- 	 * Wa_1409347922:tgl
- 	 * Wa_1409252684:tgl
- 	 * Wa_1409217633:tgl
- 	 * Wa_1409207793:tgl
- 	 * Wa_1409178076:tgl
- 	 * Wa_1408979724:tgl
- 	 * Wa_14010443199:rkl
- 	 * Wa_14010698770:rkl
+ 	 * Wa_1409142259:tgl,dg1,adl-p
+ 	 * Wa_1409347922:tgl,dg1,adl-p
+ 	 * Wa_1409252684:tgl,dg1,adl-p
+ 	 * Wa_1409217633:tgl,dg1,adl-p
+ 	 * Wa_1409207793:tgl,dg1,adl-p
+ 	 * Wa_1409178076:tgl,dg1,adl-p
+ 	 * Wa_1408979724:tgl,dg1,adl-p
+ 	 * Wa_14010443199:tgl,rkl,dg1,adl-p
+ 	 * Wa_14010698770:tgl,rkl,dg1,adl-s,adl-p
+ 	 * Wa_1409342910:tgl,rkl,dg1,adl-s,adl-p
  	 */
  	wa_masked_en(wal, GEN11_COMMON_SLICE_CHICKEN3,
  		     GEN12_DISABLE_CPS_AWARE_COLOR_PIPE);
@@@ -1121,13 -1114,8 +1122,18 @@@ gen12_gt_workarounds_init(struct drm_i9
  {
  	wa_init_mcr(i915, wal);
  
++<<<<<<< HEAD
 +	/* RH note: this workaround came in quite late, so limit it to ADL-S to avoid potential
 +	 * regressions
 +	 */
 +	if (IS_ALDERLAKE_S(i915)) {
 +		/* Wa_14011060649:tgl,rkl,dg1,adls */
 +		wa_14011060649(i915, wal);
 +	}
++=======
+ 	/* Wa_14011060649:tgl,rkl,dg1,adls,adl-p */
+ 	wa_14011060649(i915, wal);
++>>>>>>> 8c209f42cb3a (drm/i915/adl_p: Add initial ADL_P Workarounds)
  }
  
  static void
diff --git a/drivers/gpu/drm/i915/display/intel_dpll_mgr.c b/drivers/gpu/drm/i915/display/intel_dpll_mgr.c
index 529b1d569af2..adfe506f6258 100644
--- a/drivers/gpu/drm/i915/display/intel_dpll_mgr.c
+++ b/drivers/gpu/drm/i915/display/intel_dpll_mgr.c
@@ -2640,7 +2640,7 @@ static bool cnl_ddi_hdmi_pll_dividers(struct intel_crtc_state *crtc_state)
 }
 
 /*
- * Display WA #22010492432: ehl, tgl
+ * Display WA #22010492432: ehl, tgl, adl-p
  * Program half of the nominal DCO divider fraction value.
  */
 static bool
@@ -2648,7 +2648,7 @@ ehl_combo_pll_div_frac_wa_needed(struct drm_i915_private *i915)
 {
 	return ((IS_PLATFORM(i915, INTEL_ELKHARTLAKE) &&
 		 IS_JSL_EHL_REVID(i915, EHL_REVID_B0, REVID_FOREVER)) ||
-		 IS_TIGERLAKE(i915)) &&
+		 IS_TIGERLAKE(i915) || IS_ALDERLAKE_P(i915)) &&
 		 i915->dpll.ref_clks.nssc == 38400;
 }
 
diff --git a/drivers/gpu/drm/i915/gt/gen8_engine_cs.c b/drivers/gpu/drm/i915/gt/gen8_engine_cs.c
index 0bb340cacb13..9e67057d6207 100644
--- a/drivers/gpu/drm/i915/gt/gen8_engine_cs.c
+++ b/drivers/gpu/drm/i915/gt/gen8_engine_cs.c
@@ -208,7 +208,7 @@ int gen12_emit_flush_rcs(struct i915_request *rq, u32 mode)
 		flags |= PIPE_CONTROL_FLUSH_L3;
 		flags |= PIPE_CONTROL_RENDER_TARGET_CACHE_FLUSH;
 		flags |= PIPE_CONTROL_DEPTH_CACHE_FLUSH;
-		/* Wa_1409600907:tgl */
+		/* Wa_1409600907:tgl,adl-p */
 		flags |= PIPE_CONTROL_DEPTH_STALL;
 		flags |= PIPE_CONTROL_DC_FLUSH_ENABLE;
 		flags |= PIPE_CONTROL_FLUSH_ENABLE;
* Unmerged path drivers/gpu/drm/i915/gt/intel_workarounds.c
diff --git a/drivers/gpu/drm/i915/intel_pm.c b/drivers/gpu/drm/i915/intel_pm.c
index bac0c94e6962..415e562323e4 100644
--- a/drivers/gpu/drm/i915/intel_pm.c
+++ b/drivers/gpu/drm/i915/intel_pm.c
@@ -7068,15 +7068,17 @@ static void icl_init_clock_gating(struct drm_i915_private *dev_priv)
 static void gen12lp_init_clock_gating(struct drm_i915_private *dev_priv)
 {
 	/* Wa_1409120013:tgl,rkl,adl_s,dg1 */
-	intel_uncore_write(&dev_priv->uncore, ILK_DPFC_CHICKEN,
-			   ILK_DPFC_CHICKEN_COMP_DUMMY_PIXEL);
+	if (IS_TIGERLAKE(dev_priv) || IS_ROCKETLAKE(dev_priv) ||
+	    IS_ALDERLAKE_S(dev_priv) || IS_DG1(dev_priv))
+		intel_uncore_write(&dev_priv->uncore, ILK_DPFC_CHICKEN,
+				   ILK_DPFC_CHICKEN_COMP_DUMMY_PIXEL);
 
 	/* Wa_1409825376:tgl (pre-prod)*/
 	if (IS_TGL_DISPLAY_STEP(dev_priv, STEP_A0, STEP_B1))
 		intel_uncore_write(&dev_priv->uncore, GEN9_CLKGATE_DIS_3, intel_uncore_read(&dev_priv->uncore, GEN9_CLKGATE_DIS_3) |
 			   TGL_VRH_GATING_DIS);
 
-	/* Wa_14011059788:tgl,rkl,adl_s,dg1 */
+	/* Wa_14011059788:tgl,rkl,adl_s,dg1,adl-p */
 	intel_uncore_rmw(&dev_priv->uncore, GEN10_DFR_RATIO_EN_AND_CHICKEN,
 			 0, DFR_DISABLE);
 }
