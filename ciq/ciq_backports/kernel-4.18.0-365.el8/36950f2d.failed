driver core: add a min_align_mask field to struct device_dma_parameters

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-365.el8
commit-author Jianxiong Gao <jxgao@google.com>
commit 36950f2da1ea4cb683be174f6f581e25b2d33e71
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-365.el8/36950f2d.failed

Some devices rely on the address offset in a page to function
correctly (NVMe driver as an example). These devices may use
a different page size than the Linux kernel. The address offset
has to be preserved upon mapping, and in order to do so, we
need to record the page_offset_mask first.

	Signed-off-by: Jianxiong Gao <jxgao@google.com>
	Signed-off-by: Christoph Hellwig <hch@lst.de>
	Acked-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
	Signed-off-by: Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>
(cherry picked from commit 36950f2da1ea4cb683be174f6f581e25b2d33e71)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	include/linux/dma-mapping.h
diff --cc include/linux/dma-mapping.h
index 5c32cbab4717,9c26225754e7..000000000000
--- a/include/linux/dma-mapping.h
+++ b/include/linux/dma-mapping.h
@@@ -737,13 -500,20 +737,30 @@@ static inline int dma_set_seg_boundary(
  	return -EIO;
  }
  
++<<<<<<< HEAD
 +/*
 + * Please always use dma_alloc_coherent instead as it already zeroes the memory!
 + */
 +static inline void *dma_zalloc_coherent(struct device *dev, size_t size,
 +					dma_addr_t *dma_handle, gfp_t flag)
 +{
 +	return dma_alloc_coherent(dev, size, dma_handle, flag);
++=======
+ static inline unsigned int dma_get_min_align_mask(struct device *dev)
+ {
+ 	if (dev->dma_parms)
+ 		return dev->dma_parms->min_align_mask;
+ 	return 0;
+ }
+ 
+ static inline int dma_set_min_align_mask(struct device *dev,
+ 		unsigned int min_align_mask)
+ {
+ 	if (WARN_ON_ONCE(!dev->dma_parms))
+ 		return -EIO;
+ 	dev->dma_parms->min_align_mask = min_align_mask;
+ 	return 0;
++>>>>>>> 36950f2da1ea (driver core: add a min_align_mask field to struct device_dma_parameters)
  }
  
  static inline int dma_get_cache_alignment(void)
diff --git a/include/linux/device.h b/include/linux/device.h
index 08956d517202..961f036a288b 100644
--- a/include/linux/device.h
+++ b/include/linux/device.h
@@ -1012,6 +1012,7 @@ struct device_dma_parameters {
 	 * sg limitations.
 	 */
 	unsigned int max_segment_size;
+	unsigned int min_align_mask;
 	unsigned long segment_boundary_mask;
 };
 
* Unmerged path include/linux/dma-mapping.h
