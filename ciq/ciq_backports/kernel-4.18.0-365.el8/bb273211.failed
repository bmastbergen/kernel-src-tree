kbuild: move CFLAGS_{KASAN,UBSAN,KCSAN} exports to relevant Makefiles

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-365.el8
commit-author Masahiro Yamada <masahiroy@kernel.org>
commit bb2732112bc52bed7b20b9fc59d7246e4e7ce5ed
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-365.el8/bb273211.failed

Move CFLAGS_KASAN*, CFLAGS_UBSAN, CFLAGS_KCSAN to Makefile.kasan,
Makefile.ubsan, Makefile.kcsan, respectively.

This commit also avoids the same -fsanitize=* flags being added to
CFLAGS_UBSAN multiple times.

Prior to this commit, the ubsan flags were appended by the '+='
operator, without any initialization. Some build targets such as
'make bindeb-pkg' recurses to the top Makefile, and ended up with
adding the same flags to CFLAGS_UBSAN twice.

Clear CFLAGS_UBSAN with ':=' to make it a simply expanded variable.
This is better than a recursively expanded variable, which evaluates
$(call cc-option, ...) multiple times before Kbuild starts descending
to subdirectories.

	Signed-off-by: Masahiro Yamada <masahiroy@kernel.org>
	Acked-by: Marco Elver <elver@google.com>
(cherry picked from commit bb2732112bc52bed7b20b9fc59d7246e4e7ce5ed)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	scripts/Makefile.kcsan
#	scripts/Makefile.ubsan
diff --cc scripts/Makefile.kcsan
index caf1111a28ae,cec50d74e0d0..000000000000
--- a/scripts/Makefile.kcsan
+++ b/scripts/Makefile.kcsan
@@@ -1,6 -1,15 +1,15 @@@
  # SPDX-License-Identifier: GPL-2.0
 -# GCC and Clang accept backend options differently. Do not wrap in cc-option,
 -# because Clang accepts "--param" even if it is unused.
 -ifdef CONFIG_CC_IS_CLANG
 -cc-param = -mllvm -$(1)
 -else
 -cc-param = --param $(1)
 -endif
 +ifdef CONFIG_KCSAN
  
++<<<<<<< HEAD
 +CFLAGS_KCSAN := -fsanitize=thread
 +
 +endif # CONFIG_KCSAN
++=======
+ # Keep most options here optional, to allow enabling more compilers if absence
+ # of some options does not break KCSAN nor causes false positive reports.
+ export CFLAGS_KCSAN := -fsanitize=thread \
+ 	$(call cc-option,$(call cc-param,tsan-instrument-func-entry-exit=0) -fno-optimize-sibling-calls) \
+ 	$(call cc-option,$(call cc-param,tsan-instrument-read-before-write=1)) \
+ 	$(call cc-param,tsan-distinguish-volatile=1)
++>>>>>>> bb2732112bc5 (kbuild: move CFLAGS_{KASAN,UBSAN,KCSAN} exports to relevant Makefiles)
diff --cc scripts/Makefile.ubsan
index 38b2b4818e8e,c661484ee01f..000000000000
--- a/scripts/Makefile.ubsan
+++ b/scripts/Makefile.ubsan
@@@ -1,5 -1,16 +1,20 @@@
  # SPDX-License-Identifier: GPL-2.0
++<<<<<<< HEAD
 +ifdef CONFIG_UBSAN
++=======
+ 
+ export CFLAGS_UBSAN :=
+ 
+ ifdef CONFIG_UBSAN_ALIGNMENT
+       CFLAGS_UBSAN += $(call cc-option, -fsanitize=alignment)
+ endif
+ 
+ ifdef CONFIG_UBSAN_BOUNDS
+       CFLAGS_UBSAN += $(call cc-option, -fsanitize=bounds)
+ endif
+ 
+ ifdef CONFIG_UBSAN_MISC
++>>>>>>> bb2732112bc5 (kbuild: move CFLAGS_{KASAN,UBSAN,KCSAN} exports to relevant Makefiles)
        CFLAGS_UBSAN += $(call cc-option, -fsanitize=shift)
        CFLAGS_UBSAN += $(call cc-option, -fsanitize=integer-divide-by-zero)
        CFLAGS_UBSAN += $(call cc-option, -fsanitize=unreachable)
diff --git a/Makefile b/Makefile
index b5eb566f6b19..7f9a8323fd41 100644
--- a/Makefile
+++ b/Makefile
@@ -443,7 +443,6 @@ export HOSTCXX KBUILD_HOSTCXXFLAGS LDFLAGS_MODULE CHECK CHECKFLAGS
 
 export KBUILD_CPPFLAGS NOSTDINC_FLAGS LINUXINCLUDE OBJCOPYFLAGS LDFLAGS
 export KBUILD_CFLAGS CFLAGS_KERNEL CFLAGS_MODULE
-export CFLAGS_KASAN CFLAGS_KASAN_NOSANITIZE CFLAGS_UBSAN CFLAGS_KCSAN
 export KBUILD_AFLAGS AFLAGS_KERNEL AFLAGS_MODULE
 export KBUILD_AFLAGS_MODULE KBUILD_CFLAGS_MODULE KBUILD_LDFLAGS_MODULE
 export KBUILD_AFLAGS_KERNEL KBUILD_CFLAGS_KERNEL
diff --git a/scripts/Makefile.kasan b/scripts/Makefile.kasan
index f4beee1b0013..ae6dbe8de78f 100644
--- a/scripts/Makefile.kasan
+++ b/scripts/Makefile.kasan
@@ -49,3 +49,5 @@ CFLAGS_KASAN := -fsanitize=kernel-hwaddress \
 		$(instrumentation_flags)
 
 endif # CONFIG_KASAN_SW_TAGS
+
+export CFLAGS_KASAN CFLAGS_KASAN_NOSANITIZE
* Unmerged path scripts/Makefile.kcsan
* Unmerged path scripts/Makefile.ubsan
