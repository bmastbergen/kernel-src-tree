driver core: lift dma_default_coherent into common code

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-365.el8
commit-author Christoph Hellwig <hch@lst.de>
commit 6d4e9a8efe3d59f31367d79e970c2f328da139a4
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-365.el8/6d4e9a8e.failed

Lift the dma_default_coherent variable from the mips architecture code
to the driver core.  This allows an architecture to sdefault all device
to be DMA coherent at run time, even if the kernel is build with support
for DMA noncoherent device.  By allowing device_initialize to set the
->dma_coherent field to this default the amount of arch hooks required
for this behavior can be greatly reduced.

	Signed-off-by: Christoph Hellwig <hch@lst.de>
	Acked-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
	Signed-off-by: Thomas Bogendoerfer <tsbogend@alpha.franken.de>
(cherry picked from commit 6d4e9a8efe3d59f31367d79e970c2f328da139a4)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/mips/alchemy/common/setup.c
#	arch/mips/include/asm/dma-coherence.h
#	arch/mips/kernel/setup.c
#	arch/mips/mm/dma-noncoherent.c
#	include/linux/dma-map-ops.h
diff --cc arch/mips/alchemy/common/setup.c
index 7faaa6d593a7,2388d68786f4..000000000000
--- a/arch/mips/alchemy/common/setup.c
+++ b/arch/mips/alchemy/common/setup.c
@@@ -27,8 -27,9 +27,12 @@@
  
  #include <linux/init.h>
  #include <linux/ioport.h>
++<<<<<<< HEAD
++=======
+ #include <linux/mm.h>
+ #include <linux/dma-map-ops.h> /* for dma_default_coherent */
++>>>>>>> 6d4e9a8efe3d (driver core: lift dma_default_coherent into common code)
  
- #include <asm/dma-coherence.h>
  #include <asm/mipsregs.h>
  
  #include <au1000.h>
diff --cc arch/mips/kernel/setup.c
index 1c6765a9a570,f0f533294311..000000000000
--- a/arch/mips/kernel/setup.c
+++ b/arch/mips/kernel/setup.c
@@@ -1054,3 -800,21 +1054,24 @@@ static int __init debugfs_mips(void
  }
  arch_initcall(debugfs_mips);
  #endif
++<<<<<<< HEAD
++=======
+ 
+ #ifdef CONFIG_DMA_MAYBE_COHERENT
+ static int __init setcoherentio(char *str)
+ {
+ 	dma_default_coherent = true;
+ 	pr_info("Hardware DMA cache coherency (command line)\n");
+ 	return 0;
+ }
+ early_param("coherentio", setcoherentio);
+ 
+ static int __init setnocoherentio(char *str)
+ {
+ 	dma_default_coherent = true;
+ 	pr_info("Software DMA cache coherency (command line)\n");
+ 	return 0;
+ }
+ early_param("nocoherentio", setnocoherentio);
+ #endif
++>>>>>>> 6d4e9a8efe3d (driver core: lift dma_default_coherent into common code)
* Unmerged path arch/mips/include/asm/dma-coherence.h
* Unmerged path arch/mips/mm/dma-noncoherent.c
* Unmerged path include/linux/dma-map-ops.h
* Unmerged path arch/mips/alchemy/common/setup.c
* Unmerged path arch/mips/include/asm/dma-coherence.h
* Unmerged path arch/mips/kernel/setup.c
diff --git a/arch/mips/mm/c-r4k.c b/arch/mips/mm/c-r4k.c
index e12dfa48b478..c7b56f13b8dc 100644
--- a/arch/mips/mm/c-r4k.c
+++ b/arch/mips/mm/c-r4k.c
@@ -19,6 +19,7 @@
 #include <linux/mm.h>
 #include <linux/export.h>
 #include <linux/bitops.h>
+#include <linux/dma-map-ops.h> /* for dma_default_coherent */
 
 #include <asm/bcache.h>
 #include <asm/bootinfo.h>
@@ -36,7 +37,6 @@
 #include <asm/war.h>
 #include <asm/cacheflush.h> /* for run_uncached() */
 #include <asm/traps.h>
-#include <asm/dma-coherence.h>
 #include <asm/mips-cps.h>
 
 /*
* Unmerged path arch/mips/mm/dma-noncoherent.c
diff --git a/arch/mips/mti-malta/malta-setup.c b/arch/mips/mti-malta/malta-setup.c
index 7b63914d2e58..38e4aa46237f 100644
--- a/arch/mips/mti-malta/malta-setup.c
+++ b/arch/mips/mti-malta/malta-setup.c
@@ -25,6 +25,7 @@
 #include <linux/pci.h>
 #include <linux/screen_info.h>
 #include <linux/time.h>
+#include <linux/dma-map-ops.h> /* for dma_default_coherent */
 
 #include <asm/fw/fw.h>
 #include <asm/mach-malta/malta-dtshim.h>
diff --git a/arch/mips/pci/pci-alchemy.c b/arch/mips/pci/pci-alchemy.c
index 4f2411f489af..f97971bfdc46 100644
--- a/arch/mips/pci/pci-alchemy.c
+++ b/arch/mips/pci/pci-alchemy.c
@@ -17,8 +17,8 @@
 #include <linux/init.h>
 #include <linux/syscore_ops.h>
 #include <linux/vmalloc.h>
+#include <linux/dma-map-ops.h> /* for dma_default_coherent */
 
-#include <asm/dma-coherence.h>
 #include <asm/mach-au1x00/au1000.h>
 #include <asm/tlbmisc.h>
 
diff --git a/arch/mips/pistachio/init.c b/arch/mips/pistachio/init.c
index 0b06c953d293..3f4cb01bc225 100644
--- a/arch/mips/pistachio/init.c
+++ b/arch/mips/pistachio/init.c
@@ -16,7 +16,6 @@
 #include <linux/of_fdt.h>
 
 #include <asm/cacheflush.h>
-#include <asm/dma-coherence.h>
 #include <asm/fw/fw.h>
 #include <asm/mips-boards/generic.h>
 #include <asm/mips-cps.h>
diff --git a/drivers/base/core.c b/drivers/base/core.c
index 88a9aafab2f4..339d9b32bc30 100644
--- a/drivers/base/core.c
+++ b/drivers/base/core.c
@@ -27,6 +27,7 @@
 #include <linux/netdevice.h>
 #include <linux/sched/signal.h>
 #include <linux/sysfs.h>
+#include <linux/dma-map-ops.h> /* for dma_default_coherent */
 
 #include "base.h"
 #include "power/power.h"
@@ -2581,6 +2582,11 @@ void device_initialize(struct device *dev)
 	INIT_LIST_HEAD(&dev->links.suppliers);
 	INIT_LIST_HEAD(&dev->links_defer_sync);
 	dev->links.status = DL_DEV_NO_DRIVER;
+#if defined(CONFIG_ARCH_HAS_SYNC_DMA_FOR_DEVICE) || \
+    defined(CONFIG_ARCH_HAS_SYNC_DMA_FOR_CPU) || \
+    defined(CONFIG_ARCH_HAS_SYNC_DMA_FOR_CPU_ALL)
+	dev->dma_coherent = dma_default_coherent;
+#endif
 }
 EXPORT_SYMBOL_GPL(device_initialize);
 
* Unmerged path include/linux/dma-map-ops.h
diff --git a/kernel/dma/Kconfig b/kernel/dma/Kconfig
index 35c60ac3ee93..7cd8c640d655 100644
--- a/kernel/dma/Kconfig
+++ b/kernel/dma/Kconfig
@@ -24,9 +24,6 @@ config NEED_DMA_MAP_STATE
 config ARCH_DMA_ADDR_T_64BIT
 	def_bool 64BIT || PHYS_ADDR_T_64BIT
 
-config ARCH_HAS_DMA_COHERENCE_H
-	bool
-
 config ARCH_HAS_DMA_SET_MASK
 	bool
 
diff --git a/kernel/dma/mapping.c b/kernel/dma/mapping.c
index b152e4e4a653..9a5b68eacde4 100644
--- a/kernel/dma/mapping.c
+++ b/kernel/dma/mapping.c
@@ -26,6 +26,8 @@
 #include RH_KABI_FAKE_INCLUDE(<asm/iommu.h>)
 #endif
 
+bool dma_default_coherent;
+
 /*
  * Managed DMA API
  */
