fs: Add missing umask strip in vfs_tmpfile

jira LE-1907
cve CVE-2021-4037
cve CVE-2018-13405
Rebuild_History Non-Buildable kernel-3.10.0-1160.88.1.el7
commit-author Yang Xu <xuyang2018.jy@fujitsu.com>
commit ac6800e279a22b28f4fc21439843025a0d5bf03e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1160.88.1.el7/ac6800e2.failed

All creation paths except for O_TMPFILE handle umask in the vfs directly
if the filesystem doesn't support or enable POSIX ACLs. If the filesystem
does then umask handling is deferred until posix_acl_create().
Because, O_TMPFILE misses umask handling in the vfs it will not honor
umask settings. Fix this by adding the missing umask handling.

Link: https://lore.kernel.org/r/1657779088-2242-2-git-send-email-xuyang2018.jy@fujitsu.com
Fixes: 60545d0d4610 ("[O_TMPFILE] it's still short a few helpers, but infrastructure should be OK now...")
	Cc: <stable@vger.kernel.org> # 4.19+
	Reported-by: Christian Brauner (Microsoft) <brauner@kernel.org>
	Reviewed-by: Darrick J. Wong <djwong@kernel.org>
Reviewed-and-Tested-by: Jeff Layton <jlayton@kernel.org>
	Acked-by: Christian Brauner (Microsoft) <brauner@kernel.org>
	Signed-off-by: Yang Xu <xuyang2018.jy@fujitsu.com>
	Signed-off-by: Christian Brauner (Microsoft) <brauner@kernel.org>
(cherry picked from commit ac6800e279a22b28f4fc21439843025a0d5bf03e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/namei.c
diff --cc fs/namei.c
index bf1b5e732252,ac4225ad6ac4..000000000000
--- a/fs/namei.c
+++ b/fs/namei.c
@@@ -3321,14 -3559,15 +3321,20 @@@ struct dentry *vfs_tmpfile(struct dentr
  	if (error)
  		goto out_err;
  	error = -EOPNOTSUPP;
 -	if (!dir->i_op->tmpfile)
 +	tmpfile = get_tmpfile_iop(dir);
 +	if (!tmpfile)
  		goto out_err;
  	error = -ENOMEM;
 -	child = d_alloc(dentry, &slash_name);
 +	child = d_alloc(dentry, &name);
  	if (unlikely(!child))
  		goto out_err;
++<<<<<<< HEAD
 +	error = tmpfile(dir, child, mode);
++=======
+ 	if (!IS_POSIXACL(dir))
+ 		mode &= ~current_umask();
+ 	error = dir->i_op->tmpfile(mnt_userns, dir, child, mode);
++>>>>>>> ac6800e279a2 (fs: Add missing umask strip in vfs_tmpfile)
  	if (error)
  		goto out_err;
  	error = -ENOENT;
* Unmerged path fs/namei.c
