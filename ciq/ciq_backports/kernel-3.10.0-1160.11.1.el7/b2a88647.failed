xfs: fix inode allocation block res calculation precedence

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1160.11.1.el7
commit-author Brian Foster <bfoster@redhat.com>
commit b2a8864728683443f34a9fd33a2b78b860934cc1
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1160.11.1.el7/b2a88647.failed

The block reservation calculation for inode allocation is supposed
to consist of the blocks required for the inode chunk plus
(maxlevels-1) of the inode btree multiplied by the number of inode
btrees in the fs (2 when finobt is enabled, 1 otherwise).

Instead, the macro returns (ialloc_blocks + 2) due to a precedence
error in the calculation logic. This leads to block reservation
overruns via generic/531 on small block filesystems with finobt
enabled. Add braces to fix the calculation and reserve the
appropriate number of blocks.

Fixes: 9d43b180af67 ("xfs: update inode allocation/free transaction reservations for finobt")
	Signed-off-by: Brian Foster <bfoster@redhat.com>
	Reviewed-by: Darrick J. Wong <darrick.wong@oracle.com>
	Signed-off-by: Darrick J. Wong <darrick.wong@oracle.com>
	Reviewed-by: Christoph Hellwig <hch@lst.de>
(cherry picked from commit b2a8864728683443f34a9fd33a2b78b860934cc1)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/xfs/libxfs/xfs_trans_space.h
diff --cc fs/xfs/libxfs/xfs_trans_space.h
index 41e0428d8175,c6df01a2a158..000000000000
--- a/fs/xfs/libxfs/xfs_trans_space.h
+++ b/fs/xfs/libxfs/xfs_trans_space.h
@@@ -48,9 -56,9 +48,15 @@@
  #define	XFS_DIRREMOVE_SPACE_RES(mp)	\
  	XFS_DAREMOVE_SPACE_RES(mp, XFS_DATA_FORK)
  #define	XFS_IALLOC_SPACE_RES(mp)	\
++<<<<<<< HEAD
 +	((mp)->m_ialloc_blks + \
 +	 (xfs_sb_version_hasfinobt(&mp->m_sb) ? 2 : 1 * \
 +	  ((mp)->m_in_maxlevels - 1)))
++=======
+ 	(M_IGEO(mp)->ialloc_blks + \
+ 	 ((xfs_sb_version_hasfinobt(&mp->m_sb) ? 2 : 1) * \
+ 	  (M_IGEO(mp)->inobt_maxlevels - 1)))
++>>>>>>> b2a886472868 (xfs: fix inode allocation block res calculation precedence)
  
  /*
   * Space reservation values for various transactions.
* Unmerged path fs/xfs/libxfs/xfs_trans_space.h
