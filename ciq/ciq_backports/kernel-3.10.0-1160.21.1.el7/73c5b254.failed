HID: microsoft: Add rumble support for Xbox One S controller

jira LE-1907
cve CVE-2019-19532
Rebuild_History Non-Buildable kernel-3.10.0-1160.21.1.el7
Rebuild_CHGLOG: - [hid] microsoft: Add rumble support for Xbox One S controller (Chris von Recklinghausen) [1821870] {CVE-2019-19532}
Rebuild_FUZZ: 95.65%
commit-author Andrey Smirnov <andrew.smirnov@gmail.com>
commit 73c5b254c36529c84c9d19e07905f7103bb32e79
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1160.21.1.el7/73c5b254.failed

Add HID quirk driver for Xbox One S controller over bluetooth.

This driver only adds support for rumble. Standard controller
functionality is exposed by default HID driver.

[jkosina@suse.cz: straightforward rebase on more recent driver code]
	Cc: Dmitry Torokhov <dmitry.torokhov@gmail.com>
	Cc: Jiri Kosina <jikos@kernel.org>
	Cc: Benjamin Tissoires <benjamin.tissoires@redhat.com>
	Cc: linux-input@vger.kernel.org
	Cc: linux-kernel@vger.kernel.org
	Cc: Pierre-Loup A. Griffais <pgriffais@valvesoftware.com>
	Signed-off-by: Juha Kuikka <juha.kuikka@gmail.com>
	Signed-off-by: Andrey Smirnov <andrew.smirnov@gmail.com>
	Signed-off-by: Jiri Kosina <jkosina@suse.cz>
(cherry picked from commit 73c5b254c36529c84c9d19e07905f7103bb32e79)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/hid/hid-ids.h
#	drivers/hid/hid-microsoft.c
diff --cc drivers/hid/hid-ids.h
index 1db2cfa58713,a523d54c4f75..000000000000
--- a/drivers/hid/hid-ids.h
+++ b/drivers/hid/hid-ids.h
@@@ -638,7 -792,15 +638,16 @@@
  #define USB_DEVICE_ID_MS_PRESENTER_8K_USB	0x0713
  #define USB_DEVICE_ID_MS_NE7K		0x071d
  #define USB_DEVICE_ID_MS_DIGITAL_MEDIA_3K	0x0730
 -#define USB_DEVICE_ID_MS_DIGITAL_MEDIA_3KV1 0x0732
 -#define USB_DEVICE_ID_MS_DIGITAL_MEDIA_600  0x0750
  #define USB_DEVICE_ID_MS_COMFORT_MOUSE_4500	0x076c
++<<<<<<< HEAD
++=======
+ #define USB_DEVICE_ID_MS_COMFORT_KEYBOARD 0x00e3
+ #define USB_DEVICE_ID_MS_SURFACE_PRO_2   0x0799
+ #define USB_DEVICE_ID_MS_TOUCH_COVER_2   0x07a7
+ #define USB_DEVICE_ID_MS_TYPE_COVER_2    0x07a9
+ #define USB_DEVICE_ID_MS_POWER_COVER     0x07da
+ #define USB_DEVICE_ID_MS_XBOX_ONE_S_CONTROLLER	0x02fd
++>>>>>>> 73c5b254c365 (HID: microsoft: Add rumble support for Xbox One S controller)
  
  #define USB_VENDOR_ID_MOJO		0x8282
  #define USB_DEVICE_ID_RETRO_ADAPTER	0x3201
diff --cc drivers/hid/hid-microsoft.c
index 52cd311293fe,330cb073cb66..000000000000
--- a/drivers/hid/hid-microsoft.c
+++ b/drivers/hid/hid-microsoft.c
@@@ -22,13 -22,42 +22,52 @@@
  
  #include "hid-ids.h"
  
++<<<<<<< HEAD
 +#define MS_HIDINPUT		0x01
 +#define MS_ERGONOMY		0x02
 +#define MS_PRESENTER		0x04
 +#define MS_RDESC		0x08
 +#define MS_NOGET		0x10
 +#define MS_DUPLICATE_USAGES	0x20
 +#define MS_RDESC_3K		0x40
++=======
+ #define MS_HIDINPUT		BIT(0)
+ #define MS_ERGONOMY		BIT(1)
+ #define MS_PRESENTER		BIT(2)
+ #define MS_RDESC		BIT(3)
+ #define MS_NOGET		BIT(4)
+ #define MS_DUPLICATE_USAGES	BIT(5)
+ #define MS_SURFACE_DIAL		BIT(6)
+ #define MS_QUIRK_FF		BIT(7)
+ 
+ struct ms_data {
+ 	unsigned long quirks;
+ 	struct hid_device *hdev;
+ 	struct work_struct ff_worker;
+ 	__u8 strong;
+ 	__u8 weak;
+ 	void *output_report_dmabuf;
+ };
++>>>>>>> 73c5b254c365 (HID: microsoft: Add rumble support for Xbox One S controller)
+ 
+ #define XB1S_FF_REPORT		3
+ #define ENABLE_WEAK		BIT(0)
+ #define ENABLE_STRONG		BIT(1)
+ 
+ enum {
+ 	MAGNITUDE_STRONG = 2,
+ 	MAGNITUDE_WEAK,
+ 	MAGNITUDE_NUM
+ };
+ 
+ struct xb1s_ff_report {
+ 	__u8	report_id;
+ 	__u8	enable;
+ 	__u8	magnitude[MAGNITUDE_NUM];
+ 	__u8	duration_10ms;
+ 	__u8	start_delay_10ms;
+ 	__u8	loop_count;
+ } __packed;
  
  static __u8 *ms_report_fixup(struct hid_device *hdev, __u8 *rdesc,
  		unsigned int *rsize)
@@@ -215,6 -440,14 +342,13 @@@ static const struct hid_device_id ms_de
  
  	{ HID_BLUETOOTH_DEVICE(USB_VENDOR_ID_MICROSOFT, USB_DEVICE_ID_MS_PRESENTER_8K_BT),
  		.driver_data = MS_PRESENTER },
++<<<<<<< HEAD
++=======
+ 	{ HID_BLUETOOTH_DEVICE(USB_VENDOR_ID_MICROSOFT, 0x091B),
+ 		.driver_data = MS_SURFACE_DIAL },
+ 	{ HID_BLUETOOTH_DEVICE(USB_VENDOR_ID_MICROSOFT, USB_DEVICE_ID_MS_XBOX_ONE_S_CONTROLLER),
+ 		.driver_data = MS_QUIRK_FF },
++>>>>>>> 73c5b254c365 (HID: microsoft: Add rumble support for Xbox One S controller)
  	{ }
  };
  MODULE_DEVICE_TABLE(hid, ms_devices);
* Unmerged path drivers/hid/hid-ids.h
* Unmerged path drivers/hid/hid-microsoft.c
