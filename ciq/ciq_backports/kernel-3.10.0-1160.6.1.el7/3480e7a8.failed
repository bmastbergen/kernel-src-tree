scsi: qedf: Fix race betwen fipvlan request and response path

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1160.6.1.el7
commit-author Saurav Kashyap <skashyap@marvell.com>
commit 3480e7a8c8e47a6ee101ab722c58d61761b67e4a
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1160.6.1.el7/3480e7a8.failed

There is a race b/w fipvlan request and response path:

=====
qedf_fcoe_process_vlan_resp:113]:2: VLAN response, vid=0xffd.
qedf_initiate_fipvlan_req:165]:2: vlan = 0x6ffd already set.
qedf_set_vlan_id:139]:2: Setting vlan_id=0ffd prio=3.
======

The request thread sees that vlan is already set and fails to call
ctrl_link_up.

Fix:

 - While setting vlan_id use local variable and before setting vlan_id.

 - Call fcoe_ctlr_link_up in next iteration of fipvlan request.

	Signed-off-by: Saurav Kashyap <skashyap@marvell.com>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit 3480e7a8c8e47a6ee101ab722c58d61761b67e4a)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/qedf/qedf_main.c
diff --cc drivers/scsi/qedf/qedf_main.c
index 94e5701842cd,9c24f3834d70..000000000000
--- a/drivers/scsi/qedf/qedf_main.c
+++ b/drivers/scsi/qedf/qedf_main.c
@@@ -131,8 -131,19 +133,22 @@@ static bool qedf_initiate_fipvlan_req(s
  			return false;
  		}
  
++<<<<<<< HEAD
 +		if (qedf->vlan_id > 0)
++=======
+ 		if (test_bit(QEDF_UNLOADING, &qedf->flags)) {
+ 			QEDF_ERR(&qedf->dbg_ctx, "Driver unloading.\n");
+ 			return false;
+ 		}
+ 
+ 		if (qedf->vlan_id > 0) {
+ 			QEDF_INFO(&qedf->dbg_ctx, QEDF_LOG_DISC,
+ 				  "vlan = 0x%x already set, calling ctlr_link_up.\n",
+ 				  qedf->vlan_id);
+ 			if (atomic_read(&qedf->link_state) == QEDF_LINK_UP)
+ 				fcoe_ctlr_link_up(&qedf->ctlr);
++>>>>>>> 3480e7a8c8e4 (scsi: qedf: Fix race betwen fipvlan request and response path)
  			return true;
 -		}
  
  		QEDF_INFO(&(qedf->dbg_ctx), QEDF_LOG_DISC,
  			   "Retry %d.\n", qedf->fipvlan_retries);
* Unmerged path drivers/scsi/qedf/qedf_main.c
