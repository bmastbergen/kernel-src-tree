net-sysfs: Call dev_hold always in netdev_queue_add_kobject

jira LE-1907
cve CVE-2019-20811
Rebuild_History Non-Buildable kernel-3.10.0-1160.6.1.el7
commit-author Jouni Hogander <jouni.hogander@unikie.com>
commit e0b60903b434a7ee21ba8d8659f207ed84101e89
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1160.6.1.el7/e0b60903.failed

Dev_hold has to be called always in netdev_queue_add_kobject.
Otherwise usage count drops below 0 in case of failure in
kobject_init_and_add.

Fixes: b8eb718348b8 ("net-sysfs: Fix reference count leak in rx|netdev_queue_add_kobject")
	Reported-by: Hulk Robot <hulkci@huawei.com>
	Cc: Tetsuo Handa <penguin-kernel@I-love.SAKURA.ne.jp>
	Cc: David Miller <davem@davemloft.net>
	Cc: Lukas Bulwahn <lukas.bulwahn@gmail.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit e0b60903b434a7ee21ba8d8659f207ed84101e89)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/core/net-sysfs.c
diff --cc net/core/net-sysfs.c
index 3885622ac43a,5c4624298996..000000000000
--- a/net/core/net-sysfs.c
+++ b/net/core/net-sysfs.c
@@@ -1292,11 -1459,16 +1292,24 @@@ static int netdev_queue_add_kobject(str
  	struct kobject *kobj = &queue->kobj;
  	int error = 0;
  
++<<<<<<< HEAD
 +	kobj->kset = net->queues_kset;
++=======
+ 	/* Kobject_put later will trigger netdev_queue_release call
+ 	 * which decreases dev refcount: Take that reference here
+ 	 */
+ 	dev_hold(queue->dev);
+ 
+ 	kobj->kset = dev->queues_kset;
++>>>>>>> e0b60903b434 (net-sysfs: Call dev_hold always in netdev_queue_add_kobject)
  	error = kobject_init_and_add(kobj, &netdev_queue_ktype, NULL,
 -				     "tx-%u", index);
 +	    "tx-%u", index);
  	if (error)
++<<<<<<< HEAD
 +		goto exit;
++=======
+ 		goto err;
++>>>>>>> e0b60903b434 (net-sysfs: Call dev_hold always in netdev_queue_add_kobject)
  
  #ifdef CONFIG_BQL
  	error = sysfs_create_group(kobj, &dql_group);
* Unmerged path net/core/net-sysfs.c
