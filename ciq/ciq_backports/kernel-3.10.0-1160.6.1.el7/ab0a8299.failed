scsi: qedf: Keep track of num of pending flogi

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1160.6.1.el7
commit-author Saurav Kashyap <skashyap@marvell.com>
commit ab0a82991fcaae0b0d895c0aea36e91730c2d00a
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1160.6.1.el7/ab0a8299.failed

If a port is brought down for an extended period of time, the fipvlan
counter gets exhausted and the driver will fall back to default VLAN 1002
and call fcoe_ctlr_link_up to log in. However, the switch will discard the
FLOGI attempt because the VLAN is now different.

Keep track of the number of FLOGI attempts and if a threshold of
QEDF_FLOGI_RETRY_CNT is exceeded, perform a context soft reset.

Link: https://lore.kernel.org/r/20200416084314.18851-2-skashyap@marvell.com
	Signed-off-by: Saurav Kashyap <skashyap@marvell.com>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit ab0a82991fcaae0b0d895c0aea36e91730c2d00a)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/qedf/qedf_main.c
diff --cc drivers/scsi/qedf/qedf_main.c
index 94e5701842cd,89d5c12bf49c..000000000000
--- a/drivers/scsi/qedf/qedf_main.c
+++ b/drivers/scsi/qedf/qedf_main.c
@@@ -3716,6 -3771,25 +3725,28 @@@ void qedf_get_protocol_tlv_data(void *d
  	fcoe->scsi_tsk_full = qedf->task_set_fulls;
  }
  
++<<<<<<< HEAD
++=======
+ /* Deferred work function to perform soft context reset on STAG change */
+ void qedf_stag_change_work(struct work_struct *work)
+ {
+ 	struct qedf_ctx *qedf =
+ 	    container_of(work, struct qedf_ctx, stag_work.work);
+ 
+ 	if (!qedf) {
+ 		QEDF_ERR(&qedf->dbg_ctx, "qedf is NULL");
+ 		return;
+ 	}
+ 	QEDF_ERR(&qedf->dbg_ctx, "Performing software context reset.\n");
+ 	qedf_ctx_soft_reset(qedf->lport);
+ }
+ 
+ static void qedf_shutdown(struct pci_dev *pdev)
+ {
+ 	__qedf_remove(pdev, QEDF_MODE_NORMAL);
+ }
+ 
++>>>>>>> ab0a82991fca (scsi: qedf: Keep track of num of pending flogi)
  /* Generic TLV data callback */
  void qedf_get_generic_tlv_data(void *dev, struct qed_generic_tlvs *data)
  {
diff --git a/drivers/scsi/qedf/qedf.h b/drivers/scsi/qedf/qedf.h
index 721cdf3757bd..cbb63e3bfe02 100644
--- a/drivers/scsi/qedf/qedf.h
+++ b/drivers/scsi/qedf/qedf.h
@@ -391,6 +391,7 @@ struct qedf_ctx {
 	mempool_t *io_mempool;
 	struct workqueue_struct *dpc_wq;
 	struct delayed_work grcdump_work;
+	struct delayed_work stag_work;
 
 	u32 slow_sge_ios;
 	u32 fast_sge_ios;
@@ -406,6 +407,7 @@ struct qedf_ctx {
 
 	u32 flogi_cnt;
 	u32 flogi_failed;
+	u32 flogi_pending;
 
 	/* Used for fc statistics */
 	struct mutex stats_mutex;
* Unmerged path drivers/scsi/qedf/qedf_main.c
