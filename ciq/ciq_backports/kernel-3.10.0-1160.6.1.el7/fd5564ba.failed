scsi: qla2xxx: Fix stale mem access on driver unload

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1160.6.1.el7
commit-author Quinn Tran <qutran@marvell.com>
commit fd5564ba54e0d8a9e3e823d311b764232e09eb5f
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1160.6.1.el7/fd5564ba.failed

On driver unload, 'remove_one' thread was allowed to advance, while session
cleanup still lag behind.  This patch ensures session deletion will finish
before remove_one can advance.

Link: https://lore.kernel.org/r/20190912180918.6436-4-hmadhani@marvell.com
	Signed-off-by: Quinn Tran <qutran@marvell.com>
	Signed-off-by: Himanshu Madhani <hmadhani@marvell.com>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit fd5564ba54e0d8a9e3e823d311b764232e09eb5f)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/qla2xxx/qla_target.c
diff --cc drivers/scsi/qla2xxx/qla_target.c
index c9b56dcf8807,b5315be00b4d..000000000000
--- a/drivers/scsi/qla2xxx/qla_target.c
+++ b/drivers/scsi/qla2xxx/qla_target.c
@@@ -1119,8 -1105,9 +1119,9 @@@ void qlt_free_session_done(struct work_
  	}
  
  	spin_unlock_irqrestore(&ha->tgt.sess_lock, flags);
+ 	sess->free_pending = 0;
  
 -	ql_dbg(ql_dbg_tgt_mgt, vha, 0xf001,
 +	ql_dbg(ql_dbg_disc, vha, 0xf001,
  	    "Unregistration of sess %p %8phC finished fcp_cnt %d\n",
  		sess, sess->port_name, vha->fcport_count);
  
@@@ -1183,7 -1159,8 +1178,12 @@@ void qlt_unreg_sess(struct fc_port *ses
  	sess->last_rscn_gen = sess->rscn_gen;
  	sess->last_login_gen = sess->login_gen;
  
++<<<<<<< HEAD
 +	schedule_work(&sess->free_work);
++=======
+ 	INIT_WORK(&sess->free_work, qlt_free_session_done);
+ 	queue_work(sess->vha->hw->wq, &sess->free_work);
++>>>>>>> fd5564ba54e0 (scsi: qla2xxx: Fix stale mem access on driver unload)
  }
  EXPORT_SYMBOL(qlt_unreg_sess);
  
diff --git a/drivers/scsi/qla2xxx/qla_os.c b/drivers/scsi/qla2xxx/qla_os.c
index ede7a60e25df..7ebbcd0f51f2 100644
--- a/drivers/scsi/qla2xxx/qla_os.c
+++ b/drivers/scsi/qla2xxx/qla_os.c
@@ -1138,6 +1138,7 @@ qla2x00_wait_for_sess_deletion(scsi_qla_host_t *vha)
 	qla2x00_mark_all_devices_lost(vha);
 
 	wait_event_timeout(vha->fcport_waitQ, test_fcport_count(vha), 10*HZ);
+	flush_workqueue(vha->hw->wq);
 }
 
 /*
* Unmerged path drivers/scsi/qla2xxx/qla_target.c
