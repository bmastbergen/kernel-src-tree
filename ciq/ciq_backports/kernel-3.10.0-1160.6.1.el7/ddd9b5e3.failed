net-sysfs: Call dev_hold always in rx_queue_add_kobject

jira LE-1907
cve CVE-2019-20811
Rebuild_History Non-Buildable kernel-3.10.0-1160.6.1.el7
commit-author Jouni Hogander <jouni.hogander@unikie.com>
commit ddd9b5e3e765d8ed5a35786a6cb00111713fe161
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1160.6.1.el7/ddd9b5e3.failed

Dev_hold has to be called always in rx_queue_add_kobject.
Otherwise usage count drops below 0 in case of failure in
kobject_init_and_add.

Fixes: b8eb718348b8 ("net-sysfs: Fix reference count leak in rx|netdev_queue_add_kobject")
	Reported-by: syzbot <syzbot+30209ea299c09d8785c9@syzkaller.appspotmail.com>
	Cc: Tetsuo Handa <penguin-kernel@I-love.SAKURA.ne.jp>
	Cc: David Miller <davem@davemloft.net>
	Cc: Lukas Bulwahn <lukas.bulwahn@gmail.com>
	Signed-off-by: Jouni Hogander <jouni.hogander@unikie.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit ddd9b5e3e765d8ed5a35786a6cb00111713fe161)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/core/net-sysfs.c
diff --cc net/core/net-sysfs.c
index 3885622ac43a,4c826b8bf9b1..000000000000
--- a/net/core/net-sysfs.c
+++ b/net/core/net-sysfs.c
@@@ -888,12 -919,21 +888,30 @@@ static int rx_queue_add_kobject(struct 
  	struct kobject *kobj = &queue->kobj;
  	int error = 0;
  
++<<<<<<< HEAD
 +	kobj->kset = net->queues_kset;
 +	error = kobject_init_and_add(kobj, &rx_queue_ktype, NULL,
 +	    "rx-%u", index);
 +	if (error) {
 +		kobject_put(kobj);
 +		return error;
++=======
+ 	/* Kobject_put later will trigger rx_queue_release call which
+ 	 * decreases dev refcount: Take that reference here
+ 	 */
+ 	dev_hold(queue->dev);
+ 
+ 	kobj->kset = dev->queues_kset;
+ 	error = kobject_init_and_add(kobj, &rx_queue_ktype, NULL,
+ 				     "rx-%u", index);
+ 	if (error)
+ 		goto err;
+ 
+ 	if (dev->sysfs_rx_queue_group) {
+ 		error = sysfs_create_group(kobj, dev->sysfs_rx_queue_group);
+ 		if (error)
+ 			goto err;
++>>>>>>> ddd9b5e3e765 (net-sysfs: Call dev_hold always in rx_queue_add_kobject)
  	}
  
  	kobject_uevent(kobj, KOBJ_ADD);
* Unmerged path net/core/net-sysfs.c
