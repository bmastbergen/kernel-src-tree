mlxsw: spectrum: Register for IPIP_DECAP_ERROR trap

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Petr Machata <petrm@mellanox.com>
commit 86484de2c917b6ba5965ef2248d9966424932af4
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/86484de2.failed

These traps are generated for packets that fail checks for source IP,
encapsulation type, or GRE key. Trap these packets to CPU for follow-up
handling by the kernel, which will send ICMP destination unreachable
responses.

	Signed-off-by: Petr Machata <petrm@mellanox.com>
	Reviewed-by: Ido Schimmel <idosch@mellanox.com>
	Signed-off-by: Jiri Pirko <jiri@mellanox.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 86484de2c917b6ba5965ef2248d9966424932af4)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlxsw/spectrum.c
#	drivers/net/ethernet/mellanox/mlxsw/trap.h
diff --cc drivers/net/ethernet/mellanox/mlxsw/spectrum.c
index 3aac4cc5ecc4,ed7cd6c48019..000000000000
--- a/drivers/net/ethernet/mellanox/mlxsw/spectrum.c
+++ b/drivers/net/ethernet/mellanox/mlxsw/spectrum.c
@@@ -3365,15 -3358,54 +3365,56 @@@ static const struct mlxsw_listener mlxs
  	MLXSW_SP_RXL_NO_MARK(IGMP_V3_REPORT, TRAP_TO_CPU, IGMP, false),
  	MLXSW_SP_RXL_MARK(ARPBC, MIRROR_TO_CPU, ARP, false),
  	MLXSW_SP_RXL_MARK(ARPUC, MIRROR_TO_CPU, ARP, false),
 -	MLXSW_SP_RXL_NO_MARK(FID_MISS, TRAP_TO_CPU, IP2ME, false),
 -	MLXSW_SP_RXL_MARK(IPV6_MLDV12_LISTENER_QUERY, MIRROR_TO_CPU, IPV6_MLD,
 -			  false),
 -	MLXSW_SP_RXL_NO_MARK(IPV6_MLDV1_LISTENER_REPORT, TRAP_TO_CPU, IPV6_MLD,
 -			     false),
 -	MLXSW_SP_RXL_NO_MARK(IPV6_MLDV1_LISTENER_DONE, TRAP_TO_CPU, IPV6_MLD,
 -			     false),
 -	MLXSW_SP_RXL_NO_MARK(IPV6_MLDV2_LISTENER_REPORT, TRAP_TO_CPU, IPV6_MLD,
 -			     false),
  	/* L3 traps */
++<<<<<<< HEAD
 +	MLXSW_SP_RXL_NO_MARK(MTUERROR, TRAP_TO_CPU, ROUTER_EXP, false),
 +	MLXSW_SP_RXL_NO_MARK(TTLERROR, TRAP_TO_CPU, ROUTER_EXP, false),
 +	MLXSW_SP_RXL_NO_MARK(LBERROR, TRAP_TO_CPU, ROUTER_EXP, false),
 +	MLXSW_SP_RXL_MARK(OSPF, TRAP_TO_CPU, OSPF, false),
 +	MLXSW_SP_RXL_NO_MARK(IP2ME, TRAP_TO_CPU, IP2ME, false),
 +	MLXSW_SP_RXL_NO_MARK(RTR_INGRESS0, TRAP_TO_CPU, REMOTE_ROUTE, false),
 +	MLXSW_SP_RXL_NO_MARK(HOST_MISS_IPV4, TRAP_TO_CPU, ARP_MISS, false),
 +	MLXSW_SP_RXL_NO_MARK(BGP_IPV4, TRAP_TO_CPU, BGP_IPV4, false),
++=======
+ 	MLXSW_SP_RXL_MARK(MTUERROR, TRAP_TO_CPU, ROUTER_EXP, false),
+ 	MLXSW_SP_RXL_MARK(TTLERROR, TRAP_TO_CPU, ROUTER_EXP, false),
+ 	MLXSW_SP_RXL_MARK(LBERROR, TRAP_TO_CPU, ROUTER_EXP, false),
+ 	MLXSW_SP_RXL_MARK(IP2ME, TRAP_TO_CPU, IP2ME, false),
+ 	MLXSW_SP_RXL_MARK(IPV6_UNSPECIFIED_ADDRESS, TRAP_TO_CPU, ROUTER_EXP,
+ 			  false),
+ 	MLXSW_SP_RXL_MARK(IPV6_LINK_LOCAL_DEST, TRAP_TO_CPU, ROUTER_EXP, false),
+ 	MLXSW_SP_RXL_MARK(IPV6_LINK_LOCAL_SRC, TRAP_TO_CPU, ROUTER_EXP, false),
+ 	MLXSW_SP_RXL_MARK(IPV6_ALL_NODES_LINK, TRAP_TO_CPU, ROUTER_EXP, false),
+ 	MLXSW_SP_RXL_MARK(IPV6_ALL_ROUTERS_LINK, TRAP_TO_CPU, ROUTER_EXP,
+ 			  false),
+ 	MLXSW_SP_RXL_MARK(IPV4_OSPF, TRAP_TO_CPU, OSPF, false),
+ 	MLXSW_SP_RXL_MARK(IPV6_OSPF, TRAP_TO_CPU, OSPF, false),
+ 	MLXSW_SP_RXL_MARK(IPV6_DHCP, TRAP_TO_CPU, DHCP, false),
+ 	MLXSW_SP_RXL_MARK(RTR_INGRESS0, TRAP_TO_CPU, REMOTE_ROUTE, false),
+ 	MLXSW_SP_RXL_MARK(IPV4_BGP, TRAP_TO_CPU, BGP, false),
+ 	MLXSW_SP_RXL_MARK(IPV6_BGP, TRAP_TO_CPU, BGP, false),
+ 	MLXSW_SP_RXL_MARK(L3_IPV6_ROUTER_SOLICITATION, TRAP_TO_CPU, IPV6_ND,
+ 			  false),
+ 	MLXSW_SP_RXL_MARK(L3_IPV6_ROUTER_ADVERTISMENT, TRAP_TO_CPU, IPV6_ND,
+ 			  false),
+ 	MLXSW_SP_RXL_MARK(L3_IPV6_NEIGHBOR_SOLICITATION, TRAP_TO_CPU, IPV6_ND,
+ 			  false),
+ 	MLXSW_SP_RXL_MARK(L3_IPV6_NEIGHBOR_ADVERTISMENT, TRAP_TO_CPU, IPV6_ND,
+ 			  false),
+ 	MLXSW_SP_RXL_MARK(L3_IPV6_REDIRECTION, TRAP_TO_CPU, IPV6_ND, false),
+ 	MLXSW_SP_RXL_MARK(IPV6_MC_LINK_LOCAL_DEST, TRAP_TO_CPU, ROUTER_EXP,
+ 			  false),
+ 	MLXSW_SP_RXL_MARK(HOST_MISS_IPV4, TRAP_TO_CPU, HOST_MISS, false),
+ 	MLXSW_SP_RXL_MARK(HOST_MISS_IPV6, TRAP_TO_CPU, HOST_MISS, false),
+ 	MLXSW_SP_RXL_MARK(ROUTER_ALERT_IPV4, TRAP_TO_CPU, ROUTER_EXP, false),
+ 	MLXSW_SP_RXL_MARK(ROUTER_ALERT_IPV6, TRAP_TO_CPU, ROUTER_EXP, false),
+ 	MLXSW_SP_RXL_MARK(IPIP_DECAP_ERROR, TRAP_TO_CPU, ROUTER_EXP, false),
+ 	/* PKT Sample trap */
+ 	MLXSW_RXL(mlxsw_sp_rx_listener_sample_func, PKT_SAMPLE, MIRROR_TO_CPU,
+ 		  false, SP_IP2ME, DISCARD),
+ 	/* ACL trap */
+ 	MLXSW_SP_RXL_NO_MARK(ACL0, TRAP_TO_CPU, IP2ME, false),
++>>>>>>> 86484de2c917 (mlxsw: spectrum: Register for IPIP_DECAP_ERROR trap)
  };
  
  static int mlxsw_sp_cpu_policers_set(struct mlxsw_core *mlxsw_core)
diff --cc drivers/net/ethernet/mellanox/mlxsw/trap.h
index 7ab275deacac,f396a1fef633..000000000000
--- a/drivers/net/ethernet/mellanox/mlxsw/trap.h
+++ b/drivers/net/ethernet/mellanox/mlxsw/trap.h
@@@ -59,11 -61,34 +59,20 @@@ enum 
  	MLXSW_TRAP_ID_MTUERROR = 0x52,
  	MLXSW_TRAP_ID_TTLERROR = 0x53,
  	MLXSW_TRAP_ID_LBERROR = 0x54,
 -	MLXSW_TRAP_ID_IPV4_OSPF = 0x55,
 +	MLXSW_TRAP_ID_OSPF = 0x55,
  	MLXSW_TRAP_ID_IP2ME = 0x5F,
 -	MLXSW_TRAP_ID_IPV6_UNSPECIFIED_ADDRESS = 0x60,
 -	MLXSW_TRAP_ID_IPV6_LINK_LOCAL_DEST = 0x61,
 -	MLXSW_TRAP_ID_IPV6_LINK_LOCAL_SRC = 0x62,
 -	MLXSW_TRAP_ID_IPV6_ALL_NODES_LINK = 0x63,
 -	MLXSW_TRAP_ID_IPV6_OSPF = 0x64,
 -	MLXSW_TRAP_ID_IPV6_MLDV12_LISTENER_QUERY = 0x65,
 -	MLXSW_TRAP_ID_IPV6_MLDV1_LISTENER_REPORT = 0x66,
 -	MLXSW_TRAP_ID_IPV6_MLDV1_LISTENER_DONE = 0x67,
 -	MLXSW_TRAP_ID_IPV6_MLDV2_LISTENER_REPORT = 0x68,
 -	MLXSW_TRAP_ID_IPV6_DHCP = 0x69,
 -	MLXSW_TRAP_ID_IPV6_ALL_ROUTERS_LINK = 0x6F,
  	MLXSW_TRAP_ID_RTR_INGRESS0 = 0x70,
 -	MLXSW_TRAP_ID_IPV4_BGP = 0x88,
 -	MLXSW_TRAP_ID_IPV6_BGP = 0x89,
 -	MLXSW_TRAP_ID_L3_IPV6_ROUTER_SOLICITATION = 0x8A,
 -	MLXSW_TRAP_ID_L3_IPV6_ROUTER_ADVERTISMENT = 0x8B,
 -	MLXSW_TRAP_ID_L3_IPV6_NEIGHBOR_SOLICITATION = 0x8C,
 -	MLXSW_TRAP_ID_L3_IPV6_NEIGHBOR_ADVERTISMENT = 0x8D,
 -	MLXSW_TRAP_ID_L3_IPV6_REDIRECTION = 0x8E,
 +	MLXSW_TRAP_ID_BGP_IPV4 = 0x88,
  	MLXSW_TRAP_ID_HOST_MISS_IPV4 = 0x90,
++<<<<<<< HEAD
++=======
+ 	MLXSW_TRAP_ID_IPV6_MC_LINK_LOCAL_DEST = 0x91,
+ 	MLXSW_TRAP_ID_HOST_MISS_IPV6 = 0x92,
+ 	MLXSW_TRAP_ID_IPIP_DECAP_ERROR = 0xB1,
+ 	MLXSW_TRAP_ID_ROUTER_ALERT_IPV4 = 0xD6,
+ 	MLXSW_TRAP_ID_ROUTER_ALERT_IPV6 = 0xD7,
+ 	MLXSW_TRAP_ID_ACL0 = 0x1C0,
++>>>>>>> 86484de2c917 (mlxsw: spectrum: Register for IPIP_DECAP_ERROR trap)
  
  	MLXSW_TRAP_ID_MAX = 0x1FF
  };
* Unmerged path drivers/net/ethernet/mellanox/mlxsw/spectrum.c
* Unmerged path drivers/net/ethernet/mellanox/mlxsw/trap.h
