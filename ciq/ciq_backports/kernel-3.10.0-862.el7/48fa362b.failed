nvmet-fc: simplify sg list handling

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author James Smart <jsmart2021@gmail.com>
commit 48fa362b6c3f4d69bdb6310b46626049092475e0
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/48fa362b.failed

The existing nvmet_fc sg list handling has 2 faults:
a) the request between LLDD and transport has too large of an sg
   list (256 elements), which is normally 256k (64 elements).
b) sglist handling doesn't optimize on the fact that each element
   is a page.

This patch removes the static sg list in the request and uses the
dynamic list already present in the nvmet_fc transport. It also
simplies the handling of the sg list on multiple sequences to
take advantage of the per-page divisions.

	Signed-off-by: James Smart <james.smart@broadcom.com>
	Signed-off-by: Christoph Hellwig <hch@lst.de>
(cherry picked from commit 48fa362b6c3f4d69bdb6310b46626049092475e0)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/nvme/target/fc.c
diff --cc drivers/nvme/target/fc.c
index 58773994b97a,421e43bf1dd7..000000000000
--- a/drivers/nvme/target/fc.c
+++ b/drivers/nvme/target/fc.c
@@@ -109,8 -111,14 +108,9 @@@ struct nvmet_fc_tgtport 
  	struct ida			assoc_cnt;
  	struct nvmet_port		*port;
  	struct kref			ref;
+ 	u32				max_sg_cnt;
  };
  
 -struct nvmet_fc_defer_fcp_req {
 -	struct list_head		req_list;
 -	struct nvmefc_tgt_fcp_req	*fcp_req;
 -};
 -
  struct nvmet_fc_tgt_queue {
  	bool				ninetypercent;
  	u16				qid;
@@@ -1730,8 -1868,8 +1732,13 @@@ nvmet_fc_transfer_fcp_data(struct nvmet
  				struct nvmet_fc_fcp_iod *fod, u8 op)
  {
  	struct nvmefc_tgt_fcp_req *fcpreq = fod->fcpreq;
++<<<<<<< HEAD
 +	struct scatterlist *sg, *datasg;
 +	u32 tlen, sg_off;
++=======
+ 	unsigned long flags;
+ 	u32 tlen;
++>>>>>>> 48fa362b6c3f (nvmet-fc: simplify sg list handling)
  	int ret;
  
  	fcpreq->op = op;
* Unmerged path drivers/nvme/target/fc.c
diff --git a/include/linux/nvme-fc-driver.h b/include/linux/nvme-fc-driver.h
index 977e25414837..184f4e95deb0 100644
--- a/include/linux/nvme-fc-driver.h
+++ b/include/linux/nvme-fc-driver.h
@@ -624,7 +624,7 @@ struct nvmefc_tgt_fcp_req {
 	u32			timeout;
 	u32			transfer_length;
 	struct fc_ba_rjt	ba_rjt;
-	struct scatterlist	sg[NVME_FC_MAX_SEGMENTS];
+	struct scatterlist	*sg;
 	int			sg_cnt;
 	void			*rspaddr;
 	dma_addr_t		rspdma;
