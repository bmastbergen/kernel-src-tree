scsi: cxlflash: Separate RRQ processing from the RRQ interrupt handler

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
Rebuild_CHGLOG: - [scsi] cxlflash: Separate RRQ processing from the RRQ interrupt handler (Gustavo Duarte) [1456494]
Rebuild_FUZZ: 95.52%
commit-author Matthew R. Ochs <mrochs@linux.vnet.ibm.com>
commit 76a6ebbeef26b004c36a0c8ee0496bae5428fc31
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/76a6ebbe.failed

In order to support processing the HRRQ by other means (e.g. polling), the
processing portion of the current RRQ interrupt handler needs to be broken out
into a separate routine. This will allow RRQ processing from places other than
the RRQ hardware interrupt handler.

	Signed-off-by: Matthew R. Ochs <mrochs@linux.vnet.ibm.com>
	Signed-off-by: Uma Krishnan <ukrishn@linux.vnet.ibm.com>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit 76a6ebbeef26b004c36a0c8ee0496bae5428fc31)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/cxlflash/main.c
diff --cc drivers/scsi/cxlflash/main.c
index c68badcfa77f,30c09593c122..000000000000
--- a/drivers/scsi/cxlflash/main.c
+++ b/drivers/scsi/cxlflash/main.c
@@@ -1210,17 -1155,18 +1210,16 @@@ cxlflash_sync_err_irq_exit
  }
  
  /**
-  * cxlflash_rrq_irq() - interrupt handler for read-response queue (normal path)
-  * @irq:	Interrupt number.
-  * @data:	Private data provided at interrupt registration, the AFU.
+  * process_hrrq() - process the read-response queue
+  * @afu:	AFU associated with the host.
   *
-  * Return: Always return IRQ_HANDLED.
+  * Return: The number of entries processed.
   */
- static irqreturn_t cxlflash_rrq_irq(int irq, void *data)
+ static int process_hrrq(struct afu *afu)
  {
- 	struct afu *afu = (struct afu *)data;
  	struct afu_cmd *cmd;
 -	struct sisl_ioasa *ioasa;
 -	struct sisl_ioarcb *ioarcb;
  	bool toggle = afu->toggle;
+ 	int num_hrrq = 0;
  	u64 entry,
  	    *hrrq_start = afu->hrrq_start,
  	    *hrrq_end = afu->hrrq_end,
@@@ -1243,6 -1198,9 +1242,12 @@@
  			hrrq_curr = hrrq_start;
  			toggle ^= SISL_RESP_HANDLE_T_BIT;
  		}
++<<<<<<< HEAD
++=======
+ 
+ 		atomic_inc(&afu->hsq_credits);
+ 		num_hrrq++;
++>>>>>>> 76a6ebbeef26 (scsi: cxlflash: Separate RRQ processing from the RRQ interrupt handler)
  	}
  
  	afu->hrrq_curr = hrrq_curr;
* Unmerged path drivers/scsi/cxlflash/main.c
