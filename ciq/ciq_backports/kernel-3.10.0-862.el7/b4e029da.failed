net/mlx5e: Reduce memory consumption on kdump kernel

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
Rebuild_CHGLOG: - [infiniband] lx5e: Reduce memory consumption on kdump kernel (Don Dutile) [1385309 1385649 1386645 1409099 1456667 1456687]
Rebuild_FUZZ: 94.95%
commit-author Kamal Heib <kamalh@mellanox.com>
commit b4e029da29ce8244879b607fbf0514d1087dc3f5
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/b4e029da.failed

Reduce memory consumption on kdump kernel by decreasing the number of
channels to 1 and the size of RQs and SQs to the minimal values.

	Signed-off-by: Kamal Heib <kamalh@mellanox.com>
	Signed-off-by: Saeed Mahameed <saeedm@mellanox.com>
(cherry picked from commit b4e029da29ce8244879b607fbf0514d1087dc3f5)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlx5/core/en_ethtool.c
#	drivers/net/ethernet/mellanox/mlx5/core/en_main.c
diff --cc drivers/net/ethernet/mellanox/mlx5/core/en_ethtool.c
index 81b1cc7550b9,9d520f8d6d1a..000000000000
--- a/drivers/net/ethernet/mellanox/mlx5/core/en_ethtool.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/en_ethtool.c
@@@ -560,6 -560,7 +560,10 @@@ static int mlx5e_set_channels(struct ne
  			      struct ethtool_channels *ch)
  {
  	struct mlx5e_priv *priv = netdev_priv(dev);
++<<<<<<< HEAD
++=======
+ 	int ncv = priv->profile->max_nch(priv->mdev);
++>>>>>>> b4e029da29ce (net/mlx5e: Reduce memory consumption on kdump kernel)
  	unsigned int count = ch->combined_count;
  	bool arfs_enabled;
  	bool was_opened;
diff --cc drivers/net/ethernet/mellanox/mlx5/core/en_main.c
index 6ef330ad1930,e829143efc14..000000000000
--- a/drivers/net/ethernet/mellanox/mlx5/core/en_main.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/en_main.c
@@@ -76,13 -79,14 +77,15 @@@ static bool mlx5e_check_fragmented_stri
  		MLX5_CAP_ETH(mdev, reg_umr_sq);
  }
  
 -static void mlx5e_set_rq_type_params(struct mlx5e_priv *priv, u8 rq_type)
 +void mlx5e_set_rq_type_params(struct mlx5e_priv *priv, u8 rq_type)
  {
  	priv->params.rq_wq_type = rq_type;
 +	priv->params.lro_wqe_sz = MLX5E_PARAMS_DEFAULT_LRO_WQE_SZ;
  	switch (priv->params.rq_wq_type) {
  	case MLX5_WQ_TYPE_LINKED_LIST_STRIDING_RQ:
- 		priv->params.log_rq_size = MLX5E_PARAMS_DEFAULT_LOG_RQ_SIZE_MPW;
+ 		priv->params.log_rq_size = is_kdump_kernel() ?
+ 			MLX5E_PARAMS_MINIMUM_LOG_RQ_SIZE_MPW :
+ 			MLX5E_PARAMS_DEFAULT_LOG_RQ_SIZE_MPW;
  		priv->params.mpwqe_log_stride_sz =
  			MLX5E_GET_PFLAG(priv, MLX5E_PFLAG_RX_CQE_COMPRESS) ?
  			MLX5_MPWRQ_LOG_STRIDE_SIZE_CQE_COMPRESS :
@@@ -91,11 -95,9 +94,17 @@@
  			priv->params.mpwqe_log_stride_sz;
  		break;
  	default: /* MLX5_WQ_TYPE_LINKED_LIST */
++<<<<<<< HEAD
 +		priv->params.log_rq_size = MLX5E_PARAMS_DEFAULT_LOG_RQ_SIZE;
 +
 +		/* Extra room needed for build_skb */
 +		priv->params.lro_wqe_sz -= MLX5_RX_HEADROOM +
 +			SKB_DATA_ALIGN(sizeof(struct skb_shared_info));
++=======
+ 		priv->params.log_rq_size = is_kdump_kernel() ?
+ 			MLX5E_PARAMS_MINIMUM_LOG_RQ_SIZE :
+ 			MLX5E_PARAMS_DEFAULT_LOG_RQ_SIZE;
++>>>>>>> b4e029da29ce (net/mlx5e: Reduce memory consumption on kdump kernel)
  	}
  	priv->params.min_rx_wqes = mlx5_min_rx_wqes(priv->params.rq_wq_type,
  					       BIT(priv->params.log_rq_size));
diff --git a/drivers/net/ethernet/mellanox/mlx5/core/en.h b/drivers/net/ethernet/mellanox/mlx5/core/en.h
index b147e8a51d8b..77b1a725af39 100644
--- a/drivers/net/ethernet/mellanox/mlx5/core/en.h
+++ b/drivers/net/ethernet/mellanox/mlx5/core/en.h
@@ -98,6 +98,7 @@
 
 #define MLX5E_LOG_INDIR_RQT_SIZE       0x7
 #define MLX5E_INDIR_RQT_SIZE           BIT(MLX5E_LOG_INDIR_RQT_SIZE)
+#define MLX5E_MIN_NUM_CHANNELS         0x1
 #define MLX5E_MAX_NUM_CHANNELS         (MLX5E_INDIR_RQT_SIZE >> 1)
 #define MLX5E_MAX_NUM_SQS              (MLX5E_MAX_NUM_CHANNELS * MLX5E_MAX_NUM_TC)
 #define MLX5E_TX_CQ_POLL_BUDGET        128
@@ -826,12 +827,6 @@ static inline u32 mlx5e_get_wqe_mtt_offset(struct mlx5e_rq *rq, u16 wqe_ix)
 	return wqe_ix * ALIGN(MLX5_MPWRQ_PAGES_PER_WQE, 8);
 }
 
-static inline int mlx5e_get_max_num_channels(struct mlx5_core_dev *mdev)
-{
-	return min_t(int, mdev->priv.eq_table.num_comp_vectors,
-		     MLX5E_MAX_NUM_CHANNELS);
-}
-
 extern const struct ethtool_ops mlx5e_ethtool_ops;
 #ifdef CONFIG_MLX5_CORE_EN_DCB
 extern const struct dcbnl_rtnl_ops mlx5e_dcbnl_ops;
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/en_ethtool.c
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/en_main.c
