qede: Move all UDP port notifiers to single function

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Alexander Duyck <aduyck@mirantis.com>
commit f9f082a9b948e02742511f626080eb4d84886512
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/f9f082a9.failed

This patch goes through and combines the notifiers for VXLAN and GENEVE
into a single function for each action.  So there is now one combined
function for getting ports, one for adding the ports, and one for deleting
the ports.

	Signed-off-by: Alexander Duyck <aduyck@mirantis.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit f9f082a9b948e02742511f626080eb4d84886512)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/qlogic/Kconfig
#	drivers/net/ethernet/qlogic/qede/qede_main.c
diff --cc drivers/net/ethernet/qlogic/Kconfig
index 08082f7e67cd,613dd2874644..000000000000
--- a/drivers/net/ethernet/qlogic/Kconfig
+++ b/drivers/net/ethernet/qlogic/Kconfig
@@@ -120,33 -114,4 +120,36 @@@ config QED
  	---help---
  	  This enables the support for ...
  
++<<<<<<< HEAD
 +config QEDE_VXLAN
 +	bool "Virtual eXtensible Local Area Network support"
 +	default n
 +	depends on QEDE && VXLAN && !(QEDE=y && VXLAN=m)
 +	---help---
 +	  This enables hardware offload support for VXLAN protocol over
 +	  qede module. Say Y here if you want to enable hardware offload
 +	  support for Virtual eXtensible Local Area Network (VXLAN)
 +	  in the driver.
 +
 +config QEDE_GENEVE
 +	bool "Generic Network Virtualization Encapsulation (GENEVE) support"
 +	depends on QEDE && GENEVE && !(QEDE=y && GENEVE=m)
 +	---help---
 +	  This allows one to create GENEVE virtual interfaces that provide
 +	  Layer 2 Networks over Layer 3 Networks. GENEVE is often used
 +	  to tunnel virtual network infrastructure in virtualized environments.
 +	  Say Y here if you want to enable hardware offload support for
 +	  Generic Network Virtualization Encapsulation (GENEVE) in the driver.
 +
 +config QED_RDMA
 +	bool
 +
 +config QED_ISCSI
 +	bool
 +
 +config QED_FCOE
 +	bool
 +
++=======
++>>>>>>> f9f082a9b948 (qede: Move all UDP port notifiers to single function)
  endif # NET_VENDOR_QLOGIC
diff --cc drivers/net/ethernet/qlogic/qede/qede_main.c
index 9490909958e8,2972742c6adb..000000000000
--- a/drivers/net/ethernet/qlogic/qede/qede_main.c
+++ b/drivers/net/ethernet/qlogic/qede/qede_main.c
@@@ -521,8 -2107,77 +516,81 @@@ static int qede_ioctl(struct net_devic
  	return 0;
  }
  
++<<<<<<< HEAD
++=======
+ static void qede_udp_tunnel_add(struct net_device *dev,
+ 				struct udp_tunnel_info *ti)
+ {
+ 	struct qede_dev *edev = netdev_priv(dev);
+ 	u16 t_port = ntohs(ti->port);
+ 
+ 	switch (ti->type) {
+ 	case UDP_TUNNEL_TYPE_VXLAN:
+ 		if (edev->vxlan_dst_port)
+ 			return;
+ 
+ 		edev->vxlan_dst_port = t_port;
+ 
+ 		DP_VERBOSE(edev, QED_MSG_DEBUG, "Added vxlan port=%d",
+ 			   t_port);
+ 
+ 		set_bit(QEDE_SP_VXLAN_PORT_CONFIG, &edev->sp_flags);
+ 		break;
+ 	case UDP_TUNNEL_TYPE_GENEVE:
+ 		if (edev->geneve_dst_port)
+ 			return;
+ 
+ 		edev->geneve_dst_port = t_port;
+ 
+ 		DP_VERBOSE(edev, QED_MSG_DEBUG, "Added geneve port=%d",
+ 			   t_port);
+ 		set_bit(QEDE_SP_GENEVE_PORT_CONFIG, &edev->sp_flags);
+ 		break;
+ 	default:
+ 		return;
+ 	}
+ 
+ 	schedule_delayed_work(&edev->sp_task, 0);
+ }
+ 
+ static void qede_udp_tunnel_del(struct net_device *dev,
+ 				struct udp_tunnel_info *ti)
+ {
+ 	struct qede_dev *edev = netdev_priv(dev);
+ 	u16 t_port = ntohs(ti->port);
+ 
+ 	switch (ti->type) {
+ 	case UDP_TUNNEL_TYPE_VXLAN:
+ 		if (t_port != edev->vxlan_dst_port)
+ 			return;
+ 
+ 		edev->vxlan_dst_port = 0;
+ 
+ 		DP_VERBOSE(edev, QED_MSG_DEBUG, "Deleted vxlan port=%d",
+ 			   t_port);
+ 
+ 		set_bit(QEDE_SP_VXLAN_PORT_CONFIG, &edev->sp_flags);
+ 		break;
+ 	case UDP_TUNNEL_TYPE_GENEVE:
+ 		if (t_port != edev->geneve_dst_port)
+ 			return;
+ 
+ 		edev->geneve_dst_port = 0;
+ 
+ 		DP_VERBOSE(edev, QED_MSG_DEBUG, "Deleted geneve port=%d",
+ 			   t_port);
+ 		set_bit(QEDE_SP_GENEVE_PORT_CONFIG, &edev->sp_flags);
+ 		break;
+ 	default:
+ 		return;
+ 	}
+ 
+ 	schedule_delayed_work(&edev->sp_task, 0);
+ }
+ 
++>>>>>>> f9f082a9b948 (qede: Move all UDP port notifiers to single function)
  static const struct net_device_ops qede_netdev_ops = {
 +	.ndo_size = sizeof(struct net_device_ops),
  	.ndo_open = qede_open,
  	.ndo_stop = qede_close,
  	.ndo_start_xmit = qede_start_xmit,
@@@ -545,15 -2199,8 +613,20 @@@
  	.ndo_get_vf_config = qede_get_vf_config,
  	.ndo_set_vf_rate = qede_set_vf_rate,
  #endif
++<<<<<<< HEAD
 +#ifdef CONFIG_QEDE_VXLAN
 +	.ndo_add_vxlan_port = qede_add_vxlan_port,
 +	.ndo_del_vxlan_port = qede_del_vxlan_port,
 +#endif
 +#ifdef CONFIG_QEDE_GENEVE
 +	.ndo_add_geneve_port = qede_add_geneve_port,
 +	.ndo_del_geneve_port = qede_del_geneve_port,
 +#endif
 +	.ndo_features_check = qede_features_check,
++=======
+ 	.ndo_udp_tunnel_add = qede_udp_tunnel_add,
+ 	.ndo_udp_tunnel_del = qede_udp_tunnel_del,
++>>>>>>> f9f082a9b948 (qede: Move all UDP port notifiers to single function)
  };
  
  /* -------------------------------------------------------------------------
@@@ -1979,14 -3568,7 +2052,18 @@@ static int qede_open(struct net_device 
  	if (rc)
  		return rc;
  
++<<<<<<< HEAD
 +#ifdef CONFIG_QEDE_VXLAN
 +	vxlan_get_rx_port(ndev);
 +#endif
 +#ifdef CONFIG_QEDE_GENEVE
 +	geneve_get_rx_port(ndev);
 +#endif
 +
 +	edev->ops->common->update_drv_state(edev->cdev, true);
++=======
+ 	udp_tunnel_get_rx_info(ndev);
++>>>>>>> f9f082a9b948 (qede: Move all UDP port notifiers to single function)
  
  	return 0;
  }
* Unmerged path drivers/net/ethernet/qlogic/Kconfig
* Unmerged path drivers/net/ethernet/qlogic/qede/qede_main.c
