nfp: make sure to cancel port refresh on the error path

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Jakub Kicinski <jakub.kicinski@netronome.com>
commit ab832b8de405c640d407b4473c6875210c326255
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/ab832b8d.failed

If very last stages of netdev registering and init fail some
other netdevs and devlink ports may have been visible to user
space before we torn them back down.  In this case there is a
slight chance user may have triggered port refresh.  We need
to make sure the async work is cancelled.

We have to cancel after releasing pf->lock, so we will always
try to cancel, regardless of which part of probe has failed.

	Signed-off-by: Jakub Kicinski <jakub.kicinski@netronome.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit ab832b8de405c640d407b4473c6875210c326255)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/netronome/nfp/nfp_net_main.c
diff --cc drivers/net/ethernet/netronome/nfp/nfp_net_main.c
index 092c7d18f2ec,cdd25dc5988d..000000000000
--- a/drivers/net/ethernet/netronome/nfp/nfp_net_main.c
+++ b/drivers/net/ethernet/netronome/nfp/nfp_net_main.c
@@@ -629,15 -798,22 +629,20 @@@ int nfp_net_pci_probe(struct nfp_pf *pf
  
  	return 0;
  
 -err_stop_app:
 -	nfp_net_pf_app_stop(pf);
 -err_free_irqs:
 -	nfp_net_pf_free_irqs(pf);
 -err_free_vnics:
 -	nfp_net_pf_free_vnics(pf);
  err_clean_ddir:
  	nfp_net_debugfs_dir_clean(&pf->ddir);
 -	nfp_net_pf_app_clean(pf);
 -err_unmap_qc:
 -	nfp_cpp_area_release_free(pf->qc_area);
 +	nfp_cpp_area_release_free(pf->rx_area);
 +err_unmap_tx:
 +	nfp_cpp_area_release_free(pf->tx_area);
  err_ctrl_unmap:
 -	nfp_cpp_area_release_free(pf->data_vnic_bar);
 +	nfp_cpp_area_release_free(pf->ctrl_area);
  err_unlock:
++<<<<<<< HEAD
 +	mutex_unlock(&pf->port_lock);
++=======
+ 	mutex_unlock(&pf->lock);
+ 	cancel_work_sync(&pf->port_refresh_work);
++>>>>>>> ab832b8de405 (nfp: make sure to cancel port refresh on the error path)
  	return err;
  }
  
* Unmerged path drivers/net/ethernet/netronome/nfp/nfp_net_main.c
