openvswitch: netlink: support L3 packets

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Jiri Benc <jbenc@redhat.com>
commit 0a6410fbde597ebcf82dda4a0b0e889e82242678
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/0a6410fb.failed

Extend the ovs flow netlink protocol to support L3 packets. Packets without
OVS_KEY_ATTR_ETHERNET attribute specify L3 packets; for those, the
OVS_KEY_ATTR_ETHERTYPE attribute is mandatory.

Push/pop vlan actions are only supported for Ethernet packets.

Based on previous versions by Lorand Jakab and Simon Horman.

	Signed-off-by: Lorand Jakab <lojakab@cisco.com>
	Signed-off-by: Simon Horman <simon.horman@netronome.com>
	Signed-off-by: Jiri Benc <jbenc@redhat.com>
	Acked-by: Pravin B Shelar <pshelar@ovn.org>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 0a6410fbde597ebcf82dda4a0b0e889e82242678)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/openvswitch/flow_netlink.c
diff --cc net/openvswitch/flow_netlink.c
index ae25ded82b3b,c3d0cc4321c3..000000000000
--- a/net/openvswitch/flow_netlink.c
+++ b/net/openvswitch/flow_netlink.c
@@@ -1059,6 -1082,21 +1082,24 @@@ static int metadata_from_nlattrs(struc
  				   sizeof(*cl), is_mask);
  		*attrs &= ~(1ULL << OVS_KEY_ATTR_CT_LABELS);
  	}
++<<<<<<< HEAD
++=======
+ 
+ 	/* For layer 3 packets the Ethernet type is provided
+ 	 * and treated as metadata but no MAC addresses are provided.
+ 	 */
+ 	if (!(*attrs & (1ULL << OVS_KEY_ATTR_ETHERNET)) &&
+ 	    (*attrs & (1ULL << OVS_KEY_ATTR_ETHERTYPE)))
+ 		mac_proto = MAC_PROTO_NONE;
+ 
+ 	/* Always exact match mac_proto */
+ 	SW_FLOW_KEY_PUT(match, mac_proto, is_mask ? 0xff : mac_proto, is_mask);
+ 
+ 	if (mac_proto == MAC_PROTO_NONE)
+ 		return parse_eth_type_from_nlattrs(match, attrs, a, is_mask,
+ 						   log);
+ 
++>>>>>>> 0a6410fbde59 (openvswitch: netlink: support L3 packets)
  	return 0;
  }
  
* Unmerged path net/openvswitch/flow_netlink.c
