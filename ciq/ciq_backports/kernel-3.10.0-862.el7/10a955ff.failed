i40e: Detect ATR HW Evict NVM issue and disable the feature

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Anjali Singhai Jain <anjali.singhai@intel.com>
commit 10a955ff62e56fe13dae1f29aabc04bc589eaf46
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/10a955ff.failed

This patch fixes a problem with the HW ATR eviction feature where the
NVM setting was incorrect.  This patch detects the issue on X720
adapters and disables the feature if the NVM setting is incorrect.

Without this patch, HW ATR Evict feature does not work on broken NVMs
and is not detected either.  If the HW ATR Evict feature is disabled
the SW Eviction feature will take effect.

	Signed-off-by: Anjali Singhai Jain <anjali.singhai@intel.com>
	Signed-off-by: Alice Michael <alice.michael@intel.com>
	Tested-by: Andrew Bowers <andrewx.bowers@intel.com>
	Signed-off-by: Jeff Kirsher <jeffrey.t.kirsher@intel.com>
(cherry picked from commit 10a955ff62e56fe13dae1f29aabc04bc589eaf46)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/intel/i40e/i40e_main.c
diff --cc drivers/net/ethernet/intel/i40e/i40e_main.c
index 32ff0c8dc416,6a59d9367a2a..000000000000
--- a/drivers/net/ethernet/intel/i40e/i40e_main.c
+++ b/drivers/net/ethernet/intel/i40e/i40e_main.c
@@@ -8882,6 -8951,37 +8882,40 @@@ static int i40e_sw_init(struct i40e_pf 
  				 pf->hw.func_caps.fd_filters_best_effort;
  	}
  
++<<<<<<< HEAD
++=======
+ 	if (pf->hw.mac.type == I40E_MAC_X722) {
+ 		pf->hw_features |= (I40E_HW_RSS_AQ_CAPABLE |
+ 				    I40E_HW_128_QP_RSS_CAPABLE |
+ 				    I40E_HW_ATR_EVICT_CAPABLE |
+ 				    I40E_HW_WB_ON_ITR_CAPABLE |
+ 				    I40E_HW_MULTIPLE_TCP_UDP_RSS_PCTYPE |
+ 				    I40E_HW_NO_PCI_LINK_CHECK |
+ 				    I40E_HW_USE_SET_LLDP_MIB |
+ 				    I40E_HW_GENEVE_OFFLOAD_CAPABLE |
+ 				    I40E_HW_PTP_L4_CAPABLE |
+ 				    I40E_HW_WOL_MC_MAGIC_PKT_WAKE |
+ 				    I40E_HW_OUTER_UDP_CSUM_CAPABLE);
+ 
+ #define I40E_FDEVICT_PCTYPE_DEFAULT 0xc03
+ 		if (rd32(&pf->hw, I40E_GLQF_FDEVICTENA(1)) !=
+ 		    I40E_FDEVICT_PCTYPE_DEFAULT) {
+ 			dev_warn(&pf->pdev->dev,
+ 				 "FD EVICT PCTYPES are not right, disable FD HW EVICT\n");
+ 			pf->hw_features &= ~I40E_HW_ATR_EVICT_CAPABLE;
+ 		}
+ 	} else if ((pf->hw.aq.api_maj_ver > 1) ||
+ 		   ((pf->hw.aq.api_maj_ver == 1) &&
+ 		    (pf->hw.aq.api_min_ver > 4))) {
+ 		/* Supported in FW API version higher than 1.4 */
+ 		pf->hw_features |= I40E_HW_GENEVE_OFFLOAD_CAPABLE;
+ 	}
+ 
+ 	/* Enable HW ATR eviction if possible */
+ 	if (pf->hw_features & I40E_HW_ATR_EVICT_CAPABLE)
+ 		pf->flags |= I40E_FLAG_HW_ATR_EVICT_ENABLED;
+ 
++>>>>>>> 10a955ff62e5 (i40e: Detect ATR HW Evict NVM issue and disable the feature)
  	if ((pf->hw.mac.type == I40E_MAC_XL710) &&
  	    (((pf->hw.aq.fw_maj_ver == 4) && (pf->hw.aq.fw_min_ver < 33)) ||
  	    (pf->hw.aq.fw_maj_ver < 4))) {
* Unmerged path drivers/net/ethernet/intel/i40e/i40e_main.c
