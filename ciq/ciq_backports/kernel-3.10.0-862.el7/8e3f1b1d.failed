powerpc/powernv/pci: Enable 64-bit devices to access >4GB DMA space

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
Rebuild_CHGLOG: - [powerpc] powernv/pci: Enable 64-bit devices to access >4GB DMA space (Mauricio Oliveira) [1506259]
Rebuild_FUZZ: 93.65%
commit-author Russell Currey <ruscur@russell.cc>
commit 8e3f1b1d8255105f31556aacf8aeb6071b00d469
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/8e3f1b1d.failed

On PHB3/POWER8 systems, devices can select between two different sections
of address space, TVE#0 and TVE#1.  TVE#0 is intended for 32bit devices
that aren't capable of addressing more than 4GB.  Selecting TVE#1 instead,
with the capability of addressing over 4GB, is performed by setting bit 59
of a PCI address.

However, some devices aren't capable of addressing at least 59 bits, but
still want more than 4GB of DMA space.  In order to enable this, reconfigure
TVE#0 to be suitable for 64-bit devices by allocating memory past the
initial 4GB that is inaccessible by 64-bit DMAs.

This bypass mode is only enabled if a device requests 4GB or more of DMA
address space, if the system has PHB3 (POWER8 systems), and if the device
does not share a PE with any devices from different vendors.

	Signed-off-by: Russell Currey <ruscur@russell.cc>
	Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
(cherry picked from commit 8e3f1b1d8255105f31556aacf8aeb6071b00d469)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/powerpc/platforms/powernv/pci-ioda.c
diff --cc arch/powerpc/platforms/powernv/pci-ioda.c
index 4347d27d58dd,437613588df1..000000000000
--- a/arch/powerpc/platforms/powernv/pci-ioda.c
+++ b/arch/powerpc/platforms/powernv/pci-ioda.c
@@@ -1688,8 -1820,7 +1757,12 @@@ static int pnv_pci_ioda_dma_set_mask(st
  	struct pnv_ioda_pe *pe;
  	uint64_t top;
  	bool bypass = false;
++<<<<<<< HEAD
 +	struct pci_dev *linked_npu_dev;
 +	int i;
++=======
+ 	s64 rc;
++>>>>>>> 8e3f1b1d8255 (powerpc/powernv/pci: Enable 64-bit devices to access >4GB DMA space)
  
  	if (WARN_ON(!pdn || pdn->pe_number == IODA_INVALID_PE))
  		return -ENODEV;;
* Unmerged path arch/powerpc/platforms/powernv/pci-ioda.c
