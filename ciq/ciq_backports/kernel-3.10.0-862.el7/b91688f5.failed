x86/vmware: Skip lapic calibration on VMware

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Renat Valiullin <rvaliullin@vmware.com>
commit b91688f528fe96e09d17e6d87c1b2805eb0c445e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/b91688f5.failed

In a virtualized environment the APIC timer calibration can go wrong when
the host is overcommitted or the guest is running nested. This results
in the APIC timers operating at an incorrect frequency.

Since VMware supports a mechanism to retrieve the local APIC frequency we
can ask the hypervisor for it and skip the APIC calibration loop.

	Signed-off-by: Renat Valiullin <rvaliullin@vmware.com>
	Acked-by: Alok N Kataria <akataria@vmware.com>
	Cc: virtualization@lists.linux-foundation.org
Link: http://lkml.kernel.org/r/20161004201148.GA1421@uu64vm
	Signed-off-by: Thomas Gleixner <tglx@linutronix.de>

(cherry picked from commit b91688f528fe96e09d17e6d87c1b2805eb0c445e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kernel/cpu/vmware.c
diff --cc arch/x86/kernel/cpu/vmware.c
index 628a059a9a06,81160578b91a..000000000000
--- a/arch/x86/kernel/cpu/vmware.c
+++ b/arch/x86/kernel/cpu/vmware.c
@@@ -81,11 -83,17 +82,23 @@@ static void __init vmware_platform_setu
  
  	VMWARE_PORT(GETHZ, eax, ebx, ecx, edx);
  
- 	if (ebx != UINT_MAX)
+ 	if (ebx != UINT_MAX) {
  		x86_platform.calibrate_tsc = vmware_get_tsc_khz;
++<<<<<<< HEAD
 +	else
 +		printk(KERN_WARNING
 +		       "Failed to get TSC freq from the hypervisor\n");
++=======
+ #ifdef CONFIG_X86_LOCAL_APIC
+ 		/* Skip lapic calibration since we know the bus frequency. */
+ 		lapic_timer_frequency = ecx / HZ;
+ 		pr_info("Host bus clock speed read from hypervisor : %u Hz\n",
+ 			ecx);
+ #endif
+ 	} else {
+ 		pr_warn("Failed to get TSC freq from the hypervisor\n");
+ 	}
++>>>>>>> b91688f528fe (x86/vmware: Skip lapic calibration on VMware)
  }
  
  /*
* Unmerged path arch/x86/kernel/cpu/vmware.c
