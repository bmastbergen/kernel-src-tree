md/raid5: use consistency_policy to remove journal feature

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
Rebuild_CHGLOG: - [md] raid5: use consistency_policy to remove journal feature (Nigel Croxon) [1455932]
Rebuild_FUZZ: 97.35%
commit-author Song Liu <songliubraving@fb.com>
commit 0bb0c10500ba634216238c40e1eeddce92b4d488
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/0bb0c105.failed

When journal device of an array fails, the array is forced into read-only
mode. To make the array normal without adding another journal device, we
need to remove journal _feature_ from the array.

This patch allows remove journal _feature_ from an array, For journal
existing journal should be either missing or faulty.

To remove journal feature, it is necessary to remove the journal device
first:

  mdadm --fail /dev/md0 /dev/sdb
  mdadm: set /dev/sdb faulty in /dev/md0
  mdadm --remove /dev/md0 /dev/sdb
  mdadm: hot removed /dev/sdb from /dev/md0

Then the journal feature can be removed by echoing into the sysfs file:

 cat /sys/block/md0/md/consistency_policy
 journal

 echo resync > /sys/block/md0/md/consistency_policy
 cat /sys/block/md0/md/consistency_policy
 resync

	Signed-off-by: Song Liu <songliubraving@fb.com>
	Signed-off-by: Shaohua Li <shli@fb.com>
(cherry picked from commit 0bb0c10500ba634216238c40e1eeddce92b4d488)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/md/raid5.c
diff --cc drivers/md/raid5.c
index 1500f218f73e,6036d5e41ddd..000000000000
--- a/drivers/md/raid5.c
+++ b/drivers/md/raid5.c
@@@ -8201,7 -8361,7 +8225,11 @@@ static struct md_personality raid6_pers
  	.quiesce	= raid5_quiesce,
  	.takeover	= raid6_takeover,
  	.congested	= raid5_congested,
++<<<<<<< HEAD
 +	.mergeable_bvec	= raid5_mergeable_bvec,
++=======
+ 	.change_consistency_policy = raid5_change_consistency_policy,
++>>>>>>> 0bb0c10500ba (md/raid5: use consistency_policy to remove journal feature)
  };
  static struct md_personality raid5_personality =
  {
@@@ -8251,7 -8410,7 +8279,11 @@@ static struct md_personality raid4_pers
  	.quiesce	= raid5_quiesce,
  	.takeover	= raid4_takeover,
  	.congested	= raid5_congested,
++<<<<<<< HEAD
 +	.mergeable_bvec	= raid5_mergeable_bvec,
++=======
+ 	.change_consistency_policy = raid5_change_consistency_policy,
++>>>>>>> 0bb0c10500ba (md/raid5: use consistency_policy to remove journal feature)
  };
  
  static int __init raid5_init(void)
* Unmerged path drivers/md/raid5.c
