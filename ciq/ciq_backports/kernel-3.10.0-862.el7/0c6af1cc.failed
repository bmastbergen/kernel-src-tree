blk-mq: put driver tag if dispatch budget can't be got

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Ming Lei <ming.lei@redhat.com>
commit 0c6af1ccd5fd9ac640aef01c8de0043837451a04
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/0c6af1cc.failed

We have to put the driver tag if dispatch budget can't be got, otherwise
it might cause IO deadlock, especially in case that size of tags is very
small.

Fixes: de1482974080(blk-mq: introduce .get_budget and .put_budget in blk_mq_ops)
	Signed-off-by: Ming Lei <ming.lei@redhat.com>
	Signed-off-by: Jens Axboe <axboe@kernel.dk>
(cherry picked from commit 0c6af1ccd5fd9ac640aef01c8de0043837451a04)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	block/blk-mq.c
diff --cc block/blk-mq.c
index d9bfe0c6bc0e,3d759bb8a5bb..000000000000
--- a/block/blk-mq.c
+++ b/block/blk-mq.c
@@@ -843,10 -1052,39 +843,41 @@@ bool blk_mq_dispatch_rq_list(struct blk
  	 * Now process all the entries, sending them to the driver.
  	 */
  	errors = queued = 0;
 -	do {
 +	while (!list_empty(list)) {
  		struct blk_mq_queue_data bd;
 -		blk_status_t ret;
  
  		rq = list_first_entry(list, struct request, queuelist);
++<<<<<<< HEAD
++=======
+ 		if (!blk_mq_get_driver_tag(rq, &hctx, false)) {
+ 			/*
+ 			 * The initial allocation attempt failed, so we need to
+ 			 * rerun the hardware queue when a tag is freed.
+ 			 */
+ 			if (!blk_mq_dispatch_wait_add(hctx)) {
+ 				if (got_budget)
+ 					blk_mq_put_dispatch_budget(hctx);
+ 				break;
+ 			}
+ 
+ 			/*
+ 			 * It's possible that a tag was freed in the window
+ 			 * between the allocation failure and adding the
+ 			 * hardware queue to the wait queue.
+ 			 */
+ 			if (!blk_mq_get_driver_tag(rq, &hctx, false)) {
+ 				if (got_budget)
+ 					blk_mq_put_dispatch_budget(hctx);
+ 				break;
+ 			}
+ 		}
+ 
+ 		if (!got_budget && !blk_mq_get_dispatch_budget(hctx)) {
+ 			blk_mq_put_driver_tag(rq);
+ 			break;
+ 		}
+ 
++>>>>>>> 0c6af1ccd5fd (blk-mq: put driver tag if dispatch budget can't be got)
  		list_del_init(&rq->queuelist);
  
  		bd.rq = rq;
* Unmerged path block/blk-mq.c
