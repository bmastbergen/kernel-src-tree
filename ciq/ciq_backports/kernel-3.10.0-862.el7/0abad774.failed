blk-mq: improve scheduler queue sync/async running

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Jens Axboe <axboe@fb.com>
commit 0abad774124351ba211b9053786ebd5a5a722d53
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/0abad774.failed

We'll use the same criteria for whether we need to run the queue sync
or async when we have a scheduler, as we do without one.

	Signed-off-by: Jens Axboe <axboe@fb.com>
	Reviewed-by: Omar Sandoval <osandov@fb.com>
	Tested-by: Hannes Reinecke <hare@suse.com>
(cherry picked from commit 0abad774124351ba211b9053786ebd5a5a722d53)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	block/blk-mq.c
diff --cc block/blk-mq.c
index 3b21482b7f01,1f948d5c2715..000000000000
--- a/block/blk-mq.c
+++ b/block/blk-mq.c
@@@ -1459,12 -1467,19 +1459,22 @@@ static void blk_mq_make_request(struct 
  			rcu_read_unlock();
  		} else {
  			srcu_idx = srcu_read_lock(&data.hctx->queue_rq_srcu);
 -			blk_mq_try_issue_directly(old_rq, &cookie);
 +			blk_mq_try_issue_directly(old_rq);
  			srcu_read_unlock(&data.hctx->queue_rq_srcu, srcu_idx);
  		}
 -		goto done;
 +		return;
  	}
  
++<<<<<<< HEAD
++=======
+ 	if (q->elevator) {
+ 		blk_mq_put_ctx(data.ctx);
+ 		blk_mq_bio_to_request(rq, bio);
+ 		blk_mq_sched_insert_request(rq, false, true,
+ 						!is_sync || is_flush_fua);
+ 		goto done;
+ 	}
++>>>>>>> 0abad7741243 (blk-mq: improve scheduler queue sync/async running)
  	if (!blk_mq_merge_queue_io(data.hctx, data.ctx, rq, bio)) {
  		/*
  		 * For a SYNC request, send it to the hardware immediately. For
@@@ -1531,9 -1580,16 +1541,19 @@@ static void blk_sq_make_request(struct 
  		}
  
  		list_add_tail(&rq->queuelist, &plug->mq_list);
 -		return cookie;
 +		return;
  	}
  
++<<<<<<< HEAD
++=======
+ 	if (q->elevator) {
+ 		blk_mq_put_ctx(data.ctx);
+ 		blk_mq_bio_to_request(rq, bio);
+ 		blk_mq_sched_insert_request(rq, false, true,
+ 						!is_sync || is_flush_fua);
+ 		goto done;
+ 	}
++>>>>>>> 0abad7741243 (blk-mq: improve scheduler queue sync/async running)
  	if (!blk_mq_merge_queue_io(data.hctx, data.ctx, rq, bio)) {
  		/*
  		 * For a SYNC request, send it to the hardware immediately. For
* Unmerged path block/blk-mq.c
