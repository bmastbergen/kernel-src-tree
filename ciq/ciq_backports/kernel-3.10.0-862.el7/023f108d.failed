selinux: fix double free in selinux_parse_opts_str()

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Paul Moore <paul@paul-moore.com>
commit 023f108dcc187e34ef864bf10ed966cf25e14e2a
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/023f108d.failed

This patch is based on a discussion generated by an earlier patch
from Tetsuo Handa:

* https://marc.info/?t=149035659300001&r=1&w=2

The double free problem involves the mnt_opts field of the
security_mnt_opts struct, selinux_parse_opts_str() frees the memory
on error, but doesn't set the field to NULL so if the caller later
attempts to call security_free_mnt_opts() we trigger the problem.

In order to play it safe we change selinux_parse_opts_str() to call
security_free_mnt_opts() on error instead of free'ing the memory
directly.  This should ensure that everything is handled correctly,
regardless of what the caller may do.

Fixes: e0007529893c1c06 ("LSM/SELinux: Interfaces to allow FS to control mount options")
	Cc: stable@vger.kernel.org
	Cc: Tetsuo Handa <penguin-kernel@I-love.SAKURA.ne.jp>
	Reported-by: Dmitry Vyukov <dvyukov@google.com>
	Signed-off-by: Paul Moore <paul@paul-moore.com>
	Signed-off-by: James Morris <james.l.morris@oracle.com>
(cherry picked from commit 023f108dcc187e34ef864bf10ed966cf25e14e2a)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	security/selinux/hooks.c
diff --cc security/selinux/hooks.c
index 7c150cbbfbc6,819fd6858b49..000000000000
--- a/security/selinux/hooks.c
+++ b/security/selinux/hooks.c
@@@ -1069,11 -1104,10 +1069,16 @@@ static int selinux_parse_opts_str(char 
  	if (!opts->mnt_opts)
  		goto out_err;
  
++<<<<<<< HEAD
 +	opts->mnt_opts_flags = kcalloc(NUM_SEL_MNT_OPTS, sizeof(int), GFP_ATOMIC);
 +	if (!opts->mnt_opts_flags) {
 +		kfree(opts->mnt_opts);
++=======
+ 	opts->mnt_opts_flags = kcalloc(NUM_SEL_MNT_OPTS, sizeof(int),
+ 				       GFP_KERNEL);
+ 	if (!opts->mnt_opts_flags)
++>>>>>>> 023f108dcc18 (selinux: fix double free in selinux_parse_opts_str())
  		goto out_err;
- 	}
  
  	if (fscontext) {
  		opts->mnt_opts[num_mnt_opts] = fscontext;
* Unmerged path security/selinux/hooks.c
