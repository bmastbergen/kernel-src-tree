IB/ipoib: Fix memory leaks for child interfaces priv

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Alex Vesker <valex@mellanox.com>
commit ab156afd3eeb68ce7b875ec8d9ff4f64d1427776
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/ab156afd.failed

There is a need to free priv explicitly and not just to release
the device, child priv is freed explicitly on remove flow and this
patch also includes priv free on error flow in P_key creation
and also in add_port.

Fixes: cd565b4b51e5 ('IB/IPoIB: Support acceleration options callbacks')
	Signed-off-by: Alex Vesker <valex@mellanox.com>
	Signed-off-by: Leon Romanovsky <leon@kernel.org>
	Signed-off-by: Doug Ledford <dledford@redhat.com>
(cherry picked from commit ab156afd3eeb68ce7b875ec8d9ff4f64d1427776)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/ulp/ipoib/ipoib_main.c
diff --cc drivers/infiniband/ulp/ipoib/ipoib_main.c
index 8bcffdc2a64e,0ddd9709e1df..000000000000
--- a/drivers/infiniband/ulp/ipoib/ipoib_main.c
+++ b/drivers/infiniband/ulp/ipoib/ipoib_main.c
@@@ -2288,6 -2302,11 +2289,14 @@@ static void ipoib_remove_one(struct ib_
  
  		unregister_netdev(priv->dev);
  		free_netdev(priv->dev);
++<<<<<<< HEAD
++=======
+ 
+ 		list_for_each_entry_safe(cpriv, tcpriv, &priv->child_intfs, list)
+ 			kfree(cpriv);
+ 
+ 		kfree(priv);
++>>>>>>> ab156afd3eeb (IB/ipoib: Fix memory leaks for child interfaces priv)
  	}
  
  	kfree(dev_list);
* Unmerged path drivers/infiniband/ulp/ipoib/ipoib_main.c
diff --git a/drivers/infiniband/ulp/ipoib/ipoib_vlan.c b/drivers/infiniband/ulp/ipoib/ipoib_vlan.c
index a69df126283b..062d877ece3d 100644
--- a/drivers/infiniband/ulp/ipoib/ipoib_vlan.c
+++ b/drivers/infiniband/ulp/ipoib/ipoib_vlan.c
@@ -165,8 +165,10 @@ out:
 
 	rtnl_unlock();
 
-	if (result)
+	if (result) {
 		free_netdev(priv->dev);
+		kfree(priv);
+	}
 
 	return result;
 }
@@ -207,6 +209,7 @@ int ipoib_vlan_delete(struct net_device *pdev, unsigned short pkey)
 
 	if (dev) {
 		free_netdev(dev);
+		kfree(priv);
 		return 0;
 	}
 
