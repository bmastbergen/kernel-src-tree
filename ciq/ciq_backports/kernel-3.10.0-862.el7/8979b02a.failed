tpm: Fix reference count to main device

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Stefan Berger <stefanb@linux.vnet.ibm.com>
commit 8979b02aaf1d6de8d52cc143aa4da961ed32e5a2
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/8979b02a.failed

The main device is currently not properly released due to one additional
reference to the 'devs' device which is only released in case of a TPM 2.
So, also get the additional reference only in case of a TPM2.

Fixes: fdc915f7f719 ("tpm: expose spaces via a device link /dev/tpmrm<n>")
	Signed-off-by: Stefan Berger <stefanb@linux.vnet.ibm.com>
	Reviewed-by: Jarkko Sakkinen <jarkko.sakkinen@linux.intel.com>
	Tested-by: Jarkko Sakkinen <jarkko.sakkinen@linux.intel.com>
	Signed-off-by: Jarkko Sakkinen <jarkko.sakkinen@linux.intel.com>
(cherry picked from commit 8979b02aaf1d6de8d52cc143aa4da961ed32e5a2)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/char/tpm/tpm-chip.c
diff --cc drivers/char/tpm/tpm-chip.c
index d2e9a9450e38,9dec9f551b83..000000000000
--- a/drivers/char/tpm/tpm-chip.c
+++ b/drivers/char/tpm/tpm-chip.c
@@@ -173,6 -185,17 +173,20 @@@ struct tpm_chip *tpm_chip_alloc(struct 
  	chip->dev.parent = pdev;
  	chip->dev.groups = chip->groups;
  
++<<<<<<< HEAD
++=======
+ 	chip->devs.parent = pdev;
+ 	chip->devs.class = tpmrm_class;
+ 	chip->devs.release = tpm_devs_release;
+ 	/* get extra reference on main device to hold on
+ 	 * behalf of devs.  This holds the chip structure
+ 	 * while cdevs is in use.  The corresponding put
+ 	 * is in the tpm_devs_release (TPM2 only)
+ 	 */
+ 	if (chip->flags & TPM_CHIP_FLAG_TPM2)
+ 		get_device(&chip->dev);
+ 
++>>>>>>> 8979b02aaf1d (tpm: Fix reference count to main device)
  	if (chip->dev_num == 0)
  		chip->dev.devt = MKDEV(MISC_MAJOR, TPM_MINOR);
  	else
* Unmerged path drivers/char/tpm/tpm-chip.c
