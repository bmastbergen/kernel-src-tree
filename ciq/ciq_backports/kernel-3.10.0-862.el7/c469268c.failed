KVM: x86: block guest protection keys unless the host has them enabled

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Paolo Bonzini <pbonzini@redhat.com>
commit c469268cd523245cc58255f6696e0c295485cb0b
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/c469268c.failed

If the host has protection keys disabled, we cannot read and write the
guest PKRU---RDPKRU and WRPKRU fail with #GP(0) if CR4.PKE=0.  Block
the PKU cpuid bit in that case.

This ensures that guest_CR4.PKE=1 implies host_CR4.PKE=1.

Fixes: 1be0e61c1f255faaeab04a390e00c8b9b9042870
	Cc: stable@vger.kernel.org
	Reviewed-by: David Hildenbrand <david@redhat.com>
	Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
(cherry picked from commit c469268cd523245cc58255f6696e0c295485cb0b)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kvm/cpuid.c
diff --cc arch/x86/kvm/cpuid.c
index 0031611e021e,19adbb418443..000000000000
--- a/arch/x86/kvm/cpuid.c
+++ b/arch/x86/kvm/cpuid.c
@@@ -456,6 -468,9 +456,12 @@@ static inline int __do_cpuid_ent(struc
  			entry->ebx |= F(TSC_ADJUST);
  			entry->ecx &= kvm_cpuid_7_0_ecx_x86_features;
  			cpuid_mask(&entry->ecx, CPUID_7_ECX);
++<<<<<<< HEAD
++=======
+ 			/* PKU is not yet implemented for shadow paging. */
+ 			if (!tdp_enabled || !boot_cpu_has(X86_FEATURE_OSPKE))
+ 				entry->ecx &= ~F(PKU);
++>>>>>>> c469268cd523 (KVM: x86: block guest protection keys unless the host has them enabled)
  			entry->edx &= kvm_cpuid_7_0_edx_x86_features;
  			entry->edx &= get_scattered_cpuid_leaf(7, 0, CPUID_EDX);
  		} else {
* Unmerged path arch/x86/kvm/cpuid.c
