X.509: Handle midnight alternative notation in GeneralizedTime

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author David Howells <dhowells@redhat.com>
commit 7650cb80e4e90b0fae7854b6008a46d24360515f
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/7650cb80.failed

The ASN.1 GeneralizedTime object carries an ISO 8601 format date and time.
The time is permitted to show midnight as 00:00 or 24:00 (the latter being
equivalent of 00:00 of the following day).

The permitted value is checked in x509_decode_time() but the actual
handling is left to mktime64().

Without this patch, certain X.509 certificates will be rejected and could
lead to an unbootable kernel.

Note that with this patch we also permit any 24:mm:ss time and extend this
to UTCTime, which whilst not strictly correct don't permit much leeway in
fiddling date strings.

	Reported-by: Rudolf Polzer <rpolzer@google.com>
	Signed-off-by: David Howells <dhowells@redhat.com>
	Acked-by: Arnd Bergmann <arnd@arndb.de>
cc: David Woodhouse <David.Woodhouse@intel.com>
cc: John Stultz <john.stultz@linaro.org>
(cherry picked from commit 7650cb80e4e90b0fae7854b6008a46d24360515f)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	crypto/asymmetric_keys/x509_cert_parser.c
diff --cc crypto/asymmetric_keys/x509_cert_parser.c
index ac72348c186a,c02c200a7136..000000000000
--- a/crypto/asymmetric_keys/x509_cert_parser.c
+++ b/crypto/asymmetric_keys/x509_cert_parser.c
@@@ -533,6 -508,29 +533,32 @@@ static int x509_note_time(struct tm *tm
  	if (*p != 'Z')
  		goto unsupported_time;
  
++<<<<<<< HEAD
++=======
+ 	if (year < 1970 ||
+ 	    mon < 1 || mon > 12)
+ 		goto invalid_time;
+ 
+ 	mon_len = month_lengths[mon - 1];
+ 	if (mon == 2) {
+ 		if (year % 4 == 0) {
+ 			mon_len = 29;
+ 			if (year % 100 == 0) {
+ 				mon_len = 28;
+ 				if (year % 400 == 0)
+ 					mon_len = 29;
+ 			}
+ 		}
+ 	}
+ 
+ 	if (day < 1 || day > mon_len ||
+ 	    hour > 24 || /* ISO 8601 permits 24:00:00 as midnight tomorrow */
+ 	    min > 59 ||
+ 	    sec > 60) /* ISO 8601 permits leap seconds [X.680 46.3] */
+ 		goto invalid_time;
+ 
+ 	*_t = mktime64(year, mon, day, hour, min, sec);
++>>>>>>> 7650cb80e4e9 (X.509: Handle midnight alternative notation in GeneralizedTime)
  	return 0;
  
  unsupported_time:
* Unmerged path crypto/asymmetric_keys/x509_cert_parser.c
