IB/mlx5: Fix RoCE Address Path fields

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
Rebuild_CHGLOG: - [infiniband] mlx5: Fix RoCE Address Path fields (Kamal Heib) [1525603]
Rebuild_FUZZ: 95.77%
commit-author Majd Dibbiny <majd@mellanox.com>
commit 2b621851acb34762ca893b2528823215e0d4b98c
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/2b621851.failed

When working over a RoCE network, the UDP source port should be set only
for statically connected QPs (RC, UC and XRC).

Fixes: 2811ba51b049 ("IB/mlx5: Add RoCE fields to Address Vector")
	Signed-off-by: Majd Dibbiny <majd@mellanox.com>
	Reviewed-by: Yishai Hadas <yishaih@mellanox.com>
	Signed-off-by: Leon Romanovsky <leon@kernel.org>
	Signed-off-by: Doug Ledford <dledford@redhat.com>
(cherry picked from commit 2b621851acb34762ca893b2528823215e0d4b98c)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/hw/mlx5/qp.c
diff --cc drivers/infiniband/hw/mlx5/qp.c
index 07d299c4ee50,31ad28853efa..000000000000
--- a/drivers/infiniband/hw/mlx5/qp.c
+++ b/drivers/infiniband/hw/mlx5/qp.c
@@@ -2275,12 -2338,16 +2275,23 @@@ static int mlx5_set_path(struct mlx5_ib
  					     &gid_type);
  		if (err)
  			return err;
++<<<<<<< HEAD
 +		memcpy(path->rmac, ah->dmac, sizeof(ah->dmac));
 +		path->udp_sport = mlx5_get_roce_udp_sport(dev, port,
 +							  ah->grh.sgid_index);
 +		path->dci_cfi_prio_sl = (ah->sl & 0x7) << 4;
++=======
+ 		memcpy(path->rmac, ah->roce.dmac, sizeof(ah->roce.dmac));
+ 		if (qp->ibqp.qp_type == IB_QPT_RC ||
+ 		    qp->ibqp.qp_type == IB_QPT_UC ||
+ 		    qp->ibqp.qp_type == IB_QPT_XRC_INI ||
+ 		    qp->ibqp.qp_type == IB_QPT_XRC_TGT)
+ 			path->udp_sport = mlx5_get_roce_udp_sport(dev, port,
+ 								  grh->sgid_index);
+ 		path->dci_cfi_prio_sl = (sl & 0x7) << 4;
++>>>>>>> 2b621851acb3 (IB/mlx5: Fix RoCE Address Path fields)
  		if (gid_type == IB_GID_TYPE_ROCE_UDP_ENCAP)
 -			path->ecn_dscp = (grh->traffic_class >> 2) & 0x3f;
 +			path->ecn_dscp = (ah->grh.traffic_class >> 2) & 0x3f;
  	} else {
  		path->fl_free_ar = (path_flags & MLX5_PATH_FLAG_FL) ? 0x80 : 0;
  		path->fl_free_ar |=
* Unmerged path drivers/infiniband/hw/mlx5/qp.c
