net sched: vlan action fix late binding

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Jamal Hadi Salim <jhs@mojatatu.com>
commit 5026c9b1bafcb309bf467b60494b3bcd6364b99c
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/5026c9b1.failed

Late vlan action binding was broken and is fixed with this patch.

//add a vlan action to pop and give it an instance id of 1
sudo tc actions add action vlan pop index 1
//create filter which binds to vlan action id 1
sudo tc filter add dev $DEV parent ffff: protocol ip prio 1 u32 \
match ip dst 17.0.0.1/32 flowid 1:1 action vlan index 1

current message(before bug fix) was:
RTNETLINK answers: Invalid argument
We have an error talking to the kernel

	Signed-off-by: Jamal Hadi Salim <jhs@mojatatu.com>
	Reviewed-by: Cong Wang <xiyou.wangcong@gmail.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 5026c9b1bafcb309bf467b60494b3bcd6364b99c)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/sched/act_vlan.c
diff --cc net/sched/act_vlan.c
index 2ca3e6093ca9,c45f926dafb9..000000000000
--- a/net/sched/act_vlan.c
+++ b/net/sched/act_vlan.c
@@@ -76,8 -77,7 +76,12 @@@ static int tcf_vlan_init(struct net *ne
  	int action;
  	__be16 push_vid = 0;
  	__be16 push_proto = 0;
++<<<<<<< HEAD
 +	u8 push_prio = 0;
 +	int ret = 0;
++=======
+ 	int ret = 0, exists = 0;
++>>>>>>> 5026c9b1bafc (net sched: vlan action fix late binding)
  	int err;
  
  	if (!nla)
@@@ -112,18 -122,17 +126,26 @@@
  		} else {
  			push_proto = htons(ETH_P_8021Q);
  		}
 +
 +		if (tb[TCA_VLAN_PUSH_VLAN_PRIORITY])
 +			push_prio = nla_get_u8(tb[TCA_VLAN_PUSH_VLAN_PRIORITY]);
  		break;
  	default:
+ 		if (exists)
+ 			tcf_hash_release(a, bind);
  		return -EINVAL;
  	}
  	action = parm->v_action;
  
++<<<<<<< HEAD
 +	if (!tcf_hash_check(parm->index, a, bind)) {
 +		ret = tcf_hash_create(parm->index, est, a, sizeof(*v),
 +				      bind, false);
++=======
+ 	if (!exists) {
+ 		ret = tcf_hash_create(tn, parm->index, est, a,
+ 				      sizeof(*v), bind, false);
++>>>>>>> 5026c9b1bafc (net sched: vlan action fix late binding)
  		if (ret)
  			return ret;
  
* Unmerged path net/sched/act_vlan.c
