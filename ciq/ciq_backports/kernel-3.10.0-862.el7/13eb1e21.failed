IB/rxe: Avoid ICRC errors by copying into the skb first

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Andrew Boyer <andrew.boyer@dell.com>
commit 13eb1e21d6198c9068eab7e7cb68c6d5c6834d1b
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/13eb1e21.failed

The current process is to first calculate the CRC and then copy the client
data into the packet. This leaves a window in which the packet contents and
CRC can get out of sync, if the client changes the data after the CRC is
calculated but before the data is copied.

By copying the data into the packet and then calculating the CRC directly
from the packet contents we eliminate the window.

This can be seen with qperf's ud_bi_bw test. This seems like very
strange/reckless client behavior, but whether the client has mangled its
data or not RXE should be able to transfer it reliably.

Fixes: 8700e3e7c485 ("Soft RoCE driver")
	Signed-off-by: Andrew Boyer <andrew.boyer@dell.com>
	Signed-off-by: Doug Ledford <dledford@redhat.com>
(cherry picked from commit 13eb1e21d6198c9068eab7e7cb68c6d5c6834d1b)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/sw/rxe/rxe_mr.c
diff --cc drivers/infiniband/sw/rxe/rxe_mr.c
index 37eea7441ca4,5c2684bf430f..000000000000
--- a/drivers/infiniband/sw/rxe/rxe_mr.c
+++ b/drivers/infiniband/sw/rxe/rxe_mr.c
@@@ -369,10 -367,11 +369,17 @@@ int rxe_mem_copy(struct rxe_mem *mem, u
  		dest = (dir == to_mem_obj) ?
  			((void *)(uintptr_t)iova) : addr;
  
+ 		memcpy(dest, src, length);
+ 
  		if (crcp)
++<<<<<<< HEAD
 +			*crcp = crc32_le(*crcp, src, length);
 +
 +		memcpy(dest, src, length);
++=======
+ 			*crcp = rxe_crc32(to_rdev(mem->pd->ibpd.device),
+ 					*crcp, dest, length);
++>>>>>>> 13eb1e21d619 (IB/rxe: Avoid ICRC errors by copying into the skb first)
  
  		return 0;
  	}
@@@ -402,10 -401,11 +409,17 @@@
  		if (bytes > length)
  			bytes = length;
  
+ 		memcpy(dest, src, bytes);
+ 
  		if (crcp)
++<<<<<<< HEAD
 +			crc = crc32_le(crc, src, bytes);
 +
 +		memcpy(dest, src, bytes);
++=======
+ 			crc = rxe_crc32(to_rdev(mem->pd->ibpd.device),
+ 					crc, dest, bytes);
++>>>>>>> 13eb1e21d619 (IB/rxe: Avoid ICRC errors by copying into the skb first)
  
  		length	-= bytes;
  		addr	+= bytes;
* Unmerged path drivers/infiniband/sw/rxe/rxe_mr.c
