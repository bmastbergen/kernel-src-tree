dm raid: display a consistent copy of the MD status via raid_status()

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Heinz Mauelshagen <heinzm@redhat.com>
commit 67143510a7e3634a23f06a48445d1148b2fdbc4d
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/67143510.failed

The MD sync thread updates recovery flags providing state of any
running, idle, frozen, recovering, reshaping, ... activity it performs
and updates respective flags asynchronously versus dm processing
raid_status().  To close that race window, take a single copy of the
flags and pass it into its callees.

	Signed-off-by: Heinz Mauelshagen <heinzm@redhat.com>
	Signed-off-by: Mike Snitzer <snitzer@redhat.com>
(cherry picked from commit 67143510a7e3634a23f06a48445d1148b2fdbc4d)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/md/dm-raid.c
diff --cc drivers/md/dm-raid.c
index a5a315efdf86,3df7c5bd5a9b..000000000000
--- a/drivers/md/dm-raid.c
+++ b/drivers/md/dm-raid.c
@@@ -3280,10 -3350,10 +3280,10 @@@ static const char *__raid_dev_status(st
  }
  
  /* Helper to return resync/reshape progress for @rs and @array_in_sync */
- static sector_t rs_get_progress(struct raid_set *rs,
+ static sector_t rs_get_progress(struct raid_set *rs, unsigned long recovery,
  				sector_t resync_max_sectors, bool *array_in_sync)
  {
 -	sector_t r, curr_resync_completed;
 +	sector_t r, recovery_cp, curr_resync_completed;
  	struct mddev *mddev = &rs->md;
  
  	curr_resync_completed = mddev->curr_resync_completed ?: mddev->recovery_cp;
@@@ -3313,12 -3382,14 +3313,18 @@@
  			}
  
  		/* Sync is relative to the component device size */
- 		} else if (test_bit(MD_RECOVERY_RUNNING, &mddev->recovery))
+ 		} else if (test_bit(MD_RECOVERY_RUNNING, &recovery))
  			r = curr_resync_completed;
  		else
 -			r = mddev->recovery_cp;
 +			r = recovery_cp;
  
++<<<<<<< HEAD
 +		if (r == MaxSector) {
++=======
+ 		if ((r == MaxSector) ||
+ 		    (test_bit(MD_RECOVERY_DONE, &recovery) &&
+ 		     (mddev->curr_resync_completed == resync_max_sectors))) {
++>>>>>>> 67143510a7e3 (dm raid: display a consistent copy of the MD status via raid_status())
  			/*
  			 * Sync complete.
  			 */
* Unmerged path drivers/md/dm-raid.c
