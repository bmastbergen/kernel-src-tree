cpuset: fix to migrate mm correctly in a corner case

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Li Zefan <lizefan@huawei.com>
commit f047cecf2cfc9595b1f39c9aab383bb0682f5a53
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/f047cecf.failed

Before moving tasks out of empty cpusets, update_tasks_nodemask()
is called, which calls do_migrate_pages(xx, from, to). Then those
tasks are moved to an ancestor, and do_migrate_pages() is called
again.

The first time: from = node_to_be_offlined, to = empty.
The second time: from = empty, to = ancestor's nodemask.

so looks like no pages will be migrated.

Fix this by:

- Don't call update_tasks_nodemask() on empty cpusets.
- Pass cs->old_mems_allowed to do_migrate_pages().

v4: added comment in cpuset_hotplug_update_tasks() and rephased comment
    in cpuset_attach().

	Signed-off-by: Li Zefan <lizefan@huawei.com>
	Signed-off-by: Tejun Heo <tj@kernel.org>
(cherry picked from commit f047cecf2cfc9595b1f39c9aab383bb0682f5a53)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	kernel/cpuset.c
diff --cc kernel/cpuset.c
index 7853c9ca0e26,4c17d96bd3a5..000000000000
--- a/kernel/cpuset.c
+++ b/kernel/cpuset.c
@@@ -1529,10 -1560,21 +1529,24 @@@ static void cpuset_attach(struct cgrou
  	cpuset_attach_nodemask_to = cs->mems_allowed;
  	mm = get_task_mm(leader);
  	if (mm) {
 -		struct cpuset *mems_oldcs = effective_nodemask_cpuset(oldcs);
 -
  		mpol_rebind_mm(mm, &cpuset_attach_nodemask_to);
++<<<<<<< HEAD
 +		if (is_memory_migrate(cs))
 +			cpuset_migrate_mm(mm, &oldcs->mems_allowed,
++=======
+ 
+ 		/*
+ 		 * old_mems_allowed is the same with mems_allowed here, except
+ 		 * if this task is being moved automatically due to hotplug.
+ 		 * In that case @mems_allowed has been updated and is empty,
+ 		 * so @old_mems_allowed is the right nodesets that we migrate
+ 		 * mm from.
+ 		 */
+ 		if (is_memory_migrate(cs)) {
+ 			cpuset_migrate_mm(mm, &mems_oldcs->old_mems_allowed,
++>>>>>>> f047cecf2cfc (cpuset: fix to migrate mm correctly in a corner case)
  					  &cpuset_attach_nodemask_to);
+ 		}
  		mmput(mm);
  	}
  
* Unmerged path kernel/cpuset.c
