IB/mlx5: Fix memory leak in clean_mr error path

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Kamal Heib <kamalh@mellanox.com>
commit 5942d8ae411775b76e5e1ab0cce57b0666516f2d
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/5942d8ae.failed

In clean_mr error path the 'mr' should be freed.

Fixes: e126ba97dba9 ('mlx5: Add driver for Mellanox Connect-IB adapters')
	Signed-off-by: Kamal Heib <kamalh@mellanox.com>
	Signed-off-by: Doug Ledford <dledford@redhat.com>
(cherry picked from commit 5942d8ae411775b76e5e1ab0cce57b0666516f2d)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/hw/mlx5/mr.c
diff --cc drivers/infiniband/hw/mlx5/mr.c
index 41cc30b2cbb2,8cf53eb13148..000000000000
--- a/drivers/infiniband/hw/mlx5/mr.c
+++ b/drivers/infiniband/hw/mlx5/mr.c
@@@ -1527,25 -1489,20 +1527,35 @@@ static int clean_mr(struct mlx5_ib_mr *
  
  	mlx5_free_priv_descs(mr);
  
++<<<<<<< HEAD
 +	if (!umred) {
++=======
+ 	if (!allocated_from_cache) {
+ 		u32 key = mr->mmkey.key;
+ 
++>>>>>>> 5942d8ae4117 (IB/mlx5: Fix memory leak in clean_mr error path)
  		err = destroy_mkey(dev, mr);
+ 		kfree(mr);
  		if (err) {
  			mlx5_ib_warn(dev, "failed to destroy mkey 0x%x (%d)\n",
- 				     mr->mmkey.key, err);
+ 				     key, err);
  			return err;
  		}
  	} else {
 -		mlx5_mr_cache_free(dev, mr);
 +		err = unreg_umr(dev, mr);
 +		if (err) {
 +			mlx5_ib_warn(dev, "failed unregister\n");
 +			return err;
 +		}
 +		free_cached_mr(dev, mr);
  	}
  
++<<<<<<< HEAD
 +	if (!umred)
 +		kfree(mr);
 +
++=======
++>>>>>>> 5942d8ae4117 (IB/mlx5: Fix memory leak in clean_mr error path)
  	return 0;
  }
  
* Unmerged path drivers/infiniband/hw/mlx5/mr.c
