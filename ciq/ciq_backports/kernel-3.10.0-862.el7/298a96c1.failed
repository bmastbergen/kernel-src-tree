x86/dma-mapping: Fix arch_dma_alloc_attrs() oops with NULL dev

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
Rebuild_CHGLOG: - [x86] dma-mapping: Fix arch_dma_alloc_attrs() oops with NULL dev (Don Dutile) [1494648]
Rebuild_FUZZ: 96.67%
commit-author Ville Syrj채l채 <ville.syrjala@linux.intel.com>
commit 298a96c12b2d8fd845ae0c2c21c0a1c0b470f99e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/298a96c1.failed

Commit 6894258eda2f broke drivers that pass NULL as the device pointer
to dma_alloc. The reason is that arch_dma_alloc_attrs() now calls
dma_alloc_coherent_gfp_flags() which in turn calls
dma_alloc_coherent_mask(), where the device pointer is dereferenced
unconditionally.

Fix things by moving the ISA DMA fallback device assignment before the
call to dma_alloc_coherent_gfp_flags().

Fixes: 6894258eda2f ("dma-mapping: consolidate dma_{alloc,free}_{attrs,coherent}")
Reported-and-tested-by: Meelis Roos <mroos@linux.ee>
	Signed-off-by: Ville Syrj채l채 <ville.syrjala@linux.intel.com>
	Cc: Christoph Hellwig <hch@lst.de>
Link: http://lkml.kernel.org/r/1445807503-8920-1-git-send-email-ville.syrjala@linux.intel.com
	Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
(cherry picked from commit 298a96c12b2d8fd845ae0c2c21c0a1c0b470f99e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kernel/pci-dma.c
diff --cc arch/x86/kernel/pci-dma.c
index b09eae608519,cd99433b8ba1..000000000000
--- a/arch/x86/kernel/pci-dma.c
+++ b/arch/x86/kernel/pci-dma.c
@@@ -133,50 -129,20 +133,62 @@@ void dma_generic_free_coherent(struct d
  		free_pages((unsigned long)vaddr, get_order(size));
  }
  
 -bool arch_dma_alloc_attrs(struct device **dev, gfp_t *gfp)
 +void *dma_alloc_attrs(struct device *dev, size_t size, dma_addr_t *dma_handle,
 +		      gfp_t gfp, struct dma_attrs *attrs)
  {
++<<<<<<< HEAD
 +	struct dma_map_ops *ops = get_dma_ops(dev);
 +	void *memory;
 +
 +	gfp &= ~(__GFP_DMA | __GFP_HIGHMEM | __GFP_DMA32);
++=======
+ 	if (!*dev)
+ 		*dev = &x86_dma_fallback_dev;
+ 
+ 	*gfp &= ~(__GFP_DMA | __GFP_HIGHMEM | __GFP_DMA32);
+ 	*gfp = dma_alloc_coherent_gfp_flags(*dev, *gfp);
+ 
+ 	if (!is_device_dma_capable(*dev))
+ 		return false;
+ 	return true;
++>>>>>>> 298a96c12b2d (x86/dma-mapping: Fix arch_dma_alloc_attrs() oops with NULL dev)
 +
 +	if (dma_alloc_from_coherent(dev, size, dma_handle, &memory))
 +		return memory;
 +
 +	if (!dev)
 +		dev = &x86_dma_fallback_dev;
 +
 +	if (!is_device_dma_capable(dev))
 +		return NULL;
 +
 +	if (!ops->alloc)
 +		return NULL;
 +
 +	memory = ops->alloc(dev, size, dma_handle,
 +			    dma_alloc_coherent_gfp_flags(dev, gfp), attrs);
 +	debug_dma_alloc_coherent(dev, size, *dma_handle, memory);
 +
 +	return memory;
 +}
 +EXPORT_SYMBOL(dma_alloc_attrs);
 +
 +void dma_free_attrs(struct device *dev, size_t size,
 +		    void *vaddr, dma_addr_t bus,
 +		    struct dma_attrs *attrs)
 +{
 +	struct dma_map_ops *ops = get_dma_ops(dev);
 +
 +	WARN_ON(irqs_disabled());       /* for portability */
 +
 +	if (dma_release_from_coherent(dev, get_order(size), vaddr))
 +		return;
  
 +	debug_dma_free_coherent(dev, size, vaddr, bus);
 +	if (ops->free)
 +		ops->free(dev, size, vaddr, bus, attrs);
  }
 -EXPORT_SYMBOL(arch_dma_alloc_attrs);
 +EXPORT_SYMBOL(dma_free_attrs);
  
  /*
   * See <Documentation/x86/x86_64/boot-options.txt> for the iommu kernel
* Unmerged path arch/x86/kernel/pci-dma.c
