mlxsw: spectrum_router: Add support for setting counters on IPv6 neighbors

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Arkadi Sharshevsky <arkadis@mellanox.com>
commit 1ed5574c6d48c6094bf688aa2cc755ea6ca4007c
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/1ed5574c.failed

Add support for setting counters on IPv6 neighbors based on dpipe's host6
table counter status.

	Signed-off-by: Arkadi Sharshevsky <arkadis@mellanox.com>
	Signed-off-by: Jiri Pirko <jiri@mellanox.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 1ed5574c6d48c6094bf688aa2cc755ea6ca4007c)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlxsw/spectrum_router.c
diff --cc drivers/net/ethernet/mellanox/mlxsw/spectrum_router.c
index 6908726c154c,0cf68102d113..000000000000
--- a/drivers/net/ethernet/mellanox/mlxsw/spectrum_router.c
+++ b/drivers/net/ethernet/mellanox/mlxsw/spectrum_router.c
@@@ -653,6 -1007,53 +653,56 @@@ mlxsw_sp_neigh_entry_remove(struct mlxs
  			       mlxsw_sp_neigh_ht_params);
  }
  
++<<<<<<< HEAD
++=======
+ static bool
+ mlxsw_sp_neigh_counter_should_alloc(struct mlxsw_sp *mlxsw_sp,
+ 				    struct mlxsw_sp_neigh_entry *neigh_entry)
+ {
+ 	struct devlink *devlink;
+ 	const char *table_name;
+ 
+ 	switch (mlxsw_sp_neigh_entry_type(neigh_entry)) {
+ 	case AF_INET:
+ 		table_name = MLXSW_SP_DPIPE_TABLE_NAME_HOST4;
+ 		break;
+ 	case AF_INET6:
+ 		table_name = MLXSW_SP_DPIPE_TABLE_NAME_HOST6;
+ 		break;
+ 	default:
+ 		WARN_ON(1);
+ 		return false;
+ 	}
+ 
+ 	devlink = priv_to_devlink(mlxsw_sp->core);
+ 	return devlink_dpipe_table_counter_enabled(devlink, table_name);
+ }
+ 
+ static void
+ mlxsw_sp_neigh_counter_alloc(struct mlxsw_sp *mlxsw_sp,
+ 			     struct mlxsw_sp_neigh_entry *neigh_entry)
+ {
+ 	if (!mlxsw_sp_neigh_counter_should_alloc(mlxsw_sp, neigh_entry))
+ 		return;
+ 
+ 	if (mlxsw_sp_flow_counter_alloc(mlxsw_sp, &neigh_entry->counter_index))
+ 		return;
+ 
+ 	neigh_entry->counter_valid = true;
+ }
+ 
+ static void
+ mlxsw_sp_neigh_counter_free(struct mlxsw_sp *mlxsw_sp,
+ 			    struct mlxsw_sp_neigh_entry *neigh_entry)
+ {
+ 	if (!neigh_entry->counter_valid)
+ 		return;
+ 	mlxsw_sp_flow_counter_free(mlxsw_sp,
+ 				   neigh_entry->counter_index);
+ 	neigh_entry->counter_valid = false;
+ }
+ 
++>>>>>>> 1ed5574c6d48 (mlxsw: spectrum_router: Add support for setting counters on IPv6 neighbors)
  static struct mlxsw_sp_neigh_entry *
  mlxsw_sp_neigh_entry_create(struct mlxsw_sp *mlxsw_sp, struct neighbour *n)
  {
* Unmerged path drivers/net/ethernet/mellanox/mlxsw/spectrum_router.c
