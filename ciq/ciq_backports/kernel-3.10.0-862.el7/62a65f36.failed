ceph: avoid invalid memory dereference in the middle of umount

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Yan, Zheng <zyan@redhat.com>
commit 62a65f36d016fff32179acdbfcb8b2d8d9e54757
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/62a65f36.failed

extra_mon_dispatch() and debugfs' foo_show functions dereference
fsc->mdsc. we should clean up fsc->client->extra_mon_dispatch
and debugfs before destroying fsc->mds.

	Signed-off-by: "Yan, Zheng" <zyan@redhat.com>
	Signed-off-by: Ilya Dryomov <idryomov@gmail.com>
(cherry picked from commit 62a65f36d016fff32179acdbfcb8b2d8d9e54757)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/ceph/super.c
diff --cc fs/ceph/super.c
index de325fef14dc,14e78dd52ef9..000000000000
--- a/fs/ceph/super.c
+++ b/fs/ceph/super.c
@@@ -1025,11 -1032,20 +1023,19 @@@ out_final
  static void ceph_kill_sb(struct super_block *s)
  {
  	struct ceph_fs_client *fsc = ceph_sb_to_client(s);
 -	dev_t dev = s->s_dev;
 -
  	dout("kill_sb %p\n", s);
 -
  	ceph_mdsc_pre_umount(fsc->mdsc);
++<<<<<<< HEAD
 +	kill_anon_super(s);    /* will call put_super after sb is r/o */
++=======
+ 	generic_shutdown_super(s);
+ 
+ 	fsc->client->extra_mon_dispatch = NULL;
+ 	ceph_fs_debugfs_cleanup(fsc);
+ 
++>>>>>>> 62a65f36d016 (ceph: avoid invalid memory dereference in the middle of umount)
  	ceph_mdsc_destroy(fsc);
 -
  	destroy_fs_client(fsc);
 -	free_anon_bdev(dev);
  }
  
  static struct file_system_type ceph_fs_type = {
diff --git a/fs/ceph/mds_client.c b/fs/ceph/mds_client.c
index 06ecdebe64d7..b2ec0dc36892 100644
--- a/fs/ceph/mds_client.c
+++ b/fs/ceph/mds_client.c
@@ -3765,13 +3765,13 @@ static void ceph_mdsc_stop(struct ceph_mds_client *mdsc)
 void ceph_mdsc_destroy(struct ceph_fs_client *fsc)
 {
 	struct ceph_mds_client *mdsc = fsc->mdsc;
-
 	dout("mdsc_destroy %p\n", mdsc);
-	ceph_mdsc_stop(mdsc);
 
 	/* flush out any connection work with references to us */
 	ceph_msgr_flush();
 
+	ceph_mdsc_stop(mdsc);
+
 	fsc->mdsc = NULL;
 	kfree(mdsc);
 	dout("mdsc_destroy %p done\n", mdsc);
* Unmerged path fs/ceph/super.c
