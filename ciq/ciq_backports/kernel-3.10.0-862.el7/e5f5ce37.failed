mac80211: validate user rate mask before configuring driver

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Johannes Berg <johannes.berg@intel.com>
commit e5f5ce37a7918ed7406c52987c7cc8b670ed5e14
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/e5f5ce37.failed

Ben reported that when the user rate mask is rejected for not
matching any basic rate, the driver had already been configured.
This is clearly an oversight in my original change, fix this by
doing the validation before calling the driver.

	Reported-by: Ben Greear <greearb@candelatech.com>
Fixes: e8e4f5280ddd ("mac80211: reject/clear user rate mask if not usable")
	Signed-off-by: Johannes Berg <johannes.berg@intel.com>
(cherry picked from commit e5f5ce37a7918ed7406c52987c7cc8b670ed5e14)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/mac80211/cfg.c
diff --cc net/mac80211/cfg.c
index ac879bb17870,fb15d3b97cb2..000000000000
--- a/net/mac80211/cfg.c
+++ b/net/mac80211/cfg.c
@@@ -2652,6 -2727,21 +2652,24 @@@ static int ieee80211_set_bitrate_mask(s
  	if (!ieee80211_sdata_running(sdata))
  		return -ENETDOWN;
  
++<<<<<<< HEAD
++=======
+ 	/*
+ 	 * If active validate the setting and reject it if it doesn't leave
+ 	 * at least one basic rate usable, since we really have to be able
+ 	 * to send something, and if we're an AP we have to be able to do
+ 	 * so at a basic rate so that all clients can receive it.
+ 	 */
+ 	if (rcu_access_pointer(sdata->vif.chanctx_conf) &&
+ 	    sdata->vif.bss_conf.chandef.chan) {
+ 		u32 basic_rates = sdata->vif.bss_conf.basic_rates;
+ 		enum nl80211_band band = sdata->vif.bss_conf.chandef.chan->band;
+ 
+ 		if (!(mask->control[band].legacy & basic_rates))
+ 			return -EINVAL;
+ 	}
+ 
++>>>>>>> e5f5ce37a791 (mac80211: validate user rate mask before configuring driver)
  	if (ieee80211_hw_check(&local->hw, HAS_RATE_CONTROL)) {
  		ret = drv_set_bitrate_mask(local, sdata, mask);
  		if (ret)
* Unmerged path net/mac80211/cfg.c
