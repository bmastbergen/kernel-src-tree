GFS2: Take inode off order_write list when setting jdata flag

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Bob Peterson <rpeterso@redhat.com>
commit cc555b09d8c3817aeebda43a14ab67049a5653f7
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/cc555b09.failed

This patch fixes a deadlock caused when the jdata flag is set for
inodes that are already on the ordered write list. Since it is
on the ordered write list, log_flush calls gfs2_ordered_write which
calls filemap_fdatawrite. But since the inode had the jdata flag
set, that calls gfs2_jdata_writepages, which tries to start a new
transaction. A new transaction cannot be started because it tries
to acquire the log_flush rwsem which is already locked by the log
flush operation.

The bottom line is: We cannot switch an inode from ordered to jdata
until we eliminate any ordered data pages (via log flush) or any
log_flush operation afterward will create the circular dependency
above. So we need to flush the log before setting the diskflags to
switch the file mode, then we need to remove the inode from the
ordered writes list.

Before this patch, the log flush was done for jdata->ordered, but
that's wrong. If we're going from jdata to ordered, we don't need
to call gfs2_log_flush because the call to filemap_fdatawrite will
do it for us:

   filemap_fdatawrite() -> __filemap_fdatawrite_range()
      __filemap_fdatawrite_range() -> do_writepages()
         do_writepages() -> gfs2_jdata_writepages()
            gfs2_jdata_writepages() -> gfs2_log_flush()

This patch modifies function do_gfs2_set_flags so that if a file
has its jdata flag set, and it's already on the ordered write list,
the log will be flushed and it will be removed from the list
before setting the flag.

	Signed-off-by: Bob Peterson <rpeterso@redhat.com>
	Signed-off-by: Andreas Gruenbacher <agruenba@redhat.com>
	Acked-by: Abhijith Das <adas@redhat.com>
(cherry picked from commit cc555b09d8c3817aeebda43a14ab67049a5653f7)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/gfs2/file.c
diff --cc fs/gfs2/file.c
index eff20dadb6a3,c7aea96144b4..000000000000
--- a/fs/gfs2/file.c
+++ b/fs/gfs2/file.c
@@@ -263,8 -267,8 +263,13 @@@ static int do_gfs2_set_flags(struct fil
  			goto out;
  	}
  	if ((flags ^ new_flags) & GFS2_DIF_JDATA) {
++<<<<<<< HEAD
 +		if (flags & GFS2_DIF_JDATA)
 +			gfs2_log_flush(sdp, ip->i_gl);
++=======
+ 		if (new_flags & GFS2_DIF_JDATA)
+ 			gfs2_log_flush(sdp, ip->i_gl, NORMAL_FLUSH);
++>>>>>>> cc555b09d8c3 (GFS2: Take inode off order_write list when setting jdata flag)
  		error = filemap_fdatawrite(inode->i_mapping);
  		if (error)
  			goto out;
* Unmerged path fs/gfs2/file.c
