scsi: qla2xxx: Accelerate SCSI BUSY status generation in target mode

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
Rebuild_CHGLOG: - [scsi] qla2xxx: Accelerate SCSI BUSY status generation in target mode (Himanshu Madhani) [1460030]
Rebuild_FUZZ: 95.38%
commit-author Quinn Tran <quinn.tran@cavium.com>
commit 2da52737521a2a65eb9b2323a0748047a454e86c
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/2da52737.failed

Accelerate generation of SCSI busy to let initiators slow down when
target is running low in resources.

	Signed-off-by: Quinn Tran <quinn.tran@cavium.com>
	Signed-off-by: Himanshu Madhani <himanshu.madhani@cavium.com>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit 2da52737521a2a65eb9b2323a0748047a454e86c)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/qla2xxx/qla_init.c
diff --cc drivers/scsi/qla2xxx/qla_init.c
index b9189cae77e5,436968ad4484..000000000000
--- a/drivers/scsi/qla2xxx/qla_init.c
+++ b/drivers/scsi/qla2xxx/qla_init.c
@@@ -6416,21 -7364,41 +6416,49 @@@ qla81xx_update_fw_options(scsi_qla_host
  			__func__, ha->fw_options[2]);
  	}
  
 -	/* Move PUREX, ABTS RX & RIDA to ATIOQ */
 -	if (ql2xmvasynctoatio) {
 -		if (qla_tgt_mode_enabled(vha) ||
 -		    qla_dual_mode_enabled(vha))
 -			ha->fw_options[2] |= BIT_11;
 -		else
 -			ha->fw_options[2] &= ~BIT_11;
 +	/* Set Retry FLOGI in case of P2P connection */
 +	if (ha->operating_mode == P2P) {
 +		ha->fw_options[2] |= BIT_3;
 +		ql_dbg(ql_dbg_disc, vha, 0x2103,
 +		    "(%s): Setting FLOGI retry BIT in fw_options[2]: 0x%x\n",
 +			__func__, ha->fw_options[2]);
  	}
  
++<<<<<<< HEAD
 +	if (!ql2xetsenable)
 +		goto out;
++=======
+ 	if (qla_tgt_mode_enabled(vha) ||
+ 	    qla_dual_mode_enabled(vha)) {
+ 		/* FW auto send SCSI status during */
+ 		ha->fw_options[1] |= BIT_8;
+ 		ha->fw_options[10] |= (u16)SAM_STAT_BUSY << 8;
+ 
+ 		/* FW perform Exchange validation */
+ 		ha->fw_options[2] |= BIT_4;
+ 	} else {
+ 		ha->fw_options[1]  &= ~BIT_8;
+ 		ha->fw_options[10] &= 0x00ff;
+ 
+ 		ha->fw_options[2] &= ~BIT_4;
+ 	}
+ 
+ 	if (ql2xetsenable) {
+ 		/* Enable ETS Burst. */
+ 		memset(ha->fw_options, 0, sizeof(ha->fw_options));
+ 		ha->fw_options[2] |= BIT_9;
+ 	}
+ 
+ 	ql_dbg(ql_dbg_init, vha, 0x00e9,
+ 	    "%s, add FW options 1-3 = 0x%04x 0x%04x 0x%04x mode %x\n",
+ 	    __func__, ha->fw_options[1], ha->fw_options[2],
+ 	    ha->fw_options[3], vha->host->active_mode);
++>>>>>>> 2da52737521a (scsi: qla2xxx: Accelerate SCSI BUSY status generation in target mode)
  
 +	/* Enable ETS Burst. */
 +	memset(ha->fw_options, 0, sizeof(ha->fw_options));
 +	ha->fw_options[2] |= BIT_9;
 +out:
  	qla2x00_set_fw_options(vha, ha->fw_options);
  }
  
* Unmerged path drivers/scsi/qla2xxx/qla_init.c
diff --git a/drivers/scsi/qla2xxx/qla_mbx.c b/drivers/scsi/qla2xxx/qla_mbx.c
index 21eee93873e8..a99659598564 100644
--- a/drivers/scsi/qla2xxx/qla_mbx.c
+++ b/drivers/scsi/qla2xxx/qla_mbx.c
@@ -792,6 +792,8 @@ qla2x00_set_fw_options(scsi_qla_host_t *vha, uint16_t *fwopts)
 	mcp->in_mb = MBX_0;
 	if (IS_FWI2_CAPABLE(vha->hw)) {
 		mcp->in_mb |= MBX_1;
+		mcp->mb[10] = fwopts[10];
+		mcp->out_mb |= MBX_10;
 	} else {
 		mcp->mb[10] = fwopts[10];
 		mcp->mb[11] = fwopts[11];
