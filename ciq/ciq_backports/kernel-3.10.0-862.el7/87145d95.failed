drm/i915/cnl: Fix PLL mapping.

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
Rebuild_CHGLOG: - [gpu] drm/i915/cnl: Fix PLL mapping (Rob Clark) [1512612]
Rebuild_FUZZ: 98.31%
commit-author Rodrigo Vivi <rodrigo.vivi@intel.com>
commit 87145d95c3d8297fb74762bd92e022d7f5cc250c
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/87145d95.failed

On PLL Enable sequence we need to "Configure DPCLKA_CFGCR0 to turn on
the clock for the DDI and map the DPLL to the DDI"

So we first do the map and then we unset DDI_CLK_OFF to turn the clock
on. We do this in 2 separated steps.

However, on this second step where we should only unset the off bit we are
also unmapping the ddi from the pll. So we end up using the pll 0
for almost everything. Consequently breaking cases with more than one
display.

Fixes: 555e38d27317 ("drm/i915/cnl: DDI - PLL mapping")
	Cc: Paulo Zanoni <paulo.r.zanoni@intel.com>
	Cc: Manasi Navare <manasi.d.navare@intel.com>
	Cc: Kahola, Mika <mika.kahola@intel.com>
	Signed-off-by: Rodrigo Vivi <rodrigo.vivi@intel.com>
	Reviewed-by: James Ausmus <james.ausmus@intel.com>
Link: https://patchwork.freedesktop.org/patch/msgid/20171003220859.21352-2-rodrigo.vivi@intel.com
(cherry picked from commit 87145d95c3d8297fb74762bd92e022d7f5cc250c)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/gpu/drm/i915/intel_ddi.c
diff --cc drivers/gpu/drm/i915/intel_ddi.c
index 10ec9d4b7d45,adf51b328844..000000000000
--- a/drivers/gpu/drm/i915/intel_ddi.c
+++ b/drivers/gpu/drm/i915/intel_ddi.c
@@@ -1658,9 -2110,21 +1658,21 @@@ void intel_ddi_clk_select(struct intel_
  	if (WARN_ON(!pll))
  		return;
  
 -	if (IS_CANNONLAKE(dev_priv)) {
 -		/* Configure DPCLKA_CFGCR0 to map the DPLL to the DDI. */
 -		val = I915_READ(DPCLKA_CFGCR0);
 -		val |= DPCLKA_CFGCR0_DDI_CLK_SEL(pll->id, port);
 -		I915_WRITE(DPCLKA_CFGCR0, val);
 +	if (IS_SKYLAKE(dev_priv) || IS_KABYLAKE(dev_priv)) {
 +		uint32_t val;
  
++<<<<<<< HEAD
++=======
+ 		/*
+ 		 * Configure DPCLKA_CFGCR0 to turn on the clock for the DDI.
+ 		 * This step and the step before must be done with separate
+ 		 * register writes.
+ 		 */
+ 		val = I915_READ(DPCLKA_CFGCR0);
+ 		val &= ~DPCLKA_CFGCR0_DDI_CLK_OFF(port);
+ 		I915_WRITE(DPCLKA_CFGCR0, val);
+ 	} else if (IS_GEN9_BC(dev_priv)) {
++>>>>>>> 87145d95c3d8 (drm/i915/cnl: Fix PLL mapping.)
  		/* DDI -> PLL mapping  */
  		val = I915_READ(DPLL_CTRL2);
  
* Unmerged path drivers/gpu/drm/i915/intel_ddi.c
