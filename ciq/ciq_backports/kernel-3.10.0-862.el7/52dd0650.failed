drm/fb_helper: Disable all crtc's when initial setup fails.

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
Rebuild_CHGLOG: - [gpu] drm/fb_helper: Disable all crtc's when initial setup fails (Rob Clark) [1532388]
Rebuild_FUZZ: 99.15%
commit-author Maarten Lankhorst <maarten.lankhorst@linux.intel.com>
commit 52dd06506e9bbc2a37b352df7dfc5468f8da21fd
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/52dd0650.failed

Some drivers like i915 start with crtc's enabled, but with deferred
fbcon setup they were no longer disabled as part of fbdev setup.
Headless units could no longer enter pc3 state because the crtc was
still enabled.

Fix this by calling restore_fbdev_mode when we would have called
it otherwise once during initial fbdev setup.

	Signed-off-by: Maarten Lankhorst <maarten.lankhorst@linux.intel.com>
Fixes: ca91a2758fce ("drm/fb-helper: Support deferred setup")
	Cc: <stable@vger.kernel.org> # v4.14+
	Reported-by: Thomas Voegtle <tv@lio96.de>
	Tested-by: Thomas Voegtle <tv@lio96.de>
	Reviewed-by: Daniel Vetter <daniel.vetter@ffwll.ch>
Link: https://patchwork.freedesktop.org/patch/msgid/20171128111603.62757-1-maarten.lankhorst@linux.intel.com
(cherry picked from commit 52dd06506e9bbc2a37b352df7dfc5468f8da21fd)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/gpu/drm/drm_fb_helper.c
diff --cc drivers/gpu/drm/drm_fb_helper.c
index e3da97b409bc,e56166334455..000000000000
--- a/drivers/gpu/drm/drm_fb_helper.c
+++ b/drivers/gpu/drm/drm_fb_helper.c
@@@ -1569,13 -1808,18 +1569,22 @@@ static int drm_fb_helper_single_fb_prob
  	}
  
  	if (crtc_count == 0 || sizes.fb_width == -1 || sizes.fb_height == -1) {
++<<<<<<< HEAD
 +		/* hmm everyone went away - assume VGA cable just fell out
 +		   and will come back later. */
 +		DRM_INFO("Cannot find any crtc or sizes - going 1024x768\n");
 +		sizes.fb_width = sizes.surface_width = 1024;
 +		sizes.fb_height = sizes.surface_height = 768;
++=======
+ 		DRM_INFO("Cannot find any crtc or sizes\n");
+ 
+ 		/* First time: disable all crtc's.. */
+ 		if (!fb_helper->deferred_setup && !READ_ONCE(fb_helper->dev->master))
+ 			restore_fbdev_mode(fb_helper);
+ 		return -EAGAIN;
++>>>>>>> 52dd06506e9b (drm/fb_helper: Disable all crtc's when initial setup fails.)
  	}
  
 -	/* Handle our overallocation */
 -	sizes.surface_height *= drm_fbdev_overalloc;
 -	sizes.surface_height /= 100;
 -
  	/* push down into drivers */
  	ret = (*fb_helper->funcs->fb_probe)(fb_helper, &sizes);
  	if (ret < 0)
* Unmerged path drivers/gpu/drm/drm_fb_helper.c
