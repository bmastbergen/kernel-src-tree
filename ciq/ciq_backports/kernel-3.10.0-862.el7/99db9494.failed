IB/core: Remove ib_device.dma_device

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Bart Van Assche <bart.vanassche@sandisk.com>
commit 99db9494035f5b9fbb1d579f89c6fa1beba6dbb7
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/99db9494.failed

Add code in ib_register_device() for copying the DMA masks. Use
&ib_device.dev in DMA mapping operations instead of dma_device.
Remove ib_device.dma_device because due to this and previous patches
it is no longer used.

	Signed-off-by: Bart Van Assche <bart.vanassche@sandisk.com>
	Signed-off-by: Doug Ledford <dledford@redhat.com>
(cherry picked from commit 99db9494035f5b9fbb1d579f89c6fa1beba6dbb7)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	include/rdma/ib_verbs.h
diff --cc include/rdma/ib_verbs.h
index 6716ea884d52,a20a15f81936..000000000000
--- a/include/rdma/ib_verbs.h
+++ b/include/rdma/ib_verbs.h
@@@ -3050,27 -3000,9 +3048,27 @@@ static inline void ib_dma_unmap_single(
  	if (dev->dma_ops)
  		dev->dma_ops->unmap_single(dev, addr, size, direction);
  	else
- 		dma_unmap_single(dev->dma_device, addr, size, direction);
+ 		dma_unmap_single(&dev->dev, addr, size, direction);
  }
  
 +static inline u64 ib_dma_map_single_attrs(struct ib_device *dev,
 +					  void *cpu_addr, size_t size,
 +					  enum dma_data_direction direction,
 +					  struct dma_attrs *attrs)
 +{
 +	return dma_map_single_attrs(dev->dma_device, cpu_addr, size,
 +				    direction, attrs);
 +}
 +
 +static inline void ib_dma_unmap_single_attrs(struct ib_device *dev,
 +					     u64 addr, size_t size,
 +					     enum dma_data_direction direction,
 +					     struct dma_attrs *attrs)
 +{
 +	return dma_unmap_single_attrs(dev->dma_device, addr, size,
 +				      direction, attrs);
 +}
 +
  /**
   * ib_dma_map_page - Map a physical page to DMA address
   * @dev: The device for which the dma_addr is to be created
@@@ -3147,10 -3079,8 +3145,15 @@@ static inline int ib_dma_map_sg_attrs(s
  {
  	if (dev->dma_ops)
  		return dev->dma_ops->map_sg_attrs(dev, sg, nents, direction,
++<<<<<<< HEAD
 +						  attrs);
 +	else
 +		return dma_map_sg_attrs(dev->dma_device, sg, nents, direction,
 +					attrs);
++=======
+ 						  dma_attrs);
+ 	return dma_map_sg_attrs(&dev->dev, sg, nents, direction, dma_attrs);
++>>>>>>> 99db9494035f (IB/core: Remove ib_device.dma_device)
  }
  
  static inline void ib_dma_unmap_sg_attrs(struct ib_device *dev,
@@@ -3160,10 -3090,9 +3163,14 @@@
  {
  	if (dev->dma_ops)
  		return dev->dma_ops->unmap_sg_attrs(dev, sg, nents, direction,
 -						  dma_attrs);
 +						    attrs);
  	else
++<<<<<<< HEAD
 +		dma_unmap_sg_attrs(dev->dma_device, sg, nents, direction,
 +				   attrs);
++=======
+ 		dma_unmap_sg_attrs(&dev->dev, sg, nents, direction, dma_attrs);
++>>>>>>> 99db9494035f (IB/core: Remove ib_device.dma_device)
  }
  /**
   * ib_sg_dma_address - Return the DMA address from a scatter/gather entry
diff --git a/drivers/infiniband/core/device.c b/drivers/infiniband/core/device.c
index d71a36e339d0..a272b4e89626 100644
--- a/drivers/infiniband/core/device.c
+++ b/drivers/infiniband/core/device.c
@@ -333,14 +333,15 @@ int ib_register_device(struct ib_device *device,
 	int ret;
 	struct ib_client *client;
 	struct ib_udata uhw = {.outlen = 0, .inlen = 0};
-
-	WARN_ON_ONCE(!device->dev.parent && !device->dma_device);
-	WARN_ON_ONCE(device->dev.parent && device->dma_device
-		     && device->dev.parent != device->dma_device);
-	if (!device->dev.parent)
-		device->dev.parent = device->dma_device;
-	if (!device->dma_device)
-		device->dma_device = device->dev.parent;
+	struct device *parent = device->dev.parent;
+
+	WARN_ON_ONCE(!parent);
+	if (!device->dev.dma_ops)
+		device->dev.dma_ops = parent->dma_ops;
+	if (!device->dev.dma_mask)
+		device->dev.dma_mask = parent->dma_mask;
+	if (!device->dev.coherent_dma_mask)
+		device->dev.coherent_dma_mask = parent->coherent_dma_mask;
 
 	mutex_lock(&device_mutex);
 
* Unmerged path include/rdma/ib_verbs.h
