KEYS: encrypted: fix dereference of NULL user_key_payload

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Eric Biggers <ebiggers@google.com>
commit 13923d0865ca96312197962522e88bc0aedccd74
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/13923d08.failed

A key of type "encrypted" references a "master key" which is used to
encrypt and decrypt the encrypted key's payload.  However, when we
accessed the master key's payload, we failed to handle the case where
the master key has been revoked, which sets the payload pointer to NULL.
Note that request_key() *does* skip revoked keys, but there is still a
window where the key can be revoked before we acquire its semaphore.

Fix it by checking for a NULL payload, treating it like a key which was
already revoked at the time it was requested.

This was an issue for master keys of type "user" only.  Master keys can
also be of type "trusted", but those cannot be revoked.

Fixes: 7e70cb497850 ("keys: add new key-type encrypted")
	Reviewed-by: James Morris <james.l.morris@oracle.com>
	Cc: <stable@vger.kernel.org>    [v2.6.38+]
	Cc: Mimi Zohar <zohar@linux.vnet.ibm.com>
	Cc: David Safford <safford@us.ibm.com>
	Signed-off-by: Eric Biggers <ebiggers@google.com>
	Signed-off-by: David Howells <dhowells@redhat.com>
(cherry picked from commit 13923d0865ca96312197962522e88bc0aedccd74)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	security/keys/encrypted-keys/encrypted.c
diff --cc security/keys/encrypted-keys/encrypted.c
index f03ff1a51afe,535db141f4da..000000000000
--- a/security/keys/encrypted-keys/encrypted.c
+++ b/security/keys/encrypted-keys/encrypted.c
@@@ -307,7 -308,14 +307,18 @@@ static struct key *request_user_key(con
  		goto error;
  
  	down_read(&ukey->sem);
++<<<<<<< HEAD
 +	upayload = ukey->payload.data;
++=======
+ 	upayload = user_key_payload_locked(ukey);
+ 	if (!upayload) {
+ 		/* key was revoked before we acquired its semaphore */
+ 		up_read(&ukey->sem);
+ 		key_put(ukey);
+ 		ukey = ERR_PTR(-EKEYREVOKED);
+ 		goto error;
+ 	}
++>>>>>>> 13923d0865ca (KEYS: encrypted: fix dereference of NULL user_key_payload)
  	*master_key = upayload->data;
  	*master_keylen = upayload->datalen;
  error:
* Unmerged path security/keys/encrypted-keys/encrypted.c
