xfrm: fix null pointer dereference on state and tmpl sort

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Koichiro Den <den@klaipeden.com>
commit 3f5a95ad6c6c05e6b00f0c20e30da66c986564d5
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/3f5a95ad.failed

Creating sub policy that matches the same outer flow as main policy does
leads to a null pointer dereference if the outer mode's family is ipv4.
For userspace compatibility, this patch just eliminates the crash i.e.,
does not introduce any new sorting rule, which would fruitlessly affect
all but the aforementioned case.

	Signed-off-by: Koichiro Den <den@klaipeden.com>
	Signed-off-by: Steffen Klassert <steffen.klassert@secunet.com>
(cherry picked from commit 3f5a95ad6c6c05e6b00f0c20e30da66c986564d5)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/xfrm/xfrm_state.c
diff --cc net/xfrm/xfrm_state.c
index 118bfa4ed345,a792effdb0b5..000000000000
--- a/net/xfrm/xfrm_state.c
+++ b/net/xfrm/xfrm_state.c
@@@ -1441,11 -1626,14 +1442,19 @@@ xfrm_tmpl_sort(struct xfrm_tmpl **dst, 
  	if (!afinfo)
  		return -EAFNOSUPPORT;
  
 -	spin_lock_bh(&net->xfrm.xfrm_state_lock); /*FIXME*/
 +	spin_lock_bh(&net->xfrm_state_lock); /*FIXME*/
  	if (afinfo->tmpl_sort)
  		err = afinfo->tmpl_sort(dst, src, n);
++<<<<<<< HEAD
 +	spin_unlock_bh(&net->xfrm_state_lock);
 +	xfrm_state_put_afinfo(afinfo);
++=======
+ 	else
+ 		for (i = 0; i < n; i++)
+ 			dst[i] = src[i];
+ 	spin_unlock_bh(&net->xfrm.xfrm_state_lock);
+ 	rcu_read_unlock();
++>>>>>>> 3f5a95ad6c6c (xfrm: fix null pointer dereference on state and tmpl sort)
  	return err;
  }
  EXPORT_SYMBOL(xfrm_tmpl_sort);
@@@ -1461,11 -1650,14 +1471,19 @@@ xfrm_state_sort(struct xfrm_state **dst
  	if (!afinfo)
  		return -EAFNOSUPPORT;
  
 -	spin_lock_bh(&net->xfrm.xfrm_state_lock);
 +	spin_lock_bh(&net->xfrm_state_lock);
  	if (afinfo->state_sort)
  		err = afinfo->state_sort(dst, src, n);
++<<<<<<< HEAD
 +	spin_unlock_bh(&net->xfrm_state_lock);
 +	xfrm_state_put_afinfo(afinfo);
++=======
+ 	else
+ 		for (i = 0; i < n; i++)
+ 			dst[i] = src[i];
+ 	spin_unlock_bh(&net->xfrm.xfrm_state_lock);
+ 	rcu_read_unlock();
++>>>>>>> 3f5a95ad6c6c (xfrm: fix null pointer dereference on state and tmpl sort)
  	return err;
  }
  EXPORT_SYMBOL(xfrm_state_sort);
* Unmerged path net/xfrm/xfrm_state.c
