ceph: simplify 'offset in frag'

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Yan, Zheng <zyan@redhat.com>
commit a78600e7c4fb47fb5ef34265456b731fde27a9c3
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/a78600e7.failed

don't distinguish leftmost frag from other frags. always use 2 as
first entry's offset.

	Signed-off-by: Yan, Zheng <zyan@redhat.com>
(cherry picked from commit a78600e7c4fb47fb5ef34265456b731fde27a9c3)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/ceph/dir.c
diff --cc fs/ceph/dir.c
index f5abab663b08,31a2cdf39210..000000000000
--- a/fs/ceph/dir.c
+++ b/fs/ceph/dir.c
@@@ -381,15 -414,12 +381,12 @@@ more
  		if (req->r_reply_info.dir_end) {
  			kfree(fi->last_name);
  			fi->last_name = NULL;
- 			if (ceph_frag_is_rightmost(frag))
- 				fi->next_offset = 2;
- 			else
- 				fi->next_offset = 0;
+ 			fi->next_offset = 2;
  		} else {
  			err = note_last_dentry(fi,
 -				       rinfo->dir_dname[rinfo->dir_nr-1],
 -				       rinfo->dir_dname_len[rinfo->dir_nr-1],
 -				       fi->next_offset + rinfo->dir_nr);
 +					rinfo->dir_dname[rinfo->dir_nr-1],
 +					rinfo->dir_dname_len[rinfo->dir_nr-1],
 +					fi->next_offset + rinfo->dir_nr);
  			if (err)
  				return err;
  		}
@@@ -435,8 -465,8 +432,13 @@@
  	/* more frags? */
  	if (!ceph_frag_is_rightmost(frag)) {
  		frag = ceph_frag_next(frag);
++<<<<<<< HEAD
 +		off = 0;
 +		filp->f_pos = ceph_make_fpos(frag, off);
++=======
+ 		off = 2;
+ 		ctx->pos = ceph_make_fpos(frag, off);
++>>>>>>> a78600e7c4fb (ceph: simplify 'offset in frag')
  		dout("readdir next frag is %x\n", frag);
  		goto more;
  	}
* Unmerged path fs/ceph/dir.c
diff --git a/fs/ceph/inode.c b/fs/ceph/inode.c
index 6c32293bcdc3..6befa33a9f89 100644
--- a/fs/ceph/inode.c
+++ b/fs/ceph/inode.c
@@ -1416,10 +1416,7 @@ int ceph_readdir_prepopulate(struct ceph_mds_request *req,
 		dout("readdir_prepopulate got new frag %x -> %x\n",
 		     frag, le32_to_cpu(rinfo->dir_dir->frag));
 		frag = le32_to_cpu(rinfo->dir_dir->frag);
-		if (ceph_frag_is_leftmost(frag))
-			req->r_readdir_offset = 2;
-		else
-			req->r_readdir_offset = 0;
+		req->r_readdir_offset = 2;
 	}
 
 	if (le32_to_cpu(rinfo->head->op) == CEPH_MDS_OP_LSSNAP) {
