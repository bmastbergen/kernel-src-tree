blk-mq: Only unregister hctxs for which registration succeeded

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Bart Van Assche <bart.vanassche@sandisk.com>
commit f05d1ba7871a2c20ca9ebb303aac89c9296d1f58
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/f05d1ba7.failed

Hctx unregistration involves calling kobject_del(). kobject_del()
must not be called if kobject_add() has not been called. Hence in
the error path only unregister hctxs for which registration succeeded.

	Signed-off-by: Bart Van Assche <bart.vanassche@sandisk.com>
	Cc: Omar Sandoval <osandov@fb.com>
	Cc: Hannes Reinecke <hare@suse.com>
	Signed-off-by: Jens Axboe <axboe@fb.com>
(cherry picked from commit f05d1ba7871a2c20ca9ebb303aac89c9296d1f58)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	block/blk-mq-sysfs.c
diff --cc block/blk-mq-sysfs.c
index 44799e473f05,ec0afdf765e3..000000000000
--- a/block/blk-mq-sysfs.c
+++ b/block/blk-mq-sysfs.c
@@@ -439,15 -321,35 +439,42 @@@ int blk_mq_register_dev(struct device *
  	queue_for_each_hw_ctx(q, hctx, i) {
  		ret = blk_mq_register_hctx(hctx);
  		if (ret)
- 			break;
+ 			goto unreg;
  	}
  
++<<<<<<< HEAD
 +	if (ret)
 +		__blk_mq_unregister_dev(dev, q);
 +	else
 +		q->mq_sysfs_init_done = true;
 +out:
 +	blk_mq_enable_hotplug();
++=======
+ 	q->mq_sysfs_init_done = true;
+ 
+ out:
+ 	return ret;
+ 
+ unreg:
+ 	while (--i >= 0)
+ 		blk_mq_unregister_hctx(q->queue_hw_ctx[i]);
+ 
+ 	blk_mq_debugfs_unregister_mq(q);
+ 
+ 	kobject_uevent(&q->mq_kobj, KOBJ_REMOVE);
+ 	kobject_del(&q->mq_kobj);
+ 	kobject_put(&dev->kobj);
+ 	return ret;
+ }
+ 
+ int blk_mq_register_dev(struct device *dev, struct request_queue *q)
+ {
+ 	int ret;
+ 
+ 	mutex_lock(&q->sysfs_lock);
+ 	ret = __blk_mq_register_dev(dev, q);
+ 	mutex_unlock(&q->sysfs_lock);
++>>>>>>> f05d1ba7871a (blk-mq: Only unregister hctxs for which registration succeeded)
  
  	return ret;
  }
* Unmerged path block/blk-mq-sysfs.c
