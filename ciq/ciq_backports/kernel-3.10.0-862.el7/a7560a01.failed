sysfs: fix use-after-free in sysfs_kill_sb()

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Tejun Heo <tj@kernel.org>
commit a7560a0132cfc93b25d2df1d277a078a05220cf4
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/a7560a01.failed

While restructuring the [u]mount path, 4b93dc9b1c68 ("sysfs, kernfs:
prepare mount path for kernfs") incorrectly updated sysfs_kill_sb() so
that it first kills super_block and then tries to dereference its
namespace tag to drop it.  Fix it by caching namespace tag before
killing the superblock and then drop the cached namespace tag.

	Signed-off-by: Tejun Heo <tj@kernel.org>
	Reported-by: Yuanhan Liu <yuanhan.liu@linux.intel.com>
	Tested-by: Yuanhan Liu <yuanhan.liu@linux.intel.com>
	Tested-by: Vlastimil Babka <vbabka@suse.cz>
Link: http://lkml.kernel.org/g/20131205031051.GC5135@yliu-dev.sh.intel.com
	Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
(cherry picked from commit a7560a0132cfc93b25d2df1d277a078a05220cf4)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/sysfs/mount.c
diff --cc fs/sysfs/mount.c
index 59ee03fe48e1,8d075272cace..000000000000
--- a/fs/sysfs/mount.c
+++ b/fs/sysfs/mount.c
@@@ -142,12 -45,10 +142,19 @@@ static struct dentry *sysfs_mount(struc
  
  static void sysfs_kill_sb(struct super_block *sb)
  {
++<<<<<<< HEAD
 +	struct sysfs_super_info *info = sysfs_info(sb);
 +	/* Remove the superblock from fs_supers/s_instances
 +	 * so we can't find it, before freeing sysfs_super_info.
 +	 */
 +	kill_anon_super(sb);
 +	free_sysfs_super_info(info);
++=======
+ 	void *ns = (void *)kernfs_super_ns(sb);
+ 
+ 	kernfs_kill_sb(sb);
+ 	kobj_ns_drop(KOBJ_NS_TYPE_NET, ns);
++>>>>>>> a7560a0132cf (sysfs: fix use-after-free in sysfs_kill_sb())
  }
  
  static struct file_system_type sysfs_fs_type = {
* Unmerged path fs/sysfs/mount.c
