mlxsw: spectrum_router: Demultiplex FIB event based on family

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Ido Schimmel <idosch@mellanox.com>
commit 66a5763ac180d43f4a16770791669dc1e085cd5d
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/66a5763a.failed

The FIB notification block currently only handles IPv4 events, but we
want to start handling IPv6 events soon, so lay the groundwork now.

Do that by preparing the work item and process it according to the
notified address family.

	Signed-off-by: Ido Schimmel <idosch@mellanox.com>
	Signed-off-by: Jiri Pirko <jiri@mellanox.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 66a5763ac180d43f4a16770791669dc1e085cd5d)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlxsw/spectrum_router.c
diff --cc drivers/net/ethernet/mellanox/mlxsw/spectrum_router.c
index cd0a7dcb3528,166ecf5d58f1..000000000000
--- a/drivers/net/ethernet/mellanox/mlxsw/spectrum_router.c
+++ b/drivers/net/ethernet/mellanox/mlxsw/spectrum_router.c
@@@ -2733,25 -3136,18 +2769,30 @@@ static int mlxsw_sp_router_fib_event(st
  	if (WARN_ON(!fib_work))
  		return NOTIFY_BAD;
  
++<<<<<<< HEAD
 +	INIT_WORK(&fib_work->work, mlxsw_sp_router_fib_event_work);
 +	fib_work->mlxsw_sp = mlxsw_sp;
++=======
+ 	router = container_of(nb, struct mlxsw_sp_router, fib_nb);
+ 	fib_work->mlxsw_sp = router->mlxsw_sp;
++>>>>>>> 66a5763ac180 (mlxsw: spectrum_router: Demultiplex FIB event based on family)
  	fib_work->event = event;
  
- 	switch (event) {
- 	case FIB_EVENT_ENTRY_REPLACE: /* fall through */
- 	case FIB_EVENT_ENTRY_APPEND: /* fall through */
- 	case FIB_EVENT_ENTRY_ADD: /* fall through */
- 	case FIB_EVENT_ENTRY_DEL:
- 		memcpy(&fib_work->fen_info, ptr, sizeof(fib_work->fen_info));
- 		/* Take referece on fib_info to prevent it from being
- 		 * freed while work is queued. Release it afterwards.
- 		 */
- 		fib_info_hold(fib_work->fen_info.fi);
+ 	switch (info->family) {
+ 	case AF_INET:
+ 		INIT_WORK(&fib_work->work, mlxsw_sp_router_fib4_event_work);
+ 		mlxsw_sp_router_fib4_event(fib_work, info);
  		break;
 -	case AF_INET6:
++<<<<<<< HEAD
 +	case FIB_EVENT_NH_ADD: /* fall through */
 +	case FIB_EVENT_NH_DEL:
 +		memcpy(&fib_work->fnh_info, ptr, sizeof(fib_work->fnh_info));
 +		fib_info_hold(fib_work->fnh_info.fib_nh->nh_parent);
++=======
++	case AF_INET6:
+ 		INIT_WORK(&fib_work->work, mlxsw_sp_router_fib6_event_work);
+ 		mlxsw_sp_router_fib6_event(fib_work, info);
++>>>>>>> 66a5763ac180 (mlxsw: spectrum_router: Demultiplex FIB event based on family)
  		break;
  	}
  
* Unmerged path drivers/net/ethernet/mellanox/mlxsw/spectrum_router.c
