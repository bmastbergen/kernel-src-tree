scsi_dh_alua: Add new blacklist flag 'BLIST_SYNC_ALUA'

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Hannes Reinecke <hare@suse.de>
commit 851cde9909dd8b6fb90fab7f4e815c8f86c85a0d
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/851cde99.failed

Add a new blacklist flag BLIST_SYNC_ALUA to instruct the
alua device handler to use synchronous command submission
for ALUA commands.

	Reviewed-by: Bart Van Assche <bart.vanassche@sandisk.com>
	Reviewed-by: Christoph Hellwig <hch@lst.de>
	Signed-off-by: Hannes Reinecke <hare@suse.com>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit 851cde9909dd8b6fb90fab7f4e815c8f86c85a0d)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/device_handler/scsi_dh_alua.c
#	include/scsi/scsi_device.h
diff --cc drivers/scsi/device_handler/scsi_dh_alua.c
index 9c9d9c3d8e9b,fbbe85e750a8..000000000000
--- a/drivers/scsi/device_handler/scsi_dh_alua.c
+++ b/drivers/scsi/device_handler/scsi_dh_alua.c
@@@ -240,14 -348,33 +240,33 @@@ static int alua_check_vpd(struct scsi_d
  			    ALUA_DH_NAME);
  		return SCSI_DH_DEV_UNSUPP;
  	}
 +	h->state = TPGS_STATE_OPTIMIZED;
 +	h->group_id = group_id;
  
 -	pg = alua_alloc_pg(sdev, group_id, tpgs);
 -	if (IS_ERR(pg)) {
 -		if (PTR_ERR(pg) == -ENOMEM)
 -			return SCSI_DH_NOMEM;
 -		return SCSI_DH_DEV_UNSUPP;
 -	}
  	sdev_printk(KERN_INFO, sdev,
 -		    "%s: device %s port group %x rel port %x\n",
 -		    ALUA_DH_NAME, pg->device_id_str, group_id, rel_port);
 +		    "%s: port group %02x rel port %02x\n",
 +		    ALUA_DH_NAME, h->group_id, h->rel_port);
  
++<<<<<<< HEAD
 +	return 0;
++=======
+ 	/* Check for existing port group references */
+ 	spin_lock(&h->pg_lock);
+ 	old_pg = h->pg;
+ 	if (old_pg != pg) {
+ 		/* port group has changed. Update to new port group */
+ 		rcu_assign_pointer(h->pg, pg);
+ 	}
+ 	if (sdev->synchronous_alua)
+ 		pg->flags |= ALUA_SYNC_STPG;
+ 	alua_rtpg_queue(h->pg, sdev, NULL);
+ 	spin_unlock(&h->pg_lock);
+ 
+ 	if (old_pg)
+ 		kref_put(&old_pg->kref, release_port_group);
+ 
+ 	return SCSI_DH_OK;
++>>>>>>> 851cde9909dd (scsi_dh_alua: Add new blacklist flag 'BLIST_SYNC_ALUA')
  }
  
  static char print_alua_state(int state)
diff --cc include/scsi/scsi_device.h
index f9f22c6490d8,4af2b240c4d1..000000000000
--- a/include/scsi/scsi_device.h
+++ b/include/scsi/scsi_device.h
@@@ -179,16 -175,8 +179,21 @@@ struct scsi_device 
  	unsigned wce_default_on:1;	/* Cache is ON by default */
  	unsigned no_dif:1;	/* T10 PI (DIF) should be disabled */
  	unsigned broken_fua:1;		/* Don't set FUA bit */
++<<<<<<< HEAD
 +
 +	/* FOR RH USE ONLY
 +	 *
 +	 * The following padding has been inserted before ABI freeze to
 +	 * allow extending the structure while preserving ABI.
 +	 */
 +	unsigned vpd_reserved:1;
 +	unsigned xcopy_reserved:1;
 +	RH_KABI_FILL_HOLE(unsigned lun_in_cdb:1) /* Store LUN bits in CDB[1] */
 +	RH_KABI_FILL_HOLE(unsigned try_vpd_pages:1)	/* attempt to read VPD pages */
++=======
+ 	unsigned lun_in_cdb:1;		/* Store LUN bits in CDB[1] */
+ 	unsigned synchronous_alua:1;	/* Synchronous ALUA commands */
++>>>>>>> 851cde9909dd (scsi_dh_alua: Add new blacklist flag 'BLIST_SYNC_ALUA')
  
  	atomic_t disk_events_disable_depth; /* disable depth for disk events */
  
* Unmerged path drivers/scsi/device_handler/scsi_dh_alua.c
diff --git a/drivers/scsi/scsi_devinfo.c b/drivers/scsi/scsi_devinfo.c
index 09bbd3ff36da..ff41c310c900 100644
--- a/drivers/scsi/scsi_devinfo.c
+++ b/drivers/scsi/scsi_devinfo.c
@@ -220,6 +220,8 @@ static struct {
 	{"NAKAMICH", "MJ-5.16S", NULL, BLIST_FORCELUN | BLIST_SINGLELUN},
 	{"NEC", "PD-1 ODX654P", NULL, BLIST_FORCELUN | BLIST_SINGLELUN},
 	{"NEC", "iStorage", NULL, BLIST_REPORTLUN2},
+	{"NETAPP", "LUN C-Mode", NULL, BLIST_SYNC_ALUA},
+	{"NETAPP", "INF-01-00", NULL, BLIST_SYNC_ALUA},
 	{"NRC", "MBR-7", NULL, BLIST_FORCELUN | BLIST_SINGLELUN},
 	{"NRC", "MBR-7.4", NULL, BLIST_FORCELUN | BLIST_SINGLELUN},
 	{"PIONEER", "CD-ROM DRM-600", NULL, BLIST_FORCELUN | BLIST_SINGLELUN},
diff --git a/drivers/scsi/scsi_scan.c b/drivers/scsi/scsi_scan.c
index 9d2bb350e527..24cb6df37f17 100644
--- a/drivers/scsi/scsi_scan.c
+++ b/drivers/scsi/scsi_scan.c
@@ -984,6 +984,9 @@ static int scsi_add_lun(struct scsi_device *sdev, unsigned char *inq_result,
 	if (*bflags & BLIST_NO_DIF)
 		sdev->no_dif = 1;
 
+	if (*bflags & BLIST_SYNC_ALUA)
+		sdev->synchronous_alua = 1;
+
 	sdev->eh_timeout = SCSI_DEFAULT_EH_TIMEOUT;
 
 	if (*bflags & BLIST_TRY_VPD_PAGES)
* Unmerged path include/scsi/scsi_device.h
diff --git a/include/scsi/scsi_devinfo.h b/include/scsi/scsi_devinfo.h
index c67cd3ea5564..ea3ec54367e7 100644
--- a/include/scsi/scsi_devinfo.h
+++ b/include/scsi/scsi_devinfo.h
@@ -35,5 +35,6 @@
 #define BLIST_TRY_VPD_PAGES	0x10000000 /* Attempt to read VPD pages */
 #define BLIST_NO_RSOC		0x20000000 /* don't try to issue RSOC */
 #define BLIST_MAX_1024		0x40000000 /* maximum 1024 sector cdb length */
+#define BLIST_SYNC_ALUA		0x80000000 /* Synchronous ALUA commands */
 
 #endif
