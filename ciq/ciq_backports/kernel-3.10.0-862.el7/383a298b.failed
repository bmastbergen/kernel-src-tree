scsi: qla2xxx: Retain loop test for fwdump length exceeding buffer length

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
Rebuild_CHGLOG: - [scsi] qla2xxx: Retain loop test for fwdump length exceeding buffer length (Himanshu Madhani) [1460030]
Rebuild_FUZZ: 95.71%
commit-author Joe Carnuccio <joe.carnuccio@cavium.com>
commit 383a298b2065a6f39f4ab2c33d84620ccad578f9
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/383a298b.failed

	Signed-off-by: Joe Carnuccio <joe.carnuccio@cavium.com>
	Signed-off-by: Himanshu Madhani <himanshu.madhani@cavium.com>
	Reviewed-by: Bart Van Assche <Bart.VanAssche@sandisk.com>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit 383a298b2065a6f39f4ab2c33d84620ccad578f9)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/qla2xxx/qla_init.c
diff --cc drivers/scsi/qla2xxx/qla_init.c
index b9189cae77e5,e4876f4220e4..000000000000
--- a/drivers/scsi/qla2xxx/qla_init.c
+++ b/drivers/scsi/qla2xxx/qla_init.c
@@@ -5466,7 -6357,7 +5466,11 @@@ qla24xx_load_risc_flash(scsi_qla_host_
  	if (dlen > risc_size * sizeof(*dcode)) {
  		ql_log(ql_log_warn, vha, 0x0167,
  		    "Failed fwdump template exceeds array by %lx bytes\n",
++<<<<<<< HEAD
 +		    dlen - risc_size * sizeof(*dcode));
++=======
+ 		    (size_t)(dlen - risc_size * sizeof(*dcode)));
++>>>>>>> 383a298b2065 (scsi: qla2xxx: Retain loop test for fwdump length exceeding buffer length)
  		goto default_template;
  	}
  	ha->fw_dump_template_len = dlen;
@@@ -5768,7 -6659,7 +5772,11 @@@ qla24xx_load_risc_blob(scsi_qla_host_t 
  	if (dlen > risc_size * sizeof(*fwcode)) {
  		ql_log(ql_log_warn, vha, 0x0177,
  		    "Failed fwdump template exceeds array by %lx bytes\n",
++<<<<<<< HEAD
 +		    dlen - risc_size * sizeof(*fwcode));
++=======
+ 		    (size_t)(dlen - risc_size * sizeof(*fwcode)));
++>>>>>>> 383a298b2065 (scsi: qla2xxx: Retain loop test for fwdump length exceeding buffer length)
  		goto default_template;
  	}
  	ha->fw_dump_template_len = dlen;
* Unmerged path drivers/scsi/qla2xxx/qla_init.c
diff --git a/drivers/scsi/qla2xxx/qla_tmpl.c b/drivers/scsi/qla2xxx/qla_tmpl.c
index 2e2b21fc1de4..9bc2b672c172 100644
--- a/drivers/scsi/qla2xxx/qla_tmpl.c
+++ b/drivers/scsi/qla2xxx/qla_tmpl.c
@@ -219,8 +219,6 @@ qla27xx_skip_entry(struct qla27xx_fwdt_entry *ent, void *buf)
 {
 	if (buf)
 		ent->hdr.driver_flags |= DRIVER_FLAG_SKIP_ENTRY;
-	ql_dbg(ql_dbg_misc + ql_dbg_verbose, NULL, 0xd011,
-	    "Skipping entry %d\n", ent->hdr.entry_type);
 }
 
 static int
@@ -802,6 +800,8 @@ qla27xx_walk_template(struct scsi_qla_host *vha,
 	ql_dbg(ql_dbg_misc, vha, 0xd01a,
 	    "%s: entry count %lx\n", __func__, count);
 	while (count--) {
+		if (buf && *len >= vha->hw->fw_dump_len)
+			break;
 		if (qla27xx_find_entry(ent->hdr.entry_type)(vha, ent, buf, len))
 			break;
 		ent = qla27xx_next_entry(ent);
@@ -809,18 +809,20 @@ qla27xx_walk_template(struct scsi_qla_host *vha,
 
 	if (count)
 		ql_dbg(ql_dbg_misc, vha, 0xd018,
-		    "%s: residual count (%lx)\n", __func__, count);
+		    "%s: entry residual count (%lx)\n", __func__, count);
 
 	if (ent->hdr.entry_type != ENTRY_TYPE_TMP_END)
 		ql_dbg(ql_dbg_misc, vha, 0xd019,
-		    "%s: missing end (%lx)\n", __func__, count);
+		    "%s: missing end entry (%lx)\n", __func__, count);
 
-	ql_dbg(ql_dbg_misc, vha, 0xd01b,
-	    "%s: len=%lx\n", __func__, *len);
+	if (buf && *len != vha->hw->fw_dump_len)
+		ql_dbg(ql_dbg_misc, vha, 0xd01b,
+		    "%s: length=%#lx residual=%+ld\n",
+		    __func__, *len, vha->hw->fw_dump_len - *len);
 
 	if (buf) {
 		ql_log(ql_log_warn, vha, 0xd015,
-		    "Firmware dump saved to temp buffer (%ld/%p)\n",
+		    "Firmware dump saved to temp buffer (%lu/%p)\n",
 		    vha->host_no, vha->hw->fw_dump);
 		qla2x00_post_uevent_work(vha, QLA_UEVENT_CODE_FW_DUMP);
 	}
