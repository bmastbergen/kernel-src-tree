mlxsw: spectrum_router: Fix build when IPv6 isn't enabled

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Ido Schimmel <idosch@mellanox.com>
commit b5f3e0d430122a551cbc2b88068dae8b2c2c0031
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/b5f3e0d4.failed

When IPv6 isn't enabled the following error is generated:

ERROR: "nd_tbl" [drivers/net/ethernet/mellanox/mlxsw/mlxsw_spectrum.ko]
undefined!

Fix it by replacing 'arp_tbl' and 'nd_tbl' with 'tbl->family' wherever
possible and reference 'nd_tbl' only when IPV6 is enabled.

Fixes: d5eb89cf68d6 ("mlxsw: spectrum_router: Reflect IPv6 neighbours to the device")
	Signed-off-by: Ido Schimmel <idosch@mellanox.com>
	Reported-by: kbuild test robot <fengguang.wu@intel.com>
	Signed-off-by: Jiri Pirko <jiri@mellanox.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit b5f3e0d430122a551cbc2b88068dae8b2c2c0031)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlxsw/spectrum_router.c
diff --cc drivers/net/ethernet/mellanox/mlxsw/spectrum_router.c
index 413d3ee4abb7,8bf076d22fb6..000000000000
--- a/drivers/net/ethernet/mellanox/mlxsw/spectrum_router.c
+++ b/drivers/net/ethernet/mellanox/mlxsw/spectrum_router.c
@@@ -42,6 -42,8 +42,11 @@@
  #include <linux/notifier.h>
  #include <linux/inetdevice.h>
  #include <linux/netdevice.h>
++<<<<<<< HEAD
++=======
+ #include <linux/if_bridge.h>
+ #include <linux/socket.h>
++>>>>>>> b5f3e0d43012 (mlxsw: spectrum_router: Fix build when IPv6 isn't enabled)
  #include <net/netevent.h>
  #include <net/neighbour.h>
  #include <net/arp.h>
@@@ -665,9 -948,16 +670,20 @@@ mlxsw_sp_neigh_entry_lookup(struct mlxs
  static void
  mlxsw_sp_router_neighs_update_interval_init(struct mlxsw_sp *mlxsw_sp)
  {
 -	unsigned long interval;
 +	unsigned long interval = NEIGH_VAR(&arp_tbl.parms, DELAY_PROBE_TIME);
  
++<<<<<<< HEAD
 +	mlxsw_sp->router.neighs_update.interval = jiffies_to_msecs(interval);
++=======
+ #if IS_ENABLED(CONFIG_IPV6)
+ 	interval = min_t(unsigned long,
+ 			 NEIGH_VAR(&arp_tbl.parms, DELAY_PROBE_TIME),
+ 			 NEIGH_VAR(&nd_tbl.parms, DELAY_PROBE_TIME));
+ #else
+ 	interval = NEIGH_VAR(&arp_tbl.parms, DELAY_PROBE_TIME);
+ #endif
+ 	mlxsw_sp->router->neighs_update.interval = jiffies_to_msecs(interval);
++>>>>>>> b5f3e0d43012 (mlxsw: spectrum_router: Fix build when IPv6 isn't enabled)
  }
  
  static void mlxsw_sp_router_neigh_ent_ipv4_process(struct mlxsw_sp *mlxsw_sp,
@@@ -947,11 -1273,17 +971,23 @@@ mlxsw_sp_neigh_entry_update(struct mlxs
  	if (!adding && !neigh_entry->connected)
  		return;
  	neigh_entry->connected = adding;
++<<<<<<< HEAD
 +	if (neigh_entry->key.n->tbl == &arp_tbl)
 +		mlxsw_sp_router_neigh_entry_op4(mlxsw_sp, neigh_entry,
 +						mlxsw_sp_rauht_op(adding));
 +	else
++=======
+ 	if (neigh_entry->key.n->tbl->family == AF_INET) {
+ 		mlxsw_sp_router_neigh_entry_op4(mlxsw_sp, neigh_entry,
+ 						mlxsw_sp_rauht_op(adding));
+ 	} else if (neigh_entry->key.n->tbl->family == AF_INET6) {
+ 		if (mlxsw_sp_neigh_ipv6_ignore(neigh_entry->key.n))
+ 			return;
+ 		mlxsw_sp_router_neigh_entry_op6(mlxsw_sp, neigh_entry,
+ 						mlxsw_sp_rauht_op(adding));
+ 	} else {
++>>>>>>> b5f3e0d43012 (mlxsw: spectrum_router: Fix build when IPv6 isn't enabled)
  		WARN_ON_ONCE(1);
 -	}
  }
  
  struct mlxsw_sp_neigh_event_work {
@@@ -1020,7 -1352,8 +1056,12 @@@ int mlxsw_sp_router_netevent_event(stru
  		p = ptr;
  
  		/* We don't care about changes in the default table. */
++<<<<<<< HEAD
 +		if (!p->dev || p->tbl != &arp_tbl)
++=======
+ 		if (!p->dev || (p->tbl->family != AF_INET &&
+ 				p->tbl->family != AF_INET6))
++>>>>>>> b5f3e0d43012 (mlxsw: spectrum_router: Fix build when IPv6 isn't enabled)
  			return NOTIFY_DONE;
  
  		/* We are in atomic context and can't take RTNL mutex,
@@@ -1039,7 -1372,7 +1080,11 @@@
  	case NETEVENT_NEIGH_UPDATE:
  		n = ptr;
  
++<<<<<<< HEAD
 +		if (n->tbl != &arp_tbl)
++=======
+ 		if (n->tbl->family != AF_INET && n->tbl->family != AF_INET6)
++>>>>>>> b5f3e0d43012 (mlxsw: spectrum_router: Fix build when IPv6 isn't enabled)
  			return NOTIFY_DONE;
  
  		mlxsw_sp_port = mlxsw_sp_port_lower_dev_hold(n->dev);
* Unmerged path drivers/net/ethernet/mellanox/mlxsw/spectrum_router.c
