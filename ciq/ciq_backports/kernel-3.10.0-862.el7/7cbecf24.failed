mlxsw: spectrum_router: Replace vPorts with Port-VLAN

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Ido Schimmel <idosch@mellanox.com>
commit 7cbecf245ade1739f34e00a10b2cdedd851bd7f4
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/7cbecf24.failed

We're going to get rid of vPorts completely later in the patchset, but
the router code is self-contained, so it's a good candidate to start the
transition with.

Convert all the functions that expects to operate on a vPort to operate
on a Port-VLAN instead.

	Signed-off-by: Ido Schimmel <idosch@mellanox.com>
	Signed-off-by: Jiri Pirko <jiri@mellanox.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 7cbecf245ade1739f34e00a10b2cdedd851bd7f4)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlxsw/spectrum.c
#	drivers/net/ethernet/mellanox/mlxsw/spectrum_router.c
diff --cc drivers/net/ethernet/mellanox/mlxsw/spectrum.c
index 4a2dd98ae919,e04d2ed34d7e..000000000000
--- a/drivers/net/ethernet/mellanox/mlxsw/spectrum.c
+++ b/drivers/net/ethernet/mellanox/mlxsw/spectrum.c
@@@ -1471,6 -1480,33 +1471,36 @@@ static void mlxsw_sp_port_vport_destroy
  	kfree(mlxsw_sp_vport);
  }
  
++<<<<<<< HEAD
++=======
+ static struct mlxsw_sp_port_vlan *
+ mlxsw_sp_port_vlan_create(struct mlxsw_sp_port *mlxsw_sp_port, u16 vid)
+ {
+ 	struct mlxsw_sp_port_vlan *mlxsw_sp_port_vlan;
+ 
+ 	mlxsw_sp_port_vlan = kzalloc(sizeof(*mlxsw_sp_port_vlan), GFP_KERNEL);
+ 	if (!mlxsw_sp_port_vlan)
+ 		return ERR_PTR(-ENOMEM);
+ 
+ 	mlxsw_sp_port_vlan->mlxsw_sp_port = mlxsw_sp_port;
+ 	mlxsw_sp_port_vlan->vid = vid;
+ 	list_add(&mlxsw_sp_port_vlan->list, &mlxsw_sp_port->vlans_list);
+ 
+ 	return mlxsw_sp_port_vlan;
+ }
+ 
+ static void
+ mlxsw_sp_port_vlan_destroy(struct mlxsw_sp_port_vlan *mlxsw_sp_port_vlan)
+ {
+ 	struct mlxsw_sp_fid *fid = mlxsw_sp_port_vlan->fid;
+ 
+ 	if (fid && !WARN_ON(!fid->leave))
+ 		fid->leave(mlxsw_sp_port_vlan);
+ 	list_del(&mlxsw_sp_port_vlan->list);
+ 	kfree(mlxsw_sp_port_vlan);
+ }
+ 
++>>>>>>> 7cbecf245ade (mlxsw: spectrum_router: Replace vPorts with Port-VLAN)
  static int mlxsw_sp_port_add_vid(struct net_device *dev,
  				 __be16 __always_unused proto, u16 vid)
  {
diff --cc drivers/net/ethernet/mellanox/mlxsw/spectrum_router.c
index f8e7036e3f4a,ef8e8a12c001..000000000000
--- a/drivers/net/ethernet/mellanox/mlxsw/spectrum_router.c
+++ b/drivers/net/ethernet/mellanox/mlxsw/spectrum_router.c
@@@ -2688,36 -2911,29 +2688,51 @@@ static int mlxsw_sp_avail_rif_get(struc
  	int i;
  
  	for (i = 0; i < MLXSW_CORE_RES_GET(mlxsw_sp->core, MAX_RIFS); i++)
 -		if (!mlxsw_sp->router->rifs[i])
 +		if (!mlxsw_sp->rifs[i])
  			return i;
  
 -	return MLXSW_SP_INVALID_INDEX_RIF;
 +	return MLXSW_SP_INVALID_RIF;
  }
  
- static void mlxsw_sp_vport_rif_sp_attr_get(struct mlxsw_sp_port *mlxsw_sp_vport,
- 					   bool *p_lagged, u16 *p_system_port)
+ static int
+ mlxsw_sp_port_vlan_rif_sp_op(struct mlxsw_sp_port_vlan *mlxsw_sp_port_vlan,
+ 			     u16 vr_id, struct net_device *l3_dev,
+ 			     u16 rif_index, bool create)
  {
++<<<<<<< HEAD
 +	u8 local_port = mlxsw_sp_vport->local_port;
 +
 +	*p_lagged = mlxsw_sp_vport->lagged;
 +	*p_system_port = *p_lagged ? mlxsw_sp_vport->lag_id : local_port;
 +}
 +
 +static int mlxsw_sp_vport_rif_sp_op(struct mlxsw_sp_port *mlxsw_sp_vport,
 +				    u16 vr_id, struct net_device *l3_dev,
 +				    u16 rif, bool create)
 +{
 +	struct mlxsw_sp *mlxsw_sp = mlxsw_sp_vport->mlxsw_sp;
 +	bool lagged = mlxsw_sp_vport->lagged;
 +	char ritr_pl[MLXSW_REG_RITR_LEN];
 +	u16 system_port;
 +
 +	mlxsw_reg_ritr_pack(ritr_pl, create, MLXSW_REG_RITR_SP_IF, rif, vr_id,
 +			    l3_dev->mtu, l3_dev->dev_addr);
 +
 +	mlxsw_sp_vport_rif_sp_attr_get(mlxsw_sp_vport, &lagged, &system_port);
++=======
+ 	struct mlxsw_sp_port *mlxsw_sp_port = mlxsw_sp_port_vlan->mlxsw_sp_port;
+ 	struct mlxsw_sp *mlxsw_sp = mlxsw_sp_port->mlxsw_sp;
+ 	bool lagged = mlxsw_sp_port->lagged;
+ 	char ritr_pl[MLXSW_REG_RITR_LEN];
+ 	u16 system_port;
+ 
+ 	system_port = lagged ? mlxsw_sp_port->lag_id :
+ 			       mlxsw_sp_port->local_port;
+ 	mlxsw_reg_ritr_pack(ritr_pl, create, MLXSW_REG_RITR_SP_IF, rif_index,
+ 			    vr_id, l3_dev->mtu, l3_dev->dev_addr);
++>>>>>>> 7cbecf245ade (mlxsw: spectrum_router: Replace vPorts with Port-VLAN)
  	mlxsw_reg_ritr_sp_if_pack(ritr_pl, lagged, system_port,
- 				  mlxsw_sp_vport_vid_get(mlxsw_sp_vport));
+ 				  mlxsw_sp_port_vlan->vid);
  
  	return mlxsw_reg_write(mlxsw_sp->core, MLXSW_REG(ritr), ritr_pl);
  }
@@@ -2769,30 -3002,32 +2784,41 @@@ mlxsw_sp_rif_alloc(u16 rif, u16 vr_id, 
  }
  
  static struct mlxsw_sp_rif *
- mlxsw_sp_vport_rif_sp_create(struct mlxsw_sp_port *mlxsw_sp_vport,
- 			     struct net_device *l3_dev)
+ mlxsw_sp_port_vlan_rif_sp_create(struct mlxsw_sp_port_vlan *mlxsw_sp_port_vlan,
+ 				 struct net_device *l3_dev)
  {
++<<<<<<< HEAD
 +	struct mlxsw_sp *mlxsw_sp = mlxsw_sp_vport->mlxsw_sp;
++=======
+ 	struct mlxsw_sp_port *mlxsw_sp_port = mlxsw_sp_port_vlan->mlxsw_sp_port;
+ 	struct mlxsw_sp *mlxsw_sp = mlxsw_sp_port->mlxsw_sp;
+ 	u32 tb_id = l3mdev_fib_table(l3_dev);
++>>>>>>> 7cbecf245ade (mlxsw: spectrum_router: Replace vPorts with Port-VLAN)
  	struct mlxsw_sp_vr *vr;
  	struct mlxsw_sp_fid *f;
 -	struct mlxsw_sp_rif *rif;
 -	u16 fid, rif_index;
 +	struct mlxsw_sp_rif *r;
 +	u16 fid, rif;
  	int err;
  
 -	rif_index = mlxsw_sp_avail_rif_get(mlxsw_sp);
 -	if (rif_index == MLXSW_SP_INVALID_INDEX_RIF)
 +	rif = mlxsw_sp_avail_rif_get(mlxsw_sp);
 +	if (rif == MLXSW_SP_INVALID_RIF)
  		return ERR_PTR(-ERANGE);
  
 -	vr = mlxsw_sp_vr_get(mlxsw_sp, tb_id ? : RT_TABLE_MAIN);
 +	vr = mlxsw_sp_vr_get(mlxsw_sp, RT_TABLE_MAIN);
  	if (IS_ERR(vr))
  		return ERR_CAST(vr);
  
++<<<<<<< HEAD
 +	err = mlxsw_sp_vport_rif_sp_op(mlxsw_sp_vport, vr->id, l3_dev, rif,
 +				       true);
++=======
+ 	err = mlxsw_sp_port_vlan_rif_sp_op(mlxsw_sp_port_vlan, vr->id, l3_dev,
+ 					   rif_index, true);
++>>>>>>> 7cbecf245ade (mlxsw: spectrum_router: Replace vPorts with Port-VLAN)
  	if (err)
- 		goto err_vport_rif_sp_op;
+ 		goto err_port_vlan_rif_sp_op;
  
 -	fid = mlxsw_sp_rif_sp_to_fid(rif_index);
 +	fid = mlxsw_sp_rif_sp_to_fid(rif);
  	err = mlxsw_sp_rif_fdb_op(mlxsw_sp, l3_dev->dev_addr, fid, true);
  	if (err)
  		goto err_rif_fdb_op;
@@@ -2809,98 -3044,151 +2835,208 @@@
  		goto err_rif_alloc;
  	}
  
++<<<<<<< HEAD
 +	f->r = r;
 +	mlxsw_sp->rifs[rif] = r;
++=======
+ 	if (devlink_dpipe_table_counter_enabled(priv_to_devlink(mlxsw_sp->core),
+ 						MLXSW_SP_DPIPE_TABLE_NAME_ERIF)) {
+ 		err = mlxsw_sp_rif_counter_alloc(mlxsw_sp, rif,
+ 						 MLXSW_SP_RIF_COUNTER_EGRESS);
+ 		if (err)
+ 			netdev_dbg(mlxsw_sp_port->dev,
+ 				   "Counter alloc Failed err=%d\n", err);
+ 	}
+ 
+ 	f->rif = rif;
+ 	mlxsw_sp->router->rifs[rif_index] = rif;
++>>>>>>> 7cbecf245ade (mlxsw: spectrum_router: Replace vPorts with Port-VLAN)
  	vr->rif_count++;
  
 -	return rif;
 +	return r;
  
  err_rif_alloc:
  	kfree(f);
  err_rfid_alloc:
  	mlxsw_sp_rif_fdb_op(mlxsw_sp, l3_dev->dev_addr, fid, false);
  err_rif_fdb_op:
++<<<<<<< HEAD
 +	mlxsw_sp_vport_rif_sp_op(mlxsw_sp_vport, vr->id, l3_dev, rif, false);
 +err_vport_rif_sp_op:
++=======
+ 	mlxsw_sp_port_vlan_rif_sp_op(mlxsw_sp_port_vlan, vr->id, l3_dev,
+ 				     rif_index, false);
+ err_port_vlan_rif_sp_op:
++>>>>>>> 7cbecf245ade (mlxsw: spectrum_router: Replace vPorts with Port-VLAN)
  	mlxsw_sp_vr_put(vr);
  	return ERR_PTR(err);
  }
  
++<<<<<<< HEAD
 +static void mlxsw_sp_vport_rif_sp_destroy(struct mlxsw_sp_port *mlxsw_sp_vport,
 +					  struct mlxsw_sp_rif *r)
 +{
 +	struct mlxsw_sp *mlxsw_sp = mlxsw_sp_vport->mlxsw_sp;
 +	struct mlxsw_sp_vr *vr = &mlxsw_sp->router.vrs[r->vr_id];
 +	struct net_device *l3_dev = r->dev;
 +	struct mlxsw_sp_fid *f = r->f;
++=======
+ static void
+ mlxsw_sp_port_vlan_rif_sp_destroy(struct mlxsw_sp_port_vlan *mlxsw_sp_port_vlan,
+ 				  struct mlxsw_sp_rif *rif)
+ {
+ 	struct mlxsw_sp_port *mlxsw_sp_port = mlxsw_sp_port_vlan->mlxsw_sp_port;
+ 	struct mlxsw_sp *mlxsw_sp = mlxsw_sp_port->mlxsw_sp;
+ 	struct mlxsw_sp_vr *vr = &mlxsw_sp->router->vrs[rif->vr_id];
+ 	struct net_device *l3_dev = rif->dev;
+ 	struct mlxsw_sp_fid *f = rif->f;
+ 	u16 rif_index = rif->rif_index;
++>>>>>>> 7cbecf245ade (mlxsw: spectrum_router: Replace vPorts with Port-VLAN)
  	u16 fid = f->fid;
 +	u16 rif = r->rif;
  
 -	mlxsw_sp_router_rif_gone_sync(mlxsw_sp, rif);
 -
 -	mlxsw_sp_rif_counter_free(mlxsw_sp, rif, MLXSW_SP_RIF_COUNTER_EGRESS);
 -	mlxsw_sp_rif_counter_free(mlxsw_sp, rif, MLXSW_SP_RIF_COUNTER_INGRESS);
 +	mlxsw_sp_router_rif_gone_sync(mlxsw_sp, r);
  
  	vr->rif_count--;
 -	mlxsw_sp->router->rifs[rif_index] = NULL;
 -	f->rif = NULL;
 +	mlxsw_sp->rifs[rif] = NULL;
 +	f->r = NULL;
  
 -	kfree(rif);
 +	kfree(r);
  
  	kfree(f);
  
  	mlxsw_sp_rif_fdb_op(mlxsw_sp, l3_dev->dev_addr, fid, false);
  
++<<<<<<< HEAD
 +	mlxsw_sp_vport_rif_sp_op(mlxsw_sp_vport, vr->id, l3_dev, rif, false);
++=======
+ 	mlxsw_sp_port_vlan_rif_sp_op(mlxsw_sp_port_vlan, vr->id, l3_dev,
+ 				     rif_index, false);
++>>>>>>> 7cbecf245ade (mlxsw: spectrum_router: Replace vPorts with Port-VLAN)
  
  	mlxsw_sp_vr_put(vr);
  }
  
- static int mlxsw_sp_vport_rif_sp_join(struct mlxsw_sp_port *mlxsw_sp_vport,
- 				      struct net_device *l3_dev)
+ static int
+ mlxsw_sp_port_vlan_rif_sp_join(struct mlxsw_sp_port_vlan *mlxsw_sp_port_vlan,
+ 			       struct net_device *l3_dev)
  {
++<<<<<<< HEAD
 +	struct mlxsw_sp *mlxsw_sp = mlxsw_sp_vport->mlxsw_sp;
 +	struct mlxsw_sp_rif *r;
 +
 +	r = mlxsw_sp_rif_find_by_dev(mlxsw_sp, l3_dev);
 +	if (!r) {
 +		r = mlxsw_sp_vport_rif_sp_create(mlxsw_sp_vport, l3_dev);
 +		if (IS_ERR(r))
 +			return PTR_ERR(r);
 +	}
 +
 +	mlxsw_sp_vport_fid_set(mlxsw_sp_vport, r->f);
 +	r->f->ref_count++;
 +
 +	netdev_dbg(mlxsw_sp_vport->dev, "Joined FID=%d\n", r->f->fid);
 +
 +	return 0;
++=======
+ 	struct mlxsw_sp_port *mlxsw_sp_port = mlxsw_sp_port_vlan->mlxsw_sp_port;
+ 	u16 vid = mlxsw_sp_port_vlan->vid;
+ 	struct mlxsw_sp_rif *rif;
+ 	int err;
+ 
+ 	rif = mlxsw_sp_rif_find_by_dev(mlxsw_sp_port->mlxsw_sp, l3_dev);
+ 	if (!rif) {
+ 		rif = mlxsw_sp_port_vlan_rif_sp_create(mlxsw_sp_port_vlan,
+ 						       l3_dev);
+ 		if (IS_ERR(rif))
+ 			return PTR_ERR(rif);
+ 	}
+ 
+ 	err = mlxsw_sp_port_vid_learning_set(mlxsw_sp_port, vid, false);
+ 	if (err)
+ 		goto err_port_vid_learning_set;
+ 
+ 	err = mlxsw_sp_port_vid_stp_set(mlxsw_sp_port, vid,
+ 					BR_STATE_FORWARDING);
+ 	if (err)
+ 		goto err_port_vid_stp_set;
+ 
+ 	if (mlxsw_sp_port->nr_port_vid_map++ == 0) {
+ 		err = mlxsw_sp_port_vp_mode_trans(mlxsw_sp_port);
+ 		if (err)
+ 			goto err_port_vp_mode_trans;
+ 	}
+ 
+ 	mlxsw_sp_port_vlan->fid = rif->f;
+ 	rif->f->ref_count++;
+ 
+ 	return 0;
+ 
+ err_port_vp_mode_trans:
+ 	mlxsw_sp_port->nr_port_vid_map--;
+ 	mlxsw_sp_port_vid_stp_set(mlxsw_sp_port, vid, BR_STATE_BLOCKING);
+ err_port_vid_stp_set:
+ 	mlxsw_sp_port_vid_learning_set(mlxsw_sp_port, vid, true);
+ err_port_vid_learning_set:
+ 	if (rif->f->ref_count == 0)
+ 		mlxsw_sp_port_vlan_rif_sp_destroy(mlxsw_sp_port_vlan, rif);
+ 	return err;
++>>>>>>> 7cbecf245ade (mlxsw: spectrum_router: Replace vPorts with Port-VLAN)
  }
  
 -static void
 -mlxsw_sp_port_vlan_rif_sp_leave(struct mlxsw_sp_port_vlan *mlxsw_sp_port_vlan)
 +static void mlxsw_sp_vport_rif_sp_leave(struct mlxsw_sp_port *mlxsw_sp_vport)
  {
++<<<<<<< HEAD
 +	struct mlxsw_sp_fid *f = mlxsw_sp_vport_fid_get(mlxsw_sp_vport);
 +
 +	netdev_dbg(mlxsw_sp_vport->dev, "Left FID=%d\n", f->fid);
 +
 +	mlxsw_sp_vport_fid_set(mlxsw_sp_vport, NULL);
 +	if (--f->ref_count == 0)
 +		mlxsw_sp_vport_rif_sp_destroy(mlxsw_sp_vport, f->r);
++=======
+ 	struct mlxsw_sp_port *mlxsw_sp_port = mlxsw_sp_port_vlan->mlxsw_sp_port;
+ 	struct mlxsw_sp_fid *fid = mlxsw_sp_port_vlan->fid;
+ 	u16 vid = mlxsw_sp_port_vlan->vid;
+ 
+ 	fid->ref_count--;
+ 	mlxsw_sp_port_vlan->fid = NULL;
+ 
+ 	if (mlxsw_sp_port->nr_port_vid_map == 1)
+ 		mlxsw_sp_port_vlan_mode_trans(mlxsw_sp_port);
+ 	mlxsw_sp_port->nr_port_vid_map--;
+ 	mlxsw_sp_port_vid_stp_set(mlxsw_sp_port, vid, BR_STATE_BLOCKING);
+ 	mlxsw_sp_port_vid_learning_set(mlxsw_sp_port, vid, true);
+ 
+ 	if (fid->ref_count == 0)
+ 		mlxsw_sp_port_vlan_rif_sp_destroy(mlxsw_sp_port_vlan, fid->rif);
++>>>>>>> 7cbecf245ade (mlxsw: spectrum_router: Replace vPorts with Port-VLAN)
  }
  
- static int mlxsw_sp_inetaddr_vport_event(struct net_device *l3_dev,
- 					 struct net_device *port_dev,
- 					 unsigned long event, u16 vid)
+ static int mlxsw_sp_inetaddr_port_vlan_event(struct net_device *l3_dev,
+ 					     struct net_device *port_dev,
+ 					     unsigned long event, u16 vid)
  {
  	struct mlxsw_sp_port *mlxsw_sp_port = netdev_priv(port_dev);
++<<<<<<< HEAD
 +	struct mlxsw_sp_port *mlxsw_sp_vport;
 +
 +	mlxsw_sp_vport = mlxsw_sp_port_vport_find(mlxsw_sp_port, vid);
 +	if (WARN_ON(!mlxsw_sp_vport))
++=======
+ 	struct mlxsw_sp_port_vlan *mlxsw_sp_port_vlan;
+ 
+ 	mlxsw_sp_port_vlan = mlxsw_sp_port_vlan_find_by_vid(mlxsw_sp_port, vid);
+ 	if (WARN_ON(!mlxsw_sp_port_vlan))
++>>>>>>> 7cbecf245ade (mlxsw: spectrum_router: Replace vPorts with Port-VLAN)
  		return -EINVAL;
  
  	switch (event) {
  	case NETDEV_UP:
- 		return mlxsw_sp_vport_rif_sp_join(mlxsw_sp_vport, l3_dev);
+ 		return mlxsw_sp_port_vlan_rif_sp_join(mlxsw_sp_port_vlan,
+ 						      l3_dev);
  	case NETDEV_DOWN:
 -		mlxsw_sp_port_vlan_rif_sp_leave(mlxsw_sp_port_vlan);
 +		mlxsw_sp_vport_rif_sp_leave(mlxsw_sp_vport);
  		break;
  	}
  
* Unmerged path drivers/net/ethernet/mellanox/mlxsw/spectrum.c
* Unmerged path drivers/net/ethernet/mellanox/mlxsw/spectrum_router.c
