qla2xxx: Enhancements to enable NPIV support for QLOGIC ISPs with TCM/LIO.

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
Rebuild_CHGLOG: - [scsi] qla2xxx: Enhancements to enable NPIV support for QLOGIC ISPs with TCM/LIO (Himanshu Madhani) [1327621]
Rebuild_FUZZ: 99.32%
commit-author Saurav Kashyap <saurav.kashyap@qlogic.com>
commit 0e8cd71ceca4c15ef544e3af01248bc869c28d8f
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/0e8cd71c.failed

	Signed-off-by: Sawan Chandak <sawan.chandak@qlogic.com>
	Signed-off-by: Quinn Tran <quinn.tran@qlogic.com>
	Signed-off-by: Saurav Kashyap <saurav.kashyap@qlogic.com>
	Signed-off-by: Nicholas Bellinger <nab@linux-iscsi.org>
(cherry picked from commit 0e8cd71ceca4c15ef544e3af01248bc869c28d8f)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/qla2xxx/qla_target.c
#	drivers/scsi/qla2xxx/tcm_qla2xxx.c
diff --cc drivers/scsi/qla2xxx/qla_target.c
index d382e957457a,34ed246aa0db..000000000000
--- a/drivers/scsi/qla2xxx/qla_target.c
+++ b/drivers/scsi/qla2xxx/qla_target.c
@@@ -2836,11 -2722,12 +2838,11 @@@ static int qlt_handle_task_mgmt(struct 
  	struct qla_tgt *tgt;
  	struct qla_tgt_sess *sess;
  	uint32_t lun, unpacked_lun;
 -	int lun_size, fn;
 +	int fn;
  
- 	tgt = ha->tgt.qla_tgt;
+ 	tgt = vha->vha_tgt.qla_tgt;
  
  	lun = a->u.isp24.fcp_cmnd.lun;
 -	lun_size = sizeof(a->u.isp24.fcp_cmnd.lun);
  	fn = a->u.isp24.fcp_cmnd.task_mgmt_flags;
  	sess = ha->tgt.tgt_ops->find_sess_by_s_id(vha,
  	    a->u.isp24.fcp_hdr.s_id);
@@@ -4409,7 -4287,8 +4407,12 @@@ int qlt_lport_register(struct qla_tgt_f
  		rc = (*callback)(vha);
  		if (rc != 0) {
  			ha->tgt.tgt_ops = NULL;
++<<<<<<< HEAD
 +			ha->tgt.target_lport_ptr = NULL;
++=======
+ 			vha->vha_tgt.target_lport_ptr = NULL;
+ 			scsi_host_put(host);
++>>>>>>> 0e8cd71ceca4 (qla2xxx: Enhancements to enable NPIV support for QLOGIC ISPs with TCM/LIO.)
  		}
  		mutex_unlock(&qla_tgt_mutex);
  		return rc;
diff --cc drivers/scsi/qla2xxx/tcm_qla2xxx.c
index e9c7bfd1510c,113ca95d47df..000000000000
--- a/drivers/scsi/qla2xxx/tcm_qla2xxx.c
+++ b/drivers/scsi/qla2xxx/tcm_qla2xxx.c
@@@ -813,7 -767,11 +803,15 @@@ static void tcm_qla2xxx_put_session(str
  
  static void tcm_qla2xxx_put_sess(struct qla_tgt_sess *sess)
  {
++<<<<<<< HEAD
 +	tcm_qla2xxx_put_session(sess->se_sess);
++=======
+ 	if (!sess)
+ 		return;
+ 
+ 	assert_spin_locked(&sess->vha->hw->hardware_lock);
+ 	kref_put(&sess->se_sess->sess_kref, tcm_qla2xxx_release_session);
++>>>>>>> 0e8cd71ceca4 (qla2xxx: Enhancements to enable NPIV support for QLOGIC ISPs with TCM/LIO.)
  }
  
  static void tcm_qla2xxx_shutdown_sess(struct qla_tgt_sess *sess)
@@@ -1904,15 -1887,16 +1926,28 @@@ static int tcm_qla2xxx_register_configf
  	/*
  	 * Setup default attribute lists for various npiv_fabric->tf_cit_tmpl
  	 */
++<<<<<<< HEAD
 +	TF_CIT_TMPL(npiv_fabric)->tfc_wwn_cit.ct_attrs = tcm_qla2xxx_wwn_attrs;
 +	TF_CIT_TMPL(npiv_fabric)->tfc_tpg_base_cit.ct_attrs = NULL;
 +	TF_CIT_TMPL(npiv_fabric)->tfc_tpg_attrib_cit.ct_attrs = NULL;
 +	TF_CIT_TMPL(npiv_fabric)->tfc_tpg_param_cit.ct_attrs = NULL;
 +	TF_CIT_TMPL(npiv_fabric)->tfc_tpg_np_base_cit.ct_attrs = NULL;
 +	TF_CIT_TMPL(npiv_fabric)->tfc_tpg_nacl_base_cit.ct_attrs = NULL;
 +	TF_CIT_TMPL(npiv_fabric)->tfc_tpg_nacl_attrib_cit.ct_attrs = NULL;
 +	TF_CIT_TMPL(npiv_fabric)->tfc_tpg_nacl_auth_cit.ct_attrs = NULL;
 +	TF_CIT_TMPL(npiv_fabric)->tfc_tpg_nacl_param_cit.ct_attrs = NULL;
++=======
+ 	npiv_fabric->tf_cit_tmpl.tfc_wwn_cit.ct_attrs = tcm_qla2xxx_wwn_attrs;
+ 	npiv_fabric->tf_cit_tmpl.tfc_tpg_base_cit.ct_attrs =
+ 	    tcm_qla2xxx_tpg_attrs;
+ 	npiv_fabric->tf_cit_tmpl.tfc_tpg_attrib_cit.ct_attrs = NULL;
+ 	npiv_fabric->tf_cit_tmpl.tfc_tpg_param_cit.ct_attrs = NULL;
+ 	npiv_fabric->tf_cit_tmpl.tfc_tpg_np_base_cit.ct_attrs = NULL;
+ 	npiv_fabric->tf_cit_tmpl.tfc_tpg_nacl_base_cit.ct_attrs = NULL;
+ 	npiv_fabric->tf_cit_tmpl.tfc_tpg_nacl_attrib_cit.ct_attrs = NULL;
+ 	npiv_fabric->tf_cit_tmpl.tfc_tpg_nacl_auth_cit.ct_attrs = NULL;
+ 	npiv_fabric->tf_cit_tmpl.tfc_tpg_nacl_param_cit.ct_attrs = NULL;
++>>>>>>> 0e8cd71ceca4 (qla2xxx: Enhancements to enable NPIV support for QLOGIC ISPs with TCM/LIO.)
  	/*
  	 * Register the npiv_fabric for use within TCM
  	 */
diff --git a/drivers/scsi/qla2xxx/qla_attr.c b/drivers/scsi/qla2xxx/qla_attr.c
index bcc6af8e546b..abf02d3e5163 100644
--- a/drivers/scsi/qla2xxx/qla_attr.c
+++ b/drivers/scsi/qla2xxx/qla_attr.c
@@ -2104,6 +2104,8 @@ qla24xx_vport_delete(struct fc_vport *fc_vport)
 
 	vha->flags.delete_progress = 1;
 
+	qlt_remove_target(ha, vha);
+
 	fc_remove_host(vha->host);
 
 	scsi_remove_host(vha->host);
diff --git a/drivers/scsi/qla2xxx/qla_def.h b/drivers/scsi/qla2xxx/qla_def.h
index db7beb33e386..73d62c648442 100644
--- a/drivers/scsi/qla2xxx/qla_def.h
+++ b/drivers/scsi/qla2xxx/qla_def.h
@@ -2932,6 +2932,13 @@ struct qlfc_fw {
 	uint32_t len;
 };
 
+struct scsi_qlt_host {
+	void *target_lport_ptr;
+	struct mutex tgt_mutex;
+	struct mutex tgt_host_action_mutex;
+	struct qla_tgt *qla_tgt;
+};
+
 struct qlt_hw_data {
 	/* Protected by hw lock */
 	uint32_t enable_class_2:1;
@@ -2947,15 +2954,11 @@ struct qlt_hw_data {
 	uint32_t __iomem *atio_q_in;
 	uint32_t __iomem *atio_q_out;
 
-	void *target_lport_ptr;
 	struct qla_tgt_func_tmpl *tgt_ops;
-	struct qla_tgt *qla_tgt;
 	struct qla_tgt_cmd *cmds[DEFAULT_OUTSTANDING_COMMANDS];
 	uint16_t current_handle;
 
 	struct qla_tgt_vp_map *tgt_vp_map;
-	struct mutex tgt_mutex;
-	struct mutex tgt_host_action_mutex;
 
 	int saved_set;
 	uint16_t saved_exchange_count;
@@ -3684,6 +3687,7 @@ typedef struct scsi_qla_host {
 #define VP_ERR_FAB_LOGOUT	4
 #define VP_ERR_ADAP_NORESOURCES	5
 	struct qla_hw_data *hw;
+	struct scsi_qlt_host vha_tgt;
 	struct req_que *req;
 	struct qla_percpu_qp_hint *qps_hint;
 	int		fw_heartbeat_counter;
* Unmerged path drivers/scsi/qla2xxx/qla_target.c
* Unmerged path drivers/scsi/qla2xxx/tcm_qla2xxx.c
diff --git a/drivers/scsi/qla2xxx/tcm_qla2xxx.h b/drivers/scsi/qla2xxx/tcm_qla2xxx.h
index 771f7b816443..275d8b9a7a34 100644
--- a/drivers/scsi/qla2xxx/tcm_qla2xxx.h
+++ b/drivers/scsi/qla2xxx/tcm_qla2xxx.h
@@ -70,12 +70,8 @@ struct tcm_qla2xxx_lport {
 	struct tcm_qla2xxx_fc_loopid *lport_loopid_map;
 	/* Pointer to struct scsi_qla_host from qla2xxx LLD */
 	struct scsi_qla_host *qla_vha;
-	/* Pointer to struct scsi_qla_host for NPIV VP from qla2xxx LLD */
-	struct scsi_qla_host *qla_npiv_vp;
 	/* Pointer to struct qla_tgt pointer */
 	struct qla_tgt lport_qla_tgt;
-	/* Pointer to struct fc_vport for NPIV vport from libfc */
-	struct fc_vport *npiv_vport;
 	/* Pointer to TPG=1 for non NPIV mode */
 	struct tcm_qla2xxx_tpg *tpg_1;
 	/* Returned by tcm_qla2xxx_make_lport() */
