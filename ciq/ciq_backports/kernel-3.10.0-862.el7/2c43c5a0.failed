net/mlx5e: Enable local loopback in loopback selftest

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
Rebuild_CHGLOG: - [netdrv] mlx5e: Enable local loopback in loopback selftest (Kamal Heib) [1456684 1456694]
Rebuild_FUZZ: 96.08%
commit-author Huy Nguyen <huyn@mellanox.com>
commit 2c43c5a036be7d03232a2b28f4a440a8cafe699f
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/2c43c5a0.failed

Before running the ethtool's loopback selftest, we need
to make sure that the local loopback is enabled.

	Signed-off-by: Huy Nguyen <huyn@mellanox.com>
	Reviewed-by: Daniel Jurgens <danielj@mellanox.com>
	Signed-off-by: Leon Romanovsky <leon@kernel.org>
	Signed-off-by: Doug Ledford <dledford@redhat.com>
(cherry picked from commit 2c43c5a036be7d03232a2b28f4a440a8cafe699f)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlx5/core/en_selftest.c
diff --cc drivers/net/ethernet/mellanox/mlx5/core/en_selftest.c
index 5621dcfda4f1,1f1f8af87d4d..000000000000
--- a/drivers/net/ethernet/mellanox/mlx5/core/en_selftest.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/en_selftest.c
@@@ -236,12 -237,16 +237,24 @@@ static int mlx5e_test_loopback_setup(st
  {
  	int err = 0;
  
++<<<<<<< HEAD
 +	err = mlx5e_refresh_tirs_self_loopback(priv->mdev, true);
 +	if (err) {
 +		netdev_err(priv->netdev,
 +			   "\tFailed to enable UC loopback err(%d)\n", err);
++=======
+ 	/* Temporarily enable local_lb */
+ 	if (MLX5_CAP_GEN(priv->mdev, disable_local_lb)) {
+ 		mlx5_nic_vport_query_local_lb(priv->mdev, &lbtp->local_lb);
+ 		if (!lbtp->local_lb)
+ 			mlx5_nic_vport_update_local_lb(priv->mdev, true);
+ 	}
+ 
+ 	err = mlx5e_refresh_tirs(priv, true);
+ 	if (err)
++>>>>>>> 2c43c5a036be (net/mlx5e: Enable local loopback in loopback selftest)
  		return err;
 +	}
  
  	lbtp->loopback_ok = false;
  	init_completion(&lbtp->comp);
@@@ -257,8 -262,13 +270,13 @@@
  static void mlx5e_test_loopback_cleanup(struct mlx5e_priv *priv,
  					struct mlx5e_lbt_priv *lbtp)
  {
+ 	if (MLX5_CAP_GEN(priv->mdev, disable_local_lb)) {
+ 		if (!lbtp->local_lb)
+ 			mlx5_nic_vport_update_local_lb(priv->mdev, false);
+ 	}
+ 
  	dev_remove_pack(&lbtp->pt);
 -	mlx5e_refresh_tirs(priv, false);
 +	mlx5e_refresh_tirs_self_loopback(priv->mdev, false);
  }
  
  #define MLX5E_LB_VERIFY_TIMEOUT (msecs_to_jiffies(200))
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/en_selftest.c
