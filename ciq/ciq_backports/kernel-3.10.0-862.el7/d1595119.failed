ovl: check for emptiness of redirect dir

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Amir Goldstein <amir73il@gmail.com>
commit d15951198eaccb92c6b49e62cb72f5ff62da2236
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/d1595119.failed

Before introducing redirect_dir feature, the condition
!ovl_lower_positive(dentry) for a directory, implied that it is a pure
upper directory, which may be removed if empty.

Now that directory can be redirect, it is possible that upper does not
cover any lower (i.e. !ovl_lower_positive(dentry)), but the directory is a
merge (with redirected path) and maybe non empty.

Check for this case in ovl_remove_upper().

This change fixes the following test case from rename-pop-dir.py
of unionmount-testsuite:

    """Remove dir and rename old name"""
    d = ctx.non_empty_dir()
    d2 = ctx.no_dir()

    ctx.rmdir(d, err=ENOTEMPTY)
    ctx.rename(d, d2)
    ctx.rmdir(d, err=ENOENT)
    ctx.rmdir(d2, err=ENOTEMPTY)

./run --ov rename-pop-dir
/mnt/a/no_dir103: Expected error (Directory not empty) was not produced

	Signed-off-by: Amir Goldstein <amir73il@gmail.com>
	Signed-off-by: Miklos Szeredi <mszeredi@redhat.com>
(cherry picked from commit d15951198eaccb92c6b49e62cb72f5ff62da2236)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/overlayfs/dir.c
diff --cc fs/overlayfs/dir.c
index c82fdefe6d3b,4257a4a0ed72..000000000000
--- a/fs/overlayfs/dir.c
+++ b/fs/overlayfs/dir.c
@@@ -717,9 -674,18 +717,22 @@@ static int ovl_remove_upper(struct dent
  	struct dentry *upperdir = ovl_dentry_upper(dentry->d_parent);
  	struct inode *dir = upperdir->d_inode;
  	struct dentry *upper;
+ 	struct dentry *opaquedir = NULL;
  	int err;
  
++<<<<<<< HEAD
 +	mutex_lock_nested(&dir->i_mutex, I_MUTEX_PARENT);
++=======
+ 	/* Redirect dir can be !ovl_lower_positive && OVL_TYPE_MERGE */
+ 	if (is_dir && ovl_dentry_get_redirect(dentry)) {
+ 		opaquedir = ovl_check_empty_and_clear(dentry);
+ 		err = PTR_ERR(opaquedir);
+ 		if (IS_ERR(opaquedir))
+ 			goto out;
+ 	}
+ 
+ 	inode_lock_nested(dir, I_MUTEX_PARENT);
++>>>>>>> d15951198eac (ovl: check for emptiness of redirect dir)
  	upper = lookup_one_len(dentry->d_name.name, upperdir,
  			       dentry->d_name.len);
  	err = PTR_ERR(upper);
@@@ -744,9 -711,12 +758,17 @@@
  	 */
  	if (!err)
  		d_drop(dentry);
+ out_dput_upper:
+ 	dput(upper);
  out_unlock:
++<<<<<<< HEAD
 +	mutex_unlock(&dir->i_mutex);
 +
++=======
+ 	inode_unlock(dir);
+ 	dput(opaquedir);
+ out:
++>>>>>>> d15951198eac (ovl: check for emptiness of redirect dir)
  	return err;
  }
  
* Unmerged path fs/overlayfs/dir.c
