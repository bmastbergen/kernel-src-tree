drm/i915: avoid potential uninitialized variable use

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Arnd Bergmann <arnd@arndb.de>
commit 83482ca3b4fe7312bf3d1f25c7a4e9ff66585eab
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/83482ca3.failed

One of the recent changes introduced a warning about
undefined behavior in the sanity checking:

drivers/gpu/drm/i915/intel_ddi.c: In function 'intel_ddi_hdmi_level':
drivers/gpu/drm/i915/intel_ddi.c:654:6: error: 'n_hdmi_entries' may be used uninitialized in this function [-Werror=maybe-uninitialized]

It seems that the new cnl specific get_buf_trans functions
can return uninitialized data if the voltage level is set
to an unexpected value. This changes the code to always return
'1' in that error case, which seems like the safest choice
as we use one less than the number as an array index later on.

Fixes: cc9cabfdec38 ("drm/i915/cnl: Move voltage check into ddi buf trans functions.")
	Signed-off-by: Arnd Bergmann <arnd@arndb.de>
[danvet: shut up gcc comment added.]
	Signed-off-by: Daniel Vetter <daniel.vetter@ffwll.ch>
Link: https://patchwork.freedesktop.org/patch/msgid/20171005120835.437022-1-arnd@arndb.de
(cherry picked from commit 83482ca3b4fe7312bf3d1f25c7a4e9ff66585eab)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/gpu/drm/i915/intel_ddi.c
diff --cc drivers/gpu/drm/i915/intel_ddi.c
index d42007e133bd,f7c91bb9d13e..000000000000
--- a/drivers/gpu/drm/i915/intel_ddi.c
+++ b/drivers/gpu/drm/i915/intel_ddi.c
@@@ -434,6 -588,73 +434,76 @@@ skl_get_buf_trans_hdmi(struct drm_i915_
  	}
  }
  
++<<<<<<< HEAD
++=======
+ static const struct cnl_ddi_buf_trans *
+ cnl_get_buf_trans_hdmi(struct drm_i915_private *dev_priv, int *n_entries)
+ {
+ 	u32 voltage = I915_READ(CNL_PORT_COMP_DW3) & VOLTAGE_INFO_MASK;
+ 
+ 	if (voltage == VOLTAGE_INFO_0_85V) {
+ 		*n_entries = ARRAY_SIZE(cnl_ddi_translations_hdmi_0_85V);
+ 		return cnl_ddi_translations_hdmi_0_85V;
+ 	} else if (voltage == VOLTAGE_INFO_0_95V) {
+ 		*n_entries = ARRAY_SIZE(cnl_ddi_translations_hdmi_0_95V);
+ 		return cnl_ddi_translations_hdmi_0_95V;
+ 	} else if (voltage == VOLTAGE_INFO_1_05V) {
+ 		*n_entries = ARRAY_SIZE(cnl_ddi_translations_hdmi_1_05V);
+ 		return cnl_ddi_translations_hdmi_1_05V;
+ 	} else {
+ 		*n_entries = 1; /* shut up gcc */
+ 		MISSING_CASE(voltage);
+ 	}
+ 	return NULL;
+ }
+ 
+ static const struct cnl_ddi_buf_trans *
+ cnl_get_buf_trans_dp(struct drm_i915_private *dev_priv, int *n_entries)
+ {
+ 	u32 voltage = I915_READ(CNL_PORT_COMP_DW3) & VOLTAGE_INFO_MASK;
+ 
+ 	if (voltage == VOLTAGE_INFO_0_85V) {
+ 		*n_entries = ARRAY_SIZE(cnl_ddi_translations_dp_0_85V);
+ 		return cnl_ddi_translations_dp_0_85V;
+ 	} else if (voltage == VOLTAGE_INFO_0_95V) {
+ 		*n_entries = ARRAY_SIZE(cnl_ddi_translations_dp_0_95V);
+ 		return cnl_ddi_translations_dp_0_95V;
+ 	} else if (voltage == VOLTAGE_INFO_1_05V) {
+ 		*n_entries = ARRAY_SIZE(cnl_ddi_translations_dp_1_05V);
+ 		return cnl_ddi_translations_dp_1_05V;
+ 	} else {
+ 		*n_entries = 1; /* shut up gcc */
+ 		MISSING_CASE(voltage);
+ 	}
+ 	return NULL;
+ }
+ 
+ static const struct cnl_ddi_buf_trans *
+ cnl_get_buf_trans_edp(struct drm_i915_private *dev_priv, int *n_entries)
+ {
+ 	u32 voltage = I915_READ(CNL_PORT_COMP_DW3) & VOLTAGE_INFO_MASK;
+ 
+ 	if (dev_priv->vbt.edp.low_vswing) {
+ 		if (voltage == VOLTAGE_INFO_0_85V) {
+ 			*n_entries = ARRAY_SIZE(cnl_ddi_translations_edp_0_85V);
+ 			return cnl_ddi_translations_edp_0_85V;
+ 		} else if (voltage == VOLTAGE_INFO_0_95V) {
+ 			*n_entries = ARRAY_SIZE(cnl_ddi_translations_edp_0_95V);
+ 			return cnl_ddi_translations_edp_0_95V;
+ 		} else if (voltage == VOLTAGE_INFO_1_05V) {
+ 			*n_entries = ARRAY_SIZE(cnl_ddi_translations_edp_1_05V);
+ 			return cnl_ddi_translations_edp_1_05V;
+ 		} else {
+ 			*n_entries = 1; /* shut up gcc */
+ 			MISSING_CASE(voltage);
+ 		}
+ 		return NULL;
+ 	} else {
+ 		return cnl_get_buf_trans_dp(dev_priv, n_entries);
+ 	}
+ }
+ 
++>>>>>>> 83482ca3b4fe (drm/i915: avoid potential uninitialized variable use)
  static int intel_ddi_hdmi_level(struct drm_i915_private *dev_priv, enum port port)
  {
  	int n_hdmi_entries;
* Unmerged path drivers/gpu/drm/i915/intel_ddi.c
