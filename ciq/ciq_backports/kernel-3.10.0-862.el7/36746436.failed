intel-iommu: integrate DMA CMA

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Akinobu Mita <akinobu.mita@gmail.com>
commit 367464362591d89b371e2a690638e9bc899d8ebb
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/36746436.failed

This adds support for the DMA Contiguous Memory Allocator for
intel-iommu.  This change enables dma_alloc_coherent() to allocate big
contiguous memory.

It is achieved in the same way as nommu_dma_ops currently does, i.e.
trying to allocate memory by dma_alloc_from_contiguous() and
alloc_pages() is used as a fallback.

	Signed-off-by: Akinobu Mita <akinobu.mita@gmail.com>
	Cc: Marek Szyprowski <m.szyprowski@samsung.com>
	Cc: Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>
	Cc: David Woodhouse <dwmw2@infradead.org>
	Cc: Don Dutile <ddutile@redhat.com>
	Cc: Thomas Gleixner <tglx@linutronix.de>
	Cc: Ingo Molnar <mingo@redhat.com>
	Cc: "H. Peter Anvin" <hpa@zytor.com>
	Cc: Andi Kleen <andi@firstfloor.org>
	Cc: Yinghai Lu <yinghai@kernel.org>
	Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
	Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
(cherry picked from commit 367464362591d89b371e2a690638e9bc899d8ebb)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/iommu/intel-iommu.c
diff --cc drivers/iommu/intel-iommu.c
index ae278e3a91b2,6bb32773c3ac..000000000000
--- a/drivers/iommu/intel-iommu.c
+++ b/drivers/iommu/intel-iommu.c
@@@ -43,7 -39,7 +43,11 @@@
  #include <linux/dmi.h>
  #include <linux/pci-ats.h>
  #include <linux/memblock.h>
++<<<<<<< HEAD
 +#include <linux/crash_dump.h>
++=======
+ #include <linux/dma-contiguous.h>
++>>>>>>> 367464362591 (intel-iommu: integrate DMA CMA)
  #include <asm/irq_remapping.h>
  #include <asm/cacheflush.h>
  #include <asm/iommu.h>
@@@ -3625,8 -3246,9 +3644,14 @@@ static void intel_free_coherent(struct 
  	size = PAGE_ALIGN(size);
  	order = get_order(size);
  
++<<<<<<< HEAD
 +	intel_unmap(dev, dma_handle);
 +	free_pages((unsigned long)vaddr, order);
++=======
+ 	intel_unmap_page(dev, dma_handle, size, DMA_BIDIRECTIONAL, NULL);
+ 	if (!dma_release_from_contiguous(dev, page, size >> PAGE_SHIFT))
+ 		__free_pages(page, order);
++>>>>>>> 367464362591 (intel-iommu: integrate DMA CMA)
  }
  
  static void intel_unmap_sg(struct device *dev, struct scatterlist *sglist,
* Unmerged path drivers/iommu/intel-iommu.c
