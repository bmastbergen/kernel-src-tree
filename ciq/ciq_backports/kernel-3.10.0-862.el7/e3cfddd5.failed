bridge: add tracepoint in br_fdb_update

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Roopa Prabhu <roopa@cumulusnetworks.com>
commit e3cfddd577e763496c25ddb855cfff48b1174b63
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/e3cfddd5.failed

This extends bridge fdb table tracepoints to also cover
learned fdb entries in the br_fdb_update path. Note that
unlike other tracepoints I have moved this to when the fdb
is modified because this is in the datapath and can generate
a lot of noise in the trace output. br_fdb_update is also called
from added_by_user context in the NTF_USE case which is already
traced ..hence the !added_by_user check.

	Signed-off-by: Roopa Prabhu <roopa@cumulusnetworks.com>
	Acked-by: Nikolay Aleksandrov <nikolay@cumulusnetworks.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit e3cfddd577e763496c25ddb855cfff48b1174b63)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	include/trace/events/bridge.h
#	net/core/net-traces.c
diff --cc net/core/net-traces.c
index ba3c0120786c,1132820c8e62..000000000000
--- a/net/core/net-traces.c
+++ b/net/core/net-traces.c
@@@ -31,6 -31,19 +31,22 @@@
  #include <trace/events/napi.h>
  #include <trace/events/sock.h>
  #include <trace/events/udp.h>
++<<<<<<< HEAD
++=======
+ #include <trace/events/fib.h>
+ #include <trace/events/qdisc.h>
+ #if IS_ENABLED(CONFIG_IPV6)
+ #include <trace/events/fib6.h>
+ EXPORT_TRACEPOINT_SYMBOL_GPL(fib6_table_lookup);
+ #endif
+ #if IS_ENABLED(CONFIG_BRIDGE)
+ #include <trace/events/bridge.h>
+ EXPORT_TRACEPOINT_SYMBOL_GPL(br_fdb_add);
+ EXPORT_TRACEPOINT_SYMBOL_GPL(br_fdb_external_learn_add);
+ EXPORT_TRACEPOINT_SYMBOL_GPL(fdb_delete);
+ EXPORT_TRACEPOINT_SYMBOL_GPL(br_fdb_update);
+ #endif
++>>>>>>> e3cfddd577e7 (bridge: add tracepoint in br_fdb_update)
  
  EXPORT_TRACEPOINT_SYMBOL_GPL(kfree_skb);
  
* Unmerged path include/trace/events/bridge.h
* Unmerged path include/trace/events/bridge.h
diff --git a/net/bridge/br_fdb.c b/net/bridge/br_fdb.c
index ee58945b0c94..59e6a079bd65 100644
--- a/net/bridge/br_fdb.c
+++ b/net/bridge/br_fdb.c
@@ -600,8 +600,10 @@ void br_fdb_update(struct net_bridge *br, struct net_bridge_port *source,
 				fdb->updated = now;
 			if (unlikely(added_by_user))
 				fdb->added_by_user = 1;
-			if (unlikely(fdb_modified))
+			if (unlikely(fdb_modified)) {
+				trace_br_fdb_update(br, source, addr, vid, added_by_user);
 				fdb_notify(br, fdb, RTM_NEWNEIGH);
+			}
 		}
 	} else {
 		spin_lock(&br->hash_lock);
@@ -610,6 +612,7 @@ void br_fdb_update(struct net_bridge *br, struct net_bridge_port *source,
 			if (fdb) {
 				if (unlikely(added_by_user))
 					fdb->added_by_user = 1;
+				trace_br_fdb_update(br, source, addr, vid, added_by_user);
 				fdb_notify(br, fdb, RTM_NEWNEIGH);
 			}
 		}
* Unmerged path net/core/net-traces.c
