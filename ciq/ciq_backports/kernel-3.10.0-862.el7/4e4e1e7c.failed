tools/power turbostat: move --Package and --processor into the --cpu option

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
Rebuild_CHGLOG: - [tools] power turbostat: move --Package and --processor into the --cpu option (Prarit Bhargava) [1514290]
Rebuild_FUZZ: 95.83%
commit-author Len Brown <len.brown@intel.com>
commit 4e4e1e7c6eaf387f8ec803f37f154fdd60e303c0
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/4e4e1e7c.failed

--Package is now "--cpu package",
which will display just the 1st CPU in each package

--processor is not "--cpu core"
which will display just the 1st CPU in each core

	Signed-off-by: Len Brown <len.brown@intel.com>
(cherry picked from commit 4e4e1e7c6eaf387f8ec803f37f154fdd60e303c0)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/power/x86/turbostat/turbostat.8
#	tools/power/x86/turbostat/turbostat.c
diff --cc tools/power/x86/turbostat/turbostat.8
index 0863a08025ac,5189d9d982fe..000000000000
--- a/tools/power/x86/turbostat/turbostat.8
+++ b/tools/power/x86/turbostat/turbostat.8
@@@ -45,11 -46,17 +45,15 @@@ name as necessary to disambiguate it fr
  		'delta' shows the difference in values during the measurement interval.
  		'percent' shows the delta as a percentage of the cycles elapsed.
  		default: delta
 -
 -	name: "name_string"
 -		Any string that does not match a key-word above is used
 -		as the column header.
  .fi
  .PP
++<<<<<<< HEAD
 +\fB--hide column\fP do not show the specified columns.  May be invoked multiple times, or with a comma-separated list of column names.
++=======
+ \fB--cpu cpu-set\fP limit output to system summary plus the specified cpu-set.  If cpu-set is the string "core", then the system summary plus the first CPU in each core are printed -- eg. subsequent HT siblings are not printed.  Or if cpu-set is the string "package", then the system summary plus the first CPU in each package is printed.  Otherwise, the system summary plus the specified set of CPUs are printed.  The cpu-set is ordered from low to high, comma delimited with ".." and "-" permitted to denote a range. eg. 1,2,8,14..17,21-44
++>>>>>>> 4e4e1e7c6eaf (tools/power turbostat: move --Package and --processor into the --cpu option)
  .PP
 -\fB--hide column\fP do not show the specified columns.  May be invoked multiple times, or with a comma-separated list of column names.  Use "--hide sysfs" to hide the sysfs statistics columns as a group.
 -.PP
 -\fB--show column\fP show only the specified columns.  May be invoked multiple times, or with a comma-separated list of column names.  Use "--show sysfs" to show the sysfs statistics columns as a group.
 +\fB--show column\fP show only the specified columns.  May be invoked multiple times, or with a comma-separated list of column names.
  .PP
  \fB--Dump\fP displays the raw counter values.
  .PP
@@@ -65,9 -71,7 +69,13 @@@ The file is truncated if it already exi
  .PP
  \fB--Joules\fP displays energy in Joules, rather than dividing Joules by time to print power in Watts.
  .PP
++<<<<<<< HEAD
 +\fB--Package\fP limits output to the system summary plus the 1st thread in each Package.
 +.PP
 +\fB--processor\fP limits output to the system summary plus the 1st thread in each processor of each package.  Ie. it skips hyper-threaded siblings.
++=======
+ \fB--list\fP display column header names available for use by --show and --hide, then exit.
++>>>>>>> 4e4e1e7c6eaf (tools/power turbostat: move --Package and --processor into the --cpu option)
  .PP
  \fB--Summary\fP limits output to a 1-line System Summary for each interval.
  .PP
diff --cc tools/power/x86/turbostat/turbostat.c
index 416137df44fe,c005d9052679..000000000000
--- a/tools/power/x86/turbostat/turbostat.c
+++ b/tools/power/x86/turbostat/turbostat.c
@@@ -3915,9 -4153,12 +3915,15 @@@ void help(
  	"to print statistics, until interrupted.\n"
  	"--add		add a counter\n"
  	"		eg. --add msr0x10,u64,cpu,delta,MY_TSC\n"
++<<<<<<< HEAD
 +	"--debug	run in \"debug\" mode\n"
++=======
+ 	"--cpu	cpu-set	limit output to summary plus cpu-set:\n"
+ 	"		{core | package | j,k,l..m,n-p }\n"
+ 	"--quiet	skip decoding system configuration header\n"
++>>>>>>> 4e4e1e7c6eaf (tools/power turbostat: move --Package and --processor into the --cpu option)
  	"--interval sec	Override default 5-second measurement interval\n"
  	"--help		print this help message\n"
 -	"--list		list column headers only\n"
  	"--out file	create or truncate \"file\" for all output\n"
  	"--version	print version information\n"
  	"\n"
@@@ -4433,6 -4688,152 +4439,155 @@@ next
  		exit(1);
  	}
  }
++<<<<<<< HEAD
++=======
+ 
+ void probe_sysfs(void)
+ {
+ 	char path[64];
+ 	char name_buf[16];
+ 	FILE *input;
+ 	int state;
+ 	char *sp;
+ 
+ 	if (!DO_BIC(BIC_sysfs))
+ 		return;
+ 
+ 	for (state = 10; state > 0; --state) {
+ 
+ 		sprintf(path, "/sys/devices/system/cpu/cpu%d/cpuidle/state%d/name",
+ 			base_cpu, state);
+ 		input = fopen(path, "r");
+ 		if (input == NULL)
+ 			continue;
+ 		fgets(name_buf, sizeof(name_buf), input);
+ 
+ 		 /* truncate "C1-HSW\n" to "C1", or truncate "C1\n" to "C1" */
+ 		sp = strchr(name_buf, '-');
+ 		if (!sp)
+ 			sp = strchrnul(name_buf, '\n');
+ 		*sp = '%';
+ 		*(sp + 1) = '\0';
+ 
+ 		fclose(input);
+ 
+ 		sprintf(path, "cpuidle/state%d/time", state);
+ 
+ 		add_counter(0, path, name_buf, 64, SCOPE_CPU, COUNTER_USEC,
+ 				FORMAT_PERCENT, SYSFS_PERCPU);
+ 	}
+ 
+ 	for (state = 10; state > 0; --state) {
+ 
+ 		sprintf(path, "/sys/devices/system/cpu/cpu%d/cpuidle/state%d/name",
+ 			base_cpu, state);
+ 		input = fopen(path, "r");
+ 		if (input == NULL)
+ 			continue;
+ 		fgets(name_buf, sizeof(name_buf), input);
+ 		 /* truncate "C1-HSW\n" to "C1", or truncate "C1\n" to "C1" */
+ 		sp = strchr(name_buf, '-');
+ 		if (!sp)
+ 			sp = strchrnul(name_buf, '\n');
+ 		*sp = '\0';
+ 		fclose(input);
+ 
+ 		sprintf(path, "cpuidle/state%d/usage", state);
+ 
+ 		add_counter(0, path, name_buf, 64, SCOPE_CPU, COUNTER_ITEMS,
+ 				FORMAT_DELTA, SYSFS_PERCPU);
+ 	}
+ 
+ }
+ 
+ 
+ /*
+  * parse cpuset with following syntax
+  * 1,2,4..6,8-10 and set bits in cpu_subset
+  */
+ void parse_cpu_command(char *optarg)
+ {
+ 	unsigned int start, end;
+ 	char *next;
+ 
+ 	if (!strcmp(optarg, "core")) {
+ 		if (cpu_subset)
+ 			goto error;
+ 		show_core_only++;
+ 		return;
+ 	}
+ 	if (!strcmp(optarg, "package")) {
+ 		if (cpu_subset)
+ 			goto error;
+ 		show_pkg_only++;
+ 		return;
+ 	}
+ 	if (show_core_only || show_pkg_only)
+ 		goto error;
+ 
+ 	cpu_subset = CPU_ALLOC(CPU_SUBSET_MAXCPUS);
+ 	if (cpu_subset == NULL)
+ 		err(3, "CPU_ALLOC");
+ 	cpu_subset_size = CPU_ALLOC_SIZE(CPU_SUBSET_MAXCPUS);
+ 
+ 	CPU_ZERO_S(cpu_subset_size, cpu_subset);
+ 
+ 	next = optarg;
+ 
+ 	while (next && *next) {
+ 
+ 		if (*next == '-')	/* no negative cpu numbers */
+ 			goto error;
+ 
+ 		start = strtoul(next, &next, 10);
+ 
+ 		if (start >= CPU_SUBSET_MAXCPUS)
+ 			goto error;
+ 		CPU_SET_S(start, cpu_subset_size, cpu_subset);
+ 
+ 		if (*next == '\0')
+ 			break;
+ 
+ 		if (*next == ',') {
+ 			next += 1;
+ 			continue;
+ 		}
+ 
+ 		if (*next == '-') {
+ 			next += 1;	/* start range */
+ 		} else if (*next == '.') {
+ 			next += 1;
+ 			if (*next == '.')
+ 				next += 1;	/* start range */
+ 			else
+ 				goto error;
+ 		}
+ 
+ 		end = strtoul(next, &next, 10);
+ 		if (end <= start)
+ 			goto error;
+ 
+ 		while (++start <= end) {
+ 			if (start >= CPU_SUBSET_MAXCPUS)
+ 				goto error;
+ 			CPU_SET_S(start, cpu_subset_size, cpu_subset);
+ 		}
+ 
+ 		if (*next == ',')
+ 			next += 1;
+ 		else if (*next != '\0')
+ 			goto error;
+ 	}
+ 
+ 	return;
+ 
+ error:
+ 	fprintf(stderr, "\"--cpu %s\" malformed\n", optarg);
+ 	help();
+ 	exit(-1);
+ }
+ 
++>>>>>>> 4e4e1e7c6eaf (tools/power turbostat: move --Package and --processor into the --cpu option)
  /*
   * HIDE_LIST - hide this list of counters, show the rest [default]
   * SHOW_LIST - show this list of counters, hide the rest
@@@ -4480,9 -4882,9 +4635,13 @@@ void cmdline(int argc, char **argv
  		{"help",	no_argument,		0, 'h'},
  		{"hide",	required_argument,	0, 'H'},	// meh, -h taken by --help
  		{"Joules",	no_argument,		0, 'J'},
 -		{"list",	no_argument,		0, 'l'},
  		{"out",		required_argument,	0, 'o'},
++<<<<<<< HEAD
 +		{"Package",	no_argument,		0, 'p'},
 +		{"processor",	no_argument,		0, 'p'},
++=======
+ 		{"quiet",	no_argument,		0, 'q'},
++>>>>>>> 4e4e1e7c6eaf (tools/power turbostat: move --Package and --processor into the --cpu option)
  		{"show",	required_argument,	0, 's'},
  		{"Summary",	no_argument,		0, 'S'},
  		{"TCC",		required_argument,	0, 'T'},
@@@ -4492,7 -4894,7 +4651,11 @@@
  
  	progname = argv[0];
  
++<<<<<<< HEAD
 +	while ((opt = getopt_long_only(argc, argv, "+C:c:Ddvhi:JM:m:o:PpST:V",
++=======
+ 	while ((opt = getopt_long_only(argc, argv, "+C:c:Ddhi:JM:m:o:qST:v",
++>>>>>>> 4e4e1e7c6eaf (tools/power turbostat: move --Package and --processor into the --cpu option)
  				long_options, &option_index)) != -1) {
  		switch (opt) {
  		case 'a':
@@@ -4532,11 -4936,12 +4695,16 @@@
  		case 'o':
  			outf = fopen_or_die(optarg, "w");
  			break;
++<<<<<<< HEAD
 +		case 'P':
 +			show_pkg_only++;
 +			break;
 +		case 'p':
 +			show_core_only++;
++=======
+ 		case 'q':
+ 			quiet = 1;
++>>>>>>> 4e4e1e7c6eaf (tools/power turbostat: move --Package and --processor into the --cpu option)
  			break;
  		case 's':
  			parse_show_hide(optarg, SHOW_LIST);
* Unmerged path tools/power/x86/turbostat/turbostat.8
* Unmerged path tools/power/x86/turbostat/turbostat.c
