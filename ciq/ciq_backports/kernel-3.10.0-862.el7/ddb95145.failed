qla2xxx: Fix qlt_lport_register base_vha callback race

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Nicholas Bellinger <nab@linux-iscsi.org>
commit ddb95145a38eb37b236d4e00f43a75d067922dda
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/ddb95145.failed

This patch closes a race between qlt_lport_register() and
tcm_qla2xxx callback logic by holding qla_tgt_mutex before
making the callback.

In order for this to work, the qlt_add_target() and
qlt_remove_target() code has been changed to avoid the
accessing qla_tgt_mutex + list_[add,del] for NPIV enabled
ports.

This bug introduced in v3.14-rc1 code with commit 49a47f2.

	Cc: Sawan Chandak <sawan.chandak@qlogic.com>
	Cc: Quinn Tran <quinn.tran@qlogic.com>
	Cc: Saurav Kashyap <saurav.kashyap@qlogic.com>
	Cc: Giridhar Malavali <giridhar.malavali@qlogic.com>
	Signed-off-by: Nicholas Bellinger <nab@linux-iscsi.org>
(cherry picked from commit ddb95145a38eb37b236d4e00f43a75d067922dda)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/qla2xxx/qla_target.c
diff --cc drivers/scsi/qla2xxx/qla_target.c
index 071c8becb9ba,ea3eaef3f81b..000000000000
--- a/drivers/scsi/qla2xxx/qla_target.c
+++ b/drivers/scsi/qla2xxx/qla_target.c
@@@ -4335,11 -4194,15 +4338,15 @@@ int qlt_add_target(struct qla_hw_data *
  /* Must be called under tgt_host_action_mutex */
  int qlt_remove_target(struct qla_hw_data *ha, struct scsi_qla_host *vha)
  {
 -	if (!vha->vha_tgt.qla_tgt)
 +	if (!ha->tgt.qla_tgt)
  		return 0;
  
+ 	if (vha->fc_vport) {
+ 		qlt_release(vha->vha_tgt.qla_tgt);
+ 		return 0;
+ 	}
  	mutex_lock(&qla_tgt_mutex);
 -	list_del(&vha->vha_tgt.qla_tgt->tgt_list_entry);
 +	list_del(&ha->tgt.qla_tgt->tgt_list_entry);
  	mutex_unlock(&qla_tgt_mutex);
  
  	ql_dbg(ql_dbg_tgt, vha, 0xe03c, "Unregistering target for host %ld(%p)",
@@@ -4425,16 -4292,10 +4438,23 @@@ int qlt_lport_register(struct qla_tgt_f
  			scsi_host_put(host);
  			continue;
  		}
++<<<<<<< HEAD
 +		/*
 +		 * Setup passed parameters ahead of invoking callback
 +		 */
 +		ha->tgt.tgt_ops = qla_tgt_ops;
 +		ha->tgt.target_lport_ptr = target_lport_ptr;
 +		rc = (*callback)(vha);
 +		if (rc != 0) {
 +			ha->tgt.tgt_ops = NULL;
 +			ha->tgt.target_lport_ptr = NULL;
 +		}
++=======
+ 		rc = (*callback)(vha, target_lport_ptr, npiv_wwpn, npiv_wwnn);
+ 		if (rc != 0)
+ 			scsi_host_put(host);
+ 
++>>>>>>> ddb95145a38e (qla2xxx: Fix qlt_lport_register base_vha callback race)
  		mutex_unlock(&qla_tgt_mutex);
  		return rc;
  	}
* Unmerged path drivers/scsi/qla2xxx/qla_target.c
