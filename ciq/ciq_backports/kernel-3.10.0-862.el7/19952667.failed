nfsd: auth: Fix gid sorting when rootsquash enabled

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Ben Hutchings <ben.hutchings@codethink.co.uk>
commit 1995266727fa8143897e89b55f5d3c79aa828420
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/19952667.failed

Commit bdcf0a423ea1 ("kernel: make groups_sort calling a responsibility
group_info allocators") appears to break nfsd rootsquash in a pretty
major way.

It adds a call to groups_sort() inside the loop that copies/squashes
gids, which means the valid gids are sorted along with the following
garbage.  The net result is that the highest numbered valid gids are
replaced with any lower-valued garbage gids, possibly including 0.

We should sort only once, after filling in all the gids.

Fixes: bdcf0a423ea1 ("kernel: make groups_sort calling a responsibility ...")
	Signed-off-by: Ben Hutchings <ben.hutchings@codethink.co.uk>
	Acked-by: J. Bruce Fields <bfields@redhat.com>
	Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
(cherry picked from commit 1995266727fa8143897e89b55f5d3c79aa828420)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/nfsd/auth.c
diff --cc fs/nfsd/auth.c
index 6d5187b528aa,fdf2aad73470..000000000000
--- a/fs/nfsd/auth.c
+++ b/fs/nfsd/auth.c
@@@ -56,11 -56,14 +56,18 @@@ int nfsd_setuser(struct svc_rqst *rqstp
  			goto oom;
  
  		for (i = 0; i < rqgi->ngroups; i++) {
 -			if (gid_eq(GLOBAL_ROOT_GID, rqgi->gid[i]))
 -				gi->gid[i] = exp->ex_anon_gid;
 +			if (gid_eq(GLOBAL_ROOT_GID, GROUP_AT(rqgi, i)))
 +				GROUP_AT(gi, i) = exp->ex_anon_gid;
  			else
++<<<<<<< HEAD
 +				GROUP_AT(gi, i) = GROUP_AT(rqgi, i);
++=======
+ 				gi->gid[i] = rqgi->gid[i];
++>>>>>>> 1995266727fa (nfsd: auth: Fix gid sorting when rootsquash enabled)
  		}
+ 
+ 		/* Each thread allocates its own gi, no race */
+ 		groups_sort(gi);
  	} else {
  		gi = get_group_info(rqgi);
  	}
* Unmerged path fs/nfsd/auth.c
