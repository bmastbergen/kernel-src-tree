tpm: vtpm_proxy: Suppress error logging when in closed state

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Stefan Berger <stefanb@linux.vnet.ibm.com>
commit 402149c6470d9562fe6891e0165df7f5f6bff7a7
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/402149c6.failed

Suppress the error logging when the core TPM driver sends commands
to the VTPM proxy driver and -EPIPE is returned in case the VTPM
proxy driver is 'closed' (closed anonymous file descriptor).  This
error code is only returned by the send function and by tpm_transmit
when the VTPM proxy driver is being used.

	Signed-off-by: Stefan Berger <stefanb@linux.vnet.ibm.com>
	Reviewed-by: Jarkko Sakkinen <jarkko.sakkinen@linux.intel.com>
	Tested-by: Jarkko Sakkinen <jarkko.sakkinen@linux.intel.com>
	Signed-off-by: Jarkko Sakkinen <jarkko.sakkinen@linux.intel.com>
(cherry picked from commit 402149c6470d9562fe6891e0165df7f5f6bff7a7)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/char/tpm/tpm-interface.c
diff --cc drivers/char/tpm/tpm-interface.c
index 0d319f9dabc5,a965a9f0e5d2..000000000000
--- a/drivers/char/tpm/tpm-interface.c
+++ b/drivers/char/tpm/tpm-interface.c
@@@ -381,10 -423,15 +381,16 @@@ ssize_t tpm_transmit(struct tpm_chip *c
  		chip->locality = rc;
  	}
  
 -	rc = tpm2_prepare_space(chip, space, ordinal, buf);
 -	if (rc)
 -		goto out;
 -
  	rc = chip->ops->send(chip, (u8 *) buf, count);
  	if (rc < 0) {
++<<<<<<< HEAD
 +		dev_err(&chip->dev,
 +			"tpm_transmit: tpm_send: error %zd\n", rc);
++=======
+ 		if (rc != -EPIPE)
+ 			dev_err(&chip->dev,
+ 				"%s: tpm_send: error %d\n", __func__, rc);
++>>>>>>> 402149c6470d (tpm: vtpm_proxy: Suppress error logging when in closed state)
  		goto out;
  	}
  
* Unmerged path drivers/char/tpm/tpm-interface.c
diff --git a/drivers/char/tpm/tpm2-cmd.c b/drivers/char/tpm/tpm2-cmd.c
index bab83b23d39b..4d7af5ac7fd3 100644
--- a/drivers/char/tpm/tpm2-cmd.c
+++ b/drivers/char/tpm/tpm2-cmd.c
@@ -835,7 +835,7 @@ void tpm2_shutdown(struct tpm_chip *chip, u16 shutdown_type)
 	/* In places where shutdown command is sent there's no much we can do
 	 * except print the error code on a system failure.
 	 */
-	if (rc < 0)
+	if (rc < 0 && rc != -EPIPE)
 		dev_warn(&chip->dev, "transmit returned %d while stopping the TPM",
 			 rc);
 }
