module: keep percpu symbols in module's symtab

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Miroslav Benes <mbenes@suse.cz>
commit e0224418516b4d8a6c2160574bac18447c354ef0
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/e0224418.failed

Currently, percpu symbols from .data..percpu ELF section of a module are
not copied over and stored in final symtab array of struct module.
Consequently such symbol cannot be returned via kallsyms API (for
example kallsyms_lookup_name). This can be especially confusing when the
percpu symbol is exported. Only its __ksymtab et al. are present in its
symtab.

The culprit is in layout_and_allocate() function where SHF_ALLOC flag is
dropped for .data..percpu section. There is in fact no need to copy the
section to final struct module, because kernel module loader allocates
extra percpu section by itself. Unfortunately only symbols from
SHF_ALLOC sections are copied due to a check in is_core_symbol().

The patch changes is_core_symbol() function to copy over also percpu
symbols (their st_shndx points to .data..percpu ELF section). We do it
only if CONFIG_KALLSYMS_ALL is set to be consistent with the rest of the
function (ELF section is SHF_ALLOC but !SHF_EXECINSTR). Finally
elf_type() returns type 'a' for a percpu symbol because its address is
absolute.

	Signed-off-by: Miroslav Benes <mbenes@suse.cz>
	Signed-off-by: Rusty Russell <rusty@rustcorp.com.au>
	Signed-off-by: Jiri Kosina <jkosina@suse.cz>
(cherry picked from commit e0224418516b4d8a6c2160574bac18447c354ef0)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	kernel/module.c
diff --cc kernel/module.c
index dad13f388e48,912e891e0e2f..000000000000
--- a/kernel/module.c
+++ b/kernel/module.c
@@@ -2363,7 -2412,7 +2363,11 @@@ static char elf_type(const Elf_Sym *sym
  }
  
  static bool is_core_symbol(const Elf_Sym *src, const Elf_Shdr *sechdrs,
++<<<<<<< HEAD
 +                           unsigned int shnum)
++=======
+ 			unsigned int shnum, unsigned int pcpundx)
++>>>>>>> e0224418516b (module: keep percpu symbols in module's symtab)
  {
  	const Elf_Shdr *sec;
  
* Unmerged path kernel/module.c
