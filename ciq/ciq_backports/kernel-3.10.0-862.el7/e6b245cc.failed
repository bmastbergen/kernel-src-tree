thunderbolt: Add support for host and device NVM firmware upgrade

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
Rebuild_CHGLOG: - [thunderbolt] Add support for host and device NVM firmware upgrade (Jeremy McNicoll) [1172010]
Rebuild_FUZZ: 88.89%
commit-author Mika Westerberg <mika.westerberg@linux.intel.com>
commit e6b245ccd524441f462f1ca1fe726123dcedeeee
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/e6b245cc.failed

Starting from Intel Falcon Ridge the NVM firmware can be upgraded by
using DMA configuration based mailbox commands. If we detect that the
host or device (device support starts from Intel Alpine Ridge) has the
DMA configuration based mailbox we expose NVM information to the
userspace as two separate Linux NVMem devices: nvm_active and
nvm_non_active. The former is read-only portion of the active NVM which
firmware upgrade tools can be use to find out suitable NVM image if the
device identification strings are not enough.

The latter is write-only portion where the new NVM image is to be
written by the userspace. It is up to the userspace to find out right
NVM image (the kernel does very minimal validation). The ICM firmware
itself authenticates the new NVM firmware and fails the operation if it
is not what is expected.

We also expose two new sysfs files per each switch: nvm_version and
nvm_authenticate which can be used to read the active NVM version and
start the upgrade process.

We also introduce safe mode which is the mode a switch goes when it does
not have properly authenticated firmware. In this mode the switch only
accepts a couple of commands including flashing a new NVM firmware image
and triggering power cycle.

This code is based on the work done by Amir Levy and Michael Jamet.

	Signed-off-by: Michael Jamet <michael.jamet@intel.com>
	Signed-off-by: Mika Westerberg <mika.westerberg@linux.intel.com>
	Reviewed-by: Yehezkel Bernat <yehezkel.bernat@intel.com>
	Reviewed-by: Andy Shevchenko <andriy.shevchenko@linux.intel.com>
	Signed-off-by: Andreas Noever <andreas.noever@gmail.com>
	Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
(cherry picked from commit e6b245ccd524441f462f1ca1fe726123dcedeeee)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	Documentation/ABI/testing/sysfs-bus-thunderbolt
#	drivers/thunderbolt/Kconfig
#	drivers/thunderbolt/domain.c
#	drivers/thunderbolt/icm.c
#	drivers/thunderbolt/nhi.h
#	drivers/thunderbolt/switch.c
#	drivers/thunderbolt/tb.c
#	drivers/thunderbolt/tb.h
* Unmerged path Documentation/ABI/testing/sysfs-bus-thunderbolt
* Unmerged path drivers/thunderbolt/Kconfig
* Unmerged path drivers/thunderbolt/domain.c
* Unmerged path drivers/thunderbolt/icm.c
* Unmerged path drivers/thunderbolt/nhi.h
* Unmerged path drivers/thunderbolt/switch.c
* Unmerged path drivers/thunderbolt/tb.c
* Unmerged path drivers/thunderbolt/tb.h
* Unmerged path Documentation/ABI/testing/sysfs-bus-thunderbolt
* Unmerged path drivers/thunderbolt/Kconfig
* Unmerged path drivers/thunderbolt/domain.c
* Unmerged path drivers/thunderbolt/icm.c
* Unmerged path drivers/thunderbolt/nhi.h
* Unmerged path drivers/thunderbolt/switch.c
* Unmerged path drivers/thunderbolt/tb.c
* Unmerged path drivers/thunderbolt/tb.h
