qed: Revise MFW command locking

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Tomer Tayar <Tomer.Tayar@cavium.com>
commit 4ed1eea82a21ba460e53468cc1c73cfdf83d0e00
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/4ed1eea8.failed

Interaction of driver -> management firmware is based
on a one-pending mailbox [per interface], and various
mailbox commands need to be synchronized.

Current scheme is messy, and there's a difficulty extending
it as it deals differently with various commands as well as
making assumption on the required behavior for load/unload
requests.

Drop the current scheme into a completion-list-based approach;
Each flow would try sending the command when possible,
allowing one flow to complete another flow's completion and
relieve the mailbox before sending its own command.

	Signed-off-by: Tomer Tayar <Tomer.Tayar@cavium.com>
	Signed-off-by: Yuval Mintz <Yuval.Mintz@cavium.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 4ed1eea82a21ba460e53468cc1c73cfdf83d0e00)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/qlogic/qed/qed_mcp.c
#	drivers/net/ethernet/qlogic/qed/qed_mcp.h
diff --cc drivers/net/ethernet/qlogic/qed/qed_mcp.c
index 1cc3e9b6cf0b,0d157de83897..000000000000
--- a/drivers/net/ethernet/qlogic/qed/qed_mcp.c
+++ b/drivers/net/ethernet/qlogic/qed/qed_mcp.c
@@@ -190,9 -255,6 +255,12 @@@ int qed_mcp_cmd_init(struct qed_hwfn *p
  	if (!p_info->mfw_mb_shadow || !p_info->mfw_mb_addr)
  		goto err;
  
++<<<<<<< HEAD
 +	/* Initialize the MFW spinlock */
 +	spin_lock_init(&p_info->lock);
 +
++=======
++>>>>>>> 4ed1eea82a21 (qed: Revise MFW command locking)
  	return 0;
  
  err:
diff --cc drivers/net/ethernet/qlogic/qed/qed_mcp.h
index f2623df65ec2,0f7b26818acf..000000000000
--- a/drivers/net/ethernet/qlogic/qed/qed_mcp.h
+++ b/drivers/net/ethernet/qlogic/qed/qed_mcp.h
@@@ -484,7 -484,18 +484,22 @@@ int qed_mcp_bist_nvm_test_get_image_att
  				  qed_device_num_engines((_p_hwfn)->cdev)))
  
  struct qed_mcp_info {
++<<<<<<< HEAD
 +	spinlock_t				lock;
++=======
+ 	/* List for mailbox commands which were sent and wait for a response */
+ 	struct list_head			cmd_list;
+ 
+ 	/* Spinlock used for protecting the access to the mailbox commands list
+ 	 * and the sending of the commands.
+ 	 */
+ 	spinlock_t				cmd_lock;
+ 
+ 	/* Spinlock used for syncing SW link-changes and link-changes
+ 	 * originating from attention context.
+ 	 */
+ 	spinlock_t				link_lock;
++>>>>>>> 4ed1eea82a21 (qed: Revise MFW command locking)
  	bool					block_mb_sending;
  	u32					public_base;
  	u32					drv_mb_addr;
* Unmerged path drivers/net/ethernet/qlogic/qed/qed_mcp.c
* Unmerged path drivers/net/ethernet/qlogic/qed/qed_mcp.h
