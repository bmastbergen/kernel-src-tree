scsi: sas: move scsi_remove_host call into sas_remove_host

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Johannes Thumshirn <jthumshirn@suse.de>
commit c5ce0abeb62845352d7428d6b82e5b52e8728f12
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/c5ce0abe.failed

Move scsi_remove_host call into sas_remove_host and remove it from SAS
HBA drivers, so we don't mess up the ordering. This solves an issue with
double deleting sysfs entries that was introduced by the change of sysfs
behaviour from commit bcdde7e221a8 ("sysfs: make __sysfs_remove_dir()
recursive").

[mkp: addressed checkpatch complaints]

	Signed-off-by: Johannes Thumshirn <jthumshirn@suse.de>
	Suggested-by: Christoph Hellwig <hch@lst.de>
	Cc: Hannes Reinecke <hare@suse.de>
	Cc: James Bottomley <jejb@linux.vnet.ibm.com>
	Cc: Jinpu Wang <jinpu.wang@profitbricks.com>
	Cc: John Garry <john.garry@huawei.com>
	Reviewed-by: Christoph Hellwig <hch@lst.de>
	Reviewed-by: Jinpu Wang <jinpu.wang@profitbricks.com>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit c5ce0abeb62845352d7428d6b82e5b52e8728f12)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/hisi_sas/hisi_sas_main.c
#	drivers/scsi/mvsas/mv_init.c
#	drivers/scsi/pm8001/pm8001_init.c
diff --cc drivers/scsi/mvsas/mv_init.c
index 02474d41dbc6,4e047b5001a6..000000000000
--- a/drivers/scsi/mvsas/mv_init.c
+++ b/drivers/scsi/mvsas/mv_init.c
@@@ -645,10 -642,8 +645,13 @@@ static void mvs_pci_remove(struct pci_d
  	tasklet_kill(&((struct mvs_prv_info *)sha->lldd_ha)->mv_tasklet);
  #endif
  
++<<<<<<< HEAD
 +	pci_set_drvdata(pdev, NULL);
++=======
++>>>>>>> c5ce0abeb628 (scsi: sas: move scsi_remove_host call into sas_remove_host)
  	sas_unregister_ha(sha);
  	sas_remove_host(mvi->shost);
 +	scsi_remove_host(mvi->shost);
  
  	MVS_CHIP_DISP->interrupt_disable(mvi);
  	free_irq(mvi->pdev->irq, sha);
diff --cc drivers/scsi/pm8001/pm8001_init.c
index bd6a3b0d923d,034b2f7d1135..000000000000
--- a/drivers/scsi/pm8001/pm8001_init.c
+++ b/drivers/scsi/pm8001/pm8001_init.c
@@@ -937,7 -1088,6 +937,10 @@@ static void pm8001_pci_remove(struct pc
  	struct pm8001_hba_info *pm8001_ha;
  	int i, j;
  	pm8001_ha = sha->lldd_ha;
++<<<<<<< HEAD
 +	pci_set_drvdata(pdev, NULL);
++=======
++>>>>>>> c5ce0abeb628 (scsi: sas: move scsi_remove_host call into sas_remove_host)
  	sas_unregister_ha(sha);
  	sas_remove_host(pm8001_ha->shost);
  	list_del(&pm8001_ha->list);
* Unmerged path drivers/scsi/hisi_sas/hisi_sas_main.c
* Unmerged path drivers/scsi/hisi_sas/hisi_sas_main.c
diff --git a/drivers/scsi/isci/init.c b/drivers/scsi/isci/init.c
index 122172239fc4..7017692d6ac0 100644
--- a/drivers/scsi/isci/init.c
+++ b/drivers/scsi/isci/init.c
@@ -273,7 +273,6 @@ static void isci_unregister(struct isci_host *isci_host)
 		return;
 
 	shost = to_shost(isci_host);
-	scsi_remove_host(shost);
 	sas_unregister_ha(&isci_host->sas_ha);
 
 	sas_remove_host(shost);
diff --git a/drivers/scsi/mpt3sas/mpt3sas_scsih.c b/drivers/scsi/mpt3sas/mpt3sas_scsih.c
index 7a5d3ff1cab5..43ac41553db3 100644
--- a/drivers/scsi/mpt3sas/mpt3sas_scsih.c
+++ b/drivers/scsi/mpt3sas/mpt3sas_scsih.c
@@ -8410,7 +8410,6 @@ static void scsih_remove(struct pci_dev *pdev)
 	}
 
 	sas_remove_host(shost);
-	scsi_remove_host(shost);
 	mpt3sas_base_detach(ioc);
 	spin_lock(&gioc_lock);
 	list_del(&ioc->list);
* Unmerged path drivers/scsi/mvsas/mv_init.c
* Unmerged path drivers/scsi/pm8001/pm8001_init.c
diff --git a/drivers/scsi/scsi_transport_sas.c b/drivers/scsi/scsi_transport_sas.c
index 60d5b58e2cde..d2cae3cf1a54 100644
--- a/drivers/scsi/scsi_transport_sas.c
+++ b/drivers/scsi/scsi_transport_sas.c
@@ -357,12 +357,16 @@ EXPORT_SYMBOL(sas_remove_children);
  * sas_remove_host  -  tear down a Scsi_Host's SAS data structures
  * @shost:	Scsi Host that is torn down
  *
- * Removes all SAS PHYs and remote PHYs for a given Scsi_Host.
- * Must be called just before scsi_remove_host for SAS HBAs.
+ * Removes all SAS PHYs and remote PHYs for a given Scsi_Host and remove the
+ * Scsi_Host as well.
+ *
+ * Note: Do not call scsi_remove_host() on the Scsi_Host any more, as it is
+ * already removed.
  */
 void sas_remove_host(struct Scsi_Host *shost)
 {
 	sas_remove_children(&shost->shost_gendev);
+	scsi_remove_host(shost);
 }
 EXPORT_SYMBOL(sas_remove_host);
 
