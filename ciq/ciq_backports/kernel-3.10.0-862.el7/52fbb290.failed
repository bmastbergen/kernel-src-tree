net: sched: fix qdisc->running lockdep annotations

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
Rebuild_CHGLOG: - [net] sched: fix qdisc->running lockdep annotations (Ivan Vecera) [1445420]
Rebuild_FUZZ: 94.74%
commit-author Eric Dumazet <edumazet@google.com>
commit 52fbb2907988aa0583c6d9d53a56aee090b2df7e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/52fbb290.failed

1) qdisc_run_begin() is really using the equivalent of a trylock.
  Instead of using write_seqcount_begin(), use a combination of
  raw_write_seqcount_begin() and correct lockdep annotation.

2) sch_direct_xmit() should use regular spin_lock(root_lock)

Fixes: f9eb8aea2a1e ("net_sched: transform qdisc running bit into a seqcount")
	Signed-off-by: Eric Dumazet <edumazet@google.com>
	Reported-by: David Ahern <dsa@cumulusnetworks.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 52fbb2907988aa0583c6d9d53a56aee090b2df7e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	include/net/sch_generic.h
diff --cc include/net/sch_generic.h
index 8b49c889ccf1,a4c0f1649e2b..000000000000
--- a/include/net/sch_generic.h
+++ b/include/net/sch_generic.h
@@@ -106,7 -97,11 +106,15 @@@ static inline bool qdisc_run_begin(stru
  {
  	if (qdisc_is_running(qdisc))
  		return false;
++<<<<<<< HEAD
 +	qdisc->__state |= __QDISC___STATE_RUNNING;
++=======
+ 	/* Variant of write_seqcount_begin() telling lockdep a trylock
+ 	 * was attempted.
+ 	 */
+ 	raw_write_seqcount_begin(&qdisc->running);
+ 	seqcount_acquire(&qdisc->running.dep_map, 0, 1, _RET_IP_);
++>>>>>>> 52fbb2907988 (net: sched: fix qdisc->running lockdep annotations)
  	return true;
  }
  
* Unmerged path include/net/sch_generic.h
