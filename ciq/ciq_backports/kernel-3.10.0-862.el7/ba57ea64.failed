allow O_TMPFILE to work with O_WRONLY

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Al Viro <viro@zeniv.linux.org.uk>
commit ba57ea64cb1820deb37637de0fdb107f0dc90089
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/ba57ea64.failed

	Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
(cherry picked from commit ba57ea64cb1820deb37637de0fdb107f0dc90089)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/open.c
#	include/uapi/asm-generic/fcntl.h
diff --cc fs/open.c
index 3b44d9576d1b,d53e29895082..000000000000
--- a/fs/open.c
+++ b/fs/open.c
@@@ -930,11 -840,17 +930,25 @@@ static inline int build_open_flags(int 
  	if (flags & __O_SYNC)
  		flags |= O_DSYNC;
  
++<<<<<<< HEAD
 +	/*
 +	 * If we have O_PATH in the open flag. Then we
 +	 * cannot have anything other than the below set of flags
 +	 */
 +	if (flags & O_PATH) {
++=======
+ 	if (flags & __O_TMPFILE) {
+ 		if ((flags & O_TMPFILE_MASK) != O_TMPFILE)
+ 			return -EINVAL;
+ 		acc_mode = MAY_OPEN | ACC_MODE(flags);
+ 		if (!(acc_mode & MAY_WRITE))
+ 			return -EINVAL;
+ 	} else if (flags & O_PATH) {
+ 		/*
+ 		 * If we have O_PATH in the open flag. Then we
+ 		 * cannot have anything other than the below set of flags
+ 		 */
++>>>>>>> ba57ea64cb18 (allow O_TMPFILE to work with O_WRONLY)
  		flags &= O_DIRECTORY | O_NOFOLLOW | O_PATH;
  		acc_mode = 0;
  	} else {
diff --cc include/uapi/asm-generic/fcntl.h
index 729af84a016e,95e46c8e05f9..000000000000
--- a/include/uapi/asm-generic/fcntl.h
+++ b/include/uapi/asm-generic/fcntl.h
@@@ -84,6 -84,14 +84,17 @@@
  #define O_PATH		010000000
  #endif
  
++<<<<<<< HEAD
++=======
+ #ifndef __O_TMPFILE
+ #define __O_TMPFILE	020000000
+ #endif
+ 
+ /* a horrid kludge trying to make sure that this will fail on old kernels */
+ #define O_TMPFILE (__O_TMPFILE | O_DIRECTORY)
+ #define O_TMPFILE_MASK (__O_TMPFILE | O_DIRECTORY | O_CREAT)      
+ 
++>>>>>>> ba57ea64cb18 (allow O_TMPFILE to work with O_WRONLY)
  #ifndef O_NDELAY
  #define O_NDELAY	O_NONBLOCK
  #endif
* Unmerged path fs/open.c
* Unmerged path include/uapi/asm-generic/fcntl.h
