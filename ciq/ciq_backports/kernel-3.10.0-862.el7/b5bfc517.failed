livepatch: move x86 specific ftrace handler code to arch/x86

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Li Bin <huawei.libin@huawei.com>
commit b5bfc51707f1b56b0b733980bb4fcc0562bf02d8
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/b5bfc517.failed

The execution flow redirection related implemention in the livepatch
ftrace handler is depended on the specific architecture. This patch
introduces klp_arch_set_pc(like kgdb_arch_set_pc) interface to change
the pt_regs.

	Signed-off-by: Li Bin <huawei.libin@huawei.com>
	Acked-by: Josh Poimboeuf <jpoimboe@redhat.com>
	Signed-off-by: Jiri Kosina <jkosina@suse.cz>
(cherry picked from commit b5bfc51707f1b56b0b733980bb4fcc0562bf02d8)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	kernel/livepatch/core.c
#	tools/objtool/special.h
diff --cc tools/objtool/special.h
index fad1d092f679,b5608d7757fd..000000000000
--- a/tools/objtool/special.h
+++ b/tools/objtool/special.h
@@@ -15,28 -18,25 +15,43 @@@
   * along with this program; if not, see <http://www.gnu.org/licenses/>.
   */
  
 -#ifndef _ASM_X86_LIVEPATCH_H
 -#define _ASM_X86_LIVEPATCH_H
 +#ifndef _SPECIAL_H
 +#define _SPECIAL_H
  
++<<<<<<< HEAD:tools/objtool/special.h
 +#include <stdbool.h>
 +#include "elf.h"
++=======
+ #include <linux/module.h>
+ #include <linux/ftrace.h>
++>>>>>>> b5bfc51707f1 (livepatch: move x86 specific ftrace handler code to arch/x86):arch/x86/include/asm/livepatch.h
  
 -#ifdef CONFIG_LIVE_PATCHING
 -#ifndef CC_USING_FENTRY
 -#error Your compiler must support -mfentry for live patching to work
 -#endif
 -extern int klp_write_module_reloc(struct module *mod, unsigned long type,
 -				  unsigned long loc, unsigned long value);
 +struct special_alt {
 +	struct list_head list;
  
++<<<<<<< HEAD:tools/objtool/special.h
 +	bool group;
 +	bool skip_orig;
 +	bool jump_or_nop;
++=======
+ static inline void klp_arch_set_pc(struct pt_regs *regs, unsigned long ip)
+ {
+ 	regs->ip = ip;
+ }
+ #else
+ #error Live patching support is disabled; check CONFIG_LIVE_PATCHING
+ #endif
++>>>>>>> b5bfc51707f1 (livepatch: move x86 specific ftrace handler code to arch/x86):arch/x86/include/asm/livepatch.h
 +
 +	struct section *orig_sec;
 +	unsigned long orig_off;
 +
 +	struct section *new_sec;
 +	unsigned long new_off;
 +
 +	unsigned int orig_len, new_len; /* group only */
 +};
 +
 +int special_get_alts(struct elf *elf, struct list_head *alts);
  
 -#endif /* _ASM_X86_LIVEPATCH_H */
 +#endif /* _SPECIAL_H */
* Unmerged path kernel/livepatch/core.c
* Unmerged path kernel/livepatch/core.c
* Unmerged path tools/objtool/special.h
