iwlwifi: mvm: flush queue before deleting ROC

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Johannes Berg <johannes.berg@intel.com>
commit 6c2d49fdc5d947c5fe89935bd52e69f10000f4cb
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/6c2d49fd.failed

Before deleting a time event (remain-on-channel instance), flush
the queue so that frames cannot get stuck on it. We already flush
the AUX STA queues, but a separate station is used for the P2P
Device queue.

	Cc: stable@vger.kernel.org
	Signed-off-by: Johannes Berg <johannes.berg@intel.com>
	Signed-off-by: Luca Coelho <luciano.coelho@intel.com>
(cherry picked from commit 6c2d49fdc5d947c5fe89935bd52e69f10000f4cb)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/wireless/intel/iwlwifi/mvm/mvm.h
#	drivers/net/wireless/intel/iwlwifi/mvm/time-event.c
diff --cc drivers/net/wireless/intel/iwlwifi/mvm/mvm.h
index 73a216524af2,55ab5349dd40..000000000000
--- a/drivers/net/wireless/intel/iwlwifi/mvm/mvm.h
+++ b/drivers/net/wireless/intel/iwlwifi/mvm/mvm.h
@@@ -1044,6 -1050,19 +1044,22 @@@ struct iwl_mvm 
  #define IWL_MAC80211_GET_MVM(_hw)			\
  	IWL_OP_MODE_GET_MVM((struct iwl_op_mode *)((_hw)->priv))
  
++<<<<<<< HEAD
++=======
+ /**
+  * enum iwl_mvm_status - MVM status bits
+  * @IWL_MVM_STATUS_HW_RFKILL: HW RF-kill is asserted
+  * @IWL_MVM_STATUS_HW_CTKILL: CT-kill is active
+  * @IWL_MVM_STATUS_ROC_RUNNING: remain-on-channel is running
+  * @IWL_MVM_STATUS_HW_RESTART_REQUESTED: HW restart was requested
+  * @IWL_MVM_STATUS_IN_HW_RESTART: HW restart is active
+  * @IWL_MVM_STATUS_IN_D0I3: NIC is in D0i3
+  * @IWL_MVM_STATUS_ROC_AUX_RUNNING: AUX remain-on-channel is running
+  * @IWL_MVM_STATUS_D3_RECONFIG: D3 reconfiguration is being done
+  * @IWL_MVM_STATUS_FIRMWARE_RUNNING: firmware is running
+  * @IWL_MVM_STATUS_NEED_FLUSH_P2P: need to flush P2P bcast STA
+  */
++>>>>>>> 6c2d49fdc5d9 (iwlwifi: mvm: flush queue before deleting ROC)
  enum iwl_mvm_status {
  	IWL_MVM_STATUS_HW_RFKILL,
  	IWL_MVM_STATUS_HW_CTKILL,
@@@ -1052,7 -1072,16 +1068,20 @@@
  	IWL_MVM_STATUS_IN_D0I3,
  	IWL_MVM_STATUS_ROC_AUX_RUNNING,
  	IWL_MVM_STATUS_D3_RECONFIG,
++<<<<<<< HEAD
 +	IWL_MVM_STATUS_DUMPING_FW_LOG,
++=======
+ 	IWL_MVM_STATUS_FIRMWARE_RUNNING,
+ 	IWL_MVM_STATUS_NEED_FLUSH_P2P,
+ };
+ 
+ /* Keep track of completed init configuration */
+ enum iwl_mvm_init_status {
+ 	IWL_MVM_INIT_STATUS_THERMAL_INIT_COMPLETE = BIT(0),
+ 	IWL_MVM_INIT_STATUS_LEDS_INIT_COMPLETE = BIT(1),
+ 	IWL_MVM_INIT_STATUS_REG_HW_INIT_COMPLETE = BIT(2),
+ 	IWL_MVM_INIT_STATUS_TOF_INIT_COMPLETE = BIT(3),
++>>>>>>> 6c2d49fdc5d9 (iwlwifi: mvm: flush queue before deleting ROC)
  };
  
  static inline bool iwl_mvm_is_radio_killed(struct iwl_mvm *mvm)
diff --cc drivers/net/wireless/intel/iwlwifi/mvm/time-event.c
index 2c12789e7550,e25cda9fbf6c..000000000000
--- a/drivers/net/wireless/intel/iwlwifi/mvm/time-event.c
+++ b/drivers/net/wireless/intel/iwlwifi/mvm/time-event.c
@@@ -130,7 -131,25 +130,29 @@@ void iwl_mvm_roc_done_wk(struct work_st
  	 * issue as it will have to complete before the next command is
  	 * executed, and a new time event means a new command.
  	 */
++<<<<<<< HEAD
 +	iwl_mvm_flush_tx_path(mvm, queues, CMD_ASYNC);
++=======
+ 	iwl_mvm_flush_sta(mvm, &mvm->aux_sta, true, CMD_ASYNC);
+ 
+ 	/* Do the same for the P2P device queue (STA) */
+ 	if (test_and_clear_bit(IWL_MVM_STATUS_NEED_FLUSH_P2P, &mvm->status)) {
+ 		struct iwl_mvm_vif *mvmvif;
+ 
+ 		/*
+ 		 * NB: access to this pointer would be racy, but the flush bit
+ 		 * can only be set when we had a P2P-Device VIF, and we have a
+ 		 * flush of this work in iwl_mvm_prepare_mac_removal() so it's
+ 		 * not really racy.
+ 		 */
+ 
+ 		if (!WARN_ON(!mvm->p2p_device_vif)) {
+ 			mvmvif = iwl_mvm_vif_from_mac80211(mvm->p2p_device_vif);
+ 			iwl_mvm_flush_sta(mvm, &mvmvif->bcast_sta, true,
+ 					  CMD_ASYNC);
+ 		}
+ 	}
++>>>>>>> 6c2d49fdc5d9 (iwlwifi: mvm: flush queue before deleting ROC)
  }
  
  static void iwl_mvm_roc_finished(struct iwl_mvm *mvm)
* Unmerged path drivers/net/wireless/intel/iwlwifi/mvm/mvm.h
* Unmerged path drivers/net/wireless/intel/iwlwifi/mvm/time-event.c
