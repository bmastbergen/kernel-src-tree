ASoC: codec: Simplify ASoC probe code.

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
Rebuild_CHGLOG: - [sound] alsa: asoc: codec: Simplify ASoC probe code (Jaroslav Kysela) [1463624]
Rebuild_FUZZ: 91.36%
commit-author Xiubo Li <Li.Xiubo@freescale.com>
commit 5d6be5aa6becc750c5c2aa0ef8f7209ce19aa328
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/5d6be5aa.failed

For some CODEC drivers like who act as the MFDs children are ignored
by this patch.

	Signed-off-by: Xiubo Li <Li.Xiubo@freescale.com>
	Signed-off-by: Mark Brown <broonie@linaro.org>
(cherry picked from commit 5d6be5aa6becc750c5c2aa0ef8f7209ce19aa328)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	sound/soc/codecs/ad193x.c
#	sound/soc/codecs/adau1373.c
#	sound/soc/codecs/adav80x.c
#	sound/soc/codecs/ak4535.c
#	sound/soc/codecs/ak4641.c
#	sound/soc/codecs/ak4642.c
#	sound/soc/codecs/ak4671.c
#	sound/soc/codecs/alc5623.c
#	sound/soc/codecs/alc5632.c
#	sound/soc/codecs/cs4270.c
#	sound/soc/codecs/cs42l51.c
#	sound/soc/codecs/cs42l52.c
#	sound/soc/codecs/cs42l73.c
#	sound/soc/codecs/da7210.c
#	sound/soc/codecs/da7213.c
#	sound/soc/codecs/da732x.c
#	sound/soc/codecs/da9055.c
#	sound/soc/codecs/isabelle.c
#	sound/soc/codecs/lm49453.c
#	sound/soc/codecs/max9768.c
#	sound/soc/codecs/max98088.c
#	sound/soc/codecs/max98095.c
#	sound/soc/codecs/max9850.c
#	sound/soc/codecs/ml26124.c
#	sound/soc/codecs/rt5631.c
#	sound/soc/codecs/rt5640.c
#	sound/soc/codecs/ssm2518.c
#	sound/soc/codecs/ssm2602.c
#	sound/soc/codecs/sta32x.c
#	sound/soc/codecs/sta529.c
#	sound/soc/codecs/tlv320aic23.c
#	sound/soc/codecs/tlv320aic26.c
#	sound/soc/codecs/tlv320aic32x4.c
#	sound/soc/codecs/tlv320aic3x.c
#	sound/soc/codecs/wm2000.c
#	sound/soc/codecs/wm2200.c
#	sound/soc/codecs/wm5100.c
#	sound/soc/codecs/wm8510.c
#	sound/soc/codecs/wm8523.c
#	sound/soc/codecs/wm8580.c
#	sound/soc/codecs/wm8711.c
#	sound/soc/codecs/wm8728.c
#	sound/soc/codecs/wm8731.c
#	sound/soc/codecs/wm8737.c
#	sound/soc/codecs/wm8741.c
#	sound/soc/codecs/wm8750.c
#	sound/soc/codecs/wm8753.c
#	sound/soc/codecs/wm8770.c
#	sound/soc/codecs/wm8776.c
#	sound/soc/codecs/wm8804.c
#	sound/soc/codecs/wm8900.c
#	sound/soc/codecs/wm8903.c
#	sound/soc/codecs/wm8904.c
#	sound/soc/codecs/wm8940.c
#	sound/soc/codecs/wm8955.c
#	sound/soc/codecs/wm8960.c
#	sound/soc/codecs/wm8961.c
#	sound/soc/codecs/wm8962.c
#	sound/soc/codecs/wm8971.c
#	sound/soc/codecs/wm8974.c
#	sound/soc/codecs/wm8978.c
#	sound/soc/codecs/wm8983.c
#	sound/soc/codecs/wm8985.c
#	sound/soc/codecs/wm8988.c
#	sound/soc/codecs/wm8990.c
#	sound/soc/codecs/wm8991.c
#	sound/soc/codecs/wm8993.c
#	sound/soc/codecs/wm8995.c
#	sound/soc/codecs/wm8996.c
#	sound/soc/codecs/wm9081.c
#	sound/soc/codecs/wm9090.c
diff --cc sound/soc/codecs/rt5640.c
index 11057d8aef69,074cff100f54..000000000000
--- a/sound/soc/codecs/rt5640.c
+++ b/sound/soc/codecs/rt5640.c
@@@ -2018,115 -1940,14 +2018,119 @@@ static int rt5640_set_bias_level(struc
  	return 0;
  }
  
 +int rt5640_dmic_enable(struct snd_soc_codec *codec,
 +		       bool dmic1_data_pin, bool dmic2_data_pin)
 +{
 +	struct rt5640_priv *rt5640 = snd_soc_codec_get_drvdata(codec);
 +
++<<<<<<< HEAD
 +	regmap_update_bits(rt5640->regmap, RT5640_GPIO_CTRL1,
 +		RT5640_GP2_PIN_MASK, RT5640_GP2_PIN_DMIC1_SCL);
 +
 +	if (dmic1_data_pin) {
 +		regmap_update_bits(rt5640->regmap, RT5640_DMIC,
 +			RT5640_DMIC_1_DP_MASK, RT5640_DMIC_1_DP_GPIO3);
 +		regmap_update_bits(rt5640->regmap, RT5640_GPIO_CTRL1,
 +			RT5640_GP3_PIN_MASK, RT5640_GP3_PIN_DMIC1_SDA);
 +	}
++=======
++	rt5640->codec = codec;
++>>>>>>> 5d6be5aa6bec (ASoC: codec: Simplify ASoC probe code.)
 +
 +	if (dmic2_data_pin) {
 +		regmap_update_bits(rt5640->regmap, RT5640_DMIC,
 +			RT5640_DMIC_2_DP_MASK, RT5640_DMIC_2_DP_GPIO4);
 +		regmap_update_bits(rt5640->regmap, RT5640_GPIO_CTRL1,
 +			RT5640_GP4_PIN_MASK, RT5640_GP4_PIN_DMIC2_SDA);
 +	}
 +
 +	return 0;
 +}
 +EXPORT_SYMBOL_GPL(rt5640_dmic_enable);
 +
 +int rt5640_sel_asrc_clk_src(struct snd_soc_codec *codec,
 +		unsigned int filter_mask, unsigned int clk_src)
 +{
 +	struct rt5640_priv *rt5640 = snd_soc_codec_get_drvdata(codec);
 +	unsigned int asrc2_mask = 0;
 +	unsigned int asrc2_value = 0;
 +
 +	switch (clk_src) {
 +	case RT5640_CLK_SEL_SYS:
 +	case RT5640_CLK_SEL_ASRC:
 +		break;
 +
 +	default:
 +		return -EINVAL;
 +	}
 +
 +	if (!filter_mask)
 +		return -EINVAL;
 +
 +	if (filter_mask & RT5640_DA_STEREO_FILTER) {
 +		asrc2_mask |= RT5640_STO_DAC_M_MASK;
 +		asrc2_value = (asrc2_value & ~RT5640_STO_DAC_M_MASK)
 +			| (clk_src << RT5640_STO_DAC_M_SFT);
 +	}
 +
 +	if (filter_mask & RT5640_DA_MONO_L_FILTER) {
 +		asrc2_mask |= RT5640_MDA_L_M_MASK;
 +		asrc2_value = (asrc2_value & ~RT5640_MDA_L_M_MASK)
 +			| (clk_src << RT5640_MDA_L_M_SFT);
 +	}
 +
 +	if (filter_mask & RT5640_DA_MONO_R_FILTER) {
 +		asrc2_mask |= RT5640_MDA_R_M_MASK;
 +		asrc2_value = (asrc2_value & ~RT5640_MDA_R_M_MASK)
 +			| (clk_src << RT5640_MDA_R_M_SFT);
 +	}
 +
 +	if (filter_mask & RT5640_AD_STEREO_FILTER) {
 +		asrc2_mask |= RT5640_ADC_M_MASK;
 +		asrc2_value = (asrc2_value & ~RT5640_ADC_M_MASK)
 +			| (clk_src << RT5640_ADC_M_SFT);
 +	}
 +
 +	if (filter_mask & RT5640_AD_MONO_L_FILTER) {
 +		asrc2_mask |= RT5640_MAD_L_M_MASK;
 +		asrc2_value = (asrc2_value & ~RT5640_MAD_L_M_MASK)
 +			| (clk_src << RT5640_MAD_L_M_SFT);
 +	}
 +
 +	if (filter_mask & RT5640_AD_MONO_R_FILTER)  {
 +		asrc2_mask |= RT5640_MAD_R_M_MASK;
 +		asrc2_value = (asrc2_value & ~RT5640_MAD_R_M_MASK)
 +			| (clk_src << RT5640_MAD_R_M_SFT);
 +	}
 +
 +	snd_soc_update_bits(codec, RT5640_ASRC_2,
 +		asrc2_mask, asrc2_value);
 +
 +	if (snd_soc_read(codec, RT5640_ASRC_2)) {
 +		rt5640->asrc_en = true;
 +		snd_soc_update_bits(codec, RT5640_JD_CTRL, 0x3, 0x3);
 +	} else {
 +		rt5640->asrc_en = false;
 +		snd_soc_update_bits(codec, RT5640_JD_CTRL, 0x3, 0x0);
 +	}
 +
 +	return 0;
 +}
 +EXPORT_SYMBOL_GPL(rt5640_sel_asrc_clk_src);
 +
  static int rt5640_probe(struct snd_soc_codec *codec)
  {
 +	struct snd_soc_dapm_context *dapm = snd_soc_codec_get_dapm(codec);
  	struct rt5640_priv *rt5640 = snd_soc_codec_get_drvdata(codec);
  
 +	/* Check if MCLK provided */
 +	rt5640->mclk = devm_clk_get(codec->dev, "mclk");
 +	if (PTR_ERR(rt5640->mclk) == -EPROBE_DEFER)
 +		return -EPROBE_DEFER;
 +
  	rt5640->codec = codec;
  
 -	codec->dapm.idle_bias_off = 1;
 -	rt5640_set_bias_level(codec, SND_SOC_BIAS_OFF);
 +	snd_soc_codec_force_bias_level(codec, SND_SOC_BIAS_OFF);
  
  	snd_soc_update_bits(codec, RT5640_DUMMY1, 0x0301, 0x0301);
  	snd_soc_update_bits(codec, RT5640_MICBIAS, 0x0030, 0x0030);
diff --cc sound/soc/codecs/ssm2518.c
index 38a85f3adc80,cf4a6572f35b..000000000000
--- a/sound/soc/codecs/ssm2518.c
+++ b/sound/soc/codecs/ssm2518.c
@@@ -641,6 -646,17 +641,20 @@@ static struct snd_soc_dai_driver ssm251
  	.ops = &ssm2518_dai_ops,
  };
  
++<<<<<<< HEAD
++=======
+ static int ssm2518_probe(struct snd_soc_codec *codec)
+ {
+ 	return ssm2518_set_bias_level(codec, SND_SOC_BIAS_OFF);
+ }
+ 
+ static int ssm2518_remove(struct snd_soc_codec *codec)
+ {
+ 	ssm2518_set_bias_level(codec, SND_SOC_BIAS_OFF);
+ 	return 0;
+ }
+ 
++>>>>>>> 5d6be5aa6bec (ASoC: codec: Simplify ASoC probe code.)
  static int ssm2518_set_sysclk(struct snd_soc_codec *codec, int clk_id,
  	int source, unsigned int freq, int dir)
  {
* Unmerged path sound/soc/codecs/ad193x.c
* Unmerged path sound/soc/codecs/adau1373.c
* Unmerged path sound/soc/codecs/adav80x.c
* Unmerged path sound/soc/codecs/ak4535.c
* Unmerged path sound/soc/codecs/ak4641.c
* Unmerged path sound/soc/codecs/ak4642.c
* Unmerged path sound/soc/codecs/ak4671.c
* Unmerged path sound/soc/codecs/alc5623.c
* Unmerged path sound/soc/codecs/alc5632.c
* Unmerged path sound/soc/codecs/cs4270.c
* Unmerged path sound/soc/codecs/cs42l51.c
* Unmerged path sound/soc/codecs/cs42l52.c
* Unmerged path sound/soc/codecs/cs42l73.c
* Unmerged path sound/soc/codecs/da7210.c
* Unmerged path sound/soc/codecs/da7213.c
* Unmerged path sound/soc/codecs/da732x.c
* Unmerged path sound/soc/codecs/da9055.c
* Unmerged path sound/soc/codecs/isabelle.c
* Unmerged path sound/soc/codecs/lm49453.c
* Unmerged path sound/soc/codecs/max9768.c
* Unmerged path sound/soc/codecs/max98088.c
* Unmerged path sound/soc/codecs/max98095.c
* Unmerged path sound/soc/codecs/max9850.c
* Unmerged path sound/soc/codecs/ml26124.c
* Unmerged path sound/soc/codecs/rt5631.c
* Unmerged path sound/soc/codecs/ssm2602.c
* Unmerged path sound/soc/codecs/sta32x.c
* Unmerged path sound/soc/codecs/sta529.c
* Unmerged path sound/soc/codecs/tlv320aic23.c
* Unmerged path sound/soc/codecs/tlv320aic26.c
* Unmerged path sound/soc/codecs/tlv320aic32x4.c
* Unmerged path sound/soc/codecs/tlv320aic3x.c
* Unmerged path sound/soc/codecs/wm2000.c
* Unmerged path sound/soc/codecs/wm2200.c
* Unmerged path sound/soc/codecs/wm5100.c
* Unmerged path sound/soc/codecs/wm8510.c
* Unmerged path sound/soc/codecs/wm8523.c
* Unmerged path sound/soc/codecs/wm8580.c
* Unmerged path sound/soc/codecs/wm8711.c
* Unmerged path sound/soc/codecs/wm8728.c
* Unmerged path sound/soc/codecs/wm8731.c
* Unmerged path sound/soc/codecs/wm8737.c
* Unmerged path sound/soc/codecs/wm8741.c
* Unmerged path sound/soc/codecs/wm8750.c
* Unmerged path sound/soc/codecs/wm8753.c
* Unmerged path sound/soc/codecs/wm8770.c
* Unmerged path sound/soc/codecs/wm8776.c
* Unmerged path sound/soc/codecs/wm8804.c
* Unmerged path sound/soc/codecs/wm8900.c
* Unmerged path sound/soc/codecs/wm8903.c
* Unmerged path sound/soc/codecs/wm8904.c
* Unmerged path sound/soc/codecs/wm8940.c
* Unmerged path sound/soc/codecs/wm8955.c
* Unmerged path sound/soc/codecs/wm8960.c
* Unmerged path sound/soc/codecs/wm8961.c
* Unmerged path sound/soc/codecs/wm8962.c
* Unmerged path sound/soc/codecs/wm8971.c
* Unmerged path sound/soc/codecs/wm8974.c
* Unmerged path sound/soc/codecs/wm8978.c
* Unmerged path sound/soc/codecs/wm8983.c
* Unmerged path sound/soc/codecs/wm8985.c
* Unmerged path sound/soc/codecs/wm8988.c
* Unmerged path sound/soc/codecs/wm8990.c
* Unmerged path sound/soc/codecs/wm8991.c
* Unmerged path sound/soc/codecs/wm8993.c
* Unmerged path sound/soc/codecs/wm8995.c
* Unmerged path sound/soc/codecs/wm8996.c
* Unmerged path sound/soc/codecs/wm9081.c
* Unmerged path sound/soc/codecs/wm9090.c
* Unmerged path sound/soc/codecs/ad193x.c
* Unmerged path sound/soc/codecs/adau1373.c
* Unmerged path sound/soc/codecs/adav80x.c
* Unmerged path sound/soc/codecs/ak4535.c
* Unmerged path sound/soc/codecs/ak4641.c
* Unmerged path sound/soc/codecs/ak4642.c
* Unmerged path sound/soc/codecs/ak4671.c
* Unmerged path sound/soc/codecs/alc5623.c
* Unmerged path sound/soc/codecs/alc5632.c
* Unmerged path sound/soc/codecs/cs4270.c
* Unmerged path sound/soc/codecs/cs42l51.c
* Unmerged path sound/soc/codecs/cs42l52.c
* Unmerged path sound/soc/codecs/cs42l73.c
* Unmerged path sound/soc/codecs/da7210.c
* Unmerged path sound/soc/codecs/da7213.c
* Unmerged path sound/soc/codecs/da732x.c
* Unmerged path sound/soc/codecs/da9055.c
* Unmerged path sound/soc/codecs/isabelle.c
* Unmerged path sound/soc/codecs/lm49453.c
* Unmerged path sound/soc/codecs/max9768.c
* Unmerged path sound/soc/codecs/max98088.c
* Unmerged path sound/soc/codecs/max98095.c
* Unmerged path sound/soc/codecs/max9850.c
* Unmerged path sound/soc/codecs/ml26124.c
* Unmerged path sound/soc/codecs/rt5631.c
* Unmerged path sound/soc/codecs/rt5640.c
* Unmerged path sound/soc/codecs/ssm2518.c
* Unmerged path sound/soc/codecs/ssm2602.c
* Unmerged path sound/soc/codecs/sta32x.c
* Unmerged path sound/soc/codecs/sta529.c
* Unmerged path sound/soc/codecs/tlv320aic23.c
* Unmerged path sound/soc/codecs/tlv320aic26.c
* Unmerged path sound/soc/codecs/tlv320aic32x4.c
* Unmerged path sound/soc/codecs/tlv320aic3x.c
* Unmerged path sound/soc/codecs/wm2000.c
* Unmerged path sound/soc/codecs/wm2200.c
* Unmerged path sound/soc/codecs/wm5100.c
* Unmerged path sound/soc/codecs/wm8510.c
* Unmerged path sound/soc/codecs/wm8523.c
* Unmerged path sound/soc/codecs/wm8580.c
* Unmerged path sound/soc/codecs/wm8711.c
* Unmerged path sound/soc/codecs/wm8728.c
* Unmerged path sound/soc/codecs/wm8731.c
* Unmerged path sound/soc/codecs/wm8737.c
* Unmerged path sound/soc/codecs/wm8741.c
* Unmerged path sound/soc/codecs/wm8750.c
* Unmerged path sound/soc/codecs/wm8753.c
* Unmerged path sound/soc/codecs/wm8770.c
* Unmerged path sound/soc/codecs/wm8776.c
* Unmerged path sound/soc/codecs/wm8804.c
* Unmerged path sound/soc/codecs/wm8900.c
* Unmerged path sound/soc/codecs/wm8903.c
* Unmerged path sound/soc/codecs/wm8904.c
* Unmerged path sound/soc/codecs/wm8940.c
* Unmerged path sound/soc/codecs/wm8955.c
* Unmerged path sound/soc/codecs/wm8960.c
* Unmerged path sound/soc/codecs/wm8961.c
* Unmerged path sound/soc/codecs/wm8962.c
* Unmerged path sound/soc/codecs/wm8971.c
* Unmerged path sound/soc/codecs/wm8974.c
* Unmerged path sound/soc/codecs/wm8978.c
* Unmerged path sound/soc/codecs/wm8983.c
* Unmerged path sound/soc/codecs/wm8985.c
* Unmerged path sound/soc/codecs/wm8988.c
* Unmerged path sound/soc/codecs/wm8990.c
* Unmerged path sound/soc/codecs/wm8991.c
* Unmerged path sound/soc/codecs/wm8993.c
* Unmerged path sound/soc/codecs/wm8995.c
* Unmerged path sound/soc/codecs/wm8996.c
* Unmerged path sound/soc/codecs/wm9081.c
* Unmerged path sound/soc/codecs/wm9090.c
