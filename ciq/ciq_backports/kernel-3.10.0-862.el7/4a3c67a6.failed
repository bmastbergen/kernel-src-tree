mlxsw: spectrum_router: Don't batch neighbour deletion

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Ido Schimmel <idosch@mellanox.com>
commit 4a3c67a6e7cd212fe799ab3d07782c7c8688b4cc
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/4a3c67a6.failed

Current firmware supported by the driver doesn't support batch deletion
of IPv6 neighbours on a given router interface (RIF).

Until a new version that supports this functionality is made available,
delete neighbours one by one.

	Signed-off-by: Ido Schimmel <idosch@mellanox.com>
	Signed-off-by: Jiri Pirko <jiri@mellanox.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 4a3c67a6e7cd212fe799ab3d07782c7c8688b4cc)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlxsw/spectrum_router.c
diff --cc drivers/net/ethernet/mellanox/mlxsw/spectrum_router.c
index 413d3ee4abb7,548552ccec3d..000000000000
--- a/drivers/net/ethernet/mellanox/mlxsw/spectrum_router.c
+++ b/drivers/net/ethernet/mellanox/mlxsw/spectrum_router.c
@@@ -1095,30 -1414,21 +1095,40 @@@ static int mlxsw_sp_neigh_init(struct m
  
  static void mlxsw_sp_neigh_fini(struct mlxsw_sp *mlxsw_sp)
  {
 -	cancel_delayed_work_sync(&mlxsw_sp->router->neighs_update.dw);
 -	cancel_delayed_work_sync(&mlxsw_sp->router->nexthop_probe_dw);
 -	rhashtable_destroy(&mlxsw_sp->router->neigh_ht);
 +	cancel_delayed_work_sync(&mlxsw_sp->router.neighs_update.dw);
 +	cancel_delayed_work_sync(&mlxsw_sp->router.nexthop_probe_dw);
 +	rhashtable_destroy(&mlxsw_sp->router.neigh_ht);
 +}
 +
++<<<<<<< HEAD
 +static int mlxsw_sp_neigh_rif_flush(struct mlxsw_sp *mlxsw_sp,
 +				    const struct mlxsw_sp_rif *r)
 +{
 +	char rauht_pl[MLXSW_REG_RAUHT_LEN];
 +
 +	mlxsw_reg_rauht_pack(rauht_pl, MLXSW_REG_RAUHT_OP_WRITE_DELETE_ALL,
 +			     r->rif, r->addr);
 +	return mlxsw_reg_write(mlxsw_sp->core, MLXSW_REG(rauht), rauht_pl);
  }
  
++=======
++>>>>>>> 4a3c67a6e7cd (mlxsw: spectrum_router: Don't batch neighbour deletion)
  static void mlxsw_sp_neigh_rif_gone_sync(struct mlxsw_sp *mlxsw_sp,
 -					 struct mlxsw_sp_rif *rif)
 +					 struct mlxsw_sp_rif *r)
  {
  	struct mlxsw_sp_neigh_entry *neigh_entry, *tmp;
  
++<<<<<<< HEAD
 +	mlxsw_sp_neigh_rif_flush(mlxsw_sp, r);
 +	list_for_each_entry_safe(neigh_entry, tmp, &r->neigh_list,
 +				 rif_list_node)
++=======
+ 	list_for_each_entry_safe(neigh_entry, tmp, &rif->neigh_list,
+ 				 rif_list_node) {
+ 		mlxsw_sp_neigh_entry_update(mlxsw_sp, neigh_entry, false);
++>>>>>>> 4a3c67a6e7cd (mlxsw: spectrum_router: Don't batch neighbour deletion)
  		mlxsw_sp_neigh_entry_destroy(mlxsw_sp, neigh_entry);
+ 	}
  }
  
  struct mlxsw_sp_nexthop_key {
* Unmerged path drivers/net/ethernet/mellanox/mlxsw/spectrum_router.c
