USB: uas: Limit qdepth at the scsi-host level

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
Rebuild_CHGLOG: - [usb] uas: Limit qdepth at the scsi-host level (Torez Smith) [1435752]
Rebuild_FUZZ: 94.12%
commit-author Hans de Goede <hdegoede@redhat.com>
commit 198de51dbc3454d95b015ca0a055b673f85f01bb
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/198de51d.failed

Commit 64d513ac31bd ("scsi: use host wide tags by default") causes
the SCSI core to queue more commands then we can handle on devices with
multiple LUNs, limit the queue depth at the scsi-host level instead of
per slave to fix this.

BugLink: https://bugzilla.redhat.com/show_bug.cgi?id=1315013
	Cc: stable@vger.kernel.org # 4.4.x and 4.5.x
	Signed-off-by: Hans de Goede <hdegoede@redhat.com>
	Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
(cherry picked from commit 198de51dbc3454d95b015ca0a055b673f85f01bb)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/usb/storage/uas.c
diff --cc drivers/usb/storage/uas.c
index d371b91ecf04,b1ec7499166d..000000000000
--- a/drivers/usb/storage/uas.c
+++ b/drivers/usb/storage/uas.c
@@@ -832,8 -820,10 +832,15 @@@ static int uas_slave_configure(struct s
  	if (devinfo->flags & US_FL_NO_REPORT_OPCODES)
  		sdev->no_report_opcodes = 1;
  
++<<<<<<< HEAD
 +	scsi_set_tag_type(sdev, MSG_ORDERED_TAG);
 +	scsi_activate_tcq(sdev, devinfo->qdepth - 2);
++=======
+ 	/* A few buggy USB-ATA bridges don't understand FUA */
+ 	if (devinfo->flags & US_FL_BROKEN_FUA)
+ 		sdev->broken_fua = 1;
+ 
++>>>>>>> 198de51dbc34 (USB: uas: Limit qdepth at the scsi-host level)
  	return 0;
  }
  
@@@ -968,9 -955,11 +975,17 @@@ static int uas_probe(struct usb_interfa
  	if (result)
  		goto set_alt0;
  
++<<<<<<< HEAD
 +	result = scsi_init_shared_tag_map(shost, devinfo->qdepth - 2);
 +	if (result)
 +		goto free_streams;
++=======
+ 	/*
+ 	 * 1 tag is reserved for untagged commands +
+ 	 * 1 tag to avoid off by one errors in some bridge firmwares
+ 	 */
+ 	shost->can_queue = devinfo->qdepth - 2;
++>>>>>>> 198de51dbc34 (USB: uas: Limit qdepth at the scsi-host level)
  
  	usb_set_intfdata(intf, shost);
  	result = scsi_add_host(shost, &intf->dev);
* Unmerged path drivers/usb/storage/uas.c
