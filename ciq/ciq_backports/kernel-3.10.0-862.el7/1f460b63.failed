blk-mq: don't restart queue when .get_budget returns BLK_STS_RESOURCE

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Ming Lei <ming.lei@redhat.com>
commit 1f460b63d4b37f504d8d0affc2cd492eb005ea97
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/1f460b63.failed

SCSI restarts its queue in scsi_end_request() automatically, so we don't
need to handle this case in blk-mq.

Especailly any request won't be dequeued in this case, we needn't to
worry about IO hang caused by restart vs. dispatch.

	Signed-off-by: Ming Lei <ming.lei@redhat.com>
	Signed-off-by: Jens Axboe <axboe@kernel.dk>
(cherry picked from commit 1f460b63d4b37f504d8d0affc2cd492eb005ea97)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	block/blk-mq-sched.c
#	block/blk-mq-sched.h
#	block/blk-mq.c
diff --cc block/blk-mq.c
index d9bfe0c6bc0e,e4d2490f4e7e..000000000000
--- a/block/blk-mq.c
+++ b/block/blk-mq.c
@@@ -950,14 -1069,187 +950,25 @@@ static void __blk_mq_run_hw_queue(struc
  	WARN_ON(!cpumask_test_cpu(raw_smp_processor_id(), hctx->cpumask) &&
  		cpu_online(hctx->next_cpu));
  
 -	/*
 -	 * We can't run the queue inline with ints disabled. Ensure that
 -	 * we catch bad users of this early.
 -	 */
 -	WARN_ON_ONCE(in_interrupt());
 -
  	if (!(hctx->flags & BLK_MQ_F_BLOCKING)) {
  		rcu_read_lock();
++<<<<<<< HEAD
 +		blk_mq_process_rq_list(hctx);
 +		rcu_read_unlock();
 +	} else {
 +		srcu_idx = srcu_read_lock(&hctx->queue_rq_srcu);
 +		blk_mq_process_rq_list(hctx);
 +		srcu_read_unlock(&hctx->queue_rq_srcu, srcu_idx);
++=======
+ 		blk_mq_sched_dispatch_requests(hctx);
+ 		rcu_read_unlock();
+ 	} else {
+ 		might_sleep();
+ 
+ 		srcu_idx = srcu_read_lock(hctx->queue_rq_srcu);
+ 		blk_mq_sched_dispatch_requests(hctx);
+ 		srcu_read_unlock(hctx->queue_rq_srcu, srcu_idx);
++>>>>>>> 1f460b63d4b3 (blk-mq: don't restart queue when .get_budget returns BLK_STS_RESOURCE)
  	}
  }
  
* Unmerged path block/blk-mq-sched.c
* Unmerged path block/blk-mq-sched.h
* Unmerged path block/blk-mq-sched.c
* Unmerged path block/blk-mq-sched.h
* Unmerged path block/blk-mq.c
