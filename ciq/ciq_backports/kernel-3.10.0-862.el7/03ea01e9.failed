mlxsw: spectrum_router: Adjust RIF configuration for new firmware versions

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Ido Schimmel <idosch@mellanox.com>
commit 03ea01e9db82203e83b306b6c61d2cc9f0da4199
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/03ea01e9.failed

In new firmware versions, when configuring a {Port, VID} as a router
interface, the driver is responsible for enabling the STP filter and
disabling learning.  Otherwise, packets are discarded.

This change doesn't break existing firmware versions, but is required
for newer firmware versions.

	Signed-off-by: Ido Schimmel <idosch@mellanox.com>
	Signed-off-by: Jiri Pirko <jiri@mellanox.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 03ea01e9db82203e83b306b6c61d2cc9f0da4199)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlxsw/spectrum_router.c
diff --cc drivers/net/ethernet/mellanox/mlxsw/spectrum_router.c
index f8e7036e3f4a,8165b1148bce..000000000000
--- a/drivers/net/ethernet/mellanox/mlxsw/spectrum_router.c
+++ b/drivers/net/ethernet/mellanox/mlxsw/spectrum_router.c
@@@ -2857,21 -3110,39 +2858,48 @@@ static int mlxsw_sp_vport_rif_sp_join(s
  				      struct net_device *l3_dev)
  {
  	struct mlxsw_sp *mlxsw_sp = mlxsw_sp_vport->mlxsw_sp;
++<<<<<<< HEAD
 +	struct mlxsw_sp_rif *r;
++=======
+ 	u16 vid = mlxsw_sp_vport_vid_get(mlxsw_sp_vport);
+ 	struct mlxsw_sp_rif *rif;
+ 	int err;
++>>>>>>> 03ea01e9db82 (mlxsw: spectrum_router: Adjust RIF configuration for new firmware versions)
  
 -	rif = mlxsw_sp_rif_find_by_dev(mlxsw_sp, l3_dev);
 -	if (!rif) {
 -		rif = mlxsw_sp_vport_rif_sp_create(mlxsw_sp_vport, l3_dev);
 -		if (IS_ERR(rif))
 -			return PTR_ERR(rif);
 +	r = mlxsw_sp_rif_find_by_dev(mlxsw_sp, l3_dev);
 +	if (!r) {
 +		r = mlxsw_sp_vport_rif_sp_create(mlxsw_sp_vport, l3_dev);
 +		if (IS_ERR(r))
 +			return PTR_ERR(r);
  	}
  
++<<<<<<< HEAD
 +	mlxsw_sp_vport_fid_set(mlxsw_sp_vport, r->f);
 +	r->f->ref_count++;
++=======
+ 	err = mlxsw_sp_port_vid_learning_set(mlxsw_sp_vport, vid, false);
+ 	if (err)
+ 		goto err_port_vid_learning_set;
+ 
+ 	err = mlxsw_sp_port_vid_stp_set(mlxsw_sp_vport, vid,
+ 					BR_STATE_FORWARDING);
+ 	if (err)
+ 		goto err_port_vid_stp_set;
+ 
+ 	mlxsw_sp_vport_fid_set(mlxsw_sp_vport, rif->f);
+ 	rif->f->ref_count++;
++>>>>>>> 03ea01e9db82 (mlxsw: spectrum_router: Adjust RIF configuration for new firmware versions)
  
 -	netdev_dbg(mlxsw_sp_vport->dev, "Joined FID=%d\n", rif->f->fid);
 +	netdev_dbg(mlxsw_sp_vport->dev, "Joined FID=%d\n", r->f->fid);
  
  	return 0;
+ 
+ err_port_vid_stp_set:
+ 	mlxsw_sp_port_vid_learning_set(mlxsw_sp_vport, vid, true);
+ err_port_vid_learning_set:
+ 	if (rif->f->ref_count == 0)
+ 		mlxsw_sp_vport_rif_sp_destroy(mlxsw_sp_vport, rif);
+ 	return err;
  }
  
  static void mlxsw_sp_vport_rif_sp_leave(struct mlxsw_sp_port *mlxsw_sp_vport)
@@@ -2880,9 -3152,11 +2909,11 @@@
  
  	netdev_dbg(mlxsw_sp_vport->dev, "Left FID=%d\n", f->fid);
  
+ 	mlxsw_sp_port_vid_stp_set(mlxsw_sp_vport, vid, BR_STATE_BLOCKING);
+ 	mlxsw_sp_port_vid_learning_set(mlxsw_sp_vport, vid, true);
  	mlxsw_sp_vport_fid_set(mlxsw_sp_vport, NULL);
  	if (--f->ref_count == 0)
 -		mlxsw_sp_vport_rif_sp_destroy(mlxsw_sp_vport, f->rif);
 +		mlxsw_sp_vport_rif_sp_destroy(mlxsw_sp_vport, f->r);
  }
  
  static int mlxsw_sp_inetaddr_vport_event(struct net_device *l3_dev,
* Unmerged path drivers/net/ethernet/mellanox/mlxsw/spectrum_router.c
