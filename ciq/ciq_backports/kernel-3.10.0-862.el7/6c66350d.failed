x86/tsc: Provide a means to disable TSC ART

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
Rebuild_CHGLOG: - [x86] tsc: Provide a means to disable TSC ART (Frank Ramsay) [1526066]
Rebuild_FUZZ: 95.12%
commit-author mike.travis@hpe.com <mike.travis@hpe.com>
commit 6c66350d0a482892793b888b07c1177fc6d4b344
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/6c66350d.failed

On systems where multiple chassis are reset asynchronously, and thus
the TSC counters are started asynchronously, the offset needed to
convert to TSC to ART would be different.  Disable ART in that case
and rely on the TSC counters to supply the accurate time.

	Signed-off-by: Mike Travis <mike.travis@hpe.com>
	Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
	Reviewed-by: Thomas Gleixner <tglx@linutronix.de>
	Cc: Prarit Bhargava <prarit@redhat.com>
	Cc: Dimitri Sivanich <dimitri.sivanich@hpe.com>
	Cc: Russ Anderson <russ.anderson@hpe.com>
	Cc: Andrew Banman <andrew.banman@hpe.com>
	Cc: Peter Zijlstra <peterz@infradead.org>
	Cc: Bin Gao <bin.gao@linux.intel.com>
Link: https://lkml.kernel.org/r/20171012163202.289397994@stormcage.americas.sgi.com

(cherry picked from commit 6c66350d0a482892793b888b07c1177fc6d4b344)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kernel/tsc.c
diff --cc arch/x86/kernel/tsc.c
index 4716e80b8b60,f1326c0422c1..000000000000
--- a/arch/x86/kernel/tsc.c
+++ b/arch/x86/kernel/tsc.c
@@@ -1068,6 -962,16 +1068,19 @@@ static void detect_art(void
  	if (boot_cpu_data.cpuid_level < ART_CPUID_LEAF)
  		return;
  
++<<<<<<< HEAD
++=======
+ 	/*
+ 	 * Don't enable ART in a VM, non-stop TSC and TSC_ADJUST required,
+ 	 * and the TSC counter resets must not occur asynchronously.
+ 	 */
+ 	if (boot_cpu_has(X86_FEATURE_HYPERVISOR) ||
+ 	    !boot_cpu_has(X86_FEATURE_NONSTOP_TSC) ||
+ 	    !boot_cpu_has(X86_FEATURE_TSC_ADJUST) ||
+ 	    tsc_async_resets)
+ 		return;
+ 
++>>>>>>> 6c66350d0a48 (x86/tsc: Provide a means to disable TSC ART)
  	cpuid(ART_CPUID_LEAF, &art_to_tsc_denominator,
  	      &art_to_tsc_numerator, unused, unused+1);
  
* Unmerged path arch/x86/kernel/tsc.c
