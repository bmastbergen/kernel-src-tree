xfs: include inobt buffers in ifree tx log reservation

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Brian Foster <bfoster@redhat.com>
commit a6f485908d5210a5662f7a031bd1deeb3867e466
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/a6f48590.failed

The tr_ifree transaction handles inode unlinks and inode chunk
frees. The current transaction calculation does not accurately
reflect worst case changes to the inode btree, however. The inobt
portion of the current transaction reservation only covers
modification of a single inobt buffer (for the particular inode
record). This is a historical artifact from the days before XFS
supported full inode chunk removal.

When support for inode chunk removal was added in commit
254f6311ed1b ("Implement deletion of inode clusters in XFS."), the
additional log reservation required for chunk removal was not added
correctly. The new reservation only considered the header overhead
of associated buffers rather than the full contents of the btrees
and AGF and AGFL buffers affected by the transaction. The
reservation for the free space btrees was subsequently fixed up in
commit 5fe6abb82f76 ("Add space for inode and allocation btrees to
ITRUNCATE log reservation"), but the res. for full inobt joins has
never been added.

Further review of the ifree reservation uncovered a couple more
problems:

- The undocumented +2 blocks are intended for the AGF and AGFL, but
  are also not sized correctly and should be logged as full sectors
  (not FSBs).
- The additional single block header is undocumented and serves no
  apparent purpose.

Update xfs_calc_ifree_reservation() to include a full inobt join in
the reservation calculation. Refactor the undocumented blocks
appropriately and fix up the comments to reflect the current
calculation.

	Signed-off-by: Brian Foster <bfoster@redhat.com>
	Reviewed-by: Dave Chinner <dchinner@redhat.com>
	Reviewed-by: Darrick J. Wong <darrick.wong@oracle.com>
	Signed-off-by: Darrick J. Wong <darrick.wong@oracle.com>
(cherry picked from commit a6f485908d5210a5662f7a031bd1deeb3867e466)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/xfs/libxfs/xfs_trans_resv.c
diff --cc fs/xfs/libxfs/xfs_trans_resv.c
index 1b754cb1e8ae,838566b85622..000000000000
--- a/fs/xfs/libxfs/xfs_trans_resv.c
+++ b/fs/xfs/libxfs/xfs_trans_resv.c
@@@ -477,13 -503,11 +476,18 @@@ xfs_calc_ifree_reservation
  {
  	return XFS_DQUOT_LOGRES(mp) +
  		xfs_calc_inode_res(mp, 1) +
- 		xfs_calc_buf_res(1, mp->m_sb.sb_sectsize) +
- 		xfs_calc_buf_res(1, XFS_FSB_TO_B(mp, 1)) +
+ 		xfs_calc_buf_res(3, mp->m_sb.sb_sectsize) +
  		xfs_calc_iunlink_remove_reservation(mp) +
++<<<<<<< HEAD
 +		xfs_calc_buf_res(1, 0) +
 +		xfs_calc_buf_res(2 + mp->m_ialloc_blks +
 +				 mp->m_in_maxlevels, 0) +
 +		xfs_calc_buf_res(XFS_ALLOCFREE_LOG_COUNT(mp, 1),
++=======
+ 		xfs_calc_buf_res(mp->m_ialloc_blks, 0) +
+ 		xfs_calc_buf_res(mp->m_in_maxlevels, XFS_FSB_TO_B(mp, 1)) +
+ 		xfs_calc_buf_res(xfs_allocfree_log_count(mp, 1),
++>>>>>>> a6f485908d52 (xfs: include inobt buffers in ifree tx log reservation)
  				 XFS_FSB_TO_B(mp, 1)) +
  		xfs_calc_finobt_res(mp, 0, 1);
  }
* Unmerged path fs/xfs/libxfs/xfs_trans_resv.c
