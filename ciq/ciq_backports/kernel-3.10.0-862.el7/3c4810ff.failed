scsi: qla2xxx: Allow ABTS, PURX, RIDA on ATIOQ for ISP83XX/27XX

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
Rebuild_CHGLOG: - [scsi] qla2xxx: Allow ABTS, PURX, RIDA on ATIOQ for ISP83XX/27XX (Himanshu Madhani) [1460030]
Rebuild_FUZZ: 95.00%
commit-author Quinn Tran <quinn.tran@cavium.com>
commit 3c4810ffdc8e4f34d387f59baf0abefcfa4ada6a
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/3c4810ff.failed

Driver added mechanism to move ABTS/PUREX/RIDA mailbox to
ATIO queue as part of commit id 41dc529a4602ac737020f423f84686a81de38e6d
("qla2xxx: Improve RSCN handling in driver").

This patch adds a check to only allow ABTS/PURX/RIDA
to be moved to ATIO Queue for ISP83XX and ISP27XX.

	Cc: <stable@vger.kernel.org> # 4.11
	Signed-off-by: Quinn Tran <quinn.tran@cavium.com>
	Signed-off-by: Himanshu Madhani <himanshu.madhani@cavium.com>
	Reviewed-by: Bart Van Assche <Bart.VanAssche@sandisk.com>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit 3c4810ffdc8e4f34d387f59baf0abefcfa4ada6a)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/qla2xxx/qla_init.c
diff --cc drivers/scsi/qla2xxx/qla_init.c
index b9189cae77e5,f6130e8b1ca1..000000000000
--- a/drivers/scsi/qla2xxx/qla_init.c
+++ b/drivers/scsi/qla2xxx/qla_init.c
@@@ -2068,14 -2937,6 +2068,15 @@@ qla24xx_update_fw_options(scsi_qla_host
  	if (ql2xfwholdabts)
  		ha->fw_options[3] |= BIT_12;
  
 +	/* Set Retry FLOGI in case of P2P connection */
 +	if (ha->operating_mode == P2P) {
 +		ha->fw_options[2] |= BIT_3;
 +		ql_dbg(ql_dbg_disc, vha, 0x2102,
 +		    "(%s): Setting FLOGI retry BIT in fw_options[2]: 0x%x\n",
 +			__func__, ha->fw_options[2]);
 +	}
 +
++<<<<<<< HEAD
  	/* Set Retry FLOGI in case of P2P connection */
  	if (ha->operating_mode == P2P) {
  		ha->fw_options[2] |= BIT_3;
@@@ -2084,6 -2945,24 +2085,26 @@@
  			__func__, ha->fw_options[2]);
  	}
  
++=======
+ 	/* Move PUREX, ABTS RX & RIDA to ATIOQ */
+ 	if (ql2xmvasynctoatio &&
+ 	    (IS_QLA83XX(ha) || IS_QLA27XX(ha))) {
+ 		if (qla_tgt_mode_enabled(vha) ||
+ 		    qla_dual_mode_enabled(vha))
+ 			ha->fw_options[2] |= BIT_11;
+ 		else
+ 			ha->fw_options[2] &= ~BIT_11;
+ 	}
+ 
+ 	ql_dbg(ql_dbg_init, vha, 0xffff,
+ 		"%s, add FW options 1-3 = 0x%04x 0x%04x 0x%04x mode %x\n",
+ 		__func__, ha->fw_options[1], ha->fw_options[2],
+ 		ha->fw_options[3], vha->host->active_mode);
+ 
+ 	if (ha->fw_options[1] || ha->fw_options[2] || ha->fw_options[3])
+ 		qla2x00_set_fw_options(vha, ha->fw_options);
+ 
++>>>>>>> 3c4810ffdc8e (scsi: qla2xxx: Allow ABTS, PURX, RIDA on ATIOQ for ISP83XX/27XX)
  	/* Update Serial Link options. */
  	if ((le16_to_cpu(ha->fw_seriallink_options24[0]) & BIT_0) == 0)
  		return;
* Unmerged path drivers/scsi/qla2xxx/qla_init.c
