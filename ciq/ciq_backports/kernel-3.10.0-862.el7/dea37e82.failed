scsi: lpfc: Fix PRLI retry handling when target rejects it.

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
Rebuild_CHGLOG: - [scsi] lpfc: Fix PRLI retry handling when target rejects it (Dick Kennedy) [1385844 1461977 1387768]
Rebuild_FUZZ: 93.69%
commit-author James Smart <jsmart2021@gmail.com>
commit dea37e82fa3423a6c8d1325d44e68b6d03892453
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/dea37e82.failed

The nvmet driver was rejecting the initiator's PRLI because its reg_rpi
for the PLOGI was still outstanding.  The initiator would resend the
PRLI without delay and get the same answer.  The PRLI retries would
exhaust causing the nvme initiator to set the nvmet ndlp to UNMAPPED.

The driver's lpfc_els_retry handler did not have a policy for an LS_RJT
with explanation CMD_IN_PROGRESS for PRLI or NVME_PRLI.  This caused the
delay to remain at 0 but retry set 1.

Fix: When the ELS response is LS_RJT, TPC and the command was PRLI or
NVME_PRLI, just set the delay to 1000 mS to get a 1 second delay on the
PRLI retry.  This was enough to allow the REG_RPI to complete at the
target.

	Signed-off-by: Dick Kennedy <dick.kennedy@broadcom.com>
	Signed-off-by: James Smart <james.smart@broadcom.com>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit dea37e82fa3423a6c8d1325d44e68b6d03892453)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/lpfc/lpfc_els.c
diff --cc drivers/scsi/lpfc/lpfc_els.c
index ec919b3a122f,a140318d6159..000000000000
--- a/drivers/scsi/lpfc/lpfc_els.c
+++ b/drivers/scsi/lpfc/lpfc_els.c
@@@ -3250,8 -3363,7 +3263,12 @@@ lpfc_els_retry(struct lpfc_hba *phba, s
  				retry = 1;
  				break;
  			}
++<<<<<<< HEAD
 +			if ((cmd == ELS_CMD_PLOGI) ||
 +			    (cmd == ELS_CMD_PRLI)) {
++=======
+ 			if (cmd == ELS_CMD_PLOGI) {
++>>>>>>> dea37e82fa34 (scsi: lpfc: Fix PRLI retry handling when target rejects it.)
  				delay = 1000;
  				maxretry = lpfc_max_els_tries + 1;
  				retry = 1;
* Unmerged path drivers/scsi/lpfc/lpfc_els.c
