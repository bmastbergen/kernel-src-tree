qla2xxx: release request queue reservation.

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
Rebuild_CHGLOG: - [scsi] qla2xxx: release request queue reservation (Himanshu Madhani) [1327621]
Rebuild_FUZZ: 98.82%
commit-author Quinn Tran <quinn.tran@qlogic.com>
commit 810e30bc4658e9c069577bde52394a5af872803c
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/810e30bc.failed

Request IOCB queue element(s) is reserved during
good path IO.  Under error condition such as unable
to allocate IOCB handle condition, the IOCB count
that was reserved is not released.

	Cc: <stable@vger.kernel.org> # v3.18+
	Signed-off-by: Quinn Tran <quinn.tran@qlogic.com>
	Signed-off-by: Himanshu Madhani <himanshu.madhani@qlogic.com>
	Reviewed-by: Nicholas Bellinger <nab@linux-iscsi.org>
	Signed-off-by: Nicholas Bellinger <nab@linux-iscsi.org>
(cherry picked from commit 810e30bc4658e9c069577bde52394a5af872803c)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/qla2xxx/qla_target.c
diff --cc drivers/scsi/qla2xxx/qla_target.c
index 4e0d4c3c5146,49a184d30f1f..000000000000
--- a/drivers/scsi/qla2xxx/qla_target.c
+++ b/drivers/scsi/qla2xxx/qla_target.c
@@@ -2051,10 -2335,14 +2051,19 @@@ int qlt_xmit_response(struct qla_tgt_cm
  	if (unlikely(res))
  		goto out_unmap_unlock;
  
++<<<<<<< HEAD
 +	res = qlt_24xx_build_ctio_pkt(&prm, vha);
 +	if (unlikely(res != 0))
++=======
+ 	if (cmd->se_cmd.prot_op && (xmit_type & QLA_TGT_XMIT_DATA))
+ 		res = qlt_build_ctio_crc2_pkt(&prm, vha);
+ 	else
+ 		res = qlt_24xx_build_ctio_pkt(&prm, vha);
+ 	if (unlikely(res != 0)) {
+ 		vha->req->cnt += full_req_cnt;
++>>>>>>> 810e30bc4658 (qla2xxx: release request queue reservation.)
  		goto out_unmap_unlock;
- 
+ 	}
  
  	pkt = (struct ctio7_to_24xx *)prm.pkt;
  
@@@ -2166,16 -2475,25 +2175,23 @@@ int qlt_rdy_to_xfer(struct qla_tgt_cmd 
  	res = qlt_check_reserve_free_req(vha, prm.req_cnt);
  	if (res != 0)
  		goto out_unlock_free_unmap;
 -	if (cmd->se_cmd.prot_op)
 -		res = qlt_build_ctio_crc2_pkt(&prm, vha);
 -	else
 -		res = qlt_24xx_build_ctio_pkt(&prm, vha);
  
++<<<<<<< HEAD
 +	res = qlt_24xx_build_ctio_pkt(&prm, vha);
 +	if (unlikely(res != 0))
++=======
+ 	if (unlikely(res != 0)) {
+ 		vha->req->cnt += prm.req_cnt;
++>>>>>>> 810e30bc4658 (qla2xxx: release request queue reservation.)
  		goto out_unlock_free_unmap;
+ 	}
+ 
  	pkt = (struct ctio7_to_24xx *)prm.pkt;
 -	pkt->u.status0.flags |= __constant_cpu_to_le16(CTIO7_FLAGS_DATA_OUT |
 +	pkt->u.status0.flags |= cpu_to_le16(CTIO7_FLAGS_DATA_OUT |
  	    CTIO7_FLAGS_STATUS_MODE_0);
 -
 -	if (cmd->se_cmd.prot_op == TARGET_PROT_NORMAL)
 -		qlt_load_data_segments(&prm, vha);
 +	qlt_load_data_segments(&prm, vha);
  
  	cmd->state = QLA_TGT_STATE_NEED_DATA;
 -	cmd->cmd_sent_to_fw = 1;
  
  	/* Memory Barrier */
  	wmb();
* Unmerged path drivers/scsi/qla2xxx/qla_target.c
