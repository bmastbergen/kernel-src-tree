scsi: cxlflash: Support dynamic number of FC ports

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
Rebuild_CHGLOG: - [scsi] cxlflash: Support dynamic number of FC ports (Gustavo Duarte) [1456494]
Rebuild_FUZZ: 93.62%
commit-author Matthew R. Ochs <mrochs@linux.vnet.ibm.com>
commit 78ae028e823701148e4915759459ee79597ea8ec
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/78ae028e.failed

Transition from a static number of FC ports to a value that is derived during
probe. For now, a static value is used but this will later be based on the
type of card being configured.

	Signed-off-by: Matthew R. Ochs <mrochs@linux.vnet.ibm.com>
	Signed-off-by: Uma Krishnan <ukrishn@linux.vnet.ibm.com>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit 78ae028e823701148e4915759459ee79597ea8ec)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/cxlflash/main.c
diff --cc drivers/scsi/cxlflash/main.c
index c68badcfa77f,3f9c8690af0d..000000000000
--- a/drivers/scsi/cxlflash/main.c
+++ b/drivers/scsi/cxlflash/main.c
@@@ -1365,13 -1408,13 +1366,13 @@@ static int read_vpd(struct cxlflash_cf
  	ssize_t vpd_size;
  	char vpd_data[CXLFLASH_VPD_LEN];
  	char tmp_buf[WWPN_BUF_LEN] = { 0 };
- 	char *wwpn_vpd_tags[NUM_FC_PORTS] = { "V5", "V6" };
+ 	char *wwpn_vpd_tags[MAX_FC_PORTS] = { "V5", "V6" };
  
  	/* Get the VPD data from the device */
 -	vpd_size = cxl_read_adapter_vpd(pdev, vpd_data, sizeof(vpd_data));
 +	vpd_size = cxl_read_adapter_vpd(dev, vpd_data, sizeof(vpd_data));
  	if (unlikely(vpd_size <= 0)) {
 -		dev_err(dev, "%s: Unable to read VPD (size = %ld)\n",
 -			__func__, vpd_size);
 +		dev_err(&dev->dev, "%s: Unable to read VPD (size = %ld)\n",
 +		       __func__, vpd_size);
  		rc = -ENODEV;
  		goto out;
  	}
@@@ -1498,9 -1534,7 +1501,13 @@@ static int init_global(struct cxlflash_
  		goto out;
  	}
  
++<<<<<<< HEAD
 +	pr_debug("%s: wwpn0=0x%llX wwpn1=0x%llX\n", __func__, wwpn[0], wwpn[1]);
 +
 +	/* Set up RRQ in AFU for master issued cmds */
++=======
+ 	/* Set up RRQ and SQ in AFU for master issued cmds */
++>>>>>>> 78ae028e8237 (scsi: cxlflash: Support dynamic number of FC ports)
  	writeq_be((u64) afu->hrrq_start, &afu->host_map->rrq_start);
  	writeq_be((u64) afu->hrrq_end, &afu->host_map->rrq_end);
  
@@@ -2022,13 -2058,17 +2029,18 @@@ static int cxlflash_change_queue_depth(
  /**
   * cxlflash_show_port_status() - queries and presents the current port status
   * @port:	Desired port for status reporting.
 - * @cfg:	Internal structure associated with the host.
 + * @afu:	AFU owning the specified port.
   * @buf:	Buffer of length PAGE_SIZE to report back port status in ASCII.
   *
-  * Return: The size of the ASCII string returned in @buf.
+  * Return: The size of the ASCII string returned in @buf or -EINVAL.
   */
 -static ssize_t cxlflash_show_port_status(u32 port,
 -					 struct cxlflash_cfg *cfg,
 -					 char *buf)
 +static ssize_t cxlflash_show_port_status(u32 port, struct afu *afu, char *buf)
  {
++<<<<<<< HEAD
++=======
+ 	struct device *dev = &cfg->dev->dev;
+ 	struct afu *afu = cfg->afu;
++>>>>>>> 78ae028e8237 (scsi: cxlflash: Support dynamic number of FC ports)
  	char *disp_status;
  	u64 status;
  	__be64 __iomem *fc_regs;
@@@ -2175,15 -2216,17 +2193,20 @@@ static ssize_t ioctl_version_show(struc
  /**
   * cxlflash_show_port_lun_table() - queries and presents the port LUN table
   * @port:	Desired port for status reporting.
 - * @cfg:	Internal structure associated with the host.
 + * @afu:	AFU owning the specified port.
   * @buf:	Buffer of length PAGE_SIZE to report back port status in ASCII.
   *
-  * Return: The size of the ASCII string returned in @buf.
+  * Return: The size of the ASCII string returned in @buf or -EINVAL.
   */
  static ssize_t cxlflash_show_port_lun_table(u32 port,
 -					    struct cxlflash_cfg *cfg,
 +					    struct afu *afu,
  					    char *buf)
  {
++<<<<<<< HEAD
++=======
+ 	struct device *dev = &cfg->dev->dev;
+ 	struct afu *afu = cfg->afu;
++>>>>>>> 78ae028e8237 (scsi: cxlflash: Support dynamic number of FC ports)
  	int i;
  	ssize_t bytes = 0;
  	__be64 __iomem *fc_port;
@@@ -2393,8 -2509,10 +2421,9 @@@ static int cxlflash_probe(struct pci_de
  {
  	struct Scsi_Host *host;
  	struct cxlflash_cfg *cfg = NULL;
 -	struct device *dev = &pdev->dev;
  	struct dev_dependent_vals *ddv;
  	int rc = 0;
+ 	int k;
  
  	dev_dbg(&pdev->dev, "%s: Found CXLFLASH with IRQ: %d\n",
  		__func__, pdev->irq);
diff --git a/drivers/scsi/cxlflash/common.h b/drivers/scsi/cxlflash/common.h
index 811927d91c5c..b9191d5d4efa 100644
--- a/drivers/scsi/cxlflash/common.h
+++ b/drivers/scsi/cxlflash/common.h
@@ -23,7 +23,9 @@
 
 extern const struct file_operations cxlflash_cxl_fops;
 
-#define MAX_CONTEXT  CXLFLASH_MAX_CONTEXT       /* num contexts per afu */
+#define MAX_CONTEXT	CXLFLASH_MAX_CONTEXT	/* num contexts per afu */
+#define NUM_FC_PORTS	CXLFLASH_NUM_FC_PORTS	/* ports per AFU */
+#define MAX_FC_PORTS	CXLFLASH_MAX_FC_PORTS	/* ports per AFU */
 
 #define CXLFLASH_BLOCK_SIZE	4096	/* 4K blocks */
 #define CXLFLASH_MAX_XFER_SIZE	16777216	/* 16MB transfer */
@@ -98,6 +100,7 @@ struct cxlflash_cfg {
 	struct pci_dev *dev;
 	struct pci_device_id *dev_id;
 	struct Scsi_Host *host;
+	int num_fc_ports;
 
 	ulong cxlflash_regs_pci;
 
@@ -118,7 +121,7 @@ struct cxlflash_cfg {
 	struct file_operations cxl_fops;
 
 	/* Parameters that are LUN table related */
-	int last_lun_index[CXLFLASH_NUM_FC_PORTS];
+	int last_lun_index[MAX_FC_PORTS];
 	int promote_lun_index;
 	struct list_head lluns; /* list of llun_info structs */
 
* Unmerged path drivers/scsi/cxlflash/main.c
diff --git a/drivers/scsi/cxlflash/main.h b/drivers/scsi/cxlflash/main.h
index 055ea95141f2..8d44d7626df5 100644
--- a/drivers/scsi/cxlflash/main.h
+++ b/drivers/scsi/cxlflash/main.h
@@ -37,8 +37,6 @@
 
 #define CXLFLASH_PCI_ERROR_RECOVERY_TIMEOUT	(120 * HZ)
 
-#define NUM_FC_PORTS	CXLFLASH_NUM_FC_PORTS	/* ports per AFU */
-
 /* FC defines */
 #define FC_MTIP_CMDCONFIG 0x010
 #define FC_MTIP_STATUS 0x018
diff --git a/drivers/scsi/cxlflash/sislite.h b/drivers/scsi/cxlflash/sislite.h
index 347fc1671975..45ceb304fe85 100755
--- a/drivers/scsi/cxlflash/sislite.h
+++ b/drivers/scsi/cxlflash/sislite.h
@@ -350,6 +350,7 @@ struct sisl_global_regs {
 	__be64 interface_version;
 };
 
+#define CXLFLASH_MAX_FC_PORTS   2
 #define CXLFLASH_NUM_FC_PORTS   2
 #define CXLFLASH_MAX_CONTEXT  512	/* how many contexts per afu */
 #define CXLFLASH_NUM_VLUNS    512
diff --git a/drivers/scsi/cxlflash/superpipe.h b/drivers/scsi/cxlflash/superpipe.h
index 9e62ff304e4b..690ce9c652b2 100644
--- a/drivers/scsi/cxlflash/superpipe.h
+++ b/drivers/scsi/cxlflash/superpipe.h
@@ -59,7 +59,7 @@ struct glun_info {
 
 /* Local (per-adapter) lun_info structure */
 struct llun_info {
-	u64 lun_id[CXLFLASH_NUM_FC_PORTS]; /* from REPORT_LUNS */
+	u64 lun_id[MAX_FC_PORTS]; /* from REPORT_LUNS */
 	u32 lun_index;		/* Index in the LUN table */
 	u32 host_no;		/* host_no from Scsi_host */
 	u32 port_sel;		/* What port to use for this LUN */
