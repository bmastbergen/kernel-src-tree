usb-storage: Fix scsi-sd failure "Invalid field in cdb" for USB adapter JMicron

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Dmitry Katsubo <dmitry.katsubo@gmail.com>
commit 9fa62b1a31c96715aef34f25000e882ed4ac4876
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/9fa62b1a.failed

The patch extends the family of SATA-to-USB JMicron adapters that need
FUA to be disabled and applies the same policy for uas driver.
See details in http://unix.stackexchange.com/questions/237204/

	Signed-off-by: Dmitry Katsubo <dmitry.katsubo@gmail.com>
	Tested-by: Dmitry Katsubo <dmitry.katsubo@gmail.com>
	Acked-by: Alan Stern <stern@rowland.harvard.edu>
	Cc: stable <stable@vger.kernel.org>
	Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
(cherry picked from commit 9fa62b1a31c96715aef34f25000e882ed4ac4876)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/usb/storage/uas.c
diff --cc drivers/usb/storage/uas.c
index d371b91ecf04,5c66d3f7a6d0..000000000000
--- a/drivers/usb/storage/uas.c
+++ b/drivers/usb/storage/uas.c
@@@ -832,8 -796,11 +832,16 @@@ static int uas_slave_configure(struct s
  	if (devinfo->flags & US_FL_NO_REPORT_OPCODES)
  		sdev->no_report_opcodes = 1;
  
++<<<<<<< HEAD
 +	scsi_set_tag_type(sdev, MSG_ORDERED_TAG);
 +	scsi_activate_tcq(sdev, devinfo->qdepth - 2);
++=======
+ 	/* A few buggy USB-ATA bridges don't understand FUA */
+ 	if (devinfo->flags & US_FL_BROKEN_FUA)
+ 		sdev->broken_fua = 1;
+ 
+ 	scsi_change_queue_depth(sdev, devinfo->qdepth - 2);
++>>>>>>> 9fa62b1a31c9 (usb-storage: Fix scsi-sd failure "Invalid field in cdb" for USB adapter JMicron)
  	return 0;
  }
  
* Unmerged path drivers/usb/storage/uas.c
diff --git a/drivers/usb/storage/unusual_devs.h b/drivers/usb/storage/unusual_devs.h
index 1f05d8022f08..16cc18369111 100644
--- a/drivers/usb/storage/unusual_devs.h
+++ b/drivers/usb/storage/unusual_devs.h
@@ -2086,7 +2086,7 @@ UNUSUAL_DEV(  0x14cd, 0x6600, 0x0201, 0x0201,
 		US_FL_IGNORE_RESIDUE ),
 
 /* Reported by Michael BÃ¼sch <m@bues.ch> */
-UNUSUAL_DEV(  0x152d, 0x0567, 0x0114, 0x0114,
+UNUSUAL_DEV(  0x152d, 0x0567, 0x0114, 0x0116,
 		"JMicron",
 		"USB to ATA/ATAPI Bridge",
 		USB_SC_DEVICE, USB_PR_DEVICE, NULL,
diff --git a/drivers/usb/storage/unusual_uas.h b/drivers/usb/storage/unusual_uas.h
index 7d15718ea06f..4459a2ab5e08 100644
--- a/drivers/usb/storage/unusual_uas.h
+++ b/drivers/usb/storage/unusual_uas.h
@@ -147,7 +147,7 @@ UNUSUAL_DEV(0x152d, 0x0567, 0x0000, 0x9999,
 		"JMicron",
 		"JMS567",
 		USB_SC_DEVICE, USB_PR_DEVICE, NULL,
-		US_FL_NO_REPORT_OPCODES),
+		US_FL_BROKEN_FUA | US_FL_NO_REPORT_OPCODES),
 
 /* Reported-by: Takeo Nakayama <javhera@gmx.com> */
 UNUSUAL_DEV(0x357d, 0x7788, 0x0000, 0x9999,
