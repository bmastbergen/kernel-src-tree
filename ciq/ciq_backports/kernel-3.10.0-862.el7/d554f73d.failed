xen-netfront: reset skb network header before checksum

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Wei Liu <wei.liu2@citrix.com>
commit d554f73df6bc35ac8f6a65e5560bf1d31dfebed9
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/d554f73d.failed

In ed1f50c3a ("net: add skb_checksum_setup") we introduced some checksum
functions in core driver. Subsequent change b5cf66cd1 ("xen-netfront:
use new skb_checksum_setup function") made use of those functions to
replace its own implementation.

However with that change netfront is broken. It sees a lot of checksum
error. That's because its own implementation of checksum function was a
bit hacky (dereferencing skb->data directly) while the new function was
implemented using ip_hdr(). The network header is not reset before skb
is passed to the new function. When the new function tries to do its
job, it's confused and reports error.

The fix is simple, we need to reset network header before passing skb to
checksum function. Netback is not affected as it already does the right
thing.

	Reported-by: Sander Eikelenboom <linux@eikelenboom.it>
	Signed-off-by: Wei Liu <wei.liu2@citrix.com>
	Cc: Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>
	Cc: Paul Durrant <paul.durrant@citrix.com>
Tested-By: Sander Eikelenboom <linux@eikelenboom.it>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit d554f73df6bc35ac8f6a65e5560bf1d31dfebed9)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/xen-netfront.c
diff --cc drivers/net/xen-netfront.c
index 95a77195f496,e30d80033cbc..000000000000
--- a/drivers/net/xen-netfront.c
+++ b/drivers/net/xen-netfront.c
@@@ -906,12 -906,13 +906,17 @@@ static int handle_incoming_queue(struc
  			__pskb_pull_tail(skb, pull_to - skb_headlen(skb));
  
  		/* Ethernet work: Delayed to here as it peeks the header. */
++<<<<<<< HEAD
 +		skb->protocol = eth_type_trans(skb, queue->info->netdev);
++=======
+ 		skb->protocol = eth_type_trans(skb, dev);
+ 		skb_reset_network_header(skb);
++>>>>>>> d554f73df6bc (xen-netfront: reset skb network header before checksum)
  
 -		if (checksum_setup(dev, skb)) {
 +		if (checksum_setup(queue->info->netdev, skb)) {
  			kfree_skb(skb);
  			packets_dropped++;
 -			dev->stats.rx_errors++;
 +			queue->info->netdev->stats.rx_errors++;
  			continue;
  		}
  
* Unmerged path drivers/net/xen-netfront.c
