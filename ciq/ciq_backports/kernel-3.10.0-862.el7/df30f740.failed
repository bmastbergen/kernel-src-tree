openvswitch: upcall: Fix vlan handling.

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
Rebuild_CHGLOG: - [net] openvswitch: upcall: Fix vlan handling (Jiri Benc) [1497774]
Rebuild_FUZZ: 98.70%
commit-author pravin shelar <pshelar@ovn.org>
commit df30f7408b187929dbde72661c7f7c615268f1d0
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/df30f740.failed

Networking stack accelerate vlan tag handling by
keeping topmost vlan header in skb. This works as
long as packet remains in OVS datapath. But during
OVS upcall vlan header is pushed on to the packet.
When such packet is sent back to OVS datapath, core
networking stack might not handle it correctly. Following
patch avoids this issue by accelerating the vlan tag
during flow key extract. This simplifies datapath by
bringing uniform packet processing for packets from
all code paths.

Fixes: 5108bbaddc ("openvswitch: add processing of L3 packets").
CC: Jarno Rajahalme <jarno@ovn.org>
CC: Jiri Benc <jbenc@redhat.com>
	Signed-off-by: Pravin B Shelar <pshelar@ovn.org>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit df30f7408b187929dbde72661c7f7c615268f1d0)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/openvswitch/flow.c
diff --cc net/openvswitch/flow.c
index f677cc12bd8c,2c0a00f7f1b7..000000000000
--- a/net/openvswitch/flow.c
+++ b/net/openvswitch/flow.c
@@@ -765,5 -814,15 +779,18 @@@ int ovs_flow_key_extract_userspace(stru
  	if (err)
  		return err;
  
++<<<<<<< HEAD
++=======
+ 	/* key_extract assumes that skb->protocol is set-up for
+ 	 * layer 3 packets which is the case for other callers,
+ 	 * in particular packets received from the network stack.
+ 	 * Here the correct value can be set from the metadata
+ 	 * extracted above.
+ 	 * For L2 packet key eth type would be zero. skb protocol
+ 	 * would be set to correct value later during key-extact.
+ 	 */
+ 
+ 	skb->protocol = key->eth.type;
++>>>>>>> df30f7408b18 (openvswitch: upcall: Fix vlan handling.)
  	return key_extract(skb, key);
  }
* Unmerged path net/openvswitch/flow.c
