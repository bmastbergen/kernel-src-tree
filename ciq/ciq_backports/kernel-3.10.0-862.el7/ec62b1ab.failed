iommu/amd: Check if domain is NULL in get_domain() and return -EBUSY

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
Rebuild_CHGLOG: - [iommu] amd: Check if domain is NULL in get_domain() and return -EBUSY (Jerry Snitselaar) [1062729]
Rebuild_FUZZ: 95.38%
commit-author Baoquan He <bhe@redhat.com>
commit ec62b1ab0f4ccbc48aa8b9852cc25b38a1f12d1e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/ec62b1ab.failed

In get_domain(), 'domain' could be NULL before it's passed to dma_ops_domain()
to dereference. And the current code calling get_domain() can't deal with the
returned 'domain' well if its value is NULL.

So before dma_ops_domain() calling, check if 'domain' is NULL, If yes just return
ERR_PTR(-EBUSY) directly.

	Reported-by: Dan Carpenter <dan.carpenter@oracle.com>
Fixes: df3f7a6e8e85 ('iommu/amd: Use is_attach_deferred call-back')
	Signed-off-by: Baoquan He <bhe@redhat.com>
	Signed-off-by: Joerg Roedel <jroedel@suse.de>
(cherry picked from commit ec62b1ab0f4ccbc48aa8b9852cc25b38a1f12d1e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/iommu/amd_iommu.c
diff --cc drivers/iommu/amd_iommu.c
index e80343c1de99,b531307a9360..000000000000
--- a/drivers/iommu/amd_iommu.c
+++ b/drivers/iommu/amd_iommu.c
@@@ -2493,6 -2466,15 +2493,18 @@@ static struct protection_domain *get_do
  		return ERR_PTR(-EINVAL);
  
  	domain = get_dev_data(dev)->domain;
++<<<<<<< HEAD
++=======
+ 	if (domain == NULL && get_dev_data(dev)->defer_attach) {
+ 		get_dev_data(dev)->defer_attach = false;
+ 		io_domain = iommu_get_domain_for_dev(dev);
+ 		domain = to_pdomain(io_domain);
+ 		attach_device(dev, domain);
+ 	}
+ 	if (domain == NULL)
+ 		return ERR_PTR(-EBUSY);
+ 
++>>>>>>> ec62b1ab0f4c (iommu/amd: Check if domain is NULL in get_domain() and return -EBUSY)
  	if (!dma_ops_domain(domain))
  		return ERR_PTR(-EBUSY);
  
* Unmerged path drivers/iommu/amd_iommu.c
