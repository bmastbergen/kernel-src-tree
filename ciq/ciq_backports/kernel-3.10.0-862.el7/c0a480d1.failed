device property: Fix usecount for of_graph_get_port_parent()

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
Rebuild_CHGLOG: - [sound] alsa: device property: Fix usecount for of_graph_get_port_parent() (Jaroslav Kysela) [1463624]
Rebuild_FUZZ: 95.24%
commit-author Tony Lindgren <tony@atomide.com>
commit c0a480d1acf7dc184f9f3e7cf724483b0d28dc2e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/c0a480d1.failed

Fix inconsistent use of of_graph_get_port_parent() where
asoc_simple_card_parse_graph_dai() does of_node_get() before
calling it while other callers do not. We can fix this by
not trashing the node passed to of_graph_get_port_parent().

Let's also make sure the callers have correct refcounts and remove
related incorrect of_node_put() calls for of_for_each_phandle
as that's done by of_phandle_iterator_next() except when
we break out of the loop early.

Let's fix both issues with a single patch to avoid kobject
refcounts getting messed up more if two patches are merged
separately.

Otherwise strange issues can happen caused by memory corruption
caused by too many kobject_del() calls such as:

BUG: sleeping function called from invalid context at
kernel/locking/mutex.c:747
...
(___might_sleep)
(__mutex_lock)
(mutex_lock_nested)
(kernfs_remove)
(kobject_del)
(kobject_put)
(of_get_next_parent)
(of_graph_get_port_parent)
(asoc_simple_card_parse_graph_dai [snd_soc_simple_card_utils])
(asoc_graph_card_probe [snd_soc_audio_graph_card])

Fixes: 0ef472a973eb ("of_graph: add of_graph_get_port_parent()")
Fixes: 2692c1c63c29 ("ASoC: add audio-graph-card support")
Fixes: 1689333f8311 ("ASoC: simple-card-utils: add asoc_simple_card_parse_graph_dai()")
	Signed-off-by: Tony Lindgren <tony@atomide.com>
	Reviewed-by: Rob Herring <robh@kernel.org>
	Tested-by: Antonio Borneo <borneo.antonio@gmail.com>
	Tested-by: Kuninori Morimoto <kuninori.morimoto.gx@renesas.com>
	Signed-off-by: Mark Brown <broonie@kernel.org>
(cherry picked from commit c0a480d1acf7dc184f9f3e7cf724483b0d28dc2e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/of/property.c
#	sound/soc/generic/audio-graph-card.c
#	sound/soc/generic/audio-graph-scu-card.c
#	sound/soc/generic/simple-card-utils.c
* Unmerged path drivers/of/property.c
* Unmerged path sound/soc/generic/audio-graph-card.c
* Unmerged path sound/soc/generic/audio-graph-scu-card.c
* Unmerged path sound/soc/generic/simple-card-utils.c
* Unmerged path drivers/of/property.c
* Unmerged path sound/soc/generic/audio-graph-card.c
* Unmerged path sound/soc/generic/audio-graph-scu-card.c
* Unmerged path sound/soc/generic/simple-card-utils.c
diff --git a/sound/soc/soc-core.c b/sound/soc/soc-core.c
index fa21004ece38..8c4879019fd6 100644
--- a/sound/soc/soc-core.c
+++ b/sound/soc/soc-core.c
@@ -4223,6 +4223,8 @@ int snd_soc_get_dai_id(struct device_node *ep)
 	}
 	mutex_unlock(&client_mutex);
 
+	of_node_put(node);
+
 	return ret;
 }
 EXPORT_SYMBOL_GPL(snd_soc_get_dai_id);
