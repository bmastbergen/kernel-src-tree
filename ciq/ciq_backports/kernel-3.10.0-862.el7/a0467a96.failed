USB: serial: ch341: fix modem-status handling

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
Rebuild_CHGLOG: - [usb] serial: ch341: fix modem-status handling (Torez Smith) [1435752]
Rebuild_FUZZ: 94.12%
commit-author Johan Hovold <johan@kernel.org>
commit a0467a967f347842b30739aae636c44980265265
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/a0467a96.failed

The modem-status register was read as part of device configuration at
port_probe and then again at open (and reset-resume). During open (and
reset-resume) the MSR was read before submitting the interrupt URB,
something which could lead to an MSR-change going unnoticed when it
races with open (reset-resume).

Fix this by dropping the redundant reconfiguration of the port at every
open, and only read the MSR after the interrupt URB has been submitted.

Fixes: 664d5df92e88 ("USB: usb-serial ch341: support for DTR/RTS/CTS")
	Signed-off-by: Johan Hovold <johan@kernel.org>
(cherry picked from commit a0467a967f347842b30739aae636c44980265265)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/usb/serial/ch341.c
diff --cc drivers/usb/serial/ch341.c
index 3eb86a799457,86692d2f8523..000000000000
--- a/drivers/usb/serial/ch341.c
+++ b/drivers/usb/serial/ch341.c
@@@ -612,7 -603,22 +603,26 @@@ static int ch341_reset_resume(struct us
  	/* reconfigure ch341 serial port after bus-reset */
  	ch341_configure(serial->dev, priv);
  
++<<<<<<< HEAD
 +	return 0;
++=======
+ 	if (tty_port_initialized(&port->port)) {
+ 		ret = usb_submit_urb(port->interrupt_in_urb, GFP_NOIO);
+ 		if (ret) {
+ 			dev_err(&port->dev, "failed to submit interrupt urb: %d\n",
+ 				ret);
+ 			return ret;
+ 		}
+ 
+ 		ret = ch341_get_status(port->serial->dev, priv);
+ 		if (ret < 0) {
+ 			dev_err(&port->dev, "failed to read modem status: %d\n",
+ 				ret);
+ 		}
+ 	}
+ 
+ 	return usb_serial_generic_resume(serial);
++>>>>>>> a0467a967f34 (USB: serial: ch341: fix modem-status handling)
  }
  
  static struct usb_serial_driver ch341_device = {
* Unmerged path drivers/usb/serial/ch341.c
