blk-mq-sched: bypass the scheduler for flushes entirely

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Omar Sandoval <osandov@fb.com>
commit 0cacba6cf8252438f8166bd3fa1c3370dd28a769
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/0cacba6c.failed

There's a weird inconsistency that flushes are mostly hidden from the
scheduler, but it needs to be aware of them in ->insert_requests().
Instead of having every scheduler call blk_mq_sched_bypass_insert(),
let's do it in the common framework.

	Signed-off-by: Omar Sandoval <osandov@fb.com>
	Signed-off-by: Jens Axboe <axboe@fb.com>
(cherry picked from commit 0cacba6cf8252438f8166bd3fa1c3370dd28a769)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	block/blk-mq-sched.c
#	block/blk-mq-sched.h
#	block/mq-deadline.c
diff --cc block/mq-deadline.c
index a01986d7b6fb,8f91f21e8663..000000000000
--- a/block/mq-deadline.c
+++ b/block/mq-deadline.c
@@@ -393,10 -395,7 +393,14 @@@ static void dd_insert_request(struct bl
  
  	blk_mq_sched_request_inserted(rq);
  
++<<<<<<< HEAD
 +	if (blk_mq_sched_bypass_insert(hctx, rq))
 +		return;
 +
 +	if (at_head || rq->cmd_type != REQ_TYPE_FS) {
++=======
+ 	if (at_head || blk_rq_is_passthrough(rq)) {
++>>>>>>> 0cacba6cf825 (blk-mq-sched: bypass the scheduler for flushes entirely)
  		if (at_head)
  			list_add(&rq->queuelist, &dd->dispatch);
  		else
* Unmerged path block/blk-mq-sched.c
* Unmerged path block/blk-mq-sched.h
* Unmerged path block/blk-mq-sched.c
* Unmerged path block/blk-mq-sched.h
* Unmerged path block/mq-deadline.c
