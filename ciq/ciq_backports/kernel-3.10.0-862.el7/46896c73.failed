KVM: svm: add support for RDTSCP

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Paolo Bonzini <pbonzini@redhat.com>
commit 46896c73c1a4dde527c3a3cc43379deeb41985a1
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/46896c73.failed

RDTSCP was never supported for AMD CPUs, which nobody noticed because
Linux does not use it.  But exactly the fact that Linux does not
use it makes the implementation very simple; we can freely trash
MSR_TSC_AUX while running the guest.

	Cc: Joerg Roedel <joro@8bytes.org>
	Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
(cherry picked from commit 46896c73c1a4dde527c3a3cc43379deeb41985a1)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kvm/svm.c
diff --cc arch/x86/kvm/svm.c
index 4ab2fa9467cb,af342150558a..000000000000
--- a/arch/x86/kvm/svm.c
+++ b/arch/x86/kvm/svm.c
@@@ -1610,8 -1240,9 +1612,14 @@@ static void svm_vcpu_load(struct kvm_vc
  			wrmsrl(MSR_AMD64_TSC_RATIO, tsc_ratio);
  		}
  	}
++<<<<<<< HEAD
 +
 +	avic_vcpu_load(vcpu, cpu);
++=======
+ 	/* This assumes that the kernel never uses MSR_TSC_AUX */
+ 	if (static_cpu_has(X86_FEATURE_RDTSCP))
+ 		wrmsrl(MSR_TSC_AUX, svm->tsc_aux);
++>>>>>>> 46896c73c1a4 (KVM: svm: add support for RDTSCP)
  }
  
  static void svm_vcpu_put(struct kvm_vcpu *vcpu)
* Unmerged path arch/x86/kvm/svm.c
