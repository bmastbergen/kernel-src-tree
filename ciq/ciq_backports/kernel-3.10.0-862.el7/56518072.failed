scsi: cxlflash: SISlite updates to support 4 ports

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
Rebuild_CHGLOG: - [scsi] cxlflash: SISlite updates to support 4 ports (Gustavo Duarte) [1456494]
Rebuild_FUZZ: 93.62%
commit-author Matthew R. Ochs <mrochs@linux.vnet.ibm.com>
commit 565180723294b06b3e60030033847277b9d6d4bb
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/56518072.failed

Update the SISlite header to support 4 ports as outlined in the SISlite
specification. Address fallout from structure renames and refreshed
organization throughout the driver. Determine the number of ports supported by
a card from the global port selection mask register reset value.

	Signed-off-by: Matthew R. Ochs <mrochs@linux.vnet.ibm.com>
	Signed-off-by: Uma Krishnan <ukrishn@linux.vnet.ibm.com>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit 565180723294b06b3e60030033847277b9d6d4bb)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/cxlflash/common.h
#	drivers/scsi/cxlflash/main.c
#	drivers/scsi/cxlflash/sislite.h
diff --cc drivers/scsi/cxlflash/common.h
index 811927d91c5c,28bb716e78fe..000000000000
--- a/drivers/scsi/cxlflash/common.h
+++ b/drivers/scsi/cxlflash/common.h
@@@ -23,7 -25,16 +23,20 @@@
  
  extern const struct file_operations cxlflash_cxl_fops;
  
++<<<<<<< HEAD
 +#define MAX_CONTEXT  CXLFLASH_MAX_CONTEXT       /* num contexts per afu */
++=======
+ #define MAX_CONTEXT	CXLFLASH_MAX_CONTEXT	/* num contexts per afu */
+ #define MAX_FC_PORTS	CXLFLASH_MAX_FC_PORTS	/* max ports per AFU */
+ #define LEGACY_FC_PORTS	2			/* legacy ports per AFU */
+ 
+ #define CHAN2PORTBANK(_x)	((_x) >> ilog2(CXLFLASH_NUM_FC_PORTS_PER_BANK))
+ #define CHAN2BANKPORT(_x)	((_x) & (CXLFLASH_NUM_FC_PORTS_PER_BANK - 1))
+ 
+ #define CHAN2PORTMASK(_x)	(1 << (_x))	/* channel to port mask */
+ #define PORTMASK2CHAN(_x)	(ilog2((_x)))	/* port mask to channel */
+ #define PORTNUM2CHAN(_x)	((_x) - 1)	/* port number to channel */
++>>>>>>> 565180723294 (scsi: cxlflash: SISlite updates to support 4 ports)
  
  #define CXLFLASH_BLOCK_SIZE	4096	/* 4K blocks */
  #define CXLFLASH_MAX_XFER_SIZE	16777216	/* 16MB transfer */
@@@ -191,6 -243,28 +204,31 @@@ static inline u64 lun_to_lunid(u64 lun
  	return be64_to_cpu(lun_id);
  }
  
++<<<<<<< HEAD
++=======
+ static inline struct fc_port_bank __iomem *get_fc_port_bank(
+ 					    struct cxlflash_cfg *cfg, int i)
+ {
+ 	struct afu *afu = cfg->afu;
+ 
+ 	return &afu->afu_map->global.bank[CHAN2PORTBANK(i)];
+ }
+ 
+ static inline __be64 __iomem *get_fc_port_regs(struct cxlflash_cfg *cfg, int i)
+ {
+ 	struct fc_port_bank __iomem *fcpb = get_fc_port_bank(cfg, i);
+ 
+ 	return &fcpb->fc_port_regs[CHAN2BANKPORT(i)][0];
+ }
+ 
+ static inline __be64 __iomem *get_fc_port_luns(struct cxlflash_cfg *cfg, int i)
+ {
+ 	struct fc_port_bank __iomem *fcpb = get_fc_port_bank(cfg, i);
+ 
+ 	return &fcpb->fc_port_luns[CHAN2BANKPORT(i)][0];
+ }
+ 
++>>>>>>> 565180723294 (scsi: cxlflash: SISlite updates to support 4 ports)
  int cxlflash_afu_sync(struct afu *, ctx_hndl_t, res_hndl_t, u8);
  void cxlflash_list_init(void);
  void cxlflash_term_global_luns(void);
diff --cc drivers/scsi/cxlflash/main.c
index c68badcfa77f,64ad76b6b672..000000000000
--- a/drivers/scsi/cxlflash/main.c
+++ b/drivers/scsi/cxlflash/main.c
@@@ -1749,13 -1831,22 +1788,15 @@@ static int init_afu(struct cxlflash_cf
  		goto err1;
  	}
  
 -	if (afu_is_sq_cmd_mode(afu)) {
 -		afu->send_cmd = send_cmd_sq;
 -		afu->context_reset = context_reset_sq;
 -	} else {
 -		afu->send_cmd = send_cmd_ioarrin;
 -		afu->context_reset = context_reset_ioarrin;
 -	}
 -
 -	dev_dbg(dev, "%s: afu_ver=%s interface_ver=%016llx\n", __func__,
 -		afu->version, afu->interface_version);
 +	pr_debug("%s: afu version %s, interface version 0x%llX\n", __func__,
 +		 afu->version, afu->interface_version);
  
+ 	get_num_afu_ports(cfg);
+ 
  	rc = start_afu(cfg);
  	if (rc) {
 -		dev_err(dev, "%s: start_afu failed, rc=%d\n", __func__, rc);
 +		dev_err(dev, "%s: call to start_afu failed, rc=%d!\n",
 +			__func__, rc);
  		goto err1;
  	}
  
@@@ -2412,7 -2575,6 +2453,10 @@@ static int cxlflash_probe(struct pci_de
  
  	host->max_id = CXLFLASH_MAX_NUM_TARGETS_PER_BUS;
  	host->max_lun = CXLFLASH_MAX_NUM_LUNS_PER_TARGET;
++<<<<<<< HEAD
 +	host->max_channel = NUM_FC_PORTS - 1;
++=======
++>>>>>>> 565180723294 (scsi: cxlflash: SISlite updates to support 4 ports)
  	host->unique_id = host->host_no;
  	host->max_cmd_len = CXLFLASH_MAX_CDB_LEN;
  
diff --cc drivers/scsi/cxlflash/sislite.h
index 347fc1671975,42d9c9ee3bce..000000000000
mode 100755,100644..100755
--- a/drivers/scsi/cxlflash/sislite.h
+++ b/drivers/scsi/cxlflash/sislite.h
@@@ -348,11 -382,29 +374,26 @@@ struct sisl_global_regs 
  	__be64 rsvd[0xf8];
  	__le64 afu_version;
  	__be64 interface_version;
 -#define SISL_INTVER_CAP_SHIFT			16
 -#define SISL_INTVER_MAJ_SHIFT			8
 -#define SISL_INTVER_CAP_MASK			0xFFFFFFFF00000000ULL
 -#define SISL_INTVER_MAJ_MASK			0x00000000FFFF0000ULL
 -#define SISL_INTVER_MIN_MASK			0x000000000000FFFFULL
 -#define SISL_INTVER_CAP_IOARRIN_CMD_MODE	0x800000000000ULL
 -#define SISL_INTVER_CAP_SQ_CMD_MODE		0x400000000000ULL
 -#define SISL_INTVER_CAP_RESERVED_CMD_MODE_A	0x200000000000ULL
 -#define SISL_INTVER_CAP_RESERVED_CMD_MODE_B	0x100000000000ULL
  };
  
++<<<<<<< HEAD
 +#define CXLFLASH_NUM_FC_PORTS   2
 +#define CXLFLASH_MAX_CONTEXT  512	/* how many contexts per afu */
 +#define CXLFLASH_NUM_VLUNS    512
++=======
+ #define CXLFLASH_NUM_FC_PORTS_PER_BANK	2	/* fixed # of ports per bank */
+ #define CXLFLASH_MAX_FC_BANKS		1	/* max # of banks supported */
+ #define CXLFLASH_MAX_FC_PORTS	(CXLFLASH_NUM_FC_PORTS_PER_BANK *	\
+ 				 CXLFLASH_MAX_FC_BANKS)
+ #define CXLFLASH_MAX_CONTEXT	512	/* number of contexts per AFU */
+ #define CXLFLASH_NUM_VLUNS	512	/* number of vluns per AFU/port */
+ #define CXLFLASH_NUM_REGS	512	/* number of registers per port */
+ 
+ struct fc_port_bank {
+ 	__be64 fc_port_regs[CXLFLASH_NUM_FC_PORTS_PER_BANK][CXLFLASH_NUM_REGS];
+ 	__be64 fc_port_luns[CXLFLASH_NUM_FC_PORTS_PER_BANK][CXLFLASH_NUM_VLUNS];
+ };
++>>>>>>> 565180723294 (scsi: cxlflash: SISlite updates to support 4 ports)
  
  struct sisl_global_map {
  	union {
@@@ -461,7 -511,9 +500,13 @@@ struct sisl_rht_entry_f1 
  
  #define PORT0  0x01U
  #define PORT1  0x02U
++<<<<<<< HEAD
 +#define BOTH_PORTS    (PORT0 | PORT1)
++=======
+ #define PORT2  0x04U
+ #define PORT3  0x08U
+ #define PORT_MASK(_n)	((1 << (_n)) - 1)
++>>>>>>> 565180723294 (scsi: cxlflash: SISlite updates to support 4 ports)
  
  /* AFU Sync Mode byte */
  #define AFU_LW_SYNC 0x0U
* Unmerged path drivers/scsi/cxlflash/common.h
* Unmerged path drivers/scsi/cxlflash/main.c
* Unmerged path drivers/scsi/cxlflash/sislite.h
