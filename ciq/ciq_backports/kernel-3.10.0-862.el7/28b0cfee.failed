nfp: flush xmit_more on error paths

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Jakub Kicinski <jakub.kicinski@netronome.com>
commit 28b0cfee7b1b62ea214ebc50be5d5a92cbc30d42
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/28b0cfee.failed

In case of ring full or DMA mapping error remember to flush xmit_more
delayed kicks.

	Signed-off-by: Jakub Kicinski <jakub.kicinski@netronome.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 28b0cfee7b1b62ea214ebc50be5d5a92cbc30d42)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/netronome/nfp/nfp_net_common.c
diff --cc drivers/net/ethernet/netronome/nfp/nfp_net_common.c
index e0a7eb1db7a9,d35eeba86bac..000000000000
--- a/drivers/net/ethernet/netronome/nfp/nfp_net_common.c
+++ b/drivers/net/ethernet/netronome/nfp/nfp_net_common.c
@@@ -746,9 -756,10 +746,10 @@@ static int nfp_net_tx(struct sk_buff *s
  	nr_frags = skb_shinfo(skb)->nr_frags;
  
  	if (unlikely(nfp_net_tx_full(tx_ring, nr_frags + 1))) {
 -		nn_dp_warn(dp, "TX ring %d busy. wrp=%u rdp=%u\n",
 -			   qidx, tx_ring->wr_p, tx_ring->rd_p);
 +		nn_warn_ratelimit(nn, "TX ring %d busy. wrp=%u rdp=%u\n",
 +				  qidx, tx_ring->wr_p, tx_ring->rd_p);
  		netif_tx_stop_queue(nd_q);
+ 		nfp_net_tx_xmit_more_flush(tx_ring);
  		u64_stats_update_begin(&r_vec->tx_sync);
  		r_vec->tx_busy++;
  		u64_stats_update_end(&r_vec->tx_sync);
@@@ -861,7 -867,8 +862,12 @@@ err_unmap
  	tx_ring->txbufs[wr_idx].dma_addr = 0;
  	tx_ring->txbufs[wr_idx].fidx = -2;
  err_free:
++<<<<<<< HEAD
 +	nn_warn_ratelimit(nn, "Failed to map DMA TX buffer\n");
++=======
+ 	nn_dp_warn(dp, "Failed to map DMA TX buffer\n");
+ 	nfp_net_tx_xmit_more_flush(tx_ring);
++>>>>>>> 28b0cfee7b1b (nfp: flush xmit_more on error paths)
  	u64_stats_update_begin(&r_vec->tx_sync);
  	r_vec->tx_errors++;
  	u64_stats_update_end(&r_vec->tx_sync);
* Unmerged path drivers/net/ethernet/netronome/nfp/nfp_net_common.c
