tools/power turbostat: dump p-state software config

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
Rebuild_CHGLOG: - [tools] power turbostat: dump p-state software config (Prarit Bhargava) [1514290]
Rebuild_FUZZ: 93.75%
commit-author Len Brown <len.brown@intel.com>
commit 7293fccdffdec0ab0c36c4e4cffacb3ff114928e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/7293fccd.failed

cpu1: cpufreq driver: acpi-cpufreq
cpu1: cpufreq governor: ondemand
cpufreq boost: 1

or

cpu0: cpufreq driver: intel_pstate
cpu0: cpufreq governor: powersave
cpufreq intel_pstate no_turbo: 0

	Signed-off-by: Len Brown <len.brown@intel.com>
(cherry picked from commit 7293fccdffdec0ab0c36c4e4cffacb3ff114928e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/power/x86/turbostat/turbostat.c
diff --cc tools/power/x86/turbostat/turbostat.c
index 4705291e630a,7af5f42a9792..000000000000
--- a/tools/power/x86/turbostat/turbostat.c
+++ b/tools/power/x86/turbostat/turbostat.c
@@@ -2746,18 -2937,96 +2746,66 @@@ dump_cstate_pstate_config_info(unsigne
  
  	dump_nhm_cst_cfg();
  }
 -
 -static void
 -dump_sysfs_cstate_config(void)
 +int is_dnv(unsigned int family, unsigned int model)
  {
 -	char path[64];
 -	char name_buf[16];
 -	char desc[64];
 -	FILE *input;
 -	int state;
 -	char *sp;
 -
 -	if (!DO_BIC(BIC_sysfs))
 -		return;
 -
 -	for (state = 0; state < 10; ++state) {
 -
 -		sprintf(path, "/sys/devices/system/cpu/cpu%d/cpuidle/state%d/name",
 -			base_cpu, state);
 -		input = fopen(path, "r");
 -		if (input == NULL)
 -			continue;
 -		fgets(name_buf, sizeof(name_buf), input);
 -
 -		 /* truncate "C1-HSW\n" to "C1", or truncate "C1\n" to "C1" */
 -		sp = strchr(name_buf, '-');
 -		if (!sp)
 -			sp = strchrnul(name_buf, '\n');
 -		*sp = '\0';
  
 -		fclose(input);
 -
 -		sprintf(path, "/sys/devices/system/cpu/cpu%d/cpuidle/state%d/desc",
 -			base_cpu, state);
 -		input = fopen(path, "r");
 -		if (input == NULL)
 -			continue;
 -		fgets(desc, sizeof(desc), input);
 +	if (!genuine_intel)
 +		return 0;
  
 -		fprintf(outf, "cpu%d: %s: %s", base_cpu, name_buf, desc);
 -		fclose(input);
 +	switch (model) {
 +	case INTEL_FAM6_ATOM_DENVERTON:
 +		return 1;
  	}
 +	return 0;
  }
+ static void
+ dump_sysfs_pstate_config(void)
+ {
+ 	char path[64];
+ 	char driver_buf[64];
+ 	char governor_buf[64];
+ 	FILE *input;
+ 	int turbo;
+ 
+ 	sprintf(path, "/sys/devices/system/cpu/cpu%d/cpufreq/scaling_driver",
+ 			base_cpu);
+ 	input = fopen(path, "r");
+ 	if (input == NULL) {
+ 		fprintf(stderr, "NSFOD %s\n", path);
+ 		return;
+ 	}
+ 	fgets(driver_buf, sizeof(driver_buf), input);
+ 	fclose(input);
+ 
+ 	sprintf(path, "/sys/devices/system/cpu/cpu%d/cpufreq/scaling_governor",
+ 			base_cpu);
+ 	input = fopen(path, "r");
+ 	if (input == NULL) {
+ 		fprintf(stderr, "NSFOD %s\n", path);
+ 		return;
+ 	}
+ 	fgets(governor_buf, sizeof(governor_buf), input);
+ 	fclose(input);
+ 
+ 	fprintf(outf, "cpu%d: cpufreq driver: %s", base_cpu, driver_buf);
+ 	fprintf(outf, "cpu%d: cpufreq governor: %s", base_cpu, governor_buf);
+ 
+ 	sprintf(path, "/sys/devices/system/cpu/cpufreq/boost");
+ 	input = fopen(path, "r");
+ 	if (input != NULL) {
+ 		fscanf(input, "%d", &turbo);
+ 		fprintf(outf, "cpufreq boost: %d\n", turbo);
+ 		fclose(input);
+ 	}
+ 
+ 	sprintf(path, "/sys/devices/system/cpu/intel_pstate/no_turbo");
+ 	input = fopen(path, "r");
+ 	if (input != NULL) {
+ 		fscanf(input, "%d", &turbo);
+ 		fprintf(outf, "cpufreq intel_pstate no_turbo: %d\n", turbo);
+ 		fclose(input);
+ 	}
+ }
  
  
  /*
@@@ -3889,9 -4208,17 +3937,17 @@@ void process_cpuid(
  	rapl_probe(family, model);
  	perf_limit_reasons_probe(family, model);
  
 -	if (!quiet)
 +	if (debug)
  		dump_cstate_pstate_config_info(family, model);
  
++<<<<<<< HEAD
++=======
+ 	if (!quiet)
+ 		dump_sysfs_cstate_config();
+ 	if (!quiet)
+ 		dump_sysfs_pstate_config();
+ 
++>>>>>>> 7293fccdffde (tools/power turbostat: dump p-state software config)
  	if (has_skl_msrs(family, model))
  		calculate_tsc_tweak();
  
* Unmerged path tools/power/x86/turbostat/turbostat.c
