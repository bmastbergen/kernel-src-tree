openvswitch: Fix refcount leak on force commit.

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
Rebuild_CHGLOG: - [net] openvswitch: Fix refcount leak on force commit (Jiri Benc) [1497774]
Rebuild_FUZZ: 98.92%
commit-author Jarno Rajahalme <jarno@ovn.org>
commit b768b16de58d5e0b1d7c3f936825b25327ced20c
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/b768b16d.failed

The reference count held for skb needs to be released when the skb's
nfct pointer is cleared regardless of if nf_ct_delete() is called or
not.

Failing to release the skb's reference cound led to deferred conntrack
cleanup spinning forever within nf_conntrack_cleanup_net_list() when
cleaning up a network namespace:

   kworker/u16:0-19025 [004] 45981067.173642: sched_switch: kworker/u16:0:19025 [120] R ==> rcu_preempt:7 [120]
   kworker/u16:0-19025 [004] 45981067.173651: kernel_stack: <stack trace>
=> ___preempt_schedule (ffffffffa001ed36)
=> _raw_spin_unlock_bh (ffffffffa0713290)
=> nf_ct_iterate_cleanup (ffffffffc00a4454)
=> nf_conntrack_cleanup_net_list (ffffffffc00a5e1e)
=> nf_conntrack_pernet_exit (ffffffffc00a63dd)
=> ops_exit_list.isra.1 (ffffffffa06075f3)
=> cleanup_net (ffffffffa0607df0)
=> process_one_work (ffffffffa0084c31)
=> worker_thread (ffffffffa008592b)
=> kthread (ffffffffa008bee2)
=> ret_from_fork (ffffffffa071b67c)

Fixes: dd41d33f0b03 ("openvswitch: Add force commit.")
	Reported-by: Yang Song <yangsong@vmware.com>
	Signed-off-by: Jarno Rajahalme <jarno@ovn.org>
	Acked-by: Joe Stringer <joe@ovn.org>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit b768b16de58d5e0b1d7c3f936825b25327ced20c)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/openvswitch/conntrack.c
diff --cc net/openvswitch/conntrack.c
index ca0551d5e4cb,7b2c2fce408a..000000000000
--- a/net/openvswitch/conntrack.c
+++ b/net/openvswitch/conntrack.c
@@@ -551,6 -636,18 +551,21 @@@ static bool skb_nfct_cached(struct net 
  		if (help && rcu_access_pointer(help->helper) != info->helper)
  			return false;
  	}
++<<<<<<< HEAD
++=======
+ 	/* Force conntrack entry direction to the current packet? */
+ 	if (info->force && CTINFO2DIR(ctinfo) != IP_CT_DIR_ORIGINAL) {
+ 		/* Delete the conntrack entry if confirmed, else just release
+ 		 * the reference.
+ 		 */
+ 		if (nf_ct_is_confirmed(ct))
+ 			nf_ct_delete(ct, 0, 0);
+ 
+ 		nf_conntrack_put(&ct->ct_general);
+ 		nf_ct_set(skb, NULL, 0);
+ 		return false;
+ 	}
++>>>>>>> b768b16de58d (openvswitch: Fix refcount leak on force commit.)
  
  	return true;
  }
* Unmerged path net/openvswitch/conntrack.c
