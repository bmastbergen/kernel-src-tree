act_ipt: fix a bind refcnt leak

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author WANG Cong <xiyou.wangcong@gmail.com>
commit d15eccea69b96a5116169688dcc9baf6d1ce2751
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/d15eccea.failed

And avoid calling tcf_hash_check() twice.

Fixes: a57f19d30b2d ("net sched: ipt action fix late binding")
	Cc: Jamal Hadi Salim <jhs@mojatatu.com>
	Signed-off-by: Cong Wang <xiyou.wangcong@gmail.com>
	Acked-by: Jamal Hadi Salim <jhs@mojatatu.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit d15eccea69b96a5116169688dcc9baf6d1ce2751)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/sched/act_ipt.c
diff --cc net/sched/act_ipt.c
index 014563af32c0,d4bd19ee5822..000000000000
--- a/net/sched/act_ipt.c
+++ b/net/sched/act_ipt.c
@@@ -103,20 -107,29 +103,29 @@@ static int tcf_ipt_init(struct net *net
  	if (err < 0)
  		return err;
  
 -	if (tb[TCA_IPT_INDEX] != NULL)
 -		index = nla_get_u32(tb[TCA_IPT_INDEX]);
 -
 -	exists = tcf_hash_check(tn, index, a, bind);
 -	if (exists && bind)
 -		return 0;
 -
 -	if (tb[TCA_IPT_HOOK] == NULL || tb[TCA_IPT_TARG] == NULL) {
 -		if (exists)
 -			tcf_hash_release(a, bind);
 +	if (tb[TCA_IPT_HOOK] == NULL)
 +		return -EINVAL;
 +	if (tb[TCA_IPT_TARG] == NULL)
  		return -EINVAL;
 -	}
  
  	td = (struct xt_entry_target *)nla_data(tb[TCA_IPT_TARG]);
- 	if (nla_len(tb[TCA_IPT_TARG]) < td->u.target_size)
+ 	if (nla_len(tb[TCA_IPT_TARG]) < td->u.target_size) {
+ 		if (exists)
+ 			tcf_hash_release(a, bind);
  		return -EINVAL;
+ 	}
  
++<<<<<<< HEAD
 +	if (tb[TCA_IPT_INDEX] != NULL)
 +		index = nla_get_u32(tb[TCA_IPT_INDEX]);
 +
 +	if (!tcf_hash_check(index, a, bind) ) {
 +		ret = tcf_hash_create(index, est, a, sizeof(*ipt), bind, false);
++=======
+ 	if (!exists) {
+ 		ret = tcf_hash_create(tn, index, est, a, sizeof(*ipt), bind,
+ 				      false);
++>>>>>>> d15eccea69b9 (act_ipt: fix a bind refcnt leak)
  		if (ret)
  			return ret;
  		ret = ACT_P_CREATED;
* Unmerged path net/sched/act_ipt.c
