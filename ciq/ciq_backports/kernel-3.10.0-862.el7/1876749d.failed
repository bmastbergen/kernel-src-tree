nfp: refresh port state before reporting autonegotiation

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Jakub Kicinski <jakub.kicinski@netronome.com>
commit 1876749da87500c7228f91398e04291389a18634
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/1876749d.failed

State of autonegotiation may have changed but is not yet refreshed.
Make sure ethtool respects the NFP_PORT_CHANGED flag when looking
at autoneg.

	Signed-off-by: Jakub Kicinski <jakub.kicinski@netronome.com>
	Reviewed-by: Simon Horman <simon.horman@netronome.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 1876749da87500c7228f91398e04291389a18634)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/netronome/nfp/nfp_net_ethtool.c
#	drivers/net/ethernet/netronome/nfp/nfp_port.c
#	drivers/net/ethernet/netronome/nfp/nfp_port.h
diff --cc drivers/net/ethernet/netronome/nfp/nfp_net_ethtool.c
index 69f458e0de89,84fdbc4b835b..000000000000
--- a/drivers/net/ethernet/netronome/nfp/nfp_net_ethtool.c
+++ b/drivers/net/ethernet/netronome/nfp/nfp_net_ethtool.c
@@@ -190,15 -208,19 +190,30 @@@ nfp_net_get_link_ksettings(struct net_d
  	cmd->base.speed = SPEED_UNKNOWN;
  	cmd->base.duplex = DUPLEX_UNKNOWN;
  
++<<<<<<< HEAD
++=======
+ 	port = nfp_port_from_netdev(netdev);
+ 	eth_port = nfp_port_get_eth_port(port);
+ 	if (eth_port)
+ 		cmd->base.autoneg = eth_port->aneg != NFP_ANEG_DISABLED ?
+ 			AUTONEG_ENABLE : AUTONEG_DISABLE;
+ 
++>>>>>>> 1876749da875 (nfp: refresh port state before reporting autonegotiation)
  	if (!netif_carrier_ok(netdev))
  		return 0;
  
  	/* Use link speed from ETH table if available, otherwise try the BAR */
++<<<<<<< HEAD
 +	if (nn->eth_port && nfp_net_link_changed_read_clear(nn))
 +		nfp_net_refresh_port_config(nn);
 +	/* Separate if - on FW error the port could've disappeared from table */
 +	if (nn->eth_port) {
 +		cmd->base.speed = nn->eth_port->speed;
++=======
+ 	if (eth_port) {
+ 		cmd->base.port = eth_port->port_type;
+ 		cmd->base.speed = eth_port->speed;
++>>>>>>> 1876749da875 (nfp: refresh port state before reporting autonegotiation)
  		cmd->base.duplex = DUPLEX_FULL;
  		return 0;
  	}
* Unmerged path drivers/net/ethernet/netronome/nfp/nfp_port.c
* Unmerged path drivers/net/ethernet/netronome/nfp/nfp_port.h
* Unmerged path drivers/net/ethernet/netronome/nfp/nfp_net_ethtool.c
* Unmerged path drivers/net/ethernet/netronome/nfp/nfp_port.c
* Unmerged path drivers/net/ethernet/netronome/nfp/nfp_port.h
