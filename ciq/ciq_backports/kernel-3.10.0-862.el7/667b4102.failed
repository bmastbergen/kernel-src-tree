sysfs: Allow mounting without CONFIG_NET

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Eric W. Biederman <ebiederm@xmission.com>
commit 667b4102b3e63856ca7770521ee74b1c44629df1
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/667b4102.failed

In kobj_ns_current_may_mount the default should be to allow the
mount.  The test is only for a single kobj_ns_type at a time, and unless
there is a reason to prevent it the mounting sysfs should be allowed.
Subsystems that are not registered can't have are not involved so can't
have a reason to prevent mounting sysfs.

This is a bug-fix to:
    commit 7dc5dbc879bd0779924b5132a48b731a0bc04a1e
    Author: Eric W. Biederman <ebiederm@xmission.com>
    Date:   Mon Mar 25 20:07:01 2013 -0700

        sysfs: Restrict mounting sysfs

        Don't allow mounting sysfs unless the caller has CAP_SYS_ADMIN rights
        over the net namespace.  The principle here is if you create or have
        capabilities over it you can mount it, otherwise you get to live with
        what other people have mounted.

        Instead of testing this with a straight forward ns_capable call,
        perform this check the long and torturous way with kobject helpers,
        this keeps direct knowledge of namespaces out of sysfs, and preserves
        the existing sysfs abstractions.

        Acked-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
        Signed-off-by: "Eric W. Biederman" <ebiederm@xmission.com>

That came in via the userns tree during the 3.12 merge window.

	Reported-by: James Hogan <james.hogan@imgtec.com>
	Signed-off-by: "Eric W. Biederman" <ebiederm@xmission.com>
	Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
(cherry picked from commit 667b4102b3e63856ca7770521ee74b1c44629df1)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	lib/kobject.c
diff --cc lib/kobject.c
index b201420a4a54,669bf190d4fb..000000000000
--- a/lib/kobject.c
+++ b/lib/kobject.c
@@@ -933,6 -931,18 +933,21 @@@ const struct kobj_ns_type_operations *k
  	return kobj_child_ns_ops(kobj->parent);
  }
  
++<<<<<<< HEAD
++=======
+ bool kobj_ns_current_may_mount(enum kobj_ns_type type)
+ {
+ 	bool may_mount = true;
+ 
+ 	spin_lock(&kobj_ns_type_lock);
+ 	if ((type > KOBJ_NS_TYPE_NONE) && (type < KOBJ_NS_TYPES) &&
+ 	    kobj_ns_ops_tbl[type])
+ 		may_mount = kobj_ns_ops_tbl[type]->current_may_mount();
+ 	spin_unlock(&kobj_ns_type_lock);
+ 
+ 	return may_mount;
+ }
++>>>>>>> 667b4102b3e6 (sysfs: Allow mounting without CONFIG_NET)
  
  void *kobj_ns_grab_current(enum kobj_ns_type type)
  {
* Unmerged path lib/kobject.c
