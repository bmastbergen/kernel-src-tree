blk-mq: remap queues when adding/removing hardware queues

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Omar Sandoval <osandov@fb.com>
commit ebe8bddb6e30d7a02775b9972099271fc5910f37
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/ebe8bddb.failed

blk_mq_update_nr_hw_queues() used to remap hardware queues, which is the
behavior that drivers expect. However, commit 4e68a011428a changed
blk_mq_queue_reinit() to not remap queues for the case of CPU
hotplugging, inadvertently making blk_mq_update_nr_hw_queues() not remap
queues as well. This breaks, for example, NBD's multi-connection mode,
leaving the added hardware queues unused. Fix it by making
blk_mq_update_nr_hw_queues() explicitly remap the queues.

Fixes: 4e68a011428a ("blk-mq: don't redistribute hardware queues on a CPU hotplug event")
	Reviewed-by: Keith Busch <keith.busch@intel.com>
	Reviewed-by: Christoph Hellwig <hch@lst.de>
	Reviewed-by: Sagi Grimberg <sagi@grimberg.me>
	Signed-off-by: Omar Sandoval <osandov@fb.com>
	Signed-off-by: Jens Axboe <axboe@fb.com>
(cherry picked from commit ebe8bddb6e30d7a02775b9972099271fc5910f37)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	block/blk-mq.c
diff --cc block/blk-mq.c
index 8e2b66f2220e,f1be5c3eb600..000000000000
--- a/block/blk-mq.c
+++ b/block/blk-mq.c
@@@ -2392,11 -2570,13 +2392,21 @@@ static int blk_mq_alloc_rq_maps(struct 
  	return 0;
  }
  
++<<<<<<< HEAD
 +struct cpumask *blk_mq_tags_cpumask(struct blk_mq_tags *tags)
 +{
 +	return tags->cpumask;
 +}
 +EXPORT_SYMBOL_GPL(blk_mq_tags_cpumask);
++=======
+ static int blk_mq_update_queue_map(struct blk_mq_tag_set *set)
+ {
+ 	if (set->ops->map_queues)
+ 		return set->ops->map_queues(set);
+ 	else
+ 		return blk_mq_map_queues(set);
+ }
++>>>>>>> ebe8bddb6e30 (blk-mq: remap queues when adding/removing hardware queues)
  
  /*
   * Alloc a tag set to be associated with one or more request queues.
* Unmerged path block/blk-mq.c
