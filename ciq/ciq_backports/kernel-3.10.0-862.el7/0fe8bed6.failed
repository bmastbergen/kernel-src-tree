iwlwifi: mvm: send all non-bufferable frames on the probe queue

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
Rebuild_CHGLOG: - [netdrv] iwlwifi: mvm: send all non-bufferable frames on the probe (Stanislaw Gruszka) [1501877]
Rebuild_FUZZ: 95.00%
commit-author Avraham Stern <avraham.stern@intel.com>
commit 0fe8bed6e37c259b85d123ef9667f972305c9d6b
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/0fe8bed6.failed

AP interfaces now send all non-bufferable frames using the broadcast
station. Thus allow them to use the probe queue and don't warn about
it.

Fixes: eb045e6e0389 ("iwlwifi: mvm: Avoid deferring non bufferable frames")
	Signed-off-by: Avraham Stern <avraham.stern@intel.com>
	Signed-off-by: Luca Coelho <luciano.coelho@intel.com>
(cherry picked from commit 0fe8bed6e37c259b85d123ef9667f972305c9d6b)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/wireless/intel/iwlwifi/mvm/tx.c
diff --cc drivers/net/wireless/intel/iwlwifi/mvm/tx.c
index 1ba0a6f55503,6f2e2af23219..000000000000
--- a/drivers/net/wireless/intel/iwlwifi/mvm/tx.c
+++ b/drivers/net/wireless/intel/iwlwifi/mvm/tx.c
@@@ -508,15 -564,21 +508,31 @@@ static int iwl_mvm_get_ctrl_vif_queue(s
  	case NL80211_IFTYPE_AP:
  	case NL80211_IFTYPE_ADHOC:
  		/*
++<<<<<<< HEAD
 +		 * Handle legacy hostapd as well, where station may be added
 +		 * only after assoc. Take care of the case where we send a
 +		 * deauth to a station that we don't have.
 +		 */
 +		if (ieee80211_is_probe_resp(fc) || ieee80211_is_auth(fc) ||
 +		    ieee80211_is_deauth(fc))
 +			return IWL_MVM_DQA_AP_PROBE_RESP_QUEUE;
++=======
+ 		 * Non-bufferable frames use the broadcast station, thus they
+ 		 * use the probe queue.
+ 		 * Also take care of the case where we send a deauth to a
+ 		 * station that we don't have, or similarly an association
+ 		 * response (with non-success status) for a station we can't
+ 		 * accept.
+ 		 * Also, disassociate frames might happen, particular with
+ 		 * reason 7 ("Class 3 frame received from nonassociated STA").
+ 		 */
+ 		if (ieee80211_is_mgmt(fc) &&
+ 		    (!ieee80211_is_bufferable_mmpdu(fc) ||
+ 		     ieee80211_is_deauth(fc) || ieee80211_is_disassoc(fc)))
+ 			return mvm->probe_queue;
++>>>>>>> 0fe8bed6e37c (iwlwifi: mvm: send all non-bufferable frames on the probe queue)
  		if (info->hw_queue == info->control.vif->cab_queue)
 -			return mvmvif->cab_queue;
 +			return info->hw_queue;
  
  		WARN_ONCE(info->control.vif->type != NL80211_IFTYPE_ADHOC,
  			  "fc=0x%02x", le16_to_cpu(fc));
* Unmerged path drivers/net/wireless/intel/iwlwifi/mvm/tx.c
