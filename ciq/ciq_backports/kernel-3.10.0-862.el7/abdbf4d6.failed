PCI/DPC: Wait for Root Port busy to clear

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
Rebuild_CHGLOG: - [pci] dpc: Wait for Root Port busy to clear (Myron Stowe) [1499031]
Rebuild_FUZZ: 94.87%
commit-author Keith Busch <keith.busch@intel.com>
commit abdbf4d635a9a8c956bb9757a9d4f08c2abe1f97
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/abdbf4d6.failed

Per PCIe r3.1, sec 6.2.10 and sec 7.13.4, on Root Ports that support "RP
Extensions for DPC",

  When the DPC Trigger Status bit is Set and the DPC RP Busy bit is Set,
  software must leave the Root Port in DPC until the DPC RP Busy bit reads
  0b.

Wait up to 1 second for the Root Port to become non-busy.

[bhelgaas: changelog, spec references]
	Signed-off-by: Keith Busch <keith.busch@intel.com>
	Signed-off-by: Bjorn Helgaas <bhelgaas@google.com>
(cherry picked from commit abdbf4d635a9a8c956bb9757a9d4f08c2abe1f97)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/pci/pcie/pcie-dpc.c
#	include/uapi/linux/pci_regs.h
diff --cc include/uapi/linux/pci_regs.h
index 11d0eed025f3,c1b94b044795..000000000000
--- a/include/uapi/linux/pci_regs.h
+++ b/include/uapi/linux/pci_regs.h
@@@ -950,4 -959,31 +950,34 @@@
  #define PCI_TPH_CAP_ST_SHIFT	16	/* st table shift */
  #define PCI_TPH_BASE_SIZEOF	12	/* size with no st table */
  
++<<<<<<< HEAD
++=======
+ /* Downstream Port Containment */
+ #define PCI_EXP_DPC_CAP			4	/* DPC Capability */
+ #define  PCI_EXP_DPC_CAP_RP_EXT		0x20	/* Root Port Extensions for DPC */
+ #define  PCI_EXP_DPC_CAP_POISONED_TLP	0x40	/* Poisoned TLP Egress Blocking Supported */
+ #define  PCI_EXP_DPC_CAP_SW_TRIGGER	0x80	/* Software Triggering Supported */
+ #define  PCI_EXP_DPC_CAP_DL_ACTIVE	0x1000	/* ERR_COR signal on DL_Active supported */
+ 
+ #define PCI_EXP_DPC_CTL			6	/* DPC control */
+ #define  PCI_EXP_DPC_CTL_EN_NONFATAL 	0x02	/* Enable trigger on ERR_NONFATAL message */
+ #define  PCI_EXP_DPC_CTL_INT_EN 	0x08	/* DPC Interrupt Enable */
+ 
+ #define PCI_EXP_DPC_STATUS		8	/* DPC Status */
+ #define  PCI_EXP_DPC_STATUS_TRIGGER	0x01	/* Trigger Status */
+ #define  PCI_EXP_DPC_STATUS_INTERRUPT	0x08	/* Interrupt Status */
+ #define  PCI_EXP_DPC_RP_BUSY		0x10	/* Root Port Busy */
+ 
+ #define PCI_EXP_DPC_SOURCE_ID		10	/* DPC Source Identifier */
+ 
+ /* Precision Time Measurement */
+ #define PCI_PTM_CAP			0x04	    /* PTM Capability */
+ #define  PCI_PTM_CAP_REQ		0x00000001  /* Requester capable */
+ #define  PCI_PTM_CAP_ROOT		0x00000004  /* Root capable */
+ #define  PCI_PTM_GRANULARITY_MASK	0x0000FF00  /* Clock granularity */
+ #define PCI_PTM_CTRL			0x08	    /* PTM Control */
+ #define  PCI_PTM_CTRL_ENABLE		0x00000001  /* PTM enable */
+ #define  PCI_PTM_CTRL_ROOT		0x00000002  /* Root select */
+ 
++>>>>>>> abdbf4d635a9 (PCI/DPC: Wait for Root Port busy to clear)
  #endif /* LINUX_PCI_REGS_H */
* Unmerged path drivers/pci/pcie/pcie-dpc.c
* Unmerged path drivers/pci/pcie/pcie-dpc.c
* Unmerged path include/uapi/linux/pci_regs.h
