drm/atomic: Unref duplicated drm_atomic_state in drm_atomic_helper_resume()

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Jeffy Chen <jeffy.chen@rock-chips.com>
commit 6d281b1f79e194c02125da29ea77316810261ca8
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/6d281b1f.failed

Kmemleak reported memory leak after suspend and resume:
unreferenced object 0xffffffc0e31d8880 (size 128):
  comm "bash", pid 181, jiffies 4294763583 (age 24.694s)
  hex dump (first 32 bytes):
    01 00 00 00 00 00 00 00 00 20 a2 eb c0 ff ff ff  ......... ......
    01 00 00 00 00 00 00 00 80 87 1d e3 c0 ff ff ff  ................
  backtrace:
    [<ffffffc00034bb64>] __save_stack_trace+0x48/0x6c
    [<ffffffc00034c244>] create_object+0x138/0x254
    [<ffffffc0009dd218>] kmemleak_alloc+0x58/0x8c
    [<ffffffc000346de4>] kmem_cache_alloc_trace+0x188/0x254
    [<ffffffc0005af4c0>] drm_atomic_state_alloc+0x3c/0x88
    [<ffffffc000591f0c>] drm_atomic_helper_duplicate_state+0x28/0x158
    [<ffffffc000592098>] drm_atomic_helper_suspend+0x5c/0xf0

Problem here is that we are duplicating the drm_atomic_state in
drm_atomic_helper_suspend(), but not unreference it in the resume path.

Fixes: 1494276000db ("drm/atomic-helper: Implement subsystem-level suspend/resume")
	Signed-off-by: Jeffy Chen <jeffy.chen@rock-chips.com>
	Reviewed-by: Maarten Lankhorst <maarten.lankhorst@linux.intel.com>
	Signed-off-by: Maarten Lankhorst <maarten.lankhorst@linux.intel.com>
Link: https://patchwork.freedesktop.org/patch/msgid/20171009064641.15174-1-jeffy.chen@rock-chips.com
Fixes: 0853695c3ba4 ("drm: Add reference counting to drm_atomic_state")
	Cc: <stable@vger.kernel.org> # v4.10+
(cherry picked from commit 6d281b1f79e194c02125da29ea77316810261ca8)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/gpu/drm/drm_atomic_helper.c
diff --cc drivers/gpu/drm/drm_atomic_helper.c
index 205251fae539,4a262380c631..000000000000
--- a/drivers/gpu/drm/drm_atomic_helper.c
+++ b/drivers/gpu/drm/drm_atomic_helper.c
@@@ -2563,10 -3037,24 +2563,31 @@@ int drm_atomic_helper_resume(struct drm
  	int err;
  
  	drm_mode_config_reset(dev);
++<<<<<<< HEAD
 +	drm_modeset_lock_all(dev);
 +	state->acquire_ctx = config->acquire_ctx;
 +	err = drm_atomic_commit(state);
 +	drm_modeset_unlock_all(dev);
++=======
+ 
+ 	drm_modeset_acquire_init(&ctx, 0);
+ 	while (1) {
+ 		err = drm_modeset_lock_all_ctx(dev, &ctx);
+ 		if (err)
+ 			goto out;
+ 
+ 		err = drm_atomic_helper_commit_duplicated_state(state, &ctx);
+ out:
+ 		if (err != -EDEADLK)
+ 			break;
+ 
+ 		drm_modeset_backoff(&ctx);
+ 	}
+ 
+ 	drm_atomic_state_put(state);
+ 	drm_modeset_drop_locks(&ctx);
+ 	drm_modeset_acquire_fini(&ctx);
++>>>>>>> 6d281b1f79e1 (drm/atomic: Unref duplicated drm_atomic_state in drm_atomic_helper_resume())
  
  	return err;
  }
* Unmerged path drivers/gpu/drm/drm_atomic_helper.c
