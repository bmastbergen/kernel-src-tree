netfilter: use fwmark_reflect in nf_send_reset

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Pau Espin Pedrol <pau.espin@tessares.net>
commit cc31d43b4154ad5a7d8aa5543255a93b7e89edc2
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/cc31d43b.failed

Otherwise, RST packets generated by ipt_REJECT always have mark 0 when
the routing is checked later in the same code path.

Fixes: e110861f8609 ("net: add a sysctl to reflect the fwmark on replies")
	Cc: Lorenzo Colitti <lorenzo@google.com>
	Signed-off-by: Pau Espin Pedrol <pau.espin@tessares.net>
	Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
(cherry picked from commit cc31d43b4154ad5a7d8aa5543255a93b7e89edc2)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/ipv6/netfilter/nf_reject_ipv6.c
diff --cc net/ipv6/netfilter/nf_reject_ipv6.c
index 39a0bb59d9f3,eedee5d108d9..000000000000
--- a/net/ipv6/netfilter/nf_reject_ipv6.c
+++ b/net/ipv6/netfilter/nf_reject_ipv6.c
@@@ -156,9 -156,11 +156,14 @@@ void nf_send_reset6(struct net *net, st
  	fl6.daddr = oip6h->saddr;
  	fl6.fl6_sport = otcph->dest;
  	fl6.fl6_dport = otcph->source;
++<<<<<<< HEAD
++=======
+ 	fl6.flowi6_oif = l3mdev_master_ifindex(skb_dst(oldskb)->dev);
+ 	fl6.flowi6_mark = IP6_REPLY_MARK(net, oldskb->mark);
++>>>>>>> cc31d43b4154 (netfilter: use fwmark_reflect in nf_send_reset)
  	security_skb_classify_flow(oldskb, flowi6_to_flowi(&fl6));
  	dst = ip6_route_output(net, NULL, &fl6);
 -	if (dst->error) {
 +	if (dst == NULL || dst->error) {
  		dst_release(dst);
  		return;
  	}
diff --git a/net/ipv4/netfilter/nf_reject_ipv4.c b/net/ipv4/netfilter/nf_reject_ipv4.c
index 9fda46481259..605bddd51136 100644
--- a/net/ipv4/netfilter/nf_reject_ipv4.c
+++ b/net/ipv4/netfilter/nf_reject_ipv4.c
@@ -123,6 +123,8 @@ void nf_send_reset(struct sk_buff *oldskb, int hook)
 	/* ip_route_me_harder expects skb->dst to be set */
 	skb_dst_set_noref(nskb, skb_dst(oldskb));
 
+	nskb->mark = IP4_REPLY_MARK(net, oldskb->mark);
+
 	skb_reserve(nskb, LL_MAX_HEADER);
 	niph = nf_reject_iphdr_put(nskb, oldskb, IPPROTO_TCP,
 				   ip4_dst_hoplimit(skb_dst(nskb)));
* Unmerged path net/ipv6/netfilter/nf_reject_ipv6.c
