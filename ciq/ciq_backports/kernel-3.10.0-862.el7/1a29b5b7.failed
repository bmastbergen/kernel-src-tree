KVM: x86: Make indirect calls in emulator speculation safe

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Peter Zijlstra <peterz@infradead.org>
commit 1a29b5b7f347a1a9230c1e0af5b37e3e571588ab
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/1a29b5b7.failed

Replace the indirect calls with CALL_NOSPEC.

	Signed-off-by: Peter Zijlstra (Intel) <peterz@infradead.org>
	Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
	Reviewed-by: David Woodhouse <dwmw@amazon.co.uk>
	Cc: Andrea Arcangeli <aarcange@redhat.com>
	Cc: Andi Kleen <ak@linux.intel.com>
	Cc: Ashok Raj <ashok.raj@intel.com>
	Cc: Greg KH <gregkh@linuxfoundation.org>
	Cc: Jun Nakajima <jun.nakajima@intel.com>
	Cc: David Woodhouse <dwmw2@infradead.org>
	Cc: Linus Torvalds <torvalds@linux-foundation.org>
	Cc: rga@amazon.de
	Cc: Dave Hansen <dave.hansen@intel.com>
	Cc: Asit Mallick <asit.k.mallick@intel.com>
	Cc: Andy Lutomirski <luto@kernel.org>
	Cc: Josh Poimboeuf <jpoimboe@redhat.com>
	Cc: Jason Baron <jbaron@akamai.com>
	Cc: Paolo Bonzini <pbonzini@redhat.com>
	Cc: Dan Williams <dan.j.williams@intel.com>
	Cc: Arjan Van De Ven <arjan.van.de.ven@intel.com>
	Cc: Tim Chen <tim.c.chen@linux.intel.com>
Link: https://lkml.kernel.org/r/20180125095843.595615683@infradead.org

(cherry picked from commit 1a29b5b7f347a1a9230c1e0af5b37e3e571588ab)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kvm/emulate.c
diff --cc arch/x86/kvm/emulate.c
index ecc0be5cf438,453d8c990108..000000000000
--- a/arch/x86/kvm/emulate.c
+++ b/arch/x86/kvm/emulate.c
@@@ -5329,9 -5306,9 +5330,13 @@@ static int fastop(struct x86_emulate_ct
  	if (!(ctxt->d & ByteOp))
  		fop += __ffs(ctxt->dst.bytes) * FASTOP_SIZE;
  
- 	asm("push %[flags]; popf; call *%[fastop]; pushf; pop %[flags]\n"
+ 	asm("push %[flags]; popf; " CALL_NOSPEC " ; pushf; pop %[flags]\n"
  	    : "+a"(ctxt->dst.val), "+d"(ctxt->src.val), [flags]"+D"(flags),
++<<<<<<< HEAD
 +	      [fastop]"+S"(fop), "+r"(__sp)
++=======
+ 	      [thunk_target]"+S"(fop), ASM_CALL_CONSTRAINT
++>>>>>>> 1a29b5b7f347 (KVM: x86: Make indirect calls in emulator speculation safe)
  	    : "c"(ctxt->src2.val));
  
  	ctxt->eflags = (ctxt->eflags & ~EFLAGS_MASK) | (flags & EFLAGS_MASK);
* Unmerged path arch/x86/kvm/emulate.c
