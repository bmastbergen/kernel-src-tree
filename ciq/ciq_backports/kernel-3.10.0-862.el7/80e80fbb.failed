ceph: avoid creating orphan object when checking pool permission

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Yan, Zheng <zyan@redhat.com>
commit 80e80fbb584dc0d0dc894c4965bc2a199c7cd3f2
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/80e80fbb.failed

Pool permission check needs to write to the first object. But for
snapshot, head of the first object may have already been deleted.
Skip the check for snapshot inode to avoid creating orphan object.

Link: http://tracker.ceph.com/issues/18211
	Signed-off-by: Yan, Zheng <zyan@redhat.com>
(cherry picked from commit 80e80fbb584dc0d0dc894c4965bc2a199c7cd3f2)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/ceph/addr.c
diff --cc fs/ceph/addr.c
index 614603476dc3,a0f1e2b91c8e..000000000000
--- a/fs/ceph/addr.c
+++ b/fs/ceph/addr.c
@@@ -1831,12 -1944,18 +1831,23 @@@ out
  
  int ceph_pool_perm_check(struct ceph_inode_info *ci, int need)
  {
 -	s64 pool;
 -	struct ceph_string *pool_ns;
 +	u32 pool;
  	int ret, flags;
  
++<<<<<<< HEAD
 +	/* does not support pool namespace yet */
 +	if (ci->i_pool_ns_len)
 +		return -EIO;
++=======
+ 	if (ci->i_vino.snap != CEPH_NOSNAP) {
+ 		/*
+ 		 * Pool permission check needs to write to the first object.
+ 		 * But for snapshot, head of the first object may have alread
+ 		 * been deleted. Skip check to avoid creating orphan object.
+ 		 */
+ 		return 0;
+ 	}
++>>>>>>> 80e80fbb584d (ceph: avoid creating orphan object when checking pool permission)
  
  	if (ceph_test_mount_opt(ceph_inode_to_client(&ci->vfs_inode),
  				NOPOOLPERM))
* Unmerged path fs/ceph/addr.c
