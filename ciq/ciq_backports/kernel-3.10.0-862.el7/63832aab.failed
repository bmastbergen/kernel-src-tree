qla2xxx: Fix schedule_delayed_work() for target timeout calculations

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Shivaram Upadhyayula <shivaram.u@quadstor.com>
commit 63832aabec12a28a41a221773ab3819d30ba0a67
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/63832aab.failed

This patch fixes two cases in qla_target.c code where the
schedule_delayed_work() value was being incorrectly calculated
from sess->expires - jiffies.

	Signed-off-by: Shivaram U <shivaram.u@quadstor.com>
	Cc: <stable@vger.kernel.org> #3.6+
	Signed-off-by: Nicholas Bellinger <nab@linux-iscsi.org>
(cherry picked from commit 63832aabec12a28a41a221773ab3819d30ba0a67)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/qla2xxx/qla_target.c
diff --cc drivers/scsi/qla2xxx/qla_target.c
index 071c8becb9ba,3bb0a1d1622a..000000000000
--- a/drivers/scsi/qla2xxx/qla_target.c
+++ b/drivers/scsi/qla2xxx/qla_target.c
@@@ -652,47 -556,18 +652,52 @@@ static void qlt_del_sess_work_fn(struc
  	while (!list_empty(&tgt->del_sess_list)) {
  		sess = list_entry(tgt->del_sess_list.next, typeof(*sess),
  		    del_list_entry);
++<<<<<<< HEAD
 +		if (time_after_eq(jiffies, sess->expires)) {
 +			bool cancel;
 +
++=======
+ 		elapsed = jiffies;
+ 		if (time_after_eq(elapsed, sess->expires)) {
++>>>>>>> 63832aabec12 (qla2xxx: Fix schedule_delayed_work() for target timeout calculations)
  			qlt_undelete_sess(sess);
  
 -			ql_dbg(ql_dbg_tgt_mgt, vha, 0xf004,
 -			    "Timeout: sess %p about to be deleted\n",
 -			    sess);
 -			ha->tgt.tgt_ops->shutdown_sess(sess);
 -			ha->tgt.tgt_ops->put_sess(sess);
 +			spin_unlock_irqrestore(&ha->hardware_lock, flags);
 +			cancel = qlt_check_fcport_exist(vha, sess);
 +
 +			if (cancel) {
 +				if (sess->deleted) {
 +					/*
 +					 * sess was again deleted while we were
 +					 * discovering it
 +					 */
 +					spin_lock_irqsave(&ha->hardware_lock,
 +					    flags);
 +					continue;
 +				}
 +
 +				ql_dbg(ql_dbg_tgt_mgt, vha, 0xf049,
 +				    "qla_target(%d): cancel deletion of "
 +				    "session for port %02x:%02x:%02x:%02x:%02x:"
 +				    "%02x:%02x:%02x (loop ID %d), because "
 +				    " it isn't deleted by firmware",
 +				    vha->vp_idx, sess->port_name[0],
 +				    sess->port_name[1], sess->port_name[2],
 +				    sess->port_name[3], sess->port_name[4],
 +				    sess->port_name[5], sess->port_name[6],
 +				    sess->port_name[7], sess->loop_id);
 +			} else {
 +				ql_dbg(ql_dbg_tgt_mgt, vha, 0xf004,
 +				    "Timeout: sess %p about to be deleted\n",
 +				    sess);
 +				ha->tgt.tgt_ops->shutdown_sess(sess);
 +				ha->tgt.tgt_ops->put_sess(sess);
 +			}
 +
 +			spin_lock_irqsave(&ha->hardware_lock, flags);
  		} else {
  			schedule_delayed_work(&tgt->sess_del_work,
- 			    jiffies - sess->expires);
+ 			    sess->expires - elapsed);
  			break;
  		}
  	}
* Unmerged path drivers/scsi/qla2xxx/qla_target.c
