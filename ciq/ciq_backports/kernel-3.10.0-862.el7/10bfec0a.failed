mlxsw: spectrum: compile-in dpipe support only if devlink is enabled

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Jiri Pirko <jiri@mellanox.com>
commit 10bfec0a2b4b9d3b81e09b43266ebe370bb17760
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/10bfec0a.failed

Makes no sense to have dpipe compiled in when devlink is not enabled,
because the devlink dpipe registation is noop function. So don't compile
it in. This also fixes missing extern structs errors.

	Reported-by: kbuild test robot <fengguang.wu@intel.com>
Fixes: a86f030915f2 ("mlxsw: spectrum_dpipe: Add support for IPv4 host table dump")
	Signed-off-by: Jiri Pirko <jiri@mellanox.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 10bfec0a2b4b9d3b81e09b43266ebe370bb17760)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlxsw/Makefile
diff --cc drivers/net/ethernet/mellanox/mlxsw/Makefile
index 2fb8c6585ac7,f9956f3bc45c..000000000000
--- a/drivers/net/ethernet/mellanox/mlxsw/Makefile
+++ b/drivers/net/ethernet/mellanox/mlxsw/Makefile
@@@ -16,7 -16,9 +16,13 @@@ mlxsw_spectrum-objs		:= spectrum.o spec
  				   spectrum_switchdev.o spectrum_router.o \
  				   spectrum_kvdl.o spectrum_acl_tcam.o \
  				   spectrum_acl.o spectrum_flower.o \
++<<<<<<< HEAD
 +				   spectrum_cnt.o spectrum_dpipe.o
++=======
+ 				   spectrum_cnt.o \
+ 				   spectrum_fid.o
++>>>>>>> 10bfec0a2b4b (mlxsw: spectrum: compile-in dpipe support only if devlink is enabled)
  mlxsw_spectrum-$(CONFIG_MLXSW_SPECTRUM_DCB)	+= spectrum_dcb.o
+ mlxsw_spectrum-$(CONFIG_NET_DEVLINK) += spectrum_dpipe.o
  obj-$(CONFIG_MLXSW_MINIMAL)	+= mlxsw_minimal.o
  mlxsw_minimal-objs		:= minimal.o
* Unmerged path drivers/net/ethernet/mellanox/mlxsw/Makefile
diff --git a/drivers/net/ethernet/mellanox/mlxsw/spectrum_dpipe.h b/drivers/net/ethernet/mellanox/mlxsw/spectrum_dpipe.h
index 7785f9e26a18..c56a3d92a2bb 100644
--- a/drivers/net/ethernet/mellanox/mlxsw/spectrum_dpipe.h
+++ b/drivers/net/ethernet/mellanox/mlxsw/spectrum_dpipe.h
@@ -35,9 +35,24 @@
 #ifndef _MLXSW_PIPELINE_H_
 #define _MLXSW_PIPELINE_H_
 
+#if IS_ENABLED(CONFIG_NET_DEVLINK)
+
 int mlxsw_sp_dpipe_init(struct mlxsw_sp *mlxsw_sp);
 void mlxsw_sp_dpipe_fini(struct mlxsw_sp *mlxsw_sp);
 
+#else
+
+static inline int mlxsw_sp_dpipe_init(struct mlxsw_sp *mlxsw_sp)
+{
+	return 0;
+}
+
+static inline void mlxsw_sp_dpipe_fini(struct mlxsw_sp *mlxsw_sp)
+{
+}
+
+#endif
+
 #define MLXSW_SP_DPIPE_TABLE_NAME_ERIF "mlxsw_erif"
 #define MLXSW_SP_DPIPE_TABLE_NAME_HOST4 "mlxsw_host4"
 
