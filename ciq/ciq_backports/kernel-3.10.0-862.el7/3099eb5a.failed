net/mlx5e: Use modify header ID cache for offloaded TC NIC flows

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
Rebuild_CHGLOG: - [netdrv] mlx5e: Use modify header ID cache for offloaded TC NIC flows (Kamal Heib) [1456687 1456694]
Rebuild_FUZZ: 96.77%
commit-author Or Gerlitz <ogerlitz@mellanox.com>
commit 3099eb5a8ee2e46d57302932165fe4f86232a812
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/3099eb5a.failed

Use the modify header ID cache for the header re-write part of offloading
TC NIC flows.

	Signed-off-by: Or Gerlitz <ogerlitz@mellanox.com>
	Reviewed-by: Paul Blakey <paulb@mellanox.com>
	Signed-off-by: Saeed Mahameed <saeedm@mellanox.com>
(cherry picked from commit 3099eb5a8ee2e46d57302932165fe4f86232a812)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlx5/core/en_tc.c
diff --cc drivers/net/ethernet/mellanox/mlx5/core/en_tc.c
index 971ee0c61b0b,0c7a0872b22b..000000000000
--- a/drivers/net/ethernet/mellanox/mlx5/core/en_tc.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/en_tc.c
@@@ -245,6 -250,16 +245,19 @@@ mlx5e_tc_add_nic_flow(struct mlx5e_pri
  		dest.counter = counter;
  	}
  
++<<<<<<< HEAD
++=======
+ 	if (attr->action & MLX5_FLOW_CONTEXT_ACTION_MOD_HDR) {
+ 		err = mlx5e_attach_mod_hdr(priv, flow, parse_attr);
+ 		flow_act.modify_id = attr->mod_hdr_id;
+ 		kfree(parse_attr->mod_hdr_actions);
+ 		if (err) {
+ 			rule = ERR_PTR(err);
+ 			goto err_create_mod_hdr_id;
+ 		}
+ 	}
+ 
++>>>>>>> 3099eb5a8ee2 (net/mlx5e: Use modify header ID cache for offloaded TC NIC flows)
  	if (IS_ERR_OR_NULL(priv->fs.tc.t)) {
  		priv->fs.tc.t =
  			mlx5_create_auto_grouped_flow_table(priv->fs.ns,
@@@ -277,6 -292,9 +290,12 @@@ err_add_rule
  		priv->fs.tc.t = NULL;
  	}
  err_create_ft:
++<<<<<<< HEAD
++=======
+ 	if (attr->action & MLX5_FLOW_CONTEXT_ACTION_MOD_HDR)
+ 		mlx5e_detach_mod_hdr(priv, flow);
+ err_create_mod_hdr_id:
++>>>>>>> 3099eb5a8ee2 (net/mlx5e: Use modify header ID cache for offloaded TC NIC flows)
  	mlx5_fc_destroy(dev, counter);
  
  	return rule;
@@@ -295,6 -314,9 +314,12 @@@ static void mlx5e_tc_del_nic_flow(struc
  		mlx5_destroy_flow_table(priv->fs.tc.t);
  		priv->fs.tc.t = NULL;
  	}
++<<<<<<< HEAD
++=======
+ 
+ 	if (attr->action & MLX5_FLOW_CONTEXT_ACTION_MOD_HDR)
+ 		mlx5e_detach_mod_hdr(priv, flow);
++>>>>>>> 3099eb5a8ee2 (net/mlx5e: Use modify header ID cache for offloaded TC NIC flows)
  }
  
  static void mlx5e_detach_encap(struct mlx5e_priv *priv,
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/en_tc.c
