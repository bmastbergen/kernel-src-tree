KEYS: sanitize add_key() and keyctl() key payloads

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Eric Biggers <ebiggers@google.com>
commit 57070c850a03ee0cea654fc22cb8032fc3139d39
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/57070c85.failed

Before returning from add_key() or one of the keyctl() commands that
takes in a key payload, zero the temporary buffer that was allocated to
hold the key payload copied from userspace.  This may contain sensitive
key material that should not be kept around in the slab caches.

	Signed-off-by: Eric Biggers <ebiggers@google.com>
	Signed-off-by: David Howells <dhowells@redhat.com>
	Signed-off-by: James Morris <james.l.morris@oracle.com>
(cherry picked from commit 57070c850a03ee0cea654fc22cb8032fc3139d39)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	security/keys/keyctl.c
diff --cc security/keys/keyctl.c
index 3a409afc6582,ab0b337c84b4..000000000000
--- a/security/keys/keyctl.c
+++ b/security/keys/keyctl.c
@@@ -136,10 -132,10 +136,17 @@@ SYSCALL_DEFINE5(add_key, const char __u
  
  	key_ref_put(keyring_ref);
   error3:
++<<<<<<< HEAD
 +	if (!vm)
 +		kfree(payload);
 +	else
 +		vfree(payload);
++=======
+ 	if (payload) {
+ 		memzero_explicit(payload, plen);
+ 		kvfree(payload);
+ 	}
++>>>>>>> 57070c850a03 (KEYS: sanitize add_key() and keyctl() key payloads)
   error2:
  	kfree(description);
   error:
@@@ -1098,10 -1096,10 +1105,17 @@@ long keyctl_instantiate_key_common(key_
  		keyctl_change_reqkey_auth(NULL);
  
  error2:
++<<<<<<< HEAD
 +	if (!vm)
 +		kfree(payload);
 +	else
 +		vfree(payload);
++=======
+ 	if (payload) {
+ 		memzero_explicit(payload, plen);
+ 		kvfree(payload);
+ 	}
++>>>>>>> 57070c850a03 (KEYS: sanitize add_key() and keyctl() key payloads)
  error:
  	return ret;
  }
* Unmerged path security/keys/keyctl.c
