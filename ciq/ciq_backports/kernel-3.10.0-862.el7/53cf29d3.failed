scsi: lpfc: Fix NULL pointer dereference during PCI error recovery

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
Rebuild_CHGLOG: - [scsi] lpfc: Fix NULL pointer dereference during PCI error recovery (Dick Kennedy) [1385844 1461977 1387768]
Rebuild_FUZZ: 95.24%
commit-author Guilherme G. Piccoli <gpiccoli@linux.vnet.ibm.com>
commit 53cf29d3b1bc5b86fcff5fdc52f873d79d908ef4
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/53cf29d3.failed

Recent commit on patchset "lpfc updates for 11.2.0.14" fixed an issue
about dereferencing a NULL pointer on port reset. The specific commit,
named "lpfc: Fix system crash when port is reset.", is missing a check
against NULL pointer on lpfc_els_flush_cmd() though.

Since we destroy the queues on adapter resets, like in PCI error
recovery path, we need the validation present on this patch in order to
avoid a NULL pointer dereference when trying to flush commands of ELS
wq, after it has been destroyed (which would lead to a kernel oops).

	Tested-by: Raphael Silva <raphasil@linux.vnet.ibm.com>
	Signed-off-by: Guilherme G. Piccoli <gpiccoli@linux.vnet.ibm.com>
	Acked-by: James Smart <james.smart@broadcom.com>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit 53cf29d3b1bc5b86fcff5fdc52f873d79d908ef4)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/lpfc/lpfc_els.c
diff --cc drivers/scsi/lpfc/lpfc_els.c
index ec919b3a122f,8e532b39ae93..000000000000
--- a/drivers/scsi/lpfc/lpfc_els.c
+++ b/drivers/scsi/lpfc/lpfc_els.c
@@@ -7271,6 -7450,14 +7271,17 @@@ lpfc_els_flush_cmd(struct lpfc_vport *v
  	 * a working list and release the locks before calling the abort.
  	 */
  	spin_lock_irq(&phba->hbalock);
++<<<<<<< HEAD
++=======
+ 	pring = lpfc_phba_elsring(phba);
+ 
+ 	/* Bail out if we've no ELS wq, like in PCI error recovery case. */
+ 	if (unlikely(!pring)) {
+ 		spin_unlock_irq(&phba->hbalock);
+ 		return;
+ 	}
+ 
++>>>>>>> 53cf29d3b1bc (scsi: lpfc: Fix NULL pointer dereference during PCI error recovery)
  	if (phba->sli_rev == LPFC_SLI_REV4)
  		spin_lock(&pring->ring_lock);
  
* Unmerged path drivers/scsi/lpfc/lpfc_els.c
