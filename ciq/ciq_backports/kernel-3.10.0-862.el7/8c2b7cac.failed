perf debug: Move dump_stack() and sighandler_dump_stack() to debug.h

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Arnaldo Carvalho de Melo <acme@redhat.com>
commit 8c2b7cac78e17886e8089389a570a290c9b5ca67
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/8c2b7cac.failed

Two more out of util.h.

Link: http://lkml.kernel.org/n/tip-polkuxm1cpr06lbgue5pyqum@git.kernel.org
	Signed-off-by: Arnaldo Carvalho de Melo <acme@redhat.com>
(cherry picked from commit 8c2b7cac78e17886e8089389a570a290c9b5ca67)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/perf/util/util.c
#	tools/perf/util/util.h
diff --cc tools/perf/util/util.c
index dc59646111f8,ae8036f06329..000000000000
--- a/tools/perf/util/util.c
+++ b/tools/perf/util/util.c
@@@ -3,9 -3,10 +3,16 @@@
  #include "debug.h"
  #include <api/fs/fs.h>
  #include <sys/mman.h>
++<<<<<<< HEAD
 +#ifdef HAVE_BACKTRACE_SUPPORT
 +#include <execinfo.h>
 +#endif
++=======
+ #include <sys/utsname.h>
+ #include <dirent.h>
+ #include <inttypes.h>
+ #include <signal.h>
++>>>>>>> 8c2b7cac78e1 (perf debug: Move dump_stack() and sighandler_dump_stack() to debug.h)
  #include <stdio.h>
  #include <stdlib.h>
  #include <string.h>
@@@ -372,42 -350,6 +379,45 @@@ int hex2u64(const char *ptr, u64 *long_
  	return p - ptr;
  }
  
++<<<<<<< HEAD
 +/* Obtain a backtrace and print it to stdout. */
 +#ifdef HAVE_BACKTRACE_SUPPORT
 +void dump_stack(void)
 +{
 +	void *array[16];
 +	size_t size = backtrace(array, ARRAY_SIZE(array));
 +	char **strings = backtrace_symbols(array, size);
 +	size_t i;
 +
 +	printf("Obtained %zd stack frames.\n", size);
 +
 +	for (i = 0; i < size; i++)
 +		printf("%s\n", strings[i]);
 +
 +	free(strings);
 +}
 +#else
 +void dump_stack(void) {}
 +#endif
 +
 +void sighandler_dump_stack(int sig)
 +{
 +	psignal(sig, "perf");
 +	dump_stack();
 +	signal(sig, SIG_DFL);
 +	raise(sig);
 +}
 +
 +int timestamp__scnprintf_usec(u64 timestamp, char *buf, size_t sz)
 +{
 +	u64  sec = timestamp / NSEC_PER_SEC;
 +	u64 usec = (timestamp % NSEC_PER_SEC) / NSEC_PER_USEC;
 +
 +	return scnprintf(buf, sz, "%"PRIu64".%06"PRIu64, sec, usec);
 +}
 +
++=======
++>>>>>>> 8c2b7cac78e1 (perf debug: Move dump_stack() and sighandler_dump_stack() to debug.h)
  unsigned long parse_tag_value(const char *str, struct parse_tag *tags)
  {
  	struct parse_tag *i = tags;
diff --cc tools/perf/util/util.h
index e0eb4eee09b0,07c4293742e7..000000000000
--- a/tools/perf/util/util.h
+++ b/tools/perf/util/util.h
@@@ -108,20 -80,10 +108,23 @@@ void event_attr_init(struct perf_event_
  size_t hex_width(u64 v);
  int hex2u64(const char *ptr, u64 *val);
  
++<<<<<<< HEAD
 +char *ltrim(char *s);
 +char *rtrim(char *s);
 +
 +static inline char *trim(char *s)
 +{
 +	return ltrim(rtrim(s));
 +}
 +
 +void dump_stack(void);
 +void sighandler_dump_stack(int sig);
 +
++=======
++>>>>>>> 8c2b7cac78e1 (perf debug: Move dump_stack() and sighandler_dump_stack() to debug.h)
  extern unsigned int page_size;
  extern int cacheline_size;
 -extern int sysctl_perf_event_max_stack;
 -extern int sysctl_perf_event_max_contexts_per_stack;
 +extern unsigned int sysctl_perf_event_max_stack;
  
  struct parse_tag {
  	char tag;
diff --git a/tools/perf/util/debug.c b/tools/perf/util/debug.c
index dd8314b7c6fd..ca7796b8c5fb 100644
--- a/tools/perf/util/debug.c
+++ b/tools/perf/util/debug.c
@@ -7,7 +7,9 @@
 #include <stdio.h>
 #include <api/debug.h>
 #include <linux/time64.h>
-
+#ifdef HAVE_BACKTRACE_SUPPORT
+#include <execinfo.h>
+#endif
 #include "cache.h"
 #include "color.h"
 #include "event.h"
@@ -246,3 +248,31 @@ void perf_debug_setup(void)
 {
 	libapi_set_print(pr_warning_wrapper, pr_warning_wrapper, pr_debug_wrapper);
 }
+
+/* Obtain a backtrace and print it to stdout. */
+#ifdef HAVE_BACKTRACE_SUPPORT
+void dump_stack(void)
+{
+	void *array[16];
+	size_t size = backtrace(array, ARRAY_SIZE(array));
+	char **strings = backtrace_symbols(array, size);
+	size_t i;
+
+	printf("Obtained %zd stack frames.\n", size);
+
+	for (i = 0; i < size; i++)
+		printf("%s\n", strings[i]);
+
+	free(strings);
+}
+#else
+void dump_stack(void) {}
+#endif
+
+void sighandler_dump_stack(int sig)
+{
+	psignal(sig, "perf");
+	dump_stack();
+	signal(sig, SIG_DFL);
+	raise(sig);
+}
diff --git a/tools/perf/util/debug.h b/tools/perf/util/debug.h
index 98832f5531d3..8a23ea1a71c7 100644
--- a/tools/perf/util/debug.h
+++ b/tools/perf/util/debug.h
@@ -56,4 +56,7 @@ int perf_debug_option(const char *str);
 void perf_debug_setup(void);
 int perf_quiet_option(void);
 
+void dump_stack(void);
+void sighandler_dump_stack(int sig);
+
 #endif	/* __PERF_DEBUG_H */
* Unmerged path tools/perf/util/util.c
* Unmerged path tools/perf/util/util.h
