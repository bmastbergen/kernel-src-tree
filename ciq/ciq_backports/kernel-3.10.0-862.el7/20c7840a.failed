IB/core: If the MGID/MLID pair is not on the list return an error

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Michael J. Ruhl <michael.j.ruhl@intel.com>
commit 20c7840a77ddcb2ed2fbd66e8197db2868495751
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/20c7840a.failed

A list of MGID/MLID pairs is built when doing a multicast attach.  When
the multicast detach is called, the list is searched, and regardless of
the search outcome, the driver detach is called.

If an MGID/MLID pair is not on the list, driver detach should not be
called, and an error should be returned.  Calling the driver without
removing an MGID/MLID pair from the list can leave the core and driver
out of sync.

Fixes: f4e401562c11 ("IB/uverbs: track multicast group membership for userspace QPs")
	Cc: stable@vger.kernel.org
	Reviewed-by: Ira Weiny <ira.weiny@intel.com>
	Reviewed-by: Leon Romanovsky <leonro@mellanox.com>
	Signed-off-by: Michael J. Ruhl <michael.j.ruhl@intel.com>
	Signed-off-by: Dennis Dalessandro <dennis.dalessandro@intel.com>
	Signed-off-by: Doug Ledford <dledford@redhat.com>
(cherry picked from commit 20c7840a77ddcb2ed2fbd66e8197db2868495751)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/core/uverbs_cmd.c
diff --cc drivers/infiniband/core/uverbs_cmd.c
index 056e8089e68d,cb3c426c0dad..000000000000
--- a/drivers/infiniband/core/uverbs_cmd.c
+++ b/drivers/infiniband/core/uverbs_cmd.c
@@@ -3124,11 -2667,8 +3125,16 @@@ ssize_t ib_uverbs_detach_mcast(struct i
  	if (!qp)
  		return -EINVAL;
  
++<<<<<<< HEAD
 +	ret = ib_detach_mcast(qp, (union ib_gid *) cmd.gid, cmd.mlid);
 +	if (ret)
 +		goto out_put;
 +
 +	obj = container_of(qp->uobject, struct ib_uqp_object, uevent.uobject);
++=======
+ 	obj = container_of(qp->uobject, struct ib_uqp_object, uevent.uobject);
+ 	mutex_lock(&obj->mcast_lock);
++>>>>>>> 20c7840a77dd (IB/core: If the MGID/MLID pair is not on the list return an error)
  
  	list_for_each_entry(mcast, &obj->mcast_list, list)
  		if (cmd.mlid == mcast->lid &&
@@@ -3138,9 -2679,16 +3145,16 @@@
  			break;
  		}
  
+ 	if (!found) {
+ 		ret = -EINVAL;
+ 		goto out_put;
+ 	}
+ 
+ 	ret = ib_detach_mcast(qp, (union ib_gid *)cmd.gid, cmd.mlid);
+ 
  out_put:
 -	mutex_unlock(&obj->mcast_lock);
 -	uobj_put_obj_read(qp);
 +	put_qp_write(qp);
 +
  	return ret ? ret : in_len;
  }
  
* Unmerged path drivers/infiniband/core/uverbs_cmd.c
