platform/x86: dell-laptop: Add keyboard backlight timeout AC settings

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
Rebuild_CHGLOG: - [x86] dell-laptop: Add keyboard backlight timeout AC settings (Gopal Tiwari) [1457415]
Rebuild_FUZZ: 88.71%
commit-author Pali Rohár <pali.rohar@gmail.com>
commit 9216e0dcb5533a999d544d0af8661118e0588e1d
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/9216e0dc.failed

When changing keyboard backlight state on new Dell laptops, firmware
expects a new timeout AC value filled in Set New State SMBIOS call.

Without it any change of keyboard backlight state on new Dell laptops
fails. And user can see following error message in dmesg:

  dell_laptop: Setting old previous keyboard state failed
  leds dell::kbd_backlight: Setting an LED's brightness failed (-6)

This patch adds support for retrieving current timeout AC values and also
updating them. Current timeout value in sysfs is displayed based on current
AC status, like current display brightness value.

Detection if Dell laptop supports or not new timeout AC settings is done by
checking existence of Keyboard Backlight with AC SMBIOS token (0x0451).

	Signed-off-by: Pali Rohár <pali.rohar@gmail.com>
	Acked-by: Mario Limonciello <mario.limonciello@dell.com>
	Tested-by: Arcadiy Ivanov <arcadiy@ivanov.biz>
[andy: fixed merge conflict with defined constants]
	Signed-off-by: Andy Shevchenko <andriy.shevchenko@linux.intel.com>
(cherry picked from commit 9216e0dcb5533a999d544d0af8661118e0588e1d)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/platform/x86/dell-laptop.c
diff --cc drivers/platform/x86/dell-laptop.c
index f2366c77d3b3,ec202094bd50..000000000000
--- a/drivers/platform/x86/dell-laptop.c
+++ b/drivers/platform/x86/dell-laptop.c
@@@ -41,6 -43,9 +41,12 @@@
  #define KBD_LED_AUTO_50_TOKEN 0x02EB
  #define KBD_LED_AUTO_75_TOKEN 0x02EC
  #define KBD_LED_AUTO_100_TOKEN 0x02F6
++<<<<<<< HEAD
++=======
+ #define GLOBAL_MIC_MUTE_ENABLE 0x0364
+ #define GLOBAL_MIC_MUTE_DISABLE 0x0365
+ #define KBD_LED_AC_TOKEN 0x0451
++>>>>>>> 9216e0dcb553 (platform/x86: dell-laptop: Add keyboard backlight timeout AC settings)
  
  struct quirk_entry {
  	u8 touchpad_led;
@@@ -1562,13 -1603,21 +1598,19 @@@ static ssize_t kbd_led_timeout_store(st
  		}
  	}
  
 -	mutex_lock(&kbd_led_mutex);
 -
  	ret = kbd_get_state(&state);
  	if (ret)
 -		goto out;
 +		return ret;
  
  	new_state = state;
- 	new_state.timeout_value = value;
- 	new_state.timeout_unit = unit;
+ 
+ 	if (kbd_timeout_ac_supported && power_supply_is_system_supplied() > 0) {
+ 		new_state.timeout_value_ac = value;
+ 		new_state.timeout_unit_ac = unit;
+ 	} else {
+ 		new_state.timeout_value = value;
+ 		new_state.timeout_unit = unit;
+ 	}
  
  	ret = kbd_set_state_safe(&new_state, &state);
  	if (ret)
* Unmerged path drivers/platform/x86/dell-laptop.c
