x86/retpoline: Add LFENCE to the retpoline/RSB filling RSB macros

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
Rebuild_CHGLOG: - [x86] retpoline: Add LFENCE to the retpoline/RSB filling RSB macros (Josh Poimboeuf) [1535644]
Rebuild_FUZZ: 96.83%
commit-author Tom Lendacky <thomas.lendacky@amd.com>
commit 28d437d550e1e39f805d99f9f8ac399c778827b7
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/28d437d5.failed

The PAUSE instruction is currently used in the retpoline and RSB filling
macros as a speculation trap.  The use of PAUSE was originally suggested
because it showed a very, very small difference in the amount of
cycles/time used to execute the retpoline as compared to LFENCE.  On AMD,
the PAUSE instruction is not a serializing instruction, so the pause/jmp
loop will use excess power as it is speculated over waiting for return
to mispredict to the correct target.

The RSB filling macro is applicable to AMD, and, if software is unable to
verify that LFENCE is serializing on AMD (possible when running under a
hypervisor), the generic retpoline support will be used and, so, is also
applicable to AMD.  Keep the current usage of PAUSE for Intel, but add an
LFENCE instruction to the speculation trap for AMD.

The same sequence has been adopted by GCC for the GCC generated retpolines.

	Signed-off-by: Tom Lendacky <thomas.lendacky@amd.com>
	Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
	Reviewed-by: Borislav Petkov <bp@alien8.de>
	Acked-by: David Woodhouse <dwmw@amazon.co.uk>
	Acked-by: Arjan van de Ven <arjan@linux.intel.com>
	Cc: Rik van Riel <riel@redhat.com>
	Cc: Andi Kleen <ak@linux.intel.com>
	Cc: Paul Turner <pjt@google.com>
	Cc: Peter Zijlstra <peterz@infradead.org>
	Cc: Tim Chen <tim.c.chen@linux.intel.com>
	Cc: Jiri Kosina <jikos@kernel.org>
	Cc: Dave Hansen <dave.hansen@intel.com>
	Cc: Andy Lutomirski <luto@kernel.org>
	Cc: Josh Poimboeuf <jpoimboe@redhat.com>
	Cc: Dan Williams <dan.j.williams@intel.com>
	Cc: Linus Torvalds <torvalds@linux-foundation.org>
	Cc: Greg Kroah-Hartman <gregkh@linux-foundation.org>
	Cc: Kees Cook <keescook@google.com>
Link: https://lkml.kernel.org/r/20180113232730.31060.36287.stgit@tlendack-t1.amdoffice.net

(cherry picked from commit 28d437d550e1e39f805d99f9f8ac399c778827b7)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/include/asm/nospec-branch.h
* Unmerged path arch/x86/include/asm/nospec-branch.h
* Unmerged path arch/x86/include/asm/nospec-branch.h
