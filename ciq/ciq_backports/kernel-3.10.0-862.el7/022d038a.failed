IB/ipoib: Limit call to free rdma_netdev for capable devices

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Alex Vesker <valex@mellanox.com>
commit 022d038a163f9e889428789d681b97bf07730fb7
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/022d038a.failed

Limit calls to free_rdma_netdev() for capable devices only.

Fixes: cd565b4b51e5 ('IB/IPoIB: Support acceleration options callbacks')
	Signed-off-by: Alex Vesker <valex@mellanox.com>
	Signed-off-by: Leon Romanovsky <leon@kernel.org>
	Signed-off-by: Doug Ledford <dledford@redhat.com>
(cherry picked from commit 022d038a163f9e889428789d681b97bf07730fb7)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/hw/mlx5/main.c
#	drivers/infiniband/ulp/ipoib/ipoib_main.c
diff --cc drivers/infiniband/hw/mlx5/main.c
index 9a7070605698,9ecc089d4529..000000000000
--- a/drivers/infiniband/hw/mlx5/main.c
+++ b/drivers/infiniband/hw/mlx5/main.c
@@@ -3369,6 -3692,10 +3369,13 @@@ static void *mlx5_ib_add(struct mlx5_co
  	dev->ib_dev.check_mr_status	= mlx5_ib_check_mr_status;
  	dev->ib_dev.get_port_immutable  = mlx5_port_immutable;
  	dev->ib_dev.get_dev_fw_str      = get_dev_fw_str;
++<<<<<<< HEAD
++=======
+ 	if (MLX5_CAP_GEN(mdev, ipoib_enhanced_offloads)) {
+ 		dev->ib_dev.alloc_rdma_netdev	= mlx5_ib_alloc_rdma_netdev;
+ 		dev->ib_dev.free_rdma_netdev	= mlx5_ib_free_rdma_netdev;
+ 	}
++>>>>>>> 022d038a163f (IB/ipoib: Limit call to free rdma_netdev for capable devices)
  	if (mlx5_core_is_pf(mdev)) {
  		dev->ib_dev.get_vf_config	= mlx5_ib_get_vf_config;
  		dev->ib_dev.set_vf_link_state	= mlx5_ib_set_vf_link_state;
diff --cc drivers/infiniband/ulp/ipoib/ipoib_main.c
index 8bcffdc2a64e,91fae34bdd4f..000000000000
--- a/drivers/infiniband/ulp/ipoib/ipoib_main.c
+++ b/drivers/infiniband/ulp/ipoib/ipoib_main.c
@@@ -2287,7 -2301,15 +2287,19 @@@ static void ipoib_remove_one(struct ib_
  		flush_workqueue(priv->wq);
  
  		unregister_netdev(priv->dev);
++<<<<<<< HEAD
 +		free_netdev(priv->dev);
++=======
+ 		if (device->free_rdma_netdev)
+ 			device->free_rdma_netdev(priv->dev);
+ 		else
+ 			free_netdev(priv->dev);
+ 
+ 		list_for_each_entry_safe(cpriv, tcpriv, &priv->child_intfs, list)
+ 			kfree(cpriv);
+ 
+ 		kfree(priv);
++>>>>>>> 022d038a163f (IB/ipoib: Limit call to free rdma_netdev for capable devices)
  	}
  
  	kfree(dev_list);
* Unmerged path drivers/infiniband/hw/mlx5/main.c
* Unmerged path drivers/infiniband/ulp/ipoib/ipoib_main.c
