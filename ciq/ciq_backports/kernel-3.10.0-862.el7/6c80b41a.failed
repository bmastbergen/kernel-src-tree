RDMA/netlink: Add nldev initialization flows

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
commit-author Leon Romanovsky <leonro@mellanox.com>
commit 6c80b41abe22ae3c0d98f39a88f4b8fb501910d3
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/6c80b41a.failed

Add nldev init and exit flows to the RDMA/core.

	Signed-off-by: Leon Romanovsky <leonro@mellanox.com>
	Reviewed-by: Steve Wise <swise@opengridcomputing.com>
(cherry picked from commit 6c80b41abe22ae3c0d98f39a88f4b8fb501910d3)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/core/Makefile
#	drivers/infiniband/core/device.c
diff --cc drivers/infiniband/core/Makefile
index edaae9f9853c,920609a0872e..000000000000
--- a/drivers/infiniband/core/Makefile
+++ b/drivers/infiniband/core/Makefile
@@@ -10,9 -10,12 +10,15 @@@ obj-$(CONFIG_INFINIBAND_USER_ACCESS) +
  ib_core-y :=			packer.o ud_header.o verbs.o cq.o rw.o sysfs.o \
  				device.o fmr_pool.o cache.o netlink.o \
  				roce_gid_mgmt.o mr_pool.o addr.o sa_query.o \
++<<<<<<< HEAD
 +				multicast.o mad.o smi.o agent.o mad_rmpp.o
++=======
+ 				multicast.o mad.o smi.o agent.o mad_rmpp.o \
+ 				security.o nldev.o
+ 
++>>>>>>> 6c80b41abe22 (RDMA/netlink: Add nldev initialization flows)
  ib_core-$(CONFIG_INFINIBAND_USER_MEM) += umem.o
  ib_core-$(CONFIG_INFINIBAND_ON_DEMAND_PAGING) += umem_odp.o umem_rbtree.o
 -ib_core-$(CONFIG_CGROUP_RDMA) += cgroup.o
  
  ib_cm-y :=			cm.o
  
diff --cc drivers/infiniband/core/device.c
index a4559eda966e,66b109bc6753..000000000000
--- a/drivers/infiniband/core/device.c
+++ b/drivers/infiniband/core/device.c
@@@ -1071,6 -1212,8 +1071,11 @@@ static int __init ib_core_init(void
  		goto err_sa;
  	}
  
++<<<<<<< HEAD
++=======
+ 	nldev_init();
+ 	rdma_nl_register(RDMA_NL_LS, ibnl_ls_cb_table);
++>>>>>>> 6c80b41abe22 (RDMA/netlink: Add nldev initialization flows)
  	ib_cache_setup();
  
  	return 0;
@@@ -1095,7 -1238,9 +1100,13 @@@ err
  static void __exit ib_core_cleanup(void)
  {
  	ib_cache_cleanup();
++<<<<<<< HEAD
 +	ib_remove_ibnl_clients();
++=======
+ 	nldev_exit();
+ 	rdma_nl_unregister(RDMA_NL_LS);
+ 	unregister_lsm_notifier(&ibdev_lsm_nb);
++>>>>>>> 6c80b41abe22 (RDMA/netlink: Add nldev initialization flows)
  	ib_sa_cleanup();
  	ib_mad_cleanup();
  	addr_cleanup();
* Unmerged path drivers/infiniband/core/Makefile
* Unmerged path drivers/infiniband/core/device.c
diff --git a/drivers/infiniband/core/nldev.c b/drivers/infiniband/core/nldev.c
new file mode 100644
index 000000000000..1d1e4f214874
--- /dev/null
+++ b/drivers/infiniband/core/nldev.c
@@ -0,0 +1,45 @@
+/*
+ * Copyright (c) 2017 Mellanox Technologies. All rights reserved.
+ *
+ * Redistribution and use in source and binary forms, with or without
+ * modification, are permitted provided that the following conditions are met:
+ *
+ * 1. Redistributions of source code must retain the above copyright
+ *    notice, this list of conditions and the following disclaimer.
+ * 2. Redistributions in binary form must reproduce the above copyright
+ *    notice, this list of conditions and the following disclaimer in the
+ *    documentation and/or other materials provided with the distribution.
+ * 3. Neither the names of the copyright holders nor the names of its
+ *    contributors may be used to endorse or promote products derived from
+ *    this software without specific prior written permission.
+ *
+ * Alternatively, this software may be distributed under the terms of the
+ * GNU General Public License ("GPL") version 2 as published by the Free
+ * Software Foundation.
+ *
+ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
+ * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
+ * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
+ * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
+ * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
+ * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
+ * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
+ * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
+ * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
+ * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
+ * POSSIBILITY OF SUCH DAMAGE.
+ */
+
+#include <rdma/rdma_netlink.h>
+
+#include "core_priv.h"
+
+void __init nldev_init(void)
+{
+	rdma_nl_register(RDMA_NL_NLDEV, NULL);
+}
+
+void __exit nldev_exit(void)
+{
+	rdma_nl_unregister(RDMA_NL_NLDEV);
+}
