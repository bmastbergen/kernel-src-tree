kvm,powerpc: Serialize wq active checks in ops->vcpu_kick

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
Rebuild_CHGLOG: - [x86] kvm, powerpc: Serialize wq active checks in ops->vcpu_kick (Paolo Bonzini) [1498473]
Rebuild_FUZZ: 99.13%
commit-author Davidlohr Bueso <dave@stgolabs.net>
commit 267ad7bc2d3f69af536035b6a3e4a9a2b6ae11dc
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/267ad7bc.failed

Particularly because kvmppc_fast_vcpu_kick_hv() is a callback,
ensure that we properly serialize wq active checks in order to
avoid potentially missing a wakeup due to racing with the waiter
side.

	Signed-off-by: Davidlohr Bueso <dbueso@suse.de>
	Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
(cherry picked from commit 267ad7bc2d3f69af536035b6a3e4a9a2b6ae11dc)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/powerpc/kvm/book3s_hv.c
diff --cc arch/powerpc/kvm/book3s_hv.c
index 92357b82799a,73bf1ebfa78f..000000000000
--- a/arch/powerpc/kvm/book3s_hv.c
+++ b/arch/powerpc/kvm/book3s_hv.c
@@@ -156,11 -178,11 +156,16 @@@ static bool kvmppc_ipi_thread(int cpu
  static void kvmppc_fast_vcpu_kick_hv(struct kvm_vcpu *vcpu)
  {
  	int cpu;
 -	struct swait_queue_head *wqp;
 +	wait_queue_head_t *wqp;
  
  	wqp = kvm_arch_vcpu_wq(vcpu);
++<<<<<<< HEAD
 +	if (waitqueue_active(wqp)) {
 +		wake_up_interruptible(wqp);
++=======
+ 	if (swq_has_sleeper(wqp)) {
+ 		swake_up(wqp);
++>>>>>>> 267ad7bc2d3f (kvm,powerpc: Serialize wq active checks in ops->vcpu_kick)
  		++vcpu->stat.halt_wakeup;
  	}
  
* Unmerged path arch/powerpc/kvm/book3s_hv.c
