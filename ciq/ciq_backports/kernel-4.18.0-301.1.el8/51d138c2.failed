net/mlx5: Fix health error state handling

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-301.1.el8
commit-author Shay Drory <shayd@nvidia.com>
commit 51d138c2610a236c1ed0059d034ee4c74f452b86
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-301.1.el8/51d138c2.failed

Currently, when we discover a fatal error, we are queueing a work that
will wait for a lock in order to enter the device to error state.
Meanwhile, FW commands are still being processed, and gets timeouts.
This can block the driver for few minutes before the work will manage
to get the lock and enter to error state.

Setting the device to error state before queueing health work, in order
to avoid FW commands being processed while the work is waiting for the
lock.

Fixes: c1d4d2e92ad6 ("net/mlx5: Avoid calling sleeping function by the health poll thread")
	Signed-off-by: Shay Drory <shayd@nvidia.com>
	Reviewed-by: Moshe Shemesh <moshe@nvidia.com>
	Signed-off-by: Saeed Mahameed <saeedm@nvidia.com>
(cherry picked from commit 51d138c2610a236c1ed0059d034ee4c74f452b86)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlx5/core/health.c
diff --cc drivers/net/ethernet/mellanox/mlx5/core/health.c
index b31f769d2df9,0c32c485eb58..000000000000
--- a/drivers/net/ethernet/mellanox/mlx5/core/health.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/health.c
@@@ -208,12 -218,7 +218,16 @@@ void mlx5_enter_error_state(struct mlx5
  		goto unlock;
  	}
  
++<<<<<<< HEAD
 +	if (check_fatal_sensors(dev) || force) { /* protected state setting */
 +		dev->state = MLX5_DEVICE_STATE_INTERNAL_ERROR;
 +		mlx5_cmd_flush(dev);
 +	}
 +
 +	mlx5_notifier_call_chain(dev->priv.events, MLX5_DEV_EVENT_SYS_ERROR, (void *)1);
++=======
+ 	enter_error_state(dev, force);
++>>>>>>> 51d138c2610a (net/mlx5: Fix health error state handling)
  unlock:
  	mutex_unlock(&dev->intf_state_mutex);
  }
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/health.c
