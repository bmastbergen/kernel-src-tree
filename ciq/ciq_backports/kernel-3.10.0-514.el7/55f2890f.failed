perf/x86/intel/rapl: Add proper error handling

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Thomas Gleixner <tglx@linutronix.de>
commit 55f2890f0726fe4a1f41a3a0e72ca1a263f095c3
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/55f2890f.failed

Like uncore the rapl driver lacks error handling. It leaks memory and leaves
the hotplug notifier registered.

Add the proper error checks, cleanup the memory and register the hotplug
notifier only on success.

	Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
	Signed-off-by: Peter Zijlstra (Intel) <peterz@infradead.org>
	Cc: Andi Kleen <andi.kleen@intel.com>
	Cc: Arnaldo Carvalho de Melo <acme@redhat.com>
	Cc: Borislav Petkov <bp@alien8.de>
	Cc: Harish Chegondi <harish.chegondi@intel.com>
	Cc: Jacob Pan <jacob.jun.pan@linux.intel.com>
	Cc: Jiri Olsa <jolsa@redhat.com>
	Cc: Kan Liang <kan.liang@intel.com>
	Cc: Linus Torvalds <torvalds@linux-foundation.org>
	Cc: Peter Zijlstra <peterz@infradead.org>
	Cc: Stephane Eranian <eranian@google.com>
	Cc: Vince Weaver <vincent.weaver@maine.edu>
	Cc: linux-kernel@vger.kernel.org
Link: http://lkml.kernel.org/r/20160222221012.231222076@linutronix.de
	Signed-off-by: Ingo Molnar <mingo@kernel.org>
(cherry picked from commit 55f2890f0726fe4a1f41a3a0e72ca1a263f095c3)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kernel/cpu/perf_event_intel_rapl.c
diff --cc arch/x86/kernel/cpu/perf_event_intel_rapl.c
index c019c57572a7,98b04d202760..000000000000
--- a/arch/x86/kernel/cpu/perf_event_intel_rapl.c
+++ b/arch/x86/kernel/cpu/perf_event_intel_rapl.c
@@@ -765,13 -765,12 +775,16 @@@ static int __init rapl_pmu_init(void
  	ret = perf_pmu_register(&rapl_pmu_class, "power", -1);
  	if (WARN_ON(ret)) {
  		pr_info("RAPL PMU detected, registration failed (%d), RAPL PMU disabled\n", ret);
- 		cpu_notifier_register_done();
- 		return -1;
+ 		goto out;
  	}
  
++<<<<<<< HEAD:arch/x86/kernel/cpu/perf_event_intel_rapl.c
 +	pmu = __get_cpu_var(rapl_pmu);
++=======
+ 	__perf_cpu_notifier(rapl_cpu_notifier);
+ 
+ 	pmu = __this_cpu_read(rapl_pmu);
++>>>>>>> 55f2890f0726 (perf/x86/intel/rapl: Add proper error handling):arch/x86/events/intel/rapl.c
  
  	pr_info("RAPL PMU detected,"
  		" API unit is 2^-32 Joules,"
* Unmerged path arch/x86/kernel/cpu/perf_event_intel_rapl.c
