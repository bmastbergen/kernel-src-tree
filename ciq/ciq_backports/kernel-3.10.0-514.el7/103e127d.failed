usb: hcd: Remove USB phy if needed

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Valentine Barshak <valentine.barshak@cogentembedded.com>
commit 103e127d1f8f985e8a662da6537ebc5e08902ee3
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/103e127d.failed

This adds remove_phy flag to the HCD structure. If the flag is
set and if hcd->phy is valid, the phy is shutdown and released
whenever usb_add_hcd fails or usb_hcd_remove is called.
This can be used by the HCD drivers to auto-remove
the external USB phy when it is no longer needed.

	Signed-off-by: Valentine Barshak <valentine.barshak@cogentembedded.com>
	Acked-by: Alan Stern <stern@rowland.harvard.edu>
	Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
(cherry picked from commit 103e127d1f8f985e8a662da6537ebc5e08902ee3)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/usb/core/hcd.c
diff --cc drivers/usb/core/hcd.c
index f9bc43c32dd2,7527c8e4ec64..000000000000
--- a/drivers/usb/core/hcd.c
+++ b/drivers/usb/core/hcd.c
@@@ -2847,10 -2810,14 +2854,18 @@@ void usb_remove_hcd(struct usb_hcd *hcd
  			free_irq(hcd->irq, hcd);
  	}
  
 -	usb_put_dev(hcd->self.root_hub);
  	usb_deregister_bus(&hcd->self);
  	hcd_buffer_destroy(hcd);
++<<<<<<< HEAD
 +
 +	usb_put_invalidate_rhdev(hcd);
++=======
+ 	if (hcd->remove_phy && hcd->phy) {
+ 		usb_phy_shutdown(hcd->phy);
+ 		usb_put_phy(hcd->phy);
+ 		hcd->phy = NULL;
+ 	}
++>>>>>>> 103e127d1f8f (usb: hcd: Remove USB phy if needed)
  }
  EXPORT_SYMBOL_GPL(usb_remove_hcd);
  
* Unmerged path drivers/usb/core/hcd.c
diff --git a/include/linux/usb/hcd.h b/include/linux/usb/hcd.h
index 8845ed2f1978..470dd408986d 100644
--- a/include/linux/usb/hcd.h
+++ b/include/linux/usb/hcd.h
@@ -134,6 +134,7 @@ struct usb_hcd {
 	unsigned		rh_registered:1;/* is root hub registered? */
 	unsigned		rh_pollable:1;	/* may we poll the root hub? */
 	unsigned		msix_enabled:1;	/* driver has MSI-X enabled? */
+	unsigned		remove_phy:1;	/* auto-remove USB phy */
 
 	/* The next flag is a stopgap, to be removed when all the HCDs
 	 * support the new root-hub polling mechanism. */
