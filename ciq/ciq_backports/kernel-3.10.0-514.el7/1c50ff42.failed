iscsi-target: clear tx_thread_active

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Varun Prakash <varun@chelsio.com>
commit 1c50ff424e3d9a392ec2df797c3b6083ed70fca6
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/1c50ff42.failed

clear tx_thread_active for ISCSI_HW_OFFLOAD
transport in logout_post_handler functions.

	Signed-off-by: Varun Prakash <varun@chelsio.com>
	Signed-off-by: Nicholas Bellinger <nab@linux-iscsi.org>
(cherry picked from commit 1c50ff424e3d9a392ec2df797c3b6083ed70fca6)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/target/iscsi/iscsi_target.c
diff --cc drivers/target/iscsi/iscsi_target.c
index f6d914e3ba95,29df956ed0cc..000000000000
--- a/drivers/target/iscsi/iscsi_target.c
+++ b/drivers/target/iscsi/iscsi_target.c
@@@ -4503,7 -4369,19 +4503,23 @@@ static void iscsit_logout_post_handler_
  	struct iscsi_conn *conn)
  {
  	struct iscsi_session *sess = conn->sess;
++<<<<<<< HEAD
 +	int sleep = cmpxchg(&conn->tx_thread_active, true, false);
++=======
+ 	int sleep = 1;
+ 	/*
+ 	 * Traditional iscsi/tcp will invoke this logic from TX thread
+ 	 * context during session logout, so clear tx_thread_active and
+ 	 * sleep if iscsit_close_connection() has not already occured.
+ 	 *
+ 	 * Since iser-target invokes this logic from it's own workqueue,
+ 	 * always sleep waiting for RX/TX thread shutdown to complete
+ 	 * within iscsit_close_connection().
+ 	 */
+ 	if ((conn->conn_transport->transport_type == ISCSI_TCP) ||
+ 	    (conn->conn_transport->transport_type == ISCSI_HW_OFFLOAD))
+ 		sleep = cmpxchg(&conn->tx_thread_active, true, false);
++>>>>>>> 1c50ff424e3d (iscsi-target: clear tx_thread_active)
  
  	atomic_set(&conn->conn_logout_remove, 0);
  	complete(&conn->conn_logout_comp);
@@@ -4517,7 -4395,11 +4533,15 @@@
  static void iscsit_logout_post_handler_samecid(
  	struct iscsi_conn *conn)
  {
++<<<<<<< HEAD
 +	int sleep = cmpxchg(&conn->tx_thread_active, true, false);
++=======
+ 	int sleep = 1;
+ 
+ 	if ((conn->conn_transport->transport_type == ISCSI_TCP) ||
+ 	    (conn->conn_transport->transport_type == ISCSI_HW_OFFLOAD))
+ 		sleep = cmpxchg(&conn->tx_thread_active, true, false);
++>>>>>>> 1c50ff424e3d (iscsi-target: clear tx_thread_active)
  
  	atomic_set(&conn->conn_logout_remove, 0);
  	complete(&conn->conn_logout_comp);
* Unmerged path drivers/target/iscsi/iscsi_target.c
