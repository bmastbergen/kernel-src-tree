openvswitch: call only into reachable nf-nat code

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Arnd Bergmann <arnd@arndb.de>
commit 99b7248e2ad57ca93ada10c6598affb267ffc99a
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/99b7248e.failed

The openvswitch code has gained support for calling into the
nf-nat-ipv4/ipv6 modules, however those can be loadable modules
in a configuration in which openvswitch is built-in, leading
to link errors:

net/built-in.o: In function `__ovs_ct_lookup':
:(.text+0x2cc2c8): undefined reference to `nf_nat_icmp_reply_translation'
:(.text+0x2cc66c): undefined reference to `nf_nat_icmpv6_reply_translation'

The dependency on (!NF_NAT || NF_NAT) prevents similar issues,
but NF_NAT is set to 'y' if any of the symbols selecting
it are built-in, but the link error happens when any of them
are modular.

A second issue is that even if CONFIG_NF_NAT_IPV6 is built-in,
CONFIG_NF_NAT_IPV4 might be completely disabled. This is unlikely
to be useful in practice, but the driver currently only handles
IPv6 being optional.

This patch improves the Kconfig dependency so that openvswitch
cannot be built-in if either of the two other symbols are set
to 'm', and it replaces the incorrect #ifdef in ovs_ct_nat_execute()
with two "if (IS_ENABLED())" checks that should catch all corner
cases also make the code more readable.

The same #ifdef exists ovs_ct_nat_to_attr(), where it does not
cause a link error, but for consistency I'm changing it the same
way.

	Signed-off-by: Arnd Bergmann <arnd@arndb.de>
Fixes: 05752523e565 ("openvswitch: Interface with NAT.")
	Acked-by: Joe Stringer <joe@ovn.org>
	Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
(cherry picked from commit 99b7248e2ad57ca93ada10c6598affb267ffc99a)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/openvswitch/Kconfig
#	net/openvswitch/conntrack.c
diff --cc net/openvswitch/Kconfig
index aa5eac5326eb,ce947292ae77..000000000000
--- a/net/openvswitch/Kconfig
+++ b/net/openvswitch/Kconfig
@@@ -5,7 -5,11 +5,15 @@@
  config OPENVSWITCH
  	tristate "Open vSwitch"
  	depends on INET
++<<<<<<< HEAD
 +	depends on VXLAN
++=======
+ 	depends on !NF_CONNTRACK || \
+ 		   (NF_CONNTRACK && ((!NF_DEFRAG_IPV6 || NF_DEFRAG_IPV6) && \
+ 				     (!NF_NAT || NF_NAT) && \
+ 				     (!NF_NAT_IPV4 || NF_NAT_IPV4) && \
+ 				     (!NF_NAT_IPV6 || NF_NAT_IPV6)))
++>>>>>>> 99b7248e2ad5 (openvswitch: call only into reachable nf-nat code)
  	select LIBCRC32C
  	select MPLS
  	select NET_MPLS_GSO
* Unmerged path net/openvswitch/conntrack.c
* Unmerged path net/openvswitch/Kconfig
* Unmerged path net/openvswitch/conntrack.c
