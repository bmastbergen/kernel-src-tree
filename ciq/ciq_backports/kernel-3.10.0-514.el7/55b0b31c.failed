ceph: get inode size for each append write

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Yan, Zheng <zyan@redhat.com>
commit 55b0b31cbc09f80db384671e22cdc94b2aa26b29
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/55b0b31c.failed

	Signed-off-by: Yan, Zheng <zyan@redhat.com>
(cherry picked from commit 55b0b31cbc09f80db384671e22cdc94b2aa26b29)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/ceph/file.c
diff --cc fs/ceph/file.c
index 0c3070bb755c,0c62868b5c56..000000000000
--- a/fs/ceph/file.c
+++ b/fs/ceph/file.c
@@@ -994,23 -943,28 +994,37 @@@ static ssize_t ceph_aio_write(struct ki
  	if (ceph_snap(inode) != CEPH_NOSNAP)
  		return -EROFS;
  
 -	prealloc_cf = ceph_alloc_cap_flush();
 -	if (!prealloc_cf)
 -		return -ENOMEM;
 -
  	mutex_lock(&inode->i_mutex);
  
++<<<<<<< HEAD
 +	err = generic_segment_checks(iov, &nr_segs, &count, VERIFY_READ);
 +	if (err)
++=======
+ 	/* We can write back this queue in page reclaim */
+ 	current->backing_dev_info = inode_to_bdi(inode);
+ 
+ 	if (iocb->ki_flags & IOCB_APPEND) {
+ 		err = ceph_do_getattr(inode, CEPH_STAT_CAP_SIZE, false);
+ 		if (err < 0)
+ 			goto out;
+ 	}
+ 
+ 	err = generic_write_checks(iocb, from);
+ 	if (err <= 0)
++>>>>>>> 55b0b31cbc09 (ceph: get inode size for each append write)
  		goto out;
  
 -	pos = iocb->ki_pos;
 -	count = iov_iter_count(from);
 -	err = file_remove_privs(file);
 +	/* We can write back this queue in page reclaim */
 +	current->backing_dev_info = file->f_mapping->backing_dev_info;
 +
 +	err = generic_write_checks(file, &pos, &count, S_ISBLK(inode->i_mode));
 +	if (err)
 +		goto out;
 +
 +	if (count == 0)
 +		goto out;
 +
 +	err = file_remove_suid(file);
  	if (err)
  		goto out;
  
* Unmerged path fs/ceph/file.c
