iommu/vt-d: Split iommu_prepare_identity_map

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
Rebuild_CHGLOG: - [iommu] vt-d: Split iommu_prepare_identity_map (Myron Stowe) [1311267]
Rebuild_FUZZ: 92.68%
commit-author Joerg Roedel <jroedel@suse.de>
commit d66ce54b4664a0d66429a4de996741581d71cf90
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/d66ce54b.failed

Split the part of the function that fetches the domain out
and put the rest into into a domain_prepare_identity_map, so
that the code can also be used with when the domain is
already known.

	Signed-off-by: Joerg Roedel <jroedel@suse.de>
(cherry picked from commit d66ce54b4664a0d66429a4de996741581d71cf90)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/iommu/intel-iommu.c
diff --cc drivers/iommu/intel-iommu.c
index bb8ed4832156,24d31090b140..000000000000
--- a/drivers/iommu/intel-iommu.c
+++ b/drivers/iommu/intel-iommu.c
@@@ -2386,23 -2463,27 +2379,39 @@@ static int domain_prepare_identity_map(
  		     dmi_get_system_info(DMI_BIOS_VENDOR),
  		     dmi_get_system_info(DMI_BIOS_VERSION),
  		     dmi_get_system_info(DMI_PRODUCT_VERSION));
- 		ret = -EIO;
- 		goto error;
+ 		return -EIO;
  	}
  
- 	ret = iommu_domain_identity_map(domain, start, end);
+ 	return iommu_domain_identity_map(domain, start, end);
+ }
+ 
+ static int iommu_prepare_identity_map(struct device *dev,
+ 				      unsigned long long start,
+ 				      unsigned long long end)
+ {
+ 	struct dmar_domain *domain;
+ 	int ret;
+ 
+ 	domain = get_domain_for_dev(dev, DEFAULT_DOMAIN_ADDRESS_WIDTH);
+ 	if (!domain)
+ 		return -ENOMEM;
+ 
+ 	ret = domain_prepare_identity_map(dev, domain, start, end);
  	if (ret)
- 		goto error;
+ 		domain_exit(domain);
  
++<<<<<<< HEAD
 +	/* context entry init */
 +	ret = domain_context_mapping(domain, dev);
 +	if (ret)
 +		goto error;
 +
 +	return 0;
 +
 + error:
 +	domain_exit(domain);
++=======
++>>>>>>> d66ce54b4664 (iommu/vt-d: Split iommu_prepare_identity_map)
  	return ret;
  }
  
* Unmerged path drivers/iommu/intel-iommu.c
