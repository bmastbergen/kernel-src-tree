IB/cm: Use the source GID index type

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Matan Barak <matanb@mellanox.com>
commit cb57bb849effcaa83addd739595d3dea3a5905fb
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/cb57bb84.failed

Previosuly, cm and cma modules supported only IB and RoCE v1 GID type.
In order to support multiple GID types, the gid_type is passed to
cm_init_av_by_path and stored in the path record.

The rdma cm client would use a default GID type that will be saved in
rdma_id_private.

	Signed-off-by: Matan Barak <matanb@mellanox.com>
	Signed-off-by: Doug Ledford <dledford@redhat.com>
(cherry picked from commit cb57bb849effcaa83addd739595d3dea3a5905fb)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/core/cm.c
#	drivers/infiniband/core/cma.c
diff --cc drivers/infiniband/core/cm.c
index d070930aadb5,d883a322fc65..000000000000
--- a/drivers/infiniband/core/cm.c
+++ b/drivers/infiniband/core/cm.c
@@@ -363,7 -364,7 +363,11 @@@ static int cm_init_av_by_path(struct ib
  	read_lock_irqsave(&cm.device_lock, flags);
  	list_for_each_entry(cm_dev, &cm.device_list, list) {
  		if (!ib_find_cached_gid(cm_dev->ib_device, &path->sgid,
++<<<<<<< HEAD
 +					&p, NULL)) {
++=======
+ 					path->gid_type, ndev, &p, NULL)) {
++>>>>>>> cb57bb849eff (IB/cm: Use the source GID index type)
  			port = cm_dev->port[p-1];
  			break;
  		}
@@@ -1636,10 -1641,24 +1642,29 @@@ static int cm_req_handler(struct cm_wor
  	cm_format_paths_from_req(req_msg, &work->path[0], &work->path[1]);
  
  	memcpy(work->path[0].dmac, cm_id_priv->av.ah_attr.dmac, ETH_ALEN);
- 	ret = cm_init_av_by_path(&work->path[0], &cm_id_priv->av);
+ 	ret = ib_get_cached_gid(work->port->cm_dev->ib_device,
+ 				work->port->port_num,
+ 				cm_id_priv->av.ah_attr.grh.sgid_index,
+ 				&gid, &gid_attr);
+ 	if (!ret) {
+ 		if (gid_attr.ndev)
+ 			dev_put(gid_attr.ndev);
+ 		work->path[0].gid_type = gid_attr.gid_type;
+ 		ret = cm_init_av_by_path(&work->path[0], &cm_id_priv->av);
+ 	}
  	if (ret) {
++<<<<<<< HEAD
 +		ib_get_cached_gid(work->port->cm_dev->ib_device,
 +				  work->port->port_num, 0, &work->path[0].sgid);
++=======
+ 		int err = ib_get_cached_gid(work->port->cm_dev->ib_device,
+ 					    work->port->port_num, 0,
+ 					    &work->path[0].sgid,
+ 					    &gid_attr);
+ 		if (!err && gid_attr.ndev)
+ 			dev_put(gid_attr.ndev);
+ 		work->path[0].gid_type = gid_attr.gid_type;
++>>>>>>> cb57bb849eff (IB/cm: Use the source GID index type)
  		ib_send_cm_rej(cm_id, IB_CM_REJ_INVALID_GID,
  			       &work->path[0].sgid, sizeof work->path[0].sgid,
  			       NULL, 0);
diff --cc drivers/infiniband/core/cma.c
index 1487f99e0916,446323a9d38f..000000000000
--- a/drivers/infiniband/core/cma.c
+++ b/drivers/infiniband/core/cma.c
@@@ -2294,8 -2311,12 +2295,15 @@@ static int cma_resolve_iboe_route(struc
  
  	route->num_paths = 1;
  
 -	if (addr->dev_addr.bound_dev_if) {
 +	if (addr->dev_addr.bound_dev_if)
  		ndev = dev_get_by_index(&init_net, addr->dev_addr.bound_dev_if);
++<<<<<<< HEAD
++=======
+ 		route->path_rec->net = &init_net;
+ 		route->path_rec->ifindex = addr->dev_addr.bound_dev_if;
+ 		route->path_rec->gid_type = id_priv->gid_type;
+ 	}
++>>>>>>> cb57bb849eff (IB/cm: Use the source GID index type)
  	if (!ndev) {
  		ret = -ENODEV;
  		goto err2;
* Unmerged path drivers/infiniband/core/cm.c
* Unmerged path drivers/infiniband/core/cma.c
