perf hists: Support multiple sort keys in a hierarchy level

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Namhyung Kim <namhyung@kernel.org>
commit a23f37e864609f0887c1cb77c4d5b62586484a61
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/a23f37e8.failed

This implements having multiple sort keys in a single hierarchy level.
Originally only single sort key is supported for each level, but now
using the group syntax with '{ }', it can set more than one sort key in
one level.  Note that now it needs to quote in order to prevent shell
interpretation.

For example:

  $ perf report --hierarchy -s '{comm,dso},sym'
  ...
  #       Overhead  Command / Shared Object / Symbol
  # ..............  ..........................................
  #
      48.67%        swapper          [kernel.vmlinux]
         34.42%        [k] intel_idle
          1.30%        [k] __tick_nohz_idle_enter
          1.03%        [k] cpuidle_reflect
       8.87%        firefox          libpthread-2.22.so
          6.60%        [.] __GI___libc_recvmsg
          1.18%        [.] pthread_cond_signal@@GLIBC_2.3.2
          1.09%        [.] 0x000000000000ff4b
       6.11%        Xorg             libc-2.22.so
          5.27%        [.] __memcpy_sse2_unaligned

In the above example, the command name and the shared object name are
shown on the same line but the symbol name is on the different line.
Since the first two are grouped by '{}', they are in the same level.

Suggested-and-Tested=by: Arnaldo Carvalho de Melo <acme@kernel.org>
	Signed-off-by: Namhyung Kim <namhyung@kernel.org>
	Signed-off-by: Arnaldo Carvalho de Melo <acme@redhat.com>
	Cc: Alexander Shishkin <alexander.shishkin@linux.intel.com>
	Cc: David Ahern <dsahern@gmail.com>
	Cc: Jiri Olsa <jolsa@kernel.org>
	Cc: Jiri Olsa <jolsa@redhat.com>
	Cc: Peter Zijlstra <peterz@infradead.org>
	Cc: Stephane Eranian <eranian@google.com>
	Cc: Thomas Gleixner <tglx@linutronix.de>
	Cc: Wang Nan <wangnan0@huawei.com>
Link: http://lkml.kernel.org/r/1457361308-514-4-git-send-email-namhyung@kernel.org
	Signed-off-by: Ingo Molnar <mingo@kernel.org>
(cherry picked from commit a23f37e864609f0887c1cb77c4d5b62586484a61)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/perf/util/sort.c
diff --cc tools/perf/util/sort.c
index 8f36c1d6fd38,041f236379e0..000000000000
--- a/tools/perf/util/sort.c
+++ b/tools/perf/util/sort.c
@@@ -1955,18 -2309,41 +1955,54 @@@ static int setup_sort_list(char *str, s
  {
  	char *tmp, *tok;
  	int ret = 0;
++<<<<<<< HEAD
 +
 +	for (tok = strtok_r(str, ", ", &tmp);
 +			tok; tok = strtok_r(NULL, ", ", &tmp)) {
 +		ret = sort_dimension__add(tok, evlist);
 +		if (ret == -EINVAL) {
 +			error("Invalid --sort key: `%s'", tok);
 +			break;
 +		} else if (ret == -ESRCH) {
 +			error("Unknown --sort key: `%s'", tok);
 +			break;
++=======
+ 	int level = 0;
+ 	int next_level = 1;
+ 	bool in_group = false;
+ 
+ 	do {
+ 		tok = str;
+ 		tmp = strpbrk(str, "{}, ");
+ 		if (tmp) {
+ 			if (in_group)
+ 				next_level = level;
+ 			else
+ 				next_level = level + 1;
+ 
+ 			if (*tmp == '{')
+ 				in_group = true;
+ 			else if (*tmp == '}')
+ 				in_group = false;
+ 
+ 			*tmp = '\0';
+ 			str = tmp + 1;
++>>>>>>> a23f37e86460 (perf hists: Support multiple sort keys in a hierarchy level)
  		}
- 	}
+ 
+ 		if (*tok) {
+ 			ret = sort_dimension__add(tok, evlist, level);
+ 			if (ret == -EINVAL) {
+ 				error("Invalid --sort key: `%s'", tok);
+ 				break;
+ 			} else if (ret == -ESRCH) {
+ 				error("Unknown --sort key: `%s'", tok);
+ 				break;
+ 			}
+ 		}
+ 
+ 		level = next_level;
+ 	} while (tmp);
  
  	return ret;
  }
* Unmerged path tools/perf/util/sort.c
