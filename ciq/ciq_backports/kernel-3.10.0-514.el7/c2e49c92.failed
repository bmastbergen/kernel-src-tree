IB/SA: Integrate ib_sa module into ib_core module

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Mark Bloch <markb@mellanox.com>
commit c2e49c92326f9baaa490492c48bea5a7f49d3244
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/c2e49c92.failed

Consolidate ib_sa into ib_core, this commit eliminates
ib_sa.ko and makes it part of ib_core.ko

	Signed-off-by: Mark Bloch <markb@mellanox.com>
	Signed-off-by: Doug Ledford <dledford@redhat.com>
(cherry picked from commit c2e49c92326f9baaa490492c48bea5a7f49d3244)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/core/Makefile
#	drivers/infiniband/core/core_priv.h
#	drivers/infiniband/core/device.c
diff --cc drivers/infiniband/core/Makefile
index ae48d874012f,edaae9f9853c..000000000000
--- a/drivers/infiniband/core/Makefile
+++ b/drivers/infiniband/core/Makefile
@@@ -1,23 -1,19 +1,35 @@@
  infiniband-$(CONFIG_INFINIBAND_ADDR_TRANS)	:= rdma_cm.o
  user_access-$(CONFIG_INFINIBAND_ADDR_TRANS)	:= rdma_ucm.o
  
++<<<<<<< HEAD
 +obj-$(CONFIG_INFINIBAND) +=		ib_core.o ib_mad.o ib_sa.o \
 +					ib_cm.o iw_cm.o ib_addr.o \
++=======
+ obj-$(CONFIG_INFINIBAND) +=		ib_core.o ib_cm.o iw_cm.o \
++>>>>>>> c2e49c92326f (IB/SA: Integrate ib_sa module into ib_core module)
  					$(infiniband-y)
  obj-$(CONFIG_INFINIBAND_USER_MAD) +=	ib_umad.o
  obj-$(CONFIG_INFINIBAND_USER_ACCESS) +=	ib_uverbs.o ib_ucm.o \
  					$(user_access-y)
  
 -ib_core-y :=			packer.o ud_header.o verbs.o cq.o rw.o sysfs.o \
 +ib_core-y :=			packer.o ud_header.o verbs.o cq.o sysfs.o \
  				device.o fmr_pool.o cache.o netlink.o \
++<<<<<<< HEAD
 +				roce_gid_mgmt.o
 +ib_core-$(CONFIG_INFINIBAND_USER_MEM) += umem.o
 +ib_core-$(CONFIG_INFINIBAND_ON_DEMAND_PAGING) += umem_odp.o umem_rbtree.o
 +
 +ib_mad-y :=			mad.o smi.o agent.o mad_rmpp.o
 +
 +ib_sa-y :=			sa_query.o multicast.o
 +
++=======
+ 				roce_gid_mgmt.o mr_pool.o addr.o sa_query.o \
+ 				multicast.o mad.o smi.o agent.o mad_rmpp.o
+ ib_core-$(CONFIG_INFINIBAND_USER_MEM) += umem.o
+ ib_core-$(CONFIG_INFINIBAND_ON_DEMAND_PAGING) += umem_odp.o umem_rbtree.o
+ 
++>>>>>>> c2e49c92326f (IB/SA: Integrate ib_sa module into ib_core module)
  ib_cm-y :=			cm.o
  
  iw_cm-y :=			iwcm.o iwpm_util.o iwpm_msg.o
diff --cc drivers/infiniband/core/core_priv.h
index 0d01fb95d944,c78a7fa2c2bb..000000000000
--- a/drivers/infiniband/core/core_priv.h
+++ b/drivers/infiniband/core/core_priv.h
@@@ -114,4 -137,13 +114,16 @@@ static inline bool rdma_is_upper_dev_rc
  	return _upper == upper;
  }
  
++<<<<<<< HEAD
++=======
+ int addr_init(void);
+ void addr_cleanup(void);
+ 
+ int ib_mad_init(void);
+ void ib_mad_cleanup(void);
+ 
+ int ib_sa_init(void);
+ void ib_sa_cleanup(void);
+ 
++>>>>>>> c2e49c92326f (IB/SA: Integrate ib_sa module into ib_core module)
  #endif /* _CORE_PRIV_H */
diff --cc drivers/infiniband/core/device.c
index 84b0c0c4193b,2cd0956aef34..000000000000
--- a/drivers/infiniband/core/device.c
+++ b/drivers/infiniband/core/device.c
@@@ -974,10 -983,34 +974,40 @@@ static int __init ib_core_init(void
  		goto err_sysfs;
  	}
  
++<<<<<<< HEAD
++=======
+ 	ret = addr_init();
+ 	if (ret) {
+ 		pr_warn("Could't init IB address resolution\n");
+ 		goto err_ibnl;
+ 	}
+ 
+ 	ret = ib_mad_init();
+ 	if (ret) {
+ 		pr_warn("Couldn't init IB MAD\n");
+ 		goto err_addr;
+ 	}
+ 
+ 	ret = ib_sa_init();
+ 	if (ret) {
+ 		pr_warn("Couldn't init SA\n");
+ 		goto err_mad;
+ 	}
+ 
++>>>>>>> c2e49c92326f (IB/SA: Integrate ib_sa module into ib_core module)
  	ib_cache_setup();
  
  	return 0;
  
++<<<<<<< HEAD
++=======
+ err_mad:
+ 	ib_mad_cleanup();
+ err_addr:
+ 	addr_cleanup();
+ err_ibnl:
+ 	ibnl_cleanup();
++>>>>>>> c2e49c92326f (IB/SA: Integrate ib_sa module into ib_core module)
  err_sysfs:
  	class_unregister(&ib_class);
  err_comp:
@@@ -990,6 -1023,9 +1020,12 @@@ err
  static void __exit ib_core_cleanup(void)
  {
  	ib_cache_cleanup();
++<<<<<<< HEAD
++=======
+ 	ib_sa_cleanup();
+ 	ib_mad_cleanup();
+ 	addr_cleanup();
++>>>>>>> c2e49c92326f (IB/SA: Integrate ib_sa module into ib_core module)
  	ibnl_cleanup();
  	class_unregister(&ib_class);
  	destroy_workqueue(ib_comp_wq);
* Unmerged path drivers/infiniband/core/Makefile
* Unmerged path drivers/infiniband/core/core_priv.h
* Unmerged path drivers/infiniband/core/device.c
diff --git a/drivers/infiniband/core/sa_query.c b/drivers/infiniband/core/sa_query.c
index 963e90469018..36741a31636b 100644
--- a/drivers/infiniband/core/sa_query.c
+++ b/drivers/infiniband/core/sa_query.c
@@ -51,10 +51,6 @@
 #include <rdma/ib_marshall.h>
 #include "sa.h"
 
-MODULE_AUTHOR("Roland Dreier");
-MODULE_DESCRIPTION("InfiniBand subnet administration query support");
-MODULE_LICENSE("Dual BSD/GPL");
-
 #define IB_SA_LOCAL_SVC_TIMEOUT_MIN		100
 #define IB_SA_LOCAL_SVC_TIMEOUT_DEFAULT		2000
 #define IB_SA_LOCAL_SVC_TIMEOUT_MAX		200000
@@ -1728,7 +1724,7 @@ static void ib_sa_remove_one(struct ib_device *device, void *client_data)
 	kfree(sa_dev);
 }
 
-static int __init ib_sa_init(void)
+int ib_sa_init(void)
 {
 	int ret;
 
@@ -1773,7 +1769,7 @@ err1:
 	return ret;
 }
 
-static void __exit ib_sa_cleanup(void)
+void ib_sa_cleanup(void)
 {
 	ibnl_remove_client(RDMA_NL_LS);
 	cancel_delayed_work(&ib_nl_timed_work);
@@ -1783,6 +1779,3 @@ static void __exit ib_sa_cleanup(void)
 	ib_unregister_client(&sa_client);
 	idr_destroy(&query_idr);
 }
-
-module_init(ib_sa_init);
-module_exit(ib_sa_cleanup);
