xprtrdma: Reduce per-transport MR allocation

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Chuck Lever <chuck.lever@oracle.com>
commit 40c6ed0c8a7f2c5d67f5d6774bbce230a42176db
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/40c6ed0c.failed

Reduce resource consumption per-transport to make way for increasing
the credit limit and maximum r/wsize. Pre-allocate fewer MRs.

	Signed-off-by: Chuck Lever <chuck.lever@oracle.com>
	Reviewed-by: Steve Wise <swise@opengridcomputing.com>
	Reviewed-by: Sagi Grimberg <sagig@mellanox.com>
	Reviewed-by: Devesh Sharma <devesh.sharma@avagotech.com>
Tested-By: Devesh Sharma <devesh.sharma@avagotech.com>
	Reviewed-by: Doug Ledford <dledford@redhat.com>
	Signed-off-by: Anna Schumaker <Anna.Schumaker@Netapp.com>
(cherry picked from commit 40c6ed0c8a7f2c5d67f5d6774bbce230a42176db)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/sunrpc/xprtrdma/fmr_ops.c
#	net/sunrpc/xprtrdma/frwr_ops.c
diff --cc net/sunrpc/xprtrdma/fmr_ops.c
index e0da9f8f1686,f1e8dafbd507..000000000000
--- a/net/sunrpc/xprtrdma/fmr_ops.c
+++ b/net/sunrpc/xprtrdma/fmr_ops.c
@@@ -54,9 -69,12 +54,15 @@@ fmr_op_init(struct rpcrdma_xprt *r_xprt
  	INIT_LIST_HEAD(&buf->rb_mws);
  	INIT_LIST_HEAD(&buf->rb_all);
  
++<<<<<<< HEAD
 +	i = (buf->rb_max_requests + 1) * RPCRDMA_MAX_SEGS;
++=======
+ 	i = max_t(int, RPCRDMA_MAX_DATA_SEGS / RPCRDMA_MAX_FMR_SGES, 1);
+ 	i += 2;				/* head + tail */
+ 	i *= buf->rb_max_requests;	/* one set for each RPC slot */
++>>>>>>> 40c6ed0c8a7f (xprtrdma: Reduce per-transport MR allocation)
  	dprintk("RPC:       %s: initalizing %d FMRs\n", __func__, i);
  
 -	rc = -ENOMEM;
  	while (i--) {
  		r = kzalloc(sizeof(*r), GFP_KERNEL);
  		if (!r)
diff --cc net/sunrpc/xprtrdma/frwr_ops.c
index 98b2c213e28f,661fbc1784ab..000000000000
--- a/net/sunrpc/xprtrdma/frwr_ops.c
+++ b/net/sunrpc/xprtrdma/frwr_ops.c
@@@ -214,7 -270,9 +214,13 @@@ frwr_op_init(struct rpcrdma_xprt *r_xpr
  	INIT_LIST_HEAD(&buf->rb_mws);
  	INIT_LIST_HEAD(&buf->rb_all);
  
++<<<<<<< HEAD
 +	i = (buf->rb_max_requests + 1) * RPCRDMA_MAX_SEGS;
++=======
+ 	i = max_t(int, RPCRDMA_MAX_DATA_SEGS / depth, 1);
+ 	i += 2;				/* head + tail */
+ 	i *= buf->rb_max_requests;	/* one set for each RPC slot */
++>>>>>>> 40c6ed0c8a7f (xprtrdma: Reduce per-transport MR allocation)
  	dprintk("RPC:       %s: initalizing %d FRMRs\n", __func__, i);
  
  	while (i--) {
* Unmerged path net/sunrpc/xprtrdma/fmr_ops.c
* Unmerged path net/sunrpc/xprtrdma/frwr_ops.c
