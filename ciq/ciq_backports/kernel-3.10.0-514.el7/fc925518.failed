IB/srp: Initialize dma_length in srp_map_idb

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Christoph Hellwig <hch@lst.de>
commit fc925518aa04ee9f03c4e0cadd9c59f1ef48bcfa
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/fc925518.failed

Without this sg_dma_len will return 0 on architectures tha have
the dma_length field.

Fixes: commit f7f7aab1a5c0 ("IB/srp: Convert to new registration API")
	Signed-off-by: Christoph Hellwig <hch@lst.de>
	Reviewed-by: Sagi Grimberg <sagig@mellanox.com>
	Signed-off-by: Doug Ledford <dledford@redhat.com>
(cherry picked from commit fc925518aa04ee9f03c4e0cadd9c59f1ef48bcfa)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/ulp/srp/ib_srp.c
diff --cc drivers/infiniband/ulp/srp/ib_srp.c
index c0f023980fbe,72fac204d756..000000000000
--- a/drivers/infiniband/ulp/srp/ib_srp.c
+++ b/drivers/infiniband/ulp/srp/ib_srp.c
@@@ -1486,15 -1516,31 +1486,41 @@@ static int srp_map_idb(struct srp_rdma_
  	state.gen.next = next_mr;
  	state.gen.end = end_mr;
  	state.desc = &idb_desc;
 +	state.pages = idb_pages;
 +	state.pages[0] = (req->indirect_dma_addr &
 +			  dev->mr_page_mask);
 +	state.npages = 1;
  	state.base_dma_addr = req->indirect_dma_addr;
  	state.dma_len = idb_len;
++<<<<<<< HEAD
 +	ret = srp_finish_mapping(&state, ch);
 +	if (ret < 0)
 +		goto out;
++=======
+ 
+ 	if (dev->use_fast_reg) {
+ 		state.sg = idb_sg;
+ 		state.sg_nents = 1;
+ 		sg_set_buf(idb_sg, req->indirect_desc, idb_len);
+ 		idb_sg->dma_address = req->indirect_dma_addr; /* hack! */
+ #ifdef CONFIG_NEED_SG_DMA_LENGTH
+ 		idb_sg->dma_length = idb_sg->length;	      /* hack^2 */
+ #endif
+ 		ret = srp_map_finish_fr(&state, ch);
+ 		if (ret < 0)
+ 			return ret;
+ 	} else if (dev->use_fmr) {
+ 		state.pages = idb_pages;
+ 		state.pages[0] = (req->indirect_dma_addr &
+ 				  dev->mr_page_mask);
+ 		state.npages = 1;
+ 		ret = srp_map_finish_fmr(&state, ch);
+ 		if (ret < 0)
+ 			return ret;
+ 	} else {
+ 		return -EINVAL;
+ 	}
++>>>>>>> fc925518aa04 (IB/srp: Initialize dma_length in srp_map_idb)
  
  	*idb_rkey = idb_desc.key;
  
* Unmerged path drivers/infiniband/ulp/srp/ib_srp.c
