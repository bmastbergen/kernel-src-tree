nfsd: don't hold ls_mutex across a layout recall

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
Rebuild_CHGLOG: - [fs] nfsd: don't hold ls_mutex across a layout recall ("J. Bruce Fields") [1344797]
Rebuild_FUZZ: 98.97%
commit-author Jeff Layton <jlayton@poochiereds.net>
commit be20aa00c67102aaa54599518c086a2338b19f4c
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/be20aa00.failed

We do need to serialize layout stateid morphing operations, but we
currently hold the ls_mutex across a layout recall which is pretty
ugly. It's also unnecessary -- once we've bumped the seqid and
copied it, we don't need to serialize the rest of the CB_LAYOUTRECALL
vs. anything else. Just drop the mutex once the copy is done.

This was causing a "workqueue leaked lock or atomic" warning and an
occasional deadlock.

There's more work to be done here but this fixes the immediate
regression.

Fixes: cc8a55320b5f "nfsd: serialize layout stateid morphing operations"
	Cc: stable@vger.kernel.org
	Reported-by: Kinglong Mee <kinglongmee@gmail.com>
	Signed-off-by: Jeff Layton <jeff.layton@primarydata.com>
	Signed-off-by: J. Bruce Fields <bfields@redhat.com>
(cherry picked from commit be20aa00c67102aaa54599518c086a2338b19f4c)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/nfsd/nfs4layouts.c
diff --cc fs/nfsd/nfs4layouts.c
index c6e99bd6a3fa,c9d6c715c0fb..000000000000
--- a/fs/nfsd/nfs4layouts.c
+++ b/fs/nfsd/nfs4layouts.c
@@@ -618,8 -615,8 +618,13 @@@ nfsd4_cb_layout_prepare(struct nfsd4_ca
  		container_of(cb, struct nfs4_layout_stateid, ls_recall);
  
  	mutex_lock(&ls->ls_mutex);
++<<<<<<< HEAD
 +	update_stateid(&ls->ls_stid.sc_stateid);
 +	memcpy(&ls->ls_recall_sid, &ls->ls_stid.sc_stateid, sizeof(stateid_t));
++=======
+ 	nfs4_inc_and_copy_stateid(&ls->ls_recall_sid, &ls->ls_stid);
+ 	mutex_unlock(&ls->ls_mutex);
++>>>>>>> be20aa00c671 (nfsd: don't hold ls_mutex across a layout recall)
  }
  
  static int
* Unmerged path fs/nfsd/nfs4layouts.c
