x86/mm: Add kerneldoc comments for pcommit_sfence()

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
Rebuild_CHGLOG: - [x86] mm: Add kerneldoc comments for pcommit_sfence() (Steve Best) [1253104]
Rebuild_FUZZ: 95.92%
commit-author Ross Zwisler <ross.zwisler@linux.intel.com>
commit ca7d9b795e6bc78c80a1771ada867994fabcfc01
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/ca7d9b79.failed

Add kerneldoc comments for pcommit_sfence() describing the
purpose of the PCOMMIT instruction and demonstrating its usage
with an example.

	Signed-off-by: Ross Zwisler <ross.zwisler@linux.intel.com>
	Signed-off-by: Borislav Petkov <bp@suse.de>
	Cc: Andrew Morton <akpm@linux-foundation.org>
	Cc: Andy Lutomirski <luto@amacapital.net>
	Cc: Borislav Petkov <bp@alien8.de>
	Cc: Brian Gerst <brgerst@gmail.com>
	Cc: Denys Vlasenko <dvlasenk@redhat.com>
	Cc: H Peter Anvin <h.peter.anvin@intel.com>
	Cc: H. Peter Anvin <hpa@zytor.com>
	Cc: Linus Torvalds <torvalds@linux-foundation.org>
	Cc: Luis R. Rodriguez <mcgrof@suse.com>
	Cc: Peter Zijlstra <peterz@infradead.org>
	Cc: Thomas Gleixner <tglx@linutronix.de>
	Cc: Toshi Kani <toshi.kani@hp.com>
Link: http://lkml.kernel.org/r/1430261196-2401-1-git-send-email-ross.zwisler@linux.intel.com
Link: http://lkml.kernel.org/r/1431332153-18566-7-git-send-email-bp@alien8.de
	Signed-off-by: Ingo Molnar <mingo@kernel.org>
(cherry picked from commit ca7d9b795e6bc78c80a1771ada867994fabcfc01)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/include/asm/special_insns.h
diff --cc arch/x86/include/asm/special_insns.h
index fc7d11200445,2270e41b32fd..000000000000
--- a/arch/x86/include/asm/special_insns.h
+++ b/arch/x86/include/asm/special_insns.h
@@@ -199,6 -201,66 +199,69 @@@ static inline void clflushopt(volatile 
  		       "+m" (*(volatile char __force *)__p));
  }
  
++<<<<<<< HEAD
++=======
+ static inline void clwb(volatile void *__p)
+ {
+ 	volatile struct { char x[64]; } *p = __p;
+ 
+ 	asm volatile(ALTERNATIVE_2(
+ 		".byte " __stringify(NOP_DS_PREFIX) "; clflush (%[pax])",
+ 		".byte 0x66; clflush (%[pax])", /* clflushopt (%%rax) */
+ 		X86_FEATURE_CLFLUSHOPT,
+ 		".byte 0x66, 0x0f, 0xae, 0x30",  /* clwb (%%rax) */
+ 		X86_FEATURE_CLWB)
+ 		: [p] "+m" (*p)
+ 		: [pax] "a" (p));
+ }
+ 
+ /**
+  * pcommit_sfence() - persistent commit and fence
+  *
+  * The PCOMMIT instruction ensures that data that has been flushed from the
+  * processor's cache hierarchy with CLWB, CLFLUSHOPT or CLFLUSH is accepted to
+  * memory and is durable on the DIMM.  The primary use case for this is
+  * persistent memory.
+  *
+  * This function shows how to properly use CLWB/CLFLUSHOPT/CLFLUSH and PCOMMIT
+  * with appropriate fencing.
+  *
+  * Example:
+  * void flush_and_commit_buffer(void *vaddr, unsigned int size)
+  * {
+  *         unsigned long clflush_mask = boot_cpu_data.x86_clflush_size - 1;
+  *         void *vend = vaddr + size;
+  *         void *p;
+  *
+  *         for (p = (void *)((unsigned long)vaddr & ~clflush_mask);
+  *              p < vend; p += boot_cpu_data.x86_clflush_size)
+  *                 clwb(p);
+  *
+  *         // SFENCE to order CLWB/CLFLUSHOPT/CLFLUSH cache flushes
+  *         // MFENCE via mb() also works
+  *         wmb();
+  *
+  *         // PCOMMIT and the required SFENCE for ordering
+  *         pcommit_sfence();
+  * }
+  *
+  * After this function completes the data pointed to by 'vaddr' has been
+  * accepted to memory and will be durable if the 'vaddr' points to persistent
+  * memory.
+  *
+  * PCOMMIT must always be ordered by an MFENCE or SFENCE, so to help simplify
+  * things we include both the PCOMMIT and the required SFENCE in the
+  * alternatives generated by pcommit_sfence().
+  */
+ static inline void pcommit_sfence(void)
+ {
+ 	alternative(ASM_NOP7,
+ 		    ".byte 0x66, 0x0f, 0xae, 0xf8\n\t" /* pcommit */
+ 		    "sfence",
+ 		    X86_FEATURE_PCOMMIT);
+ }
+ 
++>>>>>>> ca7d9b795e6b (x86/mm: Add kerneldoc comments for pcommit_sfence())
  #define nop() asm volatile ("nop")
  
  
* Unmerged path arch/x86/include/asm/special_insns.h
