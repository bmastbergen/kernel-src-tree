i40e: fix for PHY NVM interaction problem

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Carolyn Wyborny <carolyn.wyborny@intel.com>
commit 8589af70d0879a68c93ef77505a6234d22b1b1a7
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/8589af70.failed

This patch fixes a problem where the NVMUpdate Tool, when using the PHY
NVM feature, gets bad data from the PHY because of contention on the
MDIO interface from get PHY capability calls from the driver during
regular operations.  The problem is fixed by adding a check if media
is available before calling get PHY capability function because that
bit is not set when device is in PHY interaction mode.

Change-ID: Ib89991b0f841808dd92410f5e8683d6ee3301cd0
	Signed-off-by: Carolyn Wyborny <carolyn.wyborny@intel.com>
	Tested-by: Andrew Bowers <andrewx.bowers@intel.com>
	Signed-off-by: Jeff Kirsher <jeffrey.t.kirsher@intel.com>
(cherry picked from commit 8589af70d0879a68c93ef77505a6234d22b1b1a7)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/intel/i40e/i40e_common.c
diff --cc drivers/net/ethernet/intel/i40e/i40e_common.c
index 70826108d799,c51f2fb94716..000000000000
--- a/drivers/net/ethernet/intel/i40e/i40e_common.c
+++ b/drivers/net/ethernet/intel/i40e/i40e_common.c
@@@ -2265,6 -2266,32 +2265,35 @@@ i40e_status i40e_get_link_status(struc
  }
  
  /**
++<<<<<<< HEAD
++=======
+  * i40e_updatelink_status - update status of the HW network link
+  * @hw: pointer to the hw struct
+  **/
+ i40e_status i40e_update_link_info(struct i40e_hw *hw)
+ {
+ 	struct i40e_aq_get_phy_abilities_resp abilities;
+ 	i40e_status status = 0;
+ 
+ 	status = i40e_aq_get_link_info(hw, true, NULL, NULL);
+ 	if (status)
+ 		return status;
+ 
+ 	if (hw->phy.link_info.link_info & I40E_AQ_MEDIA_AVAILABLE) {
+ 		status = i40e_aq_get_phy_capabilities(hw, false, false,
+ 						      &abilities, NULL);
+ 		if (status)
+ 			return status;
+ 
+ 		memcpy(hw->phy.link_info.module_type, &abilities.module_type,
+ 		       sizeof(hw->phy.link_info.module_type));
+ 	}
+ 
+ 	return status;
+ }
+ 
+ /**
++>>>>>>> 8589af70d087 (i40e: fix for PHY NVM interaction problem)
   * i40e_aq_add_veb - Insert a VEB between the VSI and the MAC
   * @hw: pointer to the hw struct
   * @uplink_seid: the MAC or other gizmo SEID
* Unmerged path drivers/net/ethernet/intel/i40e/i40e_common.c
