bonding: fix bond_get_stats()

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Eric Dumazet <edumazet@google.com>
commit fe30937b65354c7fec244caebbdaae68e28ca797
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/fe30937b.failed

bond_get_stats() can be called from rtnetlink (with RTNL held)
or from /proc/net/dev seq handler (with RCU held)

The logic added in commit 5f0c5f73e5ef ("bonding: make global bonding
stats more reliable") kind of assumed only one cpu could run there.

If multiple threads are reading /proc/net/dev, stats can be really
messed up after a while.

A second problem is that some fields are 32bit, so we need to properly
handle the wrap around problem.

Given that RTNL is not always held, we need to use
bond_for_each_slave_rcu().

Fixes: 5f0c5f73e5ef ("bonding: make global bonding stats more reliable")
	Signed-off-by: Eric Dumazet <edumazet@google.com>
	Cc: Andy Gospodarek <gospo@cumulusnetworks.com>
	Cc: Jay Vosburgh <j.vosburgh@gmail.com>
	Cc: Veaceslav Falico <vfalico@gmail.com>
	Reviewed-by: Nikolay Aleksandrov <nikolay@cumulusnetworks.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit fe30937b65354c7fec244caebbdaae68e28ca797)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/bonding/bond_main.c
diff --cc drivers/net/bonding/bond_main.c
index 61cdbbc0aa9f,941ec99cd3b6..000000000000
--- a/drivers/net/bonding/bond_main.c
+++ b/drivers/net/bonding/bond_main.c
@@@ -4098,7 -4163,7 +4101,11 @@@ void bond_setup(struct net_device *bond
  	struct bonding *bond = netdev_priv(bond_dev);
  
  	spin_lock_init(&bond->mode_lock);
++<<<<<<< HEAD
 +	INIT_LIST_HEAD(&bond->slave_list);
++=======
+ 	spin_lock_init(&bond->stats_lock);
++>>>>>>> fe30937b6535 (bonding: fix bond_get_stats())
  	bond->params = bonding_defaults;
  
  	/* Initialize pointers */
* Unmerged path drivers/net/bonding/bond_main.c
diff --git a/include/net/bonding.h b/include/net/bonding.h
index c940ecde787d..8f9d618078b9 100644
--- a/include/net/bonding.h
+++ b/include/net/bonding.h
@@ -207,6 +207,7 @@ struct bonding {
 	 * ALB mode (6) - to sync the use and modifications of its hash table
 	 */
 	spinlock_t mode_lock;
+	spinlock_t stats_lock;
 	u8	 send_peer_notif;
 	u8       igmp_retrans;
 #ifdef CONFIG_PROC_FS
