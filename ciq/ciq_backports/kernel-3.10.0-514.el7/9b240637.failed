perf test: Fix hists related entries

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Arnaldo Carvalho de Melo <acme@redhat.com>
commit 9b240637eb9b9677a9e9bc2dc568f5e0811e04d6
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/9b240637.failed

That got broken by d3a72fd8187b ("perf report: Fix indentation of
dynamic entries in hierarchy"), by using the evlist in setup_sorting()
without checking if it is NULL, as done in some 'perf test' entries:

  $ find tools/ -name "*.c" | xargs grep 'setup_sorting(NULL);'
  tools/perf/tests/hists_output.c:      setup_sorting(NULL);
  tools/perf/tests/hists_output.c:      setup_sorting(NULL);
  tools/perf/tests/hists_output.c:      setup_sorting(NULL);
  tools/perf/tests/hists_output.c:      setup_sorting(NULL);
  tools/perf/tests/hists_output.c:      setup_sorting(NULL);
  tools/perf/tests/hists_cumulate.c:    setup_sorting(NULL);
  tools/perf/tests/hists_cumulate.c:    setup_sorting(NULL);
  tools/perf/tests/hists_cumulate.c:    setup_sorting(NULL);
  tools/perf/tests/hists_cumulate.c:    setup_sorting(NULL);
  $

Fix it.

Before:

  [root@jouet ~]# perf test
  <SNIP>
  15: Test matching and linking multiple hists                 : FAILED!
  16: Try 'import perf' in python, checking link problems      : Ok
  17: Test breakpoint overflow signal handler                  : Ok
  18: Test breakpoint overflow sampling                        : Ok
  19: Test number of exit event of a simple workload           : Ok
  20: Test software clock events have valid period values      : Ok
  21: Test object code reading                                 : Ok
  22: Test sample parsing                                      : Ok
  23: Test using a dummy software event to keep tracking       : Ok
  24: Test parsing with no sample_id_all bit set               : Ok
  25: Test filtering hist entries                              : FAILED!
  26: Test mmap thread lookup                                  : Ok
  27: Test thread mg sharing                                   : Ok
  28: Test output sorting of hist entries                      : FAILED!
  29: Test cumulation of child hist entries                    : FAILED!
  <SNIP>

After the patch the above failed tests complete successfully.

	Acked-by: Namhyung Kim <namhyung@kernel.org>
	Cc: David Ahern <dsahern@gmail.com>
	Cc: Jiri Olsa <jolsa@kernel.org>
	Cc: Wang Nan <wangnan0@huawei.com>
Fixes: d3a72fd8187b ("perf report: Fix indentation of dynamic entries in hierarchy")
	Signed-off-by: Arnaldo Carvalho de Melo <acme@redhat.com>
(cherry picked from commit 9b240637eb9b9677a9e9bc2dc568f5e0811e04d6)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/perf/util/sort.c
diff --cc tools/perf/util/sort.c
index 8f36c1d6fd38,4380a2858802..000000000000
--- a/tools/perf/util/sort.c
+++ b/tools/perf/util/sort.c
@@@ -2316,6 -2635,29 +2316,43 @@@ out
  	return ret;
  }
  
+ static void evlist__set_hists_nr_sort_keys(struct perf_evlist *evlist)
+ {
++<<<<<<< HEAD
++	int err;
++
++	err = __setup_sorting(evlist);
++	if (err < 0)
++		return err;
++
++	if (parent_pattern != default_parent_pattern) {
++		err = sort_dimension__add("parent", evlist);
++		if (err < 0)
++			return err;
++	}
++
++=======
+ 	struct perf_evsel *evsel;
+ 
+ 	evlist__for_each(evlist, evsel) {
+ 		struct perf_hpp_fmt *fmt;
+ 		struct hists *hists = evsel__hists(evsel);
+ 
+ 		hists->nr_sort_keys = perf_hpp_list.nr_sort_keys;
+ 
+ 		/*
+ 		 * If dynamic entries were used, it might add multiple
+ 		 * entries to each evsel for a single field name.  Set
+ 		 * actual number of sort keys for each hists.
+ 		 */
+ 		perf_hpp_list__for_each_sort_list(&perf_hpp_list, fmt) {
+ 			if (perf_hpp__is_dynamic_entry(fmt) &&
+ 			    !perf_hpp__defined_dynamic_entry(fmt, hists))
+ 				hists->nr_sort_keys--;
+ 		}
+ 	}
+ }
+ 
  int setup_sorting(struct perf_evlist *evlist)
  {
  	int err;
@@@ -2330,6 -2672,9 +2367,10 @@@
  			return err;
  	}
  
+ 	if (evlist != NULL)
+ 		evlist__set_hists_nr_sort_keys(evlist);
+ 
++>>>>>>> 9b240637eb9b (perf test: Fix hists related entries)
  	reset_dimensions();
  
  	/*
* Unmerged path tools/perf/util/sort.c
