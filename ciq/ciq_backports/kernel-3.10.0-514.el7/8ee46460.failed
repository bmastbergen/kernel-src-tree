perf build: Add libcrypto feature detection

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Stephane Eranian <eranian@google.com>
commit 8ee4646038e47d065d35703e3e343136c4cd42aa
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/8ee46460.failed

Will be used to generate build-ids in the jitdump code.

	Signed-off-by: Stephane Eranian <eranian@google.com>
	Cc: Adrian Hunter <adrian.hunter@intel.com>
	Cc: Andi Kleen <ak@linux.intel.com>
	Cc: Carl Love <cel@us.ibm.com>
	Cc: David Ahern <dsahern@gmail.com>
	Cc: Jiri Olsa <jolsa@redhat.com>
	Cc: John McCutchan <johnmccutchan@google.com>
	Cc: Namhyung Kim <namhyung@kernel.org>
	Cc: Pawel Moll <pawel.moll@arm.com>
	Cc: Peter Zijlstra <peterz@infradead.org>
	Cc: Sonny Rao <sonnyrao@chromium.org>
	Cc: Sukadev Bhattiprolu <sukadev@linux.vnet.ibm.com>
Link: http://lkml.kernel.org/r/1448874143-7269-3-git-send-email-eranian@google.com
[ tools/perf/Makefile.perf comment about NO_LIBCRYPTO and added it to tests/make ]
	Signed-off-by: Arnaldo Carvalho de Melo <acme@redhat.com>
(cherry picked from commit 8ee4646038e47d065d35703e3e343136c4cd42aa)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/build/feature/Makefile
#	tools/build/feature/test-all.c
#	tools/perf/tests/make
diff --cc tools/build/feature/Makefile
index a389efb207e0,c5f4c417428d..000000000000
--- a/tools/build/feature/Makefile
+++ b/tools/build/feature/Makefile
@@@ -75,37 -79,40 +76,44 @@@ ifeq ($(findstring -static,${LDFLAGS}),
  DWARFLIBS += -lelf -lebl -lz -llzma -lbz2
  endif
  
 -$(OUTPUT)test-dwarf.bin:
 +test-dwarf.bin:
  	$(BUILD) $(DWARFLIBS)
  
 -$(OUTPUT)test-libelf-mmap.bin:
 +test-libelf-mmap.bin:
  	$(BUILD) -lelf
  
 -$(OUTPUT)test-libelf-getphdrnum.bin:
 +test-libelf-getphdrnum.bin:
  	$(BUILD) -lelf
  
 -$(OUTPUT)test-libnuma.bin:
 +test-libnuma.bin:
  	$(BUILD) -lnuma
  
 -$(OUTPUT)test-numa_num_possible_cpus.bin:
 +test-numa_num_possible_cpus.bin:
  	$(BUILD) -lnuma
  
 -$(OUTPUT)test-libunwind.bin:
 +test-libunwind.bin:
  	$(BUILD) -lelf
  
 -$(OUTPUT)test-libunwind-debug-frame.bin:
 +test-libunwind-debug-frame.bin:
  	$(BUILD) -lelf
  
 -$(OUTPUT)test-libaudit.bin:
 +test-libaudit.bin:
  	$(BUILD) -laudit
  
 -$(OUTPUT)test-libslang.bin:
 +test-libslang.bin:
  	$(BUILD) -I/usr/include/slang -lslang
  
++<<<<<<< HEAD
 +test-gtk2.bin:
++=======
+ $(OUTPUT)test-libcrypto.bin:
+ 	$(BUILD) -lcrypto
+ 
+ $(OUTPUT)test-gtk2.bin:
++>>>>>>> 8ee4646038e4 (perf build: Add libcrypto feature detection)
  	$(BUILD) $(shell $(PKG_CONFIG) --libs --cflags gtk+-2.0 2>/dev/null)
  
 -$(OUTPUT)test-gtk2-infobar.bin:
 +test-gtk2-infobar.bin:
  	$(BUILD) $(shell $(PKG_CONFIG) --libs --cflags gtk+-2.0 2>/dev/null)
  
  grep-libs  = $(filter -l%,$(1))
diff --cc tools/build/feature/test-all.c
index 272f5e2920d4,e499a36c1e4a..000000000000
--- a/tools/build/feature/test-all.c
+++ b/tools/build/feature/test-all.c
@@@ -125,6 -121,18 +125,21 @@@
  # include "test-lzma.c"
  #undef main
  
++<<<<<<< HEAD
++=======
+ #define main main_test_get_cpuid
+ # include "test-get_cpuid.c"
+ #undef main
+ 
+ #define main main_test_bpf
+ # include "test-bpf.c"
+ #undef main
+ 
+ #define main main_test_libcrypto
+ # include "test-libcrypto.c"
+ #undef main
+ 
++>>>>>>> 8ee4646038e4 (perf build: Add libcrypto feature detection)
  int main(int argc, char *argv[])
  {
  	main_test_libpython();
@@@ -152,6 -160,9 +167,12 @@@
  	main_test_zlib();
  	main_test_pthread_attr_setaffinity_np();
  	main_test_lzma();
++<<<<<<< HEAD
++=======
+ 	main_test_get_cpuid();
+ 	main_test_bpf();
+ 	main_test_libcrypto();
++>>>>>>> 8ee4646038e4 (perf build: Add libcrypto feature detection)
  
  	return 0;
  }
diff --cc tools/perf/tests/make
index fb0fc6685626,cac15d93aea6..000000000000
--- a/tools/perf/tests/make
+++ b/tools/perf/tests/make
@@@ -79,6 -79,8 +79,11 @@@ make_no_libnuma     := NO_LIBNUMA=
  make_no_libaudit    := NO_LIBAUDIT=1
  make_no_libbionic   := NO_LIBBIONIC=1
  make_no_auxtrace    := NO_AUXTRACE=1
++<<<<<<< HEAD
++=======
+ make_no_libbpf	    := NO_LIBBPF=1
+ make_no_libcrypto   := NO_LIBCRYPTO=1
++>>>>>>> 8ee4646038e4 (perf build: Add libcrypto feature detection)
  make_tags           := tags
  make_cscope         := cscope
  make_help           := help
@@@ -101,7 -103,8 +106,12 @@@ make_static         := LDFLAGS=-stati
  make_minimal        := NO_LIBPERL=1 NO_LIBPYTHON=1 NO_NEWT=1 NO_GTK2=1
  make_minimal        += NO_DEMANGLE=1 NO_LIBELF=1 NO_LIBUNWIND=1 NO_BACKTRACE=1
  make_minimal        += NO_LIBNUMA=1 NO_LIBAUDIT=1 NO_LIBBIONIC=1
++<<<<<<< HEAD
 +make_minimal        += NO_LIBDW_DWARF_UNWIND=1 NO_AUXTRACE=1
++=======
+ make_minimal        += NO_LIBDW_DWARF_UNWIND=1 NO_AUXTRACE=1 NO_LIBBPF=1
+ make_minimal        += NO_LIBCRYPTO=1
++>>>>>>> 8ee4646038e4 (perf build: Add libcrypto feature detection)
  
  # $(run) contains all available tests
  run := make_pure
diff --git a/tools/build/Makefile.feature b/tools/build/Makefile.feature
index 1b4ff2f58f17..ec7c00c97d02 100644
--- a/tools/build/Makefile.feature
+++ b/tools/build/Makefile.feature
@@ -46,6 +46,7 @@ FEATURE_TESTS_BASIC :=			\
 	libpython			\
 	libpython-version		\
 	libslang			\
+	libcrypto			\
 	libunwind			\
 	pthread-attr-setaffinity-np	\
 	stackprotector-all		\
@@ -85,6 +86,7 @@ FEATURE_DISPLAY ?=			\
 	libperl				\
 	libpython			\
 	libslang			\
+	libcrypto			\
 	libunwind			\
 	libdw-dwarf-unwind		\
 	zlib				\
* Unmerged path tools/build/feature/Makefile
* Unmerged path tools/build/feature/test-all.c
diff --git a/tools/build/feature/test-libcrypto.c b/tools/build/feature/test-libcrypto.c
new file mode 100644
index 000000000000..bd79dc7f28d3
--- /dev/null
+++ b/tools/build/feature/test-libcrypto.c
@@ -0,0 +1,17 @@
+#include <openssl/sha.h>
+#include <openssl/md5.h>
+
+int main(void)
+{
+	MD5_CTX context;
+	unsigned char md[MD5_DIGEST_LENGTH + SHA_DIGEST_LENGTH];
+	unsigned char dat[] = "12345";
+
+	MD5_Init(&context);
+	MD5_Update(&context, &dat[0], sizeof(dat));
+	MD5_Final(&md[0], &context);
+
+	SHA1(&dat[0], sizeof(dat), &md[0]);
+
+	return 0;
+}
diff --git a/tools/perf/Makefile.perf b/tools/perf/Makefile.perf
index e3084616e27f..8d36097a5030 100644
--- a/tools/perf/Makefile.perf
+++ b/tools/perf/Makefile.perf
@@ -58,6 +58,9 @@ include config/utilities.mak
 #
 # Define NO_LIBBIONIC if you do not want bionic support
 #
+# Define NO_LIBCRYPTO if you do not want libcrypto (openssl) support
+# used for generating build-ids for ELFs generated by jitdump.
+#
 # Define NO_LIBDW_DWARF_UNWIND if you do not want libdw support
 # for dwarf backtrace post unwind.
 #
diff --git a/tools/perf/config/Makefile b/tools/perf/config/Makefile
index f4664e512a9e..3c5179a3345a 100644
--- a/tools/perf/config/Makefile
+++ b/tools/perf/config/Makefile
@@ -371,6 +371,17 @@ ifndef NO_LIBAUDIT
   endif
 endif
 
+ifndef NO_LIBCRYPTO
+  ifneq ($(feature-libcrypto), 1)
+    msg := $(warning No libcrypto.h found, disables jitted code injection, please install libssl-devel or libssl-dev);
+    NO_LIBCRYPTO := 1
+  else
+    CFLAGS += -DHAVE_LIBCRYPTO_SUPPORT
+    EXTLIBS += -lcrypto
+    $(call detected,CONFIG_CRYPTO)
+  endif
+endif
+
 ifdef NO_NEWT
   NO_SLANG=1
 endif
* Unmerged path tools/perf/tests/make
