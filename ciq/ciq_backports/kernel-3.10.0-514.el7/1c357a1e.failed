dm: allocate blk_mq_tag_set rather than embed in mapped_device

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Mike Snitzer <snitzer@redhat.com>
commit 1c357a1e86a4227a6b6059f2de118ae47659cebc
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/1c357a1e.failed

The blk_mq_tag_set is only needed for dm-mq support.  There is point
wasting space in 'struct mapped_device' for non-dm-mq devices.

	Signed-off-by: Mike Snitzer <snitzer@redhat.com>
	Signed-off-by: Dan Carpenter <dan.carpenter@oracle.com> # check kzalloc return
(cherry picked from commit 1c357a1e86a4227a6b6059f2de118ae47659cebc)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/md/dm.c
diff --cc drivers/md/dm.c
index c47b968237fc,e9035959f904..000000000000
--- a/drivers/md/dm.c
+++ b/drivers/md/dm.c
@@@ -2499,32 -2386,15 +2499,40 @@@ static void free_dev(struct mapped_devi
  	int minor = MINOR(disk_devt(md->disk));
  
  	unlock_fs(md);
 +	destroy_workqueue(md->wq);
  
++<<<<<<< HEAD
 +	if (md->kworker_task)
 +		kthread_stop(md->kworker_task);
 +	if (md->io_pool)
 +		mempool_destroy(md->io_pool);
 +	if (md->rq_pool)
 +		mempool_destroy(md->rq_pool);
 +	if (md->bs)
 +		bioset_free(md->bs);
++=======
+ 	cleanup_mapped_device(md);
+ 	if (md->tag_set) {
+ 		blk_mq_free_tag_set(md->tag_set);
+ 		kfree(md->tag_set);
+ 	}
++>>>>>>> 1c357a1e86a4 (dm: allocate blk_mq_tag_set rather than embed in mapped_device)
  
 +	cleanup_srcu_struct(&md->io_barrier);
  	free_table_devices(&md->table_devices);
  	dm_stats_cleanup(&md->stats);
 +
 +	spin_lock(&_minor_lock);
 +	md->disk->private_data = NULL;
 +	spin_unlock(&_minor_lock);
 +	if (blk_get_integrity(md->disk))
 +		blk_integrity_unregister(md->disk);
 +	del_gendisk(md->disk);
 +	put_disk(md->disk);
 +	blk_cleanup_queue(md->queue);
 +	if (md->use_blk_mq)
 +		blk_mq_free_tag_set(&md->tag_set);
 +	bdput(md->bdev);
  	free_minor(minor);
  
  	module_put(THIS_MODULE);
* Unmerged path drivers/md/dm.c
