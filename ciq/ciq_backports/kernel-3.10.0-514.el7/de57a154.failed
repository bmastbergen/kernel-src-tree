USB: OHCI: make ohci-omap a separate driver

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
Rebuild_CHGLOG: - [usb] ohci: make ohci-omap a separate driver (Don Zickus) [1303209]
Rebuild_FUZZ: 93.83%
commit-author Manjunath Goudar <manjunath.goudar@linaro.org>
commit de57a1547a4865d31094de95a029fed69edf760d
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/de57a154.failed

Separate the  TI OHCI OMAP1/2 host controller driver from ohci-hcd
host code so that it can be built as a separate driver module.
This work is part of enabling multi-platform kernels on ARM.

	Signed-off-by: Manjunath Goudar <manjunath.goudar@linaro.org>
	Signed-off-by: Deepak Saxena <dsaxena@linaro.org>
	Acked-by: Alan Stern <stern@rowland.harvard.edu>
	Cc: Felipe Balbi <balbi@ti.com>
	Cc: Arnd Bergmann <arnd@arndb.de>
	Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
(cherry picked from commit de57a1547a4865d31094de95a029fed69edf760d)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/usb/host/ohci-omap.c
diff --cc drivers/usb/host/ohci-omap.c
index b1d32fb4a7ae,18b27a27e7dc..000000000000
--- a/drivers/usb/host/ohci-omap.c
+++ b/drivers/usb/host/ohci-omap.c
@@@ -188,10 -195,10 +195,10 @@@ static void start_hnp(struct ohci_hcd *
  
  /*-------------------------------------------------------------------------*/
  
- static int ohci_omap_init(struct usb_hcd *hcd)
+ static int ohci_omap_reset(struct usb_hcd *hcd)
  {
  	struct ohci_hcd		*ohci = hcd_to_ohci(hcd);
 -	struct omap_usb_config	*config = dev_get_platdata(hcd->self.controller);
 +	struct omap_usb_config	*config = hcd->self.controller->platform_data;
  	int			need_transceiver = (config->otg != 0);
  	int			ret;
  
@@@ -418,76 -413,6 +413,79 @@@ usb_hcd_omap_remove (struct usb_hcd *hc
  
  /*-------------------------------------------------------------------------*/
  
++<<<<<<< HEAD
 +static int
 +ohci_omap_start (struct usb_hcd *hcd)
 +{
 +	struct omap_usb_config *config;
 +	struct ohci_hcd	*ohci = hcd_to_ohci (hcd);
 +	int		ret;
 +
 +	if (!host_enabled)
 +		return 0;
 +	config = hcd->self.controller->platform_data;
 +	if (config->otg || config->rwc) {
 +		ohci->hc_control = OHCI_CTRL_RWC;
 +		writel(OHCI_CTRL_RWC, &ohci->regs->control);
 +	}
 +
 +	if ((ret = ohci_run (ohci)) < 0) {
 +		dev_err(hcd->self.controller, "can't start\n");
 +		ohci_stop (hcd);
 +		return ret;
 +	}
 +	return 0;
 +}
 +
 +/*-------------------------------------------------------------------------*/
 +
 +static const struct hc_driver ohci_omap_hc_driver = {
 +	.description =		hcd_name,
 +	.product_desc =		"OMAP OHCI",
 +	.hcd_priv_size =	sizeof(struct ohci_hcd),
 +
 +	/*
 +	 * generic hardware linkage
 +	 */
 +	.irq =			ohci_irq,
 +	.flags =		HCD_USB11 | HCD_MEMORY,
 +
 +	/*
 +	 * basic lifecycle operations
 +	 */
 +	.reset =		ohci_omap_init,
 +	.start =		ohci_omap_start,
 +	.stop =			ohci_omap_stop,
 +	.shutdown =		ohci_shutdown,
 +
 +	/*
 +	 * managing i/o requests and associated device resources
 +	 */
 +	.urb_enqueue =		ohci_urb_enqueue,
 +	.urb_dequeue =		ohci_urb_dequeue,
 +	.endpoint_disable =	ohci_endpoint_disable,
 +
 +	/*
 +	 * scheduling support
 +	 */
 +	.get_frame_number =	ohci_get_frame,
 +
 +	/*
 +	 * root hub support
 +	 */
 +	.hub_status_data =	ohci_hub_status_data,
 +	.hub_control =		ohci_hub_control,
 +#ifdef	CONFIG_PM
 +	.bus_suspend =		ohci_bus_suspend,
 +	.bus_resume =		ohci_bus_resume,
 +#endif
 +	.start_port_reset =	ohci_start_port_reset,
 +};
 +
 +/*-------------------------------------------------------------------------*/
 +
++=======
++>>>>>>> de57a1547a48 (USB: OHCI: make ohci-omap a separate driver)
  static int ohci_hcd_omap_drv_probe(struct platform_device *dev)
  {
  	return usb_hcd_omap_probe(&ohci_omap_hc_driver, dev);
diff --git a/drivers/usb/host/Kconfig b/drivers/usb/host/Kconfig
index 14e3c49416bf..1a41e24ce57b 100644
--- a/drivers/usb/host/Kconfig
+++ b/drivers/usb/host/Kconfig
@@ -373,7 +373,7 @@ config USB_OHCI_HCD
 if USB_OHCI_HCD
 
 config USB_OHCI_HCD_OMAP1
-	bool "OHCI support for OMAP1/2 chips"
+	tristate "OHCI support for OMAP1/2 chips"
 	depends on ARCH_OMAP1
 	default y
 	---help---
diff --git a/drivers/usb/host/Makefile b/drivers/usb/host/Makefile
index 602b80e40777..a6ed253fa004 100644
--- a/drivers/usb/host/Makefile
+++ b/drivers/usb/host/Makefile
@@ -44,6 +44,7 @@ obj-$(CONFIG_USB_OHCI_HCD)	+= ohci-hcd.o
 obj-$(CONFIG_USB_OHCI_HCD_PCI)	+= ohci-pci.o
 obj-$(CONFIG_USB_OHCI_HCD_PLATFORM)	+= ohci-platform.o
 obj-$(CONFIG_USB_OHCI_EXYNOS)	+= ohci-exynos.o
+obj-$(CONFIG_USB_OHCI_HCD_OMAP1)	+= ohci-omap.o
 
 obj-$(CONFIG_USB_UHCI_HCD)	+= uhci-hcd.o
 obj-$(CONFIG_USB_FHCI_HCD)	+= fhci.o
diff --git a/drivers/usb/host/ohci-hcd.c b/drivers/usb/host/ohci-hcd.c
index 31d50d19b73d..fbef0179233a 100644
--- a/drivers/usb/host/ohci-hcd.c
+++ b/drivers/usb/host/ohci-hcd.c
@@ -1217,11 +1217,6 @@ MODULE_LICENSE ("GPL");
 #define S3C2410_PLATFORM_DRIVER	ohci_hcd_s3c2410_driver
 #endif
 
-#ifdef CONFIG_USB_OHCI_HCD_OMAP1
-#include "ohci-omap.c"
-#define OMAP1_PLATFORM_DRIVER	ohci_hcd_omap_driver
-#endif
-
 #ifdef CONFIG_USB_OHCI_HCD_OMAP3
 #include "ohci-omap3.c"
 #define OMAP3_PLATFORM_DRIVER	ohci_hcd_omap3_driver
@@ -1322,12 +1317,6 @@ static int __init ohci_hcd_mod_init(void)
 		goto error_platform;
 #endif
 
-#ifdef OMAP1_PLATFORM_DRIVER
-	retval = platform_driver_register(&OMAP1_PLATFORM_DRIVER);
-	if (retval < 0)
-		goto error_omap1_platform;
-#endif
-
 #ifdef OMAP3_PLATFORM_DRIVER
 	retval = platform_driver_register(&OMAP3_PLATFORM_DRIVER);
 	if (retval < 0)
@@ -1441,10 +1430,6 @@ static int __init ohci_hcd_mod_init(void)
 	platform_driver_unregister(&OMAP3_PLATFORM_DRIVER);
  error_omap3_platform:
 #endif
-#ifdef OMAP1_PLATFORM_DRIVER
-	platform_driver_unregister(&OMAP1_PLATFORM_DRIVER);
- error_omap1_platform:
-#endif
 #ifdef PLATFORM_DRIVER
 	platform_driver_unregister(&PLATFORM_DRIVER);
  error_platform:
@@ -1497,9 +1482,6 @@ static void __exit ohci_hcd_mod_exit(void)
 #ifdef OMAP3_PLATFORM_DRIVER
 	platform_driver_unregister(&OMAP3_PLATFORM_DRIVER);
 #endif
-#ifdef OMAP1_PLATFORM_DRIVER
-	platform_driver_unregister(&OMAP1_PLATFORM_DRIVER);
-#endif
 #ifdef PLATFORM_DRIVER
 	platform_driver_unregister(&PLATFORM_DRIVER);
 #endif
* Unmerged path drivers/usb/host/ohci-omap.c
