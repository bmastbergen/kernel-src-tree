IB/srp: Avoid that mapping failure triggers an infinite loop

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Bart Van Assche <bart.vanassche@sandisk.com>
commit ffc548bb3601f0250474afcfa10ceb0b8b8b9764
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/ffc548bb.failed

The srp_queuecommand() function translates ENOMEM into QUEUE_FULL
which causes the SCSI mid-layer to retry the command. All other
error codes are translated into DID_ERROR which causes the SCSI
command to fail. Return E2BIG if mapping will always fail to
prevent that the SCSI mid-layer keeps resubmitting a command
forever.

	Signed-off-by: Bart Van Assche <bart.vanassche@sandisk.com>
	Cc: Christoph Hellwig <hch@lst.de>
	Cc: Sagi Grimberg <sagi@grimberg.me>
	Cc: Laurence Oberman <loberman@redhat.com>
	Reviewed-by: Christoph Hellwig <hch@lst.de>
	Signed-off-by: Doug Ledford <dledford@redhat.com>
(cherry picked from commit ffc548bb3601f0250474afcfa10ceb0b8b8b9764)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/ulp/srp/ib_srp.c
diff --cc drivers/infiniband/ulp/srp/ib_srp.c
index 6673c6f5b7ae,fbd2edbedf05..000000000000
--- a/drivers/infiniband/ulp/srp/ib_srp.c
+++ b/drivers/infiniband/ulp/srp/ib_srp.c
@@@ -1645,6 -1678,12 +1645,15 @@@ map_complete
  		cmd->buf_fmt = fmt;
  
  	return len;
++<<<<<<< HEAD
++=======
+ 
+ unmap:
+ 	srp_unmap_data(scmnd, ch, req);
+ 	if (ret == -ENOMEM && req->nmdesc >= target->mr_pool_size)
+ 		ret = -E2BIG;
+ 	return ret;
++>>>>>>> ffc548bb3601 (IB/srp: Avoid that mapping failure triggers an infinite loop)
  }
  
  /*
* Unmerged path drivers/infiniband/ulp/srp/ib_srp.c
