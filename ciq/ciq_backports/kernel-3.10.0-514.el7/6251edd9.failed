netlink: Properly unbind in error conditions.

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
Rebuild_CHGLOG: - [net] netlink: Properly unbind in error conditions (Phil Sutter) [1238749]
Rebuild_FUZZ: 98.88%
commit-author Hiroaki SHIMODA <shimoda.hiroaki@gmail.com>
commit 6251edd932ce3faadbfe27b0a0fe79780e0972e9
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/6251edd9.failed

Even if netlink_kernel_cfg::unbind is implemented the unbind() method is
not called, because cfg->unbind is omitted in __netlink_kernel_create().
And fix wrong argument of test_bit() and off by one problem.

At this point, no unbind() method is implemented, so there is no real
issue.

Fixes: 4f520900522f ("netlink: have netlink per-protocol bind function return an error code.")
	Signed-off-by: Hiroaki SHIMODA <shimoda.hiroaki@gmail.com>
	Cc: Richard Guy Briggs <rgb@redhat.com>
	Acked-by: Richard Guy Briggs <rgb@redhat.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 6251edd932ce3faadbfe27b0a0fe79780e0972e9)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/netlink/af_netlink.c
diff --cc net/netlink/af_netlink.c
index 8c03375d5550,0007b8180397..000000000000
--- a/net/netlink/af_netlink.c
+++ b/net/netlink/af_netlink.c
@@@ -1437,6 -1431,19 +1437,22 @@@ static int netlink_realloc_groups(struc
  	return err;
  }
  
++<<<<<<< HEAD
++=======
+ static void netlink_unbind(int group, long unsigned int groups,
+ 			   struct netlink_sock *nlk)
+ {
+ 	int undo;
+ 
+ 	if (!nlk->netlink_unbind)
+ 		return;
+ 
+ 	for (undo = 0; undo < group; undo++)
+ 		if (test_bit(undo, &groups))
+ 			nlk->netlink_unbind(undo);
+ }
+ 
++>>>>>>> 6251edd932ce (netlink: Properly unbind in error conditions.)
  static int netlink_bind(struct socket *sock, struct sockaddr *addr,
  			int addr_len)
  {
@@@ -1468,11 -1491,13 +1484,16 @@@
  		err = nladdr->nl_pid ?
  			netlink_insert(sk, net, nladdr->nl_pid) :
  			netlink_autobind(sock);
++<<<<<<< HEAD
 +		if (err)
++=======
+ 		if (err) {
+ 			netlink_unbind(nlk->ngroups, groups, nlk);
++>>>>>>> 6251edd932ce (netlink: Properly unbind in error conditions.)
  			return err;
 -		}
  	}
  
 -	if (!groups && (nlk->groups == NULL || !(u32)nlk->groups[0]))
 +	if (!nladdr->nl_groups && (nlk->groups == NULL || !(u32)nlk->groups[0]))
  		return 0;
  
  	netlink_table_grab();
* Unmerged path net/netlink/af_netlink.c
