ipv6: Check rt->dst.from for the DST_NOCACHE route

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Martin KaFai Lau <kafai@fb.com>
commit 02bcf4e082e4dc634409a6a6cb7def8806d6e5e6
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/02bcf4e0.failed

All DST_NOCACHE rt6_info used to have rt->dst.from set to
its parent.

After commit 8e3d5be73681 ("ipv6: Avoid double dst_free"),
DST_NOCACHE is also set to rt6_info which does not have
a parent (i.e. rt->dst.from is NULL).

This patch catches the rt->dst.from == NULL case.

Fixes: 8e3d5be73681 ("ipv6: Avoid double dst_free")
	Signed-off-by: Martin KaFai Lau <kafai@fb.com>
	Cc: Hannes Frederic Sowa <hannes@stressinduktion.org>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 02bcf4e082e4dc634409a6a6cb7def8806d6e5e6)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	include/net/ip6_fib.h
#	net/ipv6/route.c
diff --cc include/net/ip6_fib.h
index d152e230d58f,fb961a576abe..000000000000
--- a/include/net/ip6_fib.h
+++ b/include/net/ip6_fib.h
@@@ -165,13 -165,13 +165,19 @@@ static inline void rt6_update_expires(s
  	rt0->rt6i_flags |= RTF_EXPIRES;
  }
  
 -static inline u32 rt6_get_cookie(const struct rt6_info *rt)
 +static inline void rt6_set_from(struct rt6_info *rt, struct rt6_info *from)
  {
++<<<<<<< HEAD
 +	struct dst_entry *new = (struct dst_entry *) from;
++=======
+ 	if (rt->rt6i_flags & RTF_PCPU ||
+ 	    (unlikely(rt->dst.flags & DST_NOCACHE) && rt->dst.from))
+ 		rt = (struct rt6_info *)(rt->dst.from);
++>>>>>>> 02bcf4e082e4 (ipv6: Check rt->dst.from for the DST_NOCACHE route)
  
 -	return rt->rt6i_node ? rt->rt6i_node->fn_sernum : 0;
 +	rt->rt6i_flags &= ~RTF_EXPIRES;
 +	dst_hold(new);
 +	rt->dst.from = new;
  }
  
  static inline void ip6_rt_put(struct rt6_info *rt)
diff --cc net/ipv6/route.c
index 403fb7ab35ee,6f01fe122abd..000000000000
--- a/net/ipv6/route.c
+++ b/net/ipv6/route.c
@@@ -1098,13 -1278,14 +1098,21 @@@ static struct dst_entry *ip6_dst_check(
  	 * DST_OBSOLETE_FORCE_CHK which forces validation calls down
  	 * into this function always.
  	 */
 +	if (!rt->rt6i_node || (rt->rt6i_node->fn_sernum != cookie))
 +		return NULL;
  
 -	rt6_dst_from_metrics_check(rt);
 +	if (rt6_check_expired(rt))
 +		return NULL;
  
++<<<<<<< HEAD
 +	return dst;
++=======
+ 	if (rt->rt6i_flags & RTF_PCPU ||
+ 	    (unlikely(dst->flags & DST_NOCACHE) && rt->dst.from))
+ 		return rt6_dst_from_check(rt, cookie);
+ 	else
+ 		return rt6_check(rt, cookie);
++>>>>>>> 02bcf4e082e4 (ipv6: Check rt->dst.from for the DST_NOCACHE route)
  }
  
  static struct dst_entry *ip6_negative_advice(struct dst_entry *dst)
* Unmerged path include/net/ip6_fib.h
* Unmerged path net/ipv6/route.c
