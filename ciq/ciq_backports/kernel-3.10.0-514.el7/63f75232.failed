mei: hbm: reorganize the power gating responses

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Alexander Usyskin <alexander.usyskin@intel.com>
commit 63f75232dbb17badc31c3cc6cc1434763d5a6009
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/63f75232.failed

Before adding support for D0i3 we need to reorganize the hbm pg handling
Move HBM PG response code to dedicated functions in order to unclutter
hbm command switch.
Add check for the right system state before message processing and
return -EPROTO in state mismatch case.

	Signed-off-by: Alexander Usyskin <alexander.usyskin@intel.com>
	Signed-off-by: Tomas Winkler <tomas.winkler@intel.com>
	Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
(cherry picked from commit 63f75232dbb17badc31c3cc6cc1434763d5a6009)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/misc/mei/hbm.c
diff --cc drivers/misc/mei/hbm.c
index 3cb8e1000d69,21f40ce87ac8..000000000000
--- a/drivers/misc/mei/hbm.c
+++ b/drivers/misc/mei/hbm.c
@@@ -658,7 -880,69 +658,73 @@@ static int mei_hbm_fw_disconnect_req(st
  }
  
  /**
++<<<<<<< HEAD
 + * mei_hbm_config_features: check what hbm features and commands
++=======
+  * mei_hbm_pg_enter_res - PG enter response received
+  *
+  * @dev: the device structure.
+  *
+  * Return: 0 on success, -EPROTO on state mismatch
+  */
+ static int mei_hbm_pg_enter_res(struct mei_device *dev)
+ {
+ 	if (mei_pg_state(dev) != MEI_PG_OFF ||
+ 	    dev->pg_event != MEI_PG_EVENT_WAIT) {
+ 		dev_err(dev->dev, "hbm: pg entry response: state mismatch [%s, %d]\n",
+ 			mei_pg_state_str(mei_pg_state(dev)), dev->pg_event);
+ 		return -EPROTO;
+ 	}
+ 
+ 	dev->pg_event = MEI_PG_EVENT_RECEIVED;
+ 	wake_up(&dev->wait_pg);
+ 
+ 	return 0;
+ }
+ 
+ /**
+  * mei_hbm_pg_exit_res - PG exit response received
+  *
+  * @dev: the device structure.
+  *
+  * Return: 0 on success, -EPROTO on state mismatch
+  */
+ static int mei_hbm_pg_exit_res(struct mei_device *dev)
+ {
+ 	if (mei_pg_state(dev) != MEI_PG_ON ||
+ 	    (dev->pg_event != MEI_PG_EVENT_WAIT &&
+ 	     dev->pg_event != MEI_PG_EVENT_IDLE)) {
+ 		dev_err(dev->dev, "hbm: pg exit response: state mismatch [%s, %d]\n",
+ 			mei_pg_state_str(mei_pg_state(dev)), dev->pg_event);
+ 		return -EPROTO;
+ 	}
+ 
+ 	switch (dev->pg_event) {
+ 	case MEI_PG_EVENT_WAIT:
+ 		dev->pg_event = MEI_PG_EVENT_RECEIVED;
+ 		wake_up(&dev->wait_pg);
+ 		break;
+ 	case MEI_PG_EVENT_IDLE:
+ 		/*
+ 		* If the driver is not waiting on this then
+ 		* this is HW initiated exit from PG.
+ 		* Start runtime pm resume sequence to exit from PG.
+ 		*/
+ 		dev->pg_event = MEI_PG_EVENT_RECEIVED;
+ 		pm_request_resume(dev->dev);
+ 		break;
+ 	default:
+ 		WARN(1, "hbm: pg exit response: unexpected pg event = %d\n",
+ 		     dev->pg_event);
+ 		return -EPROTO;
+ 	}
+ 
+ 	return 0;
+ }
+ 
+ /**
+  * mei_hbm_config_features - check what hbm features and commands
++>>>>>>> 63f75232dbb1 (mei: hbm: reorganize the power gating responses)
   *        are supported by the fw
   *
   * @dev: the device structure
@@@ -793,17 -1089,17 +859,31 @@@ int mei_hbm_dispatch(struct mei_device 
  		break;
  
  	case MEI_PG_ISOLATION_ENTRY_RES_CMD:
++<<<<<<< HEAD
 +		dev_dbg(&dev->pdev->dev, "power gate isolation entry response received\n");
 +		dev->pg_event = MEI_PG_EVENT_RECEIVED;
 +		if (waitqueue_active(&dev->wait_pg))
 +			wake_up(&dev->wait_pg);
 +		break;
 +
 +	case MEI_PG_ISOLATION_EXIT_REQ_CMD:
 +		dev_dbg(&dev->pdev->dev, "power gate isolation exit request received\n");
 +		dev->pg_event = MEI_PG_EVENT_RECEIVED;
 +		if (waitqueue_active(&dev->wait_pg))
 +			wake_up(&dev->wait_pg);
++=======
+ 		dev_dbg(dev->dev, "hbm: power gate isolation entry response received\n");
+ 		ret = mei_hbm_pg_enter_res(dev);
+ 		if (ret)
+ 			return ret;
+ 		break;
+ 
+ 	case MEI_PG_ISOLATION_EXIT_REQ_CMD:
+ 		dev_dbg(dev->dev, "hbm: power gate isolation exit request received\n");
+ 		ret = mei_hbm_pg_exit_res(dev);
+ 		if (ret)
+ 			return ret;
++>>>>>>> 63f75232dbb1 (mei: hbm: reorganize the power gating responses)
  		break;
  
  	case HOST_CLIENT_PROPERTIES_RES_CMD:
* Unmerged path drivers/misc/mei/hbm.c
