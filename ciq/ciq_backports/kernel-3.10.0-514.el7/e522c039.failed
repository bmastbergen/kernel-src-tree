dm: cleanup dm_any_congested()

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Mike Snitzer <snitzer@redhat.com>
commit e522c039059b0fdf5ecd15d7007026326fffc9be
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/e522c039.failed

The request-based DM support for checking queue congestion doesn't
require access to the live DM table.

	Signed-off-by: Mike Snitzer <snitzer@redhat.com>
(cherry picked from commit e522c039059b0fdf5ecd15d7007026326fffc9be)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/md/dm.c
diff --cc drivers/md/dm.c
index 6df526d0d485,d605170a02d9..000000000000
--- a/drivers/md/dm.c
+++ b/drivers/md/dm.c
@@@ -2272,19 -2137,18 +2272,25 @@@ static int dm_any_congested(void *conge
  	struct dm_table *map;
  
  	if (!test_bit(DMF_BLOCK_IO_FOR_SUSPEND, &md->flags)) {
- 		map = dm_get_live_table_fast(md);
- 		if (map) {
+ 		if (dm_request_based(md)) {
  			/*
- 			 * Request-based dm cares about only own queue for
- 			 * the query about congestion status of request_queue
+ 			 * With request-based DM we only need to check the
+ 			 * top-level queue for congestion.
  			 */
++<<<<<<< HEAD
 +			if (dm_request_based(md))
 +				r = md->queue->backing_dev_info.state &
 +				    bdi_bits;
 +			else
++=======
+ 			r = md->queue->backing_dev_info.wb.state & bdi_bits;
+ 		} else {
+ 			map = dm_get_live_table_fast(md);
+ 			if (map)
++>>>>>>> e522c039059b (dm: cleanup dm_any_congested())
  				r = dm_table_any_congested(map, bdi_bits);
+ 			dm_put_live_table_fast(md);
  		}
- 		dm_put_live_table_fast(md);
  	}
  
  	return r;
* Unmerged path drivers/md/dm.c
