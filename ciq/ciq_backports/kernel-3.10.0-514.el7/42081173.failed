mpt3sas: Manage MSI-X vectors according to HBA device type

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Sreekanth Reddy <sreekanth.reddy@avagotech.com>
commit 42081173c74e0867b996f5fd6b46d3c1606377c7
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/42081173.failed

1. Do not enable MSI-X vectors for SAS2008 B0 controllers

2. Enable a single MSI-X vector for the following controller:

   a. SAS2004
   b. SAS2008
   c. SAS2008_1
   d. SAS2008_2
   e. SAS2008_3
   f. SAS2116_1
   g. SAS2116_2

3. Enable Combined Reply Post Queue Support (i.e. 96 MSI-X vectors)
   for Gen3 Invader/Fury C0 and above revision HBAs

4. Enable Combined Reply Post Queue Support (i.e. 96 MSI-X vectors)
   for all Intruder and Cutlass HBAs

	Signed-off-by: Sreekanth Reddy <Sreekanth.Reddy@avagotech.com>
	Acked-by: Christoph Hellwig <hch@lst.de>
	Reviewed-by: Hannes Reinecke <hare@suse.de>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit 42081173c74e0867b996f5fd6b46d3c1606377c7)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/mpt3sas/mpt3sas_scsih.c
diff --cc drivers/scsi/mpt3sas/mpt3sas_scsih.c
index dab4affe7dc9,2b51a414a380..000000000000
--- a/drivers/scsi/mpt3sas/mpt3sas_scsih.c
+++ b/drivers/scsi/mpt3sas/mpt3sas_scsih.c
@@@ -8032,8 -7909,48 +8032,51 @@@ _scsih_scan_finished(struct Scsi_Host *
  	return 1;
  }
  
++<<<<<<< HEAD
++=======
+ void
+ _scsih_determine_hba_mpi_version(struct MPT3SAS_ADAPTER *ioc) {
+ 
+ 	switch (ioc->pdev->device) {
+ 	case MPI2_MFGPAGE_DEVID_SAS2004:
+ 	case MPI2_MFGPAGE_DEVID_SAS2008:
+ 	case MPI2_MFGPAGE_DEVID_SAS2108_1:
+ 	case MPI2_MFGPAGE_DEVID_SAS2108_2:
+ 	case MPI2_MFGPAGE_DEVID_SAS2108_3:
+ 	case MPI2_MFGPAGE_DEVID_SAS2116_1:
+ 	case MPI2_MFGPAGE_DEVID_SAS2116_2:
+ 	case MPI2_MFGPAGE_DEVID_SAS2208_1:
+ 	case MPI2_MFGPAGE_DEVID_SAS2208_2:
+ 	case MPI2_MFGPAGE_DEVID_SAS2208_3:
+ 	case MPI2_MFGPAGE_DEVID_SAS2208_4:
+ 	case MPI2_MFGPAGE_DEVID_SAS2208_5:
+ 	case MPI2_MFGPAGE_DEVID_SAS2208_6:
+ 	case MPI2_MFGPAGE_DEVID_SAS2308_1:
+ 	case MPI2_MFGPAGE_DEVID_SAS2308_2:
+ 	case MPI2_MFGPAGE_DEVID_SAS2308_3:
+ 		ioc->hba_mpi_version_belonged = MPI2_VERSION;
+ 		break;
+ 	case MPI25_MFGPAGE_DEVID_SAS3004:
+ 	case MPI25_MFGPAGE_DEVID_SAS3008:
+ 	case MPI25_MFGPAGE_DEVID_SAS3108_1:
+ 	case MPI25_MFGPAGE_DEVID_SAS3108_2:
+ 	case MPI25_MFGPAGE_DEVID_SAS3108_5:
+ 	case MPI25_MFGPAGE_DEVID_SAS3108_6:
+ 		ioc->hba_mpi_version_belonged = MPI25_VERSION;
+ 
+ 		/* Check whether the controller revision is C0 or above.
+ 		 * only C0 and above revision controllers support 96 MSI-X
+ 		 * vectors.
+ 		 */
+ 		if (ioc->pdev->revision >= SAS3_PCI_DEVICE_C0_REVISION)
+ 			ioc->msix96_vector = 1;
+ 		break;
+ 	}
+ }
+ 
++>>>>>>> 42081173c74e (mpt3sas: Manage MSI-X vectors according to HBA device type)
  /**
 - * scsih_probe - attach and add scsi host
 + * _scsih_probe - attach and add scsi host
   * @pdev: PCI device struct
   * @id: pci device id
   *
diff --git a/drivers/scsi/mpt3sas/mpt3sas_base.c b/drivers/scsi/mpt3sas/mpt3sas_base.c
index 7026d896bea7..730322d5d95d 100644
--- a/drivers/scsi/mpt3sas/mpt3sas_base.c
+++ b/drivers/scsi/mpt3sas/mpt3sas_base.c
@@ -1712,6 +1712,14 @@ _base_check_enable_msix(struct MPT3SAS_ADAPTER *ioc)
 	int base;
 	u16 message_control;
 
+	/* Check whether controller SAS2008 B0 controller,
+	 * if it is SAS2008 B0 controller use IO-APIC instead of MSIX
+	 */
+	if (ioc->pdev->device == MPI2_MFGPAGE_DEVID_SAS2008 &&
+	    ioc->pdev->revision == SAS2_PCI_DEVICE_B0_REVISION) {
+		return -EINVAL;
+	}
+
 	base = pci_find_capability(ioc->pdev, PCI_CAP_ID_MSIX);
 	if (!base) {
 		dfailprintk(ioc, pr_info(MPT3SAS_FMT "msix not supported\n",
@@ -1720,9 +1728,19 @@ _base_check_enable_msix(struct MPT3SAS_ADAPTER *ioc)
 	}
 
 	/* get msix vector count */
-
-	pci_read_config_word(ioc->pdev, base + 2, &message_control);
-	ioc->msix_vector_count = (message_control & 0x3FF) + 1;
+	/* NUMA_IO not supported for older controllers */
+	if (ioc->pdev->device == MPI2_MFGPAGE_DEVID_SAS2004 ||
+	    ioc->pdev->device == MPI2_MFGPAGE_DEVID_SAS2008 ||
+	    ioc->pdev->device == MPI2_MFGPAGE_DEVID_SAS2108_1 ||
+	    ioc->pdev->device == MPI2_MFGPAGE_DEVID_SAS2108_2 ||
+	    ioc->pdev->device == MPI2_MFGPAGE_DEVID_SAS2108_3 ||
+	    ioc->pdev->device == MPI2_MFGPAGE_DEVID_SAS2116_1 ||
+	    ioc->pdev->device == MPI2_MFGPAGE_DEVID_SAS2116_2)
+		ioc->msix_vector_count = 1;
+	else {
+		pci_read_config_word(ioc->pdev, base + 2, &message_control);
+		ioc->msix_vector_count = (message_control & 0x3FF) + 1;
+	}
 	dinitprintk(ioc, pr_info(MPT3SAS_FMT
 		"msix is supported, vector_count(%d)\n",
 		ioc->name, ioc->msix_vector_count));
@@ -4981,7 +4999,6 @@ mpt3sas_base_attach(struct MPT3SAS_ADAPTER *ioc)
 {
 	int r, i;
 	int cpu_id, last_cpu_id = 0;
-	u8 revision;
 
 	dinitprintk(ioc, pr_info(MPT3SAS_FMT "%s\n", ioc->name,
 	    __func__));
@@ -5001,20 +5018,6 @@ mpt3sas_base_attach(struct MPT3SAS_ADAPTER *ioc)
 		goto out_free_resources;
 	}
 
-	/* Check whether the controller revision is C0 or above.
-	 * only C0 and above revision controllers support 96 MSI-X vectors.
-	 */
-	revision = ioc->pdev->revision;
-
-	if ((ioc->pdev->device == MPI25_MFGPAGE_DEVID_SAS3004 ||
-	     ioc->pdev->device == MPI25_MFGPAGE_DEVID_SAS3008 ||
-	     ioc->pdev->device == MPI25_MFGPAGE_DEVID_SAS3108_1 ||
-	     ioc->pdev->device == MPI25_MFGPAGE_DEVID_SAS3108_2 ||
-	     ioc->pdev->device == MPI25_MFGPAGE_DEVID_SAS3108_5 ||
-	     ioc->pdev->device == MPI25_MFGPAGE_DEVID_SAS3108_6) &&
-	     (revision >= 0x02))
-		ioc->msix96_vector = 1;
-
 	ioc->rdpq_array_enable_assigned = 0;
 	ioc->dma_mask = 0;
 	r = mpt3sas_base_map_resources(ioc);
diff --git a/drivers/scsi/mpt3sas/mpt3sas_base.h b/drivers/scsi/mpt3sas/mpt3sas_base.h
index 4a187ecbb856..8774d598fc29 100644
--- a/drivers/scsi/mpt3sas/mpt3sas_base.h
+++ b/drivers/scsi/mpt3sas/mpt3sas_base.h
@@ -131,6 +131,9 @@
 #define MPT_TARGET_FLAGS_DELETED	0x04
 #define MPT_TARGET_FASTPATH_IO		0x08
 
+#define SAS2_PCI_DEVICE_B0_REVISION	(0x01)
+#define SAS3_PCI_DEVICE_C0_REVISION	(0x02)
+
 /*
  * Intel HBA branding
  */
* Unmerged path drivers/scsi/mpt3sas/mpt3sas_scsih.c
