IB/isert: Support the remote invalidation exception

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Jenny Derzhavetz <jennyf@mellanox.com>
commit 422bd0acb062cd0c14f2af61db76c4f598903ad3
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/422bd0ac.failed

We'll use remote invalidate, according to negotiation result
during connection establishment. If the initiator declared that
it supports the remote invalidate exception and the local HCA
supports IB_DEVICE_MEM_MGT_EXTENSIONS then the target will
use IB_WR_SEND_WITH_INV with the correct rkey for the response.

	Signed-off-by: Jenny Derzhavetz <jennyf@mellanox.com>
	Signed-off-by: Sagi Grimberg <sagig@mellanox.com>
	Reviewed-by: Christoph Hellwig <hch@lst.de>
	Signed-off-by: Doug Ledford <dledford@redhat.com>
(cherry picked from commit 422bd0acb062cd0c14f2af61db76c4f598903ad3)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/ulp/isert/ib_isert.c
diff --cc drivers/infiniband/ulp/isert/ib_isert.c
index e93d0806eae9,abb3124f89bb..000000000000
--- a/drivers/infiniband/ulp/isert/ib_isert.c
+++ b/drivers/infiniband/ulp/isert/ib_isert.c
@@@ -740,11 -717,7 +766,15 @@@ isert_connect_request(struct rdma_cm_i
  	}
  	isert_conn->device = device;
  
++<<<<<<< HEAD
 +	/* Set max inflight RDMA READ requests */
 +	isert_conn->initiator_depth = min_t(u8,
 +				event->param.conn.initiator_depth,
 +				device->dev_attr.max_qp_init_rd_atom);
 +	isert_dbg("Using initiator_depth: %u\n", isert_conn->initiator_depth);
++=======
+ 	isert_set_nego_params(isert_conn, &event->param.conn);
++>>>>>>> 422bd0acb062 (IB/isert: Support the remote invalidation exception)
  
  	ret = isert_conn_setup_qp(isert_conn, cma_id);
  	if (ret)
* Unmerged path drivers/infiniband/ulp/isert/ib_isert.c
diff --git a/drivers/infiniband/ulp/isert/ib_isert.h b/drivers/infiniband/ulp/isert/ib_isert.h
index 6f7db3ebfd35..91dc3732bbbf 100644
--- a/drivers/infiniband/ulp/isert/ib_isert.h
+++ b/drivers/infiniband/ulp/isert/ib_isert.h
@@ -131,6 +131,7 @@ struct isert_cmd {
 	uint32_t		write_stag;
 	uint64_t		read_va;
 	uint64_t		write_va;
+	uint32_t		inv_rkey;
 	u64			pdu_buf_dma;
 	u32			pdu_buf_len;
 	struct isert_conn	*conn;
@@ -178,6 +179,7 @@ struct isert_conn {
 	struct work_struct	release_work;
 	struct ib_recv_wr       beacon;
 	bool                    logout_posted;
+	bool                    snd_w_inv;
 };
 
 #define ISERT_MAX_CQ 64
