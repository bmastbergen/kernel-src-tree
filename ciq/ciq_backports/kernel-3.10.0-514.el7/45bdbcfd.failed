kvm: x86: Fix vmwrite to SECONDARY_VM_EXEC_CONTROL

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Huaitong Han <huaitong.han@intel.com>
commit 45bdbcfdf241149642fb6c25ab0c209d59c371b7
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/45bdbcfd.failed

vmx_cpuid_tries to update SECONDARY_VM_EXEC_CONTROL in the VMCS, but
it will cause a vmwrite error on older CPUs because the code does not
check for the presence of CPU_BASED_ACTIVATE_SECONDARY_CONTROLS.

This will get rid of the following trace on e.g. Core2 6600:

vmwrite error: reg 401e value 10 (err 12)
Call Trace:
[<ffffffff8116e2b9>] dump_stack+0x40/0x57
[<ffffffffa020b88d>] vmx_cpuid_update+0x5d/0x150 [kvm_intel]
[<ffffffffa01d8fdc>] kvm_vcpu_ioctl_set_cpuid2+0x4c/0x70 [kvm]
[<ffffffffa01b8363>] kvm_arch_vcpu_ioctl+0x903/0xfa0 [kvm]

Fixes: feda805fe7c4ed9cf78158e73b1218752e3b4314
	Cc: stable@vger.kernel.org
	Reported-by: Zdenek Kaspar <zkaspar82@gmail.com>
	Signed-off-by: Huaitong Han <huaitong.han@intel.com>
	Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
(cherry picked from commit 45bdbcfdf241149642fb6c25ab0c209d59c371b7)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kvm/vmx.c
diff --cc arch/x86/kvm/vmx.c
index 7895c6014c3f,be3f1735d5eb..000000000000
--- a/arch/x86/kvm/vmx.c
+++ b/arch/x86/kvm/vmx.c
@@@ -8449,6 -8988,18 +8449,21 @@@ static void vmx_cpuid_update(struct kvm
  		if (best)
  			best->ebx &= ~bit(X86_FEATURE_INVPCID);
  	}
++<<<<<<< HEAD
++=======
+ 
+ 	if (cpu_has_secondary_exec_ctrls())
+ 		vmcs_set_secondary_exec_control(secondary_exec_ctl);
+ 
+ 	if (static_cpu_has(X86_FEATURE_PCOMMIT) && nested) {
+ 		if (guest_cpuid_has_pcommit(vcpu))
+ 			vmx->nested.nested_vmx_secondary_ctls_high |=
+ 				SECONDARY_EXEC_PCOMMIT;
+ 		else
+ 			vmx->nested.nested_vmx_secondary_ctls_high &=
+ 				~SECONDARY_EXEC_PCOMMIT;
+ 	}
++>>>>>>> 45bdbcfdf241 (kvm: x86: Fix vmwrite to SECONDARY_VM_EXEC_CONTROL)
  }
  
  static void vmx_set_supported_cpuid(u32 func, struct kvm_cpuid_entry2 *entry)
* Unmerged path arch/x86/kvm/vmx.c
