sctp: only drop the reference on the datamsg after sending a msg

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author lucien <lucien.xin@gmail.com>
commit 8b570dc9f7b634e853866ce40097c0342ac5bb81
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/8b570dc9.failed

If the chunks are enqueued successfully but sctp_cmd_interpreter()
return err to sctp_sendmsg() (mainly because of no mem), the chunks will
get re-queued, but we are dropping the reference and freeing them.

The fix is to just drop the reference on the datamsg just as it had
succeeded, as:
 - if the chunks weren't queued, this is enough to get them freed.
 - if they were queued, they will get freed when they finally get out or
 discarded.

	Signed-off-by: Xin Long <lucien.xin@gmail.com>
Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
	Signed-off-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 8b570dc9f7b634e853866ce40097c0342ac5bb81)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/sctp/socket.c
diff --cc net/sctp/socket.c
index 4d933703d9dc,9b6cc6de80d8..000000000000
--- a/net/sctp/socket.c
+++ b/net/sctp/socket.c
@@@ -1965,18 -1964,19 +1965,32 @@@ SCTP_STATIC int sctp_sendmsg(struct kio
  	 * breaks.
  	 */
  	err = sctp_primitive_SEND(net, asoc, datamsg);
+ 	sctp_datamsg_put(datamsg);
  	/* Did the lower layer accept the chunk? */
 +	if (err)
++<<<<<<< HEAD
 +		sctp_datamsg_free(datamsg);
 +	else
 +		sctp_datamsg_put(datamsg);
 +
 +	SCTP_DEBUG_PRINTK("We sent primitively.\n");
 +
  	if (err)
  		goto out_free;
 +	else
 +		err = msg_len;
++=======
++		goto out_free;
+ 
+ 	pr_debug("%s: we sent primitively\n", __func__);
+ 
+ 	err = msg_len;
+ 
+ 	if (unlikely(wait_connect)) {
+ 		timeo = sock_sndtimeo(sk, msg_flags & MSG_DONTWAIT);
+ 		sctp_wait_for_connect(asoc, &timeo);
+ 	}
++>>>>>>> 8b570dc9f7b6 (sctp: only drop the reference on the datamsg after sending a msg)
  
  	/* If we are already past ASSOCIATE, the lower
  	 * layers are responsible for association cleanup.
* Unmerged path net/sctp/socket.c
