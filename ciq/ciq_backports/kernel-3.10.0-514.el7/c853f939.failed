perf tools: Add perf_event__fprintf_event_update function

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Jiri Olsa <jolsa@kernel.org>
commit c853f9394b7bc189632673cac802bdbf6537463b
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/c853f939.failed

To display a 'event update' event for raw dump.

	Signed-off-by: Jiri Olsa <jolsa@kernel.org>
	Tested-by: Kan Liang <kan.liang@intel.com>
	Cc: David Ahern <dsahern@gmail.com>
	Cc: Namhyung Kim <namhyung@kernel.org>
	Cc: Peter Zijlstra <a.p.zijlstra@chello.nl>
Link: http://lkml.kernel.org/r/1445784728-21732-26-git-send-email-jolsa@kernel.org
	Signed-off-by: Arnaldo Carvalho de Melo <acme@redhat.com>
(cherry picked from commit c853f9394b7bc189632673cac802bdbf6537463b)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/perf/util/header.c
#	tools/perf/util/header.h
diff --cc tools/perf/util/header.c
index 5ac7bdb0dff7,49676c14c8ae..000000000000
--- a/tools/perf/util/header.c
+++ b/tools/perf/util/header.c
@@@ -2686,6 -2686,152 +2686,155 @@@ int perf_event__synthesize_attr(struct 
  	return err;
  }
  
++<<<<<<< HEAD
++=======
+ static struct event_update_event *
+ event_update_event__new(size_t size, u64 type, u64 id)
+ {
+ 	struct event_update_event *ev;
+ 
+ 	size += sizeof(*ev);
+ 	size  = PERF_ALIGN(size, sizeof(u64));
+ 
+ 	ev = zalloc(size);
+ 	if (ev) {
+ 		ev->header.type = PERF_RECORD_EVENT_UPDATE;
+ 		ev->header.size = (u16)size;
+ 		ev->type = type;
+ 		ev->id = id;
+ 	}
+ 	return ev;
+ }
+ 
+ int
+ perf_event__synthesize_event_update_unit(struct perf_tool *tool,
+ 					 struct perf_evsel *evsel,
+ 					 perf_event__handler_t process)
+ {
+ 	struct event_update_event *ev;
+ 	size_t size = strlen(evsel->unit);
+ 	int err;
+ 
+ 	ev = event_update_event__new(size + 1, PERF_EVENT_UPDATE__UNIT, evsel->id[0]);
+ 	if (ev == NULL)
+ 		return -ENOMEM;
+ 
+ 	strncpy(ev->data, evsel->unit, size);
+ 	err = process(tool, (union perf_event *)ev, NULL, NULL);
+ 	free(ev);
+ 	return err;
+ }
+ 
+ int
+ perf_event__synthesize_event_update_scale(struct perf_tool *tool,
+ 					  struct perf_evsel *evsel,
+ 					  perf_event__handler_t process)
+ {
+ 	struct event_update_event *ev;
+ 	struct event_update_event_scale *ev_data;
+ 	int err;
+ 
+ 	ev = event_update_event__new(sizeof(*ev_data), PERF_EVENT_UPDATE__SCALE, evsel->id[0]);
+ 	if (ev == NULL)
+ 		return -ENOMEM;
+ 
+ 	ev_data = (struct event_update_event_scale *) ev->data;
+ 	ev_data->scale = evsel->scale;
+ 	err = process(tool, (union perf_event*) ev, NULL, NULL);
+ 	free(ev);
+ 	return err;
+ }
+ 
+ int
+ perf_event__synthesize_event_update_name(struct perf_tool *tool,
+ 					 struct perf_evsel *evsel,
+ 					 perf_event__handler_t process)
+ {
+ 	struct event_update_event *ev;
+ 	size_t len = strlen(evsel->name);
+ 	int err;
+ 
+ 	ev = event_update_event__new(len + 1, PERF_EVENT_UPDATE__NAME, evsel->id[0]);
+ 	if (ev == NULL)
+ 		return -ENOMEM;
+ 
+ 	strncpy(ev->data, evsel->name, len);
+ 	err = process(tool, (union perf_event*) ev, NULL, NULL);
+ 	free(ev);
+ 	return err;
+ }
+ 
+ int
+ perf_event__synthesize_event_update_cpus(struct perf_tool *tool,
+ 					struct perf_evsel *evsel,
+ 					perf_event__handler_t process)
+ {
+ 	size_t size = sizeof(struct event_update_event);
+ 	struct event_update_event *ev;
+ 	int max, err;
+ 	u16 type;
+ 
+ 	if (!evsel->own_cpus)
+ 		return 0;
+ 
+ 	ev = cpu_map_data__alloc(evsel->own_cpus, &size, &type, &max);
+ 	if (!ev)
+ 		return -ENOMEM;
+ 
+ 	ev->header.type = PERF_RECORD_EVENT_UPDATE;
+ 	ev->header.size = (u16)size;
+ 	ev->type = PERF_EVENT_UPDATE__CPUS;
+ 	ev->id   = evsel->id[0];
+ 
+ 	cpu_map_data__synthesize((struct cpu_map_data *) ev->data,
+ 				 evsel->own_cpus,
+ 				 type, max);
+ 
+ 	err = process(tool, (union perf_event*) ev, NULL, NULL);
+ 	free(ev);
+ 	return err;
+ }
+ 
+ size_t perf_event__fprintf_event_update(union perf_event *event, FILE *fp)
+ {
+ 	struct event_update_event *ev = &event->event_update;
+ 	struct event_update_event_scale *ev_scale;
+ 	struct event_update_event_cpus *ev_cpus;
+ 	struct cpu_map *map;
+ 	size_t ret;
+ 
+ 	ret = fprintf(fp, "\n... id:    %" PRIu64 "\n", ev->id);
+ 
+ 	switch (ev->type) {
+ 	case PERF_EVENT_UPDATE__SCALE:
+ 		ev_scale = (struct event_update_event_scale *) ev->data;
+ 		ret += fprintf(fp, "... scale: %f\n", ev_scale->scale);
+ 		break;
+ 	case PERF_EVENT_UPDATE__UNIT:
+ 		ret += fprintf(fp, "... unit:  %s\n", ev->data);
+ 		break;
+ 	case PERF_EVENT_UPDATE__NAME:
+ 		ret += fprintf(fp, "... name:  %s\n", ev->data);
+ 		break;
+ 	case PERF_EVENT_UPDATE__CPUS:
+ 		ev_cpus = (struct event_update_event_cpus *) ev->data;
+ 		ret += fprintf(fp, "... ");
+ 
+ 		map = cpu_map__new_data(&ev_cpus->cpus);
+ 		if (map)
+ 			ret += cpu_map__fprintf(map, fp);
+ 		else
+ 			ret += fprintf(fp, "failed to get cpus\n");
+ 		break;
+ 	default:
+ 		ret += fprintf(fp, "... unknown type\n");
+ 		break;
+ 	}
+ 
+ 	return ret;
+ }
+ 
++>>>>>>> c853f9394b7b (perf tools: Add perf_event__fprintf_event_update function)
  int perf_event__synthesize_attrs(struct perf_tool *tool,
  				   struct perf_session *session,
  				   perf_event__handler_t process)
diff --cc tools/perf/util/header.h
index 05f27cb6b7e3,710deecf8f80..000000000000
--- a/tools/perf/util/header.h
+++ b/tools/perf/util/header.h
@@@ -105,8 -105,24 +105,15 @@@ int perf_event__synthesize_attr(struct 
  int perf_event__synthesize_attrs(struct perf_tool *tool,
  				 struct perf_session *session,
  				 perf_event__handler_t process);
 -int perf_event__synthesize_event_update_unit(struct perf_tool *tool,
 -					     struct perf_evsel *evsel,
 -					     perf_event__handler_t process);
 -int perf_event__synthesize_event_update_scale(struct perf_tool *tool,
 -					      struct perf_evsel *evsel,
 -					      perf_event__handler_t process);
 -int perf_event__synthesize_event_update_name(struct perf_tool *tool,
 -					     struct perf_evsel *evsel,
 -					     perf_event__handler_t process);
 -int perf_event__synthesize_event_update_cpus(struct perf_tool *tool,
 -					     struct perf_evsel *evsel,
 -					     perf_event__handler_t process);
  int perf_event__process_attr(struct perf_tool *tool, union perf_event *event,
  			     struct perf_evlist **pevlist);
++<<<<<<< HEAD
++=======
+ int perf_event__process_event_update(struct perf_tool *tool __maybe_unused,
+ 				     union perf_event *event,
+ 				     struct perf_evlist **pevlist);
+ size_t perf_event__fprintf_event_update(union perf_event *event, FILE *fp);
++>>>>>>> c853f9394b7b (perf tools: Add perf_event__fprintf_event_update function)
  
  int perf_event__synthesize_tracing_data(struct perf_tool *tool,
  					int fd, struct perf_evlist *evlist,
* Unmerged path tools/perf/util/header.c
* Unmerged path tools/perf/util/header.h
