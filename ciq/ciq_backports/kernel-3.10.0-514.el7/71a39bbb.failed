IB/mlx4: Enable RoCE v2 when the IB device is added

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Moni Shoua <monis@mellanox.com>
commit 71a39bbbfc5931310073ecbbdbe6d0fa92501fe4
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/71a39bbb.failed

If the hardware supports RoCE v2, we configure the hardware UDP
port according to the RoCE v2 Annex when mlx4_ib device is added.

	Signed-off-by: Moni Shoua <monis@mellanox.com>
	Signed-off-by: Matan Barak <matanb@mellanox.com>
	Signed-off-by: Doug Ledford <dledford@redhat.com>
(cherry picked from commit 71a39bbbfc5931310073ecbbdbe6d0fa92501fe4)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/hw/mlx4/main.c
diff --cc drivers/infiniband/hw/mlx4/main.c
index e5d702de788a,8bc0d608a9ca..000000000000
--- a/drivers/infiniband/hw/mlx4/main.c
+++ b/drivers/infiniband/hw/mlx4/main.c
@@@ -2905,26 -2498,12 +2906,35 @@@ static void *mlx4_ib_add(struct mlx4_de
  				goto err_notif;
  			}
  		}
++<<<<<<< HEAD
 +		if (!iboe->nb_inet.notifier_call) {
 +			iboe->nb_inet.notifier_call = mlx4_ib_inet_event;
 +			err = register_inetaddr_notifier(&iboe->nb_inet);
 +			if (err) {
 +				iboe->nb_inet.notifier_call = NULL;
 +				goto err_notif;
 +			}
 +		}
 +#if IS_ENABLED(CONFIG_IPV6)
 +		if (!iboe->nb_inet6.notifier_call) {
 +			iboe->nb_inet6.notifier_call = mlx4_ib_inet6_event;
 +			err = register_inet6addr_notifier(&iboe->nb_inet6);
 +			if (err) {
 +				iboe->nb_inet6.notifier_call = NULL;
 +				goto err_notif;
 +			}
 +		}
 +#endif
 +		if (mlx4_ib_init_gid_table(ibdev))
 +			goto err_notif;
++=======
+ 		if (dev->caps.flags2 & MLX4_DEV_CAP_FLAG2_ROCE_V1_V2) {
+ 			err = mlx4_config_roce_v2_port(dev, ROCE_V2_UDP_DPORT);
+ 			if (err) {
+ 				goto err_notif;
+ 			}
+ 		}
++>>>>>>> 71a39bbbfc59 (IB/mlx4: Enable RoCE v2 when the IB device is added)
  	}
  
  	for (j = 0; j < ARRAY_SIZE(mlx4_class_attributes); ++j) {
* Unmerged path drivers/infiniband/hw/mlx4/main.c
