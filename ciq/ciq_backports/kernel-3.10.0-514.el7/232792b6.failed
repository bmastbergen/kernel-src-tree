qla2xxx: Schedule board_disable only once

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Joe Lawrence <joe.lawrence@stratus.com>
commit 232792b6b43b1420324e432a0498602b9c8d5a8c
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/232792b6.failed

There are various callers of qla2x00_check_reg{32,16}_for_disconnect
that may schedule board removal on PCI-disconnect. Test-and-set a
dedicated flag before scheduling board_disable so it is invoked only
once.

	Signed-off-by: Joe Lawrence <joe.lawrence@stratus.com>
	Acked-by: Chad Dupuis <chad.dupuis@qlogic.com>
	Signed-off-by: Christoph Hellwig <hch@lst.de>
(cherry picked from commit 232792b6b43b1420324e432a0498602b9c8d5a8c)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/qla2xxx/qla_isr.c
diff --cc drivers/scsi/qla2xxx/qla_isr.c
index f12cf90f18f9,fd75b9139693..000000000000
--- a/drivers/scsi/qla2xxx/qla_isr.c
+++ b/drivers/scsi/qla2xxx/qla_isr.c
@@@ -110,6 -112,30 +110,33 @@@ qla2100_intr_handler(int irq, void *dev
  	return (IRQ_HANDLED);
  }
  
++<<<<<<< HEAD
++=======
+ bool
+ qla2x00_check_reg32_for_disconnect(scsi_qla_host_t *vha, uint32_t reg)
+ {
+ 	/* Check for PCI disconnection */
+ 	if (reg == 0xffffffff) {
+ 		if (!test_and_set_bit(PFLG_DISCONNECTED, &vha->pci_flags)) {
+ 			/*
+ 			 * Schedule this (only once) on the default system
+ 			 * workqueue so that all the adapter workqueues and the
+ 			 * DPC thread can be shutdown cleanly.
+ 			 */
+ 			schedule_work(&vha->hw->board_disable);
+ 		}
+ 		return true;
+ 	} else
+ 		return false;
+ }
+ 
+ bool
+ qla2x00_check_reg16_for_disconnect(scsi_qla_host_t *vha, uint16_t reg)
+ {
+ 	return qla2x00_check_reg32_for_disconnect(vha, 0xffff0000 | reg);
+ }
+ 
++>>>>>>> 232792b6b43b (qla2xxx: Schedule board_disable only once)
  /**
   * qla2300_intr_handler() - Process interrupts for the ISP23xx and ISP63xx.
   * @irq:
diff --git a/drivers/scsi/qla2xxx/qla_def.h b/drivers/scsi/qla2xxx/qla_def.h
index 1322f35afaab..4f6cb050b3b2 100644
--- a/drivers/scsi/qla2xxx/qla_def.h
+++ b/drivers/scsi/qla2xxx/qla_def.h
@@ -3504,6 +3504,9 @@ typedef struct scsi_qla_host {
 #define FX00_CRITEMP_RECOVERY	25
 #define FX00_HOST_INFO_RESEND	26
 
+	unsigned long	pci_flags;
+#define PFLG_DISCONNECTED	0	/* PCI device removed */
+
 	uint32_t	device_flags;
 #define SWITCH_FOUND		BIT_0
 #define DFLG_NO_CABLE		BIT_1
* Unmerged path drivers/scsi/qla2xxx/qla_isr.c
