mmc: mvsdio: delete platform data code path

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
Rebuild_CHGLOG: - [mmc] mvsdio: delete platform data code path (Don Zickus) [1127975 1277866 1280133 1286932 1297039]
Rebuild_FUZZ: 93.83%
commit-author Linus Walleij <linus.walleij@linaro.org>
commit 17da678368fac22375f0854c811034e311be23b5
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/17da6783.failed

There are no in-kernel users of the MVSDIO platform data method
(instantiating from a board file) so just delete this code and
make this a DT-only driver. We depend on OF and check that we have
an OF node in probe().

	Cc: Nicolas Pitre <nico@fluxnic.net>
	Cc: Andrew Lunn <andrew@lunn.ch>
	Cc: Sebastian Hesselbarth <sebastian.hesselbarth@gmail.com>
	Signed-off-by: Linus Walleij <linus.walleij@linaro.org>
	Acked-by: Nicolas Pitre <nico@linaro.org>
	Acked-by: Andrew Lunn <andrew@lunn.ch>
	Signed-off-by: Ulf Hansson <ulf.hansson@linaro.org>
(cherry picked from commit 17da678368fac22375f0854c811034e311be23b5)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/mmc/host/mvsdio.c
diff --cc drivers/mmc/host/mvsdio.c
index d08fe6ae9bf8,42296e55b9de..000000000000
--- a/drivers/mmc/host/mvsdio.c
+++ b/drivers/mmc/host/mvsdio.c
@@@ -685,9 -700,11 +683,13 @@@ static int __init mvsd_probe(struct pla
  	const struct mbus_dram_target_info *dram;
  	struct resource *r;
  	int ret, irq;
 +	int gpio_card_detect, gpio_write_protect;
 +	struct pinctrl *pinctrl;
  
+ 	if (!np) {
+ 		dev_err(&pdev->dev, "no DT node\n");
+ 		return -ENODEV;
+ 	}
  	r = platform_get_resource(pdev, IORESOURCE_MEM, 0);
  	irq = platform_get_irq(pdev, 0);
  	if (!r || irq < 0)
@@@ -715,39 -728,19 +717,52 @@@
  	 * fixed rate clock).
  	 */
  	host->clk = devm_clk_get(&pdev->dev, NULL);
- 	if (!IS_ERR(host->clk))
- 		clk_prepare_enable(host->clk);
+ 	if (IS_ERR(host->clk)) {
+ 		dev_err(&pdev->dev, "no clock associated\n");
+ 		ret = -EINVAL;
+ 		goto out;
+ 	}
+ 	clk_prepare_enable(host->clk);
  
++<<<<<<< HEAD
 +	if (np) {
 +		if (IS_ERR(host->clk)) {
 +			dev_err(&pdev->dev, "DT platforms must have a clock associated\n");
 +			ret = -EINVAL;
 +			goto out;
 +		}
 +
 +		host->base_clock = clk_get_rate(host->clk) / 2;
 +		gpio_card_detect = of_get_named_gpio(np, "cd-gpios", 0);
 +		gpio_write_protect = of_get_named_gpio(np, "wp-gpios", 0);
 +	} else {
 +		const struct mvsdio_platform_data *mvsd_data;
 +		mvsd_data = pdev->dev.platform_data;
 +		if (!mvsd_data) {
 +			ret = -ENXIO;
 +			goto out;
 +		}
 +		host->base_clock = mvsd_data->clock / 2;
 +		gpio_card_detect = mvsd_data->gpio_card_detect ? : -EINVAL;
 +		gpio_write_protect = mvsd_data->gpio_write_protect ? : -EINVAL;
 +	}
 +
 +	mmc->ops = &mvsd_ops;
 +
 +	mmc->ocr_avail = MMC_VDD_32_33 | MMC_VDD_33_34;
 +	mmc->caps = MMC_CAP_4_BIT_DATA | MMC_CAP_SDIO_IRQ |
 +		    MMC_CAP_SD_HIGHSPEED | MMC_CAP_MMC_HIGHSPEED;
 +
 +	mmc->f_min = DIV_ROUND_UP(host->base_clock, MVSD_BASE_DIV_MAX);
 +	mmc->f_max = maxfreq;
++=======
+ 	mmc->ops = &mvsd_ops;
+ 
+ 	mmc->ocr_avail = MMC_VDD_32_33 | MMC_VDD_33_34;
+ 
+ 	mmc->f_min = DIV_ROUND_UP(host->base_clock, MVSD_BASE_DIV_MAX);
+ 	mmc->f_max = MVSD_CLOCKRATE_MAX;
++>>>>>>> 17da678368fa (mmc: mvsdio: delete platform data code path)
  
  	mmc->max_blk_size = 2048;
  	mmc->max_blk_count = 65535;
@@@ -755,6 -748,13 +770,16 @@@
  	mmc->max_segs = 1;
  	mmc->max_seg_size = mmc->max_blk_size * mmc->max_blk_count;
  	mmc->max_req_size = mmc->max_blk_size * mmc->max_blk_count;
++<<<<<<< HEAD
++=======
+ 
+ 	host->base_clock = clk_get_rate(host->clk) / 2;
+ 	ret = mmc_of_parse(mmc);
+ 	if (ret < 0)
+ 		goto out;
+ 	if (maxfreq)
+ 		mmc->f_max = maxfreq;
++>>>>>>> 17da678368fa (mmc: mvsdio: delete platform data code path)
  
  	spin_lock_init(&host->lock);
  
diff --git a/drivers/mmc/host/Kconfig b/drivers/mmc/host/Kconfig
index 67d09e874566..2a466d52ab3e 100644
--- a/drivers/mmc/host/Kconfig
+++ b/drivers/mmc/host/Kconfig
@@ -430,6 +430,7 @@ config MMC_TIFM_SD
 config MMC_MVSDIO
 	tristate "Marvell MMC/SD/SDIO host driver"
 	depends on PLAT_ORION
+	depends on OF
 	---help---
 	  This selects the Marvell SDIO host driver.
 	  SDIO may currently be found on the Kirkwood 88F6281 and 88F6192
* Unmerged path drivers/mmc/host/mvsdio.c
