perf stat record: Synthesize stat record data

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Jiri Olsa <jolsa@kernel.org>
commit 8b99b1a4e0b082ea6a277766982dac84483d4d3c
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/8b99b1a4.failed

Synthesizing needed stat record data for report/script:
  - cpu/thread maps
  - stat config

Committer note:

New records generated on a perf.data file with this patch:

  $ perf report -D | grep PERF_RECORD_
  0x568 [0x28]: PERF_RECORD_THREAD_MAP nr: 1 thread: 29097
  0x590 [0x12]: PERF_RECORD_CPU_MAP nr: 1 cpu: 65535
  0x5a2 [0x40]: PERF_RECORD_STAT_CONFIG
  $

	Signed-off-by: Jiri Olsa <jolsa@kernel.org>
	Tested-by: Arnaldo Carvalho de Melo <acme@redhat.com>
	Tested-by: Kan Liang <kan.liang@intel.com>
	Cc: David Ahern <dsahern@gmail.com>
	Cc: Namhyung Kim <namhyung@kernel.org>
	Cc: Peter Zijlstra <a.p.zijlstra@chello.nl>
Link: http://lkml.kernel.org/r/1446734469-11352-5-git-send-email-jolsa@kernel.org
[ Adjusted wrt kernel PERF_RECORD_MMAP added when introducing 'perf stat record' ]
	Signed-off-by: Arnaldo Carvalho de Melo <acme@redhat.com>
(cherry picked from commit 8b99b1a4e0b082ea6a277766982dac84483d4d3c)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/perf/builtin-stat.c
diff --cc tools/perf/builtin-stat.c
index 473fc692d35a,45bf4d2caebe..000000000000
--- a/tools/perf/builtin-stat.c
+++ b/tools/perf/builtin-stat.c
@@@ -197,6 -217,20 +197,23 @@@ static inline int nsec_counter(struct p
  	return 0;
  }
  
++<<<<<<< HEAD
++=======
+ static int process_synthesized_event(struct perf_tool *tool __maybe_unused,
+ 				     union perf_event *event,
+ 				     struct perf_sample *sample __maybe_unused,
+ 				     struct machine *machine __maybe_unused)
+ {
+ 	if (perf_data_file__write(&perf_stat.file, event, event->header.size) < 0) {
+ 		pr_err("failed to write perf data, error: %m\n");
+ 		return -1;
+ 	}
+ 
+ 	perf_stat.bytes_written += event->header.size;
+ 	return 0;
+ }
+ 
++>>>>>>> 8b99b1a4e0b0 (perf stat record: Synthesize stat record data)
  /*
   * Read out the results of a single counter:
   * do not aggregate counts across CPUs in system-wide mode
@@@ -356,6 -419,19 +402,22 @@@ static int __run_perf_stat(int argc, co
  		return -1;
  	}
  
++<<<<<<< HEAD
++=======
+ 	if (STAT_RECORD) {
+ 		int err, fd = perf_data_file__fd(&perf_stat.file);
+ 
+ 		err = perf_session__write_header(perf_stat.session, evsel_list,
+ 						 fd, false);
+ 		if (err < 0)
+ 			return err;
+ 
+ 		err = perf_stat_synthesize_config();
+ 		if (err < 0)
+ 			return err;
+ 	}
+ 
++>>>>>>> 8b99b1a4e0b0 (perf stat record: Synthesize stat record data)
  	/*
  	 * Enable counters and exec the command:
  	 */
@@@ -1388,6 -1579,34 +1450,37 @@@ int cmd_stat(int argc, const char **arg
  	if (!forever && status != -1 && !interval)
  		print_counters(NULL, argc, argv);
  
++<<<<<<< HEAD
++=======
+ 	if (STAT_RECORD) {
+ 		/*
+ 		 * We synthesize the kernel mmap record just so that older tools
+ 		 * don't emit warnings about not being able to resolve symbols
+ 		 * due to /proc/sys/kernel/kptr_restrict settings and instear provide
+ 		 * a saner message about no samples being in the perf.data file.
+ 		 *
+ 		 * This also serves to suppress a warning about f_header.data.size == 0
+ 		 * in header.c at the moment 'perf stat record' gets introduced, which
+ 		 * is not really needed once we start adding the stat specific PERF_RECORD_
+ 		 * records, but the need to suppress the kptr_restrict messages in older
+ 		 * tools remain  -acme
+ 		 */
+ 		int fd = perf_data_file__fd(&perf_stat.file);
+ 		int err = perf_event__synthesize_kernel_mmap((void *)&perf_stat,
+ 							     process_synthesized_event,
+ 							     &perf_stat.session->machines.host);
+ 		if (err) {
+ 			pr_warning("Couldn't synthesize the kernel mmap record, harmless, "
+ 				   "older tools may produce warnings about this file\n.");
+ 		}
+ 
+ 		perf_stat.session->header.data_size += perf_stat.bytes_written;
+ 		perf_session__write_header(perf_stat.session, evsel_list, fd, true);
+ 
+ 		perf_session__delete(perf_stat.session);
+ 	}
+ 
++>>>>>>> 8b99b1a4e0b0 (perf stat record: Synthesize stat record data)
  	perf_stat__exit_aggr_mode();
  	perf_evlist__free_stats(evsel_list);
  out:
* Unmerged path tools/perf/builtin-stat.c
