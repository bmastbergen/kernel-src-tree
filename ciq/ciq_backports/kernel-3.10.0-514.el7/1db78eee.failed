IB/hfi1: Add unique trace point for pio and sdma send

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Mike Marciniszyn <mike.marciniszyn@intel.com>
commit 1db78eeebee7cde877194ddc8691f192e6279609
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/1db78eee.failed

This allows for separately enabling pio and sdma
tracepoints to cut the volume of trace information.

	Reviewed-by: Dennis Dalessandro <dennis.dalessandro@intel.com>
	Signed-off-by: Mike Marciniszyn <mike.marciniszyn@intel.com>
	Signed-off-by: Doug Ledford <dledford@redhat.com>
(cherry picked from commit 1db78eeebee7cde877194ddc8691f192e6279609)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/staging/hfi1/verbs.c
#	drivers/staging/rdma/hfi1/trace.h
diff --cc drivers/staging/hfi1/verbs.c
index d228eb7fc4f0,e605e09d8084..000000000000
--- a/drivers/staging/hfi1/verbs.c
+++ b/drivers/staging/hfi1/verbs.c
@@@ -1014,42 -872,27 +1014,47 @@@ int hfi1_verbs_send_dma(struct hfi1_qp 
  
  	int ret;
  
 -	tx = ps->s_txreq;
 -	if (!sdma_txreq_built(&tx->txreq)) {
 -		if (likely(pbc == 0)) {
 -			u32 vl = sc_to_vlt(dd_from_ibdev(qp->ibqp.device), sc5);
 -			/* No vl15 here */
 -			/* set PBC_DC_INFO bit (aka SC[4]) in pbc_flags */
 -			pbc_flags |= (!!(sc5 & 0x10)) << PBC_DC_INFO_SHIFT;
 -
 -			pbc = create_pbc(ppd,
 -					 pbc_flags,
 -					 qp->srate_mbps,
 -					 vl,
 -					 plen);
 -		}
 -		tx->wqe = qp->s_wqe;
 -		ret = build_verbs_tx_desc(tx->sde, ss, len, tx, ahdr, pbc);
 -		if (unlikely(ret))
 -			goto bail_build;
 +	if (!list_empty(&priv->s_iowait.tx_head)) {
 +		stx = list_first_entry(
 +			&priv->s_iowait.tx_head,
 +			struct sdma_txreq,
 +			list);
 +		list_del_init(&stx->list);
 +		tx = container_of(stx, struct verbs_txreq, txreq);
 +		ret = sdma_send_txreq(tx->sde, &priv->s_iowait, stx);
 +		if (unlikely(ret == -ECOMM))
 +			goto bail_ecomm;
 +		return ret;
  	}
++<<<<<<< HEAD:drivers/staging/hfi1/verbs.c
 +
 +	tx = get_txreq(dev, qp);
 +	if (IS_ERR(tx))
 +		goto bail_tx;
 +
 +	tx->sde = priv->s_sde;
 +
 +	if (likely(pbc == 0)) {
 +		u32 vl = sc_to_vlt(dd_from_ibdev(qp->ibqp.device), sc5);
 +		/* No vl15 here */
 +		/* set PBC_DC_INFO bit (aka SC[4]) in pbc_flags */
 +		pbc_flags |= (!!(sc5 & 0x10)) << PBC_DC_INFO_SHIFT;
 +
 +		pbc = create_pbc(ppd, pbc_flags, qp->srate_mbps, vl, plen);
 +	}
 +	tx->wqe = qp->s_wqe;
 +	tx->mr = qp->s_rdma_mr;
 +	if (qp->s_rdma_mr)
 +		qp->s_rdma_mr = NULL;
 +	tx->hdr_dwords = hdrwords + 2;
 +	ret = build_verbs_tx_desc(tx->sde, ss, len, tx, ahdr, pbc);
 +	if (unlikely(ret))
 +		goto bail_build;
 +	trace_output_ibhdr(dd_from_ibdev(qp->ibqp.device), &ahdr->ibh);
++=======
+ 	trace_sdma_output_ibhdr(dd_from_ibdev(qp->ibqp.device),
+ 				&ps->s_txreq->phdr.hdr);
++>>>>>>> 1db78eeebee7 (IB/hfi1: Add unique trace point for pio and sdma send):drivers/staging/rdma/hfi1/verbs.c
  	ret =  sdma_send_txreq(tx->sde, &priv->s_iowait, &tx->txreq);
  	if (unlikely(ret == -ECOMM))
  		goto bail_ecomm;
@@@ -1196,12 -1067,8 +1201,17 @@@ int hfi1_verbs_send_pio(struct hfi1_qp 
  		}
  	}
  
++<<<<<<< HEAD:drivers/staging/hfi1/verbs.c
 +	trace_output_ibhdr(dd_from_ibdev(qp->ibqp.device), &ahdr->ibh);
 +
 +	if (qp->s_rdma_mr) {
 +		hfi1_put_mr(qp->s_rdma_mr);
 +		qp->s_rdma_mr = NULL;
 +	}
++=======
+ 	trace_pio_output_ibhdr(dd_from_ibdev(qp->ibqp.device),
+ 			       &ps->s_txreq->phdr.hdr);
++>>>>>>> 1db78eeebee7 (IB/hfi1: Add unique trace point for pio and sdma send):drivers/staging/rdma/hfi1/verbs.c
  
  pio_bail:
  	if (qp->s_wqe) {
* Unmerged path drivers/staging/rdma/hfi1/trace.h
diff --git a/drivers/staging/hfi1/rc.c b/drivers/staging/hfi1/rc.c
index dd57d65aa9b2..60704310c030 100644
--- a/drivers/staging/hfi1/rc.c
+++ b/drivers/staging/hfi1/rc.c
@@ -764,7 +764,7 @@ void hfi1_send_rc_ack(struct hfi1_ctxtdata *rcd, struct hfi1_qp *qp,
 		goto queue_ack;
 	}
 
-	trace_output_ibhdr(dd_from_ibdev(qp->ibqp.device), &hdr);
+	trace_ack_output_ibhdr(dd_from_ibdev(qp->ibqp.device), &hdr);
 
 	/* write the pbc and data */
 	ppd->dd->pio_inline_send(ppd->dd, pbuf, pbc, &hdr, hwords);
* Unmerged path drivers/staging/hfi1/verbs.c
* Unmerged path drivers/staging/rdma/hfi1/trace.h
