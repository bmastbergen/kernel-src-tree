KVM: x86: set KVM_REQ_EVENT on local interrupt request from user space

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Matt Gingell <gingell@google.com>
commit 934bf65354227981df15bbc755d33f4ba3443ff2
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/934bf653.failed

Set KVM_REQ_EVENT when a PIC in user space injects a local interrupt.

Currently a request is only made when neither the PIC nor the APIC is in
the kernel, which is not sufficient in the split IRQ chip case.

This addresses a problem in QEMU where interrupts are delayed until
another path invokes the event loop.

	Reviewed-by: Steve Rutherford <srutherford@google.com>
	Signed-off-by: Matt Gingell <gingell@google.com>
Fixes: 1c1a9ce973a7863dd46767226bce2a5f12d48bc6
	Cc: stable@vger.kernel.org
	Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
(cherry picked from commit 934bf65354227981df15bbc755d33f4ba3443ff2)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kvm/x86.c
diff --cc arch/x86/kvm/x86.c
index 733894b44f8d,f254e296d368..000000000000
--- a/arch/x86/kvm/x86.c
+++ b/arch/x86/kvm/x86.c
@@@ -3069,12 -2788,25 +3069,17 @@@ static int kvm_vcpu_ioctl_interrupt(str
  {
  	if (irq->irq >= KVM_NR_INTERRUPTS)
  		return -EINVAL;
 -
 -	if (!irqchip_in_kernel(vcpu->kvm)) {
 -		kvm_queue_interrupt(vcpu, irq->irq, false);
 -		kvm_make_request(KVM_REQ_EVENT, vcpu);
 -		return 0;
 -	}
 -
 -	/*
 -	 * With in-kernel LAPIC, we only use this to inject EXTINT, so
 -	 * fail for in-kernel 8259.
 -	 */
 -	if (pic_in_kernel(vcpu->kvm))
 +	if (irqchip_in_kernel(vcpu->kvm))
  		return -ENXIO;
  
 -	if (vcpu->arch.pending_external_vector != -1)
 -		return -EEXIST;
 +	kvm_queue_interrupt(vcpu, irq->irq, false);
 +	kvm_make_request(KVM_REQ_EVENT, vcpu);
  
++<<<<<<< HEAD
++=======
+ 	vcpu->arch.pending_external_vector = irq->irq;
+ 	kvm_make_request(KVM_REQ_EVENT, vcpu);
++>>>>>>> 934bf6535422 (KVM: x86: set KVM_REQ_EVENT on local interrupt request from user space)
  	return 0;
  }
  
* Unmerged path arch/x86/kvm/x86.c
