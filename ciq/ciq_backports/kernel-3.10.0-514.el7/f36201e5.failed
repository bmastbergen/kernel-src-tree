KVM: VMX: simplify rdtscp handling in vmx_cpuid_update()

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Xiao Guangrong <guangrong.xiao@linux.intel.com>
commit f36201e5f44b55faf44ddc820929548e51ec841b
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/f36201e5.failed

if vmx_rdtscp_supported() is true SECONDARY_EXEC_RDTSCP must
have already been set in current vmcs by
vmx_secondary_exec_control()

	Signed-off-by: Xiao Guangrong <guangrong.xiao@linux.intel.com>
	Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
(cherry picked from commit f36201e5f44b55faf44ddc820929548e51ec841b)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kvm/vmx.c
diff --cc arch/x86/kvm/vmx.c
index 6bc9594ea8b1,d53f57aad5eb..000000000000
--- a/arch/x86/kvm/vmx.c
+++ b/arch/x86/kvm/vmx.c
@@@ -8379,16 -8677,18 +8379,21 @@@ static void vmx_cpuid_update(struct kvm
  	vmx->rdtscp_enabled = false;
  	if (vmx_rdtscp_supported()) {
  		exec_control = vmcs_read32(SECONDARY_VM_EXEC_CONTROL);
- 		if (exec_control & SECONDARY_EXEC_RDTSCP) {
- 			best = kvm_find_cpuid_entry(vcpu, 0x80000001, 0);
- 			if (best && (best->edx & bit(X86_FEATURE_RDTSCP)))
- 				vmx->rdtscp_enabled = true;
- 			else {
- 				exec_control &= ~SECONDARY_EXEC_RDTSCP;
- 				vmcs_write32(SECONDARY_VM_EXEC_CONTROL,
- 						exec_control);
- 			}
+ 		best = kvm_find_cpuid_entry(vcpu, 0x80000001, 0);
+ 		if (best && (best->edx & bit(X86_FEATURE_RDTSCP)))
+ 			vmx->rdtscp_enabled = true;
+ 		else {
+ 			exec_control &= ~SECONDARY_EXEC_RDTSCP;
+ 			vmcs_write32(SECONDARY_VM_EXEC_CONTROL,
+ 					exec_control);
  		}
++<<<<<<< HEAD
++=======
+ 
+ 		if (nested && !vmx->rdtscp_enabled)
+ 			vmx->nested.nested_vmx_secondary_ctls_high &=
+ 				~SECONDARY_EXEC_RDTSCP;
++>>>>>>> f36201e5f44b (KVM: VMX: simplify rdtscp handling in vmx_cpuid_update())
  	}
  
  	/* Exposing INVPCID only when PCID is exposed */
* Unmerged path arch/x86/kvm/vmx.c
