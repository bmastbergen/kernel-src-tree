IB/core: Remove smac and vlan id from path record

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Matan Barak <matanb@mellanox.com>
commit 10e07f13c06690488087f5d3f2c59a9728def339
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/10e07f13.failed

The GID cache accompanies every GID with attributes.
The GID attributes link the GID with its netdevice, which could be
resolved to smac and vlan id easily. Since we've added the netdevice
(ifindex and net) to the path record, storing the L2 attributes is
duplicated data and hence these attributes are removed.

	Signed-off-by: Matan Barak <matanb@mellanox.com>
Reviewed-By: Devesh Sharma <devesh.sharma@avagotech.com>
	Signed-off-by: Doug Ledford <dledford@redhat.com>
(cherry picked from commit 10e07f13c06690488087f5d3f2c59a9728def339)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/core/sa_query.c
#	drivers/infiniband/core/uverbs_marshall.c
#	include/rdma/ib_sa.h
diff --cc drivers/infiniband/core/sa_query.c
index 4f07d991102c,dcdaa79e3f0f..000000000000
--- a/drivers/infiniband/core/sa_query.c
+++ b/drivers/infiniband/core/sa_query.c
@@@ -1146,9 -1153,9 +1146,13 @@@ static void ib_sa_path_rec_callback(str
  
  		ib_unpack(path_rec_table, ARRAY_SIZE(path_rec_table),
  			  mad->data, &rec);
++<<<<<<< HEAD
 +		rec.vlan_id = 0xffff;
++=======
+ 		rec.net = NULL;
+ 		rec.ifindex = 0;
++>>>>>>> 10e07f13c066 (IB/core: Remove smac and vlan id from path record)
  		memset(rec.dmac, 0, ETH_ALEN);
- 		memset(rec.smac, 0, ETH_ALEN);
  		query->callback(status, &rec, query->context);
  	} else
  		query->callback(status, NULL, query->context);
diff --cc drivers/infiniband/core/uverbs_marshall.c
index abd97247443e,7d2f14c9bbef..000000000000
--- a/drivers/infiniband/core/uverbs_marshall.c
+++ b/drivers/infiniband/core/uverbs_marshall.c
@@@ -141,8 -141,8 +141,12 @@@ void ib_copy_path_rec_from_user(struct 
  	dst->preference		= src->preference;
  	dst->packet_life_time_selector = src->packet_life_time_selector;
  
- 	memset(dst->smac, 0, sizeof(dst->smac));
  	memset(dst->dmac, 0, sizeof(dst->dmac));
++<<<<<<< HEAD
 +	dst->vlan_id = 0xffff;
++=======
+ 	dst->net = NULL;
+ 	dst->ifindex = 0;
++>>>>>>> 10e07f13c066 (IB/core: Remove smac and vlan id from path record)
  }
  EXPORT_SYMBOL(ib_copy_path_rec_from_user);
diff --cc include/rdma/ib_sa.h
index 7e071a6abb34,301969552d0a..000000000000
--- a/include/rdma/ib_sa.h
+++ b/include/rdma/ib_sa.h
@@@ -154,11 -155,18 +154,17 @@@ struct ib_sa_path_rec 
  	u8           packet_life_time_selector;
  	u8           packet_life_time;
  	u8           preference;
- 	u8           smac[ETH_ALEN];
  	u8           dmac[ETH_ALEN];
++<<<<<<< HEAD
 +	u16	     vlan_id;
++=======
+ 	/* ignored in IB */
+ 	int	     ifindex;
+ 	/* ignored in IB */
+ 	struct net  *net;
++>>>>>>> 10e07f13c066 (IB/core: Remove smac and vlan id from path record)
  };
  
 -static inline struct net_device *ib_get_ndev_from_path(struct ib_sa_path_rec *rec)
 -{
 -	return rec->net ? dev_get_by_index(rec->net, rec->ifindex) : NULL;
 -}
 -
  #define IB_SA_MCMEMBER_REC_MGID				IB_SA_COMP_MASK( 0)
  #define IB_SA_MCMEMBER_REC_PORT_GID			IB_SA_COMP_MASK( 1)
  #define IB_SA_MCMEMBER_REC_QKEY				IB_SA_COMP_MASK( 2)
diff --git a/drivers/infiniband/core/cma.c b/drivers/infiniband/core/cma.c
index 0a54544100c1..bbde85857ddc 100644
--- a/drivers/infiniband/core/cma.c
+++ b/drivers/infiniband/core/cma.c
@@ -2295,9 +2295,7 @@ static int cma_resolve_iboe_route(struct rdma_id_private *id_priv)
 		goto err2;
 	}
 
-	route->path_rec->vlan_id = rdma_vlan_dev_vlan_id(ndev);
 	memcpy(route->path_rec->dmac, addr->dev_addr.dst_dev_addr, ETH_ALEN);
-	memcpy(route->path_rec->smac, ndev->dev_addr, ndev->addr_len);
 
 	rdma_ip2gid((struct sockaddr *)&id_priv->id.route.addr.src_addr,
 		    &route->path_rec->sgid);
* Unmerged path drivers/infiniband/core/sa_query.c
* Unmerged path drivers/infiniband/core/uverbs_marshall.c
* Unmerged path include/rdma/ib_sa.h
