btrfs: Check cancel and pause in interval of scrub operation

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Zhao Lei <zhaolei@cn.fujitsu.com>
commit f2f66a2f886383fb76aca8ecc1bcc116c5d1f6fe
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/f2f66a2f.failed

Old code checking cancel and pause request inside scrub stripe
operation, like:
  loop() {
    if (parity) {
      scrub_parity_stripe();
      continue;
    }

    check_cancel_and_pause()

    scrub_normal_stripe();
  }

Reason is when introduce raid56 stripe scrub, new code is inserted
simplely to front of loop.

Better to:
  loop() {
    check_cancel_and_pause()

    if (parity)
      scrub_parity_stripe();
    else
      scrub_normal_stripe();
  }

This patch adjusted code place to realize above sequence.

	Signed-off-by: Zhao Lei <zhaolei@cn.fujitsu.com>
	Signed-off-by: Chris Mason <clm@fb.com>
(cherry picked from commit f2f66a2f886383fb76aca8ecc1bcc116c5d1f6fe)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/btrfs/scrub.c
diff --cc fs/btrfs/scrub.c
index 30db20e626c6,d99cdb11d4d9..000000000000
--- a/fs/btrfs/scrub.c
+++ b/fs/btrfs/scrub.c
@@@ -3126,23 -3105,6 +3126,26 @@@ static noinline_for_stack int scrub_str
  	 */
  	ret = 0;
  	while (physical < physical_end) {
++<<<<<<< HEAD
 +		/* for raid56, we skip parity stripe */
 +		if (map->type & (BTRFS_BLOCK_GROUP_RAID5 |
 +				BTRFS_BLOCK_GROUP_RAID6)) {
 +			ret = get_raid56_logic_offset(physical, num,
 +					map, &logical, &stripe_logical);
 +			logical += base;
 +			if (ret) {
 +				stripe_logical += base;
 +				stripe_end = stripe_logical + increment - 1;
 +				ret = scrub_raid56_parity(sctx, map, scrub_dev,
 +						ppath, stripe_logical,
 +						stripe_end);
 +				if (ret)
 +					goto out;
 +				goto skip;
 +			}
 +		}
++=======
++>>>>>>> f2f66a2f8863 (btrfs: Check cancel and pause in interval of scrub operation)
  		/*
  		 * canceled?
  		 */
* Unmerged path fs/btrfs/scrub.c
