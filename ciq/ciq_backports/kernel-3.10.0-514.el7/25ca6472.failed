mei: add me client remove functions

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Tomas Winkler <tomas.winkler@intel.com>
commit 25ca6472b590e87efba314892a76bd5629c8c989
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/25ca6472.failed

To support dynamic addition/remove we add wrappers
for removal of me clients

	Signed-off-by: Tomas Winkler <tomas.winkler@intel.com>
	Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
(cherry picked from commit 25ca6472b590e87efba314892a76bd5629c8c989)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/misc/mei/client.h
#	drivers/misc/mei/hbm.c
diff --cc drivers/misc/mei/client.h
index bf2b0b1b493d,8871a852cfbb..000000000000
--- a/drivers/misc/mei/client.h
+++ b/drivers/misc/mei/client.h
@@@ -24,8 -24,11 +24,16 @@@
  
  #include "mei_dev.h"
  
++<<<<<<< HEAD
 +int mei_me_cl_by_uuid(const struct mei_device *dev, const uuid_le *cuuid);
 +int mei_me_cl_by_id(struct mei_device *dev, u8 client_id);
++=======
+ struct mei_me_client *mei_me_cl_by_uuid(const struct mei_device *dev,
+ 					const uuid_le *cuuid);
+ struct mei_me_client *mei_me_cl_by_id(struct mei_device *dev, u8 client_id);
+ void mei_me_cl_remove(struct mei_device *dev,
+ 		      const uuid_le *uuid, u8 client_id);
++>>>>>>> 25ca6472b590 (mei: add me client remove functions)
  
  /*
   * MEI IO Functions
diff --cc drivers/misc/mei/hbm.c
index b76b57c71bfa,5fb177b3bfef..000000000000
--- a/drivers/misc/mei/hbm.c
+++ b/drivers/misc/mei/hbm.c
@@@ -76,12 -91,10 +90,19 @@@ static void mei_me_cl_remove_all(struc
   */
  void mei_hbm_reset(struct mei_device *dev)
  {
++<<<<<<< HEAD
 +	dev->me_clients_num = 0;
 +	dev->me_client_presentation_num = 0;
 +	dev->me_client_index = 0;
 +
 +	kfree(dev->me_clients);
 +	dev->me_clients = NULL;
++=======
+ 	dev->me_client_presentation_num = 0;
+ 	dev->me_client_index = 0;
+ 
+ 	mei_me_cl_remove_all(dev);
++>>>>>>> 25ca6472b590 (mei: add me client remove functions)
  
  	mei_hbm_idle(dev);
  }
diff --git a/drivers/misc/mei/client.c b/drivers/misc/mei/client.c
index 3be58ecdef41..976dbb549a3c 100644
--- a/drivers/misc/mei/client.c
+++ b/drivers/misc/mei/client.c
@@ -47,7 +47,6 @@ int mei_me_cl_by_uuid(const struct mei_device *dev, const uuid_le *uuid)
 	return -ENOENT;
 }
 
-
 /**
  * mei_me_cl_by_id return index to me_clients for client_id
  *
@@ -70,6 +69,27 @@ int mei_me_cl_by_id(struct mei_device *dev, u8 client_id)
 	return -ENOENT;
 }
 
+/**
+ * mei_me_cl_remove - remove me client matching uuid and client_id
+ *
+ * @dev: the device structure
+ * @uuid: me client uuid
+ * @client_id: me client address
+ */
+void mei_me_cl_remove(struct mei_device *dev, const uuid_le *uuid, u8 client_id)
+{
+	struct mei_me_client *me_cl, *next;
+
+	list_for_each_entry_safe(me_cl, next, &dev->me_clients, list) {
+		if (uuid_le_cmp(*uuid, me_cl->props.protocol_name) == 0 &&
+		    me_cl->client_id == client_id) {
+			list_del(&me_cl->list);
+			kfree(me_cl);
+			break;
+		}
+	}
+}
+
 
 /**
  * mei_cl_cmp_id - tells if the clients are the same
* Unmerged path drivers/misc/mei/client.h
* Unmerged path drivers/misc/mei/hbm.c
