i40e: use configured RSS key and lookup table in i40e_vsi_config_rss

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Jacob Keller <jacob.e.keller@intel.com>
commit 552b996256241198a08005a91a206b402ac234f6
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/552b9962.failed

A previous refactor added support to store user configuration for VSIs,
so that extra VSIs such as for VMDq can use this information when
configuring. Unfortunately the i40e_vsi_config_rss function was missed
in this refactor, and the values were being ignored. Fix this by
checking for the fields and using those instead of always using the
default values.

	Signed-off-by: Jacob Keller <jacob.e.keller@intel.com>
	Tested-by: Andrew Bowers <andrewx.bowers@intel.com>
	Signed-off-by: Jeff Kirsher <jeffrey.t.kirsher@intel.com>
(cherry picked from commit 552b996256241198a08005a91a206b402ac234f6)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/intel/i40e/i40e_main.c
diff --cc drivers/net/ethernet/intel/i40e/i40e_main.c
index 2d7f7ed1c19e,4ec9565be605..000000000000
--- a/drivers/net/ethernet/intel/i40e/i40e_main.c
+++ b/drivers/net/ethernet/intel/i40e/i40e_main.c
@@@ -8011,6 -8063,46 +8011,49 @@@ static int i40e_get_rss_aq(struct i40e_
  }
  
  /**
++<<<<<<< HEAD
++=======
+  * i40e_vsi_config_rss - Prepare for VSI(VMDq) RSS if used
+  * @vsi: VSI structure
+  **/
+ static int i40e_vsi_config_rss(struct i40e_vsi *vsi)
+ {
+ 	u8 seed[I40E_HKEY_ARRAY_SIZE];
+ 	struct i40e_pf *pf = vsi->back;
+ 	u8 *lut;
+ 	int ret;
+ 
+ 	if (!(pf->flags & I40E_FLAG_RSS_AQ_CAPABLE))
+ 		return 0;
+ 
+ 	if (!vsi->rss_size)
+ 		vsi->rss_size = min_t(int, pf->alloc_rss_size,
+ 				      vsi->num_queue_pairs);
+ 	if (!vsi->rss_size)
+ 		return -EINVAL;
+ 
+ 	lut = kzalloc(vsi->rss_table_size, GFP_KERNEL);
+ 	if (!lut)
+ 		return -ENOMEM;
+ 	/* Use the user configured hash keys and lookup table if there is one,
+ 	 * otherwise use default
+ 	 */
+ 	if (vsi->rss_lut_user)
+ 		memcpy(lut, vsi->rss_lut_user, vsi->rss_table_size);
+ 	else
+ 		i40e_fill_rss_lut(pf, lut, vsi->rss_table_size, vsi->rss_size);
+ 	if (vsi->rss_hkey_user)
+ 		memcpy(seed, vsi->rss_hkey_user, I40E_HKEY_ARRAY_SIZE);
+ 	else
+ 		netdev_rss_key_fill((void *)seed, I40E_HKEY_ARRAY_SIZE);
+ 	ret = i40e_config_rss_aq(vsi, seed, lut, vsi->rss_table_size);
+ 	kfree(lut);
+ 
+ 	return ret;
+ }
+ 
+ /**
++>>>>>>> 552b99625624 (i40e: use configured RSS key and lookup table in i40e_vsi_config_rss)
   * i40e_config_rss_reg - Configure RSS keys and lut by writing registers
   * @vsi: Pointer to vsi structure
   * @seed: RSS hash seed
* Unmerged path drivers/net/ethernet/intel/i40e/i40e_main.c
