scsi: add a blacklist flag which enables VPD page inquiries

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
Rebuild_CHGLOG: - [scsi] add a blacklist flag which enables VPD page inquiries (Ewan Milne) [1292896]
Rebuild_FUZZ: 94.64%
commit-author Martin K. Petersen <martin.petersen@oracle.com>
commit c1d40a527e885a40bb9ea6c46a1b1145d42b66a0
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/c1d40a52.failed

Despite supporting modern SCSI features some storage devices continue to
claim conformance to an older version of the SPC spec. This is done for
compatibility with legacy operating systems.

Linux by default will not attempt to read VPD pages on devices that
claim SPC-2 or older. Introduce a blacklist flag that can be used to
trigger VPD page inquiries on devices that are known to support them.

	Reported-by: KY Srinivasan <kys@microsoft.com>
	Tested-by: KY Srinivasan <kys@microsoft.com>
	Reviewed-by: KY Srinivasan <kys@microsoft.com>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
CC: <stable@vger.kernel.org>
	Signed-off-by: Christoph Hellwig <hch@lst.de>
(cherry picked from commit c1d40a527e885a40bb9ea6c46a1b1145d42b66a0)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	include/scsi/scsi_devinfo.h
diff --cc include/scsi/scsi_devinfo.h
index 7f7ec7fe9e11,1fdd6fc5492b..000000000000
--- a/include/scsi/scsi_devinfo.h
+++ b/include/scsi/scsi_devinfo.h
@@@ -32,7 -32,7 +32,13 @@@
  #define BLIST_ATTACH_PQ3	0x1000000 /* Scan: Attach to PQ3 devices */
  #define BLIST_NO_DIF		0x2000000 /* Disable T10 PI (DIF) */
  #define BLIST_SKIP_VPD_PAGES	0x4000000 /* Ignore SBC-3 VPD pages */
++<<<<<<< HEAD
 +
 +#define BLIST_NO_RSOC		0x20000000 /* don't try to issue RSOC */
 +
++=======
+ #define BLIST_SCSI3LUN		0x8000000 /* Scan more than 256 LUNs
+ 					     for sequential scan */
+ #define BLIST_TRY_VPD_PAGES	0x10000000 /* Attempt to read VPD pages */
++>>>>>>> c1d40a527e88 (scsi: add a blacklist flag which enables VPD page inquiries)
  #endif
diff --git a/drivers/scsi/scsi_scan.c b/drivers/scsi/scsi_scan.c
index 4ca174a5f3b7..6fcdcc6b6eb0 100644
--- a/drivers/scsi/scsi_scan.c
+++ b/drivers/scsi/scsi_scan.c
@@ -952,7 +952,9 @@ static int scsi_add_lun(struct scsi_device *sdev, unsigned char *inq_result,
 
 	sdev->eh_timeout = SCSI_DEFAULT_EH_TIMEOUT;
 
-	if (*bflags & BLIST_SKIP_VPD_PAGES)
+	if (*bflags & BLIST_TRY_VPD_PAGES)
+		sdev->try_vpd_pages = 1;
+	else if (*bflags & BLIST_SKIP_VPD_PAGES)
 		sdev->skip_vpd_pages = 1;
 
 	transport_configure_device(&sdev->sdev_gendev);
diff --git a/drivers/scsi/sd.c b/drivers/scsi/sd.c
index f531f3e9f348..b301eb4466cc 100644
--- a/drivers/scsi/sd.c
+++ b/drivers/scsi/sd.c
@@ -2795,6 +2795,11 @@ static void sd_read_write_same(struct scsi_disk *sdkp, unsigned char *buffer)
 
 static int sd_try_extended_inquiry(struct scsi_device *sdp)
 {
+	/* Attempt VPD inquiry if the device blacklist explicitly calls
+	 * for it.
+	 */
+	if (sdp->try_vpd_pages)
+		return 1;
 	/*
 	 * Although VPD inquiries can go to SCSI-2 type devices,
 	 * some USB ones crash on receiving them, and the pages
diff --git a/include/scsi/scsi_device.h b/include/scsi/scsi_device.h
index 71ecad6d91eb..c8a5332299b5 100644
--- a/include/scsi/scsi_device.h
+++ b/include/scsi/scsi_device.h
@@ -151,6 +151,7 @@ struct scsi_device {
 	unsigned skip_ms_page_8:1;	/* do not use MODE SENSE page 0x08 */
 	unsigned skip_ms_page_3f:1;	/* do not use MODE SENSE page 0x3f */
 	unsigned skip_vpd_pages:1;	/* do not read VPD pages */
+	unsigned try_vpd_pages:1;	/* attempt to read VPD pages */
 	unsigned use_192_bytes_for_3f:1; /* ask for 192 bytes from page 0x3f */
 	unsigned no_start_on_add:1;	/* do not issue start on add */
 	unsigned allow_restart:1; /* issue START_UNIT in error handler */
* Unmerged path include/scsi/scsi_devinfo.h
