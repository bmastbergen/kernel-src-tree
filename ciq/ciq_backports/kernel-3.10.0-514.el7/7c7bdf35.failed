netfilter: nfnetlink: use original skbuff when acking batches

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Pablo Neira Ayuso <pablo@netfilter.org>
commit 7c7bdf35991bb8f7cfaeaf22ea3a2f2d1967c166
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/7c7bdf35.failed

Since bd678e09dc17 ("netfilter: nfnetlink: fix splat due to incorrect
socket memory accounting in skbuff clones"), we don't manually attach
the sk to the skbuff clone anymore, so we have to use the original
skbuff from netlink_ack() which needs to access the sk pointer.

Fixes: bd678e09dc17 ("netfilter: nfnetlink: fix splat due to incorrect socket memory accounting in skbuff clones")
	Reported-by: Dmitry Vyukov <dvyukov@google.com>
	Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
(cherry picked from commit 7c7bdf35991bb8f7cfaeaf22ea3a2f2d1967c166)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/netfilter/nfnetlink.c
diff --cc net/netfilter/nfnetlink.c
index a07c12f430c3,62e92af2384a..000000000000
--- a/net/netfilter/nfnetlink.c
+++ b/net/netfilter/nfnetlink.c
@@@ -302,8 -311,8 +302,13 @@@ replay
  #endif
  		{
  			nfnl_unlock(subsys_id);
++<<<<<<< HEAD
 +			netlink_ack(skb, nlh, -EOPNOTSUPP);
 +			return kfree_skb(nskb);
++=======
+ 			netlink_ack(oskb, nlh, -EOPNOTSUPP);
+ 			return kfree_skb(skb);
++>>>>>>> 7c7bdf35991b (netfilter: nfnetlink: use original skbuff when acking batches)
  		}
  	}
  
@@@ -399,8 -406,8 +404,13 @@@ ack
  				 * pointing to the batch header.
  				 */
  				nfnl_err_reset(&err_list);
++<<<<<<< HEAD
 +				netlink_ack(skb, nlmsg_hdr(oskb), -ENOMEM);
 +				success = false;
++=======
+ 				netlink_ack(oskb, nlmsg_hdr(oskb), -ENOMEM);
+ 				status |= NFNL_BATCH_FAILURE;
++>>>>>>> 7c7bdf35991b (netfilter: nfnetlink: use original skbuff when acking batches)
  				goto done;
  			}
  			/* We don't stop processing the batch on errors, thus,
* Unmerged path net/netfilter/nfnetlink.c
