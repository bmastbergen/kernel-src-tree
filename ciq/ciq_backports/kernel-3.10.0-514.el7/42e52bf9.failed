net: add netnotifier event for upper device change

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
Rebuild_CHGLOG: - [net] add netnotifier event for upper device change (Ivan Vecera) [1268334]
Rebuild_FUZZ: 94.74%
commit-author Jiri Pirko <jiri@resnulli.us>
commit 42e52bf9e3ae80fd44b21ddfcd64c54e6db2ff76
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/42e52bf9.failed

Now when upper device is changed, event is not propagated via RT Netlink
to userspace. Userspace might never now about the change. Fix this by
adding upper-device-change notifier event.

	Signed-off-by: Jiri Pirko <jiri@resnulli.us>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 42e52bf9e3ae80fd44b21ddfcd64c54e6db2ff76)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	include/linux/netdevice.h
diff --cc include/linux/netdevice.h
index 7b10147de03d,ea7b6bce9ea0..000000000000
--- a/include/linux/netdevice.h
+++ b/include/linux/netdevice.h
@@@ -1944,12 -1593,11 +1944,16 @@@ struct pcpu_sw_netstats 
  #define NETDEV_RELEASE		0x0012
  #define NETDEV_NOTIFY_PEERS	0x0013
  #define NETDEV_JOIN		0x0014
++<<<<<<< HEAD
 +#define NETDEV_RESEND_IGMP	0x0016
 +#define NETDEV_CHANGEINFODATA	0x0018
++=======
+ #define NETDEV_CHANGEUPPER	0x0015
++>>>>>>> 42e52bf9e3ae (net: add netnotifier event for upper device change)
  
 -extern int register_netdevice_notifier(struct notifier_block *nb);
 -extern int unregister_netdevice_notifier(struct notifier_block *nb);
 -extern int call_netdevice_notifiers(unsigned long val, struct net_device *dev);
 +int register_netdevice_notifier(struct notifier_block *nb);
 +int unregister_netdevice_notifier(struct notifier_block *nb);
 +int call_netdevice_notifiers(unsigned long val, struct net_device *dev);
  
  
  extern rwlock_t				dev_base_lock;		/* Device list lock */
* Unmerged path include/linux/netdevice.h
diff --git a/net/core/dev.c b/net/core/dev.c
index c72ba088d17f..7eec52447cae 100644
--- a/net/core/dev.c
+++ b/net/core/dev.c
@@ -4659,7 +4659,7 @@ static int __netdev_upper_dev_link(struct net_device *dev,
 	else
 		list_add_tail_rcu(&upper->list, &dev->upper_dev_list);
 	dev_hold(upper_dev);
-
+	call_netdevice_notifiers(NETDEV_CHANGEUPPER, dev);
 	return 0;
 }
 
@@ -4719,6 +4719,7 @@ void netdev_upper_dev_unlink(struct net_device *dev,
 	list_del_rcu(&upper->list);
 	dev_put(upper_dev);
 	kfree_rcu(upper, rcu);
+	call_netdevice_notifiers(NETDEV_CHANGEUPPER, dev);
 }
 EXPORT_SYMBOL(netdev_upper_dev_unlink);
 
