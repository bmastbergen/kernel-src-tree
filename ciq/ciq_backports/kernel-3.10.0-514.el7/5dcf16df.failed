perf machine: Pass correct string to dso__adjust_kmod_long_name

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Wang Nan <wangnan0@huawei.com>
commit 5dcf16df3ce48b2e4f798b1a11b5de2fc3cfd73a
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/5dcf16df.failed

There's a mistake in dso__adjust_kmod_long_name() that it use strdup()
to dup the new long_name of a dso, but passes the original string to
dso__set_long_name(). Which causes random crash during cleanup.

	Signed-off-by: Wang Nan <wangnan0@huawei.com>
	Reviewed-by: Masami Hiramatsu <masami.hiramatsu.pt@hitachi.com>
	Cc: Namhyung Kim <namhyung@kernel.org>
	Cc: Zefan Li <lizefan@huawei.com>
	Cc: pi3orama@163.com
Fixes: c03d5184f0e9 ("perf machine: Adjust dso->long_name for offline module")
Link: http://lkml.kernel.org/r/1449455785-42020-1-git-send-email-wangnan0@huawei.com
	Signed-off-by: Arnaldo Carvalho de Melo <acme@redhat.com>
(cherry picked from commit 5dcf16df3ce48b2e4f798b1a11b5de2fc3cfd73a)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/perf/util/machine.c
diff --cc tools/perf/util/machine.c
index 3b242a076016,bfc289c73c22..000000000000
--- a/tools/perf/util/machine.c
+++ b/tools/perf/util/machine.c
@@@ -553,6 -553,32 +553,35 @@@ int machine__process_itrace_start_event
  	return 0;
  }
  
++<<<<<<< HEAD
++=======
+ int machine__process_switch_event(struct machine *machine __maybe_unused,
+ 				  union perf_event *event)
+ {
+ 	if (dump_trace)
+ 		perf_event__fprintf_switch(event, stdout);
+ 	return 0;
+ }
+ 
+ static void dso__adjust_kmod_long_name(struct dso *dso, const char *filename)
+ {
+ 	const char *dup_filename;
+ 
+ 	if (!filename || !dso || !dso->long_name)
+ 		return;
+ 	if (dso->long_name[0] != '[')
+ 		return;
+ 	if (!strchr(filename, '/'))
+ 		return;
+ 
+ 	dup_filename = strdup(filename);
+ 	if (!dup_filename)
+ 		return;
+ 
+ 	dso__set_long_name(dso, dup_filename, true);
+ }
+ 
++>>>>>>> 5dcf16df3ce4 (perf machine: Pass correct string to dso__adjust_kmod_long_name)
  struct map *machine__findnew_module_map(struct machine *machine, u64 start,
  					const char *filename)
  {
* Unmerged path tools/perf/util/machine.c
