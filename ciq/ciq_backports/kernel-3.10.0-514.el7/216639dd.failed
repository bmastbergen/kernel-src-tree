libceph: a couple tweaks for wait loops

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Ilya Dryomov <idryomov@gmail.com>
commit 216639dd5091de4f4d7ad19b0b8dde11fad18286
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/216639dd.failed

- return -ETIMEDOUT instead of -EIO in case of timeout
- wait_event_interruptible_timeout() returns time left until timeout
  and since it can be almost LONG_MAX we had better assign it to long

	Signed-off-by: Ilya Dryomov <idryomov@gmail.com>
	Reviewed-by: Alex Elder <elder@linaro.org>
(cherry picked from commit 216639dd5091de4f4d7ad19b0b8dde11fad18286)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/ceph/ceph_common.c
diff --cc net/ceph/ceph_common.c
index 79e8f71aef5b,925d0c890b80..000000000000
--- a/net/ceph/ceph_common.c
+++ b/net/ceph/ceph_common.c
@@@ -626,8 -647,8 +626,13 @@@ static int have_mon_and_osd_map(struct 
   */
  int __ceph_open_session(struct ceph_client *client, unsigned long started)
  {
++<<<<<<< HEAD
 +	int err;
 +	unsigned long timeout = client->options->mount_timeout * HZ;
++=======
+ 	unsigned long timeout = client->options->mount_timeout;
+ 	long err;
++>>>>>>> 216639dd5091 (libceph: a couple tweaks for wait loops)
  
  	/* open session, and wait for mon and osd maps */
  	err = ceph_monc_open_session(&client->monc);
@@@ -643,8 -663,8 +647,13 @@@
  		dout("mount waiting for mon_map\n");
  		err = wait_event_interruptible_timeout(client->auth_wq,
  			have_mon_and_osd_map(client) || (client->auth_err < 0),
++<<<<<<< HEAD
 +			timeout);
 +		if (err == -EINTR || err == -ERESTARTSYS)
++=======
+ 			ceph_timeout_jiffies(timeout));
+ 		if (err < 0)
++>>>>>>> 216639dd5091 (libceph: a couple tweaks for wait loops)
  			return err;
  		if (client->auth_err < 0)
  			return client->auth_err;
* Unmerged path net/ceph/ceph_common.c
diff --git a/net/ceph/mon_client.c b/net/ceph/mon_client.c
index 2b3cf05e87b0..241a8cdfe65d 100644
--- a/net/ceph/mon_client.c
+++ b/net/ceph/mon_client.c
@@ -302,7 +302,7 @@ int ceph_monc_wait_osdmap(struct ceph_mon_client *monc, u32 epoch,
 			  unsigned long timeout)
 {
 	unsigned long started = jiffies;
-	int ret;
+	long ret;
 
 	mutex_lock(&monc->mutex);
 	while (monc->have_osdmap < epoch) {
