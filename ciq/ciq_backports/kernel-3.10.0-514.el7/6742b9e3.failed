netfilter: nfnetlink: keep going batch handling on missing modules

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Pablo Neira Ayuso <pablo@netfilter.org>
commit 6742b9e310bcf511b876532846e5302b07b7fedc
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/6742b9e3.failed

After a fresh boot with no modules in place at all and a large rulesets, the
existing nfnetlink_rcv_batch() funcion can take long time to commit the ruleset
due to the many abort path. This is specifically a problem for the existing
client of this code, ie. nf_tables, since it results in several
synchronize_rcu() call in a row.

This patch changes the policy to keep full batch processing on missing modules
errors so we abort only once.

	Reported-by: Eric Leblond <eric@regit.org>
	Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
(cherry picked from commit 6742b9e310bcf511b876532846e5302b07b7fedc)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/netfilter/nfnetlink.c
diff --cc net/netfilter/nfnetlink.c
index 158c193cef9a,0c0e8ecf02ab..000000000000
--- a/net/netfilter/nfnetlink.c
+++ b/net/netfilter/nfnetlink.c
@@@ -281,12 -289,13 +287,19 @@@ static void nfnetlink_rcv_batch(struct 
  	if (subsys_id >= NFNL_SUBSYS_COUNT)
  		return netlink_ack(skb, nlh, -EINVAL);
  replay:
++<<<<<<< HEAD
 +	nskb = netlink_skb_clone(oskb, GFP_KERNEL);
 +	if (!nskb)
++=======
+ 	status = 0;
+ 
+ 	skb = netlink_skb_clone(oskb, GFP_KERNEL);
+ 	if (!skb)
++>>>>>>> 6742b9e310bc (netfilter: nfnetlink: keep going batch handling on missing modules)
  		return netlink_ack(oskb, nlh, -ENOMEM);
  
 -	skb->sk = oskb->sk;
 +	nskb->sk = oskb->sk;
 +	skb = nskb;
  
  	nfnl_lock(subsys_id);
  	ss = rcu_dereference_protected(table[subsys_id].subsys,
@@@ -380,11 -390,8 +393,16 @@@
  			 * original skb.
  			 */
  			if (err == -EAGAIN) {
++<<<<<<< HEAD
 +				nfnl_err_reset(&err_list);
 +				ss->abort(skb);
 +				nfnl_unlock(subsys_id);
 +				kfree_skb(nskb);
 +				goto replay;
++=======
+ 				status |= NFNL_BATCH_REPLAY;
+ 				goto next;
++>>>>>>> 6742b9e310bc (netfilter: nfnetlink: keep going batch handling on missing modules)
  			}
  		}
  ack:
@@@ -417,10 -424,17 +435,24 @@@ next
  		skb_pull(skb, msglen);
  	}
  done:
++<<<<<<< HEAD
 +	if (success && done)
 +		ss->commit(skb);
 +	else
 +		ss->abort(skb);
++=======
+ 	if (status & NFNL_BATCH_REPLAY) {
+ 		ss->abort(oskb);
+ 		nfnl_err_reset(&err_list);
+ 		nfnl_unlock(subsys_id);
+ 		kfree_skb(skb);
+ 		goto replay;
+ 	} else if (status == NFNL_BATCH_DONE) {
+ 		ss->commit(oskb);
+ 	} else {
+ 		ss->abort(oskb);
+ 	}
++>>>>>>> 6742b9e310bc (netfilter: nfnetlink: keep going batch handling on missing modules)
  
  	nfnl_err_deliver(&err_list, oskb);
  	nfnl_unlock(subsys_id);
* Unmerged path net/netfilter/nfnetlink.c
