megaraid_sas: Make tape drives visible on PERC5 controllers

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Sumit Saxena <sumit.saxena@avagotech.com>
commit aed335eecf8f09c28588b01c7f7e24ee78156e28
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/aed335ee.failed

The DELL PERC5 controller firmware does not list tape drives in response
to MR_DCMD_PD_LIST_QUERY. This causes tape drives not be exposed to the
OS when connected to a PERC5 controller.

This patch permits detection of tape drives connected to a PERC5
controller by exposing non-TYPE_DISK devices unconditionally.

	Signed-off-by: Kashyap Desai <kashyap.desai@avagotech.com>
	Signed-off-by: Sumit Saxena <sumit.saxena@avagotech.com>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit aed335eecf8f09c28588b01c7f7e24ee78156e28)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/megaraid/megaraid_sas_base.c
diff --cc drivers/scsi/megaraid/megaraid_sas_base.c
index b60f8ef53c66,6efab726edbf..000000000000
--- a/drivers/scsi/megaraid/megaraid_sas_base.c
+++ b/drivers/scsi/megaraid/megaraid_sas_base.c
@@@ -1749,10 -1760,24 +1749,24 @@@ static void megasas_set_dma_alignment(s
  
  static int megasas_slave_configure(struct scsi_device *sdev)
  {
+ 	u16 pd_index = 0;
+ 	struct megasas_instance *instance;
+ 
+ 	instance = megasas_lookup_instance(sdev->host->host_no);
+ 	if (instance->allow_fw_scan) {
+ 		if (sdev->channel < MEGASAS_MAX_PD_CHANNELS &&
+ 			sdev->type == TYPE_DISK) {
+ 			pd_index = (sdev->channel * MEGASAS_MAX_DEV_PER_CHANNEL) +
+ 				sdev->id;
+ 			if (instance->pd_list[pd_index].driveState !=
+ 				MR_PD_STATE_SYSTEM)
+ 				return -ENXIO;
+ 		}
+ 	}
  	megasas_set_dma_alignment(sdev);
  	/*
 -	 * The RAID firmware may require extended timeouts.
 -	 */
 +	* The RAID firmware may require extended timeouts.
 +	*/
  	blk_queue_rq_timeout(sdev->request_queue,
  		MEGASAS_DEFAULT_CMD_TIMEOUT * HZ);
  
@@@ -1771,9 -1797,9 +1785,15 @@@ static int megasas_slave_alloc(struct s
  		pd_index =
  			(sdev->channel * MEGASAS_MAX_DEV_PER_CHANNEL) +
  			sdev->id;
++<<<<<<< HEAD
 +		if (instance->pd_list[pd_index].driveState ==
 +					MR_PD_STATE_SYSTEM) {
 +			goto scan_target;
++=======
+ 		if ((instance->allow_fw_scan || instance->pd_list[pd_index].driveState ==
+ 			MR_PD_STATE_SYSTEM)) {
+ 			return 0;
++>>>>>>> aed335eecf8f (megaraid_sas: Make tape drives visible on PERC5 controllers)
  		}
  		return -ENXIO;
  	}
diff --git a/drivers/scsi/megaraid/megaraid_sas.h b/drivers/scsi/megaraid/megaraid_sas.h
index d4c399b43165..20a6220c58f9 100644
--- a/drivers/scsi/megaraid/megaraid_sas.h
+++ b/drivers/scsi/megaraid/megaraid_sas.h
@@ -1790,6 +1790,7 @@ struct megasas_instance {
 	u8 UnevenSpanSupport;
 
 	u8 supportmax256vd;
+	u8 allow_fw_scan;
 	u16 fw_supported_vd_count;
 	u16 fw_supported_pd_count;
 
* Unmerged path drivers/scsi/megaraid/megaraid_sas_base.c
