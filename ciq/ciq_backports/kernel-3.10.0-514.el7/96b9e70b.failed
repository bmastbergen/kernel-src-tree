perf build: Introduce FEATURES_DUMP make variable

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Jiri Olsa <jolsa@kernel.org>
commit 96b9e70b8e6cd65f71ee71889143976f3afb038a
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/96b9e70b.failed

Introducing FEATURES_DUMP make variable to provide features
detection dump file and bypass the feature detection.

The intention is to use this during build tests to skip
repeated features detection, like:

Get feature dump static build into /tmp/fd file:
  $ make feature-dump FEATURE_DUMP_COPY=/tmp/fd LDFLAGS=-static
    BUILD:   Doing 'make -j4' parallel build

  Auto-detecting system features:
  ...                         dwarf: [ OFF ]

  SNIP

  FEATURE-DUMP file copied into /tmp/fd

Use /tmp/fd to build perf:
  $ make FEATURES_DUMP=/tmp/fd LDFLAGS=-static

  $ file perf
  perf: ELF 64-bit LSB executable, x86-64, version 1 (GNU/Linux), statically linked, for ...

	Suggested-by: Wang Nan <wangnan0@huawei.com>
	Signed-off-by: Jiri Olsa <jolsa@kernel.org>
	Tested-by: Arnaldo Carvalho de Melo <acme@redhat.com>
	Cc: Zefan Li <lizefan@huawei.com>
	Cc: pi3orama@163.com
Link: http://lkml.kernel.org/r/1452830421-77757-7-git-send-email-wangnan0@huawei.com
	Signed-off-by: Arnaldo Carvalho de Melo <acme@redhat.com>
(cherry picked from commit 96b9e70b8e6cd65f71ee71889143976f3afb038a)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/perf/Makefile.perf
diff --cc tools/perf/Makefile.perf
index 06fbc6ebdc3d,5d34815c7ccb..000000000000
--- a/tools/perf/Makefile.perf
+++ b/tools/perf/Makefile.perf
@@@ -75,6 -75,11 +75,14 @@@ include config/utilities.ma
  # Define NO_LZMA if you do not want to support compressed (xz) kernel modules
  #
  # Define NO_AUXTRACE if you do not want AUX area tracing support
++<<<<<<< HEAD
++=======
+ #
+ # Define NO_LIBBPF if you do not want BPF support
+ #
+ # Define FEATURES_DUMP to provide features detection dump file
+ # and bypass the feature detection
++>>>>>>> 96b9e70b8e6c (perf build: Introduce FEATURES_DUMP make variable)
  
  # As per kernel Makefile, avoid funny character set dependencies
  unexport LC_ALL
@@@ -420,6 -447,20 +437,23 @@@ $(LIBAPI)-clean
  	$(call QUIET_CLEAN, libapi)
  	$(Q)$(MAKE) -C $(LIB_DIR) O=$(OUTPUT) clean >/dev/null
  
++<<<<<<< HEAD
++=======
+ $(LIBBPF): fixdep FORCE
+ 	$(Q)$(MAKE) -C $(BPF_DIR) O=$(OUTPUT) $(OUTPUT)libbpf.a FEATURES_DUMP=$(FEATURE_DUMP_EXPORT)
+ 
+ $(LIBBPF)-clean:
+ 	$(call QUIET_CLEAN, libbpf)
+ 	$(Q)$(MAKE) -C $(BPF_DIR) O=$(OUTPUT) clean >/dev/null
+ 
+ $(LIBSUBCMD): fixdep FORCE
+ 	$(Q)$(MAKE) -C $(SUBCMD_DIR) O=$(OUTPUT) $(OUTPUT)libsubcmd.a
+ 
+ $(LIBSUBCMD)-clean:
+ 	$(call QUIET_CLEAN, libsubcmd)
+ 	$(Q)$(MAKE) -C $(SUBCMD_DIR) O=$(OUTPUT) clean
+ 
++>>>>>>> 96b9e70b8e6c (perf build: Introduce FEATURES_DUMP make variable)
  help:
  	@echo 'Perf make targets:'
  	@echo '  doc		- make *all* documentation (see below)'
* Unmerged path tools/perf/Makefile.perf
diff --git a/tools/perf/config/Makefile b/tools/perf/config/Makefile
index 94735310e78e..f3765043678e 100644
--- a/tools/perf/config/Makefile
+++ b/tools/perf/config/Makefile
@@ -180,7 +180,11 @@ LDFLAGS += -Wl,-z,noexecstack
 
 EXTLIBS = -lpthread -lrt -lm -ldl
 
+ifeq ($(FEATURES_DUMP),)
 include $(srctree)/tools/build/Makefile.feature
+else
+include $(FEATURES_DUMP)
+endif
 
 ifeq ($(feature-stackprotector-all), 1)
   CFLAGS += -fstack-protector-all
