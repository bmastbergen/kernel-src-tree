scsi: fix the type for well known LUs

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
Rebuild_CHGLOG: - [scsi] fix the type for well known LUs (Ewan Milne) [1292896]
Rebuild_FUZZ: 91.18%
commit-author Subhash Jadavani <subhashj@codeaurora.org>
commit 45341ca3fcacc8720c425e757a627ef81b65b1ee
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/45341ca3.failed

Some devices may respond with wrong type for well-known logical units.
This patch forces well-known type for devices which doesn't report it
correct.

	Signed-off-by: Subhash Jadavani <subhashj@codeaurora.org>
	Signed-off-by: Sujit Reddy Thumma <sthumma@codeaurora.org>
	Signed-off-by: Dolev Raviv <draviv@codeaurora.org>
	Signed-off-by: Christoph Hellwig <hch@lst.de>
(cherry picked from commit 45341ca3fcacc8720c425e757a627ef81b65b1ee)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	include/scsi/scsi.h
diff --cc include/scsi/scsi.h
index 4572ec7712f7,d17178e6fcdd..000000000000
--- a/include/scsi/scsi.h
+++ b/include/scsi/scsi.h
@@@ -339,6 -332,8 +339,11 @@@ static inline int scsi_status_is_good(i
  #define TYPE_ENCLOSURE      0x0d    /* Enclosure Services Device */
  #define TYPE_RBC	    0x0e
  #define TYPE_OSD            0x11
++<<<<<<< HEAD
++=======
+ #define TYPE_ZBC            0x14
+ #define TYPE_WLUN           0x1e    /* well-known logical unit */
++>>>>>>> 45341ca3fcac (scsi: fix the type for well known LUs)
  #define TYPE_NO_LUN         0x7f
  
  /* SCSI protocols; these are taken from SPC-3 section 7.5 */
diff --git a/drivers/scsi/scsi_scan.c b/drivers/scsi/scsi_scan.c
index 4ca174a5f3b7..cda3274a22e9 100644
--- a/drivers/scsi/scsi_scan.c
+++ b/drivers/scsi/scsi_scan.c
@@ -799,6 +799,19 @@ static int scsi_add_lun(struct scsi_device *sdev, unsigned char *inq_result,
 	} else {
 		sdev->type = (inq_result[0] & 0x1f);
 		sdev->removable = (inq_result[1] & 0x80) >> 7;
+
+		/*
+		 * some devices may respond with wrong type for
+		 * well-known logical units. Force well-known type
+		 * to enumerate them correctly.
+		 */
+		if (scsi_is_wlun(sdev->lun) && sdev->type != TYPE_WLUN) {
+			sdev_printk(KERN_WARNING, sdev,
+				"%s: correcting incorrect peripheral device type 0x%x for W-LUN 0x%16xhN\n",
+				__func__, sdev->type, (unsigned int)sdev->lun);
+			sdev->type = TYPE_WLUN;
+		}
+
 	}
 
 	switch (sdev->type) {
* Unmerged path include/scsi/scsi.h
