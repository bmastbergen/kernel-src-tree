objtool: Detect and warn if libelf is missing and don't break the build

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
Rebuild_CHGLOG: - [scripts] revert "objtool: Detect and warn if libelf is missing and don't break the build" (Josh Poimboeuf) [1347232]
Rebuild_FUZZ: 93.42%
commit-author Josh Poimboeuf <jpoimboe@redhat.com>
commit 3b27a0c85d7068130ed8e3977a2e977ade986841
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/3b27a0c8.failed

With CONFIG_STACK_VALIDATION enabled, if the host system doesn't have
a development version of libelf installed, the build fails with errors
like:

  elf.h:22:18: fatal error: gelf.h: No such file or directory compilation terminated.

Instead of failing to build, instead just print a warning and disable
stack validation.

	Signed-off-by: Josh Poimboeuf <jpoimboe@redhat.com>
	Cc: Andrew Morton <akpm@linux-foundation.org>
	Cc: Linus Torvalds <torvalds@linux-foundation.org>
	Cc: Peter Zijlstra <peterz@infradead.org>
	Cc: Stephen Rothwell <sfr@canb.auug.org.au>
	Cc: Sudip Mukherjee <sudipm.mukherjee@gmail.com>
	Cc: Thomas Gleixner <tglx@linutronix.de>
	Cc: linux-next@vger.kernel.org
	Cc: linux@roeck-us.net
	Cc: live-patching@vger.kernel.org
Link: http://lkml.kernel.org/r/8c27fe00face60f42e888ddb3142c97e45223165.1457026550.git.jpoimboe@redhat.com
	Signed-off-by: Ingo Molnar <mingo@kernel.org>
(cherry picked from commit 3b27a0c85d7068130ed8e3977a2e977ade986841)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	Makefile
#	scripts/Makefile.build
diff --cc Makefile
index 9bf0ea111cf7,60b729540785..000000000000
--- a/Makefile
+++ b/Makefile
@@@ -884,7 -993,21 +884,25 @@@ prepare0: archprepare FORC
  	$(Q)$(MAKE) $(build)=.
  
  # All the preparing..
++<<<<<<< HEAD
 +prepare: prepare0
++=======
+ prepare: prepare0 prepare-objtool
+ 
+ ifdef CONFIG_STACK_VALIDATION
+   has_libelf := $(shell echo "int main() {}" | $(HOSTCC) -xc -o /dev/null -lelf - &> /dev/null && echo 1 || echo 0)
+   ifeq ($(has_libelf),1)
+     objtool_target := tools/objtool FORCE
+   else
+     $(warning "Cannot use CONFIG_STACK_VALIDATION, please install libelf-dev or elfutils-libelf-devel")
+     SKIP_STACK_VALIDATION := 1
+     export SKIP_STACK_VALIDATION
+   endif
+ endif
+ 
+ PHONY += prepare-objtool
+ prepare-objtool: $(objtool_target)
++>>>>>>> 3b27a0c85d70 (objtool: Detect and warn if libelf is missing and don't break the build)
  
  # Generate some files
  # ---------------------------------------------------------------------------
diff --cc scripts/Makefile.build
index d5d859c80729,e1bc1907090e..000000000000
--- a/scripts/Makefile.build
+++ b/scripts/Makefile.build
@@@ -291,6 -241,29 +291,32 @@@ cmd_record_mcount = 						
  	fi;
  endif
  
++<<<<<<< HEAD
++=======
+ ifdef CONFIG_STACK_VALIDATION
+ ifneq ($(SKIP_STACK_VALIDATION),1)
+ 
+ __objtool_obj := $(objtree)/tools/objtool/objtool
+ 
+ objtool_args = check
+ ifndef CONFIG_FRAME_POINTER
+ objtool_args += --no-fp
+ endif
+ 
+ # 'OBJECT_FILES_NON_STANDARD := y': skip objtool checking for a directory
+ # 'OBJECT_FILES_NON_STANDARD_foo.o := 'y': skip objtool checking for a file
+ # 'OBJECT_FILES_NON_STANDARD_foo.o := 'n': override directory skip for a file
+ cmd_objtool = $(if $(patsubst y%,, \
+ 	$(OBJECT_FILES_NON_STANDARD_$(basetarget).o)$(OBJECT_FILES_NON_STANDARD)n), \
+ 	$(__objtool_obj) $(objtool_args) "$(@)";)
+ objtool_obj = $(if $(patsubst y%,, \
+ 	$(OBJECT_FILES_NON_STANDARD_$(basetarget).o)$(OBJECT_FILES_NON_STANDARD)n), \
+ 	$(__objtool_obj))
+ 
+ endif # SKIP_STACK_VALIDATION
+ endif # CONFIG_STACK_VALIDATION
+ 
++>>>>>>> 3b27a0c85d70 (objtool: Detect and warn if libelf is missing and don't break the build)
  define rule_cc_o_c
  	$(call echo-cmd,checksrc) $(cmd_checksrc)			  \
  	$(call echo-cmd,cc_o_c) $(cmd_cc_o_c);				  \
* Unmerged path Makefile
* Unmerged path scripts/Makefile.build
