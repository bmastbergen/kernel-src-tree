vxlan: do not use fdb in metadata mode

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Jiri Benc <jbenc@redhat.com>
commit f468a729a2ddb1a26f8c4b98a82050e4030fe458
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/f468a729.failed

In metadata mode, the vxlan interface is not supposed to use the fdb control
plane but an external one (openvswitch or static routes). With the current
code, packets may leak into the fdb handling code which usually causes them
to be dropped anyway but may have strange side effects.

Just drop the packets directly when in metadata mode if the destination data
are not correctly provided on egress.

	Signed-off-by: Jiri Benc <jbenc@redhat.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit f468a729a2ddb1a26f8c4b98a82050e4030fe458)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/vxlan.c
diff --cc drivers/net/vxlan.c
index 000e4c57a81e,e6944b29588e..000000000000
--- a/drivers/net/vxlan.c
+++ b/drivers/net/vxlan.c
@@@ -2071,6 -2171,14 +2071,17 @@@ static netdev_tx_t vxlan_xmit(struct sk
  #endif
  	}
  
++<<<<<<< HEAD
++=======
+ 	if (vxlan->flags & VXLAN_F_COLLECT_METADATA) {
+ 		if (info && info->mode & IP_TUNNEL_INFO_TX)
+ 			vxlan_xmit_one(skb, dev, NULL, false);
+ 		else
+ 			kfree_skb(skb);
+ 		return NETDEV_TX_OK;
+ 	}
+ 
++>>>>>>> f468a729a2dd (vxlan: do not use fdb in metadata mode)
  	f = vxlan_find_mac(vxlan, eth->h_dest);
  	did_rsc = false;
  
* Unmerged path drivers/net/vxlan.c
