acpi: Add acpi_map_pxm_to_online_node()

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Toshi Kani <toshi.kani@hp.com>
commit 99759869faf15471cfce251bc138848d8af7d162
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/99759869.failed

The kernel initializes CPU & memory's NUMA topology from ACPI
SRAT table.  Some other ACPI tables, such as NFIT and DMAR, also
contain proximity IDs for their device's NUMA topology.  This
information can be used to improve performance of these devices.

This patch introduces acpi_map_pxm_to_online_node(), which is
similar to acpi_map_pxm_to_node(), but always returns an online
node.  When the mapped node from a given proximity ID is offline,
it looks up the node distance table and returns the nearest
online node.

ACPI device drivers, which are called after the NUMA initialization
has completed in the kernel, can call this interface to obtain their
device NUMA topology from ACPI tables.  Such drivers do not have to
deal with offline nodes.  A node may be offline when a device
proximity ID is unique, SRAT memory entry does not exist, or NUMA is
disabled, ex. "numa=off" on x86.

This patch also moves the pxm range check from acpi_get_node() to
acpi_map_pxm_to_node().

	Signed-off-by: Toshi Kani <toshi.kani@hp.com>
	Acked-by: Rafael J. Wysocki <rafael.j.wysocki@intel.com>>
	Signed-off-by: Dan Williams <dan.j.williams@intel.com>
(cherry picked from commit 99759869faf15471cfce251bc138848d8af7d162)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/acpi/numa.c
diff --cc drivers/acpi/numa.c
index 7ed4fa65b1b1,acaa3b4ea504..000000000000
--- a/drivers/acpi/numa.c
+++ b/drivers/acpi/numa.c
@@@ -29,7 -29,8 +29,12 @@@
  #include <linux/errno.h>
  #include <linux/acpi.h>
  #include <linux/numa.h>
++<<<<<<< HEAD
 +#include <acpi/acpi_bus.h>
++=======
+ #include <linux/nodemask.h>
+ #include <linux/topology.h>
++>>>>>>> 99759869faf1 (acpi: Add acpi_map_pxm_to_online_node())
  
  #define PREFIX "ACPI: "
  
* Unmerged path drivers/acpi/numa.c
diff --git a/include/linux/acpi.h b/include/linux/acpi.h
index b96328fc524b..8071d69561cd 100644
--- a/include/linux/acpi.h
+++ b/include/linux/acpi.h
@@ -255,8 +255,13 @@ extern void acpi_dmi_osi_linux(int enable, const struct dmi_system_id *d);
 extern void acpi_osi_setup(char *str);
 
 #ifdef CONFIG_ACPI_NUMA
+int acpi_map_pxm_to_online_node(int pxm);
 int acpi_get_node(acpi_handle handle);
 #else
+static inline int acpi_map_pxm_to_online_node(int pxm)
+{
+	return 0;
+}
 static inline int acpi_get_node(acpi_handle handle)
 {
 	return 0;
