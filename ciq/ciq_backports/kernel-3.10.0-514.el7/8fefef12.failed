IB/hfi1: Handle host handshake timeout

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Jubin John <jubin.john@intel.com>
commit 8fefef125ed4b9347068d782aa5439f3da3dca32
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/8fefef12.failed

Host handshake timeout can occur during the verify capability
state. This is a LNI related failure and should be
handled in the same way as other LNI failures.

	Reviewed-by: Dean Luick <dean.luick@intel.com>
	Reviewed-by: Easwar Hariharan <easwar.hariharan@intel.com>
	Reviewed-by: Mike Marciniszyn <mike.marciniszyn@intel.com>
	Signed-off-by: Jubin John <jubin.john@intel.com>
	Signed-off-by: Doug Ledford <dledford@redhat.com>
(cherry picked from commit 8fefef125ed4b9347068d782aa5439f3da3dca32)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/staging/hfi1/chip.h
diff --cc drivers/staging/hfi1/chip.h
index dc82815c53a0,4f3b878e43eb..000000000000
--- a/drivers/staging/hfi1/chip.h
+++ b/drivers/staging/hfi1/chip.h
@@@ -242,36 -241,37 +242,52 @@@
  #define HCMD_SUCCESS 2
  
  /* DC_DC8051_DBG_ERR_INFO_SET_BY_8051.ERROR - error flags */
++<<<<<<< HEAD:drivers/staging/hfi1/chip.h
 +#define SPICO_ROM_FAILED		    (1 <<  0)
 +#define UNKNOWN_FRAME		    (1 <<  1)
 +#define TARGET_BER_NOT_MET		    (1 <<  2)
 +#define FAILED_SERDES_INTERNAL_LOOPBACK (1 <<  3)
 +#define FAILED_SERDES_INIT		    (1 <<  4)
 +#define FAILED_LNI_POLLING		    (1 <<  5)
 +#define FAILED_LNI_DEBOUNCE		    (1 <<  6)
 +#define FAILED_LNI_ESTBCOMM		    (1 <<  7)
 +#define FAILED_LNI_OPTEQ		    (1 <<  8)
 +#define FAILED_LNI_VERIFY_CAP1	    (1 <<  9)
 +#define FAILED_LNI_VERIFY_CAP2	    (1 << 10)
 +#define FAILED_LNI_CONFIGLT		    (1 << 11)
++=======
+ #define SPICO_ROM_FAILED		BIT(0)
+ #define UNKNOWN_FRAME			BIT(1)
+ #define TARGET_BER_NOT_MET		BIT(2)
+ #define FAILED_SERDES_INTERNAL_LOOPBACK	BIT(3)
+ #define FAILED_SERDES_INIT		BIT(4)
+ #define FAILED_LNI_POLLING		BIT(5)
+ #define FAILED_LNI_DEBOUNCE		BIT(6)
+ #define FAILED_LNI_ESTBCOMM		BIT(7)
+ #define FAILED_LNI_OPTEQ		BIT(8)
+ #define FAILED_LNI_VERIFY_CAP1		BIT(9)
+ #define FAILED_LNI_VERIFY_CAP2		BIT(10)
+ #define FAILED_LNI_CONFIGLT		BIT(11)
+ #define HOST_HANDSHAKE_TIMEOUT		BIT(12)
++>>>>>>> 8fefef125ed4 (IB/hfi1: Handle host handshake timeout):drivers/staging/rdma/hfi1/chip.h
  
  #define FAILED_LNI (FAILED_LNI_POLLING | FAILED_LNI_DEBOUNCE \
  			| FAILED_LNI_ESTBCOMM | FAILED_LNI_OPTEQ \
  			| FAILED_LNI_VERIFY_CAP1 \
  			| FAILED_LNI_VERIFY_CAP2 \
- 			| FAILED_LNI_CONFIGLT)
+ 			| FAILED_LNI_CONFIGLT | HOST_HANDSHAKE_TIMEOUT)
  
  /* DC_DC8051_DBG_ERR_INFO_SET_BY_8051.HOST_MSG - host message flags */
 -#define HOST_REQ_DONE		BIT(0)
 -#define BC_PWR_MGM_MSG		BIT(1)
 -#define BC_SMA_MSG		BIT(2)
 -#define BC_BCC_UNKNOWN_MSG	BIT(3)
 -#define BC_IDLE_UNKNOWN_MSG	BIT(4)
 -#define EXT_DEVICE_CFG_REQ	BIT(5)
 -#define VERIFY_CAP_FRAME	BIT(6)
 -#define LINKUP_ACHIEVED		BIT(7)
 -#define LINK_GOING_DOWN		BIT(8)
 -#define LINK_WIDTH_DOWNGRADED	BIT(9)
 +#define HOST_REQ_DONE	   (1 << 0)
 +#define BC_PWR_MGM_MSG	   (1 << 1)
 +#define BC_SMA_MSG		   (1 << 2)
 +#define BC_BCC_UNKOWN_MSG	   (1 << 3)
 +#define BC_IDLE_UNKNOWN_MSG	   (1 << 4)
 +#define EXT_DEVICE_CFG_REQ	   (1 << 5)
 +#define VERIFY_CAP_FRAME	   (1 << 6)
 +#define LINKUP_ACHIEVED	   (1 << 7)
 +#define LINK_GOING_DOWN	   (1 << 8)
 +#define LINK_WIDTH_DOWNGRADED  (1 << 9)
  
  /* DC_DC8051_CFG_EXT_DEV_1.REQ_TYPE - 8051 host requests */
  #define HREQ_LOAD_CONFIG	0x01
diff --git a/drivers/staging/hfi1/chip.c b/drivers/staging/hfi1/chip.c
index cf871fab9b57..237409f1e38f 100644
--- a/drivers/staging/hfi1/chip.c
+++ b/drivers/staging/hfi1/chip.c
@@ -963,7 +963,8 @@ static struct flag_table dc8051_info_err_flags[] = {
 	FLAG_ENTRY0("Failed LNI(OptEq)",       FAILED_LNI_OPTEQ),
 	FLAG_ENTRY0("Failed LNI(VerifyCap_1)", FAILED_LNI_VERIFY_CAP1),
 	FLAG_ENTRY0("Failed LNI(VerifyCap_2)", FAILED_LNI_VERIFY_CAP2),
-	FLAG_ENTRY0("Failed LNI(ConfigLT)",    FAILED_LNI_CONFIGLT)
+	FLAG_ENTRY0("Failed LNI(ConfigLT)",    FAILED_LNI_CONFIGLT),
+	FLAG_ENTRY0("Host Handshake Timeout",  HOST_HANDSHAKE_TIMEOUT)
 };
 
 /*
* Unmerged path drivers/staging/hfi1/chip.h
