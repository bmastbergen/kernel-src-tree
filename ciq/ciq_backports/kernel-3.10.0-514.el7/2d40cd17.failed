ixgbe: Add support for SFPs with retimer

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Mark Rustad <mark.d.rustad@intel.com>
commit 2d40cd1720cb6eb4406b80866c08d97b92595dfe
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/2d40cd17.failed

Add support for SFPs with an external retimer.

	Signed-off-by: Mark Rustad <mark.d.rustad@intel.com>
	Tested-by: Andrew Bowers <andrewx.bowers@intel.com>
	Signed-off-by: Jeff Kirsher <jeffrey.t.kirsher@intel.com>
(cherry picked from commit 2d40cd1720cb6eb4406b80866c08d97b92595dfe)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/intel/ixgbe/ixgbe_main.c
#	drivers/net/ethernet/intel/ixgbe/ixgbe_x550.c
diff --cc drivers/net/ethernet/intel/ixgbe/ixgbe_main.c
index c49a5686fdd6,93db4bf00dfe..000000000000
--- a/drivers/net/ethernet/intel/ixgbe/ixgbe_main.c
+++ b/drivers/net/ethernet/intel/ixgbe/ixgbe_main.c
@@@ -134,6 -131,8 +134,11 @@@ static const struct pci_device_id ixgbe
  	{PCI_VDEVICE(INTEL, IXGBE_DEV_ID_X550EM_X_KR), board_X550EM_x},
  	{PCI_VDEVICE(INTEL, IXGBE_DEV_ID_X550EM_X_10G_T), board_X550EM_x},
  	{PCI_VDEVICE(INTEL, IXGBE_DEV_ID_X550EM_X_SFP), board_X550EM_x},
++<<<<<<< HEAD
++=======
+ 	{PCI_VDEVICE(INTEL, IXGBE_DEV_ID_X550EM_A_SFP_N), board_x550em_a },
+ 	{PCI_VDEVICE(INTEL, IXGBE_DEV_ID_X550EM_A_SFP), board_x550em_a },
++>>>>>>> 2d40cd1720cb (ixgbe: Add support for SFPs with retimer)
  	/* required last entry */
  	{0, }
  };
@@@ -2608,7 -2680,10 +2613,14 @@@ static inline void ixgbe_irq_enable(str
  	case ixgbe_mac_X540:
  	case ixgbe_mac_X550:
  	case ixgbe_mac_X550EM_x:
++<<<<<<< HEAD
 +		if (adapter->hw.device_id == IXGBE_DEV_ID_X550EM_X_SFP)
++=======
+ 	case ixgbe_mac_x550em_a:
+ 		if (adapter->hw.device_id == IXGBE_DEV_ID_X550EM_X_SFP ||
+ 		    adapter->hw.device_id == IXGBE_DEV_ID_X550EM_A_SFP ||
+ 		    adapter->hw.device_id == IXGBE_DEV_ID_X550EM_A_SFP_N)
++>>>>>>> 2d40cd1720cb (ixgbe: Add support for SFPs with retimer)
  			mask |= IXGBE_EIMS_GPI_SDP0(&adapter->hw);
  		if (adapter->hw.phy.type == ixgbe_phy_x550em_ext_t)
  			mask |= IXGBE_EICR_GPI_SDP0_X540;
diff --cc drivers/net/ethernet/intel/ixgbe/ixgbe_x550.c
index 98d6e51de236,a9d86b37872c..000000000000
--- a/drivers/net/ethernet/intel/ixgbe/ixgbe_x550.c
+++ b/drivers/net/ethernet/intel/ixgbe/ixgbe_x550.c
@@@ -1341,7 -1575,19 +1458,23 @@@ static void ixgbe_init_mac_link_ops_X55
  		mac->ops.flap_tx_laser = NULL;
  		mac->ops.setup_link = ixgbe_setup_mac_link_multispeed_fiber;
  		mac->ops.setup_fc = ixgbe_setup_fc_x550em;
++<<<<<<< HEAD
 +		mac->ops.setup_mac_link = ixgbe_setup_mac_link_sfp_x550em;
++=======
+ 		switch (hw->device_id) {
+ 		case IXGBE_DEV_ID_X550EM_A_SFP_N:
+ 			mac->ops.setup_mac_link = ixgbe_setup_mac_link_sfp_n;
+ 			break;
+ 		case IXGBE_DEV_ID_X550EM_A_SFP:
+ 			mac->ops.setup_mac_link =
+ 						ixgbe_setup_mac_link_sfp_x550a;
+ 			break;
+ 		default:
+ 			mac->ops.setup_mac_link =
+ 						ixgbe_setup_mac_link_sfp_x550em;
+ 			break;
+ 		}
++>>>>>>> 2d40cd1720cb (ixgbe: Add support for SFPs with retimer)
  		mac->ops.set_rate_select_speed =
  					ixgbe_set_soft_rate_select_speed;
  		break;
@@@ -2134,6 -2382,8 +2267,11 @@@ static enum ixgbe_media_type ixgbe_get_
  		media_type = ixgbe_media_type_backplane;
  		break;
  	case IXGBE_DEV_ID_X550EM_X_SFP:
++<<<<<<< HEAD
++=======
+ 	case IXGBE_DEV_ID_X550EM_A_SFP:
+ 	case IXGBE_DEV_ID_X550EM_A_SFP_N:
++>>>>>>> 2d40cd1720cb (ixgbe: Add support for SFPs with retimer)
  		media_type = ixgbe_media_type_fiber;
  		break;
  	case IXGBE_DEV_ID_X550EM_X_1G_T:
* Unmerged path drivers/net/ethernet/intel/ixgbe/ixgbe_main.c
diff --git a/drivers/net/ethernet/intel/ixgbe/ixgbe_phy.h b/drivers/net/ethernet/intel/ixgbe/ixgbe_phy.h
index 61dc71563bf9..c3f6ca87bccc 100644
--- a/drivers/net/ethernet/intel/ixgbe/ixgbe_phy.h
+++ b/drivers/net/ethernet/intel/ixgbe/ixgbe_phy.h
@@ -1,7 +1,7 @@
 /*******************************************************************************
 
   Intel 10 Gigabit PCI Express Linux driver
-  Copyright(c) 1999 - 2014 Intel Corporation.
+  Copyright(c) 1999 - 2016 Intel Corporation.
 
   This program is free software; you can redistribute it and/or modify it
   under the terms and conditions of the GNU General Public License,
@@ -81,7 +81,11 @@
 #define IXGBE_I2C_EEPROM_STATUS_FAIL		0x2
 #define IXGBE_I2C_EEPROM_STATUS_IN_PROGRESS	0x3
 #define IXGBE_CS4227				0xBE    /* CS4227 address */
+#define IXGBE_CS4227_GLOBAL_ID_LSB		0
+#define IXGBE_CS4227_GLOBAL_ID_MSB		1
 #define IXGBE_CS4227_SCRATCH			2
+#define IXGBE_CS4223_PHY_ID			0x7003	/* Quad port */
+#define IXGBE_CS4227_PHY_ID			0x3003	/* Dual port */
 #define IXGBE_CS4227_RESET_PENDING		0x1357
 #define IXGBE_CS4227_RESET_COMPLETE		0x5AA5
 #define IXGBE_CS4227_RETRIES			15
diff --git a/drivers/net/ethernet/intel/ixgbe/ixgbe_type.h b/drivers/net/ethernet/intel/ixgbe/ixgbe_type.h
index 9826af1b5034..831c4f89f462 100644
--- a/drivers/net/ethernet/intel/ixgbe/ixgbe_type.h
+++ b/drivers/net/ethernet/intel/ixgbe/ixgbe_type.h
@@ -1308,6 +1308,7 @@ struct ixgbe_thermal_sensor_data {
 
 /* MDIO definitions */
 
+#define IXGBE_MDIO_ZERO_DEV_TYPE		0x0
 #define IXGBE_MDIO_PMA_PMD_DEV_TYPE		0x1
 #define IXGBE_MDIO_PCS_DEV_TYPE		0x3
 #define IXGBE_MDIO_PHY_XS_DEV_TYPE		0x4
@@ -3525,6 +3526,7 @@ struct ixgbe_info {
 #define IXGBE_KRM_PORT_CAR_GEN_CTRL(P)	((P) ? 0x8010 : 0x4010)
 #define IXGBE_KRM_LINK_CTRL_1(P)	((P) ? 0x820C : 0x420C)
 #define IXGBE_KRM_AN_CNTL_1(P)		((P) ? 0x822C : 0x422C)
+#define IXGBE_KRM_AN_CNTL_8(P)		((P) ? 0x8248 : 0x4248)
 #define IXGBE_KRM_DSP_TXFFE_STATE_4(P)	((P) ? 0x8634 : 0x4634)
 #define IXGBE_KRM_DSP_TXFFE_STATE_5(P)	((P) ? 0x8638 : 0x4638)
 #define IXGBE_KRM_RX_TRN_LINKUP_CTRL(P)	((P) ? 0x8B00 : 0x4B00)
@@ -3550,6 +3552,9 @@ struct ixgbe_info {
 #define IXGBE_KRM_AN_CNTL_1_SYM_PAUSE			(1 << 28)
 #define IXGBE_KRM_AN_CNTL_1_ASM_PAUSE			(1 << 29)
 
+#define IXGBE_KRM_AN_CNTL_8_LINEAR			BIT(0)
+#define IXGBE_KRM_AN_CNTL_8_LIMITING			BIT(1)
+
 #define IXGBE_KRM_DSP_TXFFE_STATE_C0_EN			(1 << 6)
 #define IXGBE_KRM_DSP_TXFFE_STATE_CP1_CN1_EN		(1 << 15)
 #define IXGBE_KRM_DSP_TXFFE_STATE_CO_ADAPT_EN		(1 << 16)
* Unmerged path drivers/net/ethernet/intel/ixgbe/ixgbe_x550.c
