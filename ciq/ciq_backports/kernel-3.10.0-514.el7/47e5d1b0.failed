vxlan: move fdb code to common location in vxlan_xmit

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Jiri Benc <jbenc@redhat.com>
commit 47e5d1b06305e73afc917f47b65490adb06c7194
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/47e5d1b0.failed

Handle VXLAN_F_COLLECT_METADATA before VXLAN_F_PROXY. The latter does not
make sense with the former, as it needs populated fdb which does not happen
in metadata mode.

After this cleanup, the fdb code in vxlan_xmit is moved to a common location
and can be later skipped for VXLAN-GPE which does not necessarily carry
inner Ethernet header.

v2: changed commit description to not reference L3 mode

	Signed-off-by: Jiri Benc <jbenc@redhat.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 47e5d1b06305e73afc917f47b65490adb06c7194)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/vxlan.c
diff --cc drivers/net/vxlan.c
index 9215c93ac7ca,d62eebaa9720..000000000000
--- a/drivers/net/vxlan.c
+++ b/drivers/net/vxlan.c
@@@ -2048,10 -2103,20 +2048,18 @@@ static netdev_tx_t vxlan_xmit(struct sk
  	struct vxlan_rdst *rdst, *fdst = NULL;
  	struct vxlan_fdb *f;
  
 -	info = skb_tunnel_info(skb);
 -
  	skb_reset_mac_header(skb);
- 	eth = eth_hdr(skb);
  
- 	if ((vxlan->flags & VXLAN_F_PROXY)) {
+ 	if (vxlan->flags & VXLAN_F_COLLECT_METADATA) {
+ 		if (info && info->mode & IP_TUNNEL_INFO_TX)
+ 			vxlan_xmit_one(skb, dev, NULL, false);
+ 		else
+ 			kfree_skb(skb);
+ 		return NETDEV_TX_OK;
+ 	}
+ 
+ 	if (vxlan->flags & VXLAN_F_PROXY) {
+ 		eth = eth_hdr(skb);
  		if (ntohs(eth->h_proto) == ETH_P_ARP)
  			return arp_reduce(dev, skb);
  #if IS_ENABLED(CONFIG_IPV6)
@@@ -2069,7 -2134,7 +2077,10 @@@
  #endif
  	}
  
++<<<<<<< HEAD
++=======
+ 	eth = eth_hdr(skb);
++>>>>>>> 47e5d1b06305 (vxlan: move fdb code to common location in vxlan_xmit)
  	f = vxlan_find_mac(vxlan, eth->h_dest);
  	did_rsc = false;
  
* Unmerged path drivers/net/vxlan.c
