drm/i915/gen9: Add WaVFEStateAfterPipeControlwithMediaStateClear

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
Rebuild_CHGLOG: - [drm] i915/gen9: Add WaVFEStateAfterPipeControlwithMediaStateClear (Rob Clark) [1348329 1349064]
Rebuild_FUZZ: 96.77%
commit-author arun.siluvery@linux.intel.com <arun.siluvery@linux.intel.com>
commit 6bb6285582e0cf9b3a8440e0e714aae5f66d9ce2
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/6bb62855.failed

Kernel only need to add a register to HW whitelist, required for a
preemption related issue.

Reference: HSD#2131039
	Reviewed-by: Jeff McGee <jeff.mcgee@intel.com>
	Signed-off-by: Arun Siluvery <arun.siluvery@linux.intel.com>
	Signed-off-by: Tvrtko Ursulin <tvrtko.ursulin@intel.com>
Link: http://patchwork.freedesktop.org/patch/msgid/1465203169-16591-1-git-send-email-arun.siluvery@linux.intel.com
(cherry picked from commit 6bb6285582e0cf9b3a8440e0e714aae5f66d9ce2)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/gpu/drm/i915/i915_reg.h
#	drivers/gpu/drm/i915/intel_ringbuffer.c
diff --cc drivers/gpu/drm/i915/i915_reg.h
index bcce9fc478ee,04a3fd277ab3..000000000000
--- a/drivers/gpu/drm/i915/i915_reg.h
+++ b/drivers/gpu/drm/i915/i915_reg.h
@@@ -5291,30 -6039,50 +5291,37 @@@ enum skl_disp_power_wells 
  #define _CHICKEN_PIPESL_1_B	0x420b4
  #define  HSW_FBCQ_DIS			(1 << 22)
  #define  BDW_DPRS_MASK_VBLANK_SRD	(1 << 0)
 -#define CHICKEN_PIPESL_1(pipe) _MMIO_PIPE(pipe, _CHICKEN_PIPESL_1_A, _CHICKEN_PIPESL_1_B)
 +#define CHICKEN_PIPESL_1(pipe) _PIPE(pipe, _CHICKEN_PIPESL_1_A, _CHICKEN_PIPESL_1_B)
  
 -#define DISP_ARB_CTL	_MMIO(0x45000)
 +#define DISP_ARB_CTL	0x45000
  #define  DISP_TILE_SURFACE_SWIZZLING	(1<<13)
  #define  DISP_FBC_WM_DIS		(1<<15)
 -#define DISP_ARB_CTL2	_MMIO(0x45004)
 +#define DISP_ARB_CTL2	0x45004
  #define  DISP_DATA_PARTITION_5_6	(1<<6)
 -#define DBUF_CTL	_MMIO(0x45008)
 -#define  DBUF_POWER_REQUEST		(1<<31)
 -#define  DBUF_POWER_STATE		(1<<30)
 -#define GEN7_MSG_CTL	_MMIO(0x45010)
 +#define GEN7_MSG_CTL	0x45010
  #define  WAIT_FOR_PCH_RESET_ACK		(1<<1)
  #define  WAIT_FOR_PCH_FLR_ACK		(1<<0)
 -#define HSW_NDE_RSTWRN_OPT	_MMIO(0x46408)
 +#define HSW_NDE_RSTWRN_OPT	0x46408
  #define  RESET_PCH_HANDSHAKE_ENABLE	(1<<4)
  
 -#define SKL_DFSM			_MMIO(0x51000)
 -#define SKL_DFSM_CDCLK_LIMIT_MASK	(3 << 23)
 -#define SKL_DFSM_CDCLK_LIMIT_675	(0 << 23)
 -#define SKL_DFSM_CDCLK_LIMIT_540	(1 << 23)
 -#define SKL_DFSM_CDCLK_LIMIT_450	(2 << 23)
 -#define SKL_DFSM_CDCLK_LIMIT_337_5	(3 << 23)
 -#define SKL_DFSM_PIPE_A_DISABLE		(1 << 30)
 -#define SKL_DFSM_PIPE_B_DISABLE		(1 << 21)
 -#define SKL_DFSM_PIPE_C_DISABLE		(1 << 28)
 -
 -#define GEN7_FF_SLICE_CS_CHICKEN1	_MMIO(0x20e0)
 -#define   GEN9_FFSC_PERCTX_PREEMPT_CTRL	(1<<14)
 -
 -#define FF_SLICE_CS_CHICKEN2			_MMIO(0x20e4)
 +#define FF_SLICE_CS_CHICKEN2			0x02e4
  #define  GEN9_TSG_BARRIER_ACK_DISABLE		(1<<8)
  
++<<<<<<< HEAD
++=======
+ #define GEN9_CS_DEBUG_MODE1		_MMIO(0x20ec)
+ #define GEN9_CTX_PREEMPT_REG		_MMIO(0x2248)
+ #define GEN8_CS_CHICKEN1		_MMIO(0x2580)
+ 
++>>>>>>> 6bb6285582e0 (drm/i915/gen9: Add WaVFEStateAfterPipeControlwithMediaStateClear)
  /* GEN7 chicken */
 -#define GEN7_COMMON_SLICE_CHICKEN1		_MMIO(0x7010)
 +#define GEN7_COMMON_SLICE_CHICKEN1		0x7010
  # define GEN7_CSC1_RHWO_OPT_DISABLE_IN_RCC	((1<<10) | (1<<26))
  # define GEN9_RHWO_OPTIMIZATION_DISABLE		(1<<14)
 -#define COMMON_SLICE_CHICKEN2			_MMIO(0x7014)
 +#define COMMON_SLICE_CHICKEN2			0x7014
  # define GEN8_CSC2_SBE_VUE_CACHE_CONSERVATIVE	(1<<0)
  
 -#define HIZ_CHICKEN					_MMIO(0x7018)
 +#define HIZ_CHICKEN					0x7018
  # define CHV_HZ_8X8_MODE_IN_1X				(1<<15)
  # define BDW_HIZ_POWER_COMPILER_CLOCK_GATING_DISABLE	(1<<3)
  
diff --cc drivers/gpu/drm/i915/intel_ringbuffer.c
index 005b5e04de4d,f6e6128b36ca..000000000000
--- a/drivers/gpu/drm/i915/intel_ringbuffer.c
+++ b/drivers/gpu/drm/i915/intel_ringbuffer.c
@@@ -959,6 -962,46 +959,49 @@@ static int gen9_init_workarounds(struc
  	WA_CLR_BIT_MASKED(GEN9_HALF_SLICE_CHICKEN5,
  			  GEN9_CCS_TLB_PREFETCH_ENABLE);
  
++<<<<<<< HEAD
++=======
+ 	/* WaDisableMaskBasedCammingInRCC:skl,bxt */
+ 	if (IS_SKL_REVID(dev_priv, SKL_REVID_C0, SKL_REVID_C0) ||
+ 	    IS_BXT_REVID(dev_priv, 0, BXT_REVID_A1))
+ 		WA_SET_BIT_MASKED(SLICE_ECO_CHICKEN0,
+ 				  PIXEL_MASK_CAMMING_DISABLE);
+ 
+ 	/* WaForceContextSaveRestoreNonCoherent:skl,bxt */
+ 	tmp = HDC_FORCE_CONTEXT_SAVE_RESTORE_NON_COHERENT;
+ 	if (IS_SKL_REVID(dev_priv, SKL_REVID_F0, REVID_FOREVER) ||
+ 	    IS_BXT_REVID(dev_priv, BXT_REVID_B0, REVID_FOREVER))
+ 		tmp |= HDC_FORCE_CSR_NON_COHERENT_OVR_DISABLE;
+ 	WA_SET_BIT_MASKED(HDC_CHICKEN0, tmp);
+ 
+ 	/* WaDisableSamplerPowerBypassForSOPingPong:skl,bxt */
+ 	if (IS_SKYLAKE(dev_priv) || IS_BXT_REVID(dev_priv, 0, BXT_REVID_B0))
+ 		WA_SET_BIT_MASKED(HALF_SLICE_CHICKEN3,
+ 				  GEN8_SAMPLER_POWER_BYPASS_DIS);
+ 
+ 	/* WaDisableSTUnitPowerOptimization:skl,bxt */
+ 	WA_SET_BIT_MASKED(HALF_SLICE_CHICKEN2, GEN8_ST_PO_DISABLE);
+ 
+ 	/* WaOCLCoherentLineFlush:skl,bxt */
+ 	I915_WRITE(GEN8_L3SQCREG4, (I915_READ(GEN8_L3SQCREG4) |
+ 				    GEN8_LQSC_FLUSH_COHERENT_LINES));
+ 
+ 	/* WaVFEStateAfterPipeControlwithMediaStateClear:skl,bxt */
+ 	ret = wa_ring_whitelist_reg(engine, GEN9_CTX_PREEMPT_REG);
+ 	if (ret)
+ 		return ret;
+ 
+ 	/* WaEnablePreemptionGranularityControlByUMD:skl,bxt */
+ 	ret= wa_ring_whitelist_reg(engine, GEN8_CS_CHICKEN1);
+ 	if (ret)
+ 		return ret;
+ 
+ 	/* WaAllowUMDToModifyHDCChicken1:skl,bxt */
+ 	ret = wa_ring_whitelist_reg(engine, GEN8_HDC_CHICKEN1);
+ 	if (ret)
+ 		return ret;
+ 
++>>>>>>> 6bb6285582e0 (drm/i915/gen9: Add WaVFEStateAfterPipeControlwithMediaStateClear)
  	return 0;
  }
  
* Unmerged path drivers/gpu/drm/i915/i915_reg.h
* Unmerged path drivers/gpu/drm/i915/intel_ringbuffer.c
