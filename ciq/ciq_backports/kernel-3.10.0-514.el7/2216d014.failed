cxgb4: Update SGE context congestion map change for T6 adapter

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Hariprasad Shenai <hariprasad@chelsio.com>
commit 2216d01432cb1589d1bfbd2722f2ec05cb26ea51
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/2216d014.failed

SGE context congestion map changed from 4 to 8 priority per port
in T6 as there are only 2 channels.

	Signed-off-by: Hariprasad Shenai <hariprasad@chelsio.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 2216d01432cb1589d1bfbd2722f2ec05cb26ea51)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/chelsio/cxgb4/cxgb4.h
#	drivers/net/ethernet/chelsio/cxgb4/t4_hw.c
diff --cc drivers/net/ethernet/chelsio/cxgb4/cxgb4.h
index 050f4218989a,ec6e849676c1..000000000000
--- a/drivers/net/ethernet/chelsio/cxgb4/cxgb4.h
+++ b/drivers/net/ethernet/chelsio/cxgb4/cxgb4.h
@@@ -322,6 -298,17 +322,20 @@@ struct devlog_params 
  	u32 size;                       /* size of log */
  };
  
++<<<<<<< HEAD
++=======
+ /* Stores chip specific parameters */
+ struct arch_specific_params {
+ 	u8 nchan;
+ 	u8 pm_stats_cnt;
+ 	u8 cng_ch_bits_log;		/* congestion channel map bits width */
+ 	u16 mps_rplc_size;
+ 	u16 vfcount;
+ 	u32 sge_fl_db;
+ 	u16 mps_tcam_size;
+ };
+ 
++>>>>>>> 2216d01432cb (cxgb4: Update SGE context congestion map change for T6 adapter)
  struct adapter_params {
  	struct sge_params sge;
  	struct tp_params  tp;
diff --cc drivers/net/ethernet/chelsio/cxgb4/t4_hw.c
index 214cd37bdf6e,636b4691f252..000000000000
--- a/drivers/net/ethernet/chelsio/cxgb4/t4_hw.c
+++ b/drivers/net/ethernet/chelsio/cxgb4/t4_hw.c
@@@ -6931,9 -7187,42 +6931,48 @@@ int t4_prep_adapter(struct adapter *ada
  	switch (ver) {
  	case CHELSIO_T4:
  		adapter->params.chip |= CHELSIO_CHIP_CODE(CHELSIO_T4, pl_rev);
++<<<<<<< HEAD
 +		break;
 +	case CHELSIO_T5:
 +		adapter->params.chip |= CHELSIO_CHIP_CODE(CHELSIO_T5, pl_rev);
++=======
+ 		adapter->params.arch.sge_fl_db = DBPRIO_F;
+ 		adapter->params.arch.mps_tcam_size =
+ 				 NUM_MPS_CLS_SRAM_L_INSTANCES;
+ 		adapter->params.arch.mps_rplc_size = 128;
+ 		adapter->params.arch.nchan = NCHAN;
+ 		adapter->params.arch.pm_stats_cnt = PM_NSTATS;
+ 		adapter->params.arch.vfcount = 128;
+ 		/* Congestion map is for 4 channels so that
+ 		 * MPS can have 4 priority per port.
+ 		 */
+ 		adapter->params.arch.cng_ch_bits_log = 2;
+ 		break;
+ 	case CHELSIO_T5:
+ 		adapter->params.chip |= CHELSIO_CHIP_CODE(CHELSIO_T5, pl_rev);
+ 		adapter->params.arch.sge_fl_db = DBPRIO_F | DBTYPE_F;
+ 		adapter->params.arch.mps_tcam_size =
+ 				 NUM_MPS_T5_CLS_SRAM_L_INSTANCES;
+ 		adapter->params.arch.mps_rplc_size = 128;
+ 		adapter->params.arch.nchan = NCHAN;
+ 		adapter->params.arch.pm_stats_cnt = PM_NSTATS;
+ 		adapter->params.arch.vfcount = 128;
+ 		adapter->params.arch.cng_ch_bits_log = 2;
+ 		break;
+ 	case CHELSIO_T6:
+ 		adapter->params.chip |= CHELSIO_CHIP_CODE(CHELSIO_T6, pl_rev);
+ 		adapter->params.arch.sge_fl_db = 0;
+ 		adapter->params.arch.mps_tcam_size =
+ 				 NUM_MPS_T5_CLS_SRAM_L_INSTANCES;
+ 		adapter->params.arch.mps_rplc_size = 256;
+ 		adapter->params.arch.nchan = 2;
+ 		adapter->params.arch.pm_stats_cnt = T6_PM_NSTATS;
+ 		adapter->params.arch.vfcount = 256;
+ 		/* Congestion map will be for 2 channels so that
+ 		 * MPS can have 8 priority per port.
+ 		 */
+ 		adapter->params.arch.cng_ch_bits_log = 3;
++>>>>>>> 2216d01432cb (cxgb4: Update SGE context congestion map change for T6 adapter)
  		break;
  	default:
  		dev_err(adapter->pdev_dev, "Device %d is not supported\n",
* Unmerged path drivers/net/ethernet/chelsio/cxgb4/cxgb4.h
diff --git a/drivers/net/ethernet/chelsio/cxgb4/sge.c b/drivers/net/ethernet/chelsio/cxgb4/sge.c
index 92673e5982e9..c4cb5ae70a27 100644
--- a/drivers/net/ethernet/chelsio/cxgb4/sge.c
+++ b/drivers/net/ethernet/chelsio/cxgb4/sge.c
@@ -2559,8 +2559,9 @@ int t4_sge_alloc_rxq(struct adapter *adap, struct sge_rspq *iq, bool fwevtq,
 	 * simple (and hopefully less wrong).
 	 */
 	if (!is_t4(adap->params.chip) && cong >= 0) {
-		u32 param, val;
+		u32 param, val, ch_map = 0;
 		int i;
+		u16 cng_ch_bits_log = adap->params.arch.cng_ch_bits_log;
 
 		param = (FW_PARAMS_MNEM_V(FW_PARAMS_MNEM_DMAQ) |
 			 FW_PARAMS_PARAM_X_V(FW_PARAMS_PARAM_DMAQ_CONM_CTXT) |
@@ -2572,9 +2573,9 @@ int t4_sge_alloc_rxq(struct adapter *adap, struct sge_rspq *iq, bool fwevtq,
 			    CONMCTXT_CNGTPMODE_V(CONMCTXT_CNGTPMODE_CHANNEL_X);
 			for (i = 0; i < 4; i++) {
 				if (cong & (1 << i))
-					val |=
-					     CONMCTXT_CNGCHMAP_V(1 << (i << 2));
+					ch_map |= 1 << (i << cng_ch_bits_log);
 			}
+			val |= CONMCTXT_CNGCHMAP_V(ch_map);
 		}
 		ret = t4_set_params(adap, adap->mbox, adap->pf, 0, 1,
 				    &param, &val);
* Unmerged path drivers/net/ethernet/chelsio/cxgb4/t4_hw.c
