x86: Fix off-by-one in instruction decoder

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
Rebuild_CHGLOG: - [x86] Fix off-by-one in instruction decoder (Rui Wang) [1138650]
Rebuild_FUZZ: 93.67%
commit-author Peter Zijlstra <peterz@infradead.org>
commit 0f363b250b15af0f218bb2876d101fe5cd413f8b
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/0f363b25.failed

Stephane reported that the PEBS fixup was broken by the recent commit to
the instruction decoder. The thing had an off-by-one which resulted in
not being able to decode the last instruction and always bail.

	Reported-by: Stephane Eranian <eranian@google.com>
Fixes: 6ba48ff46f76 ("x86: Remove arbitrary instruction size limit in instruction decoder")
	Signed-off-by: Peter Zijlstra (Intel) <peterz@infradead.org>
	Cc: stable@vger.kernel.org # 3.18
	Cc: <ak@linux.intel.com>
	Cc: Jiri Olsa <jolsa@redhat.com>
	Cc: Liang Kan <kan.liang@intel.com>
	Cc: Arnaldo Carvalho de Melo <acme@redhat.com>
	Cc: Dave Hansen <dave.hansen@linux.intel.com>
	Cc: Jim Keniston <jkenisto@us.ibm.com>
	Cc: Linus Torvalds <torvalds@linux-foundation.org>
	Cc: Masami Hiramatsu <masami.hiramatsu.pt@hitachi.com>
Link: http://lkml.kernel.org/r/20141216104614.GV3337@twins.programming.kicks-ass.net
	Signed-off-by: Ingo Molnar <mingo@kernel.org>
(cherry picked from commit 0f363b250b15af0f218bb2876d101fe5cd413f8b)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/lib/insn.c
diff --cc arch/x86/lib/insn.c
index 54fcffed28ed,1313ae6b478b..000000000000
--- a/arch/x86/lib/insn.c
+++ b/arch/x86/lib/insn.c
@@@ -28,7 -28,7 +28,11 @@@
  
  /* Verify next sizeof(t) bytes can be on the same instruction */
  #define validate_next(t, insn, n)	\
++<<<<<<< HEAD
 +	((insn)->next_byte + sizeof(t) + n - (insn)->kaddr <= MAX_INSN_SIZE)
++=======
+ 	((insn)->next_byte + sizeof(t) + n <= (insn)->end_kaddr)
++>>>>>>> 0f363b250b15 (x86: Fix off-by-one in instruction decoder)
  
  #define __get_next(t, insn)	\
  	({ t r = *(t*)insn->next_byte; insn->next_byte += sizeof(t); r; })
* Unmerged path arch/x86/lib/insn.c
