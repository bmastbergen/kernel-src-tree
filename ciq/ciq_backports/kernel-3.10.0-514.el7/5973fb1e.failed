ipv6: Check expire on DST_NOCACHE route

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Martin KaFai Lau <kafai@fb.com>
commit 5973fb1e245086071bf71994c8b54d99526ded03
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/5973fb1e.failed

Since the expires of the DST_NOCACHE rt can be set during
the ip6_rt_update_pmtu(), we also need to consider the expires
value when doing ip6_dst_check().

This patches creates __rt6_check_expired() to only
check the expire value (if one exists) of the current rt.

In rt6_dst_from_check(), it adds __rt6_check_expired() as
one of the condition check.

	Signed-off-by: Martin KaFai Lau <kafai@fb.com>
	Cc: Hannes Frederic Sowa <hannes@stressinduktion.org>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 5973fb1e245086071bf71994c8b54d99526ded03)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/ipv6/route.c
diff --cc net/ipv6/route.c
index 403fb7ab35ee,3754cf9287a0..000000000000
--- a/net/ipv6/route.c
+++ b/net/ipv6/route.c
@@@ -1088,6 -1240,34 +1096,37 @@@ struct dst_entry *ip6_blackhole_route(s
   *	Destination cache support functions
   */
  
++<<<<<<< HEAD
++=======
+ static void rt6_dst_from_metrics_check(struct rt6_info *rt)
+ {
+ 	if (rt->dst.from &&
+ 	    dst_metrics_ptr(&rt->dst) != dst_metrics_ptr(rt->dst.from))
+ 		dst_init_metrics(&rt->dst, dst_metrics_ptr(rt->dst.from), true);
+ }
+ 
+ static struct dst_entry *rt6_check(struct rt6_info *rt, u32 cookie)
+ {
+ 	if (!rt->rt6i_node || (rt->rt6i_node->fn_sernum != cookie))
+ 		return NULL;
+ 
+ 	if (rt6_check_expired(rt))
+ 		return NULL;
+ 
+ 	return &rt->dst;
+ }
+ 
+ static struct dst_entry *rt6_dst_from_check(struct rt6_info *rt, u32 cookie)
+ {
+ 	if (!__rt6_check_expired(rt) &&
+ 	    rt->dst.obsolete == DST_OBSOLETE_FORCE_CHK &&
+ 	    rt6_check((struct rt6_info *)(rt->dst.from), cookie))
+ 		return &rt->dst;
+ 	else
+ 		return NULL;
+ }
+ 
++>>>>>>> 5973fb1e2450 (ipv6: Check expire on DST_NOCACHE route)
  static struct dst_entry *ip6_dst_check(struct dst_entry *dst, u32 cookie)
  {
  	struct rt6_info *rt;
* Unmerged path net/ipv6/route.c
