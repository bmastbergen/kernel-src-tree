iommu/vt-d: Don't do early domain assignment if kdump kernel

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
Rebuild_CHGLOG: - [iommu] vt-d: Don't do early domain assignment if kdump kernel (Myron Stowe) [1050021]
Rebuild_FUZZ: 94.74%
commit-author Joerg Roedel <jroedel@suse.de>
commit a87f491890e994dca4bee64690d7e5183a19264e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/a87f4918.failed

When we copied over context tables from an old kernel, we
need to defer assignment of devices to domains until the
device driver takes over. So skip this part of
initialization when we copied over translation tables from
the old kernel.

	Tested-by: ZhenHua Li <zhen-hual@hp.com>
	Tested-by: Baoquan He <bhe@redhat.com>
	Signed-off-by: Joerg Roedel <jroedel@suse.de>
(cherry picked from commit a87f491890e994dca4bee64690d7e5183a19264e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/iommu/intel-iommu.c
diff --cc drivers/iommu/intel-iommu.c
index 301f645702ed,3b32aa55f27c..000000000000
--- a/drivers/iommu/intel-iommu.c
+++ b/drivers/iommu/intel-iommu.c
@@@ -2819,6 -3071,31 +2820,34 @@@ static int __init init_dmars(void
  		if (ret)
  			goto free_iommu;
  
++<<<<<<< HEAD
++=======
+ 		if (translation_pre_enabled(iommu)) {
+ 			pr_info("Translation already enabled - trying to copy translation structures\n");
+ 
+ 			ret = copy_translation_tables(iommu);
+ 			if (ret) {
+ 				/*
+ 				 * We found the IOMMU with translation
+ 				 * enabled - but failed to copy over the
+ 				 * old root-entry table. Try to proceed
+ 				 * by disabling translation now and
+ 				 * allocating a clean root-entry table.
+ 				 * This might cause DMAR faults, but
+ 				 * probably the dump will still succeed.
+ 				 */
+ 				pr_err("Failed to copy translation tables from previous kernel for %s\n",
+ 				       iommu->name);
+ 				iommu_disable_translation(iommu);
+ 				clear_translation_pre_enabled(iommu);
+ 			} else {
+ 				pr_info("Copied translation tables from previous kernel for %s\n",
+ 					iommu->name);
+ 				copied_tables = true;
+ 			}
+ 		}
+ 
++>>>>>>> a87f491890e9 (iommu/vt-d: Don't do early domain assignment if kdump kernel)
  		iommu_flush_write_buffer(iommu);
  		iommu_set_root_entry(iommu);
  		iommu->flush.flush_context(iommu, 0, 0, 0, DMA_CCMD_GLOBAL_INVL);
* Unmerged path drivers/iommu/intel-iommu.c
