xprtrdma: disconnect and flush cqs before freeing buffers

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Steve Wise <swise@opengridcomputing.com>
commit 72c021738252dde5849d575a650239d6404930ee
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/72c02173.failed

Otherwise a FRMR completion can cause a touch-after-free crash.

In xprt_rdma_destroy(), call rpcrdma_buffer_destroy() only after calling
rpcrdma_ep_destroy().

In rpcrdma_ep_destroy(), disconnect the cm_id first which should flush the
qp, then drain the cqs, then destroy the qp, and finally destroy the cqs.

	Signed-off-by: Steve Wise <swise@opengridcomputing.com>
	Tested-by: Chuck Lever <chuck.lever@oracle.com>
	Signed-off-by: Anna Schumaker <Anna.Schumaker@Netapp.com>
(cherry picked from commit 72c021738252dde5849d575a650239d6404930ee)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/sunrpc/xprtrdma/verbs.c
diff --cc net/sunrpc/xprtrdma/verbs.c
index c2d67e23ee5b,611d9d507a85..000000000000
--- a/net/sunrpc/xprtrdma/verbs.c
+++ b/net/sunrpc/xprtrdma/verbs.c
@@@ -877,9 -766,6 +882,12 @@@ rpcrdma_ep_destroy(struct rpcrdma_ep *e
  		ia->ri_id->qp = NULL;
  	}
  
++<<<<<<< HEAD
 +	rpcrdma_free_regbuf(ia, ep->rep_padbuf);
 +
 +	rpcrdma_clean_cq(ep->rep_attr.recv_cq);
++=======
++>>>>>>> 72c021738252 (xprtrdma: disconnect and flush cqs before freeing buffers)
  	rc = ib_destroy_cq(ep->rep_attr.recv_cq);
  	if (rc)
  		dprintk("RPC:       %s: ib_destroy_cq returned %i\n",
diff --git a/net/sunrpc/xprtrdma/transport.c b/net/sunrpc/xprtrdma/transport.c
index de0c494fae3f..707dba22a1ab 100644
--- a/net/sunrpc/xprtrdma/transport.c
+++ b/net/sunrpc/xprtrdma/transport.c
@@ -276,8 +276,8 @@ xprt_rdma_destroy(struct rpc_xprt *xprt)
 
 	xprt_clear_connected(xprt);
 
-	rpcrdma_buffer_destroy(&r_xprt->rx_buf);
 	rpcrdma_ep_destroy(&r_xprt->rx_ep, &r_xprt->rx_ia);
+	rpcrdma_buffer_destroy(&r_xprt->rx_buf);
 	rpcrdma_ia_close(&r_xprt->rx_ia);
 
 	xprt_rdma_free_addresses(xprt);
* Unmerged path net/sunrpc/xprtrdma/verbs.c
