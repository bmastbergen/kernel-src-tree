staging/rdma/hfi1: Fix debugfs access race

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
Rebuild_CHGLOG: - [infiniband] rdma/hfi1: Fix debugfs access race (Alex Estrin) [1272062 1273170]
Rebuild_FUZZ: 89.47%
commit-author Dean Luick <dean.luick@intel.com>
commit ed6f653fe430ed4912aebec10a1b9d57813fe44c
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/ed6f653f.failed

Debugfs access races with the driver being ready.  Make sure the
driver is ready before debugfs files appear and debufs files are
gone before the driver starts tearing down.

	Reviewed-by: Mike Marciniszyn <mike.marciniszyn@intel.com>
	Signed-off-by: Dean Luick <dean.luick@intel.com>
	Signed-off-by: Jubin John <jubin.john@intel.com>
	Signed-off-by: Doug Ledford <dledford@redhat.com>
(cherry picked from commit ed6f653fe430ed4912aebec10a1b9d57813fe44c)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/staging/hfi1/init.c
diff --cc drivers/staging/hfi1/init.c
index c64c8dd680db,371ed293677d..000000000000
--- a/drivers/staging/hfi1/init.c
+++ b/drivers/staging/hfi1/init.c
@@@ -986,7 -982,7 +986,11 @@@ void hfi1_free_devdata(struct hfi1_devd
  	idr_remove(&hfi1_unit_table, dd->unit);
  	list_del(&dd->list);
  	spin_unlock_irqrestore(&hfi1_devs_lock, flags);
++<<<<<<< HEAD:drivers/staging/hfi1/init.c
 +	hfi1_dbg_ibdev_exit(&dd->verbs_dev);
++=======
+ 	free_platform_config(dd);
++>>>>>>> ed6f653fe430 (staging/rdma/hfi1: Fix debugfs access race):drivers/staging/rdma/hfi1/init.c
  	rcu_barrier(); /* wait for rcu callbacks to complete */
  	free_percpu(dd->int_counter);
  	free_percpu(dd->rcv_limit);
* Unmerged path drivers/staging/hfi1/init.c
