IB/hfi1: Re-factor MMU notification code

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Mitko Haralanov <mitko.haralanov@intel.com>
commit 06e0ffa69312ce33484bf5c63aa5fc576fde13a8
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/06e0ffa6.failed

The MMU notification code added to the
expected receive side has been re-factored and
split into it's own file. This was done in
order to make the code more general and, therefore,
usable by other parts of the driver.

The caching behavior remains the same. However,
the handling of the RB tree (insertion, deletions,
and searching) as well as the MMU invalidation
processing is now handled by functions in the
mmu_rb.[ch] files.

	Reviewed-by: Dennis Dalessandro <dennis.dalessandro@intel.com>
	Reviewed-by: Dean Luick <dean.luick@intel.com>
	Signed-off-by: Mitko Haralanov <mitko.haralanov@intel.com>
	Signed-off-by: Jubin John <jubin.john@intel.com>
	Signed-off-by: Doug Ledford <dledford@redhat.com>
(cherry picked from commit 06e0ffa69312ce33484bf5c63aa5fc576fde13a8)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/staging/hfi1/file_ops.c
#	drivers/staging/hfi1/hfi.h
#	drivers/staging/hfi1/mmu_rb.c
#	drivers/staging/hfi1/mmu_rb.h
#	drivers/staging/rdma/hfi1/Makefile
#	drivers/staging/rdma/hfi1/user_exp_rcv.c
diff --cc drivers/staging/hfi1/file_ops.c
index cc3b4e0b66e2,e460261f94b7..000000000000
--- a/drivers/staging/hfi1/file_ops.c
+++ b/drivers/staging/hfi1/file_ops.c
@@@ -69,7 -55,10 +69,12 @@@
  #include "common.h"
  #include "trace.h"
  #include "user_sdma.h"
 -#include "user_exp_rcv.h"
  #include "eprom.h"
++<<<<<<< HEAD:drivers/staging/hfi1/file_ops.c
++=======
+ #include "aspm.h"
+ #include "mmu_rb.h"
++>>>>>>> 06e0ffa69312 (IB/hfi1: Re-factor MMU notification code):drivers/staging/rdma/hfi1/file_ops.c
  
  #undef pr_fmt
  #define pr_fmt(fmt) DRIVER_NAME ": " fmt
diff --cc drivers/staging/hfi1/hfi.h
index 6438dccf5749,78c8e24b1970..000000000000
--- a/drivers/staging/hfi1/hfi.h
+++ b/drivers/staging/hfi1/hfi.h
@@@ -1146,6 -1179,9 +1146,12 @@@ struct hfi1_devdata 
  #define PT_EAGER    1
  #define PT_INVALID  2
  
++<<<<<<< HEAD:drivers/staging/hfi1/hfi.h
++=======
+ struct tid_rb_node;
+ struct mmu_rb_node;
+ 
++>>>>>>> 06e0ffa69312 (IB/hfi1: Re-factor MMU notification code):drivers/staging/rdma/hfi1/hfi.h
  /* Private data for file operations */
  struct hfi1_filedata {
  	struct hfi1_ctxtdata *uctxt;
@@@ -1154,16 -1190,17 +1160,25 @@@
  	struct hfi1_user_sdma_pkt_q *pq;
  	/* for cpu affinity; -1 if none */
  	int rec_cpu_num;
- 	struct mmu_notifier mn;
  	struct rb_root tid_rb_root;
++<<<<<<< HEAD:drivers/staging/hfi1/hfi.h
++=======
+ 	struct tid_rb_node **entry_to_rb;
++>>>>>>> 06e0ffa69312 (IB/hfi1: Re-factor MMU notification code):drivers/staging/rdma/hfi1/hfi.h
  	spinlock_t tid_lock; /* protect tid_[limit,used] counters */
  	u32 tid_limit;
  	u32 tid_used;
- 	spinlock_t rb_lock; /* protect tid_rb_root RB tree */
  	u32 *invalid_tids;
  	u32 invalid_tid_idx;
++<<<<<<< HEAD:drivers/staging/hfi1/hfi.h
 +	spinlock_t invalid_lock; /* protect the invalid_tids array */
 +	int (*mmu_rb_insert)(struct rb_root *, struct mmu_rb_node *);
++=======
+ 	/* protect invalid_tids array and invalid_tid_idx */
+ 	spinlock_t invalid_lock;
+ 	int (*mmu_rb_insert)(struct rb_root *, struct mmu_rb_node *);
+ 	void (*mmu_rb_remove)(struct rb_root *, struct mmu_rb_node *);
++>>>>>>> 06e0ffa69312 (IB/hfi1: Re-factor MMU notification code):drivers/staging/rdma/hfi1/hfi.h
  };
  
  extern struct list_head hfi1_dev_list;
* Unmerged path drivers/staging/hfi1/mmu_rb.c
* Unmerged path drivers/staging/hfi1/mmu_rb.h
* Unmerged path drivers/staging/rdma/hfi1/Makefile
* Unmerged path drivers/staging/rdma/hfi1/user_exp_rcv.c
* Unmerged path drivers/staging/hfi1/file_ops.c
* Unmerged path drivers/staging/hfi1/hfi.h
* Unmerged path drivers/staging/hfi1/mmu_rb.c
* Unmerged path drivers/staging/hfi1/mmu_rb.h
* Unmerged path drivers/staging/rdma/hfi1/Makefile
* Unmerged path drivers/staging/rdma/hfi1/user_exp_rcv.c
