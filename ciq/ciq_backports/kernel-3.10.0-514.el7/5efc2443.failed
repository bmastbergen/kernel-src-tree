audit: fix exe_file access in audit_exe_compare

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Mateusz Guzik <mguzik@redhat.com>
commit 5efc244346f9f338765da3d592f7947b0afdc4b5
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/5efc2443.failed

Prior to the change the function would blindly deference mm, exe_file
and exe_file->f_inode, each of which could have been NULL or freed.

Use get_task_exe_file to safely obtain stable exe_file.

	Signed-off-by: Mateusz Guzik <mguzik@redhat.com>
	Acked-by: Konstantin Khlebnikov <khlebnikov@yandex-team.ru>
	Acked-by: Richard Guy Briggs <rgb@redhat.com>
	Cc: <stable@vger.kernel.org> # 4.3.x
	Signed-off-by: Paul Moore <paul@paul-moore.com>
(cherry picked from commit 5efc244346f9f338765da3d592f7947b0afdc4b5)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	kernel/audit_watch.c
diff --cc kernel/audit_watch.c
index ad2f90d15b85,4846691957da..000000000000
--- a/kernel/audit_watch.c
+++ b/kernel/audit_watch.c
@@@ -526,3 -519,37 +527,40 @@@ static int __init audit_watch_init(void
  	return 0;
  }
  device_initcall(audit_watch_init);
++<<<<<<< HEAD
++=======
+ 
+ int audit_dupe_exe(struct audit_krule *new, struct audit_krule *old)
+ {
+ 	struct audit_fsnotify_mark *audit_mark;
+ 	char *pathname;
+ 
+ 	pathname = kstrdup(audit_mark_path(old->exe), GFP_KERNEL);
+ 	if (!pathname)
+ 		return -ENOMEM;
+ 
+ 	audit_mark = audit_alloc_mark(new, pathname, strlen(pathname));
+ 	if (IS_ERR(audit_mark)) {
+ 		kfree(pathname);
+ 		return PTR_ERR(audit_mark);
+ 	}
+ 	new->exe = audit_mark;
+ 
+ 	return 0;
+ }
+ 
+ int audit_exe_compare(struct task_struct *tsk, struct audit_fsnotify_mark *mark)
+ {
+ 	struct file *exe_file;
+ 	unsigned long ino;
+ 	dev_t dev;
+ 
+ 	exe_file = get_task_exe_file(tsk);
+ 	if (!exe_file)
+ 		return 0;
+ 	ino = exe_file->f_inode->i_ino;
+ 	dev = exe_file->f_inode->i_sb->s_dev;
+ 	fput(exe_file);
+ 	return audit_mark_compare(mark, ino, dev);
+ }
++>>>>>>> 5efc244346f9 (audit: fix exe_file access in audit_exe_compare)
* Unmerged path kernel/audit_watch.c
