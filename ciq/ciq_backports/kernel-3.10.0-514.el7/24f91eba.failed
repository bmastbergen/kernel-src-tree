mm: don't lose the SOFT_DIRTY flag on mprotect

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Andrey Vagin <avagin@openvz.org>
commit 24f91eba18bbfdb27e71a1aae5b3a61b67fcd091
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/24f91eba.failed

The SOFT_DIRTY bit shows that the content of memory was changed after a
defined point in the past.  mprotect() doesn't change the content of
memory, so it must not change the SOFT_DIRTY bit.

This bug causes a malfunction: on the first iteration all pages are
dumped.  On other iterations only pages with the SOFT_DIRTY bit are
dumped.  So if the SOFT_DIRTY bit is cleared from a page by mistake, the
page is not dumped and its content will be restored incorrectly.

This patch does nothing with _PAGE_SWP_SOFT_DIRTY, becase pte_modify()
is called only for present pages.

Fixes commit 0f8975ec4db2 ("mm: soft-dirty bits for user memory changes
tracking").

	Signed-off-by: Andrey Vagin <avagin@openvz.org>
	Acked-by: Cyrill Gorcunov <gorcunov@openvz.org>
	Cc: Thomas Gleixner <tglx@linutronix.de>
	Cc: Ingo Molnar <mingo@redhat.com>
	Cc: "H. Peter Anvin" <hpa@zytor.com>
	Cc: Pavel Emelyanov <xemul@parallels.com>
	Cc: Borislav Petkov <bp@suse.de>
	Cc: Wen Congyang <wency@cn.fujitsu.com>
	Cc: <stable@vger.kernel.org>
	Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
	Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
(cherry picked from commit 24f91eba18bbfdb27e71a1aae5b3a61b67fcd091)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/include/asm/pgtable_types.h
diff --cc arch/x86/include/asm/pgtable_types.h
index 35216aeb100f,1aa9ccd43223..000000000000
--- a/arch/x86/include/asm/pgtable_types.h
+++ b/arch/x86/include/asm/pgtable_types.h
@@@ -94,7 -122,7 +94,11 @@@
  /* Set of bits not changed in pte_modify */
  #define _PAGE_CHG_MASK	(PTE_PFN_MASK | _PAGE_PCD | _PAGE_PWT |		\
  			 _PAGE_SPECIAL | _PAGE_ACCESSED | _PAGE_DIRTY |	\
++<<<<<<< HEAD
 +			 _PAGE_SOFTDIRTY)
++=======
+ 			 _PAGE_SOFT_DIRTY)
++>>>>>>> 24f91eba18bb (mm: don't lose the SOFT_DIRTY flag on mprotect)
  #define _HPAGE_CHG_MASK (_PAGE_CHG_MASK | _PAGE_PSE)
  
  #define _PAGE_CACHE_MASK	(_PAGE_PCD | _PAGE_PWT)
* Unmerged path arch/x86/include/asm/pgtable_types.h
