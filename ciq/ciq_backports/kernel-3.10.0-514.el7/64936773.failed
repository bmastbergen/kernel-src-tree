IB/cma: Fix RDMA port validation for iWarp

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Matan Barak <matanb@mellanox.com>
commit 649367735ee5dedb128d9fac0b86ba7e0fe7ae3b
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/64936773.failed

cma_validate_port wrongly assumed that Ethernet devices are RoCE
devices and thus their ndev should be matched in the GID table.
This broke the iWarp support. Fixing that matching the ndev only if
we work on a RoCE port.

	Cc: <stable@vger.kernel.org> # 4.4.x-
Fixes: abae1b71dd37 ('IB/cma: cma_validate_port should verify the port
		     and netdevice')
	Reported-by: Hariprasad Shenai <hariprasad@chelsio.com>
	Tested-by: Hariprasad Shenai <hariprasad@chelsio.com>
	Signed-off-by: Matan Barak <matanb@mellanox.com>
	Reviewed-by: Steve Wise <swise@opengridcomputing.com>
	Signed-off-by: Doug Ledford <dledford@redhat.com>
(cherry picked from commit 649367735ee5dedb128d9fac0b86ba7e0fe7ae3b)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/core/cma.c
diff --cc drivers/infiniband/core/cma.c
index 0523e8efcdf1,a811594b0b59..000000000000
--- a/drivers/infiniband/core/cma.c
+++ b/drivers/infiniband/core/cma.c
@@@ -459,9 -551,28 +459,34 @@@ static inline int cma_validate_port(str
  	if ((dev_type != ARPHRD_INFINIBAND) && rdma_protocol_ib(device, port))
  		return ret;
  
++<<<<<<< HEAD
 +	ret = ib_find_cached_gid(device, gid, &found_port, NULL);
 +	if (port != found_port)
 +		return -ENODEV;
++=======
+ 	if (dev_type == ARPHRD_ETHER && rdma_protocol_roce(device, port)) {
+ 		ndev = dev_get_by_index(&init_net, bound_if_index);
+ 		if (ndev && ndev->flags & IFF_LOOPBACK) {
+ 			pr_info("detected loopback device\n");
+ 			dev_put(ndev);
+ 
+ 			if (!device->get_netdev)
+ 				return -EOPNOTSUPP;
+ 
+ 			ndev = device->get_netdev(device, port);
+ 			if (!ndev)
+ 				return -ENODEV;
+ 		}
+ 	} else {
+ 		gid_type = IB_GID_TYPE_IB;
+ 	}
+ 
+ 	ret = ib_find_cached_gid_by_port(device, gid, gid_type, port,
+ 					 ndev, NULL);
+ 
+ 	if (ndev)
+ 		dev_put(ndev);
++>>>>>>> 649367735ee5 (IB/cma: Fix RDMA port validation for iWarp)
  
  	return ret;
  }
* Unmerged path drivers/infiniband/core/cma.c
