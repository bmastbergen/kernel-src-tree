scsi: report 'INQUIRY result too short' once per host

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
Rebuild_CHGLOG: - [scsi] report 'INQUIRY result too short' once per host (Vitaly Kuznetsov) [1270253]
Rebuild_FUZZ: 94.00%
commit-author Vitaly Kuznetsov <vkuznets@redhat.com>
commit a35bb4458e5e5c9dc19a0daa0629409285f3b25e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/a35bb445.failed

Some host adapters (e.g. Hyper-V storvsc) are known for not respecting
the SPC-2/3/4 requirement for 'INQUIRY data (see table ...) shall
contain at least 36 bytes'. As a result we get tons on 'scsi 0:7:1:1:
scsi scan: INQUIRY result too short (5), using 36' messages on
console. This can be problematic for slow consoles. Introduce
short_inquiry flag in struct Scsi_Host to print the message once per
host.

	Signed-off-by: Vitaly Kuznetsov <vkuznets@redhat.com>
	Reviewed-by: Christoph Hellwig <hch@lst.de>
	Reviewed-by: Hannes Reinecke <hare@suse.com>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit a35bb4458e5e5c9dc19a0daa0629409285f3b25e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/scsi_scan.c
diff --cc drivers/scsi/scsi_scan.c
index 4ca174a5f3b7,403a63310fb1..000000000000
--- a/drivers/scsi/scsi_scan.c
+++ b/drivers/scsi/scsi_scan.c
@@@ -689,10 -702,12 +689,19 @@@ static int scsi_probe_lun(struct scsi_d
  	 * strings.
  	 */
  	if (sdev->inquiry_len < 36) {
++<<<<<<< HEAD
 +		printk_once(KERN_INFO
 +			    "%s %s: scsi scan: INQUIRY result too short (%d),"
 +			    " using 36\n", dev_driver_string(&sdev->sdev_gendev),
 +			    dev_name(&sdev->sdev_gendev), sdev->inquiry_len);
++=======
+ 		if (!sdev->host->short_inquiry) {
+ 			shost_printk(KERN_INFO, sdev->host,
+ 				    "scsi scan: INQUIRY result too short (%d),"
+ 				    " using 36\n", sdev->inquiry_len);
+ 			sdev->host->short_inquiry = 1;
+ 		}
++>>>>>>> a35bb4458e5e (scsi: report 'INQUIRY result too short' once per host)
  		sdev->inquiry_len = 36;
  	}
  
* Unmerged path drivers/scsi/scsi_scan.c
diff --git a/include/scsi/scsi_host.h b/include/scsi/scsi_host.h
index 86d856e16ad5..b68d5dcd62df 100644
--- a/include/scsi/scsi_host.h
+++ b/include/scsi/scsi_host.h
@@ -724,6 +724,9 @@ struct Scsi_Host {
 	/* The transport requires the LUN bits NOT to be stored in CDB[1] */
 	RH_KABI_FILL_HOLE(unsigned no_scsi2_lun_in_cdb:1)
 
+	/* Host responded with short (<36 bytes) INQUIRY result */
+	unsigned short_inquiry:1;
+
 	/*
 	 * Optional work queue to be utilized by the transport
 	 */
