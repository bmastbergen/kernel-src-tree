ovs: allow nl 'flow set' to use ufid without flow key

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
Rebuild_CHGLOG: - [net] openvswitch: allow nl 'flow set' to use ufid without flow key (Eric Garver) [1297476]
Rebuild_FUZZ: 92.98%
commit-author Samuel Gauthier <samuel.gauthier@6wind.com>
commit 6f15cdbf8a8ac2e22767cc8b1eae225702733c95
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/6f15cdbf.failed

When we want to change a flow using netlink, we have to identify it to
be able to perform a lookup. Both the flow key and unique flow ID
(ufid) are valid identifiers, but we always have to specify the flow
key in the netlink message. When both attributes are there, the ufid
is used. The flow key is used to validate the actions provided by
the userland.

This commit allows to use the ufid without having to provide the flow
key, as it is already done in the netlink 'flow get' and 'flow del'
path. The flow key remains mandatory when an action is provided.

	Signed-off-by: Samuel Gauthier <samuel.gauthier@6wind.com>
	Reviewed-by: Simon Horman <simon.horman@netronome.com>
	Acked-by: Pravin B Shelar <pshelar@ovn.org>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 6f15cdbf8a8ac2e22767cc8b1eae225702733c95)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/openvswitch/datapath.c
diff --cc net/openvswitch/datapath.c
index f29fe045f3c8,0cc66a4e492d..000000000000
--- a/net/openvswitch/datapath.c
+++ b/net/openvswitch/datapath.c
@@@ -1072,24 -1100,30 +1072,41 @@@ static int ovs_flow_cmd_set(struct sk_b
  	bool log = !a[OVS_FLOW_ATTR_PROBE];
  	bool ufid_present;
  
- 	/* Extract key. */
- 	error = -EINVAL;
- 	if (!a[OVS_FLOW_ATTR_KEY]) {
- 		OVS_NLERR(log, "Flow key attribute not present in set flow.");
- 		goto error;
- 	}
- 
  	ufid_present = ovs_nla_get_ufid(&sfid, a[OVS_FLOW_ATTR_UFID], log);
++<<<<<<< HEAD
 +	ovs_match_init(&match, &key, &mask);
 +	error = ovs_nla_get_match(&match, a[OVS_FLOW_ATTR_KEY],
 +				  a[OVS_FLOW_ATTR_MASK], log);
++=======
+ 	if (a[OVS_FLOW_ATTR_KEY]) {
+ 		ovs_match_init(&match, &key, &mask);
+ 		error = ovs_nla_get_match(net, &match, a[OVS_FLOW_ATTR_KEY],
+ 					  a[OVS_FLOW_ATTR_MASK], log);
+ 	} else if (!ufid_present) {
+ 		OVS_NLERR(log,
+ 			  "Flow set message rejected, Key attribute missing.");
+ 		error = -EINVAL;
+ 	}
++>>>>>>> 6f15cdbf8a8a (ovs: allow nl 'flow set' to use ufid without flow key)
  	if (error)
  		goto error;
  
  	/* Validate actions. */
  	if (a[OVS_FLOW_ATTR_ACTIONS]) {
++<<<<<<< HEAD
 +		acts = get_flow_actions(a[OVS_FLOW_ATTR_ACTIONS], &key, &mask,
 +					log);
++=======
+ 		if (!a[OVS_FLOW_ATTR_KEY]) {
+ 			OVS_NLERR(log,
+ 				  "Flow key attribute not present in set flow.");
+ 			error = -EINVAL;
+ 			goto error;
+ 		}
+ 
+ 		acts = get_flow_actions(net, a[OVS_FLOW_ATTR_ACTIONS], &key,
+ 					&mask, log);
++>>>>>>> 6f15cdbf8a8a (ovs: allow nl 'flow set' to use ufid without flow key)
  		if (IS_ERR(acts)) {
  			error = PTR_ERR(acts);
  			goto error;
* Unmerged path net/openvswitch/datapath.c
