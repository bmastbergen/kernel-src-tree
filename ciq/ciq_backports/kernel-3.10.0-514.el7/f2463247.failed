KVM: x86: fix ordering of cr0 initialization code in vmx_cpu_reset

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Bruce Rogers <brogers@suse.com>
commit f24632475d4ffed5626abbfab7ef30a128dd1474
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/f2463247.failed

Commit d28bc9dd25ce reversed the order of two lines which initialize cr0,
allowing the current (old) cr0 value to mess up vcpu initialization.
This was observed in the checks for cr0 X86_CR0_WP bit in the context of
kvm_mmu_reset_context(). Besides, setting vcpu->arch.cr0 after vmx_set_cr0()
is completely redundant. Change the order back to ensure proper vcpu
initialization.

The combination of booting with ovmf firmware when guest vcpus > 1 and kvm's
ept=N option being set results in a VM-entry failure. This patch fixes that.

Fixes: d28bc9dd25ce ("KVM: x86: INIT and reset sequences are different")
	Cc: stable@vger.kernel.org
	Signed-off-by: Bruce Rogers <brogers@suse.com>
	Signed-off-by: Radim Krčmář <rkrcmar@redhat.com>
(cherry picked from commit f24632475d4ffed5626abbfab7ef30a128dd1474)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kvm/vmx.c
diff --cc arch/x86/kvm/vmx.c
index a7d76dce5145,ab4a387b98b1..000000000000
--- a/arch/x86/kvm/vmx.c
+++ b/arch/x86/kvm/vmx.c
@@@ -4596,12 -5045,13 +4596,22 @@@ static void vmx_vcpu_reset(struct kvm_v
  	if (vmx->vpid != 0)
  		vmcs_write16(VIRTUAL_PROCESSOR_ID, vmx->vpid);
  
++<<<<<<< HEAD
 +	vmx->vcpu.arch.cr0 = X86_CR0_NW | X86_CR0_CD | X86_CR0_ET;
 +	vmx_set_cr0(&vmx->vcpu, kvm_read_cr0(vcpu)); /* enter rmode */
 +	vmx_set_cr4(&vmx->vcpu, 0);
 +	vmx_set_efer(&vmx->vcpu, 0);
 +	vmx_fpu_activate(&vmx->vcpu);
 +	update_exception_bitmap(&vmx->vcpu);
++=======
+ 	cr0 = X86_CR0_NW | X86_CR0_CD | X86_CR0_ET;
+ 	vmx->vcpu.arch.cr0 = cr0;
+ 	vmx_set_cr0(vcpu, cr0); /* enter rmode */
+ 	vmx_set_cr4(vcpu, 0);
+ 	vmx_set_efer(vcpu, 0);
+ 	vmx_fpu_activate(vcpu);
+ 	update_exception_bitmap(vcpu);
++>>>>>>> f24632475d4f (KVM: x86: fix ordering of cr0 initialization code in vmx_cpu_reset)
  
  	vpid_sync_context(vmx->vpid);
  }
* Unmerged path arch/x86/kvm/vmx.c
