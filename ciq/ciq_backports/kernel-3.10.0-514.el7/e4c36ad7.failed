scsi: vpd pages are mandatory for SPC-2

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
Rebuild_CHGLOG: - [scsi] vpd pages are mandatory for SPC-2 (Ewan Milne) [1347292]
Rebuild_FUZZ: 91.67%
commit-author Hannes Reinecke <hare@suse.de>
commit e4c36ad756ec2de36b05c66bb50ed4ff47b0fdb0
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/e4c36ad7.failed

VPD pages 0x0 and 0x83 are mandatory even for SPC-2, so we should be
lowering the restriction to avoid having to whitelist every SPC-2
compliant device.

	Signed-off-by: Hannes Reinecke <hare@suse.com>
	Reviewed-by: Johannes Thumshirn <jthumshirn@suse.de>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit e4c36ad756ec2de36b05c66bb50ed4ff47b0fdb0)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	include/scsi/scsi_device.h
diff --cc include/scsi/scsi_device.h
index e1cb95bd1424,a6c346df290d..000000000000
--- a/include/scsi/scsi_device.h
+++ b/include/scsi/scsi_device.h
@@@ -592,6 -524,31 +592,34 @@@ static inline int scsi_device_tpgs(stru
  	return sdev->inquiry ? (sdev->inquiry[5] >> 4) & 0x3 : 0;
  }
  
++<<<<<<< HEAD
++=======
+ /**
+  * scsi_device_supports_vpd - test if a device supports VPD pages
+  * @sdev: the &struct scsi_device to test
+  *
+  * If the 'try_vpd_pages' flag is set it takes precedence.
+  * Otherwise we will assume VPD pages are supported if the
+  * SCSI level is at least SPC-3 and 'skip_vpd_pages' is not set.
+  */
+ static inline int scsi_device_supports_vpd(struct scsi_device *sdev)
+ {
+ 	/* Attempt VPD inquiry if the device blacklist explicitly calls
+ 	 * for it.
+ 	 */
+ 	if (sdev->try_vpd_pages)
+ 		return 1;
+ 	/*
+ 	 * Although VPD inquiries can go to SCSI-2 type devices,
+ 	 * some USB ones crash on receiving them, and the pages
+ 	 * we currently ask for are mandatory for SPC-2 and beyond
+ 	 */
+ 	if (sdev->scsi_level >= SCSI_SPC_2 && !sdev->skip_vpd_pages)
+ 		return 1;
+ 	return 0;
+ }
+ 
++>>>>>>> e4c36ad756ec (scsi: vpd pages are mandatory for SPC-2)
  #define MODULE_ALIAS_SCSI_DEVICE(type) \
  	MODULE_ALIAS("scsi:t-" __stringify(type) "*")
  #define SCSI_DEVICE_MODALIAS_FMT "scsi:t-0x%02x"
* Unmerged path include/scsi/scsi_device.h
