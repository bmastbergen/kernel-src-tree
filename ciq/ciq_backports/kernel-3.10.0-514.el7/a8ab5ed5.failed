drm/i915/gen9: implement WaConextSwitchWithConcurrentTLBInvalidate

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
Rebuild_CHGLOG: - [drm] i915/gen9: implement WaConextSwitchWithConcurrentTLBInvalidate (Rob Clark) [1348329 1349064]
Rebuild_FUZZ: 96.88%
commit-author Tim Gore <tim.gore@intel.com>
commit a8ab5ed5e1bf856eceaab5579236de6f92822b9f
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/a8ab5ed5.failed

This patch enables a workaround for a mid thread preemption
issue where a hardware timing problem can prevent the
context restore from happening, leading to a hang.

v2: move to gen9_init_workarounds (Arun)
v3: move to start of gen9_init_workarounds (Arun)

	Signed-off-by: Tim Gore <tim.gore@intel.com>
	Reviewed-by: Arun Siluvery <arun.siluvery@linux.intel.com>
	Signed-off-by: Tvrtko Ursulin <tvrtko.ursulin@intel.com>
Link: http://patchwork.freedesktop.org/patch/msgid/1465816501-25557-1-git-send-email-tim.gore@intel.com
(cherry picked from commit a8ab5ed5e1bf856eceaab5579236de6f92822b9f)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/gpu/drm/i915/i915_reg.h
#	drivers/gpu/drm/i915/intel_ringbuffer.c
diff --cc drivers/gpu/drm/i915/i915_reg.h
index bcce9fc478ee,4657aed5d7b0..000000000000
--- a/drivers/gpu/drm/i915/i915_reg.h
+++ b/drivers/gpu/drm/i915/i915_reg.h
@@@ -1365,13 -1807,30 +1365,35 @@@ enum skl_disp_power_wells 
  #define   GEN6_WIZ_HASHING_16x4				GEN6_WIZ_HASHING(1, 0)
  #define   GEN6_WIZ_HASHING_MASK				GEN6_WIZ_HASHING(1, 1)
  #define   GEN6_TD_FOUR_ROW_DISPATCH_DISABLE		(1 << 5)
 -#define   GEN9_IZ_HASHING_MASK(slice)			(0x3 << ((slice) * 2))
 -#define   GEN9_IZ_HASHING(slice, val)			((val) << ((slice) * 2))
 -
 +#define   GEN9_IZ_HASHING_MASK(slice)			(0x3 << (slice * 2))
 +#define   GEN9_IZ_HASHING(slice, val)			((val) << (slice * 2))
 +
++<<<<<<< HEAD
 +#define GFX_MODE	0x02520
 +#define GFX_MODE_GEN7	0x0229c
 +#define RING_MODE_GEN7(ring)	((ring)->mmio_base+0x29c)
++=======
+ /* chicken reg for WaConextSwitchWithConcurrentTLBInvalidate */
+ #define GEN9_CSFE_CHICKEN1_RCS _MMIO(0x20D4)
+ #define   GEN9_PREEMPT_GPGPU_SYNC_SWITCH_DISABLE (1 << 2)
+ 
+ /* WaClearTdlStateAckDirtyBits */
+ #define GEN8_STATE_ACK		_MMIO(0x20F0)
+ #define GEN9_STATE_ACK_SLICE1	_MMIO(0x20F8)
+ #define GEN9_STATE_ACK_SLICE2	_MMIO(0x2100)
+ #define   GEN9_STATE_ACK_TDL0 (1 << 12)
+ #define   GEN9_STATE_ACK_TDL1 (1 << 13)
+ #define   GEN9_STATE_ACK_TDL2 (1 << 14)
+ #define   GEN9_STATE_ACK_TDL3 (1 << 15)
+ #define   GEN9_SUBSLICE_TDL_ACK_BITS \
+ 	(GEN9_STATE_ACK_TDL3 | GEN9_STATE_ACK_TDL2 | \
+ 	 GEN9_STATE_ACK_TDL1 | GEN9_STATE_ACK_TDL0)
+ 
+ #define GFX_MODE	_MMIO(0x2520)
+ #define GFX_MODE_GEN7	_MMIO(0x229c)
+ #define RING_MODE_GEN7(ring)	_MMIO((ring)->mmio_base+0x29c)
++>>>>>>> a8ab5ed5e1bf (drm/i915/gen9: implement WaConextSwitchWithConcurrentTLBInvalidate)
  #define   GFX_RUN_LIST_ENABLE		(1<<15)
 -#define   GFX_INTERRUPT_STEERING	(1<<14)
  #define   GFX_TLB_INVALIDATE_EXPLICIT	(1<<13)
  #define   GFX_SURFACE_FAULT_ENABLE	(1<<12)
  #define   GFX_REPLAY_MODE		(1<<11)
diff --cc drivers/gpu/drm/i915/intel_ringbuffer.c
index 005b5e04de4d,110c7fc957b7..000000000000
--- a/drivers/gpu/drm/i915/intel_ringbuffer.c
+++ b/drivers/gpu/drm/i915/intel_ringbuffer.c
@@@ -904,16 -905,29 +904,32 @@@ static int chv_init_workarounds(struct 
  	return 0;
  }
  
 -static int gen9_init_workarounds(struct intel_engine_cs *engine)
 +static int gen9_init_workarounds(struct intel_engine_cs *ring)
  {
 -	struct drm_i915_private *dev_priv = engine->i915;
 -	int ret;
 +	struct drm_device *dev = ring->dev;
 +	struct drm_i915_private *dev_priv = dev->dev_private;
  
++<<<<<<< HEAD
 +	/* WaDisablePartialInstShootdown:skl */
++=======
+ 	/* WaConextSwitchWithConcurrentTLBInvalidate:skl,bxt,kbl */
+ 	I915_WRITE(GEN9_CSFE_CHICKEN1_RCS, _MASKED_BIT_ENABLE(GEN9_PREEMPT_GPGPU_SYNC_SWITCH_DISABLE));
+ 
+ 	/* WaEnableLbsSlaRetryTimerDecrement:skl,bxt,kbl */
+ 	I915_WRITE(BDW_SCRATCH1, I915_READ(BDW_SCRATCH1) |
+ 		   GEN9_LBS_SLA_RETRY_TIMER_DECREMENT_ENABLE);
+ 
+ 	/* WaDisableKillLogic:bxt,skl,kbl */
+ 	I915_WRITE(GAM_ECOCHK, I915_READ(GAM_ECOCHK) |
+ 		   ECOCHK_DIS_TLB);
+ 
+ 	/* WaClearFlowControlGpgpuContextSave:skl,bxt,kbl */
+ 	/* WaDisablePartialInstShootdown:skl,bxt,kbl */
++>>>>>>> a8ab5ed5e1bf (drm/i915/gen9: implement WaConextSwitchWithConcurrentTLBInvalidate)
  	WA_SET_BIT_MASKED(GEN8_ROW_CHICKEN,
 -			  FLOW_CONTROL_ENABLE |
  			  PARTIAL_INSTRUCTION_SHOOTDOWN_DISABLE);
  
 -	/* Syncing dependencies between camera and graphics:skl,bxt,kbl */
 +	/* Syncing dependencies between camera and graphics */
  	WA_SET_BIT_MASKED(HALF_SLICE_CHICKEN3,
  			  GEN9_DISABLE_OCL_OOB_SUPPRESS_LOGIC);
  
* Unmerged path drivers/gpu/drm/i915/i915_reg.h
* Unmerged path drivers/gpu/drm/i915/intel_ringbuffer.c
