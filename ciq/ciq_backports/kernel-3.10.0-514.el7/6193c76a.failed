rcu: Kick CPU halfway to RCU CPU stall warning

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Paul E. McKenney <paulmck@linux.vnet.ibm.com>
commit 6193c76aba8ec3cc5f083c35efbab9ed924125f6
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/6193c76a.failed

When an RCU CPU stall warning occurs, the CPU invokes resched_cpu() on
itself.  This can help move the grace period forward in some situations,
but it would be even better to do this -before- the RCU CPU stall warning.
This commit therefore causes resched_cpu() to be called every five jiffies
once the system is halfway to an RCU CPU stall warning.

	Signed-off-by: Paul E. McKenney <paulmck@linux.vnet.ibm.com>
(cherry picked from commit 6193c76aba8ec3cc5f083c35efbab9ed924125f6)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	kernel/rcutree.c
diff --cc kernel/rcutree.c
index 8a3ca028ee72,5243ebea0fc1..000000000000
--- a/kernel/rcutree.c
+++ b/kernel/rcutree.c
@@@ -827,8 -838,14 +848,19 @@@ static int rcu_implicit_dynticks_qs(str
  
  static void record_gp_stall_check_time(struct rcu_state *rsp)
  {
++<<<<<<< HEAD:kernel/rcutree.c
 +	rsp->gp_start = jiffies;
 +	rsp->jiffies_stall = jiffies + rcu_jiffies_till_stall_check();
++=======
+ 	unsigned long j = ACCESS_ONCE(jiffies);
+ 	unsigned long j1;
+ 
+ 	rsp->gp_start = j;
+ 	smp_wmb(); /* Record start time before stall time. */
+ 	j1 = rcu_jiffies_till_stall_check();
+ 	rsp->jiffies_stall = j + j1;
+ 	rsp->jiffies_resched = j + j1 / 2;
++>>>>>>> 6193c76aba8e (rcu: Kick CPU halfway to RCU CPU stall warning):kernel/rcu/tree.c
  }
  
  /*
* Unmerged path kernel/rcutree.c
diff --git a/kernel/rcutree.h b/kernel/rcutree.h
index bfacdaeba90d..be8d22a27499 100644
--- a/kernel/rcutree.h
+++ b/kernel/rcutree.h
@@ -443,6 +443,8 @@ struct rcu_state {
 						/*  but in jiffies. */
 	unsigned long jiffies_stall;		/* Time at which to check */
 						/*  for CPU stalls. */
+	unsigned long jiffies_resched;		/* Time at which to resched */
+						/*  a reluctant CPU. */
 	unsigned long gp_max;			/* Maximum GP duration in */
 						/*  jiffies. */
 	char *name;				/* Name of structure. */
