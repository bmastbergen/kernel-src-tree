pnfs: add pnfs_report_layoutstat helper function

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Peng Tao <tao.peng@primarydata.com>
commit 8733408d6ed713d080c325262d7b51a780136d41
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/8733408d.failed

	Reviewed-by: Jeff Layton <jeff.layton@primarydata.com>
	Signed-off-by: Peng Tao <tao.peng@primarydata.com>
	Signed-off-by: Trond Myklebust <trond.myklebust@primarydata.com>
(cherry picked from commit 8733408d6ed713d080c325262d7b51a780136d41)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/nfs/nfs42proc.c
#	fs/nfs/pnfs.c
diff --cc fs/nfs/nfs42proc.c
index 0899db096637,ee0248340a42..000000000000
--- a/fs/nfs/nfs42proc.c
+++ b/fs/nfs/nfs42proc.c
@@@ -166,20 -171,75 +166,88 @@@ static loff_t _nfs42_proc_llseek(struc
  	return vfs_setpos(filep, res.sr_offset, inode->i_sb->s_maxbytes);
  }
  
 -static void
 -nfs42_layoutstat_prepare(struct rpc_task *task, void *calldata)
 +loff_t nfs42_proc_llseek(struct file *filep, loff_t offset, int whence)
  {
 -	struct nfs42_layoutstat_data *data = calldata;
 -	struct nfs_server *server = NFS_SERVER(data->args.inode);
 +	struct nfs_server *server = NFS_SERVER(file_inode(filep));
 +	struct nfs4_exception exception = { };
 +	loff_t err;
  
++<<<<<<< HEAD
 +	do {
 +		err = _nfs42_proc_llseek(filep, offset, whence);
 +		if (err >= 0)
 +			break;
 +		if (err == -ENOTSUPP)
 +			return -EOPNOTSUPP;
 +		err = nfs4_handle_exception(server, err, &exception);
 +	} while (exception.retry);
 +
 +	return err;
++=======
+ 	nfs41_setup_sequence(nfs4_get_session(server), &data->args.seq_args,
+ 			     &data->res.seq_res, task);
+ }
+ 
+ static void
+ nfs42_layoutstat_done(struct rpc_task *task, void *calldata)
+ {
+ 	struct nfs42_layoutstat_data *data = calldata;
+ 
+ 	if (!nfs4_sequence_done(task, &data->res.seq_res))
+ 		return;
+ 
+ 	/* well, we don't care about errors at all! */
+ 	if (task->tk_status)
+ 		dprintk("%s server returns %d\n", __func__, task->tk_status);
+ }
+ 
+ static void
+ nfs42_layoutstat_release(void *calldata)
+ {
+ 	struct nfs42_layoutstat_data *data = calldata;
+ 	struct nfs_server *nfss = NFS_SERVER(data->args.inode);
+ 
+ 	if (nfss->pnfs_curr_ld->cleanup_layoutstats)
+ 		nfss->pnfs_curr_ld->cleanup_layoutstats(data);
+ 
+ 	pnfs_put_layout_hdr(NFS_I(data->args.inode)->layout);
+ 	nfs_iput_and_deactive(data->inode);
+ 	kfree(data->args.devinfo);
+ 	kfree(data);
+ }
+ 
+ static const struct rpc_call_ops nfs42_layoutstat_ops = {
+ 	.rpc_call_prepare = nfs42_layoutstat_prepare,
+ 	.rpc_call_done = nfs42_layoutstat_done,
+ 	.rpc_release = nfs42_layoutstat_release,
+ };
+ 
+ int nfs42_proc_layoutstats_generic(struct nfs_server *server,
+ 				   struct nfs42_layoutstat_data *data)
+ {
+ 	struct rpc_message msg = {
+ 		.rpc_proc = &nfs4_procedures[NFSPROC4_CLNT_LAYOUTSTATS],
+ 		.rpc_argp = &data->args,
+ 		.rpc_resp = &data->res,
+ 	};
+ 	struct rpc_task_setup task_setup = {
+ 		.rpc_client = server->client,
+ 		.rpc_message = &msg,
+ 		.callback_ops = &nfs42_layoutstat_ops,
+ 		.callback_data = data,
+ 		.flags = RPC_TASK_ASYNC,
+ 	};
+ 	struct rpc_task *task;
+ 
+ 	data->inode = nfs_igrab_and_active(data->args.inode);
+ 	if (!data->inode) {
+ 		nfs42_layoutstat_release(data);
+ 		return -EAGAIN;
+ 	}
+ 	nfs4_init_sequence(&data->args.seq_args, &data->res.seq_res, 0);
+ 	task = rpc_run_task(&task_setup);
+ 	if (IS_ERR(task))
+ 		return PTR_ERR(task);
+ 	return 0;
++>>>>>>> 8733408d6ed7 (pnfs: add pnfs_report_layoutstat helper function)
  }
diff --cc fs/nfs/pnfs.c
index e661b8a0925b,6279cff7df74..000000000000
--- a/fs/nfs/pnfs.c
+++ b/fs/nfs/pnfs.c
@@@ -34,6 -34,8 +34,11 @@@
  #include "pnfs.h"
  #include "iostat.h"
  #include "nfs4trace.h"
++<<<<<<< HEAD
++=======
+ #include "delegation.h"
+ #include "nfs42.h"
++>>>>>>> 8733408d6ed7 (pnfs: add pnfs_report_layoutstat helper function)
  
  #define NFSDBG_FACILITY		NFSDBG_PNFS
  #define PNFS_LAYOUTGET_RETRY_TIMEOUT (120*HZ)
* Unmerged path fs/nfs/nfs42proc.c
* Unmerged path fs/nfs/pnfs.c
diff --git a/fs/nfs/pnfs.h b/fs/nfs/pnfs.h
index e9fec461d335..933ed71d2830 100644
--- a/fs/nfs/pnfs.h
+++ b/fs/nfs/pnfs.h
@@ -178,6 +178,8 @@ struct pnfs_layoutdriver_type {
 	void (*encode_layoutcommit) (struct pnfs_layout_hdr *lo,
 				     struct xdr_stream *xdr,
 				     const struct nfs4_layoutcommit_args *args);
+	int (*prepare_layoutstats) (struct nfs42_layoutstat_args *args);
+	void (*cleanup_layoutstats) (struct nfs42_layoutstat_data *data);
 };
 
 struct pnfs_layout_hdr {
@@ -290,6 +292,7 @@ int pnfs_write_done_resend_to_mds(struct nfs_pgio_header *);
 struct nfs4_threshold *pnfs_mdsthreshold_alloc(void);
 void pnfs_error_mark_layout_for_return(struct inode *inode,
 				       struct pnfs_layout_segment *lseg);
+int pnfs_report_layoutstat(struct inode *inode);
 
 /* nfs4_deviceid_flags */
 enum {
