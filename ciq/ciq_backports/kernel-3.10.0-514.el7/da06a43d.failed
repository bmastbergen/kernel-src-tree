perf, x86: Stop Intel PT before kdump starts

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Takao Indoh <indou.takao@jp.fujitsu.com>
commit da06a43d3f3f3df87416f654fe15d29fecb5e321
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/da06a43d.failed

This patch stops Intel PT logging and saves its registers in memory
before kdump is started. This feature is needed to prevent Intel PT from
overwriting its log buffer after panic, and saved registers are needed to
find the last position where Intel PT wrote data.

After the crash dump is captured by kdump, users can retrieve the log buffer
from the vmcore and use it to investigate bad kernel behavior.

	Signed-off-by: Takao Indoh <indou.takao@jp.fujitsu.com>
	Signed-off-by: Peter Zijlstra (Intel) <peterz@infradead.org>
	Cc: Alexander Shishkin<alexander.shishkin@linux.intel.com>
	Cc: Arnaldo Carvalho de Melo <acme@kernel.org>
	Cc: Arnaldo Carvalho de Melo <acme@redhat.com>
	Cc: H.Peter Anvin <hpa@zytor.com>
	Cc: Jiri Olsa <jolsa@redhat.com>
	Cc: Linus Torvalds <torvalds@linux-foundation.org>
	Cc: Mike Galbraith <efault@gmx.de>
	Cc: Peter Zijlstra <peterz@infradead.org>
	Cc: Stephane Eranian <eranian@google.com>
	Cc: Thomas Gleixner <tglx@linutronix.de>
	Cc: Vince Weaver <vincent.weaver@maine.edu>
	Cc: Vivek Goyal <vgoyal@redhat.com>
Link: http://lkml.kernel.org/r/1446614553-6072-3-git-send-email-indou.takao@jp.fujitsu.com
	Signed-off-by: Ingo Molnar <mingo@kernel.org>
(cherry picked from commit da06a43d3f3f3df87416f654fe15d29fecb5e321)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kernel/crash.c
diff --cc arch/x86/kernel/crash.c
index 609354d74141,58f34319b29a..000000000000
--- a/arch/x86/kernel/crash.c
+++ b/arch/x86/kernel/crash.c
@@@ -172,7 -175,11 +178,15 @@@ void native_machine_crash_shutdown(stru
  	cpu_emergency_vmxoff();
  	cpu_emergency_svm_disable();
  
++<<<<<<< HEAD
 +	lapic_shutdown();
++=======
+ 	/*
+ 	 * Disable Intel PT to stop its logging
+ 	 */
+ 	cpu_emergency_stop_pt();
+ 
++>>>>>>> da06a43d3f3f (perf, x86: Stop Intel PT before kdump starts)
  #ifdef CONFIG_X86_IO_APIC
  	/* Prevent crash_kexec() from deadlocking on ioapic_lock. */
  	ioapic_zap_locks();
* Unmerged path arch/x86/kernel/crash.c
