KVM: VMX: align vmx->nested.nested_vmx_secondary_ctls_high to vmx->rdtscp_enabled

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Paolo Bonzini <pbonzini@redhat.com>
commit 8b97265a1516819d54c2d24b3874489a52f269d4
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/8b97265a.failed

The SECONDARY_EXEC_RDTSCP must be available iff RDTSCP is enabled in the
guest.

	Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
(cherry picked from commit 8b97265a1516819d54c2d24b3874489a52f269d4)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kvm/vmx.c
diff --cc arch/x86/kvm/vmx.c
index d1ae1d645663,dad471f8ca57..000000000000
--- a/arch/x86/kvm/vmx.c
+++ b/arch/x86/kvm/vmx.c
@@@ -8379,16 -8677,23 +8379,28 @@@ static void vmx_cpuid_update(struct kvm
  	vmx->rdtscp_enabled = false;
  	if (vmx_rdtscp_supported()) {
  		exec_control = vmcs_read32(SECONDARY_VM_EXEC_CONTROL);
 -		best = kvm_find_cpuid_entry(vcpu, 0x80000001, 0);
 -		if (best && (best->edx & bit(X86_FEATURE_RDTSCP)))
 -			vmx->rdtscp_enabled = true;
 -		else {
 -			exec_control &= ~SECONDARY_EXEC_RDTSCP;
 -			vmcs_write32(SECONDARY_VM_EXEC_CONTROL,
 -					exec_control);
 +		if (exec_control & SECONDARY_EXEC_RDTSCP) {
 +			best = kvm_find_cpuid_entry(vcpu, 0x80000001, 0);
 +			if (best && (best->edx & bit(X86_FEATURE_RDTSCP)))
 +				vmx->rdtscp_enabled = true;
 +			else {
 +				exec_control &= ~SECONDARY_EXEC_RDTSCP;
 +				vmcs_write32(SECONDARY_VM_EXEC_CONTROL,
 +						exec_control);
 +			}
  		}
++<<<<<<< HEAD
++=======
+ 
+ 		if (nested) {
+ 			if (vmx->rdtscp_enabled)
+ 				vmx->nested.nested_vmx_secondary_ctls_high |=
+ 					SECONDARY_EXEC_RDTSCP;
+ 			else
+ 				vmx->nested.nested_vmx_secondary_ctls_high &=
+ 					~SECONDARY_EXEC_RDTSCP;
+ 		}
++>>>>>>> 8b97265a1516 (KVM: VMX: align vmx->nested.nested_vmx_secondary_ctls_high to vmx->rdtscp_enabled)
  	}
  
  	/* Exposing INVPCID only when PCID is exposed */
* Unmerged path arch/x86/kvm/vmx.c
