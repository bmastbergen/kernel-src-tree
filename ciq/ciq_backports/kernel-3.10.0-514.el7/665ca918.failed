s390/stacktrace: fix save_stack_trace_tsk() for current task

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
Rebuild_CHGLOG: - [s390] stacktrace: fix save_stack_trace_tsk() for current task (Pratyush Anand) [1297488]
Rebuild_FUZZ: 95.65%
commit-author Heiko Carstens <heiko.carstens@de.ibm.com>
commit 665ca9187c4087736fa57b0e00bcf33ea601fb6f
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/665ca918.failed

The function save_stack_trace_tsk() did not consider that it can be
used for tsk == current, for which the current stack pointer obviously
cannot be found in the thread structure.

Fix this and get the stack pointer with an inline assembly.

This fixes e.g. the output of "cat /proc/self/stack".

Before:
[<0000000000000000>]           (null)
[<ffffffffffffffff>] 0xffffffffffffffff

After:
[<000000000011b3ee>] save_stack_trace_tsk+0x56/0x98
[<0000000000366cde>] proc_pid_stack+0xae/0x108
[<00000000003636f0>] proc_single_show+0x70/0xc0
[<0000000000311fbc>] seq_read+0xcc/0x448
[<00000000002e7716>] __vfs_read+0x36/0x100
[<00000000002e872e>] vfs_read+0x76/0x130
[<00000000002e975e>] SyS_read+0x66/0xd8
[<000000000089490e>] system_call+0xd6/0x264
[<ffffffffffffffff>] 0xffffffffffffffff

	Signed-off-by: Heiko Carstens <heiko.carstens@de.ibm.com>
	Tested-by: Peter Oberparleiter <oberpar@linux.vnet.ibm.com>
	Signed-off-by: Martin Schwidefsky <schwidefsky@de.ibm.com>
(cherry picked from commit 665ca9187c4087736fa57b0e00bcf33ea601fb6f)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/s390/kernel/stacktrace.c
diff --cc arch/s390/kernel/stacktrace.c
index 1785cd82253c,dd484c75be56..000000000000
--- a/arch/s390/kernel/stacktrace.c
+++ b/arch/s390/kernel/stacktrace.c
@@@ -86,7 -85,11 +86,15 @@@ void save_stack_trace_tsk(struct task_s
  {
  	unsigned long sp, low, high;
  
++<<<<<<< HEAD
 +	sp = tsk->thread.ksp & PSW_ADDR_INSN;
++=======
+ 	sp = tsk->thread.ksp;
+ 	if (tsk == current) {
+ 		/* Get current stack pointer. */
+ 		asm volatile("la %0,0(15)" : "=a" (sp));
+ 	}
++>>>>>>> 665ca9187c40 (s390/stacktrace: fix save_stack_trace_tsk() for current task)
  	low = (unsigned long) task_stack_page(tsk);
  	high = (unsigned long) task_pt_regs(tsk);
  	save_context_stack(trace, sp, low, high, 0);
* Unmerged path arch/s390/kernel/stacktrace.c
