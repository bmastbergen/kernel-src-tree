openvswitch: Ensure flow is valid before executing ct

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Joe Stringer <joestringer@nicira.com>
commit ec0d043d05e6e3c0c2fac5de922c800c027c6386
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/ec0d043d.failed

The ct action uses parts of the flow key, so we need to ensure that it
is valid before executing that action.

Fixes: 7f8a436eaa2c "openvswitch: Add conntrack action"
	Signed-off-by: Joe Stringer <joestringer@nicira.com>
	Acked-by: Pravin B Shelar <pshelar@nicira.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit ec0d043d05e6e3c0c2fac5de922c800c027c6386)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/openvswitch/actions.c
diff --cc net/openvswitch/actions.c
index 1970b0908585,c6a39bf2c3b9..000000000000
--- a/net/openvswitch/actions.c
+++ b/net/openvswitch/actions.c
@@@ -932,6 -1100,21 +932,24 @@@ static int do_execute_actions(struct da
  		case OVS_ACTION_ATTR_SAMPLE:
  			err = sample(dp, skb, key, a, attr, len);
  			break;
++<<<<<<< HEAD
++=======
+ 
+ 		case OVS_ACTION_ATTR_CT:
+ 			if (!is_flow_key_valid(key)) {
+ 				err = ovs_flow_key_update(skb, key);
+ 				if (err)
+ 					return err;
+ 			}
+ 
+ 			err = ovs_ct_execute(ovs_dp_get_net(dp), skb, key,
+ 					     nla_data(a));
+ 
+ 			/* Hide stolen IP fragments from user space. */
+ 			if (err == -EINPROGRESS)
+ 				return 0;
+ 			break;
++>>>>>>> ec0d043d05e6 (openvswitch: Ensure flow is valid before executing ct)
  		}
  
  		if (unlikely(err)) {
* Unmerged path net/openvswitch/actions.c
