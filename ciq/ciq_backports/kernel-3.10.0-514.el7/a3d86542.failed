perf/x86/intel/pebs: Add PEBSv3 decoding

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Peter Zijlstra <peterz@infradead.org>
commit a3d86542de8850be52e8589da22b24002941dfb7
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/a3d86542.failed

PEBSv3 as present on Skylake fixed the long standing issue of the
status bits. They now really reflect the events that generated the
record.

	Tested-by: Andi Kleen <ak@linux.intel.com>
	Tested-by: Kan Liang <kan.liang@intel.com>
	Signed-off-by: Peter Zijlstra (Intel) <peterz@infradead.org>
	Cc: Andrew Morton <akpm@linux-foundation.org>
	Cc: H. Peter Anvin <hpa@zytor.com>
	Cc: Linus Torvalds <torvalds@linux-foundation.org>
	Cc: Peter Zijlstra <peterz@infradead.org>
	Cc: Thomas Gleixner <tglx@linutronix.de>
	Signed-off-by: Ingo Molnar <mingo@kernel.org>
(cherry picked from commit a3d86542de8850be52e8589da22b24002941dfb7)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kernel/cpu/perf_event_intel_ds.c
diff --cc arch/x86/kernel/cpu/perf_event_intel_ds.c
index 923d9fc3cc3a,71fc40238843..000000000000
--- a/arch/x86/kernel/cpu/perf_event_intel_ds.c
+++ b/arch/x86/kernel/cpu/perf_event_intel_ds.c
@@@ -1112,8 -1125,9 +1113,12 @@@ static void intel_pmu_drain_pebs_nhm(st
  	struct debug_store *ds = cpuc->ds;
  	struct perf_event *event;
  	void *base, *at, *top;
- 	int bit;
  	short counts[MAX_PEBS_EVENTS] = {};
++<<<<<<< HEAD
++=======
+ 	short error[MAX_PEBS_EVENTS] = {};
+ 	int bit, i;
++>>>>>>> a3d86542de88 (perf/x86/intel/pebs: Add PEBSv3 decoding)
  
  	if (!x86_pmu.pebs_active)
  		return;
@@@ -1157,8 -1180,12 +1171,15 @@@
  			/* slow path */
  			pebs_status = p->status & cpuc->pebs_enabled;
  			pebs_status &= (1ULL << MAX_PEBS_EVENTS) - 1;
++<<<<<<< HEAD
 +			if (pebs_status != (1 << bit))
++=======
+ 			if (pebs_status != (1 << bit)) {
+ 				for_each_set_bit(i, (unsigned long *)&pebs_status,
+ 						 MAX_PEBS_EVENTS)
+ 					error[i]++;
++>>>>>>> a3d86542de88 (perf/x86/intel/pebs: Add PEBSv3 decoding)
  				continue;
 -			}
  		}
  		counts[bit]++;
  	}
* Unmerged path arch/x86/kernel/cpu/perf_event_intel_ds.c
