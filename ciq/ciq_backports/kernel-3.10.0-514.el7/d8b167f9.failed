perf tests: Move x86 tests into arch directory

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Matt Fleming <matt.fleming@intel.com>
commit d8b167f9d8af817073ee35cf904e2e527465dbc1
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/d8b167f9.failed

Move out the x86-specific tests into tools/perf/arch/x86/tests and
define an 'arch_tests' array, which is the list of tests that only apply
to the build architecture.

We can also now begin to get rid of some of the #ifdef code that is
present in the generic perf tests.

	Signed-off-by: Matt Fleming <matt.fleming@intel.com>
	Cc: Adrian Hunter <adrian.hunter@intel.com>
	Cc: Andi Kleen <ak@linux.intel.com>
	Cc: Fenghua Yu <fenghua.yu@intel.com>
	Cc: Jiri Olsa <jolsa@redhat.com>
	Cc: Kanaka Juvva <kanaka.d.juvva@intel.com>
	Cc: Peter Zijlstra <peterz@infradead.org>
	Cc: Vikas Shivappa <vikas.shivappa@intel.com>
	Cc: Vince Weaver <vince@deater.net>
Link: http://lkml.kernel.org/n/tip-9s68h4ptg06ah0lgnjz55mqn@git.kernel.org
	Signed-off-by: Arnaldo Carvalho de Melo <acme@redhat.com>
(cherry picked from commit d8b167f9d8af817073ee35cf904e2e527465dbc1)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/perf/arch/x86/tests/gen-insn-x86-dat.awk
#	tools/perf/arch/x86/tests/gen-insn-x86-dat.sh
#	tools/perf/arch/x86/tests/insn-x86-dat-32.c
#	tools/perf/arch/x86/tests/insn-x86-dat-64.c
#	tools/perf/arch/x86/tests/insn-x86-dat-src.c
#	tools/perf/arch/x86/tests/insn-x86.c
#	tools/perf/tests/Build
#	tools/perf/tests/builtin-test.c
#	tools/perf/tests/tests.h
diff --cc tools/perf/tests/Build
index d20d6e6ab65b,50de2253cff6..000000000000
--- a/tools/perf/tests/Build
+++ b/tools/perf/tests/Build
@@@ -32,9 -31,9 +31,12 @@@ perf-y += sample-parsing.
  perf-y += parse-no-sample-id-all.o
  perf-y += kmod-path.o
  perf-y += thread-map.o
 -perf-y += llvm.o
 -perf-y += topology.o
  
++<<<<<<< HEAD
 +perf-$(CONFIG_X86) += perf-time-to-tsc.o
 +
++=======
++>>>>>>> d8b167f9d8af (perf tests: Move x86 tests into arch directory)
  ifeq ($(ARCH),$(filter $(ARCH),x86 arm arm64))
  perf-$(CONFIG_DWARF_UNWIND) += dwarf-unwind.o
  endif
diff --cc tools/perf/tests/builtin-test.c
index 2a451197cb6b,66f72d3d6677..000000000000
--- a/tools/perf/tests/builtin-test.c
+++ b/tools/perf/tests/builtin-test.c
@@@ -178,6 -158,14 +158,17 @@@ static struct test generic_tests[] = 
  		.func = test__thread_map,
  	},
  	{
++<<<<<<< HEAD
++=======
+ 		.desc = "Test LLVM searching and compiling",
+ 		.func = test__llvm,
+ 	},
+ 	{
+ 		.desc = "Test topology in session",
+ 		.func = test_session_topology,
+ 	},
+ 	{
++>>>>>>> d8b167f9d8af (perf tests: Move x86 tests into arch directory)
  		.func = NULL,
  	},
  };
diff --cc tools/perf/tests/tests.h
index a08027794fa0,c80486969f83..000000000000
--- a/tools/perf/tests/tests.h
+++ b/tools/perf/tests/tests.h
@@@ -67,8 -65,10 +65,13 @@@ int test__fdarray__filter(void)
  int test__fdarray__add(void);
  int test__kmod_path__parse(void);
  int test__thread_map(void);
++<<<<<<< HEAD
++=======
+ int test__llvm(void);
+ int test_session_topology(void);
++>>>>>>> d8b167f9d8af (perf tests: Move x86 tests into arch directory)
  
- #if defined(__x86_64__) || defined(__i386__) || defined(__arm__) || defined(__aarch64__)
+ #if defined(__arm__) || defined(__aarch64__)
  #ifdef HAVE_DWARF_UNWIND_SUPPORT
  struct thread;
  struct perf_sample;
* Unmerged path tools/perf/arch/x86/tests/gen-insn-x86-dat.awk
* Unmerged path tools/perf/arch/x86/tests/gen-insn-x86-dat.sh
* Unmerged path tools/perf/arch/x86/tests/insn-x86-dat-32.c
* Unmerged path tools/perf/arch/x86/tests/insn-x86-dat-64.c
* Unmerged path tools/perf/arch/x86/tests/insn-x86-dat-src.c
* Unmerged path tools/perf/arch/x86/tests/insn-x86.c
diff --git a/tools/perf/arch/x86/include/arch-tests.h b/tools/perf/arch/x86/include/arch-tests.h
index 4bd41d8e1ca4..5927cf224325 100644
--- a/tools/perf/arch/x86/include/arch-tests.h
+++ b/tools/perf/arch/x86/include/arch-tests.h
@@ -1,6 +1,18 @@
 #ifndef ARCH_TESTS_H
 #define ARCH_TESTS_H
 
+/* Tests */
+int test__rdpmc(void);
+int test__perf_time_to_tsc(void);
+int test__insn_x86(void);
+
+#ifdef HAVE_DWARF_UNWIND_SUPPORT
+struct thread;
+struct perf_sample;
+int test__arch_unwind_sample(struct perf_sample *sample,
+			     struct thread *thread);
+#endif
+
 extern struct test arch_tests[];
 
 #endif
diff --git a/tools/perf/arch/x86/tests/Build b/tools/perf/arch/x86/tests/Build
index d827ef384b33..8e2c5a38c3b9 100644
--- a/tools/perf/arch/x86/tests/Build
+++ b/tools/perf/arch/x86/tests/Build
@@ -2,3 +2,6 @@ libperf-$(CONFIG_DWARF_UNWIND) += regs_load.o
 libperf-$(CONFIG_DWARF_UNWIND) += dwarf-unwind.o
 
 libperf-y += arch-tests.o
+libperf-y += rdpmc.o
+libperf-y += perf-time-to-tsc.o
+libperf-$(CONFIG_AUXTRACE) += insn-x86.o
diff --git a/tools/perf/arch/x86/tests/arch-tests.c b/tools/perf/arch/x86/tests/arch-tests.c
index fca9eb9d39a2..d116c217af99 100644
--- a/tools/perf/arch/x86/tests/arch-tests.c
+++ b/tools/perf/arch/x86/tests/arch-tests.c
@@ -3,6 +3,26 @@
 #include "arch-tests.h"
 
 struct test arch_tests[] = {
+	{
+		.desc = "x86 rdpmc test",
+		.func = test__rdpmc,
+	},
+	{
+		.desc = "Test converting perf time to TSC",
+		.func = test__perf_time_to_tsc,
+	},
+#ifdef HAVE_DWARF_UNWIND_SUPPORT
+	{
+		.desc = "Test dwarf unwind",
+		.func = test__dwarf_unwind,
+	},
+#endif
+#ifdef HAVE_AUXTRACE_SUPPORT
+	{
+		.desc = "Test x86 instruction decoder - new instructions",
+		.func = test__insn_x86,
+	},
+#endif
 	{
 		.func = NULL,
 	},
diff --git a/tools/perf/arch/x86/tests/dwarf-unwind.c b/tools/perf/arch/x86/tests/dwarf-unwind.c
index d8bbf7ad1681..7f209ce827bf 100644
--- a/tools/perf/arch/x86/tests/dwarf-unwind.c
+++ b/tools/perf/arch/x86/tests/dwarf-unwind.c
@@ -5,6 +5,7 @@
 #include "event.h"
 #include "debug.h"
 #include "tests/tests.h"
+#include "arch-tests.h"
 
 #define STACK_SIZE 8192
 
* Unmerged path tools/perf/arch/x86/tests/gen-insn-x86-dat.awk
* Unmerged path tools/perf/arch/x86/tests/gen-insn-x86-dat.sh
* Unmerged path tools/perf/arch/x86/tests/insn-x86-dat-32.c
* Unmerged path tools/perf/arch/x86/tests/insn-x86-dat-64.c
* Unmerged path tools/perf/arch/x86/tests/insn-x86-dat-src.c
* Unmerged path tools/perf/arch/x86/tests/insn-x86.c
diff --git a/tools/perf/tests/perf-time-to-tsc.c b/tools/perf/arch/x86/tests/perf-time-to-tsc.c
similarity index 98%
rename from tools/perf/tests/perf-time-to-tsc.c
rename to tools/perf/arch/x86/tests/perf-time-to-tsc.c
index 5f49484f1abc..658cd200af74 100644
--- a/tools/perf/tests/perf-time-to-tsc.c
+++ b/tools/perf/arch/x86/tests/perf-time-to-tsc.c
@@ -9,7 +9,9 @@
 #include "thread_map.h"
 #include "cpumap.h"
 #include "tsc.h"
-#include "tests.h"
+#include "tests/tests.h"
+
+#include "arch-tests.h"
 
 #define CHECK__(x) {				\
 	while ((x) < 0) {			\
diff --git a/tools/perf/tests/rdpmc.c b/tools/perf/arch/x86/tests/rdpmc.c
similarity index 97%
rename from tools/perf/tests/rdpmc.c
rename to tools/perf/arch/x86/tests/rdpmc.c
index d31f2c4d9f64..e7688214c7cf 100644
--- a/tools/perf/tests/rdpmc.c
+++ b/tools/perf/arch/x86/tests/rdpmc.c
@@ -5,10 +5,9 @@
 #include <linux/types.h>
 #include "perf.h"
 #include "debug.h"
-#include "tests.h"
+#include "tests/tests.h"
 #include "cloexec.h"
-
-#if defined(__x86_64__) || defined(__i386__)
+#include "arch-tests.h"
 
 static u64 rdpmc(unsigned int counter)
 {
@@ -173,5 +172,3 @@ int test__rdpmc(void)
 
 	return 0;
 }
-
-#endif
* Unmerged path tools/perf/tests/Build
* Unmerged path tools/perf/tests/builtin-test.c
diff --git a/tools/perf/tests/dwarf-unwind.c b/tools/perf/tests/dwarf-unwind.c
index 9b748e1ad46e..63350213ee19 100644
--- a/tools/perf/tests/dwarf-unwind.c
+++ b/tools/perf/tests/dwarf-unwind.c
@@ -11,6 +11,10 @@
 #include "thread.h"
 #include "callchain.h"
 
+#if defined (__x86_64__) || defined (__i386__)
+#include "arch-tests.h"
+#endif
+
 /* For bsearch. We try to unwind functions in shared object. */
 #include <stdlib.h>
 
* Unmerged path tools/perf/tests/tests.h
