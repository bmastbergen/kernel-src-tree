RDMA/ocrdma: Fix vlan-id assignment in qp parameters

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Devesh Sharma <devesh.sharma@avagotech.com>
commit c6002d5602ab36c19ef4fe0e20ecfa28aaabf028
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/c6002d56.failed

vlan-id is wrongly getting as 0 when PFC is enabled.
Set vlan-id configured by user in QP parameters.
In case vlan interface is not used, flash a warning to
user to configure vlan and assign vlan-id as 0 in qp params.

Fixes: dbf727de7440 ('IB/core: Use GID table in AH creation and dmac resolution')
	Cc: Matan Barak <matanb@mellanox.com>
	Signed-off-by: Devesh Sharma <devesh.sharma@avagotech.com>
	Signed-off-by: Doug Ledford <dledford@redhat.com>
(cherry picked from commit c6002d5602ab36c19ef4fe0e20ecfa28aaabf028)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/hw/ocrdma/ocrdma_hw.c
diff --cc drivers/infiniband/hw/ocrdma/ocrdma_hw.c
index 9d9914299866,4fc2bb49c28e..000000000000
--- a/drivers/infiniband/hw/ocrdma/ocrdma_hw.c
+++ b/drivers/infiniband/hw/ocrdma/ocrdma_hw.c
@@@ -2508,17 -2514,16 +2508,29 @@@ static int ocrdma_set_av_params(struct 
  	ocrdma_cpu_to_le32(&cmd->params.dgid[0], sizeof(cmd->params.dgid));
  	ocrdma_cpu_to_le32(&cmd->params.sgid[0], sizeof(cmd->params.sgid));
  	cmd->params.vlan_dmac_b4_to_b5 = mac_addr[4] | (mac_addr[5] << 8);
 +	if (attr_mask & IB_QP_VID) {
 +		vlan_id = attrs->vlan_id;
 +	} else if (dev->pfc_state) {
 +		vlan_id = 0;
 +		pr_err("ocrdma%d:Using VLAN with PFC is recommended\n",
 +			dev->id);
 +		pr_err("ocrdma%d:Using VLAN 0 for this connection\n",
 +			dev->id);
 +	}
  
++<<<<<<< HEAD
 +	if (vlan_id < 0x1000) {
++=======
+ 	if (vlan_id == 0xFFFF)
+ 		vlan_id = 0;
+ 	if (vlan_id || dev->pfc_state) {
+ 		if (!vlan_id) {
+ 			pr_err("ocrdma%d:Using VLAN with PFC is recommended\n",
+ 			       dev->id);
+ 			pr_err("ocrdma%d:Using VLAN 0 for this connection\n",
+ 			       dev->id);
+ 		}
++>>>>>>> c6002d5602ab (RDMA/ocrdma: Fix vlan-id assignment in qp parameters)
  		cmd->params.vlan_dmac_b4_to_b5 |=
  		    vlan_id << OCRDMA_QP_PARAMS_VLAN_SHIFT;
  		cmd->flags |= OCRDMA_QP_PARA_VLAN_EN_VALID;
* Unmerged path drivers/infiniband/hw/ocrdma/ocrdma_hw.c
