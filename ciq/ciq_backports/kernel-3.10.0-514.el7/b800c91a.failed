mm: fix corner case in anon_vma endless growing prevention

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
Rebuild_CHGLOG: - [mm] fix corner case in anon_vma endless growing prevention (Jerome Marchand) [1341497]
Rebuild_FUZZ: 96.43%
commit-author Konstantin Khlebnikov <koct9i@gmail.com>
commit b800c91a0517071156e772d4fb329ad33590da62
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/b800c91a.failed

Fix for BUG_ON(anon_vma->degree) splashes in unlink_anon_vmas() ("kernel
BUG at mm/rmap.c:399!") caused by commit 7a3ef208e662 ("mm: prevent
endless growth of anon_vma hierarchy")

Anon_vma_clone() is usually called for a copy of source vma in
destination argument.  If source vma has anon_vma it should be already
in dst->anon_vma.  NULL in dst->anon_vma is used as a sign that it's
called from anon_vma_fork().  In this case anon_vma_clone() finds
anon_vma for reusing.

Vma_adjust() calls it differently and this breaks anon_vma reusing
logic: anon_vma_clone() links vma to old anon_vma and updates degree
counters but vma_adjust() overrides vma->anon_vma right after that.  As
a result final unlink_anon_vmas() decrements degree for wrong anon_vma.

This patch assigns ->anon_vma before calling anon_vma_clone().

	Signed-off-by: Konstantin Khlebnikov <koct9i@gmail.com>
Reported-and-tested-by: Chris Clayton <chris2553@googlemail.com>
Reported-and-tested-by: Oded Gabbay <oded.gabbay@amd.com>
Reported-and-tested-by: Chih-Wei Huang <cwhuang@android-x86.org>
	Acked-by: Rik van Riel <riel@redhat.com>
	Acked-by: Vlastimil Babka <vbabka@suse.cz>
	Cc: Daniel Forrest <dan.forrest@ssec.wisc.edu>
	Cc: Michal Hocko <mhocko@suse.cz>
	Cc: stable@vger.kernel.org  # to match back-porting of 7a3ef208e662
	Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
(cherry picked from commit b800c91a0517071156e772d4fb329ad33590da62)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	mm/mmap.c
diff --cc mm/mmap.c
index dc2927ad5660,7f684d5a8087..000000000000
--- a/mm/mmap.c
+++ b/mm/mmap.c
@@@ -744,9 -776,14 +744,19 @@@ again:			remove_next = 1 + (end > next-
  		 * shrinking vma had, to cover any anon pages imported.
  		 */
  		if (exporter && exporter->anon_vma && !importer->anon_vma) {
++<<<<<<< HEAD
 +			if (anon_vma_clone(importer, exporter))
 +				return -ENOMEM;
++=======
+ 			int error;
+ 
++>>>>>>> b800c91a0517 (mm: fix corner case in anon_vma endless growing prevention)
  			importer->anon_vma = exporter->anon_vma;
+ 			error = anon_vma_clone(importer, exporter);
+ 			if (error) {
+ 				importer->anon_vma = NULL;
+ 				return error;
+ 			}
  		}
  	}
  
* Unmerged path mm/mmap.c
