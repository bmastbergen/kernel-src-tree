usb: common: otg-fsm: only signal connect after switching to peripheral

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
Rebuild_CHGLOG: - [usb] common: otg-fsm: only signal connect after switching to peripheral (Don Zickus) [1303209]
Rebuild_FUZZ: 96.35%
commit-author Peter Chen <peter.chen@freescale.com>
commit a886bd92267c9e3d5c912860c6fb5a68479a7643
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/a886bd92.failed

We should signal connect (pull up dp) after we have already
at peripheral mode, otherwise, the dp may be toggled due to
we reset controller or do disconnect during the initialization
for peripheral, then, the host may be confused during the
enumeration, eg, it finds the reset can't succeed, but the
device is still there, see below error message.

hub 1-0:1.0: USB hub found
hub 1-0:1.0: 1 port detected
hub 1-0:1.0: cannot reset port 1 (err = -32)
hub 1-0:1.0: cannot reset port 1 (err = -32)
hub 1-0:1.0: cannot reset port 1 (err = -32)
hub 1-0:1.0: cannot reset port 1 (err = -32)
hub 1-0:1.0: cannot reset port 1 (err = -32)
hub 1-0:1.0: Cannot enable port 1.  Maybe the USB cable is bad?
hub 1-0:1.0: cannot reset port 1 (err = -32)
hub 1-0:1.0: cannot reset port 1 (err = -32)
hub 1-0:1.0: cannot reset port 1 (err = -32)
hub 1-0:1.0: cannot reset port 1 (err = -32)
hub 1-0:1.0: cannot reset port 1 (err = -32)
hub 1-0:1.0: Cannot enable port 1.  Maybe the USB cable is bad?
hub 1-0:1.0: cannot reset port 1 (err = -32)
hub 1-0:1.0: cannot reset port 1 (err = -32)
hub 1-0:1.0: cannot reset port 1 (err = -32)
hub 1-0:1.0: cannot reset port 1 (err = -32)
hub 1-0:1.0: cannot reset port 1 (err = -32)
hub 1-0:1.0: Cannot enable port 1.  Maybe the USB cable is bad?
hub 1-0:1.0: cannot reset port 1 (err = -32)
hub 1-0:1.0: cannot reset port 1 (err = -32)
hub 1-0:1.0: cannot reset port 1 (err = -32)
hub 1-0:1.0: cannot reset port 1 (err = -32)
hub 1-0:1.0: cannot reset port 1 (err = -32)
hub 1-0:1.0: Cannot enable port 1.  Maybe the USB cable is bad?
hub 1-0:1.0: unable to enumerate USB device on port 1

Fixes: the issue existed when the otg fsm code was added.
	Cc: <stable@vger.kernel.org> # v3.16+
	Signed-off-by: Peter Chen <peter.chen@freescale.com>
	Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
(cherry picked from commit a886bd92267c9e3d5c912860c6fb5a68479a7643)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/usb/phy/phy-fsm-usb.c
diff --cc drivers/usb/phy/phy-fsm-usb.c
index 62aa5e160867,61d538aa2346..000000000000
--- a/drivers/usb/phy/phy-fsm-usb.c
+++ b/drivers/usb/phy/phy-fsm-usb.c
@@@ -202,7 -216,8 +202,11 @@@ int otg_set_state(struct otg_fsm *fsm, 
  		otg_loc_sof(fsm, 0);
  		otg_set_protocol(fsm, PROTO_GADGET);
  		otg_drv_vbus(fsm, 1);
++<<<<<<< HEAD:drivers/usb/phy/phy-fsm-usb.c
++=======
+ 		otg_loc_conn(fsm, 1);
+ 		otg_add_timer(fsm, A_BIDL_ADIS);
++>>>>>>> a886bd92267c (usb: common: otg-fsm: only signal connect after switching to peripheral):drivers/usb/common/usb-otg-fsm.c
  		break;
  	case OTG_STATE_A_WAIT_VFALL:
  		otg_drv_vbus(fsm, 0);
* Unmerged path drivers/usb/phy/phy-fsm-usb.c
