IB/hfi1: Fix ordering of trace for accuracy

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Mike Marciniszyn <mike.marciniszyn@intel.com>
commit 5326dfbf005ca8589d709209a81d145c5b87b23d
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/5326dfbf.failed

The postitioning of the sdma ibhdr trace was
causing an extra trace message when the tx send
returned -EBUSY.

Move the trace to just before the return
and handle negative return values to avoid
any trace.

	Reviewed-by: Dennis Dalessandro <dennis.dalessandro@intel.com>
	Signed-off-by: Mike Marciniszyn <mike.marciniszyn@intel.com>
	Signed-off-by: Doug Ledford <dledford@redhat.com>
(cherry picked from commit 5326dfbf005ca8589d709209a81d145c5b87b23d)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/staging/hfi1/verbs.c
diff --cc drivers/staging/hfi1/verbs.c
index d228eb7fc4f0,467e6c349c68..000000000000
--- a/drivers/staging/hfi1/verbs.c
+++ b/drivers/staging/hfi1/verbs.c
@@@ -1014,45 -872,33 +1014,56 @@@ int hfi1_verbs_send_dma(struct hfi1_qp 
  
  	int ret;
  
 -	tx = ps->s_txreq;
 -	if (!sdma_txreq_built(&tx->txreq)) {
 -		if (likely(pbc == 0)) {
 -			u32 vl = sc_to_vlt(dd_from_ibdev(qp->ibqp.device), sc5);
 -			/* No vl15 here */
 -			/* set PBC_DC_INFO bit (aka SC[4]) in pbc_flags */
 -			pbc_flags |= (!!(sc5 & 0x10)) << PBC_DC_INFO_SHIFT;
 -
 -			pbc = create_pbc(ppd,
 -					 pbc_flags,
 -					 qp->srate_mbps,
 -					 vl,
 -					 plen);
 -		}
 -		tx->wqe = qp->s_wqe;
 -		ret = build_verbs_tx_desc(tx->sde, ss, len, tx, ahdr, pbc);
 -		if (unlikely(ret))
 -			goto bail_build;
 +	if (!list_empty(&priv->s_iowait.tx_head)) {
 +		stx = list_first_entry(
 +			&priv->s_iowait.tx_head,
 +			struct sdma_txreq,
 +			list);
 +		list_del_init(&stx->list);
 +		tx = container_of(stx, struct verbs_txreq, txreq);
 +		ret = sdma_send_txreq(tx->sde, &priv->s_iowait, stx);
 +		if (unlikely(ret == -ECOMM))
 +			goto bail_ecomm;
 +		return ret;
  	}
++<<<<<<< HEAD:drivers/staging/hfi1/verbs.c
 +
 +	tx = get_txreq(dev, qp);
 +	if (IS_ERR(tx))
 +		goto bail_tx;
 +
 +	tx->sde = priv->s_sde;
 +
 +	if (likely(pbc == 0)) {
 +		u32 vl = sc_to_vlt(dd_from_ibdev(qp->ibqp.device), sc5);
 +		/* No vl15 here */
 +		/* set PBC_DC_INFO bit (aka SC[4]) in pbc_flags */
 +		pbc_flags |= (!!(sc5 & 0x10)) << PBC_DC_INFO_SHIFT;
 +
 +		pbc = create_pbc(ppd, pbc_flags, qp->srate_mbps, vl, plen);
 +	}
 +	tx->wqe = qp->s_wqe;
 +	tx->mr = qp->s_rdma_mr;
 +	if (qp->s_rdma_mr)
 +		qp->s_rdma_mr = NULL;
 +	tx->hdr_dwords = hdrwords + 2;
 +	ret = build_verbs_tx_desc(tx->sde, ss, len, tx, ahdr, pbc);
 +	if (unlikely(ret))
 +		goto bail_build;
 +	trace_output_ibhdr(dd_from_ibdev(qp->ibqp.device), &ahdr->ibh);
 +	ret =  sdma_send_txreq(tx->sde, &priv->s_iowait, &tx->txreq);
 +	if (unlikely(ret == -ECOMM))
 +		goto bail_ecomm;
++=======
+ 	ret =  sdma_send_txreq(tx->sde, &priv->s_iowait, &tx->txreq);
+ 	if (unlikely(ret < 0)) {
+ 		if (ret == -ECOMM)
+ 			goto bail_ecomm;
+ 		return ret;
+ 	}
+ 	trace_sdma_output_ibhdr(dd_from_ibdev(qp->ibqp.device),
+ 				&ps->s_txreq->phdr.hdr);
++>>>>>>> 5326dfbf005c (IB/hfi1: Fix ordering of trace for accuracy):drivers/staging/rdma/hfi1/verbs.c
  	return ret;
  
  bail_ecomm:
* Unmerged path drivers/staging/hfi1/verbs.c
