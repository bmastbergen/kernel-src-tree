IB/MAD: Integrate ib_mad module into ib_core module

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Mark Bloch <markb@mellanox.com>
commit 4c2cb4220431cbf92233dc12733ee8962abb9081
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/4c2cb422.failed

Consolidate ib_mad into ib_core, this commit eliminates
ib_mad.ko and makes it part of ib_core.ko

	Signed-off-by: Mark Bloch <markb@mellanox.com>
	Signed-off-by: Doug Ledford <dledford@redhat.com>
(cherry picked from commit 4c2cb4220431cbf92233dc12733ee8962abb9081)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/core/Makefile
#	drivers/infiniband/core/core_priv.h
#	drivers/infiniband/core/device.c
diff --cc drivers/infiniband/core/Makefile
index ae48d874012f,cc0a6042ccf4..000000000000
--- a/drivers/infiniband/core/Makefile
+++ b/drivers/infiniband/core/Makefile
@@@ -1,16 -1,17 +1,26 @@@
  infiniband-$(CONFIG_INFINIBAND_ADDR_TRANS)	:= rdma_cm.o
  user_access-$(CONFIG_INFINIBAND_ADDR_TRANS)	:= rdma_ucm.o
  
++<<<<<<< HEAD
 +obj-$(CONFIG_INFINIBAND) +=		ib_core.o ib_mad.o ib_sa.o \
 +					ib_cm.o iw_cm.o ib_addr.o \
++=======
+ obj-$(CONFIG_INFINIBAND) +=		ib_core.o ib_sa.o \
+ 					ib_cm.o iw_cm.o \
++>>>>>>> 4c2cb4220431 (IB/MAD: Integrate ib_mad module into ib_core module)
  					$(infiniband-y)
  obj-$(CONFIG_INFINIBAND_USER_MAD) +=	ib_umad.o
  obj-$(CONFIG_INFINIBAND_USER_ACCESS) +=	ib_uverbs.o ib_ucm.o \
  					$(user_access-y)
  
 -ib_core-y :=			packer.o ud_header.o verbs.o cq.o rw.o sysfs.o \
 +ib_core-y :=			packer.o ud_header.o verbs.o cq.o sysfs.o \
  				device.o fmr_pool.o cache.o netlink.o \
++<<<<<<< HEAD
 +				roce_gid_mgmt.o
++=======
+ 				roce_gid_mgmt.o mr_pool.o addr.o \
+ 				mad.o smi.o agent.o mad_rmpp.o
++>>>>>>> 4c2cb4220431 (IB/MAD: Integrate ib_mad module into ib_core module)
  ib_core-$(CONFIG_INFINIBAND_USER_MEM) += umem.o
  ib_core-$(CONFIG_INFINIBAND_ON_DEMAND_PAGING) += umem_odp.o umem_rbtree.o
  
diff --cc drivers/infiniband/core/core_priv.h
index 0d01fb95d944,d43b2fa01ee8..000000000000
--- a/drivers/infiniband/core/core_priv.h
+++ b/drivers/infiniband/core/core_priv.h
@@@ -114,4 -137,10 +114,13 @@@ static inline bool rdma_is_upper_dev_rc
  	return _upper == upper;
  }
  
++<<<<<<< HEAD
++=======
+ int addr_init(void);
+ void addr_cleanup(void);
+ 
+ int ib_mad_init(void);
+ void ib_mad_cleanup(void);
+ 
++>>>>>>> 4c2cb4220431 (IB/MAD: Integrate ib_mad module into ib_core module)
  #endif /* _CORE_PRIV_H */
diff --cc drivers/infiniband/core/device.c
index 84b0c0c4193b,f80549fbd6f5..000000000000
--- a/drivers/infiniband/core/device.c
+++ b/drivers/infiniband/core/device.c
@@@ -974,10 -983,26 +974,32 @@@ static int __init ib_core_init(void
  		goto err_sysfs;
  	}
  
++<<<<<<< HEAD
++=======
+ 	ret = addr_init();
+ 	if (ret) {
+ 		pr_warn("Could't init IB address resolution\n");
+ 		goto err_ibnl;
+ 	}
+ 
+ 	ret = ib_mad_init();
+ 	if (ret) {
+ 		pr_warn("Couldn't init IB MAD\n");
+ 		goto err_addr;
+ 	}
+ 
++>>>>>>> 4c2cb4220431 (IB/MAD: Integrate ib_mad module into ib_core module)
  	ib_cache_setup();
  
  	return 0;
  
++<<<<<<< HEAD
++=======
+ err_addr:
+ 	addr_cleanup();
+ err_ibnl:
+ 	ibnl_cleanup();
++>>>>>>> 4c2cb4220431 (IB/MAD: Integrate ib_mad module into ib_core module)
  err_sysfs:
  	class_unregister(&ib_class);
  err_comp:
@@@ -990,6 -1015,8 +1012,11 @@@ err
  static void __exit ib_core_cleanup(void)
  {
  	ib_cache_cleanup();
++<<<<<<< HEAD
++=======
+ 	ib_mad_cleanup();
+ 	addr_cleanup();
++>>>>>>> 4c2cb4220431 (IB/MAD: Integrate ib_mad module into ib_core module)
  	ibnl_cleanup();
  	class_unregister(&ib_class);
  	destroy_workqueue(ib_comp_wq);
* Unmerged path drivers/infiniband/core/Makefile
* Unmerged path drivers/infiniband/core/core_priv.h
* Unmerged path drivers/infiniband/core/device.c
diff --git a/drivers/infiniband/core/mad.c b/drivers/infiniband/core/mad.c
index 381da3519202..ba2343447802 100644
--- a/drivers/infiniband/core/mad.c
+++ b/drivers/infiniband/core/mad.c
@@ -47,11 +47,7 @@
 #include "smi.h"
 #include "opa_smi.h"
 #include "agent.h"
-
-MODULE_LICENSE("Dual BSD/GPL");
-MODULE_DESCRIPTION("kernel IB MAD API");
-MODULE_AUTHOR("Hal Rosenstock");
-MODULE_AUTHOR("Sean Hefty");
+#include "core_priv.h"
 
 static int mad_sendq_size = IB_MAD_QP_SEND_SIZE;
 static int mad_recvq_size = IB_MAD_QP_RECV_SIZE;
@@ -3362,7 +3358,7 @@ static struct ib_client mad_client = {
 	.remove = ib_mad_remove_device
 };
 
-static int __init ib_mad_init_module(void)
+int ib_mad_init(void)
 {
 	mad_recvq_size = min(mad_recvq_size, IB_MAD_QP_MAX_SIZE);
 	mad_recvq_size = max(mad_recvq_size, IB_MAD_QP_MIN_SIZE);
@@ -3380,10 +3376,7 @@ static int __init ib_mad_init_module(void)
 	return 0;
 }
 
-static void __exit ib_mad_cleanup_module(void)
+void ib_mad_cleanup(void)
 {
 	ib_unregister_client(&mad_client);
 }
-
-module_init(ib_mad_init_module);
-module_exit(ib_mad_cleanup_module);
