ovl: check mounter creds on underlying lookup

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Miklos Szeredi <mszeredi@redhat.com>
commit c1b2cc1a765aff4df7b22abe6b66014236f73eba
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/c1b2cc1a.failed

The hash salting changes meant that we can no longer reuse the hash in the
overlay dentry to look up the underlying dentry.

Instead of lookup_hash(), use lookup_one_len_unlocked() and swith to
mounter's creds (like we do for all other operations later in the series).

Now the lookup_hash() export introduced in 4.6 by 3c9fe8cdff1b ("vfs: add
lookup_hash() helper") is unused and can possibly be removed; its
usefulness negated by the hash salting and the idea that mounter's creds
should be used on operations on underlying filesystems.

	Signed-off-by: Miklos Szeredi <mszeredi@redhat.com>
Fixes: 8387ff2577eb ("vfs: make the string hashes salt the hash")
(cherry picked from commit c1b2cc1a765aff4df7b22abe6b66014236f73eba)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/overlayfs/super.c
diff --cc fs/overlayfs/super.c
index 5c0fb1f1eab2,cbfa0398f9da..000000000000
--- a/fs/overlayfs/super.c
+++ b/fs/overlayfs/super.c
@@@ -379,14 -423,16 +379,22 @@@ static bool ovl_dentry_weird(struct den
  				  DCACHE_OP_COMPARE);
  }
  
- static inline struct dentry *ovl_lookup_real(struct dentry *dir,
+ static inline struct dentry *ovl_lookup_real(struct super_block *ovl_sb,
+ 					     struct dentry *dir,
  					     struct qstr *name)
  {
+ 	const struct cred *old_cred;
  	struct dentry *dentry;
  
++<<<<<<< HEAD
 +	mutex_lock(&dir->d_inode->i_mutex);
 +	dentry = lookup_one_len(name->name, dir, name->len);
 +	mutex_unlock(&dir->d_inode->i_mutex);
++=======
+ 	old_cred = ovl_override_creds(ovl_sb);
+ 	dentry = lookup_one_len_unlocked(name->name, dir, name->len);
+ 	revert_creds(old_cred);
++>>>>>>> c1b2cc1a765a (ovl: check mounter creds on underlying lookup)
  
  	if (IS_ERR(dentry)) {
  		if (PTR_ERR(dentry) == -ENOENT)
* Unmerged path fs/overlayfs/super.c
