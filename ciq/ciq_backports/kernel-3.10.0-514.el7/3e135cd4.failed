netfilter: nft_dynset: dynamic stateful expression instantiation

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Patrick McHardy <kaber@trash.net>
commit 3e135cd499bfbec15684fe9c756162d58df4dc77
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/3e135cd4.failed

Support instantiating stateful expressions based on a template that
are associated with dynamically created set entries. The expressions
are evaluated when adding or updating the set element.

This allows to maintain per flow state using the existing set
infrastructure and expression types, with arbitrary definitions of
a flow.

Usage is currently restricted to anonymous sets, meaning only a single
binding can exist, since the desired semantics of multiple independant
bindings haven't been defined so far.

Examples (userspace syntax is still WIP):

1. Limit the rate of new SSH connections per host, similar to iptables
   hashlimit:

	flow ip saddr timeout 60s \
	limit 10/second \
	accept

2. Account network traffic between each set of /24 networks:

	flow ip saddr & 255.255.255.0 . ip daddr & 255.255.255.0 \
	counter

3. Account traffic to each host per user:

	flow skuid . ip daddr \
	counter

4. Account traffic for each combination of source address and TCP flags:

	flow ip saddr . tcp flags \
	counter

The resulting set content after a Xmas-scan look like this:

{
	192.168.122.1 . fin | psh | urg : counter packets 1001 bytes 40040,
	192.168.122.1 . ack : counter packets 74 bytes 3848,
	192.168.122.1 . psh | ack : counter packets 35 bytes 3144
}

	Signed-off-by: Patrick McHardy <kaber@trash.net>
	Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
(cherry picked from commit 3e135cd499bfbec15684fe9c756162d58df4dc77)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	include/uapi/linux/netfilter/nf_tables.h
#	net/netfilter/nft_dynset.c
diff --cc include/uapi/linux/netfilter/nf_tables.h
index 971d245e7378,5fa1cd04762e..000000000000
--- a/include/uapi/linux/netfilter/nf_tables.h
+++ b/include/uapi/linux/netfilter/nf_tables.h
@@@ -511,6 -553,35 +511,38 @@@ enum nft_lookup_attributes 
  };
  #define NFTA_LOOKUP_MAX		(__NFTA_LOOKUP_MAX - 1)
  
++<<<<<<< HEAD
++=======
+ enum nft_dynset_ops {
+ 	NFT_DYNSET_OP_ADD,
+ 	NFT_DYNSET_OP_UPDATE,
+ };
+ 
+ /**
+  * enum nft_dynset_attributes - dynset expression attributes
+  *
+  * @NFTA_DYNSET_SET_NAME: name of set the to add data to (NLA_STRING)
+  * @NFTA_DYNSET_SET_ID: uniquely identifier of the set in the transaction (NLA_U32)
+  * @NFTA_DYNSET_OP: operation (NLA_U32)
+  * @NFTA_DYNSET_SREG_KEY: source register of the key (NLA_U32)
+  * @NFTA_DYNSET_SREG_DATA: source register of the data (NLA_U32)
+  * @NFTA_DYNSET_TIMEOUT: timeout value for the new element (NLA_U64)
+  * @NFTA_DYNSET_EXPR: expression (NLA_NESTED: nft_expr_attributes)
+  */
+ enum nft_dynset_attributes {
+ 	NFTA_DYNSET_UNSPEC,
+ 	NFTA_DYNSET_SET_NAME,
+ 	NFTA_DYNSET_SET_ID,
+ 	NFTA_DYNSET_OP,
+ 	NFTA_DYNSET_SREG_KEY,
+ 	NFTA_DYNSET_SREG_DATA,
+ 	NFTA_DYNSET_TIMEOUT,
+ 	NFTA_DYNSET_EXPR,
+ 	__NFTA_DYNSET_MAX,
+ };
+ #define NFTA_DYNSET_MAX		(__NFTA_DYNSET_MAX - 1)
+ 
++>>>>>>> 3e135cd499bf (netfilter: nft_dynset: dynamic stateful expression instantiation)
  /**
   * enum nft_payload_bases - nf_tables payload expression offset bases
   *
* Unmerged path net/netfilter/nft_dynset.c
* Unmerged path include/uapi/linux/netfilter/nf_tables.h
* Unmerged path net/netfilter/nft_dynset.c
