tools build: Build fixdep helper from perf and basic libs

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
Rebuild_CHGLOG: - [tools] build: Build fixdep helper from perf and basic libs (Jiri Olsa) [1308570]
Rebuild_FUZZ: 94.44%
commit-author Jiri Olsa <jolsa@kernel.org>
commit 7c422f5572667fef0db38d2046ecce69dcf0afc8
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/7c422f55.failed

Adding the fixdep target into the Makefile.include to ease up building of
fixdep helper, that needs to be built before we dive in to the build itself.
The user can invoke the fixdep target to build the helper.

	Signed-off-by: Jiri Olsa <jolsa@kernel.org>
	Cc: David Ahern <dsahern@gmail.com>
	Cc: Namhyung Kim <namhyung@kernel.org>
	Cc: Peter Zijlstra <a.p.zijlstra@chello.nl>
Link: http://lkml.kernel.org/r/1443004442-32660-8-git-send-email-jolsa@kernel.org
	Signed-off-by: Arnaldo Carvalho de Melo <acme@redhat.com>
(cherry picked from commit 7c422f5572667fef0db38d2046ecce69dcf0afc8)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/build/Documentation/Build.txt
#	tools/build/Makefile.include
#	tools/build/tests/ex/Makefile
#	tools/lib/bpf/Makefile
#	tools/lib/lockdep/Makefile
diff --cc tools/build/Documentation/Build.txt
index aa5e092c4352,a47bffbae159..000000000000
--- a/tools/build/Documentation/Build.txt
+++ b/tools/build/Documentation/Build.txt
@@@ -95,8 -97,31 +95,36 @@@ It's only a matter of 2 single command
  
  You can check the 'ex' example in 'tools/build/tests/ex' for more details.
  
++<<<<<<< HEAD
 +b) Rules
 +--------
++=======
+ 
+ Makefile.include
+ ----------------
+ 
+ The tools/build/Makefile.include makefile could be included
+ via user makefiles to get usefull definitions.
+ 
+ It defines following interface:
+ 
+   - build macro definition:
+       build := -f $(srctree)/tools/build/Makefile.build dir=. obj
+ 
+     to make it easier to invoke build like:
+       make $(build)=ex
+ 
+ 
+ Fixdep
+ ------
+ It is necessary to build the fixdep helper before invoking the build.
+ The Makefile.include file adds the fixdep target, that could be
+ invoked by the user.
+ 
+ 
+ Rules
+ -----
++>>>>>>> 7c422f557266 (tools build: Build fixdep helper from perf and basic libs)
  
  The build framework provides standard compilation rules to handle .S and .c
  compilation.
diff --cc tools/build/tests/ex/Makefile
index 35741b5f6b73,c50d5782ad5a..000000000000
--- a/tools/build/tests/ex/Makefile
+++ b/tools/build/tests/ex/Makefile
@@@ -3,7 -3,10 +3,14 @@@ export CC      := gc
  export LD      := ld
  export AR      := ar
  
++<<<<<<< HEAD
 +build := -f $(srctree)/tools/build/Makefile.build dir=. obj
++=======
+ ex:
+ 
+ include $(srctree)/tools/build/Makefile.include
+ 
++>>>>>>> 7c422f557266 (tools build: Build fixdep helper from perf and basic libs)
  ex: ex-in.o libex-in.o
  	gcc -o $@ $^
  
* Unmerged path tools/build/Makefile.include
* Unmerged path tools/lib/bpf/Makefile
* Unmerged path tools/lib/lockdep/Makefile
* Unmerged path tools/build/Documentation/Build.txt
* Unmerged path tools/build/Makefile.include
* Unmerged path tools/build/tests/ex/Makefile
diff --git a/tools/lib/api/Makefile b/tools/lib/api/Makefile
index fe1b02c2c95b..68e9b47c5d23 100644
--- a/tools/lib/api/Makefile
+++ b/tools/lib/api/Makefile
@@ -24,9 +24,11 @@ RM = rm -f
 build  := -f $(srctree)/tools/build/Makefile.build dir=. obj
 API_IN := $(OUTPUT)libapi-in.o
 
+all:
+
 export srctree OUTPUT CC LD CFLAGS V
 
-all: $(LIBFILE)
+all: fixdep $(LIBFILE)
 
 $(API_IN): FORCE
 	@$(MAKE) $(build)=libapi
* Unmerged path tools/lib/bpf/Makefile
* Unmerged path tools/lib/lockdep/Makefile
diff --git a/tools/perf/Makefile.perf b/tools/perf/Makefile.perf
index 40bb4c1322a4..873224ba3ddd 100644
--- a/tools/perf/Makefile.perf
+++ b/tools/perf/Makefile.perf
@@ -306,7 +306,7 @@ $(OUTPUT)perf: $(PERFLIBS) $(PERF_IN) $(LIBTRACEEVENT_DYNAMIC_LIST)
 	$(QUIET_LINK)$(CC) $(CFLAGS) $(LDFLAGS) $(LIBTRACEEVENT_DYNAMIC_LIST_LDFLAGS) \
 		$(PERF_IN) $(LIBS) -o $@
 
-$(GTK_IN): FORCE
+$(GTK_IN): fixdep FORCE
 	$(Q)$(MAKE) $(build)=gtk
 
 $(OUTPUT)libperf-gtk.so: $(GTK_IN) $(PERFLIBS)
@@ -349,7 +349,7 @@ endif
 __build-dir = $(subst $(OUTPUT),,$(dir $@))
 build-dir   = $(if $(__build-dir),$(__build-dir),.)
 
-prepare: $(OUTPUT)PERF-VERSION-FILE $(OUTPUT)common-cmds.h
+prepare: $(OUTPUT)PERF-VERSION-FILE $(OUTPUT)common-cmds.h fixdep
 
 $(OUTPUT)%.o: %.c prepare FORCE
 	$(Q)$(MAKE) -f $(srctree)/tools/build/Makefile.build dir=$(build-dir) $@
@@ -389,7 +389,7 @@ $(patsubst perf-%,%.o,$(PROGRAMS)): $(wildcard */*.h)
 
 LIBPERF_IN := $(OUTPUT)libperf-in.o
 
-$(LIBPERF_IN): FORCE
+$(LIBPERF_IN): fixdep FORCE
 	$(Q)$(MAKE) $(build)=libperf
 
 $(LIB_FILE): $(LIBPERF_IN)
@@ -397,10 +397,10 @@ $(LIB_FILE): $(LIBPERF_IN)
 
 LIBTRACEEVENT_FLAGS += plugin_dir=$(plugindir_SQ)
 
-$(LIBTRACEEVENT): FORCE
+$(LIBTRACEEVENT): fixdep FORCE
 	$(Q)$(MAKE) -C $(TRACE_EVENT_DIR) $(LIBTRACEEVENT_FLAGS) O=$(OUTPUT) $(OUTPUT)libtraceevent.a
 
-libtraceevent_plugins: FORCE
+libtraceevent_plugins: fixdep FORCE
 	$(Q)$(MAKE) -C $(TRACE_EVENT_DIR) $(LIBTRACEEVENT_FLAGS) O=$(OUTPUT) plugins
 
 $(LIBTRACEEVENT_DYNAMIC_LIST): libtraceevent_plugins
@@ -413,7 +413,7 @@ $(LIBTRACEEVENT)-clean:
 install-traceevent-plugins: $(LIBTRACEEVENT)
 	$(Q)$(MAKE) -C $(TRACE_EVENT_DIR) $(LIBTRACEEVENT_FLAGS) O=$(OUTPUT) install_plugins
 
-$(LIBAPI): FORCE
+$(LIBAPI): fixdep FORCE
 	$(Q)$(MAKE) -C $(LIB_DIR) O=$(OUTPUT) $(OUTPUT)libapi.a
 
 $(LIBAPI)-clean:
