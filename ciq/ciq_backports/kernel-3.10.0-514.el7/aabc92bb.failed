net: add __netdev_alloc_pcpu_stats() to indicate gfp flags

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
Rebuild_CHGLOG: - [net] add __netdev_alloc_pcpu_stats() to indicate gfp flags (Paolo Abeni) [1331757]
Rebuild_FUZZ: 95.50%
commit-author Pablo Neira Ayuso <pablo@netfilter.org>
commit aabc92bbe3cfe4c545f8ccdaaeeea012a46f0abf
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/aabc92bb.failed

nf_tables may create percpu counters from the packet path through its
dynamic set instantiation infrastructure, so we need a way to allocate
this through GFP_ATOMIC.

	Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
	Acked-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit aabc92bbe3cfe4c545f8ccdaaeeea012a46f0abf)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	include/linux/netdevice.h
diff --cc include/linux/netdevice.h
index 95e53059b81a,e9d0c8a75380..000000000000
--- a/include/linux/netdevice.h
+++ b/include/linux/netdevice.h
@@@ -1897,20 -2068,23 +1897,38 @@@ struct pcpu_sw_netstats 
  	struct u64_stats_sync   syncp;
  };
  
++<<<<<<< HEAD
 +#define netdev_alloc_pcpu_stats(type)				\
 +({								\
 +	typeof(type) *pcpu_stats = alloc_percpu(type);		\
 +	if (pcpu_stats)	{					\
 +		int i;						\
 +		for_each_possible_cpu(i) {			\
 +			typeof(type) *stat;			\
 +			stat = per_cpu_ptr(pcpu_stats, i);	\
 +			u64_stats_init(&stat->syncp);		\
 +		}						\
 +	}							\
 +	pcpu_stats;						\
++=======
+ #define __netdev_alloc_pcpu_stats(type, gfp)				\
+ ({									\
+ 	typeof(type) __percpu *pcpu_stats = alloc_percpu_gfp(type, gfp);\
+ 	if (pcpu_stats)	{						\
+ 		int __cpu;						\
+ 		for_each_possible_cpu(__cpu) {				\
+ 			typeof(type) *stat;				\
+ 			stat = per_cpu_ptr(pcpu_stats, __cpu);		\
+ 			u64_stats_init(&stat->syncp);			\
+ 		}							\
+ 	}								\
+ 	pcpu_stats;							\
++>>>>>>> aabc92bbe3cf (net: add __netdev_alloc_pcpu_stats() to indicate gfp flags)
  })
  
+ #define netdev_alloc_pcpu_stats(type)					\
+ 	__netdev_alloc_pcpu_stats(type, GFP_KERNEL);
+ 
  #include <linux/notifier.h>
  
  /* netdevice notifier chain. Please remember to update the rtnetlink
* Unmerged path include/linux/netdevice.h
