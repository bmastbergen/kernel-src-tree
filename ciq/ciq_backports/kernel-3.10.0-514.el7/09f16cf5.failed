IB/mlx5: Fix use of null pointer PD

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Majd Dibbiny <majd@mellanox.com>
commit 09f16cf59fbf825130c216c3af189253505dc9d9
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/09f16cf5.failed

When a Raw Ethernet QP is created, a NULL pointer PD could be used.
Fixing that by only using the PD after validating it's valid.
smatch also reported this error:
drivers/infiniband/hw/mlx5/qp.c:1629 mlx5_ib_create_qp()
	 error: we previously assumed 'pd' could be null (see line 1616)

Fixes: 0fb2ed66a14c ('IB/mlx5: Add create and destroy functionality for Raw Packet QP')
	Signed-off-by: Majd Dibbiny <majd@mellanox.com>
	Reported-by: Dan Carpenter <dan.carpenter@oracle.com>
	Signed-off-by: Doug Ledford <dledford@redhat.com>
(cherry picked from commit 09f16cf59fbf825130c216c3af189253505dc9d9)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/hw/mlx5/qp.c
diff --cc drivers/infiniband/hw/mlx5/qp.c
index 607cf202ca0b,40bbe962a1ce..000000000000
--- a/drivers/infiniband/hw/mlx5/qp.c
+++ b/drivers/infiniband/hw/mlx5/qp.c
@@@ -1268,6 -1615,16 +1268,19 @@@ struct ib_qp *mlx5_ib_create_qp(struct 
  
  	if (pd) {
  		dev = to_mdev(pd->device);
++<<<<<<< HEAD
++=======
+ 
+ 		if (init_attr->qp_type == IB_QPT_RAW_PACKET) {
+ 			if (!pd->uobject) {
+ 				mlx5_ib_dbg(dev, "Raw Packet QP is not supported for kernel consumers\n");
+ 				return ERR_PTR(-EINVAL);
+ 			} else if (!to_mucontext(pd->uobject->context)->cqe_version) {
+ 				mlx5_ib_dbg(dev, "Raw Packet QP is only supported for CQE version > 0\n");
+ 				return ERR_PTR(-EINVAL);
+ 			}
+ 		}
++>>>>>>> 09f16cf59fbf (IB/mlx5: Fix use of null pointer PD)
  	} else {
  		/* being cautious here */
  		if (init_attr->qp_type != IB_QPT_XRC_TGT &&
* Unmerged path drivers/infiniband/hw/mlx5/qp.c
