net/mlx5e: Don't try to modify CQ moderation if it is not supported

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
Rebuild_CHGLOG: - [netdrv] mlx5e: Don't try to modify CQ moderation if it is not supported (Kamal Heib) [1316951]
Rebuild_FUZZ: 96.92%
commit-author Gal Pressman <galp@mellanox.com>
commit 7524a5d88b94afef8397a79f1e664af5b7052c22
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/7524a5d8.failed

If CQ moderation is not supported by the device, print a warning on
netdevice load, and return error when trying to modify/query cq
moderation via ethtool.

Fixes: f62b8bb8f2d3 ('net/mlx5: Extend mlx5_core to support ConnectX-4
Ethernet functionality')
	Signed-off-by: Gal Pressman <galp@mellanox.com>

	Signed-off-by: Saeed Mahameed <saeedm@mellanox.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 7524a5d88b94afef8397a79f1e664af5b7052c22)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlx5/core/en_main.c
diff --cc drivers/net/ethernet/mellanox/mlx5/core/en_main.c
index 40206da1f9d7,b20a35bd1d4f..000000000000
--- a/drivers/net/ethernet/mellanox/mlx5/core/en_main.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/en_main.c
@@@ -1670,6 -2214,11 +1668,14 @@@ static int mlx5e_check_required_hca_cap
  			       "Not creating net device, some required device capabilities are missing\n");
  		return -ENOTSUPP;
  	}
++<<<<<<< HEAD
++=======
+ 	if (!MLX5_CAP_ETH(mdev, self_lb_en_modifiable))
+ 		mlx5_core_warn(mdev, "Self loop back prevention is not supported\n");
+ 	if (!MLX5_CAP_GEN(mdev, cq_moderation))
+ 		mlx5_core_warn(mdev, "CQ modiration is not supported\n");
+ 
++>>>>>>> 7524a5d88b94 (net/mlx5e: Don't try to modify CQ moderation if it is not supported)
  	return 0;
  }
  
diff --git a/drivers/net/ethernet/mellanox/mlx5/core/en_ethtool.c b/drivers/net/ethernet/mellanox/mlx5/core/en_ethtool.c
index 388938482ff9..1c7293e3af8c 100644
--- a/drivers/net/ethernet/mellanox/mlx5/core/en_ethtool.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/en_ethtool.c
@@ -378,6 +378,9 @@ static int mlx5e_get_coalesce(struct net_device *netdev,
 {
 	struct mlx5e_priv *priv = netdev_priv(netdev);
 
+	if (!MLX5_CAP_GEN(priv->mdev, cq_moderation))
+		return -ENOTSUPP;
+
 	coal->rx_coalesce_usecs       = priv->params.rx_cq_moderation_usec;
 	coal->rx_max_coalesced_frames = priv->params.rx_cq_moderation_pkts;
 	coal->tx_coalesce_usecs       = priv->params.tx_cq_moderation_usec;
@@ -395,6 +398,9 @@ static int mlx5e_set_coalesce(struct net_device *netdev,
 	int tc;
 	int i;
 
+	if (!MLX5_CAP_GEN(mdev, cq_moderation))
+		return -ENOTSUPP;
+
 	priv->params.tx_cq_moderation_usec = coal->tx_coalesce_usecs;
 	priv->params.tx_cq_moderation_pkts = coal->tx_max_coalesced_frames;
 	priv->params.rx_cq_moderation_usec = coal->rx_coalesce_usecs;
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/en_main.c
