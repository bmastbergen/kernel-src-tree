netfilter: bridge: fix routing of bridge frames with call-iptables=1

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Florian Westphal <fw@strlen.de>
commit 63cdbc06b357dcb3a7104a421ee4a4550d7fadfd
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/63cdbc06.failed

We can't re-use the physoutdev storage area.

1.  When using NFQUEUE in PREROUTING, we attempt to bump a bogus
refcnt since nf_bridge->physoutdev is garbage (ipv4/ipv6 address)

2. for same reason, we crash in physdev match in FORWARD or later if
skb is routed instead of bridged.

This increases nf_bridge_info to 40 bytes, but we have no other choice.

Fixes: 72b1e5e4cac7 ("netfilter: bridge: reduce nf_bridge_info to 32 bytes again")
	Reported-by: Sander Eikelenboom <linux@eikelenboom.it>
	Signed-off-by: Florian Westphal <fw@strlen.de>
	Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
(cherry picked from commit 63cdbc06b357dcb3a7104a421ee4a4550d7fadfd)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	include/linux/skbuff.h
diff --cc include/linux/skbuff.h
index 2e271768b46a,9987af080fa0..000000000000
--- a/include/linux/skbuff.h
+++ b/include/linux/skbuff.h
@@@ -163,13 -166,33 +163,30 @@@ struct nf_conntrack 
  };
  #endif
  
 -#if IS_ENABLED(CONFIG_BRIDGE_NETFILTER)
 +#ifdef CONFIG_BRIDGE_NETFILTER
  struct nf_bridge_info {
  	atomic_t		use;
 -	enum {
 -		BRNF_PROTO_UNCHANGED,
 -		BRNF_PROTO_8021Q,
 -		BRNF_PROTO_PPPOE
 -	} orig_proto:8;
 -	u8			pkt_otherhost:1;
 -	u8			in_prerouting:1;
 -	u8			bridged_dnat:1;
 -	__u16			frag_max_size;
 +	unsigned int		mask;
  	struct net_device	*physindev;
++<<<<<<< HEAD
 +	struct net_device	*physoutdev;
 +	unsigned long		data[32 / sizeof(unsigned long)];
++=======
+ 
+ 	/* always valid & non-NULL from FORWARD on, for physdev match */
+ 	struct net_device	*physoutdev;
+ 	union {
+ 		/* prerouting: detect dnat in orig/reply direction */
+ 		__be32          ipv4_daddr;
+ 		struct in6_addr ipv6_daddr;
+ 
+ 		/* after prerouting + nat detected: store original source
+ 		 * mac since neigh resolution overwrites it, only used while
+ 		 * skb is out in neigh layer.
+ 		 */
+ 		char neigh_header[8];
+ 	};
++>>>>>>> 63cdbc06b357 (netfilter: bridge: fix routing of bridge frames with call-iptables=1)
  };
  #endif
  
* Unmerged path include/linux/skbuff.h
