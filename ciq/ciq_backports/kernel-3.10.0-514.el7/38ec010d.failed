iommu: Do more input validation in iommu_map_sg()

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
Rebuild_CHGLOG: - [iommu] Do more input validation in iommu_map_sg() (Myron Stowe) [1287300]
Rebuild_FUZZ: 92.31%
commit-author Joerg Roedel <jroedel@suse.de>
commit 38ec010d9b04ed94845f8ff6f10d33eb6bbfe180
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/38ec010d.failed

The IOMMU-API works on page boundarys, unlike the DMA-API
which can work with sub-page buffers. The sg->offset
field does not make sense on the IOMMU level, so force it to
be 0. Do some error-path consolidation while at it.

	Signed-off-by: Joerg Roedel <jroedel@suse.de>
(cherry picked from commit 38ec010d9b04ed94845f8ff6f10d33eb6bbfe180)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/iommu/iommu.c
diff --cc drivers/iommu/iommu.c
index d46818e4f66f,08c53c5a046f..000000000000
--- a/drivers/iommu/iommu.c
+++ b/drivers/iommu/iommu.c
@@@ -1109,6 -1124,38 +1109,41 @@@ size_t iommu_unmap(struct iommu_domain 
  }
  EXPORT_SYMBOL_GPL(iommu_unmap);
  
++<<<<<<< HEAD
++=======
+ size_t default_iommu_map_sg(struct iommu_domain *domain, unsigned long iova,
+ 			 struct scatterlist *sg, unsigned int nents, int prot)
+ {
+ 	struct scatterlist *s;
+ 	size_t mapped = 0;
+ 	unsigned int i;
+ 	int ret;
+ 
+ 	for_each_sg(sg, s, nents, i) {
+ 		phys_addr_t phys = page_to_phys(sg_page(s));
+ 
+ 		/* We are mapping on page boundarys, so offset must be 0 */
+ 		if (s->offset)
+ 			goto out_err;
+ 
+ 		ret = iommu_map(domain, iova + mapped, phys, s->length, prot);
+ 		if (ret)
+ 			goto out_err;
+ 
+ 		mapped += s->length;
+ 	}
+ 
+ 	return mapped;
+ 
+ out_err:
+ 	/* undo mappings already done */
+ 	iommu_unmap(domain, iova, mapped);
+ 
+ 	return 0;
+ 
+ }
+ EXPORT_SYMBOL_GPL(default_iommu_map_sg);
++>>>>>>> 38ec010d9b04 (iommu: Do more input validation in iommu_map_sg())
  
  int iommu_domain_window_enable(struct iommu_domain *domain, u32 wnd_nr,
  			       phys_addr_t paddr, u64 size, int prot)
* Unmerged path drivers/iommu/iommu.c
