sh_eth: Fix sleeping function called from invalid context

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
Rebuild_CHGLOG: - [kernel] cpuset: fix sleeping function called from invalid context (Mateusz Guzik) [1069467]
Rebuild_FUZZ: 94.74%
commit-author Mitsuhiro Kimura <mitsuhiro.kimura.kc@renesas.com>
commit 7fa2955ff70ce4532f144d26b8a087095f9c9ffc
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/7fa2955f.failed

This resolves the following bug which can be reproduced by building the
kernel with CONFIG_DEBUG_ATOMIC_SLEEP=y and reading network statistics
while the network interface is down.

e.g.:

ifconfig eth0 down
cat /sys/class/net/eth0/statistics/tx_errors

----
[ 1238.161349] BUG: sleeping function called from invalid context at drivers/base/power/runtime.c:952
[ 1238.188279] in_atomic(): 1, irqs_disabled(): 0, pid: 1388, name: cat
[ 1238.207425] CPU: 0 PID: 1388 Comm: cat Not tainted 3.10.31-ltsi-00046-gefa0b46 #1087
[ 1238.230737] Backtrace:
[ 1238.238123] [<c0012e64>] (dump_backtrace+0x0/0x10c) from [<c0013000>] (show_stack+0x18/0x1c)
[ 1238.263499]  r6:000003b8 r5:c06160c0 r4:c0669e00 r3:00404000
[ 1238.280583] [<c0012fe8>] (show_stack+0x0/0x1c) from [<c04515a4>] (dump_stack+0x20/0x28)
[ 1238.304631] [<c0451584>] (dump_stack+0x0/0x28) from [<c004970c>] (__might_sleep+0xf8/0x118)
[ 1238.329734] [<c0049614>] (__might_sleep+0x0/0x118) from [<c02465ac>] (__pm_runtime_resume+0x38/0x90)
[ 1238.357170]  r7:d616f000 r6:c049c458 r5:00000004 r4:d6a17210
[ 1238.374251] [<c0246574>] (__pm_runtime_resume+0x0/0x90) from [<c029b1c4>] (sh_eth_get_stats+0x44/0x280)
[ 1238.402468]  r7:d616f000 r6:c049c458 r5:d5c21000 r4:d5c21000
[ 1238.419552] [<c029b180>] (sh_eth_get_stats+0x0/0x280) from [<c03ae39c>] (dev_get_stats+0x54/0x88)
[ 1238.446204]  r5:d5c21000 r4:d5ed7e08
[ 1238.456980] [<c03ae348>] (dev_get_stats+0x0/0x88) from [<c03c677c>] (netstat_show.isra.15+0x54/0x9c)
[ 1238.484413]  r6:d5c21000 r5:d5c21238 r4:00000028 r3:00000001
[ 1238.501495] [<c03c6728>] (netstat_show.isra.15+0x0/0x9c) from [<c03c69b8>] (show_tx_errors+0x18/0x1c)
[ 1238.529196]  r7:d5f945d8 r6:d5f945c0 r5:c049716c r4:c0650e7c
[ 1238.546279] [<c03c69a0>] (show_tx_errors+0x0/0x1c) from [<c023963c>] (dev_attr_show+0x24/0x50)
[ 1238.572157] [<c0239618>] (dev_attr_show+0x0/0x50) from [<c010c148>] (sysfs_read_file+0xb0/0x140)
[ 1238.598554]  r5:c049716c r4:d5c21240
[ 1238.609326] [<c010c098>] (sysfs_read_file+0x0/0x140) from [<c00b9ee4>] (vfs_read+0xb0/0x13c)
[ 1238.634679] [<c00b9e34>] (vfs_read+0x0/0x13c) from [<c00ba0ac>] (SyS_read+0x44/0x74)
[ 1238.657944]  r8:bef45bf0 r7:00000000 r6:d6ac0600 r5:00000000 r4:00000000
[ 1238.678172] [<c00ba068>] (SyS_read+0x0/0x74) from [<c000eec0>] (ret_fast_syscall+0x0/0x30)
----

	Signed-off-by: Mitsuhiro Kimura <mitsuhiro.kimura.kc@renesas.com>
	Signed-off-by: Yoshihiro Kaneko <ykaneko0929@gmail.com>
	Signed-off-by: Simon Horman <horms+renesas@verge.net.au>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 7fa2955ff70ce4532f144d26b8a087095f9c9ffc)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/renesas/sh_eth.c
diff --cc drivers/net/ethernet/renesas/sh_eth.c
index e29fe8dbd226,b5db6b3f939f..000000000000
--- a/drivers/net/ethernet/renesas/sh_eth.c
+++ b/drivers/net/ethernet/renesas/sh_eth.c
@@@ -2123,35 -2195,8 +2158,38 @@@ static int sh_eth_close(struct net_devi
  	return 0;
  }
  
++<<<<<<< HEAD
 +static struct net_device_stats *sh_eth_get_stats(struct net_device *ndev)
 +{
 +	struct sh_eth_private *mdp = netdev_priv(ndev);
 +
 +	pm_runtime_get_sync(&mdp->pdev->dev);
 +
 +	ndev->stats.tx_dropped += sh_eth_read(ndev, TROCR);
 +	sh_eth_write(ndev, 0, TROCR);	/* (write clear) */
 +	ndev->stats.collisions += sh_eth_read(ndev, CDCR);
 +	sh_eth_write(ndev, 0, CDCR);	/* (write clear) */
 +	ndev->stats.tx_carrier_errors += sh_eth_read(ndev, LCCR);
 +	sh_eth_write(ndev, 0, LCCR);	/* (write clear) */
 +	if (sh_eth_is_gether(mdp)) {
 +		ndev->stats.tx_carrier_errors += sh_eth_read(ndev, CERCR);
 +		sh_eth_write(ndev, 0, CERCR);	/* (write clear) */
 +		ndev->stats.tx_carrier_errors += sh_eth_read(ndev, CEECR);
 +		sh_eth_write(ndev, 0, CEECR);	/* (write clear) */
 +	} else {
 +		ndev->stats.tx_carrier_errors += sh_eth_read(ndev, CNDCR);
 +		sh_eth_write(ndev, 0, CNDCR);	/* (write clear) */
 +	}
 +	pm_runtime_put_sync(&mdp->pdev->dev);
 +
 +	return &ndev->stats;
 +}
 +
++=======
++>>>>>>> 7fa2955ff70c (sh_eth: Fix sleeping function called from invalid context)
  /* ioctl to device function */
 -static int sh_eth_do_ioctl(struct net_device *ndev, struct ifreq *rq, int cmd)
 +static int sh_eth_do_ioctl(struct net_device *ndev, struct ifreq *rq,
 +				int cmd)
  {
  	struct sh_eth_private *mdp = netdev_priv(ndev);
  	struct phy_device *phydev = mdp->phydev;
* Unmerged path drivers/net/ethernet/renesas/sh_eth.c
diff --git a/drivers/net/ethernet/renesas/sh_eth.h b/drivers/net/ethernet/renesas/sh_eth.h
index 62689a5823be..e5b0e1f58cb1 100644
--- a/drivers/net/ethernet/renesas/sh_eth.h
+++ b/drivers/net/ethernet/renesas/sh_eth.h
@@ -513,6 +513,7 @@ struct sh_eth_private {
 
 	unsigned no_ether_link:1;
 	unsigned ether_link_active_low:1;
+	unsigned is_opened:1;
 };
 
 static inline void sh_eth_soft_swap(char *src, int len)
