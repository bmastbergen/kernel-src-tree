rbd: add 'config_info' sysfs rbd device attribute

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Mike Christie <mchristi@redhat.com>
commit 0d6d1e9c2e970c26e8a1ec4932ffffacec90e0b4
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/0d6d1e9c.failed

Export the info used to setup the rbd image, so it can be used to remap
the image.

	Signed-off-by: Mike Christie <mchristi@redhat.com>
[idryomov@gmail.com: do_rbd_add() EH]
	Signed-off-by: Ilya Dryomov <idryomov@gmail.com>
(cherry picked from commit 0d6d1e9c2e970c26e8a1ec4932ffffacec90e0b4)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/block/rbd.c
diff --cc drivers/block/rbd.c
index 0ea1260a957b,8ff2dc872008..000000000000
--- a/drivers/block/rbd.c
+++ b/drivers/block/rbd.c
@@@ -346,8 -370,10 +346,9 @@@ struct rbd_device 
  	unsigned long		flags;		/* possibly lock protected */
  	struct rbd_spec		*spec;
  	struct rbd_options	*opts;
+ 	char			*config_info;	/* add{,_single_major} string */
  
  	struct ceph_object_id	header_oid;
 -	struct ceph_object_locator header_oloc;
  
  	struct ceph_file_layout	layout;		/* used for all rbd requests */
  
@@@ -4157,7 -4830,12 +4168,12 @@@ static void rbd_spec_free(struct kref *
  
  static void rbd_dev_free(struct rbd_device *rbd_dev)
  {
 -	WARN_ON(rbd_dev->watch_state != RBD_WATCH_STATE_UNREGISTERED);
 -	WARN_ON(rbd_dev->lock_state != RBD_LOCK_STATE_UNLOCKED);
 -
  	ceph_oid_destroy(&rbd_dev->header_oid);
++<<<<<<< HEAD
++=======
+ 	ceph_oloc_destroy(&rbd_dev->header_oloc);
+ 	kfree(rbd_dev->config_info);
++>>>>>>> 0d6d1e9c2e97 (rbd: add 'config_info' sysfs rbd device attribute)
  
  	rbd_put_client(rbd_dev->rbd_client);
  	rbd_spec_put(rbd_dev->spec);
diff --git a/Documentation/ABI/testing/sysfs-bus-rbd b/Documentation/ABI/testing/sysfs-bus-rbd
index 7bf8d4fa6f63..6dccbf82fcf4 100644
--- a/Documentation/ABI/testing/sysfs-bus-rbd
+++ b/Documentation/ABI/testing/sysfs-bus-rbd
@@ -57,6 +57,11 @@ cluster_fsid
 
 	The ceph cluster UUID.  (August 2016, since 4.9.)
 
+config_info
+
+	The string written into /sys/bus/rbd/add{,_single_major}.  (August
+	2016, since 4.9.)
+
 features
 
 	A hexadecimal encoding of the feature bits for this image.
* Unmerged path drivers/block/rbd.c
