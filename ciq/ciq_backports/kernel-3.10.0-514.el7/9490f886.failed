af-unix: passcred support for sendpage

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
Rebuild_CHGLOG: - [net] af_unix: passcred support for sendpage (Hannes Frederic Sowa) [1282574]
Rebuild_FUZZ: 97.37%
commit-author Hannes Frederic Sowa <hannes@stressinduktion.org>
commit 9490f886b192964796285907d777ff00fba1fa0f
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/9490f886.failed

sendpage did not care about credentials at all. This could lead to
situations in which because of fd passing between processes we could
append data to skbs with different scm data. It is illegal to splice those
skbs together. Instead we have to allocate a new skb and if requested
fill out the scm details.

Fixes: 869e7c62486ec ("net: af_unix: implement stream sendpage support")
	Reported-by: Al Viro <viro@zeniv.linux.org.uk>
	Cc: Al Viro <viro@zeniv.linux.org.uk>
	Cc: Eric Dumazet <edumazet@google.com>
	Signed-off-by: Hannes Frederic Sowa <hannes@stressinduktion.org>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 9490f886b192964796285907d777ff00fba1fa0f)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/unix/af_unix.c
diff --cc net/unix/af_unix.c
index 2ee5c63dc1ed,6ced74690eee..000000000000
--- a/net/unix/af_unix.c
+++ b/net/unix/af_unix.c
@@@ -1840,8 -2015,8 +1890,13 @@@ alloc_skb
  	unix_state_unlock(other);
  	mutex_unlock(&unix_sk(other)->readlock);
  
++<<<<<<< HEAD
 +	other->sk_data_ready(other, 0);
 +
++=======
+ 	other->sk_data_ready(other);
+ 	scm_destroy(&scm);
++>>>>>>> 9490f886b192 (af-unix: passcred support for sendpage)
  	return size;
  
  err_state_unlock:
@@@ -2169,9 -2332,7 +2226,13 @@@ unlock
  
  		if (check_creds) {
  			/* Never glue messages from different writers */
++<<<<<<< HEAD
 +			if ((UNIXCB(skb).pid  != siocb->scm->pid) ||
 +			    !uid_eq(UNIXCB(skb).uid, siocb->scm->creds.uid) ||
 +			    !gid_eq(UNIXCB(skb).gid, siocb->scm->creds.gid))
++=======
+ 			if (!unix_skb_scm_eq(skb, &scm))
++>>>>>>> 9490f886b192 (af-unix: passcred support for sendpage)
  				break;
  		} else if (test_bit(SOCK_PASSCRED, &sock->flags)) {
  			/* Copy credentials */
* Unmerged path net/unix/af_unix.c
