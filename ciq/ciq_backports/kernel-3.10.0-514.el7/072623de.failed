dm: fix dm_target_io leak if clone_bio() returns an error

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Mikulas Patocka <mpatocka@redhat.com>
commit 072623de1f964c7ff01c46a9101af1c822fd2873
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/072623de.failed

Commit c80914e81ec5b08 ("dm: return error if bio_integrity_clone() fails
in clone_bio()") changed clone_bio() such that if it does return error
then the alloc_tio() created resources (both the bio that was allocated
to be a clone and the containing dm_target_io struct) will leak.

Fix this by calling free_tio() in __clone_and_map_data_bio()'s
clone_bio() error path.

Fixes: c80914e81ec5b08 ("dm: return error if bio_integrity_clone() fails in clone_bio()")
	Signed-off-by: Mikulas Patocka <mpatocka@redhat.com>
	Signed-off-by: Mike Snitzer <snitzer@redhat.com>
(cherry picked from commit 072623de1f964c7ff01c46a9101af1c822fd2873)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/md/dm.c
diff --cc drivers/md/dm.c
index a6b44461a701,3d3ac13287a4..000000000000
--- a/drivers/md/dm.c
+++ b/drivers/md/dm.c
@@@ -1609,13 -1659,17 +1609,23 @@@ static void __clone_and_map_data_bio(st
  		num_target_bios = ti->num_write_bios(ti, bio);
  
  	for (target_bio_nr = 0; target_bio_nr < num_target_bios; target_bio_nr++) {
++<<<<<<< HEAD
 +		tio = alloc_tio(ci, ti, nr_iovecs, target_bio_nr);
 +		if (split_bvec)
 +			clone_split_bio(tio, bio, sector, idx, offset, len);
 +		else
 +			clone_bio(tio, bio, sector, idx, bv_count, len);
++=======
+ 		tio = alloc_tio(ci, ti, target_bio_nr);
+ 		tio->len_ptr = len;
+ 		r = clone_bio(tio, bio, sector, *len);
+ 		if (r < 0) {
+ 			free_tio(ci->md, tio);
+ 			break;
+ 		}
++>>>>>>> 072623de1f96 (dm: fix dm_target_io leak if clone_bio() returns an error)
  		__map_bio(tio);
  	}
 -
 -	return r;
  }
  
  typedef unsigned (*get_num_bios_fn)(struct dm_target *ti);
* Unmerged path drivers/md/dm.c
