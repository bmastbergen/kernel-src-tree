ALSA: hda - Add hduadio support to DEVTABLE

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Subhransu S. Prusty <subhransu.s.prusty@intel.com>
commit da23ac1e40ce844d1a9553906bdacce160af76f6
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/da23ac1e.failed

For generating modalias entries automatically, move the definition of
struct hda_device_id to linux/mod_devicetable.h and add the handling
of this record in file2alias helper.  The new modalias is represented
with combination of vendor id, device id, and api version as
"hdaudio:vNrNaN".

This patch itself doesn't convert the existing modaliases.  Since they
were added manually, this patch won't give any regression by itself at
this point.

[Modified the modalias format to adapt the api_version field, and drop
 invalid ANY_ID definition by tiwai]

	Signed-off-by: Subhransu S. Prusty <subhransu.s.prusty@intel.com>
	Reviewed-by: Vinod Koul <vinod.koul@intel.com>
	Tested-by: Subhransu S Prusty <subhransu.s.prusty@intel.com>
	Signed-off-by: Takashi Iwai <tiwai@suse.de>
(cherry picked from commit da23ac1e40ce844d1a9553906bdacce160af76f6)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	scripts/mod/file2alias.c
diff --cc scripts/mod/file2alias.c
index 45f9a3377dcd,fc51d4bff3f8..000000000000
--- a/scripts/mod/file2alias.c
+++ b/scripts/mod/file2alias.c
@@@ -1145,6 -1217,56 +1145,59 @@@ static int do_mei_entry(const char *fil
  }
  ADD_TO_DEVTABLE("mei", mei_cl_device_id, do_mei_entry);
  
++<<<<<<< HEAD
++=======
+ /* Looks like: rapidio:vNdNavNadN */
+ static int do_rio_entry(const char *filename,
+ 			void *symval, char *alias)
+ {
+ 	DEF_FIELD(symval, rio_device_id, did);
+ 	DEF_FIELD(symval, rio_device_id, vid);
+ 	DEF_FIELD(symval, rio_device_id, asm_did);
+ 	DEF_FIELD(symval, rio_device_id, asm_vid);
+ 
+ 	strcpy(alias, "rapidio:");
+ 	ADD(alias, "v", vid != RIO_ANY_ID, vid);
+ 	ADD(alias, "d", did != RIO_ANY_ID, did);
+ 	ADD(alias, "av", asm_vid != RIO_ANY_ID, asm_vid);
+ 	ADD(alias, "ad", asm_did != RIO_ANY_ID, asm_did);
+ 
+ 	add_wildcard(alias);
+ 	return 1;
+ }
+ ADD_TO_DEVTABLE("rapidio", rio_device_id, do_rio_entry);
+ 
+ /* Looks like: ulpi:vNpN */
+ static int do_ulpi_entry(const char *filename, void *symval,
+ 			 char *alias)
+ {
+ 	DEF_FIELD(symval, ulpi_device_id, vendor);
+ 	DEF_FIELD(symval, ulpi_device_id, product);
+ 
+ 	sprintf(alias, "ulpi:v%04xp%04x", vendor, product);
+ 
+ 	return 1;
+ }
+ ADD_TO_DEVTABLE("ulpi", ulpi_device_id, do_ulpi_entry);
+ 
+ /* Looks like: hdaudio:vNrNaN */
+ static int do_hda_entry(const char *filename, void *symval, char *alias)
+ {
+ 	DEF_FIELD(symval, hda_device_id, vendor_id);
+ 	DEF_FIELD(symval, hda_device_id, rev_id);
+ 	DEF_FIELD(symval, hda_device_id, api_version);
+ 
+ 	strcpy(alias, "hdaudio:");
+ 	ADD(alias, "v", vendor_id != 0, vendor_id);
+ 	ADD(alias, "r", rev_id != 0, rev_id);
+ 	ADD(alias, "a", api_version != 0, api_version);
+ 
+ 	add_wildcard(alias);
+ 	return 1;
+ }
+ ADD_TO_DEVTABLE("hdaudio", hda_device_id, do_hda_entry);
+ 
++>>>>>>> da23ac1e40ce (ALSA: hda - Add hduadio support to DEVTABLE)
  /* Does namelen bytes of name exactly match the symbol? */
  static bool sym_is(const char *name, unsigned namelen, const char *symbol)
  {
diff --git a/include/linux/mod_devicetable.h b/include/linux/mod_devicetable.h
index b3bd7e737e8b..3f03f8db09ee 100644
--- a/include/linux/mod_devicetable.h
+++ b/include/linux/mod_devicetable.h
@@ -217,6 +217,14 @@ struct serio_device_id {
 	__u8 proto;
 };
 
+struct hda_device_id {
+	__u32 vendor_id;
+	__u32 rev_id;
+	__u8 api_version;
+	const char *name;
+	unsigned long driver_data;
+};
+
 /*
  * Struct used for matching a device
  */
diff --git a/include/sound/hdaudio.h b/include/sound/hdaudio.h
index 8dd44c96f7ba..add0865aa85f 100644
--- a/include/sound/hdaudio.h
+++ b/include/sound/hdaudio.h
@@ -21,6 +21,7 @@ struct hdac_stream;
 struct hdac_device;
 struct hdac_driver;
 struct hdac_widget_tree;
+struct hda_device_id;
 
 /*
  * exported bus type
diff --git a/scripts/mod/devicetable-offsets.c b/scripts/mod/devicetable-offsets.c
index e66d4d258e1a..8d77729730af 100644
--- a/scripts/mod/devicetable-offsets.c
+++ b/scripts/mod/devicetable-offsets.c
@@ -177,5 +177,10 @@ int main(void)
 	DEVID(mei_cl_device_id);
 	DEVID_FIELD(mei_cl_device_id, name);
 
+	DEVID(hda_device_id);
+	DEVID_FIELD(hda_device_id, vendor_id);
+	DEVID_FIELD(hda_device_id, rev_id);
+	DEVID_FIELD(hda_device_id, api_version);
+
 	return 0;
 }
* Unmerged path scripts/mod/file2alias.c
diff --git a/sound/hda/hda_bus_type.c b/sound/hda/hda_bus_type.c
index 519914a12e8a..1dc12f47704a 100644
--- a/sound/hda/hda_bus_type.c
+++ b/sound/hda/hda_bus_type.c
@@ -4,6 +4,7 @@
 #include <linux/init.h>
 #include <linux/device.h>
 #include <linux/module.h>
+#include <linux/mod_devicetable.h>
 #include <linux/export.h>
 #include <sound/hdaudio.h>
 
