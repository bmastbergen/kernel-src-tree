dm thin: remove __bio_inc_remaining() and switch to using bio_inc_remaining()

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Mike Snitzer <snitzer@redhat.com>
commit 13e4f8a695aa1dc7c94525047fc2ffb9abc8125e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/13e4f8a6.failed

DM thinp's use of bio_inc_remaining() is critical to ensure the original
parent discard bio isn't completed before sub-discards have.  DM thinp
needs this due to the extra quiescing that occurs, via multiple DM thinp
mappings, while processing large discards.  As such DM thinp must build
the async discard bio chain after some delay -- so bio_inc_remaining()
is used to enable DM thinp to take a reference on the original parent
discard bio for each mapping.  This allows the immediate use of
bio_endio() on that discard bio; but with the understanding that the
actual completion won't occur until each of the sub-discards'
per-mapping references are dropped.

	Signed-off-by: Mike Snitzer <snitzer@redhat.com>
	Acked-by: Joe Thornber <ejt@redhat.com>
(cherry picked from commit 13e4f8a695aa1dc7c94525047fc2ffb9abc8125e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/md/dm-thin.c
diff --cc drivers/md/dm-thin.c
index 6c9ed579302c,da42c4916ce6..000000000000
--- a/drivers/md/dm-thin.c
+++ b/drivers/md/dm-thin.c
@@@ -1546,18 -1494,6 +1546,21 @@@ static void process_discard_cell_no_pas
  		pool->process_prepared_discard(m);
  }
  
++<<<<<<< HEAD
 +/*
 + * FIXME: DM local hack to defer parent bios's end_io until we
 + * _know_ all chained sub range discard bios have completed.
 + * Will go away once late bio splitting lands upstream!
 + */
 +static inline void __bio_inc_remaining(struct bio *bio)
 +{
 +	bio->bio_aux->bi_flags |= (1 << BIO_AUX_CHAIN);
 +	smp_mb__before_atomic();
 +	atomic_inc(&bio->bio_aux->__bi_remaining);
 +}
 +
++=======
++>>>>>>> 13e4f8a695aa (dm thin: remove __bio_inc_remaining() and switch to using bio_inc_remaining())
  static void break_up_discard_bio(struct thin_c *tc, dm_block_t begin, dm_block_t end,
  				 struct bio *bio)
  {
* Unmerged path drivers/md/dm-thin.c
