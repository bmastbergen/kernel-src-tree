cifs: Ratelimit kernel log messages

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Jamie Bainbridge <jamie.bainbridge@gmail.com>
commit ec7147a99e33a9e4abad6fc6e1b40d15df045d53
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/ec7147a9.failed

Under some conditions, CIFS can repeatedly call the cifs_dbg() logging
wrapper. If done rapidly enough, the console framebuffer can softlockup
or "rcu_sched self-detected stall". Apply the built-in log ratelimiters
to prevent such hangs.

	Signed-off-by: Jamie Bainbridge <jamie.bainbridge@gmail.com>
	Signed-off-by: Steve French <smfrench@gmail.com>
CC: Stable <stable@vger.kernel.org>
(cherry picked from commit ec7147a99e33a9e4abad6fc6e1b40d15df045d53)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/cifs/cifs_debug.c
#	fs/cifs/cifs_debug.h
diff --cc fs/cifs/cifs_debug.c
index 44ec72684df5,50b268483302..000000000000
--- a/fs/cifs/cifs_debug.c
+++ b/fs/cifs/cifs_debug.c
@@@ -68,7 -50,7 +68,11 @@@ void cifs_vfs_err(const char *fmt, ...
  	vaf.fmt = fmt;
  	vaf.va = &args;
  
++<<<<<<< HEAD
 +	printk(KERN_ERR "CIFS VFS: %pV", &vaf);
++=======
+ 	pr_err_ratelimited("CIFS VFS: %pV", &vaf);
++>>>>>>> ec7147a99e33 (cifs: Ratelimit kernel log messages)
  
  	va_end(args);
  }
diff --cc fs/cifs/cifs_debug.h
index c99b40fb609b,66cf0f9fff89..000000000000
--- a/fs/cifs/cifs_debug.h
+++ b/fs/cifs/cifs_debug.h
@@@ -51,15 -51,13 +51,25 @@@ __printf(1, 2) void cifs_vfs_err(const 
  /* information message: e.g., configuration, major event */
  #define cifs_dbg(type, fmt, ...)					\
  do {									\
++<<<<<<< HEAD
 +	if (type == FYI) {						\
 +		if (cifsFYI & CIFS_INFO) {				\
 +			printk(KERN_DEBUG "%s: " fmt,			\
 +			       __FILE__, ##__VA_ARGS__);		\
 +		}							\
 +	} else if (type == VFS) {					\
 +		cifs_vfs_err(fmt, ##__VA_ARGS__);			\
 +	} else if (type == NOISY && type != 0) {			\
 +		printk(KERN_DEBUG fmt, ##__VA_ARGS__);			\
++=======
+ 	if (type == FYI && cifsFYI & CIFS_INFO) {			\
+ 		pr_debug_ratelimited("%s: "				\
+ 			    fmt, __FILE__, ##__VA_ARGS__);		\
+ 	} else if (type == VFS) {					\
+ 		cifs_vfs_err(fmt, ##__VA_ARGS__);			\
+ 	} else if (type == NOISY && type != 0) {			\
+ 		pr_debug_ratelimited(fmt, ##__VA_ARGS__);		\
++>>>>>>> ec7147a99e33 (cifs: Ratelimit kernel log messages)
  	}								\
  } while (0)
  
* Unmerged path fs/cifs/cifs_debug.c
* Unmerged path fs/cifs/cifs_debug.h
