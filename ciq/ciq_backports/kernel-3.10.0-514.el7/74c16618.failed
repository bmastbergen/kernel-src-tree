openvswitch: Fix double-free on ip_defrag() errors

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Joe Stringer <joestringer@nicira.com>
commit 74c16618137f1505b0a32dea3ec73a2ef6f8f842
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/74c16618.failed

If ip_defrag() returns an error other than -EINPROGRESS, then the skb is
freed. When handle_fragments() passes this back up to
do_execute_actions(), it will be freed again. Prevent this double free
by never freeing the skb in do_execute_actions() for errors returned by
ovs_ct_execute. Always free it in ovs_ct_execute() error paths instead.

Fixes: 7f8a436eaa2c ("openvswitch: Add conntrack action")
	Reported-by: Florian Westphal <fw@strlen.de>
	Signed-off-by: Joe Stringer <joestringer@nicira.com>
	Acked-by: Pravin B Shelar <pshelar@nicira.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 74c16618137f1505b0a32dea3ec73a2ef6f8f842)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/openvswitch/actions.c
#	net/openvswitch/conntrack.c
#	net/openvswitch/conntrack.h
diff --cc net/openvswitch/actions.c
index 1970b0908585,dba635d086b2..000000000000
--- a/net/openvswitch/actions.c
+++ b/net/openvswitch/actions.c
@@@ -932,6 -1097,21 +932,24 @@@ static int do_execute_actions(struct da
  		case OVS_ACTION_ATTR_SAMPLE:
  			err = sample(dp, skb, key, a, attr, len);
  			break;
++<<<<<<< HEAD
++=======
+ 
+ 		case OVS_ACTION_ATTR_CT:
+ 			if (!is_flow_key_valid(key)) {
+ 				err = ovs_flow_key_update(skb, key);
+ 				if (err)
+ 					return err;
+ 			}
+ 
+ 			err = ovs_ct_execute(ovs_dp_get_net(dp), skb, key,
+ 					     nla_data(a));
+ 
+ 			/* Hide stolen IP fragments from user space. */
+ 			if (err)
+ 				return err == -EINPROGRESS ? 0 : err;
+ 			break;
++>>>>>>> 74c16618137f (openvswitch: Fix double-free on ip_defrag() errors)
  		}
  
  		if (unlikely(err)) {
* Unmerged path net/openvswitch/conntrack.c
* Unmerged path net/openvswitch/conntrack.h
* Unmerged path net/openvswitch/actions.c
* Unmerged path net/openvswitch/conntrack.c
* Unmerged path net/openvswitch/conntrack.h
