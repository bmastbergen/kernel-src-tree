mei: support polling for event notification

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Tomas Winkler <tomas.winkler@intel.com>
commit 2c84c2970c1acf83827aa97ab0e6addc3d2aa960
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/2c84c297.failed

Polling on priority events is translated on waiting for event
notification. One need to enable notification prior for
calling select or poll system call otherwise process
will not wait.

	Signed-off-by: Tomas Winkler <tomas.winkler@intel.com>
	Signed-off-by: Alexander Usyskin <alexander.usyskin@intel.com>
	Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
(cherry picked from commit 2c84c2970c1acf83827aa97ab0e6addc3d2aa960)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/misc/mei/main.c
diff --cc drivers/misc/mei/main.c
index b23f9eba9e3a,17b356f26686..000000000000
--- a/drivers/misc/mei/main.c
+++ b/drivers/misc/mei/main.c
@@@ -639,7 -617,10 +640,14 @@@ static unsigned int mei_poll(struct fil
  
  	mutex_lock(&dev->device_lock);
  
++<<<<<<< HEAD
 +	if (!mei_cl_is_connected(cl)) {
++=======
+ 	notify_en = cl->notify_en && (req_events & POLLPRI);
+ 
+ 	if (dev->dev_state != MEI_DEV_ENABLED ||
+ 	    !mei_cl_is_connected(cl)) {
++>>>>>>> 2c84c2970c1a (mei: support polling for event notification)
  		mask = POLLERR;
  		goto out;
  	}
@@@ -659,7 -630,20 +667,24 @@@
  		goto out;
  	}
  
++<<<<<<< HEAD
 +	mask |= (POLLIN | POLLRDNORM);
++=======
+ 	if (notify_en) {
+ 		poll_wait(file, &cl->ev_wait, wait);
+ 		if (cl->notify_ev)
+ 			mask |= POLLPRI;
+ 	}
+ 
+ 	if (req_events & (POLLIN | POLLRDNORM)) {
+ 		poll_wait(file, &cl->rx_wait, wait);
+ 
+ 		if (!list_empty(&cl->rd_completed))
+ 			mask |= POLLIN | POLLRDNORM;
+ 		else
+ 			mei_cl_read_start(cl, 0, file);
+ 	}
++>>>>>>> 2c84c2970c1a (mei: support polling for event notification)
  
  out:
  	mutex_unlock(&dev->device_lock);
* Unmerged path drivers/misc/mei/main.c
