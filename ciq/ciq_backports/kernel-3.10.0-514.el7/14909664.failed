sit: Setup and TX path for sit/UDP foo-over-udp encapsulation

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Tom Herbert <therbert@google.com>
commit 14909664e4e192f4c6f6fcdccd9919af7cf783ab
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/14909664.failed

Added netlink handling of IP tunnel encapulation paramters, properly
adjust MTU for encapsulation. Added ip_tunnel_encap call to
ipip6_tunnel_xmit to actually perform FOU encapsulation.

	Signed-off-by: Tom Herbert <therbert@google.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 14909664e4e192f4c6f6fcdccd9919af7cf783ab)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/ipv6/sit.c
diff --cc net/ipv6/sit.c
index 7987bacb263b,db75809ab843..000000000000
--- a/net/ipv6/sit.c
+++ b/net/ipv6/sit.c
@@@ -880,16 -977,13 +888,20 @@@ static netdev_tx_t ipip6_tunnel_xmit(st
  		ttl = iph6->hop_limit;
  	tos = INET_ECN_encapsulate(tos, ipv6_get_dsfield(iph6));
  
- 	skb = iptunnel_handle_offloads(skb, false, SKB_GSO_SIT);
- 	if (IS_ERR(skb)) {
+ 	if (ip_tunnel_encap(skb, tunnel, &protocol, &fl4) < 0) {
  		ip_rt_put(rt);
- 		goto out;
+ 		goto tx_error;
  	}
  
++<<<<<<< HEAD
 +	skb_set_inner_ipproto(skb, IPPROTO_IPV6);
 +
 +	err = iptunnel_xmit(NULL, rt, skb, fl4.saddr, fl4.daddr,
 +			    IPPROTO_IPV6, tos, ttl, df,
++=======
+ 	err = iptunnel_xmit(skb->sk, rt, skb, fl4.saddr, fl4.daddr,
+ 			    protocol, tos, ttl, df,
++>>>>>>> 14909664e4e1 (sit: Setup and TX path for sit/UDP foo-over-udp encapsulation)
  			    !net_eq(tunnel->net, dev_net(dev)));
  	iptunnel_xmit_stats(err, &dev->stats, dev->tstats);
  	return NETDEV_TX_OK;
@@@ -1262,14 -1350,18 +1279,22 @@@ static void ipip6_dev_free(struct net_d
  
  static void ipip6_tunnel_setup(struct net_device *dev)
  {
+ 	struct ip_tunnel *tunnel = netdev_priv(dev);
+ 	int t_hlen = tunnel->hlen + sizeof(struct iphdr);
+ 
  	dev->netdev_ops		= &ipip6_netdev_ops;
 -	dev->destructor		= ipip6_dev_free;
 +	dev->destructor 	= ipip6_dev_free;
  
  	dev->type		= ARPHRD_SIT;
++<<<<<<< HEAD
 +	dev->hard_header_len 	= LL_MAX_HEADER + sizeof(struct iphdr);
 +	dev->mtu		= ETH_DATA_LEN - sizeof(struct iphdr);
++=======
+ 	dev->hard_header_len	= LL_MAX_HEADER + t_hlen;
+ 	dev->mtu		= ETH_DATA_LEN - t_hlen;
++>>>>>>> 14909664e4e1 (sit: Setup and TX path for sit/UDP foo-over-udp encapsulation)
  	dev->flags		= IFF_NOARP;
 -	dev->priv_flags	       &= ~IFF_XMIT_DST_RELEASE;
 -	dev->iflink		= 0;
 +	netif_keep_dst(dev);
  	dev->addr_len		= 4;
  	dev->features		|= NETIF_F_LLTX;
  	dev->features		|= SIT_FEATURES;
* Unmerged path net/ipv6/sit.c
