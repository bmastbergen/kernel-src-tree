IB/hfi1: Fix TID caching actions

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Dean Luick <dean.luick@intel.com>
commit 622c202c4a4697636334761d7ca295ebd35074e4
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/622c202c.failed

Per file descriptor TID caching actions depend on a global that can
change midway through the lifetime of that file descriptor.

Make the use of caching consistent for the life of the file descriptor
by using the presence of the cache handler to decide when to use the cache
functions.

	Reviewed-by: Ira Weiny <ira.weiny@intel.com>
	Signed-off-by: Dean Luick <dean.luick@intel.com>
	Signed-off-by: Doug Ledford <dledford@redhat.com>
(cherry picked from commit 622c202c4a4697636334761d7ca295ebd35074e4)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/hw/hfi1/user_exp_rcv.c
#	drivers/staging/hfi1/file_ops.c
diff --cc drivers/staging/hfi1/file_ops.c
index 834243df87b3,4f39bffad74a..000000000000
--- a/drivers/staging/hfi1/file_ops.c
+++ b/drivers/staging/hfi1/file_ops.c
@@@ -1146,9 -1128,14 +1146,20 @@@ static int get_ctxt_info(struct file *f
  	int ret = 0;
  
  	memset(&cinfo, 0, sizeof(cinfo));
++<<<<<<< HEAD:drivers/staging/hfi1/file_ops.c
 +	ret = hfi1_get_base_kinfo(uctxt, &cinfo);
 +	if (ret < 0)
 +		goto done;
++=======
+ 	cinfo.runtime_flags = (((uctxt->flags >> HFI1_CAP_MISC_SHIFT) &
+ 				HFI1_CAP_MISC_MASK) << HFI1_CAP_USER_SHIFT) |
+ 			HFI1_CAP_UGET_MASK(uctxt->flags, MASK) |
+ 			HFI1_CAP_KGET_MASK(uctxt->flags, K2U);
+ 	/* adjust flag if this fd is not able to cache */
+ 	if (!fd->handler)
+ 		cinfo.runtime_flags |= HFI1_CAP_TID_UNMAP; /* no caching */
+ 
++>>>>>>> 622c202c4a46 (IB/hfi1: Fix TID caching actions):drivers/infiniband/hw/hfi1/file_ops.c
  	cinfo.num_active = hfi1_count_active_units();
  	cinfo.unit = uctxt->dd->unit;
  	cinfo.ctxt = uctxt->ctxt;
* Unmerged path drivers/infiniband/hw/hfi1/user_exp_rcv.c
* Unmerged path drivers/infiniband/hw/hfi1/user_exp_rcv.c
* Unmerged path drivers/staging/hfi1/file_ops.c
