ipv6: Fix IPsec pre-encap fragmentation check

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Herbert Xu <herbert@gondor.apana.org.au>
commit 93efac3f2e03321129de67a3c0ba53048bb53e31
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/93efac3f.failed

The IPv6 IPsec pre-encap path performs fragmentation for tunnel-mode
packets.  That is, we perform fragmentation pre-encap rather than
post-encap.

A check was added later to ensure that proper MTU information is
passed back for locally generated traffic.  Unfortunately this
check was performed on all IPsec packets, including transport-mode
packets.

What's more, the check failed to take GSO into account.

The end result is that transport-mode GSO packets get dropped at
the check.

This patch fixes it by moving the tunnel mode check forward as well
as adding the GSO check.

Fixes: dd767856a36e ("xfrm6: Don't call icmpv6_send on local error")
	Signed-off-by: Herbert Xu <herbert@gondor.apana.org.au>
	Signed-off-by: Steffen Klassert <steffen.klassert@secunet.com>
(cherry picked from commit 93efac3f2e03321129de67a3c0ba53048bb53e31)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/ipv6/xfrm6_output.c
diff --cc net/ipv6/xfrm6_output.c
index 743a92816c6b,be033f22a3f3..000000000000
--- a/net/ipv6/xfrm6_output.c
+++ b/net/ipv6/xfrm6_output.c
@@@ -146,11 -153,13 +150,18 @@@ static int __xfrm6_output(struct sock *
  	else
  		mtu = dst_mtu(skb_dst(skb));
  
- 	if (skb->len > mtu && xfrm6_local_dontfrag(skb)) {
+ 	toobig = skb->len > mtu && !skb_is_gso(skb);
+ 
+ 	if (toobig && xfrm6_local_dontfrag(skb)) {
  		xfrm6_local_rxpmtu(skb, mtu);
  		return -EMSGSIZE;
++<<<<<<< HEAD
 +	} else if (!skb->ignore_df && skb->len > mtu && skb->sk) {
 +		xfrm6_local_error(skb, mtu);
++=======
+ 	} else if (!skb->ignore_df && toobig && skb->sk) {
+ 		xfrm_local_error(skb, mtu);
++>>>>>>> 93efac3f2e03 (ipv6: Fix IPsec pre-encap fragmentation check)
  		return -EMSGSIZE;
  	}
  
* Unmerged path net/ipv6/xfrm6_output.c
