iommu/amd: Get rid of device_dma_ops_init()

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
Rebuild_CHGLOG: - [iommu] amd: Get rid of device_dma_ops_init() (Myron Stowe) [1050021]
Rebuild_FUZZ: 92.50%
commit-author Joerg Roedel <jroedel@suse.de>
commit 343e9cac9c4a2715e8fa6b89b04e31e9fcbae5e3
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/343e9cac.failed

With device intialization done in the add_device call-back
now there is no reason for this function anymore.

	Signed-off-by: Joerg Roedel <jroedel@suse.de>
(cherry picked from commit 343e9cac9c4a2715e8fa6b89b04e31e9fcbae5e3)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/iommu/amd_iommu.c
diff --cc drivers/iommu/amd_iommu.c
index 5607b3ae03af,fadda2c0cd18..000000000000
--- a/drivers/iommu/amd_iommu.c
+++ b/drivers/iommu/amd_iommu.c
@@@ -2370,44 -2251,50 +2370,54 @@@ static void detach_device(struct devic
  	dev_data->ats.enabled = false;
  }
  
 -static int amd_iommu_add_device(struct device *dev)
 +/*
 + * Find out the protection domain structure for a given PCI device. This
 + * will give us the pointer to the page table root for example.
 + */
 +static struct protection_domain *domain_for_device(struct device *dev)
  {
  	struct iommu_dev_data *dev_data;
 -	struct iommu_domain *domain;
 -	struct amd_iommu *iommu;
 -	u16 devid;
 -	int ret;
 +	struct protection_domain *dom = NULL;
 +	unsigned long flags;
  
 -	if (!check_device(dev) || get_dev_data(dev))
 -		return 0;
 +	dev_data   = get_dev_data(dev);
  
 -	devid = get_device_id(dev);
 -	iommu = amd_iommu_rlookup_table[devid];
 +	if (dev_data->domain)
 +		return dev_data->domain;
  
++<<<<<<< HEAD
 +	if (dev_data->alias_data != NULL) {
 +		struct iommu_dev_data *alias_data = dev_data->alias_data;
++=======
+ 	ret = iommu_init_device(dev);
+ 	if (ret == -ENOTSUPP) {
+ 		iommu_ignore_device(dev);
+ 		dev->archdata.dma_ops = &nommu_dma_ops;
+ 		goto out;
+ 	}
+ 	init_iommu_group(dev);
++>>>>>>> 343e9cac9c4a (iommu/amd: Get rid of device_dma_ops_init())
  
 -	dev_data = get_dev_data(dev);
 -	if (dev_data && dev_data->iommu_v2)
 -		iommu_request_dm_for_dev(dev);
 -
 -	/* Domains are initialized for this device - have a look what we ended up with */
 -	domain = iommu_get_domain_for_dev(dev);
 -	if (domain->type == IOMMU_DOMAIN_IDENTITY) {
 -		dev_data->passthrough = true;
 -		dev->archdata.dma_ops = &nommu_dma_ops;
 -	} else {
 -		dev->archdata.dma_ops = &amd_iommu_dma_ops;
 +		read_lock_irqsave(&amd_iommu_devtable_lock, flags);
 +		if (alias_data->domain != NULL) {
 +			__attach_device(dev_data, alias_data->domain);
 +			dom = alias_data->domain;
 +		}
 +		read_unlock_irqrestore(&amd_iommu_devtable_lock, flags);
  	}
  
 -out:
 -	iommu_completion_wait(iommu);
 -
 -	return 0;
 +	return dom;
  }
  
 -static void amd_iommu_remove_device(struct device *dev)
 +static int device_change_notifier(struct notifier_block *nb,
 +				  unsigned long action, void *data)
  {
 +	struct dma_ops_domain *dma_domain;
 +	struct protection_domain *domain;
 +	struct iommu_dev_data *dev_data;
 +	struct device *dev = data;
  	struct amd_iommu *iommu;
 +	unsigned long flags;
  	u16 devid;
  
  	if (!check_device(dev))
@@@ -3111,29 -2848,6 +3091,32 @@@ void __init amd_iommu_init_api(void
  
  int __init amd_iommu_init_dma_ops(void)
  {
++<<<<<<< HEAD
 +	struct amd_iommu *iommu;
 +	int ret, unhandled;
 +
 +	/*
 +	 * first allocate a default protection domain for every IOMMU we
 +	 * found in the system. Devices not assigned to any other
 +	 * protection domain will be assigned to the default one.
 +	 */
 +	for_each_iommu(iommu) {
 +		iommu->default_dom = dma_ops_domain_alloc();
 +		if (iommu->default_dom == NULL)
 +			return -ENOMEM;
 +		iommu->default_dom->domain.flags |= PD_DEFAULT_MASK;
 +		ret = iommu_init_unity_mappings(iommu);
 +		if (ret)
 +			goto free_domains;
 +	}
 +
 +	/*
 +	 * Pre-allocate the protection domains for each device.
 +	 */
 +	prealloc_protection_domains();
 +
++=======
++>>>>>>> 343e9cac9c4a (iommu/amd: Get rid of device_dma_ops_init())
  	iommu_detected = 1;
  	swiotlb = 0;
  
* Unmerged path drivers/iommu/amd_iommu.c
