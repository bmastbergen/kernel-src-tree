hpsa: allow driver requested rescans

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Don Brace <don.brace@pmcs.com>
commit 853633e85996cb661e7aed5b3ae8823b12f265cf
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/853633e8.failed

	Reviewed-by: Scott Teel <scott.teel@pmcs.com>
	Reviewed-by: Justin Lindley <justin.lindley@pmcs.com>
	Reviewed-by: Kevin Barnett <kevin.barnett@pmcs.com>
	Reviewed-by: Tomas Henzl <thenzl@redhat.com>
	Reviewed-by; Hannes Reinecke <hare@suse.de>
	Signed-off-by: Don Brace <don.brace@pmcs.com>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit 853633e85996cb661e7aed5b3ae8823b12f265cf)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/hpsa.c
diff --cc drivers/scsi/hpsa.c
index 3c91d6ef5eb9,f010b8ec1a20..000000000000
--- a/drivers/scsi/hpsa.c
+++ b/drivers/scsi/hpsa.c
@@@ -3697,20 -3752,13 +3698,26 @@@ static void hpsa_update_scsi_devices(st
  	}
  	memset(lunzerobits, 0, sizeof(lunzerobits));
  
++<<<<<<< HEAD
 +	rescan_hba_mode = hpsa_hba_mode_enabled(h);
 +	if (rescan_hba_mode < 0)
 +		goto out;
 +
 +	if (!h->hba_mode_enabled && rescan_hba_mode)
 +		dev_warn(&h->pdev->dev, "HBA mode enabled\n");
 +	else if (h->hba_mode_enabled && !rescan_hba_mode)
 +		dev_warn(&h->pdev->dev, "HBA mode disabled\n");
 +
 +	h->hba_mode_enabled = rescan_hba_mode;
++=======
+ 	h->drv_req_rescan = 0; /* cancel scheduled rescan - we're doing it. */
++>>>>>>> 853633e85996 (hpsa: allow driver requested rescans)
  
  	if (hpsa_gather_lun_info(h, physdev_list, &nphysicals,
- 			logdev_list, &nlogicals))
+ 			logdev_list, &nlogicals)) {
+ 		h->drv_req_rescan = 1;
  		goto out;
+ 	}
  
  	/* We might see up to the maximum number of logical and physical disks
  	 * plus external target devices, and a device for the local RAID
* Unmerged path drivers/scsi/hpsa.c
diff --git a/drivers/scsi/hpsa.h b/drivers/scsi/hpsa.h
index f0fd2e029959..d1ae99bd071b 100644
--- a/drivers/scsi/hpsa.h
+++ b/drivers/scsi/hpsa.h
@@ -259,6 +259,7 @@ struct ctlr_info {
 	spinlock_t offline_device_lock;
 	struct list_head offline_device_list;
 	int	acciopath_status;
+	int	drv_req_rescan;
 	int	raid_offload_debug;
 	int	needs_abort_tags_swizzled;
 	struct workqueue_struct *resubmit_wq;
