IB/hfi1: Fix potential panic with sdma drained mechanism

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Mike Marciniszyn <mike.marciniszyn@intel.com>
commit b96b040445f5d84fb8aa2ff986be71f5069c976e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/b96b0404.failed

The guard is backwards, potentially causing the SDMA client
to panic if a wait structure was not specified.

psm and verbs are not exposed to the issue, but fix the
code just to be correct.

Fixes: a545f5308b6c ("staging/rdma/hfi: fix CQ completion order issue")
	Reviewed-by: Dennis Dalessandro <dennis.dalessandro@intel.com>
	Signed-off-by: Mike Marciniszyn <mike.marciniszyn@intel.com>
	Signed-off-by: Doug Ledford <dledford@redhat.com>
(cherry picked from commit b96b040445f5d84fb8aa2ff986be71f5069c976e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/staging/hfi1/sdma.c
diff --cc drivers/staging/hfi1/sdma.c
index 8a57bc183ce2,e938017f78e3..000000000000
--- a/drivers/staging/hfi1/sdma.c
+++ b/drivers/staging/hfi1/sdma.c
@@@ -361,6 -358,28 +361,31 @@@ static inline void sdma_set_desc_cnt(st
  	write_sde_csr(sde, SD(DESC_CNT), reg);
  }
  
++<<<<<<< HEAD:drivers/staging/hfi1/sdma.c
++=======
+ static inline void complete_tx(struct sdma_engine *sde,
+ 			       struct sdma_txreq *tx,
+ 			       int res)
+ {
+ 	/* protect against complete modifying */
+ 	struct iowait *wait = tx->wait;
+ 	callback_t complete = tx->complete;
+ 
+ #ifdef CONFIG_HFI1_DEBUG_SDMA_ORDER
+ 	trace_hfi1_sdma_out_sn(sde, tx->sn);
+ 	if (WARN_ON_ONCE(sde->head_sn != tx->sn))
+ 		dd_dev_err(sde->dd, "expected %llu got %llu\n",
+ 			   sde->head_sn, tx->sn);
+ 	sde->head_sn++;
+ #endif
+ 	sdma_txclean(sde->dd, tx);
+ 	if (complete)
+ 		(*complete)(tx, res);
+ 	if (wait && iowait_sdma_dec(wait))
+ 		iowait_drain_wakeup(wait);
+ }
+ 
++>>>>>>> b96b040445f5 (IB/hfi1: Fix potential panic with sdma drained mechanism):drivers/staging/rdma/hfi1/sdma.c
  /*
   * Complete all the sdma requests with a SDMA_TXREQ_S_ABORTED status
   *
* Unmerged path drivers/staging/hfi1/sdma.c
