mmc: sdhci: disable the clock in sdhci_pltfm_unregister()

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
Rebuild_CHGLOG: - [mmc] sdhci: disable the clock in sdhci_pltfm_unregister() (Don Zickus) [1127975 1277866 1280133 1286932 1297039]
Rebuild_FUZZ: 95.41%
commit-author Kevin Hao <haokexin@gmail.com>
commit 83eacdfa2529b4ee97fe16a3a3a41d1b03465e13
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/83eacdfa.failed

So we can avoid to sprinkle the clk_disable_unprepare() in many
drivers.

	Signed-off-by: Kevin Hao <haokexin@gmail.com>
	Signed-off-by: Ulf Hansson <ulf.hansson@linaro.org>
(cherry picked from commit 83eacdfa2529b4ee97fe16a3a3a41d1b03465e13)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/mmc/host/sdhci-bcm-kona.c
#	drivers/mmc/host/sdhci-dove.c
#	drivers/mmc/host/sdhci-of-arasan.c
#	drivers/mmc/host/sdhci-sirf.c
#	drivers/mmc/host/sdhci-tegra.c
diff --cc drivers/mmc/host/sdhci-bcm-kona.c
index 87175f9817c2,91cba26f75af..000000000000
--- a/drivers/mmc/host/sdhci-bcm-kona.c
+++ b/drivers/mmc/host/sdhci-bcm-kona.c
@@@ -314,21 -323,9 +314,25 @@@ err_pltfm_free
  	return ret;
  }
  
 -static int sdhci_bcm_kona_remove(struct platform_device *pdev)
 +static int __exit sdhci_bcm_kona_remove(struct platform_device *pdev)
  {
++<<<<<<< HEAD
 +	struct sdhci_host *host = platform_get_drvdata(pdev);
 +	int dead;
 +	u32 scratch;
 +
 +	dead = 0;
 +	scratch = readl(host->ioaddr + SDHCI_INT_STATUS);
 +	if (scratch == (u32)-1)
 +		dead = 1;
 +	sdhci_remove_host(host, dead);
 +
 +	sdhci_free_host(host);
 +
 +	return 0;
++=======
+ 	return sdhci_pltfm_unregister(pdev);
++>>>>>>> 83eacdfa2529 (mmc: sdhci: disable the clock in sdhci_pltfm_unregister())
  }
  
  static struct platform_driver sdhci_bcm_kona_driver = {
diff --cc drivers/mmc/host/sdhci-dove.c
index 8424839660f8,2314ff88d942..000000000000
--- a/drivers/mmc/host/sdhci-dove.c
+++ b/drivers/mmc/host/sdhci-dove.c
@@@ -180,21 -110,7 +180,25 @@@ err_sdhci_pltfm_init
  
  static int sdhci_dove_remove(struct platform_device *pdev)
  {
++<<<<<<< HEAD
 +	struct sdhci_host *host = platform_get_drvdata(pdev);
 +	struct sdhci_pltfm_host *pltfm_host = sdhci_priv(host);
 +	struct sdhci_dove_priv *priv = pltfm_host->priv;
 +
 +	sdhci_pltfm_unregister(pdev);
 +
 +	if (gpio_is_valid(priv->gpio_cd)) {
 +		free_irq(gpio_to_irq(priv->gpio_cd), host);
 +		gpio_free(priv->gpio_cd);
 +	}
 +
 +	if (!IS_ERR(priv->clk))
 +		clk_disable_unprepare(priv->clk);
 +
 +	return 0;
++=======
+ 	return sdhci_pltfm_unregister(pdev);
++>>>>>>> 83eacdfa2529 (mmc: sdhci: disable the clock in sdhci_pltfm_unregister())
  }
  
  static const struct of_device_id sdhci_dove_of_match_table[] = {
diff --cc drivers/mmc/host/sdhci-sirf.c
index 09805af0526d,f3c8d8d9fc62..000000000000
--- a/drivers/mmc/host/sdhci-sirf.c
+++ b/drivers/mmc/host/sdhci-sirf.c
@@@ -119,16 -196,8 +119,21 @@@ err_sdhci_pltfm_init
  static int sdhci_sirf_remove(struct platform_device *pdev)
  {
  	struct sdhci_host *host = platform_get_drvdata(pdev);
++<<<<<<< HEAD
 +	struct sdhci_pltfm_host *pltfm_host = sdhci_priv(host);
 +	struct sdhci_sirf_priv *priv = pltfm_host->priv;
 +
 +	sdhci_pltfm_unregister(pdev);
 +
 +	if (gpio_is_valid(priv->gpio_cd))
 +		mmc_gpio_free_cd(host->mmc);
 +
 +	clk_disable_unprepare(priv->clk);
 +	return 0;
++=======
+ 
+ 	return sdhci_pltfm_unregister(pdev);
++>>>>>>> 83eacdfa2529 (mmc: sdhci: disable the clock in sdhci_pltfm_unregister())
  }
  
  #ifdef CONFIG_PM_SLEEP
diff --cc drivers/mmc/host/sdhci-tegra.c
index c8b058283a06,12881e05ff30..000000000000
--- a/drivers/mmc/host/sdhci-tegra.c
+++ b/drivers/mmc/host/sdhci-tegra.c
@@@ -286,22 -323,7 +286,26 @@@ err_alloc_tegra_host
  
  static int sdhci_tegra_remove(struct platform_device *pdev)
  {
++<<<<<<< HEAD
 +	struct sdhci_host *host = platform_get_drvdata(pdev);
 +	struct sdhci_pltfm_host *pltfm_host = sdhci_priv(host);
 +	struct sdhci_tegra *tegra_host = pltfm_host->priv;
 +	int dead = (readl(host->ioaddr + SDHCI_INT_STATUS) == 0xffffffff);
 +
 +	sdhci_remove_host(host, dead);
 +
 +	if (gpio_is_valid(tegra_host->power_gpio))
 +		gpio_free(tegra_host->power_gpio);
 +
 +	clk_disable_unprepare(pltfm_host->clk);
 +	clk_put(pltfm_host->clk);
 +
 +	sdhci_pltfm_free(pdev);
 +
 +	return 0;
++=======
+ 	return sdhci_pltfm_unregister(pdev);
++>>>>>>> 83eacdfa2529 (mmc: sdhci: disable the clock in sdhci_pltfm_unregister())
  }
  
  static struct platform_driver sdhci_tegra_driver = {
* Unmerged path drivers/mmc/host/sdhci-of-arasan.c
* Unmerged path drivers/mmc/host/sdhci-bcm-kona.c
* Unmerged path drivers/mmc/host/sdhci-dove.c
* Unmerged path drivers/mmc/host/sdhci-of-arasan.c
diff --git a/drivers/mmc/host/sdhci-pltfm.c b/drivers/mmc/host/sdhci-pltfm.c
index 0c80d5f1986d..426636904342 100644
--- a/drivers/mmc/host/sdhci-pltfm.c
+++ b/drivers/mmc/host/sdhci-pltfm.c
@@ -221,9 +221,11 @@ EXPORT_SYMBOL_GPL(sdhci_pltfm_register);
 int sdhci_pltfm_unregister(struct platform_device *pdev)
 {
 	struct sdhci_host *host = platform_get_drvdata(pdev);
+	struct sdhci_pltfm_host *pltfm_host = sdhci_priv(host);
 	int dead = (readl(host->ioaddr + SDHCI_INT_STATUS) == 0xffffffff);
 
 	sdhci_remove_host(host, dead);
+	clk_disable_unprepare(pltfm_host->clk);
 	sdhci_pltfm_free(pdev);
 
 	return 0;
* Unmerged path drivers/mmc/host/sdhci-sirf.c
diff --git a/drivers/mmc/host/sdhci-st.c b/drivers/mmc/host/sdhci-st.c
index 328f348c7243..810bc2ccabfe 100644
--- a/drivers/mmc/host/sdhci-st.c
+++ b/drivers/mmc/host/sdhci-st.c
@@ -115,11 +115,6 @@ err_out:
 
 static int sdhci_st_remove(struct platform_device *pdev)
 {
-	struct sdhci_host *host = platform_get_drvdata(pdev);
-	struct sdhci_pltfm_host *pltfm_host = sdhci_priv(host);
-
-	clk_disable_unprepare(pltfm_host->clk);
-
 	return sdhci_pltfm_unregister(pdev);
 }
 
* Unmerged path drivers/mmc/host/sdhci-tegra.c
