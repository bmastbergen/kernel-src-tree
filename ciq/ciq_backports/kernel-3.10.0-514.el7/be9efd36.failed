net: pass changed flags along with NETDEV_CHANGE event

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
Rebuild_CHGLOG: - [net] pass changed flags along with NETDEV_CHANGE event (Ivan Vecera) [1268334]
Rebuild_FUZZ: 95.15%
commit-author Jiri Pirko <jiri@resnulli.us>
commit be9efd3653284f2827fd82861e8e9db9a8f726e1
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/be9efd36.failed

Use new netdevice notifier infrastructure to pass along changed flags.

	Signed-off-by: Timo Ter√§s <timo.teras@iki.fi>
	Signed-off-by: Jiri Pirko <jiri@resnulli.us>

v2->v3: shortened notifier_info struct name
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit be9efd3653284f2827fd82861e8e9db9a8f726e1)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	include/linux/netdevice.h
diff --cc include/linux/netdevice.h
index eb7e9fa3e472,850271809a9e..000000000000
--- a/include/linux/netdevice.h
+++ b/include/linux/netdevice.h
@@@ -1936,12 -1595,29 +1936,36 @@@ struct pcpu_sw_netstats 
  #define NETDEV_RELEASE		0x0012
  #define NETDEV_NOTIFY_PEERS	0x0013
  #define NETDEV_JOIN		0x0014
 -#define NETDEV_CHANGEUPPER	0x0015
 -
 +#define NETDEV_RESEND_IGMP	0x0016
 +#define NETDEV_CHANGEINFODATA	0x0018
 +
++<<<<<<< HEAD
 +int register_netdevice_notifier(struct notifier_block *nb);
 +int unregister_netdevice_notifier(struct notifier_block *nb);
 +int call_netdevice_notifiers(unsigned long val, struct net_device *dev);
++=======
+ extern int register_netdevice_notifier(struct notifier_block *nb);
+ extern int unregister_netdevice_notifier(struct notifier_block *nb);
+ 
+ struct netdev_notifier_info {
+ 	struct net_device *dev;
+ };
+ 
+ struct netdev_notifier_change_info {
+ 	struct netdev_notifier_info info; /* must be first */
+ 	unsigned int flags_changed;
+ };
+ 
+ static inline struct net_device *
+ netdev_notifier_info_to_dev(const struct netdev_notifier_info *info)
+ {
+ 	return info->dev;
+ }
+ 
+ extern int call_netdevice_notifiers_info(unsigned long val, struct net_device *dev,
+ 					 struct netdev_notifier_info *info);
+ extern int call_netdevice_notifiers(unsigned long val, struct net_device *dev);
++>>>>>>> be9efd365328 (net: pass changed flags along with NETDEV_CHANGE event)
  
  
  extern rwlock_t				dev_base_lock;		/* Device list lock */
* Unmerged path include/linux/netdevice.h
diff --git a/net/core/dev.c b/net/core/dev.c
index ce5758e98847..682d49c69036 100644
--- a/net/core/dev.c
+++ b/net/core/dev.c
@@ -5093,8 +5093,13 @@ void __dev_notify_flags(struct net_device *dev, unsigned int old_flags,
 	}
 
 	if (dev->flags & IFF_UP &&
-	    (changes & ~(IFF_UP | IFF_PROMISC | IFF_ALLMULTI | IFF_VOLATILE)))
-		call_netdevice_notifiers(NETDEV_CHANGE, dev);
+	    (changes & ~(IFF_UP | IFF_PROMISC | IFF_ALLMULTI | IFF_VOLATILE))) {
+		struct netdev_notifier_change_info change_info;
+
+		change_info.flags_changed = changes;
+		call_netdevice_notifiers_info(NETDEV_CHANGE, dev,
+					      &change_info.info);
+	}
 }
 
 /**
