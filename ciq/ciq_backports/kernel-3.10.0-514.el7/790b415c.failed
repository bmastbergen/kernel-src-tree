ALSA: hda - hdmi defer to register acomp eld notifier

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Libin Yang <libin.yang@linux.intel.com>
commit 790b415c98de62602810b0eedce26f0f9d6ddd78
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/790b415c.failed

Defer to register acomp eld notifier until hdmi audio driver
is fully ready.

After registering eld notifier, gfx driver can use this
callback function to notify audio driver the monitor
connection event. However this action may happen when
audio driver is adding the pins or doing other initialization.
This is not always safe, however. For example, using
per_pin->lock before the lock is initialized.

Let's register the eld notifier after the initialization is done.

	Signed-off-by: Libin Yang <libin.yang@linux.intel.com>
	Signed-off-by: Takashi Iwai <tiwai@suse.de>
(cherry picked from commit 790b415c98de62602810b0eedce26f0f9d6ddd78)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	sound/pci/hda/patch_hdmi.c
diff --cc sound/pci/hda/patch_hdmi.c
index 07dadb7c58be,bcbc4ee10130..000000000000
--- a/sound/pci/hda/patch_hdmi.c
+++ b/sound/pci/hda/patch_hdmi.c
@@@ -2319,8 -2496,20 +2307,23 @@@ static int patch_generic_hdmi(struct hd
  
  	generic_hdmi_init_per_pins(codec);
  
 -	init_channel_allocations();
  
++<<<<<<< HEAD
 +	WARN_ON(spec->dyn_pcm_assign && !codec_has_acomp(codec));
++=======
+ 	if (codec_has_acomp(codec)) {
+ 		codec->depop_delay = 0;
+ 		spec->i915_audio_ops.audio_ptr = codec;
+ 		/* intel_audio_codec_enable() or intel_audio_codec_disable()
+ 		 * will call pin_eld_notify with using audio_ptr pointer
+ 		 * We need make sure audio_ptr is really setup
+ 		 */
+ 		wmb();
+ 		spec->i915_audio_ops.pin_eld_notify = intel_pin_eld_notify;
+ 		snd_hdac_i915_register_notifier(&spec->i915_audio_ops);
+ 	}
+ 
++>>>>>>> 790b415c98de (ALSA: hda - hdmi defer to register acomp eld notifier)
  	return 0;
  }
  
* Unmerged path sound/pci/hda/patch_hdmi.c
