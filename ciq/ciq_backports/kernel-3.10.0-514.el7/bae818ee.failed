rbd: require stable pages if message data CRCs are enabled

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Ronny Hegewald <ronny.hegewald@online.de>
commit bae818ee1577c27356093901a0ea48f672eda514
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/bae818ee.failed

rbd requires stable pages, as it performs a crc of the page data before
they are send to the OSDs.

But since kernel 3.9 (patch 1d1d1a767206fbe5d4c69493b7e6d2a8d08cc0a0
"mm: only enforce stable page writes if the backing device requires
it") it is not assumed anymore that block devices require stable pages.

This patch sets the necessary flag to get stable pages back for rbd.

In a ceph installation that provides multiple ext4 formatted rbd
devices "bad crc" messages appeared regularly (ca 1 message every 1-2
minutes on every OSD that provided the data for the rbd) in the
OSD-logs before this patch. After this patch this messages are pretty
much gone (only ca 1-2 / month / OSD).

	Cc: stable@vger.kernel.org # 3.9+, needs backporting
	Signed-off-by: Ronny Hegewald <Ronny.Hegewald@online.de>
[idryomov@gmail.com: require stable pages only in crc case, changelog]
	Signed-off-by: Ilya Dryomov <idryomov@gmail.com>
(cherry picked from commit bae818ee1577c27356093901a0ea48f672eda514)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/block/rbd.c
diff --cc drivers/block/rbd.c
index 81afeb35a025,128e7df5b807..000000000000
--- a/drivers/block/rbd.c
+++ b/drivers/block/rbd.c
@@@ -3866,10 -3777,12 +3866,16 @@@ static int rbd_init_disk(struct rbd_dev
  	queue_flag_set_unlocked(QUEUE_FLAG_DISCARD, q);
  	q->limits.discard_granularity = segment_size;
  	q->limits.discard_alignment = segment_size;
 -	blk_queue_max_discard_sectors(q, segment_size / SECTOR_SIZE);
 +	q->limits.max_discard_sectors = segment_size / SECTOR_SIZE;
  	q->limits.discard_zeroes_data = 1;
  
++<<<<<<< HEAD
 +	blk_queue_merge_bvec(q, rbd_merge_bvec);
++=======
+ 	if (!ceph_test_opt(rbd_dev->rbd_client->client, NOCRC))
+ 		q->backing_dev_info.capabilities |= BDI_CAP_STABLE_WRITES;
+ 
++>>>>>>> bae818ee1577 (rbd: require stable pages if message data CRCs are enabled)
  	disk->queue = q;
  
  	q->queuedata = rbd_dev;
* Unmerged path drivers/block/rbd.c
