netfilter: nfnetlink_queue: Unregister pernet subsys in case of init failure

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Nikolay Borisov <kernel@kyup.com>
commit 639e077b43d9c54ffb1e1b54a2de54597ceae1d8
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/639e077b.failed

Commit 3bfe049807c2403 ("netfilter: nfnetlink_{log,queue}:
Register pernet in first place") reorganised the initialisation
order of the pernet_subsys to avoid "use-before-initialised"
condition. However, in doing so the cleanup logic in nfnetlink_queue
got botched in that the pernet_subsys wasn't cleaned in case
nfnetlink_subsys_register failed. This patch adds the necessary
cleanup routine call.

Fixes: 3bfe049807c2403 ("netfilter: nfnetlink_{log,queue}: Register pernet in first place")
	Signed-off-by: Nikolay Borisov <kernel@kyup.com>
	Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
(cherry picked from commit 639e077b43d9c54ffb1e1b54a2de54597ceae1d8)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/netfilter/nfnetlink_queue_core.c
diff --cc net/netfilter/nfnetlink_queue_core.c
index b5cda594b57a,861c6615253b..000000000000
--- a/net/netfilter/nfnetlink_queue_core.c
+++ b/net/netfilter/nfnetlink_queue_core.c
@@@ -1288,10 -1417,10 +1288,15 @@@ static int __init nfnetlink_queue_init(
  	nf_register_queue_handler(&nfqh);
  	return status;
  
 +cleanup_subsys:
 +	nfnetlink_subsys_unregister(&nfqnl_subsys);
  cleanup_netlink_notifier:
  	netlink_unregister_notifier(&nfqnl_rtnl_notifier);
++<<<<<<< HEAD:net/netfilter/nfnetlink_queue_core.c
++=======
+ 	unregister_pernet_subsys(&nfnl_queue_net_ops);
+ out:
++>>>>>>> 639e077b43d9 (netfilter: nfnetlink_queue: Unregister pernet subsys in case of init failure):net/netfilter/nfnetlink_queue.c
  	return status;
  }
  
* Unmerged path net/netfilter/nfnetlink_queue_core.c
