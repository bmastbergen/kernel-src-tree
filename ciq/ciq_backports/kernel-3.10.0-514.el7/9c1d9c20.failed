sd: Reject optimal transfer length smaller than page size

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Martin K. Petersen <martin.petersen@oracle.com>
commit 9c1d9c207bb800498347a2716da298043ee280c5
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/9c1d9c20.failed

Eryu Guan reported that loading scsi_debug would fail. This turned out
to be caused by scsi_debug reporting an optimal I/O size of 32KB which
is smaller than the 64KB page size on the PowerPC system in question.

Add a check to ensure that we only use the device-reported OPTIMAL
TRANSFER LENGTH if it is bigger than or equal to the page cache size.

	Reported-by: Eryu Guan <guaneryu@gmail.com>
	Reported-by: Ming Lei <tom.leiming@gmail.com>
	Reviewed-by: Douglas Gilbert <dgilbert@interlog.com>
	Reviewed-by: Ewan Milne <emilne@redhat.com>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit 9c1d9c207bb800498347a2716da298043ee280c5)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/sd.c
diff --cc drivers/scsi/sd.c
index aba2f00de9b1,4e08d1cd704d..000000000000
--- a/drivers/scsi/sd.c
+++ b/drivers/scsi/sd.c
@@@ -2893,11 -2876,29 +2893,34 @@@ static int sd_revalidate_disk(struct ge
  	 */
  	sd_set_flush_flag(sdkp);
  
 -	/* Initial block count limit based on CDB TRANSFER LENGTH field size. */
 -	dev_max = sdp->use_16_for_rw ? SD_MAX_XFER_BLOCKS : SD_DEF_XFER_BLOCKS;
 +	max_xfer = sdkp->max_xfer_blocks;
 +	max_xfer <<= ilog2(sdp->sector_size) - 9;
  
++<<<<<<< HEAD
 +	sdkp->disk->queue->limits.max_sectors =
 +		min_not_zero(queue_max_hw_sectors(sdkp->disk->queue), max_xfer);
++=======
+ 	/* Some devices report a maximum block count for READ/WRITE requests. */
+ 	dev_max = min_not_zero(dev_max, sdkp->max_xfer_blocks);
+ 	q->limits.max_dev_sectors = logical_to_sectors(sdp, dev_max);
+ 
+ 	/*
+ 	 * Use the device's preferred I/O size for reads and writes
+ 	 * unless the reported value is unreasonably small, large, or
+ 	 * garbage.
+ 	 */
+ 	if (sdkp->opt_xfer_blocks &&
+ 	    sdkp->opt_xfer_blocks <= dev_max &&
+ 	    sdkp->opt_xfer_blocks <= SD_DEF_XFER_BLOCKS &&
+ 	    sdkp->opt_xfer_blocks * sdp->sector_size >= PAGE_CACHE_SIZE)
+ 		rw_max = q->limits.io_opt =
+ 			logical_to_sectors(sdp, sdkp->opt_xfer_blocks);
+ 	else
+ 		rw_max = BLK_DEF_MAX_SECTORS;
+ 
+ 	/* Combine with controller limits */
+ 	q->limits.max_sectors = min(rw_max, queue_max_hw_sectors(q));
++>>>>>>> 9c1d9c207bb8 (sd: Reject optimal transfer length smaller than page size)
  
  	set_capacity(disk, sdkp->capacity);
  	sd_config_write_same(sdkp);
* Unmerged path drivers/scsi/sd.c
