ahci: switch from 'threaded' to 'hardirq' interrupt handling

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Dan Williams <dan.j.williams@intel.com>
commit a6b7fb764ed2a6b7bb1ac96d93c06787aa589092
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/a6b7fb76.failed

For high frequency I/O the overhead of threaded interrupts impacts
performance.  A quick out-of-the-box test (i.e. no affinity tuning)
shows ~10% random read performance at ~20% less cpu.  The cpu wins
appear to be from reduced lock contention.

	Signed-off-by: Dan Williams <dan.j.williams@intel.com>
	Signed-off-by: Tejun Heo <tj@kernel.org>
(cherry picked from commit a6b7fb764ed2a6b7bb1ac96d93c06787aa589092)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/ata/libahci.c
diff --cc drivers/ata/libahci.c
index 245e3eaedd22,1b6c7cc415bf..000000000000
--- a/drivers/ata/libahci.c
+++ b/drivers/ata/libahci.c
@@@ -1821,10 -1813,37 +1804,10 @@@ static irqreturn_t ahci_multi_irqs_intr
  
  	VPRINTK("EXIT\n");
  
- 	return IRQ_WAKE_THREAD;
+ 	return IRQ_HANDLED;
  }
  
 -static u32 ahci_handle_port_intr(struct ata_host *host, u32 irq_masked)
 -{
 -	unsigned int i, handled = 0;
 -
 -	for (i = 0; i < host->n_ports; i++) {
 -		struct ata_port *ap;
 -
 -		if (!(irq_masked & (1 << i)))
 -			continue;
 -
 -		ap = host->ports[i];
 -		if (ap) {
 -			ahci_port_intr(ap);
 -			VPRINTK("port %u\n", i);
 -		} else {
 -			VPRINTK("port %u (no irq)\n", i);
 -			if (ata_ratelimit())
 -				dev_warn(host->dev,
 -					 "interrupt on disabled port %u\n", i);
 -		}
 -
 -		handled = 1;
 -	}
 -
 -	return handled;
 -}
 -
 -static irqreturn_t ahci_single_edge_irq_intr(int irq, void *dev_instance)
 +static irqreturn_t ahci_single_irq_intr(int irq, void *dev_instance)
  {
  	struct ata_host *host = dev_instance;
  	struct ahci_host_priv *hpriv;
@@@ -2428,14 -2482,14 +2411,20 @@@ static int ahci_host_activate_multi_irq
  			continue;
  		}
  
++<<<<<<< HEAD
 +		rc = devm_request_threaded_irq(host->dev, irq + i,
 +					       ahci_multi_irqs_intr,
 +					       ahci_port_thread_fn, 0,
 +					       pp->irq_desc, host->ports[i]);
++=======
+ 		rc = devm_request_irq(host->dev, irq, ahci_multi_irqs_intr_hard,
+ 				0, pp->irq_desc, host->ports[i]);
+ 
++>>>>>>> a6b7fb764ed2 (ahci: switch from 'threaded' to 'hardirq' interrupt handling)
  		if (rc)
  			return rc;
 -		ata_port_desc(host->ports[i], "irq %d", irq);
 +		ata_port_desc(host->ports[i], "irq %d", irq + i);
  	}
 -
  	return ata_host_register(host, sht);
  }
  
* Unmerged path drivers/ata/libahci.c
