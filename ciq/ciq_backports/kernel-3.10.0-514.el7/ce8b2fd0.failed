IB/hfi1: Update pkey table properly after link down or FM start

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Sebastian Sanchez <sebastian.sanchez@intel.com>
commit ce8b2fd0950ccc14440b02f05d2c7023608cfa76
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/ce8b2fd0.failed

When FM is disabled, and the HFI port on the switch is
changed from MgmtAllowed=YES to MgmtAllowed=NO and the
link is bounced, FULL_MGMT_P_KEY doesn't get cleared
from the pkey table. This also occurs when the QSFP
cable is moved from a switch port with MgmtAllowed=YES
to a MgmtAllowed=NO port. Clear pkey entry properly.

Also, when the driver is loaded and the switch port is
set to MgmtAllowed=NO, FULL_MGMT_P_KEY shouldn't be added
to pkey table after FM is started. Only set FULL_MGMT_P_KEY
in the pkey table if switch port is configured to
MgmtAllowed=YES.

	Reviewed-by: Dean Luick <dean.luick@intel.com>
	Signed-off-by: Sebastian Sanchez <sebastian.sanchez@intel.com>
	Signed-off-by: Doug Ledford <dledford@redhat.com>
(cherry picked from commit ce8b2fd0950ccc14440b02f05d2c7023608cfa76)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/staging/hfi1/chip.c
diff --cc drivers/staging/hfi1/chip.c
index 0b4db256e34f,3b876da745a1..000000000000
--- a/drivers/staging/hfi1/chip.c
+++ b/drivers/staging/hfi1/chip.c
@@@ -1032,6 -1034,10 +1032,12 @@@ static void read_planned_down_reason_co
  static void handle_temp_err(struct hfi1_devdata *);
  static void dc_shutdown(struct hfi1_devdata *);
  static void dc_start(struct hfi1_devdata *);
++<<<<<<< HEAD:drivers/staging/hfi1/chip.c
++=======
+ static int qos_rmt_entries(struct hfi1_devdata *dd, unsigned int *mp,
+ 			   unsigned int *np);
+ static void remove_full_mgmt_pkey(struct hfi1_pportdata *ppd);
++>>>>>>> ce8b2fd0950c (IB/hfi1: Update pkey table properly after link down or FM start):drivers/infiniband/hw/hfi1/chip.c
  
  /*
   * Error interrupt table entry.  This is used as input to the interrupt
* Unmerged path drivers/staging/hfi1/chip.c
diff --git a/drivers/staging/hfi1/mad.c b/drivers/staging/hfi1/mad.c
index a1d1bd3b5d27..9e29d9bce0fb 100644
--- a/drivers/staging/hfi1/mad.c
+++ b/drivers/staging/hfi1/mad.c
@@ -1384,6 +1384,12 @@ static int set_pkeys(struct hfi1_devdata *dd, u8 port, u16 *pkeys)
 
 		if (key == okey)
 			continue;
+		/*
+		 * Don't update pkeys[2], if an HFI port without MgmtAllowed
+		 * by neighbor is a switch.
+		 */
+		if (i == 2 && !ppd->mgmt_allowed && ppd->neighbor_type == 1)
+			continue;
 		/*
 		 * The SM gives us the complete PKey table. We have
 		 * to ensure that we put the PKeys in the matching
