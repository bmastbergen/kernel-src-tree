IB/srp: Always initialize use_fast_reg and use_fmr

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Bart Van Assche <bart.vanassche@sandisk.com>
commit 249f06561fc333581e48e6d388a56e3d100d23b6
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/249f0656.failed

Avoid that mapping fails due to use_fast_reg != 0 or use_fmr != 0
if both member variables should be zero (if never_register == 1 or
if neither FMR nor FR is supported). Remove an initialization that
became superfluous due to changing a kmalloc() into a kzalloc()
call.

Fixes: 509c5f33f4f6 ("IB/srp: Prevent mapping failures")
	Cc: Sagi Grimberg <sai@grimberg.m>
	Cc: Christoph Hellwig <hch@lst.de>
	Cc: Laurence Oberman <loberman@redhat.com>
	Signed-off-by: Bart Van Assche <bart.vanassche@sandisk.com>
	Reviewed-by: Leon Romanovsky <leonro@mellanox.com>
	Reviewed-by: Sagi Grimberg <sagi@grimberg.me>
	Reviewed-by: Christoph Hellwig <hch@lst.de>
	Signed-off-by: Doug Ledford <dledford@redhat.com>
(cherry picked from commit 249f06561fc333581e48e6d388a56e3d100d23b6)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/ulp/srp/ib_srp.c
diff --cc drivers/infiniband/ulp/srp/ib_srp.c
index eb57f69536ed,bc24b8d32ce6..000000000000
--- a/drivers/infiniband/ulp/srp/ib_srp.c
+++ b/drivers/infiniband/ulp/srp/ib_srp.c
@@@ -3449,29 -3526,9 +3449,33 @@@ static void srp_add_one(struct ib_devic
  	int mr_page_shift, p;
  	u64 max_pages_per_mr;
  
++<<<<<<< HEAD
 +	dev_attr = kmalloc(sizeof *dev_attr, GFP_KERNEL);
 +	if (!dev_attr)
 +		return;
 +
 +	if (ib_query_device(device, dev_attr)) {
 +		pr_warn("Query device failed for %s\n", device->name);
 +		goto free_attr;
 +	}
 +
 +	srp_dev = kmalloc(sizeof *srp_dev, GFP_KERNEL);
++=======
+ 	srp_dev = kzalloc(sizeof(*srp_dev), GFP_KERNEL);
++>>>>>>> 249f06561fc3 (IB/srp: Always initialize use_fast_reg and use_fmr)
  	if (!srp_dev)
 -		return;
 +		goto free_attr;
 +
 +	srp_dev->has_fmr = (device->alloc_fmr && device->dealloc_fmr &&
 +			    device->map_phys_fmr && device->unmap_fmr);
 +	srp_dev->has_fr = (dev_attr->device_cap_flags &
 +			   IB_DEVICE_MEM_MGT_EXTENSIONS);
 +	if (!srp_dev->has_fmr && !srp_dev->has_fr)
 +		dev_warn(&device->dev, "neither FMR nor FR is supported\n");
 +
 +	srp_dev->use_fast_reg = (srp_dev->has_fr &&
 +				 (!srp_dev->has_fmr || prefer_fr));
 +	srp_dev->use_fmr = !srp_dev->use_fast_reg && srp_dev->has_fmr;
  
  	/*
  	 * Use the smallest page size supported by the HCA, down to a
* Unmerged path drivers/infiniband/ulp/srp/ib_srp.c
