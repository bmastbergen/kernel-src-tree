libnvdimm: enable iostat

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Dan Williams <dan.j.williams@intel.com>
commit f0dc089ce217e7b98e0d2077c548ff08129e7911
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/f0dc089c.failed

This is disabled by default as the overhead is prohibitive, but if the
user takes the action to turn it on we'll oblige.

	Reviewed-by: Vishal Verma <vishal.l.verma@linux.intel.com>
	Signed-off-by: Dan Williams <dan.j.williams@intel.com>
(cherry picked from commit f0dc089ce217e7b98e0d2077c548ff08129e7911)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/nvdimm/blk.c
#	drivers/nvdimm/btt.c
#	drivers/nvdimm/core.c
#	drivers/nvdimm/nd.h
* Unmerged path drivers/nvdimm/blk.c
* Unmerged path drivers/nvdimm/btt.c
* Unmerged path drivers/nvdimm/core.c
* Unmerged path drivers/nvdimm/nd.h
diff --git a/drivers/block/pmem.c b/drivers/block/pmem.c
index 6ac10394afa7..f069cb19789f 100644
--- a/drivers/block/pmem.c
+++ b/drivers/block/pmem.c
@@ -58,14 +58,19 @@ static void pmem_do_bvec(struct pmem_device *pmem, struct page *page,
 
 static void pmem_make_request(struct request_queue *q, struct bio *bio)
 {
+	bool do_acct;
+	unsigned long start;
 	struct bio_vec bvec;
 	struct bvec_iter iter;
 	struct block_device *bdev = bio->bi_bdev;
 	struct pmem_device *pmem = bdev->bd_disk->private_data;
 
+	do_acct = nd_iostat_start(bio, &start);
 	bio_for_each_segment(bvec, bio, iter)
 		pmem_do_bvec(pmem, bvec.bv_page, bvec.bv_len, bvec.bv_offset,
 				bio_data_dir(bio), iter.bi_sector);
+	if (do_acct)
+		nd_iostat_end(bio, start);
 	bio_endio(bio, 0);
 }
 
* Unmerged path drivers/nvdimm/blk.c
* Unmerged path drivers/nvdimm/btt.c
* Unmerged path drivers/nvdimm/core.c
* Unmerged path drivers/nvdimm/nd.h
