netfilter: bridge: build br_nf_core only if required

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Florian Westphal <fw@strlen.de>
commit 57f5877c11b244ff2315f4ba0e57b54fe013581f
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/57f5877c.failed

Eric reports build failure with
CONFIG_BRIDGE_NETFILTER=n

We insist to build br_nf_core.o unconditionally, but we must only do so
if br_netfilter was enabled, else it fails to build due to
functions being defined to empty stubs (and some structure members
being defined out).

Also, BRIDGE_NETFILTER=y|m makes no sense when BRIDGE=n.

Fixes: 34666d467 (netfilter: bridge: move br_netfilter out of the core)
	Reported-by: Eric Dumazet <eric.dumazet@gmail.com>
	Signed-off-by: Florian Westphal <fw@strlen.de>
	Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 57f5877c11b244ff2315f4ba0e57b54fe013581f)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/Kconfig
#	net/bridge/Makefile
diff --cc net/Kconfig
index dfcf6d3459d0,d6b138e2c263..000000000000
--- a/net/Kconfig
+++ b/net/Kconfig
@@@ -171,10 -176,11 +171,16 @@@ config NETFILTER_ADVANCE
  	  If unsure, say Y.
  
  config BRIDGE_NETFILTER
++<<<<<<< HEAD
 +	bool "Bridged IP/ARP packets filtering"
 +	depends on BRIDGE && NETFILTER && INET
++=======
+ 	tristate "Bridged IP/ARP packets filtering"
+ 	depends on BRIDGE
+ 	depends on NETFILTER && INET
++>>>>>>> 57f5877c11b2 (netfilter: bridge: build br_nf_core only if required)
  	depends on NETFILTER_ADVANCED
 -	default m
 +	default y
  	---help---
  	  Enabling this option will let arptables resp. iptables see bridged
  	  ARP resp. IP traffic. If you want a bridging firewall, you probably
diff --cc net/bridge/Makefile
index be68796fdffd,fd7ee03c59b3..000000000000
--- a/net/bridge/Makefile
+++ b/net/bridge/Makefile
@@@ -5,12 -5,14 +5,22 @@@
  obj-$(CONFIG_BRIDGE) += bridge.o
  
  bridge-y	:= br.o br_device.o br_fdb.o br_forward.o br_if.o br_input.o \
++<<<<<<< HEAD
 +			br_ioctl.o br_notify.o br_stp.o br_stp_bpdu.o \
++=======
+ 			br_ioctl.o br_stp.o br_stp_bpdu.o \
++>>>>>>> 57f5877c11b2 (netfilter: bridge: build br_nf_core only if required)
  			br_stp_if.o br_stp_timer.o br_netlink.o
  
  bridge-$(CONFIG_SYSFS) += br_sysfs_if.o br_sysfs_br.o
  
++<<<<<<< HEAD
 +bridge-$(CONFIG_BRIDGE_NETFILTER) += br_netfilter.o
++=======
+ bridge-$(subst m,y,$(CONFIG_BRIDGE_NETFILTER)) += br_nf_core.o
+ 
+ obj-$(CONFIG_BRIDGE_NETFILTER) += br_netfilter.o
++>>>>>>> 57f5877c11b2 (netfilter: bridge: build br_nf_core only if required)
  
  bridge-$(CONFIG_BRIDGE_IGMP_SNOOPING) += br_multicast.o br_mdb.o
  
* Unmerged path net/Kconfig
* Unmerged path net/bridge/Makefile
