iommu/vt-d: Move EIM detection to intel_prepare_irq_remapping

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
Rebuild_CHGLOG: - [iommu] vt-d: Move EIM detection to intel_prepare_irq_remapping (Myron Stowe) [1050021]
Rebuild_FUZZ: 94.83%
commit-author Joerg Roedel <jroedel@suse.de>
commit 23256d0b350014a05c1edf0f355546aa1ff2eb55
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/23256d0b.failed

We need this to be detected already when we program the irq
remapping table pointer to hardware.

	Tested-by: ZhenHua Li <zhen-hual@hp.com>
	Tested-by: Baoquan He <bhe@redhat.com>
	Signed-off-by: Joerg Roedel <jroedel@suse.de>
(cherry picked from commit 23256d0b350014a05c1edf0f355546aa1ff2eb55)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/iommu/intel_irq_remapping.c
diff --cc drivers/iommu/intel_irq_remapping.c
index 085a116a8b0a,12250f72be0b..000000000000
--- a/drivers/iommu/intel_irq_remapping.c
+++ b/drivers/iommu/intel_irq_remapping.c
@@@ -587,10 -589,10 +587,11 @@@ static int __init intel_prepare_irq_rem
  {
  	struct dmar_drhd_unit *drhd;
  	struct intel_iommu *iommu;
+ 	int eim = 0;
  
  	if (irq_remap_broken) {
 -		pr_warn("This system BIOS has enabled interrupt remapping\n"
 +		printk(KERN_WARNING
 +			"This system BIOS has enabled interrupt remapping\n"
  			"on a chipset that contains an erratum making that\n"
  			"feature unstable.  To maintain system stability\n"
  			"interrupt remapping is being disabled.  Please\n"
@@@ -663,19 -678,6 +677,22 @@@ static int __init intel_enable_irq_rema
  	}
  
  	/*
++<<<<<<< HEAD
 +	 * check for the Interrupt-remapping support
 +	 */
 +	for_each_iommu(iommu, drhd)
 +		if (eim && !ecap_eim_support(iommu->ecap)) {
 +			printk(KERN_INFO "DRHD %Lx: EIM not supported by DRHD, "
 +			       " ecap %Lx\n", drhd->reg_base_addr, iommu->ecap);
 +			eim = 0;
 +		}
 +	eim_mode = eim;
 +	if (eim)
 +		pr_info("Queued invalidation will be enabled to support x2apic and Intr-remapping.\n");
 +
 +	/*
++=======
++>>>>>>> 23256d0b3500 (iommu/vt-d: Move EIM detection to intel_prepare_irq_remapping)
  	 * Enable queued invalidation for all the DRHD's.
  	 */
  	for_each_iommu(iommu, drhd) {
* Unmerged path drivers/iommu/intel_irq_remapping.c
