PCI: Propagate the "ignore hotplug" setting to parent

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Rafael J. Wysocki <rafael.j.wysocki@intel.com>
commit 0824965140fff1bf640a987dc790d1594a8e0699
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/08249651.failed

Refine the mechanism introduced by commit f244d8b623da ("ACPIPHP / radeon /
nouveau: Fix VGA switcheroo problem related to hotplug") to propagate the
ignore_hotplug setting of the device to its parent bridge in case hotplug
notifications related to the graphics adapter switching are given for the
bridge rather than for the device itself (they need to be ignored in both
cases).

Link: https://bugzilla.kernel.org/show_bug.cgi?id=61891
Link: https://bugs.freedesktop.org/show_bug.cgi?id=88927
Fixes: b440bde74f04 ("PCI: Add pci_ignore_hotplug() to ignore hotplug events for a device")
Reported-and-tested-by: tiagdtd-lava <tiagdtd-lava@yahoo.de>
	Signed-off-by: Rafael J. Wysocki <rafael.j.wysocki@intel.com>
	Signed-off-by: Bjorn Helgaas <bhelgaas@google.com>
CC: stable@vger.kernel.org	# v3.17+
(cherry picked from commit 0824965140fff1bf640a987dc790d1594a8e0699)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	include/linux/pci.h
diff --cc include/linux/pci.h
index fc6767850ccc,ef45ffe9ca88..000000000000
--- a/include/linux/pci.h
+++ b/include/linux/pci.h
@@@ -1064,12 -1044,11 +1065,20 @@@ bool pci_dev_run_wake(struct pci_dev *d
  bool pci_check_pme_status(struct pci_dev *dev);
  void pci_pme_wakeup_bus(struct pci_bus *bus);
  
++<<<<<<< HEAD
 +static inline void pci_ignore_hotplug(struct pci_dev *dev)
 +{
 +	dev->ignore_hotplug = 1;
 +}
 +
 +int pci_enable_wake(struct pci_dev *dev, pci_power_t state, bool enable);
++=======
+ static inline int pci_enable_wake(struct pci_dev *dev, pci_power_t state,
+ 				  bool enable)
+ {
+ 	return __pci_enable_wake(dev, state, false, enable);
+ }
++>>>>>>> 0824965140ff (PCI: Propagate the "ignore hotplug" setting to parent)
  
  /* PCI Virtual Channel */
  int pci_save_vc_state(struct pci_dev *dev);
diff --git a/drivers/pci/pci.c b/drivers/pci/pci.c
index 1126474d9c49..f809851a4f79 100644
--- a/drivers/pci/pci.c
+++ b/drivers/pci/pci.c
@@ -4276,6 +4276,17 @@ bool pci_device_is_present(struct pci_dev *pdev)
 }
 EXPORT_SYMBOL_GPL(pci_device_is_present);
 
+void pci_ignore_hotplug(struct pci_dev *dev)
+{
+	struct pci_dev *bridge = dev->bus->self;
+
+	dev->ignore_hotplug = 1;
+	/* Propagate the "ignore hotplug" setting to the parent bridge. */
+	if (bridge)
+		bridge->ignore_hotplug = 1;
+}
+EXPORT_SYMBOL_GPL(pci_ignore_hotplug);
+
 #define RESOURCE_ALIGNMENT_PARAM_SIZE COMMAND_LINE_SIZE
 static char resource_alignment_param[RESOURCE_ALIGNMENT_PARAM_SIZE] = {0};
 static DEFINE_SPINLOCK(resource_alignment_lock);
* Unmerged path include/linux/pci.h
