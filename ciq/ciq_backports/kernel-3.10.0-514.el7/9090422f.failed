KVM: nVMX: checks for address bits beyond MAXPHYADDR on VM-entry

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Eugene Korenevsky <ekorenevsky@gmail.com>
commit 9090422f1ca5270795738549cf91a4ae7cb47662
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/9090422f.failed

On each VM-entry CPU should check the following VMCS fields for zero bits
beyond physical address width:
-  APIC-access address
-  virtual-APIC address
-  posted-interrupt descriptor address
This patch adds these checks required by Intel SDM.

	Signed-off-by: Eugene Korenevsky <ekorenevsky@gmail.com>
Message-Id: <20150329205627.GA1244@gnote>
	Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
(cherry picked from commit 9090422f1ca5270795738549cf91a4ae7cb47662)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kvm/vmx.c
diff --cc arch/x86/kvm/vmx.c
index a36fdcc51ab2,6f770e875936..000000000000
--- a/arch/x86/kvm/vmx.c
+++ b/arch/x86/kvm/vmx.c
@@@ -8543,6 -8665,32 +8544,35 @@@ static bool nested_get_vmcs12_pages(str
  			return false;
  	}
  
++<<<<<<< HEAD
++=======
+ 	if (nested_cpu_has_posted_intr(vmcs12)) {
+ 		if (!IS_ALIGNED(vmcs12->posted_intr_desc_addr, 64) ||
+ 		    vmcs12->posted_intr_desc_addr >> maxphyaddr)
+ 			return false;
+ 
+ 		if (vmx->nested.pi_desc_page) { /* shouldn't happen */
+ 			kunmap(vmx->nested.pi_desc_page);
+ 			nested_release_page(vmx->nested.pi_desc_page);
+ 		}
+ 		vmx->nested.pi_desc_page =
+ 			nested_get_page(vcpu, vmcs12->posted_intr_desc_addr);
+ 		if (!vmx->nested.pi_desc_page)
+ 			return false;
+ 
+ 		vmx->nested.pi_desc =
+ 			(struct pi_desc *)kmap(vmx->nested.pi_desc_page);
+ 		if (!vmx->nested.pi_desc) {
+ 			nested_release_page_clean(vmx->nested.pi_desc_page);
+ 			return false;
+ 		}
+ 		vmx->nested.pi_desc =
+ 			(struct pi_desc *)((void *)vmx->nested.pi_desc +
+ 			(unsigned long)(vmcs12->posted_intr_desc_addr &
+ 			(PAGE_SIZE - 1)));
+ 	}
+ 
++>>>>>>> 9090422f1ca5 (KVM: nVMX: checks for address bits beyond MAXPHYADDR on VM-entry)
  	return true;
  }
  
* Unmerged path arch/x86/kvm/vmx.c
