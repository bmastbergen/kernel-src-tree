s390/dasd: fix disconnected device with valid path mask

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
Rebuild_CHGLOG: - [s390] dasd: fix disconnected device with valid path mask (Hendrik Brueckner) [1284021]
Rebuild_FUZZ: 95.24%
commit-author Stefan Haberland <stefan.haberland@de.ibm.com>
commit ccc0e7dc708ce1bd2e1c4a2b6a180ae7459374de
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/ccc0e7dc.failed

Path verification is either done via dasd_eckd_read_conf() which is
triggered during online processing and resume or via
do_path_verification_work() which is triggered after path events.
The dasd_eckd_read_conf() version added paths unconditionally and did
not check if the path mask was empty. This led to devices having the
disconnected stop flag set but a valid path mask. So they where not
working although they had paths validated successfully. After a resume
this state could even not be solved with additional paths added.

Fix by checking for an empty path mask in dasd_eckd_read_conf() and
clearing the device stop bits for a newly added channel path.

	Reviewed-by: Sebastian Ott <sebott@linux.vnet.ibm.com>
	Signed-off-by: Stefan Haberland <stefan.haberland@de.ibm.com>
	Signed-off-by: Martin Schwidefsky <schwidefsky@de.ibm.com>
(cherry picked from commit ccc0e7dc708ce1bd2e1c4a2b6a180ae7459374de)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/s390/block/dasd_eckd.c
diff --cc drivers/s390/block/dasd_eckd.c
index a80f6ae91fdf,9083247f55a8..000000000000
--- a/drivers/s390/block/dasd_eckd.c
+++ b/drivers/s390/block/dasd_eckd.c
@@@ -1138,10 -1171,19 +1138,26 @@@ static int dasd_eckd_read_conf(struct d
  			path_data->ppm |= lpm;
  			break;
  		}
++<<<<<<< HEAD
 +		path_data->opm |= lpm;
 +
 +		if (conf_data != private->conf_data)
 +			kfree(conf_data);
++=======
+ 		if (!path_data->opm) {
+ 			path_data->opm = lpm;
+ 			dasd_generic_path_operational(device);
+ 		} else {
+ 			path_data->opm |= lpm;
+ 		}
+ 		/*
+ 		 * if the path is used
+ 		 * it should not be in one of the negative lists
+ 		 */
+ 		path_data->cablepm &= ~lpm;
+ 		path_data->hpfpm &= ~lpm;
+ 		path_data->cuirpm &= ~lpm;
++>>>>>>> ccc0e7dc708c (s390/dasd: fix disconnected device with valid path mask)
  	}
  
  	return path_err;
* Unmerged path drivers/s390/block/dasd_eckd.c
