ethtool: ensure channel counts are within bounds during SCHANNELS

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Keller, Jacob E <jacob.e.keller@intel.com>
commit 8bf3686204861d39803797ebbd1e264442421907
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/8bf36862.failed

Add a sanity check to ensure that all requested channel sizes are within
bounds, which should reduce errors in driver implementation.

	Signed-off-by: Jacob Keller <jacob.e.keller@intel.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 8bf3686204861d39803797ebbd1e264442421907)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/core/ethtool.c
diff --cc net/core/ethtool.c
index 7158422fa5fd,65f907aea777..000000000000
--- a/net/core/ethtool.c
+++ b/net/core/ethtool.c
@@@ -1198,14 -1274,31 +1198,38 @@@ static noinline_for_stack int ethtool_g
  static noinline_for_stack int ethtool_set_channels(struct net_device *dev,
  						   void __user *useraddr)
  {
++<<<<<<< HEAD
 +	struct ethtool_channels channels;
++=======
+ 	struct ethtool_channels channels, max;
+ 	u32 max_rx_in_use = 0;
++>>>>>>> 8bf368620486 (ethtool: ensure channel counts are within bounds during SCHANNELS)
  
- 	if (!dev->ethtool_ops->set_channels)
+ 	if (!dev->ethtool_ops->set_channels || !dev->ethtool_ops->get_channels)
  		return -EOPNOTSUPP;
  
  	if (copy_from_user(&channels, useraddr, sizeof(channels)))
  		return -EFAULT;
  
++<<<<<<< HEAD
++=======
+ 	dev->ethtool_ops->get_channels(dev, &max);
+ 
+ 	/* ensure new counts are within the maximums */
+ 	if ((channels.rx_count > max.max_rx) ||
+ 	    (channels.tx_count > max.max_tx) ||
+ 	    (channels.combined_count > max.max_combined) ||
+ 	    (channels.other_count > max.max_other))
+ 		return -EINVAL;
+ 
+ 	/* ensure the new Rx count fits within the configured Rx flow
+ 	 * indirection table settings */
+ 	if (netif_is_rxfh_configured(dev) &&
+ 	    !ethtool_get_max_rxfh_channel(dev, &max_rx_in_use) &&
+ 	    (channels.combined_count + channels.rx_count) <= max_rx_in_use)
+ 	    return -EINVAL;
+ 
++>>>>>>> 8bf368620486 (ethtool: ensure channel counts are within bounds during SCHANNELS)
  	return dev->ethtool_ops->set_channels(dev, &channels);
  }
  
* Unmerged path net/core/ethtool.c
