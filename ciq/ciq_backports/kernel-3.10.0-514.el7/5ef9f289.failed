OVS: Ignore negative headroom value

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
Rebuild_CHGLOG: - [net] openvswitch: Ignore negative headroom value (Jakub Sitnicki) [1369642]
Rebuild_FUZZ: 89.74%
commit-author Ian Wienand <iwienand@redhat.com>
commit 5ef9f289c4e698054e5687edb54f0da3cdc9173a
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/5ef9f289.failed

net_device->ndo_set_rx_headroom (introduced in
871b642adebe300be2e50aa5f65a418510f636ec) says

  "Setting a negtaive value reset the rx headroom
   to the default value".

It seems that the OVS implementation in
3a927bc7cf9d0fbe8f4a8189dd5f8440228f64e7 overlooked this and sets
dev->needed_headroom unconditionally.

This doesn't have an immediate effect, but can mess up later
LL_RESERVED_SPACE calculations, such as done in
net/ipv6/mcast.c:mld_newpack.  For reference, this issue was found
from a skb_panic raised there after the length calculations had given
the wrong result.

Note the other current users of this interface
(drivers/net/tun.c:tun_set_headroom and
drivers/net/veth.c:veth_set_rx_headroom) are both checking this
correctly thus need no modification.

Thanks to Ben for some pointers from the crash dumps!

	Cc: Benjamin Poirier <bpoirier@suse.com>
	Cc: Paolo Abeni <pabeni@redhat.com>
Bugzilla: https://bugzilla.redhat.com/show_bug.cgi?id=1361414
	Signed-off-by: Ian Wienand <iwienand@redhat.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 5ef9f289c4e698054e5687edb54f0da3cdc9173a)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/openvswitch/vport-internal_dev.c
diff --cc net/openvswitch/vport-internal_dev.c
index d6aef25cd7bb,95c36147a6e1..000000000000
--- a/net/openvswitch/vport-internal_dev.c
+++ b/net/openvswitch/vport-internal_dev.c
@@@ -115,6 -106,43 +115,46 @@@ static void internal_dev_destructor(str
  	free_netdev(dev);
  }
  
++<<<<<<< HEAD
++=======
+ static struct rtnl_link_stats64 *
+ internal_get_stats(struct net_device *dev, struct rtnl_link_stats64 *stats)
+ {
+ 	int i;
+ 
+ 	memset(stats, 0, sizeof(*stats));
+ 	stats->rx_errors  = dev->stats.rx_errors;
+ 	stats->tx_errors  = dev->stats.tx_errors;
+ 	stats->tx_dropped = dev->stats.tx_dropped;
+ 	stats->rx_dropped = dev->stats.rx_dropped;
+ 
+ 	for_each_possible_cpu(i) {
+ 		const struct pcpu_sw_netstats *percpu_stats;
+ 		struct pcpu_sw_netstats local_stats;
+ 		unsigned int start;
+ 
+ 		percpu_stats = per_cpu_ptr(dev->tstats, i);
+ 
+ 		do {
+ 			start = u64_stats_fetch_begin_irq(&percpu_stats->syncp);
+ 			local_stats = *percpu_stats;
+ 		} while (u64_stats_fetch_retry_irq(&percpu_stats->syncp, start));
+ 
+ 		stats->rx_bytes         += local_stats.rx_bytes;
+ 		stats->rx_packets       += local_stats.rx_packets;
+ 		stats->tx_bytes         += local_stats.tx_bytes;
+ 		stats->tx_packets       += local_stats.tx_packets;
+ 	}
+ 
+ 	return stats;
+ }
+ 
+ static void internal_set_rx_headroom(struct net_device *dev, int new_hr)
+ {
+ 	dev->needed_headroom = new_hr < 0 ? 0 : new_hr;
+ }
+ 
++>>>>>>> 5ef9f289c4e6 (OVS: Ignore negative headroom value)
  static const struct net_device_ops internal_dev_netdev_ops = {
  	.ndo_open = internal_dev_open,
  	.ndo_stop = internal_dev_stop,
* Unmerged path net/openvswitch/vport-internal_dev.c
