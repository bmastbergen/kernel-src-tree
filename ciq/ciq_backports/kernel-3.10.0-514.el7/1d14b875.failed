powerpc/pseries: Move MSI-related ops to pci_controller_ops

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
Rebuild_CHGLOG: - [powerpc] pseries: Move MSI-related ops to pci_controller_ops (Gustavo Duarte) [1275657]
Rebuild_FUZZ: 92.73%
commit-author Daniel Axtens <dja@axtens.net>
commit 1d14b8755f0a7d8110f0bdc5b74987f8cc96c18e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/1d14b875.failed

Move the pseries platform to use the pci_controller_ops structure
rather than ppc_md for MSI related PCI controller operations

We need to iterate all PHBs because the MSI setup happens later than
find_and_init_phbs() - mpe.

	Signed-off-by: Daniel Axtens <dja@axtens.net>
	Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
(cherry picked from commit 1d14b8755f0a7d8110f0bdc5b74987f8cc96c18e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/powerpc/platforms/pseries/msi.c
diff --cc arch/powerpc/platforms/pseries/msi.c
index b08a3e7a1a32,c22bb647cce6..000000000000
--- a/arch/powerpc/platforms/pseries/msi.c
+++ b/arch/powerpc/platforms/pseries/msi.c
@@@ -16,7 -16,10 +16,9 @@@
  #include <asm/rtas.h>
  #include <asm/hw_irq.h>
  #include <asm/ppc-pci.h>
 -#include <asm/machdep.h>
  
+ #include "pseries.h"
+ 
  static int query_token, change_token;
  
  #define RTAS_QUERY_FN		0
@@@ -524,10 -520,15 +528,22 @@@ static int rtas_msi_init(void
  
  	pr_debug("rtas_msi: Registering RTAS MSI callbacks.\n");
  
++<<<<<<< HEAD
 +	WARN_ON(ppc_md.setup_msi_irqs);
 +	ppc_md.setup_msi_irqs = rtas_setup_msi_irqs;
 +	ppc_md.teardown_msi_irqs = rtas_teardown_msi_irqs;
 +	ppc_md.msi_check_device = rtas_msi_check_device;
++=======
+ 	WARN_ON(pseries_pci_controller_ops.setup_msi_irqs);
+ 	pseries_pci_controller_ops.setup_msi_irqs = rtas_setup_msi_irqs;
+ 	pseries_pci_controller_ops.teardown_msi_irqs = rtas_teardown_msi_irqs;
+ 
+ 	list_for_each_entry(phb, &hose_list, list_node) {
+ 		WARN_ON(phb->controller_ops.setup_msi_irqs);
+ 		phb->controller_ops.setup_msi_irqs = rtas_setup_msi_irqs;
+ 		phb->controller_ops.teardown_msi_irqs = rtas_teardown_msi_irqs;
+ 	}
++>>>>>>> 1d14b8755f0a (powerpc/pseries: Move MSI-related ops to pci_controller_ops)
  
  	WARN_ON(ppc_md.pci_irq_fixup);
  	ppc_md.pci_irq_fixup = rtas_msi_pci_irq_fixup;
* Unmerged path arch/powerpc/platforms/pseries/msi.c
