mmc: queue: Improve error handling during allocation of bounce buffers

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
Rebuild_CHGLOG: - [mmc] queue: Improve error handling during allocation of bounce buffers (Don Zickus) [1127975 1277866 1280133 1286932 1297039]
Rebuild_FUZZ: 96.30%
commit-author Bhuvanesh Surachari <bhuvanesh_surachari@mentor.com>
commit fdb409f636cd6fc3ac4e2f9c880402860e738554
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/fdb409f6.failed

Allocation of previous bounce buffer in mmc_init_queue when the current
bounce buffer allocation fails was leading to a crash later in
__blk_segment_map_sg. Error handling is improved by allocating previous
bounce buffer only if the current bounce buffer allocation succeeds.

	Signed-off-by: Bhuvanesh Surachari <bhuvanesh_surachari@mentor.com>
	Signed-off-by: Harish Jenny K N <harish_kandiga@mentor.com>
	Signed-off-by: Ulf Hansson <ulf.hansson@linaro.org>
(cherry picked from commit fdb409f636cd6fc3ac4e2f9c880402860e738554)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/mmc/card/queue.c
diff --cc drivers/mmc/card/queue.c
index 984643ad216d,236d194c2883..000000000000
--- a/drivers/mmc/card/queue.c
+++ b/drivers/mmc/card/queue.c
@@@ -229,17 -230,17 +229,29 @@@ int mmc_init_queue(struct mmc_queue *mq
  		if (bouncesz > 512) {
  			mqrq_cur->bounce_buf = kmalloc(bouncesz, GFP_KERNEL);
  			if (!mqrq_cur->bounce_buf) {
 -				pr_warn("%s: unable to allocate bounce cur buffer\n",
 +				pr_warning("%s: unable to "
 +					"allocate bounce cur buffer\n",
  					mmc_card_name(card));
++<<<<<<< HEAD
 +			}
 +			mqrq_prev->bounce_buf = kmalloc(bouncesz, GFP_KERNEL);
 +			if (!mqrq_prev->bounce_buf) {
 +				pr_warning("%s: unable to "
 +					"allocate bounce prev buffer\n",
 +					mmc_card_name(card));
 +				kfree(mqrq_cur->bounce_buf);
 +				mqrq_cur->bounce_buf = NULL;
++=======
+ 			} else {
+ 				mqrq_prev->bounce_buf =
+ 						kmalloc(bouncesz, GFP_KERNEL);
+ 				if (!mqrq_prev->bounce_buf) {
+ 					pr_warn("%s: unable to allocate bounce prev buffer\n",
+ 						mmc_card_name(card));
+ 					kfree(mqrq_cur->bounce_buf);
+ 					mqrq_cur->bounce_buf = NULL;
+ 				}
++>>>>>>> fdb409f636cd (mmc: queue: Improve error handling during allocation of bounce buffers)
  			}
  		}
  
* Unmerged path drivers/mmc/card/queue.c
