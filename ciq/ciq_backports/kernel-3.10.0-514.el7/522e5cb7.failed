iommu/amd: Fix unity mapping initialization race

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
Rebuild_CHGLOG: - [iommu] amd: Fix unity mapping initialization race (Myron Stowe) [1340546]
Rebuild_FUZZ: 93.33%
commit-author Joerg Roedel <jroedel@suse.de>
commit 522e5cb76d0663c88f96b6a8301451c8efa37207
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/522e5cb7.failed

There is a race condition in the AMD IOMMU init code that
causes requested unity mappings to be blocked by the IOMMU
for a short period of time. This results on boot failures
and IO_PAGE_FAULTs on some machines.

Fix this by making sure the unity mappings are installed
before all other DMA is blocked.

Fixes: aafd8ba0ca74 ('iommu/amd: Implement add_device and remove_device')
	Cc: stable@vger.kernel.org # v4.2+
	Signed-off-by: Joerg Roedel <jroedel@suse.de>
(cherry picked from commit 522e5cb76d0663c88f96b6a8301451c8efa37207)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/iommu/amd_iommu_init.c
diff --cc drivers/iommu/amd_iommu_init.c
index 8d6a15e2890d,59741ead7e15..000000000000
--- a/drivers/iommu/amd_iommu_init.c
+++ b/drivers/iommu/amd_iommu_init.c
@@@ -1345,9 -1568,25 +1345,31 @@@ static int __init amd_iommu_init_pci(vo
  			break;
  	}
  
++<<<<<<< HEAD
 +	ret = amd_iommu_init_devices();
 +
 +	print_iommu_info();
++=======
+ 	/*
+ 	 * Order is important here to make sure any unity map requirements are
+ 	 * fulfilled. The unity mappings are created and written to the device
+ 	 * table during the amd_iommu_init_api() call.
+ 	 *
+ 	 * After that we call init_device_table_dma() to make sure any
+ 	 * uninitialized DTE will block DMA, and in the end we flush the caches
+ 	 * of all IOMMUs to make sure the changes to the device table are
+ 	 * active.
+ 	 */
+ 	ret = amd_iommu_init_api();
+ 
+ 	init_device_table_dma();
+ 
+ 	for_each_iommu(iommu)
+ 		iommu_flush_all_caches(iommu);
+ 
+ 	if (!ret)
+ 		print_iommu_info();
++>>>>>>> 522e5cb76d06 (iommu/amd: Fix unity mapping initialization race)
  
  	return ret;
  }
* Unmerged path drivers/iommu/amd_iommu_init.c
