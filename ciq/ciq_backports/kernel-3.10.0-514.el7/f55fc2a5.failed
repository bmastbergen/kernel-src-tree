perf: Restructure perf syscall point of no return

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Peter Zijlstra <peterz@infradead.org>
commit f55fc2a57cc9ca3b1bb4fb8eb25b6e1989e5b993
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/f55fc2a5.failed

The exclusive_event_installable() stuff only works because its
exclusive with the grouping bits.

Rework the code such that there is a sane place to error out before we
go do things we cannot undo.

	Signed-off-by: Peter Zijlstra (Intel) <peterz@infradead.org>
	Cc: Alexander Shishkin <alexander.shishkin@linux.intel.com>
	Cc: Linus Torvalds <torvalds@linux-foundation.org>
	Cc: Peter Zijlstra <peterz@infradead.org>
	Cc: Thomas Gleixner <tglx@linutronix.de>
	Cc: linux-kernel@vger.kernel.org
	Signed-off-by: Ingo Molnar <mingo@kernel.org>
(cherry picked from commit f55fc2a57cc9ca3b1bb4fb8eb25b6e1989e5b993)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	kernel/events/core.c
diff --cc kernel/events/core.c
index 49fc1e59eeb3,39679f749500..000000000000
--- a/kernel/events/core.c
+++ b/kernel/events/core.c
@@@ -7819,8 -8360,15 +7830,18 @@@ SYSCALL_DEFINE5(perf_event_open
  		perf_event__state_init(group_leader);
  		perf_install_in_context(ctx, group_leader, group_leader->cpu);
  		get_ctx(ctx);
+ 
++<<<<<<< HEAD
++=======
+ 		/*
+ 		 * Now that all events are installed in @ctx, nothing
+ 		 * references @gctx anymore, so drop the last reference we have
+ 		 * on it.
+ 		 */
+ 		put_ctx(gctx);
  	}
  
++>>>>>>> f55fc2a57cc9 (perf: Restructure perf syscall point of no return)
  	perf_install_in_context(ctx, event, event->cpu);
  	perf_unpin_context(ctx);
  
* Unmerged path kernel/events/core.c
