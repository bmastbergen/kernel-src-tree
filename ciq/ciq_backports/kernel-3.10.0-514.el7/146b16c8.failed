mpt3sas: Refcount fw_events and fix unsafe list usage

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author Sreekanth Reddy <sreekanth.reddy@avagotech.com>
commit 146b16c8071f5f6c67895d15beeee1163f5107c4
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/146b16c8.failed

The fw_event_work struct is concurrently referenced at shutdown. Add a
refcount to protect it and refactor the code to use it.

Additionally, refactor _scsih_fw_event_cleanup_queue() such that it no
longer iterates over the list without holding the lock since
_firmware_event_work() concurrently deletes items from the list.

This patch is ported from commit 008549f6e8a1 ("mpt2sas: Refcount
fw_events and fix unsafe list usage"). These changes are also required
for mpt3sas.

	Signed-off-by: Sreekanth Reddy <Sreekanth.Reddy@avagotech.com>
	Acked-by: Christoph Hellwig <hch@lst.de>
	Reviewed-by: Hannes Reinecke <hare@suse.de>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit 146b16c8071f5f6c67895d15beeee1163f5107c4)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/mpt3sas/mpt3sas_scsih.c
diff --cc drivers/scsi/mpt3sas/mpt3sas_scsih.c
index dab4affe7dc9,436e65e513ae..000000000000
--- a/drivers/scsi/mpt3sas/mpt3sas_scsih.c
+++ b/drivers/scsi/mpt3sas/mpt3sas_scsih.c
@@@ -194,8 -204,32 +195,37 @@@ struct fw_event_work 
  	char			event_data[0] __aligned(4);
  };
  
++<<<<<<< HEAD
 +/* raid transport support */
 +static struct raid_template *mpt3sas_raid_template;
++=======
+ static void fw_event_work_free(struct kref *r)
+ {
+ 	kfree(container_of(r, struct fw_event_work, refcount));
+ }
+ 
+ static void fw_event_work_get(struct fw_event_work *fw_work)
+ {
+ 	kref_get(&fw_work->refcount);
+ }
+ 
+ static void fw_event_work_put(struct fw_event_work *fw_work)
+ {
+ 	kref_put(&fw_work->refcount, fw_event_work_free);
+ }
+ 
+ static struct fw_event_work *alloc_fw_event_work(int len)
+ {
+ 	struct fw_event_work *fw_event;
+ 
+ 	fw_event = kzalloc(sizeof(*fw_event) + len, GFP_ATOMIC);
+ 	if (!fw_event)
+ 		return NULL;
+ 
+ 	kref_init(&fw_event->refcount);
+ 	return fw_event;
+ }
++>>>>>>> 146b16c8071f (mpt3sas: Refcount fw_events and fix unsafe list usage)
  
  /**
   * struct _scsi_io_transfer - scsi io transfer
* Unmerged path drivers/scsi/mpt3sas/mpt3sas_scsih.c
