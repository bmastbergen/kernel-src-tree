r8152: check linking status with netif_carrier_ok

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-514.el7
commit-author hayeswang <hayeswang@realtek.com>
commit 51d979faa274d2a924907bdf59f88a216dcc19a9
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-514.el7/51d979fa.failed

Replace (tp->speed & LINK_STATUS) with netif_carrier_ok().

	Signed-off-by: Hayes Wang <hayeswang@realtek.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 51d979faa274d2a924907bdf59f88a216dcc19a9)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/usb/r8152.c
diff --cc drivers/net/usb/r8152.c
index da37808a0e60,66678093db10..000000000000
--- a/drivers/net/usb/r8152.c
+++ b/drivers/net/usb/r8152.c
@@@ -2811,16 -2921,16 +2810,15 @@@ static void set_carrier(struct r8152 *t
  			tp->rtl_ops.enable(tp);
  			set_bit(RTL8152_SET_RX_MODE, &tp->flags);
  			netif_carrier_on(netdev);
 -			rtl_start_rx(tp);
  		}
  	} else {
- 		if (tp->speed & LINK_STATUS) {
+ 		if (netif_carrier_ok(netdev)) {
  			netif_carrier_off(netdev);
 -			napi_disable(&tp->napi);
 +			tasklet_disable(&tp->tl);
  			tp->rtl_ops.disable(tp);
 -			napi_enable(&tp->napi);
 +			tasklet_enable(&tp->tl);
  		}
  	}
- 	tp->speed = speed;
  }
  
  static void rtl_work_func_t(struct work_struct *work)
@@@ -2842,10 -2960,11 +2840,18 @@@
  	if (test_bit(RTL8152_SET_RX_MODE, &tp->flags))
  		_rtl8152_set_rx_mode(tp->netdev);
  
++<<<<<<< HEAD
 +	if (test_bit(SCHEDULE_TASKLET, &tp->flags) &&
 +	    (tp->speed & LINK_STATUS)) {
 +		clear_bit(SCHEDULE_TASKLET, &tp->flags);
 +		tasklet_schedule(&tp->tl);
++=======
+ 	/* don't schedule napi before linking */
+ 	if (test_bit(SCHEDULE_NAPI, &tp->flags) &&
+ 	    netif_carrier_ok(tp->netdev)) {
+ 		clear_bit(SCHEDULE_NAPI, &tp->flags);
+ 		napi_schedule(&tp->napi);
++>>>>>>> 51d979faa274 (r8152: check linking status with netif_carrier_ok)
  	}
  
  	if (test_bit(PHY_RESET, &tp->flags))
@@@ -3179,18 -3335,18 +3183,29 @@@ static int rtl8152_resume(struct usb_in
  		if (test_bit(SELECTIVE_SUSPEND, &tp->flags)) {
  			rtl_runtime_suspend_enable(tp, false);
  			clear_bit(SELECTIVE_SUSPEND, &tp->flags);
++<<<<<<< HEAD
 +			if (tp->speed & LINK_STATUS)
 +				tp->rtl_ops.disable(tp);
++=======
+ 			set_bit(WORK_ENABLE, &tp->flags);
+ 			if (netif_carrier_ok(tp->netdev))
+ 				rtl_start_rx(tp);
++>>>>>>> 51d979faa274 (r8152: check linking status with netif_carrier_ok)
  		} else {
  			tp->rtl_ops.up(tp);
  			rtl8152_set_speed(tp, AUTONEG_ENABLE,
  					  tp->mii.supports_gmii ?
  					  SPEED_1000 : SPEED_100,
  					  DUPLEX_FULL);
++<<<<<<< HEAD
++=======
+ 			netif_carrier_off(tp->netdev);
+ 			set_bit(WORK_ENABLE, &tp->flags);
++>>>>>>> 51d979faa274 (r8152: check linking status with netif_carrier_ok)
  		}
 +		tp->speed = 0;
 +		netif_carrier_off(tp->netdev);
 +		set_bit(WORK_ENABLE, &tp->flags);
  		usb_submit_urb(tp->intr_urb, GFP_KERNEL);
  	} else if (test_bit(SELECTIVE_SUSPEND, &tp->flags)) {
  		clear_bit(SELECTIVE_SUSPEND, &tp->flags);
* Unmerged path drivers/net/usb/r8152.c
