powerpc/perf: Fix MMCR2 handling for EBB

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-229.el7
Rebuild_CHGLOG: - [powerpc] perf: Fix MMCR2 handling for EBB (Don Zickus) [1127366]
Rebuild_FUZZ: 88.89%
commit-author Michael Ellerman <mpe@ellerman.id.au>
commit 8903461c9bc56fcb041fb92d054e2529951770b6
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-229.el7/8903461c.failed

In the recent commit b50a6c584bb4 "Clear MMCR2 when enabling PMU", I
screwed up the handling of MMCR2 for tasks using EBB.

We must make sure we set MMCR2 *before* ebb_switch_in(), otherwise we
overwrite the value of MMCR2 that userspace may have written. That
potentially breaks a task that uses EBB and manually uses MMCR2 for
event freezing.

Fixes: b50a6c584bb4 ("powerpc/perf: Clear MMCR2 when enabling PMU")
	Cc: stable@vger.kernel.org
	Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
	Signed-off-by: Benjamin Herrenschmidt <benh@kernel.crashing.org>
(cherry picked from commit 8903461c9bc56fcb041fb92d054e2529951770b6)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/powerpc/perf/core-book3s.c
diff --cc arch/powerpc/perf/core-book3s.c
index d376dcb70daa,fe52db2eea6a..000000000000
--- a/arch/powerpc/perf/core-book3s.c
+++ b/arch/powerpc/perf/core-book3s.c
@@@ -1211,6 -1305,11 +1211,14 @@@ static void power_pmu_enable(struct pm
  	cpuhw->mmcr[0] |= MMCR0_PMXE | MMCR0_FCECE;
  
   out_enable:
++<<<<<<< HEAD
++=======
+ 	pmao_restore_workaround(ebb);
+ 
+ 	if (ppmu->flags & PPMU_ARCH_207S)
+ 		mtspr(SPRN_MMCR2, 0);
+ 
++>>>>>>> 8903461c9bc5 (powerpc/perf: Fix MMCR2 handling for EBB)
  	mmcr0 = ebb_switch_in(ebb, cpuhw->mmcr[0]);
  
  	mb();
* Unmerged path arch/powerpc/perf/core-book3s.c
