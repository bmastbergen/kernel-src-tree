ipv6: add sysctl_mld_qrv to configure query robustness variable

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-229.el7
commit-author Hannes Frederic Sowa <hannes@stressinduktion.org>
commit 2f711939d2ea9dfaecebecd1324d2ec7a7a21f65
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-229.el7/2f711939.failed

This patch adds a new sysctl_mld_qrv knob to configure the mldv1/v2 query
robustness variable. It specifies how many retransmit of unsolicited mld
retransmit should happen. Admins might want to tune this on lossy links.

Also reset mld state on interface down/up, so we pick up new sysctl
settings during interface up event.

IPv6 certification requests this knob to be available.

I didn't make this knob netns specific, as it is mostly a setting in a
physical environment and should be per host.

	Cc: Flavio Leitner <fbl@redhat.com>
	Signed-off-by: Hannes Frederic Sowa <hannes@stressinduktion.org>
	Acked-by: Flavio Leitner <fbl@redhat.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 2f711939d2ea9dfaecebecd1324d2ec7a7a21f65)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	Documentation/networking/ip-sysctl.txt
#	net/ipv6/mcast.c
diff --cc Documentation/networking/ip-sysctl.txt
index 1997f9aff3d3,cfc71ac0f764..000000000000
--- a/Documentation/networking/ip-sysctl.txt
+++ b/Documentation/networking/ip-sysctl.txt
@@@ -1063,6 -1128,35 +1063,38 @@@ bindv6only - BOOLEA
  
  	Default: FALSE (as specified in RFC3493)
  
++<<<<<<< HEAD
++=======
+ flowlabel_consistency - BOOLEAN
+ 	Protect the consistency (and unicity) of flow label.
+ 	You have to disable it to use IPV6_FL_F_REFLECT flag on the
+ 	flow label manager.
+ 	TRUE: enabled
+ 	FALSE: disabled
+ 	Default: TRUE
+ 
+ auto_flowlabels - BOOLEAN
+ 	Automatically generate flow labels based based on a flow hash
+ 	of the packet. This allows intermediate devices, such as routers,
+ 	to idenfify packet flows for mechanisms like Equal Cost Multipath
+ 	Routing (see RFC 6438).
+ 	TRUE: enabled
+ 	FALSE: disabled
+ 	Default: false
+ 
+ anycast_src_echo_reply - BOOLEAN
+ 	Controls the use of anycast addresses as source addresses for ICMPv6
+ 	echo reply
+ 	TRUE:  enabled
+ 	FALSE: disabled
+ 	Default: FALSE
+ 
+ mld_qrv - INTEGER
+ 	Controls the MLD query robustness variable (see RFC3810 9.1).
+ 	Default: 2 (as specified by RFC3810 9.1)
+ 	Minimum: 1 (as specified by RFC6636 4.5)
+ 
++>>>>>>> 2f711939d2ea (ipv6: add sysctl_mld_qrv to configure query robustness variable)
  IPv6 Fragmentation:
  
  ip6frag_high_thresh - INTEGER
diff --cc net/ipv6/mcast.c
index e4ba79752788,64919425f1ab..000000000000
--- a/net/ipv6/mcast.c
+++ b/net/ipv6/mcast.c
@@@ -2487,7 -2498,8 +2497,12 @@@ void ipv6_mc_up(struct inet6_dev *idev
  	/* Install multicast list, except for all-nodes (already installed) */
  
  	read_lock_bh(&idev->lock);
++<<<<<<< HEAD
 +	for (i = idev->mc_list; i; i=i->next)
++=======
+ 	ipv6_mc_reset(idev);
+ 	for (i = idev->mc_list; i; i = i->next)
++>>>>>>> 2f711939d2ea (ipv6: add sysctl_mld_qrv to configure query robustness variable)
  		igmp6_group_added(i);
  	read_unlock_bh(&idev->lock);
  }
* Unmerged path Documentation/networking/ip-sysctl.txt
diff --git a/include/net/ipv6.h b/include/net/ipv6.h
index face22bfd545..ff2fc75aed2b 100644
--- a/include/net/ipv6.h
+++ b/include/net/ipv6.h
@@ -116,6 +116,7 @@ struct frag_hdr {
 
 /* sysctls */
 extern int sysctl_mld_max_msf;
+extern int sysctl_mld_qrv;
 
 #define _DEVINC(net, statname, modifier, idev, field)			\
 ({									\
* Unmerged path net/ipv6/mcast.c
diff --git a/net/ipv6/sysctl_net_ipv6.c b/net/ipv6/sysctl_net_ipv6.c
index 107b2f1d90ae..2d528c931397 100644
--- a/net/ipv6/sysctl_net_ipv6.c
+++ b/net/ipv6/sysctl_net_ipv6.c
@@ -16,6 +16,8 @@
 #include <net/addrconf.h>
 #include <net/inet_frag.h>
 
+static int one = 1;
+
 static struct ctl_table ipv6_table_template[] = {
 	{
 		.procname	= "bindv6only",
@@ -35,6 +37,14 @@ static struct ctl_table ipv6_rotable[] = {
 		.mode		= 0644,
 		.proc_handler	= proc_dointvec
 	},
+	{
+		.procname	= "mld_qrv",
+		.data		= &sysctl_mld_qrv,
+		.maxlen		= sizeof(int),
+		.mode		= 0644,
+		.proc_handler	= proc_dointvec_minmax,
+		.extra1		= &one
+	},
 	{ }
 };
 
