mtip32xx: move error handling to service thread

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-229.el7
commit-author Asai Thambi S P <asamymuthupa@micron.com>
commit 9b204fbf0987748ec6cc4a3cde0064ecf42accd0
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-229.el7/9b204fbf.failed

Move error handling to service thread, and use mtip_set_timeout()
to set timeouts for HDIO_DRIVE_TASK and HDIO_DRIVE_CMD IOCTL commands.

	Signed-off-by: Selvan Mani <smani@micron.com>
	Signed-off-by: Asai Thambi S P <asamymuthupa@micron.com>
	Signed-off-by: Jens Axboe <axboe@fb.com>
(cherry picked from commit 9b204fbf0987748ec6cc4a3cde0064ecf42accd0)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/block/mtip32xx/mtip32xx.c
diff --cc drivers/block/mtip32xx/mtip32xx.c
index 9912f3d7777e,ae331ab4a451..000000000000
--- a/drivers/block/mtip32xx/mtip32xx.c
+++ b/drivers/block/mtip32xx/mtip32xx.c
@@@ -831,8 -620,6 +831,11 @@@ static void mtip_handle_tfe(struct driv
  
  	port = dd->port;
  
++<<<<<<< HEAD
 +	/* Stop the timer to prevent command timeouts. */
 +	del_timer(&port->cmd_timer);
++=======
++>>>>>>> 9b204fbf0987 (mtip32xx: move error handling to service thread)
  	set_bit(MTIP_PF_EH_ACTIVE_BIT, &port->flags);
  
  	if (test_bit(MTIP_PF_IC_ACTIVE_BIT, &port->flags) &&
@@@ -1363,10 -1119,11 +1373,11 @@@ static int mtip_exec_internal_command(s
  	if (atomic == GFP_KERNEL) {
  		if (fis->command != ATA_CMD_STANDBYNOW1) {
  			/* wait for io to complete if non atomic */
- 			if (mtip_quiesce_io(port, 5000) < 0) {
+ 			if (mtip_quiesce_io(port,
+ 					MTIP_QUIESCE_IO_TIMEOUT_MS) < 0) {
  				dev_warn(&dd->pdev->dev,
  					"Failed to quiesce IO\n");
 -				mtip_put_int_command(dd, int_cmd);
 +				release_slot(port, MTIP_TAG_INTERNAL);
  				clear_bit(MTIP_PF_IC_ACTIVE_BIT, &port->flags);
  				wake_up_interruptible(&port->svc_wait);
  				return -EBUSY;
* Unmerged path drivers/block/mtip32xx/mtip32xx.c
diff --git a/drivers/block/mtip32xx/mtip32xx.h b/drivers/block/mtip32xx/mtip32xx.h
index 54174cb32feb..b29511dce036 100644
--- a/drivers/block/mtip32xx/mtip32xx.h
+++ b/drivers/block/mtip32xx/mtip32xx.h
@@ -40,9 +40,11 @@
 #define MTIP_MAX_RETRIES	2
 
 /* Various timeout values in ms */
-#define MTIP_NCQ_COMMAND_TIMEOUT_MS       5000
-#define MTIP_IOCTL_COMMAND_TIMEOUT_MS     5000
-#define MTIP_INTERNAL_COMMAND_TIMEOUT_MS  5000
+#define MTIP_NCQ_CMD_TIMEOUT_MS      15000
+#define MTIP_IOCTL_CMD_TIMEOUT_MS    5000
+#define MTIP_INT_CMD_TIMEOUT_MS      5000
+#define MTIP_QUIESCE_IO_TIMEOUT_MS   (MTIP_NCQ_CMD_TIMEOUT_MS * \
+				     (MTIP_MAX_RETRIES + 1))
 
 /* check for timeouts every 500ms */
 #define MTIP_TIMEOUT_CHECK_PERIOD	500
