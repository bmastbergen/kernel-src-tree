dm cache: emit a warning message if there are a lot of cache blocks

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-229.el7
Rebuild_CHGLOG: - [md] dm-cache: emit a warning message if there are a lot of cache blocks (Mike Snitzer) [1159001]
Rebuild_FUZZ: 98.51%
commit-author Joe Thornber <ejt@redhat.com>
commit d1d9220cbaeecce910f3ecfeb71cc897a678eb68
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-229.el7/d1d9220c.failed

Loading and saving millions of block mappings takes time.  We may as
well explain what's going on, and encourage people to use a larger
cache block size.

	Signed-off-by: Joe Thornber <ejt@redhat.com>
	Signed-off-by: Mike Snitzer <snitzer@redhat.com>
(cherry picked from commit d1d9220cbaeecce910f3ecfeb71cc897a678eb68)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/md/dm-cache-target.c
diff --cc drivers/md/dm-cache-target.c
index e75d70ec363a,abdd45d07bf6..000000000000
--- a/drivers/md/dm-cache-target.c
+++ b/drivers/md/dm-cache-target.c
@@@ -2174,6 -2272,48 +2174,51 @@@ static int create_cache_policy(struct c
  	return 0;
  }
  
++<<<<<<< HEAD
++=======
+ /*
+  * We want the discard block size to be a power of two, at least the size
+  * of the cache block size, and have no more than 2^14 discard blocks
+  * across the origin.
+  */
+ #define MAX_DISCARD_BLOCKS (1 << 14)
+ 
+ static bool too_many_discard_blocks(sector_t discard_block_size,
+ 				    sector_t origin_size)
+ {
+ 	(void) sector_div(origin_size, discard_block_size);
+ 
+ 	return origin_size > MAX_DISCARD_BLOCKS;
+ }
+ 
+ static sector_t calculate_discard_block_size(sector_t cache_block_size,
+ 					     sector_t origin_size)
+ {
+ 	sector_t discard_block_size;
+ 
+ 	discard_block_size = roundup_pow_of_two(cache_block_size);
+ 
+ 	if (origin_size)
+ 		while (too_many_discard_blocks(discard_block_size, origin_size))
+ 			discard_block_size *= 2;
+ 
+ 	return discard_block_size;
+ }
+ 
+ static void set_cache_size(struct cache *cache, dm_cblock_t size)
+ {
+ 	dm_block_t nr_blocks = from_cblock(size);
+ 
+ 	if (nr_blocks > (1 << 20) && cache->cache_size != size)
+ 		DMWARN_LIMIT("You have created a cache device with a lot of individual cache blocks (%llu)\n"
+ 			     "All these mappings can consume a lot of kernel memory, and take some time to read/write.\n"
+ 			     "Please consider increasing the cache block size to reduce the overall cache block count.",
+ 			     (unsigned long long) nr_blocks);
+ 
+ 	cache->cache_size = size;
+ }
+ 
++>>>>>>> d1d9220cbaee (dm cache: emit a warning message if there are a lot of cache blocks)
  #define DEFAULT_MIGRATION_THRESHOLD 2048
  
  static int cache_create(struct cache_args *ca, struct cache **result)
* Unmerged path drivers/md/dm-cache-target.c
