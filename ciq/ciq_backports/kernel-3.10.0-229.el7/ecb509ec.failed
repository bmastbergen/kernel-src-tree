iommu/vt-d: Remove pdev from iommu_no_mapping()

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-229.el7
Rebuild_CHGLOG: - [iommu] vt-d: Remove pdev from iommu_no_mapping() (Myron Stowe) [1129880 1087643]
Rebuild_FUZZ: 93.18%
commit-author David Woodhouse <David.Woodhouse@intel.com>
commit ecb509ec2bacfe341530e56abf6bf3f20548bcd6
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-229.el7/ecb509ec.failed

	Signed-off-by: David Woodhouse <David.Woodhouse@intel.com>
(cherry picked from commit ecb509ec2bacfe341530e56abf6bf3f20548bcd6)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/iommu/intel-iommu.c
diff --cc drivers/iommu/intel-iommu.c
index bd20ea6166e6,0f5e6c911e85..000000000000
--- a/drivers/iommu/intel-iommu.c
+++ b/drivers/iommu/intel-iommu.c
@@@ -2809,19 -2916,18 +2808,22 @@@ static int iommu_no_mapping(struct devi
  	if (!iommu_identity_mapping)
  		return 0;
  
- 	pdev = to_pci_dev(dev);
  	found = identity_mapping(dev);
  	if (found) {
++<<<<<<< HEAD
 +		if (iommu_should_identity_map(pdev, 0))
++=======
+ 		if (iommu_should_identity_map(dev, 0))
++>>>>>>> ecb509ec2bac (iommu/vt-d: Remove pdev from iommu_no_mapping())
  			return 1;
  		else {
  			/*
  			 * 32 bit DMA is removed from si_domain and fall back
  			 * to non-identity mapping.
  			 */
 -			domain_remove_one_dev_info(si_domain, dev);
 +			domain_remove_one_dev_info(si_domain, pdev);
  			printk(KERN_INFO "32bit %s uses non-identity mapping\n",
- 			       pci_name(pdev));
+ 			       dev_name(dev));
  			return 0;
  		}
  	} else {
@@@ -2829,9 -2935,9 +2831,13 @@@
  		 * In case of a detached 64 bit DMA device from vm, the device
  		 * is put into si_domain for identity mapping.
  		 */
++<<<<<<< HEAD
 +		if (iommu_should_identity_map(pdev, 0)) {
++=======
+ 		if (iommu_should_identity_map(dev, 0)) {
++>>>>>>> ecb509ec2bac (iommu/vt-d: Remove pdev from iommu_no_mapping())
  			int ret;
 -			ret = domain_add_dev_info(si_domain, dev,
 +			ret = domain_add_dev_info(si_domain, pdev,
  						  hw_pass_through ?
  						  CONTEXT_TT_PASS_THROUGH :
  						  CONTEXT_TT_MULTI_LEVEL);
* Unmerged path drivers/iommu/intel-iommu.c
