drm/i915: Kick fbdev before vgacon

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-229.el7
Rebuild_CHGLOG: - [drm] i915: Kick fbdev before vgacon (Rob Clark) [1173317]
Rebuild_FUZZ: 93.75%
commit-author Daniel Vetter <daniel.vetter@ffwll.ch>
commit 0485c9dc24ec0939b42ca5104c0373297506b555
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-229.el7/0485c9dc.failed

It's magic, but it seems to work.

This fixes a regression introduced in

commit 1bb9e632a0aeee1121e652ee4dc80e5e6f14bcd2
Author: Daniel Vetter <daniel.vetter@ffwll.ch>
Date:   Tue Jul 8 10:02:43 2014 +0200

    drm/i915: Only unbind vgacon, not other console drivers

My best guess is that the vga fbdev driver falls over if we rip out
parts of vgacon. Hooray.

Bugzilla: https://bugs.freedesktop.org/show_bug.cgi?id=82439
	Cc: stable@vger.kernel.org (v3.16+)
Reported-and-tested-by: Lv Zheng <lv.zheng@intel.com>
	Signed-off-by: Daniel Vetter <daniel.vetter@intel.com>
	Acked-by: Chris Wilson <chris@chris-wilson.co.uk>
	Signed-off-by: Jani Nikula <jani.nikula@intel.com>
(cherry picked from commit 0485c9dc24ec0939b42ca5104c0373297506b555)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/gpu/drm/i915/i915_dma.c
diff --cc drivers/gpu/drm/i915/i915_dma.c
index 661cf9b87340,318ade9bb5af..000000000000
--- a/drivers/gpu/drm/i915/i915_dma.c
+++ b/drivers/gpu/drm/i915/i915_dma.c
@@@ -1551,10 -1667,23 +1551,28 @@@ int i915_driver_load(struct drm_device 
  
  	ret = i915_gem_gtt_init(dev);
  	if (ret)
 -		goto out_regs;
 +		goto put_bridge;
  
++<<<<<<< HEAD
 +	if (drm_core_check_feature(dev, DRIVER_MODESET))
 +		i915_kick_out_firmware_fb(dev_priv);
++=======
+ 	if (drm_core_check_feature(dev, DRIVER_MODESET)) {
+ 		/* WARNING: Apparently we must kick fbdev drivers before vgacon,
+ 		 * otherwise the vga fbdev driver falls over. */
+ 		ret = i915_kick_out_firmware_fb(dev_priv);
+ 		if (ret) {
+ 			DRM_ERROR("failed to remove conflicting framebuffer drivers\n");
+ 			goto out_gtt;
+ 		}
+ 
+ 		ret = i915_kick_out_vgacon(dev_priv);
+ 		if (ret) {
+ 			DRM_ERROR("failed to remove conflicting VGA console\n");
+ 			goto out_gtt;
+ 		}
+ 	}
++>>>>>>> 0485c9dc24ec (drm/i915: Kick fbdev before vgacon)
  
  	pci_set_master(dev->pdev);
  
* Unmerged path drivers/gpu/drm/i915/i915_dma.c
