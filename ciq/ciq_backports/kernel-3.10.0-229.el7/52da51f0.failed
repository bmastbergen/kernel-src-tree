drm/radeon: fix active_cu mask on SI and CIK after re-init (v3)

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-229.el7
Rebuild_CHGLOG: - [drm] radeon: fix active_cu mask on SI and CIK after re-init (v3) (Rob Clark) [1173317]
Rebuild_FUZZ: 96.72%
commit-author Alex Deucher <alexander.deucher@amd.com>
commit 52da51f0f9ea9d213adfc99223630707b26d1d38
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-229.el7/52da51f0.failed

Need to initialize the mask to 0 on init, otherwise it
keeps increasing.

bug:
https://bugzilla.kernel.org/show_bug.cgi?id=82581

v2: also fix cu count
v3: split count fix into separate patch

	Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
	Reviewed-by: Michel DÃ¤nzer <michel.daenzer@amd.com>
	Cc: stable@vger.kernel.org
(cherry picked from commit 52da51f0f9ea9d213adfc99223630707b26d1d38)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/gpu/drm/radeon/cik.c
#	drivers/gpu/drm/radeon/si.c
diff --cc drivers/gpu/drm/radeon/cik.c
index 90bff4975b2c,f4e14702639d..000000000000
--- a/drivers/gpu/drm/radeon/cik.c
+++ b/drivers/gpu/drm/radeon/cik.c
@@@ -2873,6 -3672,14 +2873,17 @@@ static void cik_gpu_init(struct radeon_
  		     rdev->config.cik.max_sh_per_se,
  		     rdev->config.cik.max_backends_per_se);
  
++<<<<<<< HEAD
++=======
+ 	rdev->config.cik.active_cus = 0;
+ 	for (i = 0; i < rdev->config.cik.max_shader_engines; i++) {
+ 		for (j = 0; j < rdev->config.cik.max_sh_per_se; j++) {
+ 			rdev->config.cik.active_cus +=
+ 				hweight32(cik_get_cu_active_bitmap(rdev, i, j));
+ 		}
+ 	}
+ 
++>>>>>>> 52da51f0f9ea (drm/radeon: fix active_cu mask on SI and CIK after re-init (v3))
  	/* set HW defaults for 3D engine */
  	WREG32(CP_MEQ_THRESHOLDS, MEQ1_START(0x30) | MEQ2_START(0x60));
  
diff --cc drivers/gpu/drm/radeon/si.c
index 4cbbc5b3fe11,a1274a31405c..000000000000
--- a/drivers/gpu/drm/radeon/si.c
+++ b/drivers/gpu/drm/radeon/si.c
@@@ -3090,6 -3255,13 +3090,16 @@@ static void si_gpu_init(struct radeon_d
  		     rdev->config.si.max_sh_per_se,
  		     rdev->config.si.max_cu_per_sh);
  
++<<<<<<< HEAD
++=======
+ 	rdev->config.si.active_cus = 0;
+ 	for (i = 0; i < rdev->config.si.max_shader_engines; i++) {
+ 		for (j = 0; j < rdev->config.si.max_sh_per_se; j++) {
+ 			rdev->config.si.active_cus +=
+ 				hweight32(si_get_cu_active_bitmap(rdev, i, j));
+ 		}
+ 	}
++>>>>>>> 52da51f0f9ea (drm/radeon: fix active_cu mask on SI and CIK after re-init (v3))
  
  	/* set HW defaults for 3D engine */
  	WREG32(CP_QUEUE_THRESHOLDS, (ROQ_IB1_START(0x16) |
* Unmerged path drivers/gpu/drm/radeon/cik.c
* Unmerged path drivers/gpu/drm/radeon/si.c
