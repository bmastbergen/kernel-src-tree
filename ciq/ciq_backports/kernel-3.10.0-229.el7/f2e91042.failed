KVM: PPC: Add CAP to indicate hcall fixes

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-229.el7
Rebuild_CHGLOG: - [virt] kvm/ppc: Add CAP to indicate hcall fixes (David Gibson) [1123145 1123133 1123367]
Rebuild_FUZZ: 96.30%
commit-author Alexander Graf <agraf@suse.de>
commit f2e91042a807cbf9b0b0d9776bf37d1ef0bd7ebe
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-229.el7/f2e91042.failed

We worked around some nasty KVM magic page hcall breakages:

  1) NX bit not honored, so ignore NX when we detect it
  2) LE guests swizzle hypercall instruction

Without these fixes in place, there's no way it would make sense to expose kvm
hypercalls to a guest. Chances are immensely high it would trip over and break.

So add a new CAP that gives user space a hint that we have workarounds for the
bugs above in place. It can use those as hint to disable PV hypercalls when
the guest CPU is anything POWER7 or higher and the host does not have fixes
in place.

	Signed-off-by: Alexander Graf <agraf@suse.de>
(cherry picked from commit f2e91042a807cbf9b0b0d9776bf37d1ef0bd7ebe)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	include/uapi/linux/kvm.h
diff --cc include/uapi/linux/kvm.h
index 1ba9af99e2bc,16c923de85e7..000000000000
--- a/include/uapi/linux/kvm.h
+++ b/include/uapi/linux/kvm.h
@@@ -667,8 -739,16 +667,16 @@@ struct kvm_ppc_smmu_info 
  #define KVM_CAP_IRQ_MPIC 90
  #define KVM_CAP_PPC_RTAS 91
  #define KVM_CAP_IRQ_XICS 92
 -#define KVM_CAP_ARM_EL1_32BIT 93
 -#define KVM_CAP_SPAPR_MULTITCE 94
 -#define KVM_CAP_EXT_EMUL_CPUID 95
  #define KVM_CAP_HYPERV_TIME 96
  #define KVM_CAP_IOAPIC_POLARITY_IGNORED 97
++<<<<<<< HEAD
++=======
+ #define KVM_CAP_ENABLE_CAP_VM 98
+ #define KVM_CAP_S390_IRQCHIP 99
+ #define KVM_CAP_IOEVENTFD_NO_LENGTH 100
+ #define KVM_CAP_VM_ATTRIBUTES 101
+ #define KVM_CAP_PPC_FIXUP_HCALL 102
++>>>>>>> f2e91042a807 (KVM: PPC: Add CAP to indicate hcall fixes)
  
  #ifdef KVM_CAP_IRQ_ROUTING
  
diff --git a/arch/powerpc/kvm/powerpc.c b/arch/powerpc/kvm/powerpc.c
index 126467ebd44f..0a5d6d968e7e 100644
--- a/arch/powerpc/kvm/powerpc.c
+++ b/arch/powerpc/kvm/powerpc.c
@@ -340,6 +340,7 @@ int kvm_dev_ioctl_check_extension(long ext)
 	case KVM_CAP_SPAPR_TCE:
 	case KVM_CAP_PPC_ALLOC_HTAB:
 	case KVM_CAP_PPC_RTAS:
+	case KVM_CAP_PPC_FIXUP_HCALL:
 #ifdef CONFIG_KVM_XICS
 	case KVM_CAP_IRQ_XICS:
 #endif
* Unmerged path include/uapi/linux/kvm.h
