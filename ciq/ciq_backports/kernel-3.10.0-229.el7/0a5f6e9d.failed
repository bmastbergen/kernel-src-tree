drm/radeon: handle broken disabled rb mask gracefully (6xx/7xx) (v2)

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-229.el7
Rebuild_CHGLOG: - [drm] radeon: handle broken disabled rb mask gracefully (6xx/7xx) (Rob Clark) [1173317]
Rebuild_FUZZ: 92.91%
commit-author Alex Deucher <alexander.deucher@amd.com>
commit 0a5f6e9d60e71e4b6dbeabd97bc887d6b2b0f0c8
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-229.el7/0a5f6e9d.failed

This is a port of cedb655a3a7764c3fd946077944383c9e0e68dd4
to older asics.  Fixes a possible divide by 0 if the harvest
register is invalid.

v2: drop some additional harvest munging.

	Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
	Cc: stable@vger.kernel.org
(cherry picked from commit 0a5f6e9d60e71e4b6dbeabd97bc887d6b2b0f0c8)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/gpu/drm/radeon/r600.c
#	drivers/gpu/drm/radeon/rv770.c
diff --cc drivers/gpu/drm/radeon/r600.c
index ef9bb3b606d7,e616eb5f6e7a..000000000000
--- a/drivers/gpu/drm/radeon/r600.c
+++ b/drivers/gpu/drm/radeon/r600.c
@@@ -1820,26 -1938,20 +1819,33 @@@ static void r600_gpu_init(struct radeon
  	}
  	tiling_config |= BANK_SWAPS(1);
  
- 	cc_rb_backend_disable = RREG32(CC_RB_BACKEND_DISABLE) & 0x00ff0000;
- 	tmp = R6XX_MAX_BACKENDS -
- 		r600_count_pipe_bits((cc_rb_backend_disable >> 16) & R6XX_MAX_BACKENDS_MASK);
- 	if (tmp < rdev->config.r600.max_backends) {
- 		rdev->config.r600.max_backends = tmp;
- 	}
- 
  	cc_gc_shader_pipe_config = RREG32(CC_GC_SHADER_PIPE_CONFIG) & 0x00ffff00;
++<<<<<<< HEAD
 +	tmp = R6XX_MAX_PIPES -
 +		r600_count_pipe_bits((cc_gc_shader_pipe_config >> 8) & R6XX_MAX_PIPES_MASK);
 +	if (tmp < rdev->config.r600.max_pipes) {
 +		rdev->config.r600.max_pipes = tmp;
 +	}
 +	tmp = R6XX_MAX_SIMDS -
 +		r600_count_pipe_bits((cc_gc_shader_pipe_config >> 16) & R6XX_MAX_SIMDS_MASK);
 +	if (tmp < rdev->config.r600.max_simds) {
 +		rdev->config.r600.max_simds = tmp;
 +	}
++=======
+ 	tmp = rdev->config.r600.max_simds -
+ 		r600_count_pipe_bits((cc_gc_shader_pipe_config >> 16) & R6XX_MAX_SIMDS_MASK);
+ 	rdev->config.r600.active_simds = tmp;
++>>>>>>> 0a5f6e9d60e7 (drm/radeon: handle broken disabled rb mask gracefully (6xx/7xx) (v2))
  
  	disabled_rb_mask = (RREG32(CC_RB_BACKEND_DISABLE) >> 16) & R6XX_MAX_BACKENDS_MASK;
+ 	tmp = 0;
+ 	for (i = 0; i < rdev->config.r600.max_backends; i++)
+ 		tmp |= (1 << i);
+ 	/* if all the backends are disabled, fix it up here */
+ 	if ((disabled_rb_mask & tmp) == tmp) {
+ 		for (i = 0; i < rdev->config.r600.max_backends; i++)
+ 			disabled_rb_mask &= ~(1 << i);
+ 	}
  	tmp = (tiling_config & PIPE_TILING__MASK) >> PIPE_TILING__SHIFT;
  	tmp = r6xx_remap_render_backend(rdev, tmp, rdev->config.r600.max_backends,
  					R6XX_MAX_BACKENDS, disabled_rb_mask);
diff --cc drivers/gpu/drm/radeon/rv770.c
index 32994da4b4df,d9f5ce715c9b..000000000000
--- a/drivers/gpu/drm/radeon/rv770.c
+++ b/drivers/gpu/drm/radeon/rv770.c
@@@ -1276,21 -1310,10 +1275,21 @@@ static void rv770_gpu_init(struct radeo
  		WREG32(SPI_CONFIG_CNTL, 0);
  	}
  
- 	cc_rb_backend_disable = RREG32(CC_RB_BACKEND_DISABLE) & 0x00ff0000;
- 	tmp = R7XX_MAX_BACKENDS - r600_count_pipe_bits(cc_rb_backend_disable >> 16);
- 	if (tmp < rdev->config.rv770.max_backends) {
- 		rdev->config.rv770.max_backends = tmp;
- 	}
- 
  	cc_gc_shader_pipe_config = RREG32(CC_GC_SHADER_PIPE_CONFIG) & 0xffffff00;
++<<<<<<< HEAD
 +	tmp = R7XX_MAX_PIPES - r600_count_pipe_bits((cc_gc_shader_pipe_config >> 8) & R7XX_MAX_PIPES_MASK);
 +	if (tmp < rdev->config.rv770.max_pipes) {
 +		rdev->config.rv770.max_pipes = tmp;
 +	}
 +	tmp = R7XX_MAX_SIMDS - r600_count_pipe_bits((cc_gc_shader_pipe_config >> 16) & R7XX_MAX_SIMDS_MASK);
 +	if (tmp < rdev->config.rv770.max_simds) {
 +		rdev->config.rv770.max_simds = tmp;
 +	}
++=======
+ 	tmp = rdev->config.rv770.max_simds -
+ 		r600_count_pipe_bits((cc_gc_shader_pipe_config >> 16) & R7XX_MAX_SIMDS_MASK);
+ 	rdev->config.rv770.active_simds = tmp;
++>>>>>>> 0a5f6e9d60e7 (drm/radeon: handle broken disabled rb mask gracefully (6xx/7xx) (v2))
  
  	switch (rdev->config.rv770.max_tile_pipes) {
  	case 1:
* Unmerged path drivers/gpu/drm/radeon/r600.c
* Unmerged path drivers/gpu/drm/radeon/rv770.c
