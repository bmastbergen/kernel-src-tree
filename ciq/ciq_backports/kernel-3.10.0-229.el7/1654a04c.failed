sunrpc: don't wait for write before allowing reads from use-gss-proxy file

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-229.el7
Rebuild_CHGLOG: - [net] sunrpc: don't wait for write before allowing reads from use-gss-proxy file ("J. Bruce Fields") [1117914]
Rebuild_FUZZ: 99.33%
commit-author Jeff Layton <jlayton@redhat.com>
commit 1654a04cd702fd19c297c36300a6ab834cf8c072
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-229.el7/1654a04c.failed

It doesn't make much sense to make reads from this procfile hang. As
far as I can tell, only gssproxy itself will open this file and it
never reads from it. Change it to just give the present setting of
sn->use_gss_proxy without waiting for anything.

Note that we do not want to call use_gss_proxy() in this codepath
since an inopportune read of this file could cause it to be disabled
prematurely.

	Cc: stable@vger.kernel.org
	Signed-off-by: Jeff Layton <jlayton@redhat.com>
	Signed-off-by: J. Bruce Fields <bfields@redhat.com>
(cherry picked from commit 1654a04cd702fd19c297c36300a6ab834cf8c072)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/sunrpc/auth_gss/svcauth_gss.c
diff --cc net/sunrpc/auth_gss/svcauth_gss.c
index 0ce7c262aeb7,1b94a9c8a242..000000000000
--- a/net/sunrpc/auth_gss/svcauth_gss.c
+++ b/net/sunrpc/auth_gss/svcauth_gss.c
@@@ -1354,7 -1329,8 +1329,12 @@@ static ssize_t write_gssp(struct file *
  static ssize_t read_gssp(struct file *file, char __user *buf,
  			 size_t count, loff_t *ppos)
  {
++<<<<<<< HEAD
 +	struct net *net = PDE_DATA(file->f_path.dentry->d_inode);
++=======
+ 	struct net *net = PDE_DATA(file_inode(file));
+ 	struct sunrpc_net *sn = net_generic(net, sunrpc_net_id);
++>>>>>>> 1654a04cd702 (sunrpc: don't wait for write before allowing reads from use-gss-proxy file)
  	unsigned long p = *ppos;
  	char tbuf[10];
  	size_t len;
diff --git a/net/sunrpc/auth_gss/gss_rpc_upcall.c b/net/sunrpc/auth_gss/gss_rpc_upcall.c
index 458f85e9b0ba..abbb7dcd1689 100644
--- a/net/sunrpc/auth_gss/gss_rpc_upcall.c
+++ b/net/sunrpc/auth_gss/gss_rpc_upcall.c
@@ -137,7 +137,6 @@ void init_gssp_clnt(struct sunrpc_net *sn)
 {
 	mutex_init(&sn->gssp_lock);
 	sn->gssp_clnt = NULL;
-	init_waitqueue_head(&sn->gssp_wq);
 }
 
 int set_gssp_clnt(struct net *net)
@@ -154,7 +153,6 @@ int set_gssp_clnt(struct net *net)
 		sn->gssp_clnt = clnt;
 	}
 	mutex_unlock(&sn->gssp_lock);
-	wake_up(&sn->gssp_wq);
 	return ret;
 }
 
* Unmerged path net/sunrpc/auth_gss/svcauth_gss.c
diff --git a/net/sunrpc/netns.h b/net/sunrpc/netns.h
index 94e506f9d72b..df5826876535 100644
--- a/net/sunrpc/netns.h
+++ b/net/sunrpc/netns.h
@@ -27,7 +27,6 @@ struct sunrpc_net {
 	unsigned int rpcb_is_af_local : 1;
 
 	struct mutex gssp_lock;
-	wait_queue_head_t gssp_wq;
 	struct rpc_clnt *gssp_clnt;
 	int use_gss_proxy;
 	int pipe_version;
