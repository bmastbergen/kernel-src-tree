Revert "blk-mq: initialize req->q in allocation"

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-229.el7
Rebuild_CHGLOG: - [block] Revert: blk-mq: initialize req->q in allocation (Mike Snitzer) [1105204]
Rebuild_FUZZ: 96.84%
commit-author Jens Axboe <axboe@fb.com>
commit 70ab0b2d51f84fc7d9eb6ed81c3986595efaa33d
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-229.el7/70ab0b2d.failed

This reverts commit 6a3c8a3ac0e68dcfc2a01f4aa1ca0edd1a1701eb.

We need selective clearing of the request to make the init-at-free
time completely safe. Otherwise we end up stomping on
rq->atomic_flags, which we don't want to do.

(cherry picked from commit 70ab0b2d51f84fc7d9eb6ed81c3986595efaa33d)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	block/blk-mq.c
diff --cc block/blk-mq.c
index 1e5a2766fa8d,7d5650d75aef..000000000000
--- a/block/blk-mq.c
+++ b/block/blk-mq.c
@@@ -81,7 -81,8 +81,12 @@@ static struct request *__blk_mq_alloc_r
  
  	tag = blk_mq_get_tag(hctx->tags, gfp, reserved);
  	if (tag != BLK_MQ_TAG_FAIL) {
++<<<<<<< HEAD
 +		rq = hctx->rqs[tag];
++=======
+ 		rq = hctx->tags->rqs[tag];
+ 		blk_rq_init(hctx->queue, rq);
++>>>>>>> 70ab0b2d51f8 (Revert "blk-mq: initialize req->q in allocation")
  		rq->tag = tag;
  
  		return rq;
@@@ -268,9 -258,7 +273,12 @@@ static void __blk_mq_free_request(struc
  	const int tag = rq->tag;
  	struct request_queue *q = rq->q;
  
++<<<<<<< HEAD
 +	blk_mq_rq_init(hctx, rq);
++=======
++>>>>>>> 70ab0b2d51f8 (Revert "blk-mq: initialize req->q in allocation")
  	blk_mq_put_tag(hctx->tags, tag);
 +
  	blk_mq_queue_exit(q);
  }
  
@@@ -1116,11 -1190,17 +1124,22 @@@ static int blk_mq_init_rq_map(struct bl
  
  		p = page_address(page);
  		entries_per_page = order_to_size(this_order) / rq_size;
 -		to_do = min(entries_per_page, set->queue_depth - i);
 +		to_do = min(entries_per_page, hctx->queue_depth - i);
  		left -= to_do * rq_size;
  		for (j = 0; j < to_do; j++) {
++<<<<<<< HEAD
 +			hctx->rqs[i] = p;
 +			blk_mq_rq_init(hctx, hctx->rqs[i]);
++=======
+ 			tags->rqs[i] = p;
+ 			if (set->ops->init_request) {
+ 				if (set->ops->init_request(set->driver_data,
+ 						tags->rqs[i], hctx_idx, i,
+ 						set->numa_node))
+ 					goto fail;
+ 			}
+ 
++>>>>>>> 70ab0b2d51f8 (Revert "blk-mq: initialize req->q in allocation")
  			p += rq_size;
  			i++;
  		}
* Unmerged path block/blk-mq.c
