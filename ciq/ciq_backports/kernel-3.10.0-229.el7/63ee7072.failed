qla2xxx: Remove wait for online from host reset handler.

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-229.el7
Rebuild_CHGLOG: - [scsi] qla2xxx: Remove wait for online from host reset handler (Chad Dupuis) [1089346]
Rebuild_FUZZ: 99.10%
commit-author Chad Dupuis <chad.dupuis@qlogic.com>
commit 63ee7072b55646a1914165de63681279d661a6fe
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-229.el7/63ee7072.failed

This can block progress of the SCSI error handler thread and cause long I/O
outages.  Instead just fail immediately if another reset is going on or we are
accessing flash memory.

	Signed-off-by: Chad Dupuis <chad.dupuis@qlogic.com>
	Signed-off-by: Saurav Kashyap <saurav.kashyap@qlogic.com>
	Signed-off-by: Christoph Hellwig <hch@lst.de>
(cherry picked from commit 63ee7072b55646a1914165de63681279d661a6fe)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/qla2xxx/qla_dbg.c
#	drivers/scsi/qla2xxx/qla_os.c
diff --cc drivers/scsi/qla2xxx/qla_dbg.c
index 0233049ebbc0,c72ee97bf3f7..000000000000
--- a/drivers/scsi/qla2xxx/qla_dbg.c
+++ b/drivers/scsi/qla2xxx/qla_dbg.c
@@@ -33,19 -36,20 +33,36 @@@
   * |                              |                    | 0x503d,0x5044  |
   * |                              |                    | 0x507b		|
   * | Timer Routines               |       0x6012       |                |
++<<<<<<< HEAD
 + * | User Space Interactions      |       0x70e1       | 0x7018,0x702e, |
 + * |                              |                    | 0x7020,0x7024, |
 + * |                              |                    | 0x7039,0x7045, |
 + * |                              |                    | 0x7073-0x7075, |
 + * |                              |                    | 0x707b,0x708c, |
 + * |                              |                    | 0x70a5,0x70a6, |
 + * |                              |                    | 0x70a8,0x70ab, |
 + * |                              |                    | 0x70ad-0x70ae, |
 + * |                              |                    | 0x70d1-0x70db, |
 + * |                              |                    | 0x7047,0x703b	|
 + * |                              |                    | 0x70de-0x70df, |
 + * | Task Management              |       0x803d       | 0x8025-0x8026  |
 + * |                              |                    | 0x800b,0x8039  |
++=======
+  * | User Space Interactions      |       0x70e2       | 0x7018,0x702e  |
+  * |				  |		       | 0x7020,0x7024  |
+  * |                              |                    | 0x7039,0x7045  |
+  * |                              |                    | 0x7073-0x7075  |
+  * |                              |                    | 0x70a5-0x70a6  |
+  * |                              |                    | 0x70a8,0x70ab  |
+  * |                              |                    | 0x70ad-0x70ae  |
+  * |                              |                    | 0x70d7-0x70db  |
+  * |                              |                    | 0x70de-0x70df  |
+  * | Task Management              |       0x803d       | 0x8000,0x800b  |
+  * |                              |                    | 0x8019         |
+  * |                              |                    | 0x8025,0x8026  |
+  * |                              |                    | 0x8031,0x8032  |
+  * |                              |                    | 0x8039,0x803c  |
++>>>>>>> 63ee7072b556 (qla2xxx: Remove wait for online from host reset handler.)
   * | AER/EEH                      |       0x9011       |		|
   * | Virtual Port                 |       0xa007       |		|
   * | ISP82XX Specific             |       0xb157       | 0xb002,0xb024  |
diff --cc drivers/scsi/qla2xxx/qla_os.c
index 65e8eef2e9b5,5a430c7bc027..000000000000
--- a/drivers/scsi/qla2xxx/qla_os.c
+++ b/drivers/scsi/qla2xxx/qla_os.c
@@@ -844,11 -844,8 +844,16 @@@ qla2x00_wait_for_hba_online(scsi_qla_ho
  }
  
  /*
++<<<<<<< HEAD
 + * qla2x00_wait_for_reset_ready
 + *    Wait till the HBA is online after going through
 + *    <= MAX_RETRIES_OF_ISP_ABORT  or
 + *    finally HBA is disabled ie marked offline or flash
 + *    operations are in progress.
++=======
+  * qla2x00_wait_for_hba_ready
+  * Wait till the HBA is ready before doing driver unload
++>>>>>>> 63ee7072b556 (qla2xxx: Remove wait for online from host reset handler.)
   *
   * Input:
   *     ha - pointer to host adapter structure
@@@ -857,35 -854,15 +862,47 @@@
   *    Does context switching-Release SPIN_LOCK
   *    (if any) before calling this routine.
   *
++<<<<<<< HEAD
 + * Return:
 + *    Success (Adapter is online/no flash ops) : 0
 + *    Failed  (Adapter is offline/disabled/flash ops in progress) : 1
 + */
 +static int
 +qla2x00_wait_for_reset_ready(scsi_qla_host_t *vha)
 +{
 +	int		return_status;
 +	unsigned long	wait_online;
 +	struct qla_hw_data *ha = vha->hw;
 +	scsi_qla_host_t *base_vha = pci_get_drvdata(ha->pdev);
 +
 +	wait_online = jiffies + (MAX_LOOP_TIMEOUT * HZ);
 +	while (((test_bit(ISP_ABORT_NEEDED, &base_vha->dpc_flags)) ||
 +	    test_bit(ABORT_ISP_ACTIVE, &base_vha->dpc_flags) ||
 +	    test_bit(ISP_ABORT_RETRY, &base_vha->dpc_flags) ||
 +	    ha->optrom_state != QLA_SWAITING ||
 +	    ha->dpc_active) && time_before(jiffies, wait_online))
 +		msleep(1000);
 +
 +	if (base_vha->flags.online &&  ha->optrom_state == QLA_SWAITING)
 +		return_status = QLA_SUCCESS;
 +	else
 +		return_status = QLA_FUNCTION_FAILED;
 +
 +	ql_dbg(ql_dbg_taskm, vha, 0x8019,
 +	    "%s return status=%d.\n", __func__, return_status);
 +
 +	return return_status;
++=======
+  */
+ static void
+ qla2x00_wait_for_hba_ready(scsi_qla_host_t *vha)
+ {
+ 	struct qla_hw_data *ha = vha->hw;
+ 
+ 	while ((!(vha->flags.online) || ha->dpc_active ||
+ 	    ha->flags.mbox_busy))
+ 		msleep(1000);
++>>>>>>> 63ee7072b556 (qla2xxx: Remove wait for online from host reset handler.)
  }
  
  int
* Unmerged path drivers/scsi/qla2xxx/qla_dbg.c
* Unmerged path drivers/scsi/qla2xxx/qla_os.c
