powerpc/tm: Fix GOT save offset for ABIv2

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-229.el7
Rebuild_CHGLOG: - [powerpc] tm: Fix GOT save offset for ABIv2 (Don Zickus) [1127366]
Rebuild_FUZZ: 89.19%
commit-author Anton Blanchard <anton@samba.org>
commit 6403105bfda4d6934b39aeb85ff818b185b42de8
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-229.el7/6403105b.failed

The r2 TOC/GOT save offset is 40 on ABIv1 and 24 on ABIv2.

	Signed-off-by: Anton Blanchard <anton@samba.org>
(cherry picked from commit 6403105bfda4d6934b39aeb85ff818b185b42de8)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/powerpc/include/asm/ppc_asm.h
diff --cc arch/powerpc/include/asm/ppc_asm.h
index f627f8c74b2a,2cc2511ff076..000000000000
--- a/arch/powerpc/include/asm/ppc_asm.h
+++ b/arch/powerpc/include/asm/ppc_asm.h
@@@ -204,9 -189,35 +204,17 @@@ END_FW_FTR_SECTION_IFSET(FW_FEATURE_SPL
  #define __STK_REG(i)   (112 + ((i)-14)*8)
  #define STK_REG(i)     __STK_REG(__REG_##i)
  
++<<<<<<< HEAD
++=======
+ #if defined(_CALL_ELF) && _CALL_ELF == 2
+ #define STK_GOT		24
+ #define __STK_PARAM(i)	(32 + ((i)-3)*8)
+ #else
+ #define STK_GOT		40
++>>>>>>> 6403105bfda4 (powerpc/tm: Fix GOT save offset for ABIv2)
  #define __STK_PARAM(i)	(48 + ((i)-3)*8)
 -#endif
  #define STK_PARAM(i)	__STK_PARAM(__REG_##i)
  
 -#if defined(_CALL_ELF) && _CALL_ELF == 2
 -
 -#define _GLOBAL(name) \
 -	.section ".text"; \
 -	.align 2 ; \
 -	.type name,@function; \
 -	.globl name; \
 -name:
 -
 -#define _KPROBE(name) \
 -	.section ".kprobes.text","a"; \
 -	.align 2 ; \
 -	.type name,@function; \
 -	.globl name; \
 -name:
 -
 -#define DOTSYM(a)	a
 -
 -#else
 -
  #define XGLUE(a,b) a##b
  #define GLUE(a,b) XGLUE(a,b)
  
* Unmerged path arch/powerpc/include/asm/ppc_asm.h
diff --git a/arch/powerpc/kernel/tm.S b/arch/powerpc/kernel/tm.S
index 5752acec2226..453b0b24d94e 100644
--- a/arch/powerpc/kernel/tm.S
+++ b/arch/powerpc/kernel/tm.S
@@ -108,7 +108,7 @@ _GLOBAL(tm_reclaim)
 	mflr	r0
 	stw	r6, 8(r1)
 	std	r0, 16(r1)
-	std	r2, 40(r1)
+	std	r2, STK_GOT(r1)
 	stdu	r1, -TM_FRAME_SIZE(r1)
 
 	/* We've a struct pt_regs at [r1+STACK_FRAME_OVERHEAD]. */
@@ -289,7 +289,7 @@ dont_backup_fp:
 	ld	r0, 16(r1)
 	mtcr	r4
 	mtlr	r0
-	ld	r2, 40(r1)
+	ld	r2, STK_GOT(r1)
 
 	/* Load system default DSCR */
 	ld	r4, DSCR_DEFAULT@toc(r2)
@@ -312,7 +312,7 @@ _GLOBAL(__tm_recheckpoint)
 	mflr	r0
 	stw	r5, 8(r1)
 	std	r0, 16(r1)
-	std	r2, 40(r1)
+	std	r2, STK_GOT(r1)
 	stdu	r1, -TM_FRAME_SIZE(r1)
 
 	/* We've a struct pt_regs at [r1+STACK_FRAME_OVERHEAD].
@@ -448,7 +448,7 @@ restore_gprs:
 	ld	r0, 16(r1)
 	mtcr	r4
 	mtlr	r0
-	ld	r2, 40(r1)
+	ld	r2, STK_GOT(r1)
 
 	/* Load system default DSCR */
 	ld	r4, DSCR_DEFAULT@toc(r2)
