KVM: x86: Add nested virtualization support for MPX

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-229.el7
Rebuild_CHGLOG: - [virt] kvm/x86: Add nested virtualization support for MPX (Paolo Bonzini) [1116936]
Rebuild_FUZZ: 97.03%
commit-author Paolo Bonzini <pbonzini@redhat.com>
commit 36be0b9deb23161e9eba962c215aece551113a15
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-229.el7/36be0b9d.failed

This is simple to do, the "host" BNDCFGS is either 0 or the guest value.
However, both controls have to be present.  We cannot provide MPX if
we only have one of the "load BNDCFGS" or "clear BNDCFGS" controls.

	Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
(cherry picked from commit 36be0b9deb23161e9eba962c215aece551113a15)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kvm/vmx.c
diff --cc arch/x86/kvm/vmx.c
index 0fa868222fb6,c95bea17fc1e..000000000000
--- a/arch/x86/kvm/vmx.c
+++ b/arch/x86/kvm/vmx.c
@@@ -2201,15 -2287,12 +2205,20 @@@ static __init void nested_vmx_setup_ctl
  #ifdef CONFIG_X86_64
  		VM_EXIT_HOST_ADDR_SPACE_SIZE |
  #endif
 -		VM_EXIT_LOAD_IA32_PAT | VM_EXIT_SAVE_IA32_PAT;
 -	nested_vmx_exit_ctls_high |= VM_EXIT_ALWAYSON_WITHOUT_TRUE_MSR |
 -		VM_EXIT_LOAD_IA32_EFER | VM_EXIT_SAVE_IA32_EFER |
 +		VM_EXIT_LOAD_IA32_PAT | VM_EXIT_SAVE_IA32_PAT |
  		VM_EXIT_SAVE_VMX_PREEMPTION_TIMER;
++<<<<<<< HEAD
 +	if (!(nested_vmx_pinbased_ctls_high & PIN_BASED_VMX_PREEMPTION_TIMER) ||
 +	    !(nested_vmx_exit_ctls_high & VM_EXIT_SAVE_VMX_PREEMPTION_TIMER)) {
 +		nested_vmx_exit_ctls_high &= ~VM_EXIT_SAVE_VMX_PREEMPTION_TIMER;
 +		nested_vmx_pinbased_ctls_high &= ~PIN_BASED_VMX_PREEMPTION_TIMER;
 +	}
 +	nested_vmx_exit_ctls_high |= (VM_EXIT_ALWAYSON_WITHOUT_TRUE_MSR |
 +		VM_EXIT_LOAD_IA32_EFER | VM_EXIT_SAVE_IA32_EFER);
++=======
+ 	if (vmx_mpx_supported())
+ 		nested_vmx_exit_ctls_high |= VM_EXIT_CLEAR_BNDCFGS;
++>>>>>>> 36be0b9deb23 (KVM: x86: Add nested virtualization support for MPX)
  
  	/* entry controls */
  	rdmsr(MSR_IA32_VMX_ENTRY_CTLS,
* Unmerged path arch/x86/kvm/vmx.c
