net: cdc_ncm: fix control message ordering

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-229.el7
Rebuild_CHGLOG: - [net] cdc_ncm: fix control message ordering (Neil Horman) [1129796]
Rebuild_FUZZ: 93.67%
commit-author Bjørn Mork <bjorn@mork.no>
commit ff0992e9036e9810e7cd45234fa32ca1e79750e2
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-229.el7/ff0992e9.failed

This is a context modified revert of commit 6a9612e2cb22
("net: cdc_ncm: remove ncm_parm field") which introduced
a NCM specification violation, causing setup errors for
some devices. These errors resulted in the device and
host disagreeing about shared settings, with complete
failure to communicate as the end result.

The NCM specification require that many of the NCM specific
control reuests are sent only while the NCM Data Interface
is in alternate setting 0. Reverting the commit ensures that
we follow this requirement.

Fixes: 6a9612e2cb22 ("net: cdc_ncm: remove ncm_parm field")
Reported-and-tested-by: Pasi Kärkkäinen <pasik@iki.fi>
	Reported-by: Thomas Schäfer <tschaefer@t-online.de>
	Signed-off-by: Bjørn Mork <bjorn@mork.no>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit ff0992e9036e9810e7cd45234fa32ca1e79750e2)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/usb/cdc_ncm.c
diff --cc drivers/net/usb/cdc_ncm.c
index 279ebc0fa590,d350d2795e10..000000000000
--- a/drivers/net/usb/cdc_ncm.c
+++ b/drivers/net/usb/cdc_ncm.c
@@@ -470,25 -425,29 +470,32 @@@ advance
  
  	/* reset data interface */
  	temp = usb_set_interface(dev->udev, iface_no, 0);
 -	if (temp) {
 -		dev_dbg(&intf->dev, "set interface failed\n");
 +	if (temp)
 +		goto error2;
 +
 +	/* initialize data interface */
 +	if (cdc_ncm_setup(dev))
  		goto error2;
 -	}
  
+ 	/* initialize data interface */
+ 	if (cdc_ncm_setup(dev))
+ 		goto error2;
+ 
  	/* configure data interface */
  	temp = usb_set_interface(dev->udev, iface_no, data_altsetting);
 -	if (temp) {
 -		dev_dbg(&intf->dev, "set interface failed\n");
 +	if (temp)
  		goto error2;
 -	}
  
  	cdc_ncm_find_endpoints(dev, ctx->data);
  	cdc_ncm_find_endpoints(dev, ctx->control);
 -	if (!dev->in || !dev->out || !dev->status) {
 -		dev_dbg(&intf->dev, "failed to collect endpoints\n");
 +	if (!dev->in || !dev->out || !dev->status)
  		goto error2;
 -	}
  
++<<<<<<< HEAD
 +	dev->net->ethtool_ops = &cdc_ncm_ethtool_ops;
 +
++=======
++>>>>>>> ff0992e9036e (net: cdc_ncm: fix control message ordering)
  	usb_set_intfdata(ctx->data, dev);
  	usb_set_intfdata(ctx->control, dev);
  
* Unmerged path drivers/net/usb/cdc_ncm.c
