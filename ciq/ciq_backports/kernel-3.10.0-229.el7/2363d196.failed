iser-target: Fix multi network portal shutdown regression

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-229.el7
Rebuild_CHGLOG: - [target] iscsi: Fix multi network portal shutdown regression (Andy Grover) [1129387]
Rebuild_FUZZ: 88.89%
commit-author Nicholas Bellinger <nab@linux-iscsi.org>
commit 2363d196686e44c0158929e7cf96c8589a24a81b
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-229.el7/2363d196.failed

This patch fixes a iser-target specific regression introduced in
v3.15-rc6 with:

commit 14f4b54fe38f3a8f8392a50b951c8aa43b63687a
Author: Sagi Grimberg <sagig@mellanox.com>
Date:   Tue Apr 29 13:13:47 2014 +0300

    Target/iscsi,iser: Avoid accepting transport connections during stop stage

where the change to set iscsi_np->enabled = false within
iscsit_clear_tpg_np_login_thread() meant that a iscsi_np with
two iscsi_tpg_np exports would have it's parent iscsi_np set
to a disabled state, even if other iscsi_tpg_np exports still
existed.

This patch changes iscsit_clear_tpg_np_login_thread() to only
set iscsi_np->enabled = false when shutdown = true, and also
changes iscsit_del_np() to set iscsi_np->enabled = true when
iscsi_np->np_exports is non zero.

	Cc: Sagi Grimberg <sagig@dev.mellanox.co.il>
	Cc: stable@vger.kernel.org # 3.10+
	Signed-off-by: Nicholas Bellinger <nab@linux-iscsi.org>
(cherry picked from commit 2363d196686e44c0158929e7cf96c8589a24a81b)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/target/iscsi/iscsi_target_tpg.c
diff --cc drivers/target/iscsi/iscsi_target_tpg.c
index 439260b7d87f,1431e8400d28..000000000000
--- a/drivers/target/iscsi/iscsi_target_tpg.c
+++ b/drivers/target/iscsi/iscsi_target_tpg.c
@@@ -182,7 -184,9 +182,13 @@@ static void iscsit_clear_tpg_np_login_t
  		return;
  	}
  
++<<<<<<< HEAD
 +	iscsit_reset_np_thread(tpg_np->tpg_np, tpg_np, tpg);
++=======
+ 	if (shutdown)
+ 		tpg_np->tpg_np->enabled = false;
+ 	iscsit_reset_np_thread(tpg_np->tpg_np, tpg_np, tpg, shutdown);
++>>>>>>> 2363d196686e (iser-target: Fix multi network portal shutdown regression)
  }
  
  void iscsit_clear_tpg_np_login_threads(
diff --git a/drivers/target/iscsi/iscsi_target.c b/drivers/target/iscsi/iscsi_target.c
index 570837b405fb..7df3a169c295 100644
--- a/drivers/target/iscsi/iscsi_target.c
+++ b/drivers/target/iscsi/iscsi_target.c
@@ -460,6 +460,7 @@ int iscsit_del_np(struct iscsi_np *np)
 	spin_lock_bh(&np->np_thread_lock);
 	np->np_exports--;
 	if (np->np_exports) {
+		np->enabled = true;
 		spin_unlock_bh(&np->np_thread_lock);
 		return 0;
 	}
* Unmerged path drivers/target/iscsi/iscsi_target_tpg.c
