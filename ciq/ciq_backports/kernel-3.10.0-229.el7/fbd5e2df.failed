i40e: only create PTP device node once

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-229.el7
commit-author Jacob Keller <jacob.e.keller@intel.com>
commit fbd5e2df9f9e65439f41953455e3eb5b9aab3685
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-229.el7/fbd5e2df.failed

Currently every time we run through the i40e_ptp_init routine, we create
a new device node. This function is called by i40e_reset_and_rebuild
which is used to handle reset of the device. Even though the 1588
registers only get cleared on a GLOBAL reset, this function is still
called to handle a CORE reset.

This causes a leak of PTP device nodes at every reset. To fix this,
break PTP device clock node creation out of i40e_ptp_init, and only call
this if we don't already have a device created. Further invocation of
i40e_ptp_init will not generate new PTP devices. Instead, only the
necessary work required to reconfigure 1588 will be done.

This change also fixes an issue where a reset can cause the
device to forget it's timestamp configuration, and revert to the default
mode.

Change-ID: I741d01c61d9fe1d24887859d1316e1a8a892909e
	Signed-off-by: Jacob Keller <jacob.e.keller@intel.com>
	Signed-off-by: Jeff Kirsher <jeffrey.t.kirsher@intel.com>
(cherry picked from commit fbd5e2df9f9e65439f41953455e3eb5b9aab3685)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/intel/i40e/i40e_ptp.c
diff --cc drivers/net/ethernet/intel/i40e/i40e_ptp.c
index da1a49fa7737,0c935e8f3a6c..000000000000
--- a/drivers/net/ethernet/intel/i40e/i40e_ptp.c
+++ b/drivers/net/ethernet/intel/i40e/i40e_ptp.c
@@@ -633,9 -638,6 +672,12 @@@ void i40e_ptp_init(struct i40e_pf *pf
  		struct timespec ts;
  		u32 regval;
  
++<<<<<<< HEAD
 +		spin_lock_init(&pf->tmreg_lock);
 +		INIT_WORK(&pf->ptp_tx_work, i40e_ptp_tx_work);
 +
++=======
++>>>>>>> fbd5e2df9f9e (i40e: only create PTP device node once)
  		dev_info(&pf->pdev->dev, "%s: added PHC on %s\n", __func__,
  			 netdev->name);
  		pf->flags |= I40E_FLAG_PTP;
* Unmerged path drivers/net/ethernet/intel/i40e/i40e_ptp.c
