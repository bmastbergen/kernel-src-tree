tools/perf/build: Split out feature check: 'libelf-mmap'

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-229.el7
Rebuild_CHGLOG: - [tools] perf/build: split out feature check 'libelf-mmap' (Jiri Olsa) [1131394]
Rebuild_FUZZ: 93.33%
commit-author Ingo Molnar <mingo@kernel.org>
commit 8869b17ee0bdd0da3d1f7d7ced284ab444c2c6d8
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-229.el7/8869b17e.failed

	Cc: Arnaldo Carvalho de Melo <acme@redhat.com>
	Cc: Peter Zijlstra <a.p.zijlstra@chello.nl>
	Cc: Namhyung Kim <namhyung@kernel.org>
	Cc: David Ahern <dsahern@gmail.com>
	Cc: Jiri Olsa <jolsa@redhat.com>
Link: http://lkml.kernel.org/n/tip-9fxnxjcmrgbSvipxlwsdQ8fg@git.kernel.org
	Signed-off-by: Ingo Molnar <mingo@kernel.org>
(cherry picked from commit 8869b17ee0bdd0da3d1f7d7ced284ab444c2c6d8)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/perf/config/Makefile
diff --cc tools/perf/config/Makefile
index 9b9309dee255,bf1f021d2467..000000000000
--- a/tools/perf/config/Makefile
+++ b/tools/perf/config/Makefile
@@@ -199,37 -200,37 +200,50 @@@ els
  endif # NO_LIBELF
  
  ifndef NO_LIBELF
 -  CFLAGS += -DHAVE_LIBELF_SUPPORT
 -  FLAGS_LIBELF=$(CFLAGS) $(LDFLAGS) $(EXTLIBS)
 +CFLAGS += -DLIBELF_SUPPORT
 +FLAGS_LIBELF=$(CFLAGS) $(LDFLAGS) $(EXTLIBS)
 +ifeq ($(call try-cc,$(SOURCE_ELF_MMAP),$(FLAGS_LIBELF),-DLIBELF_MMAP),y)
 +  CFLAGS += -DLIBELF_MMAP
 +endif
 +ifeq ($(call try-cc,$(SOURCE_ELF_GETPHDRNUM),$(FLAGS_LIBELF),-DHAVE_ELF_GETPHDRNUM),y)
 +  CFLAGS += -DHAVE_ELF_GETPHDRNUM
 +endif
  
++<<<<<<< HEAD
 +# include ARCH specific config
 +-include $(src-perf)/arch/$(ARCH)/Makefile
++=======
+   ifeq ($(feature-libelf-mmap), 1)
+     CFLAGS += -DHAVE_LIBELF_MMAP_SUPPORT
+   endif
++>>>>>>> 8869b17ee0bd (tools/perf/build: Split out feature check: 'libelf-mmap')
  
 -  ifeq ($(call try-cc,$(SOURCE_ELF_GETPHDRNUM),$(FLAGS_LIBELF),-DHAVE_ELF_GETPHDRNUM_SUPPORT),y)
 -    CFLAGS += -DHAVE_ELF_GETPHDRNUM_SUPPORT
 -  endif
 -
 -  # include ARCH specific config
 -  -include $(src-perf)/arch/$(ARCH)/Makefile
 +ifndef NO_DWARF
 +ifeq ($(origin PERF_HAVE_DWARF_REGS), undefined)
 +  msg := $(warning DWARF register mappings have not been defined for architecture $(ARCH), DWARF support disabled);
 +  NO_DWARF := 1
 +else
 +  CFLAGS += -DDWARF_SUPPORT $(LIBDW_CFLAGS)
 +  LDFLAGS += $(LIBDW_LDFLAGS)
 +  EXTLIBS += -lelf -ldw
 +endif # PERF_HAVE_DWARF_REGS
 +endif # NO_DWARF
  
 -  ifndef NO_DWARF
 -    ifeq ($(origin PERF_HAVE_DWARF_REGS), undefined)
 -      msg := $(warning DWARF register mappings have not been defined for architecture $(ARCH), DWARF support disabled);
 -      NO_DWARF := 1
 -    else
 -      CFLAGS += -DHAVE_DWARF_SUPPORT $(LIBDW_CFLAGS)
 -      LDFLAGS += $(LIBDW_LDFLAGS)
 -      EXTLIBS += -lelf -ldw
 -    endif # PERF_HAVE_DWARF_REGS
 -  endif # NO_DWARF
  endif # NO_LIBELF
  
  ifndef NO_LIBELF
++<<<<<<< HEAD
 +CFLAGS += -DLIBELF_SUPPORT
 +FLAGS_LIBELF=$(CFLAGS) $(LDFLAGS) $(EXTLIBS)
 +ifeq ($(call try-cc,$(SOURCE_ELF_MMAP),$(FLAGS_LIBELF),-DLIBELF_MMAP),y)
 +  CFLAGS += -DLIBELF_MMAP
 +endif # try-cc
++=======
+   CFLAGS += -DHAVE_LIBELF_SUPPORT
+   ifeq ($(feature-libelf-mmap), 1)
+     CFLAGS += -DHAVE_LIBELF_MMAP_SUPPORT
+   endif # try-cc
++>>>>>>> 8869b17ee0bd (tools/perf/build: Split out feature check: 'libelf-mmap')
  endif # NO_LIBELF
  
  # There's only x86 (both 32 and 64) support for CFI unwind so far
* Unmerged path tools/perf/config/Makefile
diff --git a/tools/perf/config/feature-checks/Makefile b/tools/perf/config/feature-checks/Makefile
index 566a71dd6168..bf96e34509f4 100644
--- a/tools/perf/config/feature-checks/Makefile
+++ b/tools/perf/config/feature-checks/Makefile
@@ -9,6 +9,7 @@ FILES=					\
 	test-libelf			\
 	test-glibc			\
 	test-dwarf			\
+	test-libelf-mmap		\
 	test-libnuma
 
 CC := $(CC) -MD
@@ -46,6 +47,9 @@ test-glibc:
 test-dwarf:
 	$(BUILD) -ldw
 
+test-libelf-mmap:
+	$(BUILD) -lelf
+
 test-libnuma:
 	$(BUILD) -lnuma
 
diff --git a/tools/perf/config/feature-checks/test-libelf-mmap.c b/tools/perf/config/feature-checks/test-libelf-mmap.c
new file mode 100644
index 000000000000..1c648159c705
--- /dev/null
+++ b/tools/perf/config/feature-checks/test-libelf-mmap.c
@@ -0,0 +1,7 @@
+#include <libelf.h>
+#
+int main(void)
+{
+	Elf *elf = elf_begin(0, ELF_C_READ_MMAP, 0);
+	return (long)elf;
+}
