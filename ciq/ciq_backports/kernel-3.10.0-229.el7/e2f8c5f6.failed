iommu/vt-d: Use domain_remove_one_dev_info() in domain_add_dev_info() error path

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-229.el7
Rebuild_CHGLOG: - [iommu] vt-d: Use domain_remove_one_dev_info() in domain_add_dev_info() error path (Myron Stowe) [1129880 1087643]
Rebuild_FUZZ: 96.10%
commit-author David Woodhouse <David.Woodhouse@intel.com>
commit e2f8c5f6d45b092b52adea9d71018ef11250b924
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-229.el7/e2f8c5f6.failed

	Signed-off-by: David Woodhouse <David.Woodhouse@intel.com>
(cherry picked from commit e2f8c5f6d45b092b52adea9d71018ef11250b924)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/iommu/intel-iommu.c
diff --cc drivers/iommu/intel-iommu.c
index 2d7348365b6d,84f0d4284125..000000000000
--- a/drivers/iommu/intel-iommu.c
+++ b/drivers/iommu/intel-iommu.c
@@@ -2343,32 -2452,18 +2343,40 @@@ static int domain_add_dev_info(struct d
  			       struct pci_dev *pdev,
  			       int translation)
  {
++<<<<<<< HEAD
 +	struct device_domain_info *info;
 +	unsigned long flags;
++=======
+ 	struct dmar_domain *ndomain;
++>>>>>>> e2f8c5f6d45b (iommu/vt-d: Use domain_remove_one_dev_info() in domain_add_dev_info() error path)
  	int ret;
  
 -	ndomain = dmar_insert_dev_info(pci_domain_nr(pdev->bus),
 -				       pdev->bus->number, pdev->devfn,
 -				       &pdev->dev, domain);
 -	if (ndomain != domain)
 -		return -EBUSY;
 +	info = alloc_devinfo_mem();
 +	if (!info)
 +		return -ENOMEM;
 +
 +	info->segment = pci_domain_nr(pdev->bus);
 +	info->bus = pdev->bus->number;
 +	info->devfn = pdev->devfn;
 +	info->dev = pdev;
 +	info->domain = domain;
 +
 +	spin_lock_irqsave(&device_domain_lock, flags);
 +	list_add(&info->link, &domain->devices);
 +	list_add(&info->global, &device_domain_list);
 +	pdev->dev.archdata.iommu = info;
 +	spin_unlock_irqrestore(&device_domain_lock, flags);
  
  	ret = domain_context_mapping(domain, pdev, translation);
  	if (ret) {
++<<<<<<< HEAD
 +		spin_lock_irqsave(&device_domain_lock, flags);
 +		unlink_domain_info(info);
 +		spin_unlock_irqrestore(&device_domain_lock, flags);
 +		free_devinfo_mem(info);
++=======
+ 		domain_remove_one_dev_info(domain, pdev);
++>>>>>>> e2f8c5f6d45b (iommu/vt-d: Use domain_remove_one_dev_info() in domain_add_dev_info() error path)
  		return ret;
  	}
  
* Unmerged path drivers/iommu/intel-iommu.c
