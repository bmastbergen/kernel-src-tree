KVM: PPC: Book3s PR: Disable AIL mode with OPAL

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-229.el7
Rebuild_CHGLOG: - [virt] kvm/ppc: book3s/pr - Disable AIL mode with OPAL (David Gibson) [1123145 1123133 1123367]
Rebuild_FUZZ: 91.49%
commit-author Alexander Graf <agraf@suse.de>
commit fb4188bad02f4871b26cf19b98e8d92499ca5d31
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-229.el7/fb4188ba.failed

When we're using PR KVM we must not allow the CPU to take interrupts
in virtual mode, as the SLB does not contain host kernel mappings
when running inside the guest context.

To make sure we get good performance for non-KVM tasks but still
properly functioning PR KVM, let's just disable AIL whenever a vcpu
is scheduled in.

This is fundamentally different from how we deal with AIL on pSeries
type machines where we disable AIL for the whole machine as soon as
a single KVM VM is up.

The reason for that is easy - on pSeries we do not have control over
per-cpu configuration of AIL. We also don't want to mess with CPU hotplug
races and AIL configuration, so setting it per CPU is easier and more
flexible.

This patch fixes running PR KVM on POWER8 bare metal for me.

	Signed-off-by: Alexander Graf <agraf@suse.de>
	Acked-by: Paul Mackerras <paulus@samba.org>
(cherry picked from commit fb4188bad02f4871b26cf19b98e8d92499ca5d31)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/powerpc/kvm/book3s_pr.c
diff --cc arch/powerpc/kvm/book3s_pr.c
index 4a72f612a23b,8ea7da4b5649..000000000000
--- a/arch/powerpc/kvm/book3s_pr.c
+++ b/arch/powerpc/kvm/book3s_pr.c
@@@ -84,6 -96,13 +90,16 @@@ void kvmppc_core_vcpu_put(struct kvm_vc
  #endif
  
  	kvmppc_giveup_ext(vcpu, MSR_FP | MSR_VEC | MSR_VSX);
++<<<<<<< HEAD
++=======
+ 	kvmppc_giveup_fac(vcpu, FSCR_TAR_LG);
+ 
+ 	/* Enable AIL if supported */
+ 	if (cpu_has_feature(CPU_FTR_HVMODE) &&
+ 	    cpu_has_feature(CPU_FTR_ARCH_207S))
+ 		mtspr(SPRN_LPCR, mfspr(SPRN_LPCR) | LPCR_AIL_3);
+ 
++>>>>>>> fb4188bad02f (KVM: PPC: Book3s PR: Disable AIL mode with OPAL)
  	vcpu->cpu = -1;
  }
  
* Unmerged path arch/powerpc/kvm/book3s_pr.c
