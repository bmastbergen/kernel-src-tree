hpsa: use per-cpu variable for lockup_detected

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-229.el7
commit-author Stephen M. Cameron <scameron@beardog.cce.hp.com>
commit 094963dad88c86f8f480c78992df03d916774c18
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-229.el7/094963da.failed

Avoid excessive locking by using per-cpu variable for lockup_detected

	Signed-off-by: Stephen M. Cameron <scameron@beardog.cce.hp.com>
	Reviewed-by: Scott Teel <scott.teel@hp.com>
	Signed-off-by: Christoph Hellwig <hch@lst.de>
(cherry picked from commit 094963dad88c86f8f480c78992df03d916774c18)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/hpsa.c
diff --cc drivers/scsi/hpsa.c
index 799615a22841,3b70e66838ad..000000000000
--- a/drivers/scsi/hpsa.c
+++ b/drivers/scsi/hpsa.c
@@@ -7164,7 -7225,7 +7189,11 @@@ static void hpsa_remove_one(struct pci_
  	kfree(h->hba_inquiry_data);
  	pci_disable_device(pdev);
  	pci_release_regions(pdev);
++<<<<<<< HEAD
 +	pci_set_drvdata(pdev, NULL);
++=======
+ 	free_percpu(h->lockup_detected);
++>>>>>>> 094963dad88c (hpsa: use per-cpu variable for lockup_detected)
  	kfree(h);
  }
  
* Unmerged path drivers/scsi/hpsa.c
diff --git a/drivers/scsi/hpsa.h b/drivers/scsi/hpsa.h
index 771d1c1151be..895257bae5b0 100644
--- a/drivers/scsi/hpsa.h
+++ b/drivers/scsi/hpsa.h
@@ -192,7 +192,7 @@ struct ctlr_info {
 	u64 last_heartbeat_timestamp;
 	u32 heartbeat_sample_interval;
 	atomic_t firmware_flash_in_progress;
-	u32 lockup_detected;
+	u32 *lockup_detected;
 	struct delayed_work monitor_ctlr_work;
 	int remove_in_progress;
 	/* Address of h->q[x] is passed to intr handler to know which queue */
