x86, amd, ibs: Fix CPU hotplug callback registration

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-229.el7
Rebuild_CHGLOG: - [x86] amd, ibs: Fix CPU hotplug callback registration (Prarit Bhargava) [1119078]
Rebuild_FUZZ: 94.95%
commit-author Srivatsa S. Bhat <srivatsa.bhat@linux.vnet.ibm.com>
commit 047868ce2952bb6a86ccea3ecc6fd59faa9062a7
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-229.el7/047868ce.failed

Subsystems that want to register CPU hotplug callbacks, as well as perform
initialization for the CPUs that are already online, often do it as shown
below:

	get_online_cpus();

	for_each_online_cpu(cpu)
		init_cpu(cpu);

	register_cpu_notifier(&foobar_cpu_notifier);

	put_online_cpus();

This is wrong, since it is prone to ABBA deadlocks involving the
cpu_add_remove_lock and the cpu_hotplug.lock (when running concurrently
with CPU hotplug operations).

Instead, the correct and race-free way of performing the callback
registration is:

	cpu_notifier_register_begin();

	for_each_online_cpu(cpu)
		init_cpu(cpu);

	/* Note the use of the double underscored version of the API */
	__register_cpu_notifier(&foobar_cpu_notifier);

	cpu_notifier_register_done();

Fix the amd-ibs code in x86 by using this latter form of callback
registration.

	Cc: Peter Zijlstra <peterz@infradead.org>
	Cc: Paul Mackerras <paulus@samba.org>
	Cc: Ingo Molnar <mingo@kernel.org>
	Cc: Arnaldo Carvalho de Melo <acme@ghostprotocols.net>
	Cc: Thomas Gleixner <tglx@linutronix.de>
	Cc: "H. Peter Anvin" <hpa@zytor.com>
	Signed-off-by: Srivatsa S. Bhat <srivatsa.bhat@linux.vnet.ibm.com>
	Signed-off-by: Rafael J. Wysocki <rafael.j.wysocki@intel.com>
(cherry picked from commit 047868ce2952bb6a86ccea3ecc6fd59faa9062a7)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kernel/cpu/perf_event_amd_ibs.c
diff --cc arch/x86/kernel/cpu/perf_event_amd_ibs.c
index 5f0581e713c2,4c36bbe3173a..000000000000
--- a/arch/x86/kernel/cpu/perf_event_amd_ibs.c
+++ b/arch/x86/kernel/cpu/perf_event_amd_ibs.c
@@@ -889,7 -925,8 +889,12 @@@ static __init int amd_ibs_init(void
  	if (!ibs_eilvt_valid())
  		goto out;
  
++<<<<<<< HEAD
 +	get_online_cpus();
++=======
+ 	perf_ibs_pm_init();
+ 	cpu_notifier_register_begin();
++>>>>>>> 047868ce2952 (x86, amd, ibs: Fix CPU hotplug callback registration)
  	ibs_caps = caps;
  	/* make ibs_caps visible to other cpus: */
  	smp_mb();
* Unmerged path arch/x86/kernel/cpu/perf_event_amd_ibs.c
