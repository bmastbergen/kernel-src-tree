nfsd4: replace defer_free by svcxdr_tmpalloc

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-229.el7
commit-author J. Bruce Fields <bfields@redhat.com>
commit d5e2338324102dcf34aa25aeaf96064cc4d94dce
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-229.el7/d5e23383.failed

Avoid an extra allocation for the tmpbuf struct itself, and stop
ignoring some allocation failures.

	Signed-off-by: J. Bruce Fields <bfields@redhat.com>
(cherry picked from commit d5e2338324102dcf34aa25aeaf96064cc4d94dce)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/nfsd/nfs4xdr.c
diff --cc fs/nfsd/nfs4xdr.c
index 69638768c116,46115f2c3074..000000000000
--- a/fs/nfsd/nfs4xdr.c
+++ b/fs/nfsd/nfs4xdr.c
@@@ -309,7 -301,7 +301,11 @@@ nfsd4_decode_fattr(struct nfsd4_compoun
  		if (nace > NFS4_ACL_MAX)
  			return nfserr_fbig;
  
++<<<<<<< HEAD
 +		*acl = nfs4_acl_new(nace);
++=======
+ 		*acl = svcxdr_tmpalloc(argp, nfs4_acl_bytes(nace));
++>>>>>>> d5e233832410 (nfsd4: replace defer_free by svcxdr_tmpalloc)
  		if (*acl == NULL)
  			return nfserr_jukebox;
  
* Unmerged path fs/nfsd/nfs4xdr.c
diff --git a/fs/nfsd/xdr4.h b/fs/nfsd/xdr4.h
index 4379cc871607..efce9010cad4 100644
--- a/fs/nfsd/xdr4.h
+++ b/fs/nfsd/xdr4.h
@@ -478,6 +478,14 @@ struct nfsd4_op {
 
 bool nfsd4_cache_this_op(struct nfsd4_op *);
 
+/*
+ * Memory needed just for the duration of processing one compound:
+ */
+struct svcxdr_tmpbuf {
+	struct svcxdr_tmpbuf *next;
+	char buf[];
+};
+
 struct nfsd4_compoundargs {
 	/* scratch variables for XDR decode */
 	__be32 *			p;
@@ -486,10 +494,7 @@ struct nfsd4_compoundargs {
 	int				pagelen;
 	__be32				tmp[8];
 	__be32 *			tmpp;
-	struct tmpbuf {
-		struct tmpbuf *next;
-		void *buf;
-	}				*to_free;
+	struct svcxdr_tmpbuf		*to_free;
 
 	struct svc_rqst			*rqstp;
 
