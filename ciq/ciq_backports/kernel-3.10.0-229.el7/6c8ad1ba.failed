i40e: allow user to set LAA again

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-229.el7
commit-author Shannon Nelson <shannon.nelson@intel.com>
commit 6c8ad1ba1650e6c22dcaa5fe288c6236c3b25ae5
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-229.el7/6c8ad1ba.failed

Don't short-circuit the LAA assignment when the driver thinks it has
already been done - it is possible that the user might want to force
the address setting again.  At the same time, this requires a little
re-ordering of the filter management.

Change-ID: Ia0d71e3bc04edd7b68cf67edecc00abe7b9f6639
	Signed-off-by: Shannon Nelson <shannon.nelson@intel.com>
	Signed-off-by: Jeff Kirsher <jeffrey.t.kirsher@intel.com>
(cherry picked from commit 6c8ad1ba1650e6c22dcaa5fe288c6236c3b25ae5)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/intel/i40e/i40e_main.c
diff --cc drivers/net/ethernet/intel/i40e/i40e_main.c
index a960b5c3292a,81cbea72722e..000000000000
--- a/drivers/net/ethernet/intel/i40e/i40e_main.c
+++ b/drivers/net/ethernet/intel/i40e/i40e_main.c
@@@ -1277,22 -1342,26 +1274,35 @@@ static int i40e_set_mac(struct net_devi
  				    ret);
  			return -EADDRNOTAVAIL;
  		}
++<<<<<<< HEAD
 +
 +		memcpy(vsi->back->hw.mac.addr, addr->sa_data, netdev->addr_len);
++=======
++>>>>>>> 6c8ad1ba1650 (i40e: allow user to set LAA again)
  	}
  
- 	/* In order to be sure to not drop any packets, add the new address
- 	 * then delete the old one.
- 	 */
- 	f = i40e_add_filter(vsi, addr->sa_data, I40E_VLAN_ANY, false, false);
- 	if (!f)
- 		return -ENOMEM;
+ 	if (!i40e_find_mac(vsi, addr->sa_data, false, true)) {
  
- 	i40e_sync_vsi_filters(vsi);
- 	i40e_del_filter(vsi, netdev->dev_addr, I40E_VLAN_ANY, false, false);
- 	i40e_sync_vsi_filters(vsi);
+ 		/* In order to be sure to not drop any packets, add the
+ 		 * new address first then delete the old one.
+ 		 */
+ 		f = i40e_add_filter(vsi, addr->sa_data, I40E_VLAN_ANY,
+ 				    false, false);
+ 		if (!f)
+ 			return -ENOMEM;
  
++<<<<<<< HEAD
 +	memcpy(netdev->dev_addr, addr->sa_data, netdev->addr_len);
++=======
+ 		i40e_sync_vsi_filters(vsi);
+ 		i40e_del_filter(vsi, netdev->dev_addr, I40E_VLAN_ANY,
+ 				false, false);
+ 		i40e_sync_vsi_filters(vsi);
+ 	}
+ 
+ 	if (!ether_addr_equal(netdev->dev_addr, addr->sa_data))
+ 		ether_addr_copy(netdev->dev_addr, addr->sa_data);
++>>>>>>> 6c8ad1ba1650 (i40e: allow user to set LAA again)
  
  	return 0;
  }
* Unmerged path drivers/net/ethernet/intel/i40e/i40e_main.c
