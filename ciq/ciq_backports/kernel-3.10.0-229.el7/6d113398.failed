block: Stop abusing rq->csd.list in blk-softirq

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-229.el7
Rebuild_CHGLOG: - [block] Stop abusing rq->csd.list in blk-softirq (Mike Snitzer) [1105204]
Rebuild_FUZZ: 91.95%
commit-author Jan Kara <jack@suse.cz>
commit 6d113398dcf4dfcd9787a4ead738b186f7b7ff0f
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-229.el7/6d113398.failed

Abusing rq->csd.list for a list of requests to complete is rather ugly.
We use rq->queuelist instead which is much cleaner. It is safe because
queuelist is used by the block layer only for requests waiting to be
submitted to a device. Thus it is unused when irq reports the request IO
is finished.

	Signed-off-by: Jan Kara <jack@suse.cz>
	Cc: Andrew Morton <akpm@linux-foundation.org>
	Cc: Christoph Hellwig <hch@infradead.org>
	Cc: Ingo Molnar <mingo@kernel.org>
	Cc: Jens Axboe <axboe@fb.com>
	Signed-off-by: Frederic Weisbecker <fweisbec@gmail.com>
	Signed-off-by: Jens Axboe <axboe@fb.com>
(cherry picked from commit 6d113398dcf4dfcd9787a4ead738b186f7b7ff0f)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	block/blk-softirq.c
diff --cc block/blk-softirq.c
index ec9e60636f43,b5c37d96cf0e..000000000000
--- a/block/blk-softirq.c
+++ b/block/blk-softirq.c
@@@ -44,10 -44,15 +44,20 @@@ static void trigger_softirq(void *data
  	struct list_head *list;
  
  	local_irq_save(flags);
++<<<<<<< HEAD
 +	list = &__get_cpu_var(blk_cpu_done);
 +	list_add_tail(&rq->csd.list, list);
++=======
+ 	list = this_cpu_ptr(&blk_cpu_done);
+ 	/*
+ 	 * We reuse queuelist for a list of requests to process. Since the
+ 	 * queuelist is used by the block layer only for requests waiting to be
+ 	 * submitted to the device it is unused now.
+ 	 */
+ 	list_add_tail(&rq->queuelist, list);
++>>>>>>> 6d113398dcf4 (block: Stop abusing rq->csd.list in blk-softirq)
  
- 	if (list->next == &rq->csd.list)
+ 	if (list->next == &rq->queuelist)
  		raise_softirq_irqoff(BLOCK_SOFTIRQ);
  
  	local_irq_restore(flags);
@@@ -135,8 -140,8 +145,13 @@@ void __blk_complete_request(struct requ
  	if (ccpu == cpu || shared) {
  		struct list_head *list;
  do_local:
++<<<<<<< HEAD
 +		list = &__get_cpu_var(blk_cpu_done);
 +		list_add_tail(&req->csd.list, list);
++=======
+ 		list = this_cpu_ptr(&blk_cpu_done);
+ 		list_add_tail(&req->queuelist, list);
++>>>>>>> 6d113398dcf4 (block: Stop abusing rq->csd.list in blk-softirq)
  
  		/*
  		 * if the list only contains our just added request,
* Unmerged path block/blk-softirq.c
