tools/perf/build: Split out feature check: 'libelf-getphdrnum'

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-229.el7
Rebuild_CHGLOG: - [tools] perf/build: split out feature check 'libelf-getphdrnum' (Jiri Olsa) [1131394]
Rebuild_FUZZ: 94.02%
commit-author Ingo Molnar <mingo@kernel.org>
commit b7bcef6f8e61580e883672b6c97148d4f89e9874
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-229.el7/b7bcef6f.failed

	Cc: Arnaldo Carvalho de Melo <acme@redhat.com>
	Cc: Peter Zijlstra <a.p.zijlstra@chello.nl>
	Cc: Namhyung Kim <namhyung@kernel.org>
	Cc: David Ahern <dsahern@gmail.com>
	Cc: Jiri Olsa <jolsa@redhat.com>
Link: http://lkml.kernel.org/n/tip-wa9qstb8erbjreLxiHepzjfw@git.kernel.org
	Signed-off-by: Ingo Molnar <mingo@kernel.org>
(cherry picked from commit b7bcef6f8e61580e883672b6c97148d4f89e9874)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/perf/config/Makefile
#	tools/perf/config/feature-checks/Makefile
diff --cc tools/perf/config/Makefile
index 9b9309dee255,718b47611340..000000000000
--- a/tools/perf/config/Makefile
+++ b/tools/perf/config/Makefile
@@@ -111,6 -111,8 +111,11 @@@ FEATURE_TESTS =				
  	libelf				\
  	glibc				\
  	dwarf				\
++<<<<<<< HEAD
++=======
+ 	libelf-mmap			\
+ 	libelf-getphdrnum		\
++>>>>>>> b7bcef6f8e61 (tools/perf/build: Split out feature check: 'libelf-getphdrnum')
  	libnuma
  
  $(foreach test,$(FEATURE_TESTS),$(call feature_check,$(test),$(test)))
@@@ -199,37 -201,37 +204,50 @@@ els
  endif # NO_LIBELF
  
  ifndef NO_LIBELF
 -  CFLAGS += -DHAVE_LIBELF_SUPPORT
 -  FLAGS_LIBELF=$(CFLAGS) $(LDFLAGS) $(EXTLIBS)
 +CFLAGS += -DLIBELF_SUPPORT
 +FLAGS_LIBELF=$(CFLAGS) $(LDFLAGS) $(EXTLIBS)
 +ifeq ($(call try-cc,$(SOURCE_ELF_MMAP),$(FLAGS_LIBELF),-DLIBELF_MMAP),y)
 +  CFLAGS += -DLIBELF_MMAP
 +endif
 +ifeq ($(call try-cc,$(SOURCE_ELF_GETPHDRNUM),$(FLAGS_LIBELF),-DHAVE_ELF_GETPHDRNUM),y)
 +  CFLAGS += -DHAVE_ELF_GETPHDRNUM
 +endif
  
 -  ifeq ($(feature-libelf-mmap), 1)
 -    CFLAGS += -DHAVE_LIBELF_MMAP_SUPPORT
 -  endif
 +# include ARCH specific config
 +-include $(src-perf)/arch/$(ARCH)/Makefile
  
++<<<<<<< HEAD
 +ifndef NO_DWARF
 +ifeq ($(origin PERF_HAVE_DWARF_REGS), undefined)
 +  msg := $(warning DWARF register mappings have not been defined for architecture $(ARCH), DWARF support disabled);
 +  NO_DWARF := 1
 +else
 +  CFLAGS += -DDWARF_SUPPORT $(LIBDW_CFLAGS)
 +  LDFLAGS += $(LIBDW_LDFLAGS)
 +  EXTLIBS += -lelf -ldw
 +endif # PERF_HAVE_DWARF_REGS
 +endif # NO_DWARF
++=======
+   ifeq ($(feature-libelf-getphdrnum), 1)
+     CFLAGS += -DHAVE_ELF_GETPHDRNUM_SUPPORT
+   endif
++>>>>>>> b7bcef6f8e61 (tools/perf/build: Split out feature check: 'libelf-getphdrnum')
  
 -  # include ARCH specific config
 -  -include $(src-perf)/arch/$(ARCH)/Makefile
 -
 -  ifndef NO_DWARF
 -    ifeq ($(origin PERF_HAVE_DWARF_REGS), undefined)
 -      msg := $(warning DWARF register mappings have not been defined for architecture $(ARCH), DWARF support disabled);
 -      NO_DWARF := 1
 -    else
 -      CFLAGS += -DHAVE_DWARF_SUPPORT $(LIBDW_CFLAGS)
 -      LDFLAGS += $(LIBDW_LDFLAGS)
 -      EXTLIBS += -lelf -ldw
 -    endif # PERF_HAVE_DWARF_REGS
 -  endif # NO_DWARF
  endif # NO_LIBELF
  
  ifndef NO_LIBELF
++<<<<<<< HEAD
 +CFLAGS += -DLIBELF_SUPPORT
 +FLAGS_LIBELF=$(CFLAGS) $(LDFLAGS) $(EXTLIBS)
 +ifeq ($(call try-cc,$(SOURCE_ELF_MMAP),$(FLAGS_LIBELF),-DLIBELF_MMAP),y)
 +  CFLAGS += -DLIBELF_MMAP
 +endif # try-cc
++=======
+   CFLAGS += -DHAVE_LIBELF_SUPPORT
+   ifeq ($(feature-libelf-mmap), 1)
+     CFLAGS += -DHAVE_LIBELF_MMAP_SUPPORT
+   endif
++>>>>>>> b7bcef6f8e61 (tools/perf/build: Split out feature check: 'libelf-getphdrnum')
  endif # NO_LIBELF
  
  # There's only x86 (both 32 and 64) support for CFI unwind so far
diff --cc tools/perf/config/feature-checks/Makefile
index 566a71dd6168,83b3a02b64d8..000000000000
--- a/tools/perf/config/feature-checks/Makefile
+++ b/tools/perf/config/feature-checks/Makefile
@@@ -9,6 -9,8 +9,11 @@@ FILES=					
  	test-libelf			\
  	test-glibc			\
  	test-dwarf			\
++<<<<<<< HEAD
++=======
+ 	test-libelf-mmap		\
+ 	test-libelf-getphdrnum		\
++>>>>>>> b7bcef6f8e61 (tools/perf/build: Split out feature check: 'libelf-getphdrnum')
  	test-libnuma
  
  CC := $(CC) -MD
@@@ -46,6 -48,12 +51,15 @@@ test-glibc
  test-dwarf:
  	$(BUILD) -ldw
  
++<<<<<<< HEAD
++=======
+ test-libelf-mmap:
+ 	$(BUILD) -lelf
+ 
+ test-libelf-getphdrnum:
+ 	$(BUILD) -lelf
+ 
++>>>>>>> b7bcef6f8e61 (tools/perf/build: Split out feature check: 'libelf-getphdrnum')
  test-libnuma:
  	$(BUILD) -lnuma
  
* Unmerged path tools/perf/config/Makefile
* Unmerged path tools/perf/config/feature-checks/Makefile
diff --git a/tools/perf/config/feature-checks/test-libelf-getphdrnum.c b/tools/perf/config/feature-checks/test-libelf-getphdrnum.c
new file mode 100644
index 000000000000..58eca5332520
--- /dev/null
+++ b/tools/perf/config/feature-checks/test-libelf-getphdrnum.c
@@ -0,0 +1,7 @@
+#include <libelf.h>
+#
+int main(void)
+{
+	size_t dst;
+	return elf_getphdrnum(0, &dst);
+}
