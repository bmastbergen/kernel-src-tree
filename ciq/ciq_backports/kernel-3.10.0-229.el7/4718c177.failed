usb: host: xhci-plat: add clock support

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-229.el7
Rebuild_CHGLOG: - [usb] host/xhci-plat: add clock support (Don Zickus) [1110939]
Rebuild_FUZZ: 88.89%
commit-author Gregory CLEMENT <gregory.clement@free-electrons.com>
commit 4718c177405112386a977fd9f1cba5fd6aa82315
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-229.el7/4718c177.failed

Some platforms (such as the Armada 38x ones) can gate the clock of
their USB controller. This patch adds the support for one clock in
xhci-plat, by enabling it during probe and disabling it on remove.

To achieve this, it adds a 'struct clk *' member in xhci_hcd. While
only used for now in xhci-plat, it might be used by other drivers in
the future. Moreover, the xhci_hcd structure already holds other
members such as msix_count and msix_entries, which are MSI-X specific,
and therefore only used by xhci-pci.

	Signed-off-by: Gregory CLEMENT <gregory.clement@free-electrons.com>
	Signed-off-by: Thomas Petazzoni <thomas.petazzoni@free-electrons.com>
	Acked-by: Felipe Balbi <balbi@ti.com>
	Acked-by: Mathias Nyman <mathias.nyman@linux.intel.com>
	Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
(cherry picked from commit 4718c177405112386a977fd9f1cba5fd6aa82315)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/usb/host/xhci-plat.c
diff --cc drivers/usb/host/xhci-plat.c
index cd4bdbdb9eae,8108e58c9e02..000000000000
--- a/drivers/usb/host/xhci-plat.c
+++ b/drivers/usb/host/xhci-plat.c
@@@ -137,13 -139,27 +139,31 @@@ static int xhci_plat_probe(struct platf
  		goto release_mem_region;
  	}
  
+ 	/*
+ 	 * Not all platforms have a clk so it is not an error if the
+ 	 * clock does not exists.
+ 	 */
+ 	clk = devm_clk_get(&pdev->dev, NULL);
+ 	if (!IS_ERR(clk)) {
+ 		ret = clk_prepare_enable(clk);
+ 		if (ret)
+ 			goto unmap_registers;
+ 	}
+ 
  	ret = usb_add_hcd(hcd, irq, IRQF_SHARED);
  	if (ret)
++<<<<<<< HEAD
 +		goto unmap_registers;
++=======
+ 		goto disable_clk;
+ 
+ 	device_wakeup_enable(hcd->self.controller);
++>>>>>>> 4718c1774051 (usb: host: xhci-plat: add clock support)
  
  	/* USB 2.0 roothub is stored in the platform_device now. */
 -	hcd = platform_get_drvdata(pdev);
 +	hcd = dev_get_drvdata(&pdev->dev);
  	xhci = hcd_to_xhci(hcd);
+ 	xhci->clk = clk;
  	xhci->shared_hcd = usb_create_shared_hcd(driver, &pdev->dev,
  			dev_name(&pdev->dev), hcd);
  	if (!xhci->shared_hcd) {
* Unmerged path drivers/usb/host/xhci-plat.c
diff --git a/drivers/usb/host/xhci.h b/drivers/usb/host/xhci.h
index 2774526449a6..9ffecd56600d 100644
--- a/drivers/usb/host/xhci.h
+++ b/drivers/usb/host/xhci.h
@@ -1472,6 +1472,8 @@ struct xhci_hcd {
 	/* msi-x vectors */
 	int		msix_count;
 	struct msix_entry	*msix_entries;
+	/* optional clock */
+	struct clk		*clk;
 	/* data structures */
 	struct xhci_device_context_array *dcbaa;
 	struct xhci_ring	*cmd_ring;
