powerpc/tm: Add checking to treclaim/trechkpt

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-229.el7
Rebuild_CHGLOG: - [powerpc] tm: Add checking to treclaim/trechkpt (Don Zickus) [1127366]
Rebuild_FUZZ: 90.24%
commit-author Michael Neuling <mikey@neuling.org>
commit 7f06f21d40a638e1ca759ceda0f21cd81082607e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-229.el7/7f06f21d.failed

If we do a treclaim and we are not in TM suspend mode, it results in a TM bad
thing (ie. a 0x700 program check).  Similarly if we do a trechkpt and we have
an active transaction or TEXASR Failure Summary (FS) is not set, we also take a
TM bad thing.

This should never happen, but if it does (ie. a kernel bug), the cause is
almost impossible to debug as the GPR state is mostly userspace and hence we
don't get a call chain.

This adds some checks in these cases case a BUG_ON() (in asm) in case we ever
hit these cases.  It moves the register saving around to preserve r1 till later
also.

	Signed-off-by: Michael Neuling <mikey@neuling.org>
	Signed-off-by: Benjamin Herrenschmidt <benh@kernel.crashing.org>
(cherry picked from commit 7f06f21d40a638e1ca759ceda0f21cd81082607e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/powerpc/kernel/tm.S
diff --cc arch/powerpc/kernel/tm.S
index 0b97954f4f77,508c54b92fa6..000000000000
--- a/arch/powerpc/kernel/tm.S
+++ b/arch/powerpc/kernel/tm.S
@@@ -383,13 -391,11 +391,18 @@@ restore_gprs
  	/* ******************** CR,LR,CCR,MSR ********** */
  	ld	r4, _CTR(r7)
  	ld	r5, _LINK(r7)
- 	ld	r6, _CCR(r7)
  	ld	r8, _XER(r7)
  
++<<<<<<< HEAD
 +	mtctr   r4
 +	mtlr    r5
 +	mtcr    r6
 +	mtxer   r8
++=======
+ 	mtctr	r4
+ 	mtlr	r5
+ 	mtxer	r8
++>>>>>>> 7f06f21d40a6 (powerpc/tm: Add checking to treclaim/trechkpt)
  
  	/* ******************** TAR ******************** */
  	ld	r4, THREAD_TM_TAR(r3)
diff --git a/arch/powerpc/include/asm/reg.h b/arch/powerpc/include/asm/reg.h
index e983e00762dc..5b0f93382d8a 100644
--- a/arch/powerpc/include/asm/reg.h
+++ b/arch/powerpc/include/asm/reg.h
@@ -214,6 +214,7 @@
 #define SPRN_TFIAR	0x81	/* Transaction Failure Inst Addr   */
 #define SPRN_TEXASR	0x82	/* Transaction EXception & Summary */
 #define SPRN_TEXASRU	0x83	/* ''	   ''	   ''	 Upper 32  */
+#define   TEXASR_FS     __MASK(63-36) /* TEXASR Failure Summary */
 #define SPRN_TFHAR	0x80	/* Transaction Failure Handler Addr */
 #define SPRN_CTRLF	0x088
 #define SPRN_CTRLT	0x098
* Unmerged path arch/powerpc/kernel/tm.S
