tools/perf/build: Split out feature checks: 'liberty', 'liberty-z', 'cplus-demangle'

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-229.el7
Rebuild_CHGLOG: - [tools] perf/build: split out feature checks 'liberty', 'liberty-z', 'cplus-demangle' (Jiri Olsa) [1131394]
Rebuild_FUZZ: 95.65%
commit-author Ingo Molnar <mingo@kernel.org>
commit 1c47661a93fe6f729c80ed18a1f9ab1c7fb0cac2
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-229.el7/1c47661a.failed

Note that these are rarely executed tests, so we call feature_check() explicitly
and don't have them in CORE_FEATURE_CHECKS.

	Cc: Arnaldo Carvalho de Melo <acme@redhat.com>
	Cc: Peter Zijlstra <a.p.zijlstra@chello.nl>
	Cc: Namhyung Kim <namhyung@kernel.org>
	Cc: David Ahern <dsahern@gmail.com>
	Cc: Jiri Olsa <jolsa@redhat.com>
Link: http://lkml.kernel.org/n/tip-pvumlx6mbtfxffgrlwO2mRcx@git.kernel.org
	Signed-off-by: Ingo Molnar <mingo@kernel.org>
(cherry picked from commit 1c47661a93fe6f729c80ed18a1f9ab1c7fb0cac2)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/perf/config/Makefile
#	tools/perf/config/feature-checks/Makefile
diff --cc tools/perf/config/Makefile
index d8ab952c5cde,89b2d47d2e4b..000000000000
--- a/tools/perf/config/Makefile
+++ b/tools/perf/config/Makefile
@@@ -422,30 -468,25 +422,31 @@@ endi
  ifdef NO_DEMANGLE
    CFLAGS += -DNO_DEMANGLE
  else
 -  ifdef HAVE_CPLUS_DEMANGLE_SUPPORT
 +  ifdef HAVE_CPLUS_DEMANGLE
      EXTLIBS += -liberty
 -    CFLAGS += -DHAVE_CPLUS_DEMANGLE_SUPPORT
 +    CFLAGS += -DHAVE_CPLUS_DEMANGLE
    else
++<<<<<<< HEAD
 +    FLAGS_BFD=$(CFLAGS) $(LDFLAGS) $(EXTLIBS) -DPACKAGE='perf' -lbfd
 +    has_bfd := $(call try-cc,$(SOURCE_BFD),$(FLAGS_BFD),libbfd)
 +    ifeq ($(has_bfd),y)
++=======
+     ifeq ($(feature-libbfd), 1)
++>>>>>>> 1c47661a93fe (tools/perf/build: Split out feature checks: 'liberty', 'liberty-z', 'cplus-demangle')
        EXTLIBS += -lbfd
      else
-       FLAGS_BFD_IBERTY=$(FLAGS_BFD) -liberty
-       has_bfd_iberty := $(call try-cc,$(SOURCE_BFD),$(FLAGS_BFD_IBERTY),liberty)
-       ifeq ($(has_bfd_iberty),y)
+       $(feature_check,liberty)
+       ifeq ($(feature-liberty), 1)
          EXTLIBS += -lbfd -liberty
        else
-         FLAGS_BFD_IBERTY_Z=$(FLAGS_BFD_IBERTY) -lz
-         has_bfd_iberty_z := $(call try-cc,$(SOURCE_BFD),$(FLAGS_BFD_IBERTY_Z),libz)
-         ifeq ($(has_bfd_iberty_z),y)
+         $(feature_check,liberty-z)
+         ifeq ($(feature-liberty-z), 1)
            EXTLIBS += -lbfd -liberty -lz
          else
-           FLAGS_CPLUS_DEMANGLE=$(CFLAGS) $(LDFLAGS) $(EXTLIBS) -liberty
-           has_cplus_demangle := $(call try-cc,$(SOURCE_CPLUS_DEMANGLE),$(FLAGS_CPLUS_DEMANGLE),demangle)
-           ifeq ($(has_cplus_demangle),y)
+           $(feature_check,cplus-demangle)
+           ifeq ($(feature-cplus-demangle), 1)
              EXTLIBS += -liberty
 -            CFLAGS += -DHAVE_CPLUS_DEMANGLE_SUPPORT
 +            CFLAGS += -DHAVE_CPLUS_DEMANGLE
            else
              msg := $(warning No bfd.h/libbfd found, install binutils-dev[el]/zlib-static to gain symbol demangling)
              CFLAGS += -DNO_DEMANGLE
diff --cc tools/perf/config/feature-checks/Makefile
index 19082b9c3ca6,e21bceb80bf2..000000000000
--- a/tools/perf/config/feature-checks/Makefile
+++ b/tools/perf/config/feature-checks/Makefile
@@@ -1,15 -1,32 +1,33 @@@
  
  FILES=					\
 -	test-all			\
 -	test-backtrace			\
 -	test-bionic			\
 -	test-dwarf			\
 -	test-fortify-source		\
 -	test-glibc			\
 -	test-gtk2			\
 -	test-gtk2-infobar		\
  	test-hello			\
++<<<<<<< HEAD
++=======
+ 	test-libaudit			\
+ 	test-libbfd			\
+ 	test-liberty			\
+ 	test-liberty-z			\
+ 	test-cplus-demangle		\
+ 	test-libelf			\
+ 	test-libelf-getphdrnum		\
+ 	test-libelf-mmap		\
+ 	test-libnuma			\
+ 	test-libperl			\
+ 	test-libpython			\
+ 	test-libpython-version		\
+ 	test-libslang			\
+ 	test-libunwind			\
+ 	test-on-exit			\
++>>>>>>> 1c47661a93fe (tools/perf/build: Split out feature checks: 'liberty', 'liberty-z', 'cplus-demangle')
  	test-stackprotector-all		\
  	test-stackprotector		\
 -	test-volatile-register-var
 +	test-volatile-register-var	\
 +	test-fortify-source		\
 +	test-bionic			\
 +	test-libelf			\
 +	test-glibc			\
 +	test-dwarf			\
 +	test-libnuma
  
  CC := $(CC) -MD
  
@@@ -52,6 -69,77 +70,74 @@@ test-dwarf
  test-libnuma:
  	$(BUILD) -lnuma
  
++<<<<<<< HEAD
++=======
+ test-libunwind:
+ 	$(BUILD) -lunwind -lunwind-x86_64 -lelf
+ 
+ test-libaudit:
+ 	$(BUILD) -laudit
+ 
+ test-libslang:
+ 	$(BUILD) -I/usr/include/slang -lslang
+ 
+ test-gtk2:
+ 	$(BUILD) $(shell pkg-config --libs --cflags gtk+-2.0 2>/dev/null)
+ 
+ test-gtk2-infobar:
+ 	$(BUILD) $(shell pkg-config --libs --cflags gtk+-2.0 2>/dev/null)
+ 
+ grep-libs  = $(filter -l%,$(1))
+ strip-libs = $(filter-out -l%,$(1))
+ 
+ PERL_EMBED_LDOPTS = $(shell perl -MExtUtils::Embed -e ldopts 2>/dev/null)
+ PERL_EMBED_LDFLAGS = $(call strip-libs,$(PERL_EMBED_LDOPTS))
+ PERL_EMBED_LIBADD = $(call grep-libs,$(PERL_EMBED_LDOPTS))
+ PERL_EMBED_CCOPTS = `perl -MExtUtils::Embed -e ccopts 2>/dev/null`
+ FLAGS_PERL_EMBED=$(PERL_EMBED_CCOPTS) $(PERL_EMBED_LDOPTS)
+ 
+ test-libperl:
+ 	$(BUILD) $(FLAGS_PERL_EMBED)
+ 
+ override PYTHON := python
+ override PYTHON_CONFIG := python-config
+ 
+ escape-for-shell-sq =  $(subst ','\'',$(1))
+ shell-sq = '$(escape-for-shell-sq)'
+ 
+ PYTHON_CONFIG_SQ = $(call shell-sq,$(PYTHON_CONFIG))
+ 
+ PYTHON_EMBED_LDOPTS = $(shell $(PYTHON_CONFIG_SQ) --ldflags 2>/dev/null)
+ PYTHON_EMBED_LDFLAGS = $(call strip-libs,$(PYTHON_EMBED_LDOPTS))
+ PYTHON_EMBED_LIBADD = $(call grep-libs,$(PYTHON_EMBED_LDOPTS))
+ PYTHON_EMBED_CCOPTS = $(shell $(PYTHON_CONFIG_SQ) --cflags 2>/dev/null)
+ FLAGS_PYTHON_EMBED = $(PYTHON_EMBED_CCOPTS) $(PYTHON_EMBED_LDOPTS)
+ 
+ test-libpython:
+ 	$(BUILD) $(FLAGS_PYTHON_EMBED)
+ 
+ test-libpython-version:
+ 	$(BUILD) $(FLAGS_PYTHON_EMBED)
+ 
+ test-libbfd:
+ 	$(BUILD) -DPACKAGE='perf' -DPACKAGE=perf -lbfd -ldl
+ 
+ test-liberty:
+ 	$(CC) -o $(OUTPUT)$@ test-libbfd.c -DPACKAGE='perf' -DPACKAGE=perf -lbfd -ldl -liberty
+ 
+ test-liberty-z:
+ 	$(CC) -o $(OUTPUT)$@ test-libbfd.c -DPACKAGE='perf' -DPACKAGE=perf -lbfd -ldl -liberty -lz
+ 
+ test-cplus-demangle:
+ 	$(BUILD) -liberty
+ 
+ test-on-exit:
+ 	$(BUILD)
+ 
+ test-backtrace:
+ 	$(BUILD)
+ 
++>>>>>>> 1c47661a93fe (tools/perf/build: Split out feature checks: 'liberty', 'liberty-z', 'cplus-demangle')
  -include *.d */*.d
  
  ###############################
* Unmerged path tools/perf/config/Makefile
* Unmerged path tools/perf/config/feature-checks/Makefile
diff --git a/tools/perf/config/feature-checks/test-cplus-demangle.c b/tools/perf/config/feature-checks/test-cplus-demangle.c
new file mode 100644
index 000000000000..5202f5038ad8
--- /dev/null
+++ b/tools/perf/config/feature-checks/test-cplus-demangle.c
@@ -0,0 +1,10 @@
+
+extern char *cplus_demangle(const char *, int);
+
+int main(void)
+{
+	cplus_demangle(0, 0);
+
+	return 0;
+}
+
