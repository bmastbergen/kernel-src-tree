ppc/kvm: Clear the runlatch bit of a vcpu before napping

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-229.el7
Rebuild_CHGLOG: - [virt] kvm/ppc: Clear the runlatch bit of a vcpu before napping (Don Zickus) [1127366]
Rebuild_FUZZ: 92.86%
commit-author Preeti U Murthy <preeti@linux.vnet.ibm.com>
commit 582b910edafd283dfab78f41f437a92a65ee5103
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-229.el7/582b910e.failed

When the guest cedes the vcpu or the vcpu has no guest to
run it naps. Clear the runlatch bit of the vcpu before
napping to indicate an idle cpu.

	Signed-off-by: Preeti U Murthy <preeti@linux.vnet.ibm.com>
	Acked-by: Paul Mackerras <paulus@samba.org>
	Reviewed-by: Srivatsa S. Bhat <srivatsa.bhat@linux.vnet.ibm.com>
	Signed-off-by: Benjamin Herrenschmidt <benh@kernel.crashing.org>
(cherry picked from commit 582b910edafd283dfab78f41f437a92a65ee5103)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/powerpc/kvm/book3s_hv_rmhandlers.S
diff --cc arch/powerpc/kvm/book3s_hv_rmhandlers.S
index 0ae4c28ae4b6,b031f932c0cc..000000000000
--- a/arch/powerpc/kvm/book3s_hv_rmhandlers.S
+++ b/arch/powerpc/kvm/book3s_hv_rmhandlers.S
@@@ -255,6 -314,12 +255,15 @@@ kvm_start_guest
  kvm_no_guest:
  	li	r0, KVM_HWTHREAD_IN_NAP
  	stb	r0, HSTATE_HWTHREAD_STATE(r13)
++<<<<<<< HEAD
++=======
+ kvm_do_nap:
+ 	/* Clear the runlatch bit before napping */
+ 	mfspr	r2, SPRN_CTRLF
+ 	clrrdi	r2, r2, 1
+ 	mtspr	SPRN_CTRLT, r2
+ 
++>>>>>>> 582b910edafd (ppc/kvm: Clear the runlatch bit of a vcpu before napping)
  	li	r3, LPCR_PECE0
  	mfspr	r4, SPRN_LPCR
  	rlwimi	r4, r3, 0, LPCR_PECE0 | LPCR_PECE1
@@@ -1711,9 -2009,14 +1720,19 @@@ END_FTR_SECTION_IFCLR(CPU_FTR_ARCH_206
  	bl	kvmppc_save_fp
  
  	/*
++<<<<<<< HEAD
 +	 * Take a nap until a decrementer or external interrupt occurs,
 +	 * with PECE1 (wake on decr) and PECE0 (wake on external) set in LPCR
++=======
+ 	 * Take a nap until a decrementer or external or doobell interrupt
+ 	 * occurs, with PECE1, PECE0 and PECEDP set in LPCR. Also clear the
+ 	 * runlatch bit before napping.
++>>>>>>> 582b910edafd (ppc/kvm: Clear the runlatch bit of a vcpu before napping)
  	 */
+ 	mfspr	r2, SPRN_CTRLF
+ 	clrrdi	r2, r2, 1
+ 	mtspr	SPRN_CTRLT, r2
+ 
  	li	r0,1
  	stb	r0,HSTATE_HWTHREAD_REQ(r13)
  	mfspr	r5,SPRN_LPCR
* Unmerged path arch/powerpc/kvm/book3s_hv_rmhandlers.S
