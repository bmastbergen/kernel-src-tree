ceph: drop unconnected inodes

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-229.el7
commit-author Yan, Zheng <zheng.z.yan@intel.com>
commit 9f12bd119e408388233e7aeb1152f372a8b5dcad
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-229.el7/9f12bd11.failed

Positve dentry and corresponding inode are always accompanied in MDS reply.
So no need to keep inode in the cache after dropping all its aliases.

	Signed-off-by: Yan, Zheng <zheng.z.yan@intel.com>
	Reviewed-by: Sage Weil <sage@inktank.com>
(cherry picked from commit 9f12bd119e408388233e7aeb1152f372a8b5dcad)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/ceph/inode.c
diff --cc fs/ceph/inode.c
index 32d3d57bb16c,d37b2dc01d3f..000000000000
--- a/fs/ceph/inode.c
+++ b/fs/ceph/inode.c
@@@ -431,6 -436,15 +431,18 @@@ void ceph_destroy_inode(struct inode *i
  	call_rcu(&inode->i_rcu, ceph_i_callback);
  }
  
++<<<<<<< HEAD
++=======
+ int ceph_drop_inode(struct inode *inode)
+ {
+ 	/*
+ 	 * Positve dentry and corresponding inode are always accompanied
+ 	 * in MDS reply. So no need to keep inode in the cache after
+ 	 * dropping all its aliases.
+ 	 */
+ 	return 1;
+ }
++>>>>>>> 9f12bd119e40 (ceph: drop unconnected inodes)
  
  /*
   * Helpers to fill in size, ctime, mtime, and atime.  We have to be
* Unmerged path fs/ceph/inode.c
diff --git a/fs/ceph/super.c b/fs/ceph/super.c
index 6627b26a800c..4fe919a7119d 100644
--- a/fs/ceph/super.c
+++ b/fs/ceph/super.c
@@ -655,6 +655,7 @@ static const struct super_operations ceph_super_ops = {
 	.alloc_inode	= ceph_alloc_inode,
 	.destroy_inode	= ceph_destroy_inode,
 	.write_inode    = ceph_write_inode,
+	.drop_inode	= ceph_drop_inode,
 	.sync_fs        = ceph_sync_fs,
 	.put_super	= ceph_put_super,
 	.show_options   = ceph_show_options,
diff --git a/fs/ceph/super.h b/fs/ceph/super.h
index fadef7047cb9..bd8df0cae0ad 100644
--- a/fs/ceph/super.h
+++ b/fs/ceph/super.h
@@ -675,6 +675,7 @@ extern const struct inode_operations ceph_file_iops;
 
 extern struct inode *ceph_alloc_inode(struct super_block *sb);
 extern void ceph_destroy_inode(struct inode *inode);
+extern int ceph_drop_inode(struct inode *inode);
 
 extern struct inode *ceph_get_inode(struct super_block *sb,
 				    struct ceph_vino vino);
