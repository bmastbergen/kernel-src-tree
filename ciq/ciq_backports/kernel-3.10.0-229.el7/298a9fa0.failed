dm crypt: use per-bio data

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-229.el7
Rebuild_CHGLOG: - [md] dm-crypt: use per-bio data (Mike Snitzer) [1117872]
Rebuild_FUZZ: 96.15%
commit-author Mikulas Patocka <mpatocka@redhat.com>
commit 298a9fa08a1577211d42a75e8fc073baef61e0d9
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-229.el7/298a9fa0.failed

Change dm-crypt so that it uses auxiliary data allocated with the bio.

Dm-crypt requires two allocations per request - struct dm_crypt_io and
struct ablkcipher_request (with other data appended to it).  It
previously only used mempool allocations.

Some requests may require more dm_crypt_ios and ablkcipher_requests,
however most requests need just one of each of these two structures to
complete.

This patch changes it so that the first dm_crypt_io and ablkcipher_request
are allocated with the bio (using target per_bio_data_size option).  If
the request needs additional values, they are allocated from the mempool.

	Signed-off-by: Mikulas Patocka <mpatocka@redhat.com>
	Signed-off-by: Mike Snitzer <snitzer@redhat.com>
(cherry picked from commit 298a9fa08a1577211d42a75e8fc073baef61e0d9)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/md/dm-crypt.c
diff --cc drivers/md/dm-crypt.c
index ed4032c3eadc,2785007e0e46..000000000000
--- a/drivers/md/dm-crypt.c
+++ b/drivers/md/dm-crypt.c
@@@ -1836,7 -1835,9 +1847,13 @@@ static int crypt_map(struct dm_target *
  		return DM_MAPIO_REMAPPED;
  	}
  
++<<<<<<< HEAD
 +	io = crypt_io_alloc(cc, bio, dm_target_offset(ti, bio->bi_sector));
++=======
+ 	io = dm_per_bio_data(bio, cc->per_bio_data_size);
+ 	crypt_io_init(io, cc, bio, dm_target_offset(ti, bio->bi_iter.bi_sector));
+ 	io->ctx.req = (struct ablkcipher_request *)(io + 1);
++>>>>>>> 298a9fa08a15 (dm crypt: use per-bio data)
  
  	if (bio_data_dir(io->base_bio) == READ) {
  		if (kcryptd_io_read(io, GFP_NOWAIT))
* Unmerged path drivers/md/dm-crypt.c
