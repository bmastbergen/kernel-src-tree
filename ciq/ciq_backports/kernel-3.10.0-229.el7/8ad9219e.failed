perf stat: Fix memory corruption of xyarray when cpumask is used

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-229.el7
Rebuild_CHGLOG: - [tools] perf/stat: Fix memory corruption of xyarray when cpumask is used (Jiri Olsa) [1133083]
Rebuild_FUZZ: 98.44%
commit-author Stephane Eranian <eranian@google.com>
commit 8ad9219e08af12a5652892e273336dbd31b25b03
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-229.el7/8ad9219e.failed

This patch fixes a memory corruption problem with the xyarray when the
evsel fds get closed at the end of the run_perf_stat() call.

It could be triggered with:

 # perf stat -a -e power/energy-cores/ ls

When cpumask are used by events (.e.g, RAPL or uncores) then the evsel
fds are allocated based on the actual number of CPUs monitored. That
number can be smaller than the total number of CPUs on the system.

The problem arises at the end by perf stat closes the fds twice. When
fds are closed, their entry in the xyarray are set to -1.

The first close() on the evsel is made from __run_perf_stat() and it
uses the actual number of CPUS for the event which is how the xyarray
was allocated for.

The second is from perf_evlist_close() but that one is on the total
number of CPUs in the system, so it assume the xyarray was allocated to
cover it. However it was not, and some writes corrupt memory.

The fix is in perf_evlist_close() is to first try with the evsel->cpus
if present, if not use the evlist->cpus. That fixes the problem.

	Signed-off-by: Stephane Eranian <eranian@google.com>
	Cc: David Ahern <dsahern@gmail.com>
	Cc: Ingo Molnar <mingo@elte.hu>
	Cc: Jiri Olsa <jolsa@redhat.com>
	Cc: Peter Zijlstra <peterz@infradead.org>
Link: http://lkml.kernel.org/r/1389972846-6566-3-git-send-email-eranian@google.com
	Signed-off-by: Arnaldo Carvalho de Melo <acme@redhat.com>
(cherry picked from commit 8ad9219e08af12a5652892e273336dbd31b25b03)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/perf/util/evlist.c
diff --cc tools/perf/util/evlist.c
index 885c0d67effb,59ef2802fcf6..000000000000
--- a/tools/perf/util/evlist.c
+++ b/tools/perf/util/evlist.c
@@@ -1006,9 -1003,12 +1006,17 @@@ void perf_evlist__close(struct perf_evl
  	struct perf_evsel *evsel;
  	int ncpus = cpu_map__nr(evlist->cpus);
  	int nthreads = thread_map__nr(evlist->threads);
+ 	int n;
  
++<<<<<<< HEAD
 +	list_for_each_entry_reverse(evsel, &evlist->entries, node)
 +		perf_evsel__close(evsel, ncpus, nthreads);
++=======
+ 	evlist__for_each_reverse(evlist, evsel) {
+ 		n = evsel->cpus ? evsel->cpus->nr : ncpus;
+ 		perf_evsel__close(evsel, n, nthreads);
+ 	}
++>>>>>>> 8ad9219e08af (perf stat: Fix memory corruption of xyarray when cpumask is used)
  }
  
  int perf_evlist__open(struct perf_evlist *evlist)
* Unmerged path tools/perf/util/evlist.c
