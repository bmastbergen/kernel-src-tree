ip_tunnel: Make vti work with i_key set

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-229.el7
commit-author Steffen Klassert <steffen.klassert@secunet.com>
commit 6d608f06e390d803c1d0e604cae280f1e708bf68
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-229.el7/6d608f06.failed

Vti uses the o_key to mark packets that were transmitted or received
by a vti interface. Unfortunately we can't apply different marks
to in and outbound packets with only one key availabe. Vti interfaces
typically use wildcard selectors for vti IPsec policies. On forwarding,
the same output policy will match for both directions. This generates
a loop between the IPsec gateways until the ttl of the packet is
exceeded.

The gre i_key/o_key are usually there to find the right gre tunnel
during a lookup. When vti uses the i_key to mark packets, the tunnel
lookup does not work any more because vti does not use the gre keys
as a hash key for the lookup.

This patch workarounds this my not including the i_key when comupting
the hash for the tunnel lookup in case of vti tunnels.

With this we have separate keys available for the transmitting and
receiving side of the vti interface.

	Signed-off-by: Steffen Klassert <steffen.klassert@secunet.com>
(cherry picked from commit 6d608f06e390d803c1d0e604cae280f1e708bf68)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/ipv4/ip_tunnel.c
diff --cc net/ipv4/ip_tunnel.c
index 94a70beef142,4fff64418fb2..000000000000
--- a/net/ipv4/ip_tunnel.c
+++ b/net/ipv4/ip_tunnel.c
@@@ -234,7 -287,10 +235,14 @@@ static struct hlist_head *ip_bucket(str
  	else
  		remote = 0;
  
++<<<<<<< HEAD
 +	h = ip_tunnel_hash(itn, parms->i_key, remote);
++=======
+ 	if (!(parms->i_flags & TUNNEL_KEY) && (parms->i_flags & VTI_ISVTI))
+ 		i_key = 0;
+ 
+ 	h = ip_tunnel_hash(i_key, remote);
++>>>>>>> 6d608f06e390 (ip_tunnel: Make vti work with i_key set)
  	return &itn->tunnels[h];
  }
  
* Unmerged path net/ipv4/ip_tunnel.c
