openvswitch: restore OVS_FLOW_CMD_NEW notifications

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-229.el7
commit-author Samuel Gauthier <samuel.gauthier@6wind.com>
commit 9b67aa4a82492f128adfccc63e61ab57c1ce1dfd
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-229.el7/9b67aa4a.failed

Since commit fb5d1e9e127a ("openvswitch: Build flow cmd netlink reply only if needed."),
the new flows are not notified to the listeners of OVS_FLOW_MCGROUP.

This commit fixes the problem by using the genl function, ie
genl_has_listerners() instead of netlink_has_listeners().

	Signed-off-by: Samuel Gauthier <samuel.gauthier@6wind.com>
	Signed-off-by: Nicolas Dichtel <nicolas.dichtel@6wind.com>
	Acked-by: Pravin B Shelar <pshelar@nicira.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 9b67aa4a82492f128adfccc63e61ab57c1ce1dfd)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/openvswitch/datapath.c
diff --cc net/openvswitch/datapath.c
index 786222d76e75,64dc864a417f..000000000000
--- a/net/openvswitch/datapath.c
+++ b/net/openvswitch/datapath.c
@@@ -62,11 -60,37 +62,45 @@@
  
  int ovs_net_id __read_mostly;
  
++<<<<<<< HEAD
 +static void ovs_notify(struct sk_buff *skb, struct genl_info *info,
 +		       struct genl_multicast_group *grp)
 +{
 +	genl_notify(skb, genl_info_net(info), info->snd_portid,
 +		    grp->id, info->nlhdr, GFP_KERNEL);
++=======
+ static struct genl_family dp_packet_genl_family;
+ static struct genl_family dp_flow_genl_family;
+ static struct genl_family dp_datapath_genl_family;
+ 
+ static const struct genl_multicast_group ovs_dp_flow_multicast_group = {
+ 	.name = OVS_FLOW_MCGROUP,
+ };
+ 
+ static const struct genl_multicast_group ovs_dp_datapath_multicast_group = {
+ 	.name = OVS_DATAPATH_MCGROUP,
+ };
+ 
+ static const struct genl_multicast_group ovs_dp_vport_multicast_group = {
+ 	.name = OVS_VPORT_MCGROUP,
+ };
+ 
+ /* Check if need to build a reply message.
+  * OVS userspace sets the NLM_F_ECHO flag if it needs the reply. */
+ static bool ovs_must_notify(struct genl_family *family, struct genl_info *info,
+ 			    unsigned int group)
+ {
+ 	return info->nlhdr->nlmsg_flags & NLM_F_ECHO ||
+ 	       genl_has_listeners(family, genl_info_net(info)->genl_sock,
+ 				  group);
+ }
+ 
+ static void ovs_notify(struct genl_family *family,
+ 		       struct sk_buff *skb, struct genl_info *info)
+ {
+ 	genl_notify(family, skb, genl_info_net(info), info->snd_portid,
+ 		    0, info->nlhdr, GFP_KERNEL);
++>>>>>>> 9b67aa4a8249 (openvswitch: restore OVS_FLOW_CMD_NEW notifications)
  }
  
  /**
@@@ -748,22 -757,28 +782,27 @@@ error
  	return err;
  }
  
 -/* May not be called with RCU read lock. */
 -static struct sk_buff *ovs_flow_cmd_alloc_info(const struct sw_flow_actions *acts,
 -					       struct genl_info *info,
 -					       bool always)
 +/* Must be called with ovs_mutex. */
 +static struct sk_buff *ovs_flow_cmd_alloc_info(struct sw_flow *flow,
 +					       struct genl_info *info)
  {
 -	struct sk_buff *skb;
 +	size_t len;
  
++<<<<<<< HEAD
 +	len = ovs_flow_cmd_msg_size(ovsl_dereference(flow->sf_acts));
++=======
+ 	if (!always && !ovs_must_notify(&dp_flow_genl_family, info, 0))
+ 		return NULL;
++>>>>>>> 9b67aa4a8249 (openvswitch: restore OVS_FLOW_CMD_NEW notifications)
  
 -	skb = genlmsg_new_unicast(ovs_flow_cmd_msg_size(acts), info, GFP_KERNEL);
 -	if (!skb)
 -		return ERR_PTR(-ENOMEM);
 -
 -	return skb;
 +	return genlmsg_new_unicast(len, info, GFP_KERNEL);
  }
  
 -/* Called with ovs_mutex. */
 -static struct sk_buff *ovs_flow_cmd_build_info(const struct sw_flow *flow,
 -					       int dp_ifindex,
 -					       struct genl_info *info, u8 cmd,
 -					       bool always)
 +/* Must be called with ovs_mutex. */
 +static struct sk_buff *ovs_flow_cmd_build_info(struct sw_flow *flow,
 +					       struct datapath *dp,
 +					       struct genl_info *info,
 +					       u8 cmd)
  {
  	struct sk_buff *skb;
  	int retval;
* Unmerged path net/openvswitch/datapath.c
