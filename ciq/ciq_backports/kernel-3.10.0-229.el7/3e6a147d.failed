perf tools: Separate lbfd check out of NO_DEMANGLE condition

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-229.el7
Rebuild_CHGLOG: - [tools] perf: Separate lbfd check out of NO_DEMANGLE condition (Jiri Olsa) [1131394]
Rebuild_FUZZ: 94.74%
commit-author Jiri Olsa <jolsa@redhat.com>
commit 3e6a147deef93ddbb899cb394d8d44118289e76a
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-229.el7/3e6a147d.failed

We fail build with NO_DEMANGLE with missing -lbfd externals error.
The reason is that we now use bfd code in srcline object:
  perf tools: Implement addr2line directly using libbfd

So we need to check/add -lbfd always now.

	Signed-off-by: Jiri Olsa <jolsa@redhat.com>
	Cc: Corey Ashford <cjashfor@linux.vnet.ibm.com>
	Cc: David Ahern <dsahern@gmail.com>
	Cc: Ingo Molnar <mingo@elte.hu>
	Cc: Namhyung Kim <namhyung@kernel.org>
	Cc: Paul Mackerras <paulus@samba.org>
	Cc: Peter Zijlstra <a.p.zijlstra@chello.nl>
	Cc: Arnaldo Carvalho de Melo <acme@redhat.com>
(cherry picked from commit 3e6a147deef93ddbb899cb394d8d44118289e76a)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/perf/config/Makefile
diff --cc tools/perf/config/Makefile
index 96a8898e922c,96804247df08..000000000000
--- a/tools/perf/config/Makefile
+++ b/tools/perf/config/Makefile
@@@ -421,30 -477,23 +425,36 @@@ endi
  ifdef NO_DEMANGLE
    CFLAGS += -DNO_DEMANGLE
  else
 -  ifdef HAVE_CPLUS_DEMANGLE_SUPPORT
 +  ifdef HAVE_CPLUS_DEMANGLE
      EXTLIBS += -liberty
 -    CFLAGS += -DHAVE_CPLUS_DEMANGLE_SUPPORT
 +    CFLAGS += -DHAVE_CPLUS_DEMANGLE
    else
++<<<<<<< HEAD
 +    FLAGS_BFD=$(CFLAGS) $(LDFLAGS) $(EXTLIBS) -DPACKAGE='perf' -lbfd
 +    has_bfd := $(call try-cc,$(SOURCE_BFD),$(FLAGS_BFD),libbfd)
 +    ifeq ($(has_bfd),y)
 +      EXTLIBS += -lbfd
 +    else
 +      FLAGS_BFD_IBERTY=$(FLAGS_BFD) -liberty
 +      has_bfd_iberty := $(call try-cc,$(SOURCE_BFD),$(FLAGS_BFD_IBERTY),liberty)
 +      ifeq ($(has_bfd_iberty),y)
++=======
+     ifneq ($(feature-libbfd), 1)
+       $(feature_check,liberty)
+       ifeq ($(feature-liberty), 1)
++>>>>>>> 3e6a147deef9 (perf tools: Separate lbfd check out of NO_DEMANGLE condition)
          EXTLIBS += -lbfd -liberty
        else
 -        $(feature_check,liberty-z)
 -        ifeq ($(feature-liberty-z), 1)
 +        FLAGS_BFD_IBERTY_Z=$(FLAGS_BFD_IBERTY) -lz
 +        has_bfd_iberty_z := $(call try-cc,$(SOURCE_BFD),$(FLAGS_BFD_IBERTY_Z),libz)
 +        ifeq ($(has_bfd_iberty_z),y)
            EXTLIBS += -lbfd -liberty -lz
          else
 -          $(feature_check,cplus-demangle)
 -          ifeq ($(feature-cplus-demangle), 1)
 +          FLAGS_CPLUS_DEMANGLE=$(CFLAGS) $(LDFLAGS) $(EXTLIBS) -liberty
 +          has_cplus_demangle := $(call try-cc,$(SOURCE_CPLUS_DEMANGLE),$(FLAGS_CPLUS_DEMANGLE),demangle)
 +          ifeq ($(has_cplus_demangle),y)
              EXTLIBS += -liberty
 -            CFLAGS += -DHAVE_CPLUS_DEMANGLE_SUPPORT
 +            CFLAGS += -DHAVE_CPLUS_DEMANGLE
            else
              msg := $(warning No bfd.h/libbfd found, install binutils-dev[el]/zlib-static to gain symbol demangling)
              CFLAGS += -DNO_DEMANGLE
@@@ -455,10 -504,8 +465,15 @@@
    endif
  endif
  
++<<<<<<< HEAD
 +ifndef NO_STRLCPY
 +  ifeq ($(call try-cc,$(SOURCE_STRLCPY),,-DHAVE_STRLCPY),y)
 +    CFLAGS += -DHAVE_STRLCPY
 +  endif
++=======
+ ifneq ($(filter -lbfd,$(EXTLIBS)),)
+   CFLAGS += -DHAVE_LIBBFD_SUPPORT
++>>>>>>> 3e6a147deef9 (perf tools: Separate lbfd check out of NO_DEMANGLE condition)
  endif
  
  ifndef NO_ON_EXIT
* Unmerged path tools/perf/config/Makefile
