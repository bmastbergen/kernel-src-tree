powerpc: Add VM_FAULT_HWPOISON handling to powerpc page fault handler

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-229.el7
Rebuild_CHGLOG: - [powerpc] Add VM_FAULT_HWPOISON handling to powerpc page fault handler (Gustavo Duarte) [1173267]
Rebuild_FUZZ: 93.02%
commit-author Anton Blanchard <anton@samba.org>
commit 3913fdd7a23d9d8480ce3a6ca9cdf78bf0dec5a0
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-229.el7/3913fdd7.failed

do_page_fault was missing knowledge of HWPOISON, and we would oops
if userspace tried to access a poisoned page:

kernel BUG at arch/powerpc/mm/fault.c:180!

	Signed-off-by: Anton Blanchard <anton@samba.org>
	Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
(cherry picked from commit 3913fdd7a23d9d8480ce3a6ca9cdf78bf0dec5a0)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/powerpc/mm/fault.c
diff --cc arch/powerpc/mm/fault.c
index 2dd69bf4af46,588b6ccc0569..000000000000
--- a/arch/powerpc/mm/fault.c
+++ b/arch/powerpc/mm/fault.c
@@@ -120,16 -121,23 +121,36 @@@ static int do_sigbus(struct pt_regs *re
  
  	up_read(&current->mm->mmap_sem);
  
++<<<<<<< HEAD
 +	if (user_mode(regs)) {
 +		current->thread.trap_nr = BUS_ADRERR;
 +		info.si_signo = SIGBUS;
 +		info.si_errno = 0;
 +		info.si_code = BUS_ADRERR;
 +		info.si_addr = (void __user *)address;
 +		force_sig_info(SIGBUS, &info, current);
 +		return MM_FAULT_RETURN;
 +	}
 +	return MM_FAULT_ERR(SIGBUS);
++=======
+ 	if (!user_mode(regs))
+ 		return MM_FAULT_ERR(SIGBUS);
+ 
+ 	current->thread.trap_nr = BUS_ADRERR;
+ 	info.si_signo = SIGBUS;
+ 	info.si_errno = 0;
+ 	info.si_code = BUS_ADRERR;
+ 	info.si_addr = (void __user *)address;
+ #ifdef CONFIG_MEMORY_FAILURE
+ 	if (fault & (VM_FAULT_HWPOISON|VM_FAULT_HWPOISON_LARGE)) {
+ 		pr_err("MCE: Killing %s:%d due to hardware memory corruption fault at %lx\n",
+ 			current->comm, current->pid, address);
+ 		info.si_code = BUS_MCEERR_AR;
+ 	}
+ #endif
+ 	force_sig_info(SIGBUS, &info, current);
+ 	return MM_FAULT_RETURN;
++>>>>>>> 3913fdd7a23d (powerpc: Add VM_FAULT_HWPOISON handling to powerpc page fault handler)
  }
  
  static int mm_fault_error(struct pt_regs *regs, unsigned long addr, int fault)
* Unmerged path arch/powerpc/mm/fault.c
