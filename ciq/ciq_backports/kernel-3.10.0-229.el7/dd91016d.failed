uprobes/x86: Don't change the task's state if ->pre_xol() fails

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-229.el7
Rebuild_CHGLOG: - [kernel] uprobes: Don't change the task's state if ->pre_xol() fails (Oleg Nesterov) [1073627]
Rebuild_FUZZ: 96.72%
commit-author Oleg Nesterov <oleg@redhat.com>
commit dd91016dfc9ba9236cb0149984da3f0434278b49
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-229.el7/dd91016d.failed

Currently this doesn't matter, the only ->pre_xol() hook can't fail,
but we need to fix arch_uprobe_pre_xol() anyway. If ->pre_xol() fails
we should not change regs->ip/flags, we should just return the error
to make restart actually possible.

	Signed-off-by: Oleg Nesterov <oleg@redhat.com>
	Reviewed-by: Jim Keniston <jkenisto@us.ibm.com>
(cherry picked from commit dd91016dfc9ba9236cb0149984da3f0434278b49)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kernel/uprobes.c
diff --cc arch/x86/kernel/uprobes.c
index 99569dc5b83d,f4464b1b9435..000000000000
--- a/arch/x86/kernel/uprobes.c
+++ b/arch/x86/kernel/uprobes.c
@@@ -470,33 -702,6 +476,36 @@@ int arch_uprobe_pre_xol(struct arch_upr
  	if (test_tsk_thread_flag(current, TIF_BLOCKSTEP))
  		set_task_blockstep(current, false);
  
++<<<<<<< HEAD
 +	pre_xol_rip_insn(auprobe, regs, &utask->autask);
 +	return 0;
 +}
 +
 +/*
 + * This function is called by arch_uprobe_post_xol() to adjust the return
 + * address pushed by a call instruction executed out of line.
 + */
 +static int adjust_ret_addr(unsigned long sp, long correction)
 +{
 +	int rasize, ncopied;
 +	long ra = 0;
 +
 +	if (is_ia32_task())
 +		rasize = 4;
 +	else
 +		rasize = 8;
 +
 +	ncopied = copy_from_user(&ra, (void __user *)sp, rasize);
 +	if (unlikely(ncopied))
 +		return -EFAULT;
 +
 +	ra += correction;
 +	ncopied = copy_to_user((void __user *)sp, &ra, rasize);
 +	if (unlikely(ncopied))
 +		return -EFAULT;
 +
++=======
++>>>>>>> dd91016dfc9b (uprobes/x86: Don't change the task's state if ->pre_xol() fails)
  	return 0;
  }
  
* Unmerged path arch/x86/kernel/uprobes.c
