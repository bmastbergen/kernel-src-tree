blk-mq: initialize request on allocation

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-229.el7
commit-author Christoph Hellwig <hch@lst.de>
commit ed44832dea8a74f909e0187f350201402927f5e5
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-229.el7/ed44832d.failed

If we want to share tag and request allocation between queues we cannot
initialize the request at init/free time, but need to initialize it
at allocation time as it might get used for different queues over its
lifetime.

	Signed-off-by: Christoph Hellwig <hch@lst.de>
	Signed-off-by: Jens Axboe <axboe@fb.com>
(cherry picked from commit ed44832dea8a74f909e0187f350201402927f5e5)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	block/blk-mq.c
diff --cc block/blk-mq.c
index aa3684343138,2a5a0fed10a3..000000000000
--- a/block/blk-mq.c
+++ b/block/blk-mq.c
@@@ -268,9 -258,7 +269,11 @@@ static void __blk_mq_free_request(struc
  	const int tag = rq->tag;
  	struct request_queue *q = rq->q;
  
++<<<<<<< HEAD
 +	blk_mq_rq_init(hctx, rq);
++=======
++>>>>>>> ed44832dea8a (blk-mq: initialize request on allocation)
  	blk_mq_put_tag(hctx->tags, tag);
- 
  	blk_mq_queue_exit(q);
  }
  
@@@ -1127,7 -1121,13 +1130,17 @@@ static int blk_mq_init_rq_map(struct bl
  		left -= to_do * rq_size;
  		for (j = 0; j < to_do; j++) {
  			hctx->rqs[i] = p;
++<<<<<<< HEAD
 +			blk_mq_rq_init(hctx, hctx->rqs[i]);
++=======
+ 			if (reg->ops->init_request) {
+ 				error = reg->ops->init_request(driver_data,
+ 						hctx, hctx->rqs[i], i);
+ 				if (error)
+ 					goto err_rq_map;
+ 			}
+ 
++>>>>>>> ed44832dea8a (blk-mq: initialize request on allocation)
  			p += rq_size;
  			i++;
  		}
* Unmerged path block/blk-mq.c
