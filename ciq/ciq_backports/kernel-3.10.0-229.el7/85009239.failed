[SCSI] hpsa: add 5 second delay after doorbell reset

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-229.el7
Rebuild_CHGLOG: - [scsi] hpsa: add 5 second delay after doorbell reset (Tomas Henzl) [1069185]
Rebuild_FUZZ: 92.78%
commit-author Stephen M. Cameron <scameron@beardog.cce.hp.com>
commit 85009239477a9b0b06d068d6ead9226d5c809a82
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-229.el7/85009239.failed

The hardware guys tell us that after initiating a software
reset via the doorbell register we need to wait 5 seconds before
attempting to talk to the board *at all*.  This means that we
cannot watch the board to verify it transitions from "ready" to
to "not ready" then back "ready", since this transition will
most likely happen during those 5 seconds (though we can still
verify the reset happens by watching the "driver version" field
get cleared.)

	Signed-off-by: Stephen M. Cameron <scameron@beardog.cce.hp.com>
	Signed-off-by: James Bottomley <JBottomley@Parallels.com>
(cherry picked from commit 85009239477a9b0b06d068d6ead9226d5c809a82)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/hpsa.c
diff --cc drivers/scsi/hpsa.c
index 11c05c26db1b,2a71ab903d96..000000000000
--- a/drivers/scsi/hpsa.c
+++ b/drivers/scsi/hpsa.c
@@@ -3991,6 -3988,23 +3998,26 @@@ static int hpsa_kdump_hard_reset_contro
  	   need a little pause here */
  	msleep(HPSA_POST_RESET_PAUSE_MSECS);
  
++<<<<<<< HEAD
++=======
+ 	if (!use_doorbell) {
+ 		/* Wait for board to become not ready, then ready.
+ 		 * (if we used the doorbell, then we already waited 5 secs
+ 		 * so the "not ready" state is already gone by so we
+ 		 * won't catch it.)
+ 		 */
+ 		dev_info(&pdev->dev, "Waiting for board to reset.\n");
+ 		rc = hpsa_wait_for_board_state(pdev, vaddr, BOARD_NOT_READY);
+ 		if (rc) {
+ 			dev_warn(&pdev->dev,
+ 				"failed waiting for board to reset."
+ 				" Will try soft reset.\n");
+ 			/* Not expected, but try soft reset later */
+ 			rc = -ENOTSUPP;
+ 			goto unmap_cfgtable;
+ 		}
+ 	}
++>>>>>>> 85009239477a ([SCSI] hpsa: add 5 second delay after doorbell reset)
  	rc = hpsa_wait_for_board_state(pdev, vaddr, BOARD_READY);
  	if (rc) {
  		dev_warn(&pdev->dev,
* Unmerged path drivers/scsi/hpsa.c
