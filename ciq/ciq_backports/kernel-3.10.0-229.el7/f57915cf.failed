ib_isert: Add max_send_sge=2 minimum for control PDU responses

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-229.el7
Rebuild_CHGLOG: - [ib_isert] Add max_send_sge=2 minimum for control PDU responses (Andy Grover) [1166314]
Rebuild_FUZZ: 91.23%
commit-author Or Gerlitz <ogerlitz@mellanox.com>
commit f57915cfa5b2b14c1cffa2e83c034f55e3f0e70d
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-229.el7/f57915cf.failed

This patch adds a max_send_sge=2 minimum in isert_conn_setup_qp()
to ensure outgoing control PDU responses with tx_desc->num_sge=2
are able to function correctly.

This addresses a bug with RDMA hardware using dev_attr.max_sge=3,
that in the original code with the ConnectX-2 work-around would
result in isert_conn->max_sge=1 being negotiated.

Originally reported by Chris with ocrdma driver.

	Reported-by: Chris Moore <Chris.Moore@emulex.com>
	Tested-by: Chris Moore <Chris.Moore@emulex.com>
	Signed-off-by: Or Gerlitz <ogerlitz@mellanox.com>
	Cc: <stable@vger.kernel.org> # 3.10+
	Signed-off-by: Nicholas Bellinger <nab@linux-iscsi.org>
(cherry picked from commit f57915cfa5b2b14c1cffa2e83c034f55e3f0e70d)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/ulp/isert/ib_isert.c
diff --cc drivers/infiniband/ulp/isert/ib_isert.c
index ec71464a2b6f,ef5b22b3ea83..000000000000
--- a/drivers/infiniband/ulp/isert/ib_isert.c
+++ b/drivers/infiniband/ulp/isert/ib_isert.c
@@@ -107,9 -115,12 +107,16 @@@ isert_conn_setup_qp(struct isert_conn *
  	attr.cap.max_recv_wr = ISERT_QP_MAX_RECV_DTOS;
  	/*
  	 * FIXME: Use devattr.max_sge - 2 for max_send_sge as
- 	 * work-around for RDMA_READ..
+ 	 * work-around for RDMA_READs with ConnectX-2.
+ 	 *
+ 	 * Also, still make sure to have at least two SGEs for
+ 	 * outgoing control PDU responses.
  	 */
++<<<<<<< HEAD
 +	attr.cap.max_send_sge = devattr.max_sge - 2;
++=======
+ 	attr.cap.max_send_sge = max(2, device->dev_attr.max_sge - 2);
++>>>>>>> f57915cfa5b2 (ib_isert: Add max_send_sge=2 minimum for control PDU responses)
  	isert_conn->max_sge = attr.cap.max_send_sge;
  
  	attr.cap.max_recv_sge = 1;
* Unmerged path drivers/infiniband/ulp/isert/ib_isert.c
