dm cache: fix some issues with the new discard range support

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-229.el7
Rebuild_CHGLOG: - [md] dm-cache: fix some issues with the new discard range support (Mike Snitzer) [1165050]
Rebuild_FUZZ: 98.33%
commit-author Joe Thornber <ejt@redhat.com>
commit 2572629a1318eb9e13e70fa59756d7bcfb80319e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-229.el7/2572629a.failed

Commit 7ae34e777 ("dm cache: improve discard support") needed to also:
- discontinue having DM core split the discard bios on cache block
  boundaries
- calculate the cache's discard_nr_blocks relative to the determined
  discard_block_size rather than using oblock_to_dblock()

	Signed-off-by: Joe Thornber <ejt@redhat.com>
	Signed-off-by: Mike Snitzer <snitzer@redhat.com>
(cherry picked from commit 2572629a1318eb9e13e70fa59756d7bcfb80319e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/md/dm-cache-target.c
diff --cc drivers/md/dm-cache-target.c
index e75d70ec363a,41e7cfdb450d..000000000000
--- a/drivers/md/dm-cache-target.c
+++ b/drivers/md/dm-cache-target.c
@@@ -2297,8 -2436,12 +2296,17 @@@ static int cache_create(struct cache_ar
  	}
  	clear_bitset(cache->dirty_bitset, from_cblock(cache->cache_size));
  
++<<<<<<< HEAD
 +	cache->discard_nr_blocks = cache->origin_blocks;
 +	cache->discard_bitset = alloc_bitset(from_oblock(cache->discard_nr_blocks));
++=======
+ 	cache->discard_block_size =
+ 		calculate_discard_block_size(cache->sectors_per_block,
+ 					     cache->origin_sectors);
+ 	cache->discard_nr_blocks = to_dblock(dm_sector_div_up(cache->origin_sectors,
+ 							      cache->discard_block_size));
+ 	cache->discard_bitset = alloc_bitset(from_dblock(cache->discard_nr_blocks));
++>>>>>>> 2572629a1318 (dm cache: fix some issues with the new discard range support)
  	if (!cache->discard_bitset) {
  		*error = "could not allocate discard bitset";
  		goto bad;
* Unmerged path drivers/md/dm-cache-target.c
