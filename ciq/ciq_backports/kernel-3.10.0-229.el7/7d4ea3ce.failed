xfs: use ranged writeback and invalidation for direct IO

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-229.el7
commit-author Dave Chinner <dchinner@redhat.com>
commit 7d4ea3ce63a6bc532abb334c469c18481798af8c
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-229.el7/7d4ea3ce.failed

Now we are not doing silly things with dirtying buffers beyond EOF
and using invalidation correctly, we can finally reduce the ranges of
writeback and invalidation used by direct IO to match that of the IO
being issued.

Bring the writeback and invalidation ranges back to match the
generic direct IO code - this will greatly reduce the perturbation
of cached data when direct IO and buffered IO are mixed, but still
provide the same buffered vs direct IO coherency behaviour we
currently have.

	Signed-off-by: Dave Chinner <dchinner@redhat.com>
	Reviewed-by: Brian Foster <bfoster@redhat.com>
	Reviewed-by: Christoph Hellwig <hch@lst.de>
	Signed-off-by: Dave Chinner <david@fromorbit.com>


(cherry picked from commit 7d4ea3ce63a6bc532abb334c469c18481798af8c)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/xfs/xfs_file.c
diff --cc fs/xfs/xfs_file.c
index 5b02668e1067,de5368c803f9..000000000000
--- a/fs/xfs/xfs_file.c
+++ b/fs/xfs/xfs_file.c
@@@ -689,10 -641,20 +690,23 @@@ xfs_file_dio_aio_write
  
  	if (mapping->nrpages) {
  		ret = filemap_write_and_wait_range(VFS_I(ip)->i_mapping,
- 						    pos, -1);
+ 						    pos, pos + count - 1);
  		if (ret)
  			goto out;
++<<<<<<< HEAD
 +		truncate_pagecache_range(VFS_I(ip), pos, -1);
++=======
+ 		/*
+ 		 * Invalidate whole pages. This can return an error if
+ 		 * we fail to invalidate a page, but this should never
+ 		 * happen on XFS. Warn if it does fail.
+ 		 */
+ 		ret = invalidate_inode_pages2_range(VFS_I(ip)->i_mapping,
+ 					pos >> PAGE_CACHE_SHIFT,
+ 					(pos + count - 1) >> PAGE_CACHE_SHIFT);
+ 		WARN_ON_ONCE(ret);
+ 		ret = 0;
++>>>>>>> 7d4ea3ce63a6 (xfs: use ranged writeback and invalidation for direct IO)
  	}
  
  	/*
* Unmerged path fs/xfs/xfs_file.c
