ALSA: hda - restore BCLK M/N values when resuming HSW/BDW display controller

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-229.el7
Rebuild_CHGLOG: - [alsa] hda: restore BCLK M/N values when resuming HSW/BDW display controller (Jaroslav Kysela) [1112200]
Rebuild_FUZZ: 93.79%
commit-author Mengdong Lin <mengdong.lin@intel.com>
commit a07187c992be945ab561b370cbb49cfd72064c3c
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-229.el7/a07187c9.failed

For Intel Haswell/Broadwell display HD-A controller, the 24MHz HD-A link BCLK
is converted from Core Display Clock (CDCLK): BCLK = CDCLK * M / N
And there are two registers EM4 and EM5 to program M, N value respectively.
The EM4/EM5 values will be lost and when the display power well is disabled.

BIOS programs CDCLK selected by OEM and EM4/EM5, but BIOS has no idea about
display power well on/off at runtime. So the M/N can be wrong if non-default
CDCLK is used when the audio controller resumes, which results in an invalid
BCLK and abnormal audio playback rate. So this patch saves and restores valid
M/N values on controller suspend/resume.

And 'struct hda_intel' is defined to contain standard HD-A 'struct azx' and
Intel specific fields, as Takashi suggested.

	Signed-off-by: Mengdong Lin <mengdong.lin@intel.com>
	Cc: <stable@vger.kernel.org>
	Signed-off-by: Takashi Iwai <tiwai@suse.de>
(cherry picked from commit a07187c992be945ab561b370cbb49cfd72064c3c)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	sound/pci/hda/hda_intel.c
diff --cc sound/pci/hda/hda_intel.c
index c74374a10f3c,25753db97071..000000000000
--- a/sound/pci/hda/hda_intel.c
+++ b/sound/pci/hda/hda_intel.c
@@@ -308,8 -288,23 +308,28 @@@ static char *driver_short_names[] = 
  	[AZX_DRIVER_GENERIC] = "HD-Audio Generic",
  };
  
++<<<<<<< HEAD
 +/* for pcm support */
 +#define get_azx_dev(substream) (substream->runtime->private_data)
++=======
+ 
+ /* Intel HSW/BDW display HDA controller Extended Mode registers.
+  * EM4 (M value) and EM5 (N Value) are used to convert CDClk (Core Display
+  * Clock) to 24MHz BCLK: BCLK = CDCLK * M / N
+  * The values will be lost when the display power well is disabled.
+  */
+ #define ICH6_REG_EM4			0x100c
+ #define ICH6_REG_EM5			0x1010
+ 
+ struct hda_intel {
+ 	struct azx chip;
+ 
+ 	/* HSW/BDW display HDA controller to restore BCLK from CDCLK */
+ 	unsigned int bclk_m;
+ 	unsigned int bclk_n;
+ };
+ 
++>>>>>>> a07187c992be (ALSA: hda - restore BCLK M/N values when resuming HSW/BDW display controller)
  
  #ifdef CONFIG_X86
  static void __mark_pages_wc(struct azx *chip, struct snd_dma_buffer *dmab, bool on)
@@@ -3178,9 -1233,9 +3230,15 @@@ static int azx_create(struct snd_card *
  	if (err < 0)
  		return err;
  
++<<<<<<< HEAD
 +	chip = kzalloc(sizeof(*chip), GFP_KERNEL);
 +	if (!chip) {
 +		snd_printk(KERN_ERR SFX "%s: Cannot allocate chip\n", pci_name(pci));
++=======
+ 	hda = kzalloc(sizeof(*hda), GFP_KERNEL);
+ 	if (!hda) {
+ 		dev_err(card->dev, "Cannot allocate hda\n");
++>>>>>>> a07187c992be (ALSA: hda - restore BCLK M/N values when resuming HSW/BDW display controller)
  		pci_disable_device(pci);
  		return -ENOMEM;
  	}
* Unmerged path sound/pci/hda/hda_intel.c
