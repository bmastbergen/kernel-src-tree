xprtrdma: Rename frmr_wr

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-229.el7
commit-author Chuck Lever <chuck.lever@oracle.com>
commit f590e878c52c38046fd7cfa5a742ddae68717484
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-229.el7/f590e878.failed

Clean up: Name frmr_wr after the opcode of the Work Request,
consistent with the send and local invalidation paths.

	Signed-off-by: Chuck Lever <chuck.lever@oracle.com>
	Tested-by: Steve Wise <swise@opengridcomputing.com>
	Tested-by: Shirley Ma <shirley.ma@oracle.com>
	Tested-by: Devesh Sharma <devesh.sharma@emulex.com>
	Signed-off-by: Anna Schumaker <Anna.Schumaker@Netapp.com>
(cherry picked from commit f590e878c52c38046fd7cfa5a742ddae68717484)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/sunrpc/xprtrdma/verbs.c
diff --cc net/sunrpc/xprtrdma/verbs.c
index 499e0d7e7773,80c01638a66b..000000000000
--- a/net/sunrpc/xprtrdma/verbs.c
+++ b/net/sunrpc/xprtrdma/verbs.c
@@@ -1509,8 -1684,10 +1509,15 @@@ rpcrdma_register_frmr_external(struct r
  			struct rpcrdma_xprt *r_xprt)
  {
  	struct rpcrdma_mr_seg *seg1 = seg;
++<<<<<<< HEAD
 +	struct ib_send_wr invalidate_wr, frmr_wr, *bad_wr, *post_wr;
 +
++=======
+ 	struct rpcrdma_mw *mw = seg1->mr_chunk.rl_mw;
+ 	struct rpcrdma_frmr *frmr = &mw->r.frmr;
+ 	struct ib_mr *mr = frmr->fr_mr;
+ 	struct ib_send_wr fastreg_wr, *bad_wr;
++>>>>>>> f590e878c52c (xprtrdma: Rename frmr_wr)
  	u8 key;
  	int len, pageoff;
  	int i, rc;
@@@ -1541,52 -1717,34 +1548,71 @@@
  			break;
  	}
  	dprintk("RPC:       %s: Using frmr %p to map %d segments\n",
 -		__func__, mw, i);
 -
 -	frmr->fr_state = FRMR_IS_VALID;
 +		__func__, seg1->mr_chunk.rl_mw, i);
  
 +	if (unlikely(seg1->mr_chunk.rl_mw->r.frmr.state == FRMR_IS_VALID)) {
 +		dprintk("RPC:       %s: frmr %x left valid, posting invalidate.\n",
 +			__func__,
 +			seg1->mr_chunk.rl_mw->r.frmr.fr_mr->rkey);
 +		/* Invalidate before using. */
 +		memset(&invalidate_wr, 0, sizeof invalidate_wr);
 +		invalidate_wr.wr_id = (unsigned long)(void *)seg1->mr_chunk.rl_mw;
 +		invalidate_wr.next = &frmr_wr;
 +		invalidate_wr.opcode = IB_WR_LOCAL_INV;
 +		invalidate_wr.send_flags = IB_SEND_SIGNALED;
 +		invalidate_wr.ex.invalidate_rkey =
 +			seg1->mr_chunk.rl_mw->r.frmr.fr_mr->rkey;
 +		DECR_CQCOUNT(&r_xprt->rx_ep);
 +		post_wr = &invalidate_wr;
 +	} else
 +		post_wr = &frmr_wr;
 +
++<<<<<<< HEAD
 +	/* Prepare FRMR WR */
 +	memset(&frmr_wr, 0, sizeof frmr_wr);
 +	frmr_wr.wr_id = (unsigned long)(void *)seg1->mr_chunk.rl_mw;
 +	frmr_wr.opcode = IB_WR_FAST_REG_MR;
 +	frmr_wr.send_flags = IB_SEND_SIGNALED;
 +	frmr_wr.wr.fast_reg.iova_start = seg1->mr_dma;
 +	frmr_wr.wr.fast_reg.page_list = seg1->mr_chunk.rl_mw->r.frmr.fr_pgl;
 +	frmr_wr.wr.fast_reg.page_list_len = page_no;
 +	frmr_wr.wr.fast_reg.page_shift = PAGE_SHIFT;
 +	frmr_wr.wr.fast_reg.length = page_no << PAGE_SHIFT;
 +	if (frmr_wr.wr.fast_reg.length < len) {
++=======
+ 	memset(&fastreg_wr, 0, sizeof(fastreg_wr));
+ 	fastreg_wr.wr_id = (unsigned long)(void *)mw;
+ 	fastreg_wr.opcode = IB_WR_FAST_REG_MR;
+ 	fastreg_wr.wr.fast_reg.iova_start = seg1->mr_dma;
+ 	fastreg_wr.wr.fast_reg.page_list = frmr->fr_pgl;
+ 	fastreg_wr.wr.fast_reg.page_list_len = page_no;
+ 	fastreg_wr.wr.fast_reg.page_shift = PAGE_SHIFT;
+ 	fastreg_wr.wr.fast_reg.length = page_no << PAGE_SHIFT;
+ 	if (fastreg_wr.wr.fast_reg.length < len) {
++>>>>>>> f590e878c52c (xprtrdma: Rename frmr_wr)
  		rc = -EIO;
  		goto out_err;
  	}
  
  	/* Bump the key */
 -	key = (u8)(mr->rkey & 0x000000FF);
 -	ib_update_fast_reg_key(mr, ++key);
 +	key = (u8)(seg1->mr_chunk.rl_mw->r.frmr.fr_mr->rkey & 0x000000FF);
 +	ib_update_fast_reg_key(seg1->mr_chunk.rl_mw->r.frmr.fr_mr, ++key);
  
- 	frmr_wr.wr.fast_reg.access_flags = (writing ?
+ 	fastreg_wr.wr.fast_reg.access_flags = (writing ?
  				IB_ACCESS_REMOTE_WRITE | IB_ACCESS_LOCAL_WRITE :
  				IB_ACCESS_REMOTE_READ);
++<<<<<<< HEAD
 +	frmr_wr.wr.fast_reg.rkey = seg1->mr_chunk.rl_mw->r.frmr.fr_mr->rkey;
 +	DECR_CQCOUNT(&r_xprt->rx_ep);
 +
 +	rc = ib_post_send(ia->ri_id->qp, post_wr, &bad_wr);
 +
++=======
+ 	fastreg_wr.wr.fast_reg.rkey = mr->rkey;
+ 	DECR_CQCOUNT(&r_xprt->rx_ep);
+ 
+ 	rc = ib_post_send(ia->ri_id->qp, &fastreg_wr, &bad_wr);
++>>>>>>> f590e878c52c (xprtrdma: Rename frmr_wr)
  	if (rc) {
  		dprintk("RPC:       %s: failed ib_post_send for register,"
  			" status %i\n", __func__, rc);
* Unmerged path net/sunrpc/xprtrdma/verbs.c
