drm/i915: Fix EIO/wedged handling in gem fault handler

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-229.el7
Rebuild_CHGLOG: - [drm] i915: Fix EIO/wedged handling in gem fault handler (Rob Clark) [1153301]
Rebuild_FUZZ: 96.15%
commit-author Daniel Vetter <daniel.vetter@ffwll.ch>
commit 2232f0315c6688f5ff6b2067ea88d97542034873
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-229.el7/2232f031.failed

In

commit 1f83fee08d625f8d0130f9fe5ef7b17c2e022f3c
Author: Daniel Vetter <daniel.vetter@ffwll.ch>
Date:   Thu Nov 15 17:17:22 2012 +0100

    drm/i915: clear up wedged transitions

I've accidentally inverted the EIO/wedged handling in the fault
handler: We want to return the EIO as a SIGBUS only if it's not
because of the gpu having died, to prevent userspace from unduly
dying.

In my defence the comment right above is completely misleading, so fix
both.

v2: Drop the WARN_ON, it's not actually a bug to e.g. receive an -EIO
when swap-in fails.

v3: Don't remove too much ... oops.

	Reported-by: Chris Wilson <chris@chris-wilson.co.uk>
	Cc: Chris Wilson <chris@chris-wilson.co.uk>
	Cc: stable@vger.kernel.org
	Signed-off-by: Daniel Vetter <daniel.vetter@intel.com>
	Reviewed-by: Chris Wilson <chris@chris-wilson.co.uk>
	Signed-off-by: Jani Nikula <jani.nikula@intel.com>
(cherry picked from commit 2232f0315c6688f5ff6b2067ea88d97542034873)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/gpu/drm/i915/i915_gem.c
diff --cc drivers/gpu/drm/i915/i915_gem.c
index 280127ee6ffb,ad55b06a3cb1..000000000000
--- a/drivers/gpu/drm/i915/i915_gem.c
+++ b/drivers/gpu/drm/i915/i915_gem.c
@@@ -1384,11 -1590,16 +1384,24 @@@ unlock
  out:
  	switch (ret) {
  	case -EIO:
++<<<<<<< HEAD
 +		/* If this -EIO is due to a gpu hang, give the reset code a
 +		 * chance to clean up the mess. Otherwise return the proper
 +		 * SIGBUS. */
 +		if (i915_terminally_wedged(&dev_priv->gpu_error))
 +			return VM_FAULT_SIGBUS;
++=======
+ 		/*
+ 		 * We eat errors when the gpu is terminally wedged to avoid
+ 		 * userspace unduly crashing (gl has no provisions for mmaps to
+ 		 * fail). But any other -EIO isn't ours (e.g. swap in failure)
+ 		 * and so needs to be reported.
+ 		 */
+ 		if (!i915_terminally_wedged(&dev_priv->gpu_error)) {
+ 			ret = VM_FAULT_SIGBUS;
+ 			break;
+ 		}
++>>>>>>> 2232f0315c66 (drm/i915: Fix EIO/wedged handling in gem fault handler)
  	case -EAGAIN:
  		/*
  		 * EAGAIN means the gpu is hung and we'll wait for the error
* Unmerged path drivers/gpu/drm/i915/i915_gem.c
