powerpc/PCI: Fix NULL dereference in sys_pciconfig_iobase() list traversal

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-229.el7
Rebuild_CHGLOG: - [powerpc] pci: Fix NULL dereference in sys_pciconfig_iobase() list traversal (Myron Stowe) [1110896]
Rebuild_FUZZ: 94.29%
commit-author Mike Qiu <qiudayu@linux.vnet.ibm.com>
commit ff0c41b2df1577f3354f788af4f6bb5dbdfd26da
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-229.el7/ff0c41b2.failed

3bc955987fb3 ("powerpc/PCI: Use list_for_each_entry() for bus traversal")
caused a NULL pointer dereference because the loop body set the iterator to
NULL:

  Unable to handle kernel paging request for data at address 0x00000000
  Faulting instruction address: 0xc000000000041d78
  Oops: Kernel access of bad area, sig: 11 [#1]
  ...
  NIP [c000000000041d78] .sys_pciconfig_iobase+0x68/0x1f0
  LR [c000000000041e0c] .sys_pciconfig_iobase+0xfc/0x1f0
  Call Trace:
  [c0000003b4787db0] [c000000000041e0c] .sys_pciconfig_iobase+0xfc/0x1f0 (unreliable)
  [c0000003b4787e30] [c000000000009ed8] syscall_exit+0x0/0x98

Fix it by using a temporary variable for the iterator.

[bhelgaas: changelog, drop tmp_bus initialization]
Fixes: 3bc955987fb3 powerpc/PCI: Use list_for_each_entry() for bus traversal
	Signed-off-by: Mike Qiu <qiudayu@linux.vnet.ibm.com>
	Signed-off-by: Bjorn Helgaas <bhelgaas@google.com>
(cherry picked from commit ff0c41b2df1577f3354f788af4f6bb5dbdfd26da)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/powerpc/kernel/pci_64.c
diff --cc arch/powerpc/kernel/pci_64.c
index cdf5aa1411bf,155013da27e0..000000000000
--- a/arch/powerpc/kernel/pci_64.c
+++ b/arch/powerpc/kernel/pci_64.c
@@@ -208,8 -208,7 +208,12 @@@ long sys_pciconfig_iobase(long which, u
  			  unsigned long in_devfn)
  {
  	struct pci_controller* hose;
++<<<<<<< HEAD
 +	struct list_head *ln;
 +	struct pci_bus *bus = NULL;
++=======
+ 	struct pci_bus *tmp_bus, *bus = NULL;
++>>>>>>> ff0c41b2df15 (powerpc/PCI: Fix NULL dereference in sys_pciconfig_iobase() list traversal)
  	struct device_node *hose_node;
  
  	/* Argh ! Please forgive me for that hack, but that's the
@@@ -230,11 -229,12 +234,18 @@@
  	 * used on pre-domains setup. We return the first match
  	 */
  
++<<<<<<< HEAD
 +	for (ln = pci_root_buses.next; ln != &pci_root_buses; ln = ln->next) {
 +		bus = pci_bus_b(ln);
 +		if (in_bus >= bus->number && in_bus <= bus->busn_res.end)
++=======
+ 	list_for_each_entry(tmp_bus, &pci_root_buses, node) {
+ 		if (in_bus >= tmp_bus->number &&
+ 		    in_bus <= tmp_bus->busn_res.end) {
+ 			bus = tmp_bus;
++>>>>>>> ff0c41b2df15 (powerpc/PCI: Fix NULL dereference in sys_pciconfig_iobase() list traversal)
  			break;
- 		bus = NULL;
+ 		}
  	}
  	if (bus == NULL || bus->dev.of_node == NULL)
  		return -ENODEV;
* Unmerged path arch/powerpc/kernel/pci_64.c
