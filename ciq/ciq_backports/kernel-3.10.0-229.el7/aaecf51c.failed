qlcnic: Limit vNIC support in legacy interrupt mode

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-229.el7
commit-author Sucheta Chakraborty <sucheta.chakraborty@qlogic.com>
commit aaecf51cf31160262b29a6d50f364f4a76c7ed1e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-229.el7/aaecf51c.failed

o When the driver loads in legacy interrupt mode, only vNICs
  with PCI function number 0-7 are supported.

	Signed-off-by: Sucheta Chakraborty <sucheta.chakraborty@qlogic.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit aaecf51cf31160262b29a6d50f364f4a76c7ed1e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/qlogic/qlcnic/qlcnic_83xx_hw.c
diff --cc drivers/net/ethernet/qlogic/qlcnic/qlcnic_83xx_hw.c
index f09be3298853,7c125d7fb547..000000000000
--- a/drivers/net/ethernet/qlogic/qlcnic/qlcnic_83xx_hw.c
+++ b/drivers/net/ethernet/qlogic/qlcnic/qlcnic_83xx_hw.c
@@@ -299,13 -357,15 +300,25 @@@ int qlcnic_83xx_setup_intr(struct qlcni
  				sizeof(struct qlcnic_intrpt_config));
  	if (!ahw->intr_tbl)
  		return -ENOMEM;
++<<<<<<< HEAD
 +	if (!(adapter->flags & QLCNIC_MSIX_ENABLED)) {
 +		/* MSI-X enablement failed, use legacy interrupt */
 +		adapter->tgt_status_reg = ahw->pci_base0 + QLC_83XX_INTX_PTR;
 +		adapter->tgt_mask_reg = ahw->pci_base0 + QLC_83XX_INTX_MASK;
 +		adapter->isr_int_vec = ahw->pci_base0 + QLC_83XX_INTX_TRGR;
 +		adapter->msix_entries[0].vector = adapter->pdev->irq;
 +		dev_info(&adapter->pdev->dev, "using legacy interrupt\n");
++=======
+ 
+ 	if (!(adapter->flags & QLCNIC_MSIX_ENABLED)) {
+ 		if (adapter->ahw->pci_func >= QLC_MAX_LEGACY_FUNC_SUPP) {
+ 			dev_err(&adapter->pdev->dev, "PCI function number 8 and higher are not supported with legacy interrupt, func 0x%x\n",
+ 				ahw->pci_func);
+ 			return -EOPNOTSUPP;
+ 		}
+ 
+ 		qlcnic_83xx_enable_legacy(adapter);
++>>>>>>> aaecf51cf311 (qlcnic: Limit vNIC support in legacy interrupt mode)
  	}
  
  	for (i = 0; i < num_msix; i++) {
* Unmerged path drivers/net/ethernet/qlogic/qlcnic/qlcnic_83xx_hw.c
diff --git a/drivers/net/ethernet/qlogic/qlcnic/qlcnic_main.c b/drivers/net/ethernet/qlogic/qlcnic/qlcnic_main.c
index 9918316d26ed..7fb4240fd41c 100644
--- a/drivers/net/ethernet/qlogic/qlcnic/qlcnic_main.c
+++ b/drivers/net/ethernet/qlogic/qlcnic/qlcnic_main.c
@@ -2342,6 +2342,9 @@ qlcnic_probe(struct pci_dev *pdev, const struct pci_device_id *ent)
 			case -ENOMEM:
 				dev_err(&pdev->dev, "Adapter initialization failed. Please reboot\n");
 				goto err_out_free_hw;
+			case -EOPNOTSUPP:
+				dev_err(&pdev->dev, "Adapter initialization failed\n");
+				goto err_out_free_hw;
 			default:
 				dev_err(&pdev->dev, "Adapter initialization failed. Driver will load in maintenance mode to recover the adapter using the application\n");
 				goto err_out_maintenance_mode;
