blk-mq: limit memory consumption if a crash dump is active

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-229.el7
commit-author Jens Axboe <axboe@fb.com>
commit aedcd72f6c283dffefbb8b808ae67bdd2c6eb11a
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-229.el7/aedcd72f.failed

It's not uncommon for crash dump kernels to be limited to 128MB or
something low in that area. This is normally not a problem for
devices as we don't use that much memory, but for some shared SCSI
setups with huge queue depths, it can potentially fill most of
memory with tons of request allocations. blk-mq does scale back
when it fails to allocate memory, but it scales back just enough
so that blk-mq succeeds. This could still leave the system with
not enough memory to make any real progress.

Check if we are in a kdump environment and limit the hardware
queues and tag depth.

	Signed-off-by: Jens Axboe <axboe@fb.com>
(cherry picked from commit aedcd72f6c283dffefbb8b808ae67bdd2c6eb11a)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	block/blk-mq.c
diff --cc block/blk-mq.c
index 6fcf1deefe8d,c5345a951820..000000000000
--- a/block/blk-mq.c
+++ b/block/blk-mq.c
@@@ -1331,8 -1743,18 +1332,23 @@@ struct request_queue *blk_mq_init_queue
  	if (!ctx)
  		return ERR_PTR(-ENOMEM);
  
++<<<<<<< HEAD
 +	hctxs = kmalloc_node(reg->nr_hw_queues * sizeof(*hctxs), GFP_KERNEL,
 +			reg->numa_node);
++=======
+ 	/*
+ 	 * If a crashdump is active, then we are potentially in a very
+ 	 * memory constrained environment. Limit us to 1 queue and
+ 	 * 64 tags to prevent using too much memory.
+ 	 */
+ 	if (is_kdump_kernel()) {
+ 		set->nr_hw_queues = 1;
+ 		set->queue_depth = min(64U, set->queue_depth);
+ 	}
+ 
+ 	hctxs = kmalloc_node(set->nr_hw_queues * sizeof(*hctxs), GFP_KERNEL,
+ 			set->numa_node);
++>>>>>>> aedcd72f6c28 (blk-mq: limit memory consumption if a crash dump is active)
  
  	if (!hctxs)
  		goto err_percpu;
* Unmerged path block/blk-mq.c
