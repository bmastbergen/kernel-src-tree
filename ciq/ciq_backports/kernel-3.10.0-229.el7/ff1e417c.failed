mac80211: schedule the actual switch of the station before CSA count 0

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-229.el7
commit-author Luciano Coelho <luciano.coelho@intel.com>
commit ff1e417c7c239b7abfe70aa90460a77eaafc7f83
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-229.el7/ff1e417c.failed

Due to the time it takes to process the beacon that started the CSA
process, we may be late for the switch if we try to reach exactly
beacon 0.  To avoid that, use count - 1 when calculating the switch time.

	Cc: stable@vger.kernel.org
	Reported-by: Jouni Malinen <j@w1.fi>
	Signed-off-by: Luciano Coelho <luciano.coelho@intel.com>
	Signed-off-by: Johannes Berg <johannes.berg@intel.com>
(cherry picked from commit ff1e417c7c239b7abfe70aa90460a77eaafc7f83)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/mac80211/mlme.c
diff --cc net/mac80211/mlme.c
index b7830baa1cd5,93af0f1c9d99..000000000000
--- a/net/mac80211/mlme.c
+++ b/net/mac80211/mlme.c
@@@ -1265,13 -1168,16 +1265,18 @@@ ieee80211_sta_process_chanswitch(struc
  		ieee80211_queue_work(&local->hw, &ifmgd->chswitch_work);
  	else
  		mod_timer(&ifmgd->chswitch_timer,
++<<<<<<< HEAD
 +			  TU_TO_EXP_TIME(count * cbss->beacon_interval));
++=======
+ 			  TU_TO_EXP_TIME((csa_ie.count - 1) *
+ 					 cbss->beacon_interval));
++>>>>>>> ff1e417c7c23 (mac80211: schedule the actual switch of the station before CSA count 0)
  }
  
 -static bool
 -ieee80211_find_80211h_pwr_constr(struct ieee80211_sub_if_data *sdata,
 -				 struct ieee80211_channel *channel,
 -				 const u8 *country_ie, u8 country_ie_len,
 -				 const u8 *pwr_constr_elem,
 -				 int *chan_pwr, int *pwr_reduction)
 +static u32 ieee80211_handle_pwr_constr(struct ieee80211_sub_if_data *sdata,
 +				       struct ieee80211_channel *channel,
 +				       const u8 *country_ie, u8 country_ie_len,
 +				       const u8 *pwr_constr_elem)
  {
  	struct ieee80211_country_ie_triplet *triplet;
  	int chan = ieee80211_frequency_to_channel(channel->center_freq);
* Unmerged path net/mac80211/mlme.c
