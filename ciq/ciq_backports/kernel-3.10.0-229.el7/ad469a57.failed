[SCSI] scsi_error: disable eh_deadline if no host_reset_handler is set

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-229.el7
Rebuild_CHGLOG: - [scsi] scsi_error: disable eh_deadline if no host_reset_handler is set (Ewan Milne) [1132092]
Rebuild_FUZZ: 94.74%
commit-author Hannes Reinecke <hare@suse.de>
commit ad469a57643b322dc7a3bfc482e265e1e88f735a
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-229.el7/ad469a57.failed

When the host template doesn't declare an eh_host_reset_handler
the eh_deadline mechanism is pointless and will set the
device to offline. So disable eh_deadline if no
eh_host_reset_handler is present.

	Signed-off-by: Hannes Reinecke <hare@suse.de>
	Signed-off-by: James Bottomley <JBottomley@Parallels.com>
(cherry picked from commit ad469a57643b322dc7a3bfc482e265e1e88f735a)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/hosts.c
diff --cc drivers/scsi/hosts.c
index fed9ef108906,3cbb57a8b846..000000000000
--- a/drivers/scsi/hosts.c
+++ b/drivers/scsi/hosts.c
@@@ -397,7 -397,8 +397,12 @@@ struct Scsi_Host *scsi_host_alloc(struc
  	shost->use_clustering = sht->use_clustering;
  	shost->ordered_tag = sht->ordered_tag;
  	shost->no_write_same = sht->no_write_same;
++<<<<<<< HEAD
 +	if (shost_eh_deadline == -1)
++=======
+ 
+ 	if (shost_eh_deadline == -1 || !sht->eh_host_reset_handler)
++>>>>>>> ad469a57643b ([SCSI] scsi_error: disable eh_deadline if no host_reset_handler is set)
  		shost->eh_deadline = -1;
  	else if ((ulong) shost_eh_deadline * HZ > INT_MAX) {
  		shost_printk(KERN_WARNING, shost,
* Unmerged path drivers/scsi/hosts.c
diff --git a/drivers/scsi/scsi_sysfs.c b/drivers/scsi/scsi_sysfs.c
index 196e59ae746f..511f83142822 100644
--- a/drivers/scsi/scsi_sysfs.c
+++ b/drivers/scsi/scsi_sysfs.c
@@ -300,7 +300,9 @@ store_shost_eh_deadline(struct device *dev, struct device_attribute *attr,
 	int ret = -EINVAL;
 	unsigned long deadline, flags;
 
-	if (shost->transportt && shost->transportt->eh_strategy_handler)
+	if (shost->transportt &&
+	    (shost->transportt->eh_strategy_handler ||
+	     !shost->hostt->eh_host_reset_handler))
 		return ret;
 
 	if (!strncmp(buf, "off", strlen("off")))
