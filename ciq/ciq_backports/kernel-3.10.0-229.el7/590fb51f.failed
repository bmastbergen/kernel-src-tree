vfs: call d_op->d_prune() before unhashing dentry

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-229.el7
commit-author Yan, Zheng <zheng.z.yan@intel.com>
commit 590fb51f1cf99c4a48a3b1bd65885192e877b561
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-229.el7/590fb51f.failed

The d_prune dentry operation is used to notify filesystem when VFS
about to prune a hashed dentry from the dcache. There are three
code paths that prune dentries: shrink_dcache_for_umount_subtree(),
prune_dcache_sb() and d_prune_aliases(). For the d_prune_aliases()
case, VFS unhashes the dentry first, then call the d_prune dentry
operation. This confuses ceph_d_prune() (ceph uses the d_prune
dentry operation to maintain a flag indicating whether the complete
contents of a directory are in the dcache, pruning unhashed dentry
does not affect dir's completeness)

This patch fixes the issue by calling the d_prune dentry operation
in d_prune_aliases(), before unhashing the dentry. Also make VFS
only call the d_prune dentry operation for hashed dentry, to avoid
calling the d_prune dentry operation twice when dentry is pruned
by d_prune_aliases().

	Signed-off-by: Yan, Zheng <zheng.z.yan@intel.com>
	Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
(cherry picked from commit 590fb51f1cf99c4a48a3b1bd65885192e877b561)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/dcache.c
diff --cc fs/dcache.c
index 2b5ecf22ac33,2e5f9ca83285..000000000000
--- a/fs/dcache.c
+++ b/fs/dcache.c
@@@ -758,7 -718,15 +758,19 @@@ restart
  	spin_lock(&inode->i_lock);
  	hlist_for_each_entry(dentry, &inode->i_dentry, d_alias) {
  		spin_lock(&dentry->d_lock);
++<<<<<<< HEAD
 +		if (!dentry->d_lockref.count) {
++=======
+ 		if (!dentry->d_count) {
+ 			/*
+ 			 * inform the fs via d_prune that this dentry
+ 			 * is about to be unhashed and destroyed.
+ 			 */
+ 			if ((dentry->d_flags & DCACHE_OP_PRUNE) &&
+ 			    !d_unhashed(dentry))
+ 				dentry->d_op->d_prune(dentry);
+ 
++>>>>>>> 590fb51f1cf9 (vfs: call d_op->d_prune() before unhashing dentry)
  			__dget_dlock(dentry);
  			__d_drop(dentry);
  			spin_unlock(&dentry->d_lock);
* Unmerged path fs/dcache.c
