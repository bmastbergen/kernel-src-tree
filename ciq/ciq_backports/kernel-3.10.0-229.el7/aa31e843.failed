KVM: PPC: Book3S HV: Handle guest using doorbells for IPIs

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-229.el7
Rebuild_CHGLOG: - [virt] kvm/ppc: book3s hv - Handle guest using doorbells for IPIs (Don Zickus) [1127366]
Rebuild_FUZZ: 94.83%
commit-author Paul Mackerras <paulus@samba.org>
commit aa31e843225769735b79795c955426c9479046a5
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-229.el7/aa31e843.failed

* SRR1 wake reason field for system reset interrupt on wakeup from nap
  is now a 4-bit field on P8, compared to 3 bits on P7.

* Set PECEDP in LPCR when napping because of H_CEDE so guest doorbells
  will wake us up.

* Waking up from nap because of a guest doorbell interrupt is not a
  reason to exit the guest.

	Signed-off-by: Paul Mackerras <paulus@samba.org>
	Signed-off-by: Alexander Graf <agraf@suse.de>
(cherry picked from commit aa31e843225769735b79795c955426c9479046a5)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/powerpc/kvm/book3s_hv_rmhandlers.S
diff --cc arch/powerpc/kvm/book3s_hv_rmhandlers.S
index 4e71b0446184,9e89c7577b4a..000000000000
--- a/arch/powerpc/kvm/book3s_hv_rmhandlers.S
+++ b/arch/powerpc/kvm/book3s_hv_rmhandlers.S
@@@ -1819,6 -1971,37 +1822,40 @@@ machine_check_realmode
  	b	fast_interrupt_c_return
  
  /*
++<<<<<<< HEAD
++=======
+  * Check the reason we woke from nap, and take appropriate action.
+  * Returns:
+  *	0 if nothing needs to be done
+  *	1 if something happened that needs to be handled by the host
+  *	-1 if there was a guest wakeup (IPI)
+  *
+  * Also sets r12 to the interrupt vector for any interrupt that needs
+  * to be handled now by the host (0x500 for external interrupt), or zero.
+  */
+ kvmppc_check_wake_reason:
+ 	mfspr	r6, SPRN_SRR1
+ BEGIN_FTR_SECTION
+ 	rlwinm	r6, r6, 45-31, 0xf	/* extract wake reason field (P8) */
+ FTR_SECTION_ELSE
+ 	rlwinm	r6, r6, 45-31, 0xe	/* P7 wake reason field is 3 bits */
+ ALT_FTR_SECTION_END_IFSET(CPU_FTR_ARCH_207S)
+ 	cmpwi	r6, 8			/* was it an external interrupt? */
+ 	li	r12, BOOK3S_INTERRUPT_EXTERNAL
+ 	beq	kvmppc_read_intr	/* if so, see what it was */
+ 	li	r3, 0
+ 	li	r12, 0
+ 	cmpwi	r6, 6			/* was it the decrementer? */
+ 	beq	0f
+ BEGIN_FTR_SECTION
+ 	cmpwi	r6, 5			/* privileged doorbell? */
+ 	beq	0f
+ END_FTR_SECTION_IFSET(CPU_FTR_ARCH_207S)
+ 	li	r3, 1			/* anything else, return 1 */
+ 0:	blr
+ 
+ /*
++>>>>>>> aa31e8432257 (KVM: PPC: Book3S HV: Handle guest using doorbells for IPIs)
   * Determine what sort of external interrupt is pending (if any).
   * Returns:
   *	0 if no interrupt is pending
diff --git a/arch/powerpc/include/asm/reg.h b/arch/powerpc/include/asm/reg.h
index e983e00762dc..e557753a30f3 100644
--- a/arch/powerpc/include/asm/reg.h
+++ b/arch/powerpc/include/asm/reg.h
@@ -300,7 +300,9 @@
 #define   LPCR_ILE     0x02000000      /* !HV irqs set MSR:LE */
 #define   LPCR_AIL_0	0x00000000	/* MMU off exception offset 0x0 */
 #define   LPCR_AIL_3	0x01800000	/* MMU on exception offset 0xc00...4xxx */
-#define   LPCR_PECE	0x00007000	/* powersave exit cause enable */
+#define   LPCR_PECE	0x0001f000	/* powersave exit cause enable */
+#define     LPCR_PECEDP	0x00010000	/* directed priv dbells cause exit */
+#define     LPCR_PECEDH	0x00008000	/* directed hyp dbells cause exit */
 #define     LPCR_PECE0	0x00004000	/* ext. exceptions can cause exit */
 #define     LPCR_PECE1	0x00002000	/* decrementer can cause exit */
 #define     LPCR_PECE2	0x00001000	/* machine check etc can cause exit */
* Unmerged path arch/powerpc/kvm/book3s_hv_rmhandlers.S
