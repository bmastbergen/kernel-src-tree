netfilter: nft_hash: no need for rcu in the hash set destroy path

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-229.el7
commit-author Pablo Neira Ayuso <pablo@netfilter.org>
commit 39f390167e9ca73c009d3c8e2d6c3b4286b02ab6
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-229.el7/39f39016.failed

The sets are released from the rcu callback, after the rule is removed
from the chain list, which implies that nfnetlink cannot update the
hashes (thus, no resizing may occur) and no packets are walking on the
set anymore.

This resolves a lockdep splat in the nft_hash_destroy() path since the
nfnl mutex is not held there.

===============================
[ INFO: suspicious RCU usage. ]
3.16.0-rc2+ #168 Not tainted
-------------------------------
net/netfilter/nft_hash.c:362 suspicious rcu_dereference_protected() usage!

other info that might help us debug this:

rcu_scheduler_active = 1, debug_locks = 1
1 lock held by ksoftirqd/0/3:
 #0:  (rcu_callback){......}, at: [<ffffffff81096393>] rcu_process_callbacks+0x27e/0x4c7

stack backtrace:
CPU: 0 PID: 3 Comm: ksoftirqd/0 Not tainted 3.16.0-rc2+ #168
Hardware name: LENOVO 23259H1/23259H1, BIOS G2ET32WW (1.12 ) 05/30/2012
 0000000000000001 ffff88011769bb98 ffffffff8142c922 0000000000000006
 ffff880117694090 ffff88011769bbc8 ffffffff8107c3ff ffff8800cba52400
 ffff8800c476bea8 ffff8800c476bea8 ffff8800cba52400 ffff88011769bc08
Call Trace:
 [<ffffffff8142c922>] dump_stack+0x4e/0x68
 [<ffffffff8107c3ff>] lockdep_rcu_suspicious+0xfa/0x103
 [<ffffffffa079931e>] nft_hash_destroy+0x50/0x137 [nft_hash]
 [<ffffffffa078cd57>] nft_set_destroy+0x11/0x2a [nf_tables]

	Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
	Acked-by: Thomas Graf <tgraf@suug.ch>
(cherry picked from commit 39f390167e9ca73c009d3c8e2d6c3b4286b02ab6)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/netfilter/nft_hash.c
diff --cc net/netfilter/nft_hash.c
index 1dfeb6786832,8892b7b6184a..000000000000
--- a/net/netfilter/nft_hash.c
+++ b/net/netfilter/nft_hash.c
@@@ -361,19 -179,19 +361,34 @@@ static int nft_hash_init(const struct n
  
  static void nft_hash_destroy(const struct nft_set *set)
  {
++<<<<<<< HEAD
 +	const struct nft_hash *priv = nft_set_priv(set);
 +	const struct nft_hash_table *tbl = nft_dereference(priv->tbl);
++=======
+ 	const struct rhashtable *priv = nft_set_priv(set);
+ 	const struct bucket_table *tbl = priv->tbl;
++>>>>>>> 39f390167e9c (netfilter: nft_hash: no need for rcu in the hash set destroy path)
  	struct nft_hash_elem *he, *next;
  	unsigned int i;
  
  	for (i = 0; i < tbl->size; i++) {
++<<<<<<< HEAD
 +		for (he = nft_dereference(tbl->buckets[i]); he != NULL;
 +		     he = next) {
 +			next = nft_dereference(he->next);
 +			nft_hash_elem_destroy(set, he);
 +		}
 +	}
 +	kfree(tbl);
++=======
+ 		for (he = rht_entry(tbl->buckets[i], struct nft_hash_elem, node);
+ 		     he != NULL; he = next) {
+ 			next = rht_entry(he->node.next, struct nft_hash_elem, node);
+ 			nft_hash_elem_destroy(set, he);
+ 		}
+ 	}
+ 	rhashtable_destroy(priv);
++>>>>>>> 39f390167e9c (netfilter: nft_hash: no need for rcu in the hash set destroy path)
  }
  
  static bool nft_hash_estimate(const struct nft_set_desc *desc, u32 features,
* Unmerged path net/netfilter/nft_hash.c
