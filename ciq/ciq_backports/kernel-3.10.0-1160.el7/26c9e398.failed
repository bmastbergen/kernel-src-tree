vfio/mdev: Avoid creating sysfs remove file on stale device removal

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1160.el7
commit-author Parav Pandit <parav@mellanox.com>
commit 26c9e3988eec6b858c08b0fc352d8eb13832d828
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1160.el7/26c9e398.failed

If device is removal is initiated by two threads as below, mdev core
attempts to create a syfs remove file on stale device.
During this flow, below [1] call trace is observed.

     cpu-0                                    cpu-1
     -----                                    -----
  mdev_unregister_device()
    device_for_each_child
       mdev_device_remove_cb
          mdev_device_remove
                                       user_syscall
                                         remove_store()
                                           mdev_device_remove()
                                        [..]
   unregister device();
                                       /* not found in list or
                                        * active=false.
                                        */
                                          sysfs_create_file()
                                          ..Call trace

Now that mdev core follows correct device removal sequence of the linux
bus model, remove shouldn't fail in normal cases. If it fails, there is
no point of creating a stale file or checking for specific error status.

kernel: WARNING: CPU: 2 PID: 9348 at fs/sysfs/file.c:327
sysfs_create_file_ns+0x7f/0x90
kernel: CPU: 2 PID: 9348 Comm: bash Kdump: loaded Not tainted
5.1.0-rc6-vdevbus+ #6
kernel: Hardware name: Supermicro SYS-6028U-TR4+/X10DRU-i+, BIOS 2.0b
08/09/2016
kernel: RIP: 0010:sysfs_create_file_ns+0x7f/0x90
kernel: Call Trace:
kernel: remove_store+0xdc/0x100 [mdev]
kernel: kernfs_fop_write+0x113/0x1a0
kernel: vfs_write+0xad/0x1b0
kernel: ksys_write+0x5a/0xe0
kernel: do_syscall_64+0x5a/0x210
kernel: entry_SYSCALL_64_after_hwframe+0x49/0xbe

	Reviewed-by: Cornelia Huck <cohuck@redhat.com>
	Signed-off-by: Parav Pandit <parav@mellanox.com>
	Signed-off-by: Alex Williamson <alex.williamson@redhat.com>
(cherry picked from commit 26c9e3988eec6b858c08b0fc352d8eb13832d828)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/vfio/mdev/mdev_sysfs.c
diff --cc drivers/vfio/mdev/mdev_sysfs.c
index 75f18e6a31a1,ffa3dcebf201..000000000000
--- a/drivers/vfio/mdev/mdev_sysfs.c
+++ b/drivers/vfio/mdev/mdev_sysfs.c
@@@ -242,11 -233,12 +242,17 @@@ static ssize_t remove_store(struct devi
  	if (kstrtoul(buf, 0, &val) < 0)
  		return -EINVAL;
  
 -	if (val && device_remove_file_self(dev, attr)) {
 -		int ret;
 +	if (val) {
 +		int ret = device_schedule_callback(dev, remove_callback);
  
++<<<<<<< HEAD
 +		if (ret)
 +			count = ret;
++=======
+ 		ret = mdev_device_remove(dev);
+ 		if (ret)
+ 			return ret;
++>>>>>>> 26c9e3988eec (vfio/mdev: Avoid creating sysfs remove file on stale device removal)
  	}
  
  	return count;
* Unmerged path drivers/vfio/mdev/mdev_sysfs.c
