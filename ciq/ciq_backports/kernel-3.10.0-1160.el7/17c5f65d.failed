scsi: qla2xxx: Fix a NULL pointer dereference in an error path

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1160.el7
commit-author Bart Van Assche <bvanassche@acm.org>
commit 17c5f65db629a3bd95ac8eb960940b6fbb39a310
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1160.el7/17c5f65d.failed

This patch fixes the following Coverity complaint:

FORWARD_NULL

qla_init.c: 5275 in qla2x00_configure_local_loop()
5269
5270     		if (fcport->scan_state == QLA_FCPORT_FOUND)
5271     			qla24xx_fcport_handle_login(vha, fcport);
5272     	}
5273
5274     cleanup_allocation:
>>>     CID 353340:    (FORWARD_NULL)
>>>     Passing null pointer "new_fcport" to "qla2x00_free_fcport", which dereferences it.
5275     	qla2x00_free_fcport(new_fcport);
5276
5277     	if (rval != QLA_SUCCESS) {
5278     		ql_dbg(ql_dbg_disc, vha, 0x2098,
5279     		    "Configure local loop error exit: rval=%x.\n", rval);
5280     	}
qla_init.c: 5275 in qla2x00_configure_local_loop()
5269
5270     		if (fcport->scan_state == QLA_FCPORT_FOUND)
5271     			qla24xx_fcport_handle_login(vha, fcport);
5272     	}
5273
5274     cleanup_allocation:
>>>     CID 353340:    (FORWARD_NULL)
>>>     Passing null pointer "new_fcport" to "qla2x00_free_fcport", which dereferences it.
5275     	qla2x00_free_fcport(new_fcport);
5276
5277     	if (rval != QLA_SUCCESS) {
5278     		ql_dbg(ql_dbg_disc, vha, 0x2098,
5279     		    "Configure local loop error exit: rval=%x.\n", rval);
5280     	}

Fixes: 3dae220595ba ("scsi: qla2xxx: Use common routine to free fcport struct")
	Cc: Himanshu Madhani <hmadhani@marvell.com>
	Cc: Quinn Tran <qutran@marvell.com>
	Cc: Martin Wilck <mwilck@suse.com>
	Cc: Daniel Wagner <dwagner@suse.de>
	Cc: Roman Bolshakov <r.bolshakov@yadro.com>
Link: https://lore.kernel.org/r/20200118042056.32232-1-bvanassche@acm.org
	Signed-off-by: Bart Van Assche <bvanassche@acm.org>
	Reviewed-by: Ewan D. Milne <emilne@redhat.com>
	Reviewed-by: Daniel Wagner <dwagner@suse.de>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit 17c5f65db629a3bd95ac8eb960940b6fbb39a310)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/qla2xxx/qla_init.c
diff --cc drivers/scsi/qla2xxx/qla_init.c
index f980b85d84d4,9e6b56527b25..000000000000
--- a/drivers/scsi/qla2xxx/qla_init.c
+++ b/drivers/scsi/qla2xxx/qla_init.c
@@@ -5312,15 -5271,14 +5312,19 @@@ skip_login
  			qla24xx_fcport_handle_login(vha, fcport);
  	}
  
++<<<<<<< HEAD
 +cleanup_allocation:
 +	kfree(new_fcport);
++=======
+ 	qla2x00_free_fcport(new_fcport);
++>>>>>>> 17c5f65db629 (scsi: qla2xxx: Fix a NULL pointer dereference in an error path)
  
- 	if (rval != QLA_SUCCESS) {
- 		ql_dbg(ql_dbg_disc, vha, 0x2098,
- 		    "Configure local loop error exit: rval=%x.\n", rval);
- 	}
+ 	return rval;
  
- 	return (rval);
+ err:
+ 	ql_dbg(ql_dbg_disc, vha, 0x2098,
+ 	       "Configure local loop error exit: rval=%x.\n", rval);
+ 	return rval;
  }
  
  static void
* Unmerged path drivers/scsi/qla2xxx/qla_init.c
