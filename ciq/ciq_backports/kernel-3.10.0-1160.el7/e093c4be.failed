xfs: Fix tail rounding in xfs_alloc_file_space()

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1160.el7
commit-author Max Reitz <mreitz@redhat.com>
commit e093c4be760ebf46c131ae0dd6138865a22f46fa
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1160.el7/e093c4be.failed

To ensure that all blocks touched by the range [offset, offset + count)
are allocated, we need to calculate the block count from the difference
of the range end (rounded up) and the range start (rounded down).

Before this patch, we just round up the byte count, which may lead to
unaligned ranges not being fully allocated:

$ touch test_file
$ block_size=$(stat -fc '%S' test_file)
$ fallocate -o $((block_size / 2)) -l $block_size test_file
$ xfs_bmap test_file
test_file:
        0: [0..7]: 1396264..1396271
        1: [8..15]: hole

There should not be a hole there.  Instead, the first two blocks should
be fully allocated.

With this patch applied, the result is something like this:

$ touch test_file
$ block_size=$(stat -fc '%S' test_file)
$ fallocate -o $((block_size / 2)) -l $block_size test_file
$ xfs_bmap test_file
test_file:
        0: [0..15]: 11024..11039

	Signed-off-by: Max Reitz <mreitz@redhat.com>
	Reviewed-by: Carlos Maiolino <cmaiolino@redhat.com>
	Reviewed-by: Christoph Hellwig <hch@lst.de>
	Reviewed-by: Darrick J. Wong <darrick.wong@oracle.com>
	Signed-off-by: Darrick J. Wong <darrick.wong@oracle.com>
(cherry picked from commit e093c4be760ebf46c131ae0dd6138865a22f46fa)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/xfs/xfs_bmap_util.c
diff --cc fs/xfs/xfs_bmap_util.c
index 45d1fa3cff5e,4f443703065e..000000000000
--- a/fs/xfs/xfs_bmap_util.c
+++ b/fs/xfs/xfs_bmap_util.c
@@@ -848,7 -864,7 +848,11 @@@ xfs_alloc_file_space
  	xfs_filblks_t		allocatesize_fsb;
  	xfs_extlen_t		extsz, temp;
  	xfs_fileoff_t		startoffset_fsb;
++<<<<<<< HEAD
 +	xfs_fsblock_t		firstfsb;
++=======
+ 	xfs_fileoff_t		endoffset_fsb;
++>>>>>>> e093c4be760e (xfs: Fix tail rounding in xfs_alloc_file_space())
  	int			nimaps;
  	int			quota_flag;
  	int			rt;
* Unmerged path fs/xfs/xfs_bmap_util.c
