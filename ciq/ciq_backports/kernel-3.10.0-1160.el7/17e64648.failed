scsi: qla2xxx: Correct fcport flags handling

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1160.el7
commit-author Shyam Sundar <ssundar@marvell.com>
commit 17e64648aa476092eb959e6e431c7ec8f7bfd4e7
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1160.el7/17e64648.failed

This patch fixes some instances of FCF_ASYNC_{SENT|ACTIVE} flag setting and
clearning were missing.

Link: https://lore.kernel.org/r/20191217220617.28084-10-hmadhani@marvell.com
	Signed-off-by: Shyam Sundar <ssundar@marvell.com>
	Signed-off-by: Himanshu Madhani <hmadhani@marvell.com>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit 17e64648aa476092eb959e6e431c7ec8f7bfd4e7)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/qla2xxx/qla_iocb.c
diff --cc drivers/scsi/qla2xxx/qla_iocb.c
index 337fcd555ae5,47bf60a9490a..000000000000
--- a/drivers/scsi/qla2xxx/qla_iocb.c
+++ b/drivers/scsi/qla2xxx/qla_iocb.c
@@@ -3073,19 -3002,8 +3074,24 @@@ qla24xx_els_dcmd2_iocb(scsi_qla_host_t 
  	}
  
  out:
++<<<<<<< HEAD
 +	fcport->flags &= ~(FCF_ASYNC_SENT);
 +	if (elsio->u.els_plogi.els_plogi_pyld)
 +		dma_free_coherent(&sp->vha->hw->pdev->dev,
 +		    elsio->u.els_plogi.tx_size,
 +		    elsio->u.els_plogi.els_plogi_pyld,
 +		    elsio->u.els_plogi.els_plogi_pyld_dma);
 +
 +	if (elsio->u.els_plogi.els_resp_pyld)
 +		dma_free_coherent(&sp->vha->hw->pdev->dev,
 +		    elsio->u.els_plogi.rx_size,
 +		    elsio->u.els_plogi.els_resp_pyld,
 +		    elsio->u.els_plogi.els_resp_pyld_dma);
 +
++=======
+ 	fcport->flags &= ~(FCF_ASYNC_SENT | FCF_ASYNC_ACTIVE);
+ 	qla2x00_els_dcmd2_free(vha, &elsio->u.els_plogi);
++>>>>>>> 17e64648aa47 (scsi: qla2xxx: Correct fcport flags handling)
  	sp->free(sp);
  done:
  	return rval;
diff --git a/drivers/scsi/qla2xxx/qla_gs.c b/drivers/scsi/qla2xxx/qla_gs.c
index 295f856cb8b7..23b34b573fe7 100644
--- a/drivers/scsi/qla2xxx/qla_gs.c
+++ b/drivers/scsi/qla2xxx/qla_gs.c
@@ -2995,7 +2995,6 @@ int qla24xx_post_gpsc_work(struct scsi_qla_host *vha, fc_port_t *fcport)
 		return QLA_FUNCTION_FAILED;
 
 	e->u.fcport.fcport = fcport;
-	fcport->flags |= FCF_ASYNC_ACTIVE;
 	return qla2x00_post_work(vha, e);
 }
 
@@ -3130,9 +3129,7 @@ int qla24xx_async_gpsc(scsi_qla_host_t *vha, fc_port_t *fcport)
 
 done_free_sp:
 	sp->free(sp);
-	fcport->flags &= ~FCF_ASYNC_SENT;
 done:
-	fcport->flags &= ~FCF_ASYNC_ACTIVE;
 	return rval;
 }
 
@@ -4489,7 +4486,6 @@ int qla24xx_async_gfpnid(scsi_qla_host_t *vha, fc_port_t *fcport)
 
 done_free_sp:
 	sp->free(sp);
-	fcport->flags &= ~FCF_ASYNC_SENT;
 done:
 	return rval;
 }
diff --git a/drivers/scsi/qla2xxx/qla_init.c b/drivers/scsi/qla2xxx/qla_init.c
index c327139a9ced..aeae2eb9c35f 100644
--- a/drivers/scsi/qla2xxx/qla_init.c
+++ b/drivers/scsi/qla2xxx/qla_init.c
@@ -1132,8 +1132,8 @@ int qla24xx_async_gnl(struct scsi_qla_host *vha, fc_port_t *fcport)
 
 done_free_sp:
 	sp->free(sp);
-	fcport->flags &= ~FCF_ASYNC_SENT;
 done:
+	fcport->flags &= ~(FCF_ASYNC_ACTIVE | FCF_ASYNC_SENT);
 	return rval;
 }
 
@@ -1364,6 +1364,7 @@ done_free_sp:
 	sp->free(sp);
 	fcport->flags &= ~FCF_ASYNC_SENT;
 done:
+	fcport->flags &= ~FCF_ASYNC_ACTIVE;
 	qla24xx_post_gpdb_work(vha, fcport, opt);
 	return rval;
 }
* Unmerged path drivers/scsi/qla2xxx/qla_iocb.c
