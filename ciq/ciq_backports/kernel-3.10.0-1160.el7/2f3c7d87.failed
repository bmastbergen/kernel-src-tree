NFS: Remove racy size manipulations in O_DIRECT

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1160.el7
commit-author Trond Myklebust <trond.myklebust@primarydata.com>
commit 2f3c7d87a347b12f725f6128b3097727b91b230e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1160.el7/2f3c7d87.failed

On success, the RPC callbacks will ensure that we make the appropriate calls
to nfs_writeback_update_inode()

	Signed-off-by: Trond Myklebust <trond.myklebust@primarydata.com>
(cherry picked from commit 2f3c7d87a347b12f725f6128b3097727b91b230e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/nfs/direct.c
diff --cc fs/nfs/direct.c
index 245296715330,826d4dace0e5..000000000000
--- a/fs/nfs/direct.c
+++ b/fs/nfs/direct.c
@@@ -1188,14 -1049,9 +1179,17 @@@ ssize_t nfs_file_direct_write(struct ki
  	if (!result) {
  		result = nfs_direct_wait(dreq);
  		if (result > 0) {
- 			struct inode *inode = mapping->host;
- 
  			iocb->ki_pos = pos + result;
++<<<<<<< HEAD
 +			spin_lock(&inode->i_lock);
 +			if (i_size_read(inode) < iocb->ki_pos)
 +				i_size_write(inode, iocb->ki_pos);
 +			spin_unlock(&inode->i_lock);
 +			generic_write_sync(file, pos, result);
++=======
+ 			/* XXX: should check the generic_write_sync retval */
+ 			generic_write_sync(iocb, result);
++>>>>>>> 2f3c7d87a347 (NFS: Remove racy size manipulations in O_DIRECT)
  		}
  	}
  	nfs_direct_req_release(dreq);
* Unmerged path fs/nfs/direct.c
