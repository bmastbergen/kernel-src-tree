KVM: x86: do not reset microcode version on INIT or RESET

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1160.el7
commit-author Paolo Bonzini <pbonzini@redhat.com>
commit bab0c318ba3da32483da8aad37b9ef98fd8edafb
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1160.el7/bab0c318.failed

Do not initialize the microcode version at RESET or INIT, only on vCPU
creation.   Microcode updates are not lost during INIT, and exact
behavior across a warm RESET is not specified by the architecture.

Since we do not support a microcode update directly from the hypervisor,
but only as a result of userspace setting the microcode version MSR,
it's simpler for userspace if we do nothing in KVM and let userspace
emulate behavior for RESET as it sees fit.

Userspace can tie the fix to the availability of MSR_IA32_UCODE_REV in
the list of emulated MSRs.

	Reported-by: Alex Williamson <alex.williamson@redhat.com>
	Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
(cherry picked from commit bab0c318ba3da32483da8aad37b9ef98fd8edafb)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kvm/svm.c
#	arch/x86/kvm/vmx/vmx.c
diff --cc arch/x86/kvm/svm.c
index abee2f094107,bef0ba35f121..000000000000
--- a/arch/x86/kvm/svm.c
+++ b/arch/x86/kvm/svm.c
@@@ -1727,7 -2175,9 +1727,11 @@@ static void svm_vcpu_reset(struct kvm_v
  	u32 dummy;
  	u32 eax = 1;
  
++<<<<<<< HEAD
++=======
+ 	svm->spec_ctrl = 0;
++>>>>>>> bab0c318ba3d (KVM: x86: do not reset microcode version on INIT or RESET)
  	svm->virt_spec_ctrl = 0;
 -
  	if (!init_event) {
  		svm->vcpu.arch.apic_base = APIC_DEFAULT_PHYS_BASE |
  					   MSR_IA32_APICBASE_ENABLE;
@@@ -1819,9 -2264,10 +1823,14 @@@ static struct kvm_vcpu *svm_create_vcpu
  	svm->asid_generation = 0;
  	init_vmcb(svm);
  
++<<<<<<< HEAD
 +	svm_init_osvw(&svm->vcpu);
++=======
+ 	svm_init_osvw(vcpu);
+ 	vcpu->arch.microcode_version = 0x01000065;
++>>>>>>> bab0c318ba3d (KVM: x86: do not reset microcode version on INIT or RESET)
  
 -	return 0;
 +	return &svm->vcpu;
  
  free_page4:
  	__free_page(hsave_page);
* Unmerged path arch/x86/kvm/vmx/vmx.c
* Unmerged path arch/x86/kvm/svm.c
* Unmerged path arch/x86/kvm/vmx/vmx.c
