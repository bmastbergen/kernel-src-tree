r8169: fix broken Wake-on-LAN from S5 (poweroff)

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
commit-author Heiner Kallweit <hkallweit1@gmail.com>
commit 649f0837a8cc2b39329f2de00fa0d04b029291c5
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/649f0837.failed

It was reported that WoL from S5 is broken (WoL from S3 works) and the
analysis showed that during system shutdown the network interface was
brought down already when the actual kernel shutdown started.
Therefore netif_running() returned false and as a consequence the PHY
was suspended. Obviously WoL wasn't working then.
To fix this the original patch needs to be effectively reverted.
A side effect is that when normally bringing down the interface and
WoL is enabled the PHY will remain powered on (like it was before the
original patch).

Fixes: fe87bef01f9b ("r8169: don't check WoL when powering down PHY and interface is down")
	Reported-by: Neil MacLeod <neil@nmacleod.com>
	Signed-off-by: Heiner Kallweit <hkallweit1@gmail.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 649f0837a8cc2b39329f2de00fa0d04b029291c5)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/realtek/r8169.c
diff --cc drivers/net/ethernet/realtek/r8169.c
index b884c766fbf3,1fd01688d37b..000000000000
--- a/drivers/net/ethernet/realtek/r8169.c
+++ b/drivers/net/ethernet/realtek/r8169.c
@@@ -4401,10 -4161,15 +4401,19 @@@ static void rtl_wol_suspend_quirk(struc
  
  static bool rtl_wol_pll_power_down(struct rtl8169_private *tp)
  {
- 	if (!netif_running(tp->dev) || !__rtl8169_get_wol(tp))
+ 	struct phy_device *phydev;
+ 
+ 	if (!__rtl8169_get_wol(tp))
  		return false;
  
++<<<<<<< HEAD
 +	rtl_speed_down(tp);
++=======
+ 	/* phydev may not be attached to netdevice */
+ 	phydev = mdiobus_get_phy(tp->mii_bus, 0);
+ 
+ 	phy_speed_down(phydev, false);
++>>>>>>> 649f0837a8cc (r8169: fix broken Wake-on-LAN from S5 (poweroff))
  	rtl_wol_suspend_quirk(tp);
  
  	return true;
* Unmerged path drivers/net/ethernet/realtek/r8169.c
