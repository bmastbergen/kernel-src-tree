xfs: set format back to extents if xfs_bmap_extents_to_btree

jira LE-1907
cve CVE-2018-13095
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
commit-author Eric Sandeen <sandeen@redhat.com>
commit 2c4306f719b083d17df2963bc761777576b8ad1b
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/2c4306f7.failed

If xfs_bmap_extents_to_btree fails in a mode where we call
xfs_iroot_realloc(-1) to de-allocate the root, set the
format back to extents.

Otherwise we can assume we can dereference ifp->if_broot
based on the XFS_DINODE_FMT_BTREE format, and crash.

Bugzilla: https://bugzilla.kernel.org/show_bug.cgi?id=199423
	Signed-off-by: Eric Sandeen <sandeen@redhat.com>
	Reviewed-by: Christoph Hellwig <hch@lst.de>
	Reviewed-by: Darrick J. Wong <darrick.wong@oracle.com>
	Signed-off-by: Darrick J. Wong <darrick.wong@oracle.com>
(cherry picked from commit 2c4306f719b083d17df2963bc761777576b8ad1b)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/xfs/libxfs/xfs_bmap.c
diff --cc fs/xfs/libxfs/xfs_bmap.c
index a821827ec13e,040eeda8426f..000000000000
--- a/fs/xfs/libxfs/xfs_bmap.c
+++ b/fs/xfs/libxfs/xfs_bmap.c
@@@ -746,6 -730,14 +748,17 @@@ xfs_bmap_extents_to_btree
  		xfs_btree_del_cursor(cur, XFS_BTREE_ERROR);
  		return error;
  	}
++<<<<<<< HEAD
++=======
+ 
+ 	if (WARN_ON_ONCE(args.fsbno == NULLFSBLOCK)) {
+ 		xfs_iroot_realloc(ip, -1, whichfork);
+ 		ASSERT(ifp->if_broot == NULL);
+ 		XFS_IFORK_FMT_SET(ip, whichfork, XFS_DINODE_FMT_EXTENTS);
+ 		xfs_btree_del_cursor(cur, XFS_BTREE_ERROR);
+ 		return -ENOSPC;
+ 	}
++>>>>>>> 2c4306f719b0 (xfs: set format back to extents if xfs_bmap_extents_to_btree)
  	/*
  	 * Allocation can't fail, the space was reserved.
  	 */
* Unmerged path fs/xfs/libxfs/xfs_bmap.c
