ALSA: hda/realtek - Fixed Headset Mic JD not stable

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
commit-author Kailang Yang <kailang@realtek.com>
commit 10f5b1b85ed10a80d45bc2db450e65bd792efaad
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/10f5b1b8.failed

It will be lose Mic JD state when Chrome OS boot and headset was plugged.
Implement of reset combo jack JD. It will show normally.

Fixes: e854747d7593 ("ALSA: hda/realtek - Enable headset button support for new codec")
	Signed-off-by: Kailang Yang <kailang@realtek.com>
	Signed-off-by: Takashi Iwai <tiwai@suse.de>
(cherry picked from commit 10f5b1b85ed10a80d45bc2db450e65bd792efaad)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	sound/pci/hda/patch_realtek.c
diff --cc sound/pci/hda/patch_realtek.c
index b59b127f463b,156f4c4305a5..000000000000
--- a/sound/pci/hda/patch_realtek.c
+++ b/sound/pci/hda/patch_realtek.c
@@@ -5427,6 -5461,93 +5427,96 @@@ static void alc285_fixup_invalidate_dac
  	snd_hda_override_wcaps(codec, 0x03, 0);
  }
  
++<<<<<<< HEAD
++=======
+ static const struct hda_jack_keymap alc_headset_btn_keymap[] = {
+ 	{ SND_JACK_BTN_0, KEY_PLAYPAUSE },
+ 	{ SND_JACK_BTN_1, KEY_VOICECOMMAND },
+ 	{ SND_JACK_BTN_2, KEY_VOLUMEUP },
+ 	{ SND_JACK_BTN_3, KEY_VOLUMEDOWN },
+ 	{}
+ };
+ 
+ static void alc_headset_btn_callback(struct hda_codec *codec,
+ 				     struct hda_jack_callback *jack)
+ {
+ 	int report = 0;
+ 
+ 	if (jack->unsol_res & (7 << 13))
+ 		report |= SND_JACK_BTN_0;
+ 
+ 	if (jack->unsol_res  & (1 << 16 | 3 << 8))
+ 		report |= SND_JACK_BTN_1;
+ 
+ 	/* Volume up key */
+ 	if (jack->unsol_res & (7 << 23))
+ 		report |= SND_JACK_BTN_2;
+ 
+ 	/* Volume down key */
+ 	if (jack->unsol_res & (7 << 10))
+ 		report |= SND_JACK_BTN_3;
+ 
+ 	jack->jack->button_state = report;
+ }
+ 
+ static void alc_fixup_headset_jack(struct hda_codec *codec,
+ 				    const struct hda_fixup *fix, int action)
+ {
+ 
+ 	switch (action) {
+ 	case HDA_FIXUP_ACT_PRE_PROBE:
+ 		snd_hda_jack_detect_enable_callback(codec, 0x55,
+ 						    alc_headset_btn_callback);
+ 		snd_hda_jack_add_kctl(codec, 0x55, "Headset Jack", false,
+ 				      SND_JACK_HEADSET, alc_headset_btn_keymap);
+ 		break;
+ 	case HDA_FIXUP_ACT_INIT:
+ 		switch (codec->core.vendor_id) {
+ 		case 0x10ec0225:
+ 		case 0x10ec0295:
+ 		case 0x10ec0299:
+ 			alc_write_coef_idx(codec, 0x48, 0xd011);
+ 			alc_update_coef_idx(codec, 0x49, 0x007f, 0x0045);
+ 			alc_update_coef_idx(codec, 0x44, 0x007f << 8, 0x0045 << 8);
+ 			break;
+ 		case 0x10ec0236:
+ 		case 0x10ec0256:
+ 			alc_write_coef_idx(codec, 0x48, 0xd011);
+ 			alc_update_coef_idx(codec, 0x49, 0x007f, 0x0045);
+ 			break;
+ 		}
+ 		break;
+ 	}
+ }
+ 
+ static void alc295_fixup_chromebook(struct hda_codec *codec,
+ 				    const struct hda_fixup *fix, int action)
+ {
+ 
+ 	switch (action) {
+ 	case HDA_FIXUP_ACT_PRE_PROBE:
+ 		switch (codec->core.vendor_id) {
+ 		case 0x10ec0295:
+ 			alc_update_coef_idx(codec, 0x4a, 0x8000, 1 << 15); /* Reset HP JD */
+ 			alc_update_coef_idx(codec, 0x4a, 0x8000, 0 << 15);
+ 			break;
+ 		case 0x10ec0236:
+ 			alc_update_coef_idx(codec, 0x1b, 0x8000, 1 << 15); /* Reset HP JD */
+ 			alc_update_coef_idx(codec, 0x1b, 0x8000, 0 << 15);
+ 			break;
+ 		}
+ 		break;
+ 	}
+ }
+ 
+ static void alc_fixup_disable_mic_vref(struct hda_codec *codec,
+ 				  const struct hda_fixup *fix, int action)
+ {
+ 	if (action == HDA_FIXUP_ACT_PRE_PROBE)
+ 		snd_hda_codec_set_pin_target(codec, 0x19, PIN_VREFHIZ);
+ }
+ 
++>>>>>>> 10f5b1b85ed1 (ALSA: hda/realtek - Fixed Headset Mic JD not stable)
  /* for hda_fixup_thinkpad_acpi() */
  #include "thinkpad_helper.c"
  
@@@ -5571,6 -5690,11 +5661,14 @@@ enum 
  	ALC294_FIXUP_ASUS_MIC,
  	ALC294_FIXUP_ASUS_HEADSET_MIC,
  	ALC294_FIXUP_ASUS_SPK,
++<<<<<<< HEAD
++=======
+ 	ALC225_FIXUP_HEADSET_JACK,
+ 	ALC293_FIXUP_SYSTEM76_MIC_NO_PRESENCE,
+ 	ALC285_FIXUP_LENOVO_PC_BEEP_IN_NOISE,
+ 	ALC255_FIXUP_ACER_HEADSET_MIC,
+ 	ALC295_FIXUP_CHROME_BOOK,
++>>>>>>> 10f5b1b85ed1 (ALSA: hda/realtek - Fixed Headset Mic JD not stable)
  };
  
  static const struct hda_fixup alc269_fixups[] = {
@@@ -6507,6 -6637,46 +6605,49 @@@
  		.chained = true,
  		.chain_id = ALC294_FIXUP_ASUS_HEADSET_MIC
  	},
++<<<<<<< HEAD
++=======
+ 	[ALC225_FIXUP_HEADSET_JACK] = {
+ 		.type = HDA_FIXUP_FUNC,
+ 		.v.func = alc_fixup_headset_jack,
+ 	},
+ 	[ALC293_FIXUP_SYSTEM76_MIC_NO_PRESENCE] = {
+ 		.type = HDA_FIXUP_PINS,
+ 		.v.pins = (const struct hda_pintbl[]) {
+ 			{ 0x1a, 0x01a1913c }, /* use as headset mic, without its own jack detect */
+ 			{ }
+ 		},
+ 		.chained = true,
+ 		.chain_id = ALC269_FIXUP_HEADSET_MODE_NO_HP_MIC
+ 	},
+ 	[ALC285_FIXUP_LENOVO_PC_BEEP_IN_NOISE] = {
+ 		.type = HDA_FIXUP_VERBS,
+ 		.v.verbs = (const struct hda_verb[]) {
+ 			/* Disable PCBEEP-IN passthrough */
+ 			{ 0x20, AC_VERB_SET_COEF_INDEX, 0x36 },
+ 			{ 0x20, AC_VERB_SET_PROC_COEF, 0x57d7 },
+ 			{ }
+ 		},
+ 		.chained = true,
+ 		.chain_id = ALC285_FIXUP_LENOVO_HEADPHONE_NOISE
+ 	},
+ 	[ALC255_FIXUP_ACER_HEADSET_MIC] = {
+ 		.type = HDA_FIXUP_PINS,
+ 		.v.pins = (const struct hda_pintbl[]) {
+ 			{ 0x19, 0x03a11130 },
+ 			{ 0x1a, 0x90a60140 }, /* use as internal mic */
+ 			{ }
+ 		},
+ 		.chained = true,
+ 		.chain_id = ALC255_FIXUP_HEADSET_MODE_NO_HP_MIC
+ 	},
+ 	[ALC295_FIXUP_CHROME_BOOK] = {
+ 		.type = HDA_FIXUP_FUNC,
+ 		.v.func = alc295_fixup_chromebook,
+ 		.chained = true,
+ 		.chain_id = ALC225_FIXUP_HEADSET_JACK
+ 	},
++>>>>>>> 10f5b1b85ed1 (ALSA: hda/realtek - Fixed Headset Mic JD not stable)
  };
  
  static const struct snd_pci_quirk alc269_fixup_tbl[] = {
@@@ -6831,8 -7005,89 +6972,91 @@@ static const struct hda_model_fixup alc
  	{.id = ALC292_FIXUP_TPT440_DOCK, .name = "tpt440-dock"},
  	{.id = ALC292_FIXUP_TPT440, .name = "tpt440"},
  	{.id = ALC292_FIXUP_TPT460, .name = "tpt460"},
 -	{.id = ALC298_FIXUP_TPT470_DOCK, .name = "tpt470-dock"},
  	{.id = ALC233_FIXUP_LENOVO_MULTI_CODECS, .name = "dual-codecs"},
  	{.id = ALC700_FIXUP_INTEL_REFERENCE, .name = "alc700-ref"},
++<<<<<<< HEAD
++=======
+ 	{.id = ALC269_FIXUP_SONY_VAIO, .name = "vaio"},
+ 	{.id = ALC269_FIXUP_DELL_M101Z, .name = "dell-m101z"},
+ 	{.id = ALC269_FIXUP_ASUS_G73JW, .name = "asus-g73jw"},
+ 	{.id = ALC269_FIXUP_LENOVO_EAPD, .name = "lenovo-eapd"},
+ 	{.id = ALC275_FIXUP_SONY_HWEQ, .name = "sony-hweq"},
+ 	{.id = ALC269_FIXUP_PCM_44K, .name = "pcm44k"},
+ 	{.id = ALC269_FIXUP_LIFEBOOK, .name = "lifebook"},
+ 	{.id = ALC269_FIXUP_LIFEBOOK_EXTMIC, .name = "lifebook-extmic"},
+ 	{.id = ALC269_FIXUP_LIFEBOOK_HP_PIN, .name = "lifebook-hp-pin"},
+ 	{.id = ALC255_FIXUP_LIFEBOOK_U7x7_HEADSET_MIC, .name = "lifebook-u7x7"},
+ 	{.id = ALC269VB_FIXUP_AMIC, .name = "alc269vb-amic"},
+ 	{.id = ALC269VB_FIXUP_DMIC, .name = "alc269vb-dmic"},
+ 	{.id = ALC269_FIXUP_HP_MUTE_LED_MIC1, .name = "hp-mute-led-mic1"},
+ 	{.id = ALC269_FIXUP_HP_MUTE_LED_MIC2, .name = "hp-mute-led-mic2"},
+ 	{.id = ALC269_FIXUP_HP_MUTE_LED_MIC3, .name = "hp-mute-led-mic3"},
+ 	{.id = ALC269_FIXUP_HP_GPIO_MIC1_LED, .name = "hp-gpio-mic1"},
+ 	{.id = ALC269_FIXUP_HP_LINE1_MIC1_LED, .name = "hp-line1-mic1"},
+ 	{.id = ALC269_FIXUP_NO_SHUTUP, .name = "noshutup"},
+ 	{.id = ALC286_FIXUP_SONY_MIC_NO_PRESENCE, .name = "sony-nomic"},
+ 	{.id = ALC269_FIXUP_ASPIRE_HEADSET_MIC, .name = "aspire-headset-mic"},
+ 	{.id = ALC269_FIXUP_ASUS_X101, .name = "asus-x101"},
+ 	{.id = ALC271_FIXUP_HP_GATE_MIC_JACK, .name = "acer-ao7xx"},
+ 	{.id = ALC271_FIXUP_HP_GATE_MIC_JACK_E1_572, .name = "acer-aspire-e1"},
+ 	{.id = ALC269_FIXUP_ACER_AC700, .name = "acer-ac700"},
+ 	{.id = ALC269_FIXUP_LIMIT_INT_MIC_BOOST, .name = "limit-mic-boost"},
+ 	{.id = ALC269VB_FIXUP_ASUS_ZENBOOK, .name = "asus-zenbook"},
+ 	{.id = ALC269VB_FIXUP_ASUS_ZENBOOK_UX31A, .name = "asus-zenbook-ux31a"},
+ 	{.id = ALC269VB_FIXUP_ORDISSIMO_EVE2, .name = "ordissimo"},
+ 	{.id = ALC282_FIXUP_ASUS_TX300, .name = "asus-tx300"},
+ 	{.id = ALC283_FIXUP_INT_MIC, .name = "alc283-int-mic"},
+ 	{.id = ALC290_FIXUP_MONO_SPEAKERS_HSJACK, .name = "mono-speakers"},
+ 	{.id = ALC290_FIXUP_SUBWOOFER_HSJACK, .name = "alc290-subwoofer"},
+ 	{.id = ALC269_FIXUP_THINKPAD_ACPI, .name = "thinkpad"},
+ 	{.id = ALC269_FIXUP_DMIC_THINKPAD_ACPI, .name = "dmic-thinkpad"},
+ 	{.id = ALC255_FIXUP_ACER_MIC_NO_PRESENCE, .name = "alc255-acer"},
+ 	{.id = ALC255_FIXUP_ASUS_MIC_NO_PRESENCE, .name = "alc255-asus"},
+ 	{.id = ALC255_FIXUP_DELL1_MIC_NO_PRESENCE, .name = "alc255-dell1"},
+ 	{.id = ALC255_FIXUP_DELL2_MIC_NO_PRESENCE, .name = "alc255-dell2"},
+ 	{.id = ALC293_FIXUP_DELL1_MIC_NO_PRESENCE, .name = "alc293-dell1"},
+ 	{.id = ALC283_FIXUP_HEADSET_MIC, .name = "alc283-headset"},
+ 	{.id = ALC255_FIXUP_MIC_MUTE_LED, .name = "alc255-dell-mute"},
+ 	{.id = ALC282_FIXUP_ASPIRE_V5_PINS, .name = "aspire-v5"},
+ 	{.id = ALC280_FIXUP_HP_GPIO4, .name = "hp-gpio4"},
+ 	{.id = ALC286_FIXUP_HP_GPIO_LED, .name = "hp-gpio-led"},
+ 	{.id = ALC280_FIXUP_HP_GPIO2_MIC_HOTKEY, .name = "hp-gpio2-hotkey"},
+ 	{.id = ALC280_FIXUP_HP_DOCK_PINS, .name = "hp-dock-pins"},
+ 	{.id = ALC269_FIXUP_HP_DOCK_GPIO_MIC1_LED, .name = "hp-dock-gpio-mic"},
+ 	{.id = ALC280_FIXUP_HP_9480M, .name = "hp-9480m"},
+ 	{.id = ALC288_FIXUP_DELL_HEADSET_MODE, .name = "alc288-dell-headset"},
+ 	{.id = ALC288_FIXUP_DELL1_MIC_NO_PRESENCE, .name = "alc288-dell1"},
+ 	{.id = ALC288_FIXUP_DELL_XPS_13, .name = "alc288-dell-xps13"},
+ 	{.id = ALC292_FIXUP_DELL_E7X, .name = "dell-e7x"},
+ 	{.id = ALC293_FIXUP_DISABLE_AAMIX_MULTIJACK, .name = "alc293-dell"},
+ 	{.id = ALC298_FIXUP_DELL1_MIC_NO_PRESENCE, .name = "alc298-dell1"},
+ 	{.id = ALC298_FIXUP_DELL_AIO_MIC_NO_PRESENCE, .name = "alc298-dell-aio"},
+ 	{.id = ALC275_FIXUP_DELL_XPS, .name = "alc275-dell-xps"},
+ 	{.id = ALC256_FIXUP_DELL_XPS_13_HEADPHONE_NOISE, .name = "alc256-dell-xps13"},
+ 	{.id = ALC293_FIXUP_LENOVO_SPK_NOISE, .name = "lenovo-spk-noise"},
+ 	{.id = ALC233_FIXUP_LENOVO_LINE2_MIC_HOTKEY, .name = "lenovo-hotkey"},
+ 	{.id = ALC255_FIXUP_DELL_SPK_NOISE, .name = "dell-spk-noise"},
+ 	{.id = ALC225_FIXUP_DELL1_MIC_NO_PRESENCE, .name = "alc225-dell1"},
+ 	{.id = ALC295_FIXUP_DISABLE_DAC3, .name = "alc295-disable-dac3"},
+ 	{.id = ALC280_FIXUP_HP_HEADSET_MIC, .name = "alc280-hp-headset"},
+ 	{.id = ALC221_FIXUP_HP_FRONT_MIC, .name = "alc221-hp-mic"},
+ 	{.id = ALC298_FIXUP_SPK_VOLUME, .name = "alc298-spk-volume"},
+ 	{.id = ALC256_FIXUP_DELL_INSPIRON_7559_SUBWOOFER, .name = "dell-inspiron-7559"},
+ 	{.id = ALC269_FIXUP_ATIV_BOOK_8, .name = "ativ-book"},
+ 	{.id = ALC221_FIXUP_HP_MIC_NO_PRESENCE, .name = "alc221-hp-mic"},
+ 	{.id = ALC256_FIXUP_ASUS_HEADSET_MODE, .name = "alc256-asus-headset"},
+ 	{.id = ALC256_FIXUP_ASUS_MIC, .name = "alc256-asus-mic"},
+ 	{.id = ALC256_FIXUP_ASUS_AIO_GPIO2, .name = "alc256-asus-aio"},
+ 	{.id = ALC233_FIXUP_ASUS_MIC_NO_PRESENCE, .name = "alc233-asus"},
+ 	{.id = ALC233_FIXUP_EAPD_COEF_AND_MIC_NO_PRESENCE, .name = "alc233-eapd"},
+ 	{.id = ALC294_FIXUP_LENOVO_MIC_LOCATION, .name = "alc294-lenovo-mic"},
+ 	{.id = ALC225_FIXUP_DELL_WYSE_MIC_NO_PRESENCE, .name = "alc225-wyse"},
+ 	{.id = ALC274_FIXUP_DELL_AIO_LINEOUT_VERB, .name = "alc274-dell-aio"},
+ 	{.id = ALC255_FIXUP_DUMMY_LINEOUT_VERB, .name = "alc255-dummy-lineout"},
+ 	{.id = ALC255_FIXUP_DELL_HEADSET_MIC, .name = "alc255-dell-headset"},
+ 	{.id = ALC295_FIXUP_HP_X360, .name = "alc295-hp-x360"},
+ 	{.id = ALC295_FIXUP_CHROME_BOOK, .name = "alc-sense-combo"},
++>>>>>>> 10f5b1b85ed1 (ALSA: hda/realtek - Fixed Headset Mic JD not stable)
  	{}
  };
  #define ALC225_STANDARD_PINS \
* Unmerged path sound/pci/hda/patch_realtek.c
