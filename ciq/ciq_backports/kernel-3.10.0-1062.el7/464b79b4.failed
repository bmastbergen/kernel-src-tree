IB/core: Add default GIDs of the bond master netdev

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
commit-author Parav Pandit <parav@mellanox.com>
commit 464b79b45aede2859eb46ae91786f0266868602b
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/464b79b4.failed

Currently following issues exist:
1. Default GIDs of the lower (slave) netdevice if the bond netdevice is
   added. Rather default GID should be of bond master netdevice.
2. Due to this, when failover event occurs FAILOVER event handler attempts
   to delete the GID of the upper device and tries to add the default GID
   of the lower device. This is incorrect behavior.

To have simple and correct code:
(a) Split default GIDs addition out of add_netdev_ips().  This allows
    easier removal in future if RoCE default GIDs are removed.
(b) Add default GIDs of the bond master device by using right filter and
    callback function.
(c) Remove unused function enum_netdev_default_gids().

	Signed-off-by: Parav Pandit <parav@mellanox.com>
	Signed-off-by: Leon Romanovsky <leonro@mellanox.com>
	Signed-off-by: Jason Gunthorpe <jgg@mellanox.com>
(cherry picked from commit 464b79b45aede2859eb46ae91786f0266868602b)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/core/roce_gid_mgmt.c
diff --cc drivers/infiniband/core/roce_gid_mgmt.c
index b6e4d6e5b248,69f58e907810..000000000000
--- a/drivers/infiniband/core/roce_gid_mgmt.c
+++ b/drivers/infiniband/core/roce_gid_mgmt.c
@@@ -461,10 -475,22 +473,25 @@@ static void enum_all_gids_of_dev_cb(str
  	 * our feet
  	 */
  	rtnl_lock();
 -	down_read(&net_rwsem);
  	for_each_net(net)
- 		for_each_netdev(net, ndev)
+ 		for_each_netdev(net, ndev) {
+ 			/*
+ 			 * Filter and add default GIDs of the primary netdevice
+ 			 * when not in bonding mode, or add default GIDs
+ 			 * of bond master device, when in bonding mode.
+ 			 */
+ 			if (is_ndev_for_default_gid_filter(ib_dev, port,
+ 							   rdma_ndev, ndev))
+ 				add_default_gids(ib_dev, port, rdma_ndev, ndev);
+ 
  			if (is_eth_port_of_netdev(ib_dev, port, rdma_ndev, ndev))
++<<<<<<< HEAD
 +				add_netdev_ips(ib_dev, port, rdma_ndev, ndev);
++=======
+ 				_add_netdev_ips(ib_dev, port, ndev);
+ 		}
+ 	up_read(&net_rwsem);
++>>>>>>> 464b79b45aed (IB/core: Add default GIDs of the bond master netdev)
  	rtnl_unlock();
  }
  
* Unmerged path drivers/infiniband/core/roce_gid_mgmt.c
