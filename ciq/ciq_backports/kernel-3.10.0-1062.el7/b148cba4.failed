ovl: clean up copy-up error paths

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
commit-author Miklos Szeredi <mszeredi@redhat.com>
commit b148cba403f4fc9c99f0a596e35047395b748169
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/b148cba4.failed

	Signed-off-by: Miklos Szeredi <mszeredi@redhat.com>
(cherry picked from commit b148cba403f4fc9c99f0a596e35047395b748169)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/overlayfs/copy_up.c
diff --cc fs/overlayfs/copy_up.c
index 5bfbfc122918,ddaddb4ce4c3..000000000000
--- a/fs/overlayfs/copy_up.c
+++ b/fs/overlayfs/copy_up.c
@@@ -398,17 -365,14 +398,22 @@@ static int ovl_create_index(struct dent
  	if (err)
  		return err;
  
++<<<<<<< HEAD
 +	temp = ovl_lookup_temp(indexdir);
++=======
+ 	temp = ovl_create_temp(indexdir, OVL_CATTR(S_IFDIR | 0));
+ 	err = PTR_ERR(temp);
++>>>>>>> b148cba403f4 (ovl: clean up copy-up error paths)
  	if (IS_ERR(temp))
- 		goto temp_err;
+ 		goto free_name;
  
 +	err = ovl_do_mkdir(dir, temp, S_IFDIR, true);
 +	if (err)
 +		goto out;
 +
  	err = ovl_set_upper_fh(upper, temp);
  	if (err)
- 		goto out_cleanup;
+ 		goto out;
  
  	index = lookup_one_len(name.name, indexdir, name.len);
  	if (IS_ERR(index)) {
@@@ -531,24 -488,10 +527,29 @@@ static struct dentry *ovl_get_tmpfile(s
  	if (new_creds)
  		old_creds = override_creds(new_creds);
  
 -	if (c->tmpfile)
 +	if (c->tmpfile) {
  		temp = ovl_do_tmpfile(c->workdir, c->stat.mode);
++<<<<<<< HEAD
 +		if (IS_ERR(temp))
 +			goto temp_err;
 +	} else {
 +		temp = ovl_lookup_temp(c->workdir);
 +		if (IS_ERR(temp))
 +			goto temp_err;
 +
 +		err = ovl_create_real(d_inode(c->workdir), temp, &cattr,
 +				      NULL, true);
 +		if (err) {
 +			dput(temp);
 +			goto out;
 +		}
 +	}
 +	err = 0;
 +	*tempp = temp;
++=======
+ 	else
+ 		temp = ovl_create_temp(c->workdir, &cattr);
++>>>>>>> b148cba403f4 (ovl: clean up copy-up error paths)
  out:
  	if (new_creds) {
  		revert_creds(old_creds);
* Unmerged path fs/overlayfs/copy_up.c
