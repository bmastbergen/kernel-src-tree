IB/mlx5: Avoid dealing with vport representors if not being e-switch manager

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
commit-author Or Gerlitz <ogerlitz@mellanox.com>
commit aff2252a2ad3844ca47bf2f18af071101baace40
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/aff2252a.failed

In smartnic env, the host (PF) driver might not be an e-switch
manager, hence the switchdev mode representors are running on
the embedded cpu (EC) and not at the host.

As such, we should avoid dealing with vport representors if
not being esw manager.

Fixes: b5ca15ad7e61 ('IB/mlx5: Add proper representors support')
	Signed-off-by: Or Gerlitz <ogerlitz@mellanox.com>
	Reviewed-by: Eli Cohen <eli@mellanox.com>
	Signed-off-by: Saeed Mahameed <saeedm@mellanox.com>
(cherry picked from commit aff2252a2ad3844ca47bf2f18af071101baace40)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/hw/mlx5/main.c
diff --cc drivers/infiniband/hw/mlx5/main.c
index 1726b9447b75,634be96dcb86..000000000000
--- a/drivers/infiniband/hw/mlx5/main.c
+++ b/drivers/infiniband/hw/mlx5/main.c
@@@ -5397,7 -6099,22 +5397,26 @@@ static void *mlx5_ib_add(struct mlx5_co
  		return mlx5_ib_add_slave_port(mdev, port_num);
  	}
  
++<<<<<<< HEAD
 +	return __mlx5_ib_add(mdev, &pf_profile);
++=======
+ 	dev = (struct mlx5_ib_dev *)ib_alloc_device(sizeof(*dev));
+ 	if (!dev)
+ 		return NULL;
+ 
+ 	dev->mdev = mdev;
+ 	dev->num_ports = max(MLX5_CAP_GEN(mdev, num_ports),
+ 			     MLX5_CAP_GEN(mdev, num_vhca_ports));
+ 
+ 	if (MLX5_ESWITCH_MANAGER(mdev) &&
+ 	    mlx5_ib_eswitch_mode(mdev->priv.eswitch) == SRIOV_OFFLOADS) {
+ 		dev->rep = mlx5_ib_vport_rep(mdev->priv.eswitch, 0);
+ 
+ 		return __mlx5_ib_add(dev, &nic_rep_profile);
+ 	}
+ 
+ 	return __mlx5_ib_add(dev, &pf_profile);
++>>>>>>> aff2252a2ad3 (IB/mlx5: Avoid dealing with vport representors if not being e-switch manager)
  }
  
  static void mlx5_ib_remove(struct mlx5_core_dev *mdev, void *context)
* Unmerged path drivers/infiniband/hw/mlx5/main.c
