IB/cache: Restore compatibility for ib_query_gid

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
commit-author Jason Gunthorpe <jgg@mellanox.com>
commit 7aaa1807e698f73094b78f0ef25b1a37a4409a55
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/7aaa1807.failed

Code changes in smc have become so complicated this cycle that the RDMA
patches to remove ib_query_gid in smc create too complex merge conflicts.
Allow those conflicts to be resolved by using the net/smc hunks by
providing a compatibility wrapper. During the second phase of the merge
window this wrapper will be deleted and smc updated to use the new API.

	Reported-by: Stephen Rothwell <sfr@canb.auug.org.au>
	Reviewed-by: Parav Pandit <parav@mellanox.com>
	Signed-off-by: Jason Gunthorpe <jgg@mellanox.com>
(cherry picked from commit 7aaa1807e698f73094b78f0ef25b1a37a4409a55)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	include/rdma/ib_cache.h
diff --cc include/rdma/ib_cache.h
index 8ee33847c513,a4ce441f36f0..000000000000
--- a/include/rdma/ib_cache.h
+++ b/include/rdma/ib_cache.h
@@@ -166,4 -127,33 +166,36 @@@ int ib_get_cached_port_state(struct ib_
  			      u8                port_num,
  			      enum ib_port_state *port_active);
  
++<<<<<<< HEAD
++=======
+ bool rdma_is_zero_gid(const union ib_gid *gid);
+ const struct ib_gid_attr *rdma_get_gid_attr(struct ib_device *device,
+ 					    u8 port_num, int index);
+ void rdma_put_gid_attr(const struct ib_gid_attr *attr);
+ void rdma_hold_gid_attr(const struct ib_gid_attr *attr);
+ 
+ /*
+  * This is to be removed. It only exists to make merging rdma and smc simpler.
+  */
+ static inline __deprecated int ib_query_gid(struct ib_device *device,
+ 					    u8 port_num, int index,
+ 					    union ib_gid *gid,
+ 					    struct ib_gid_attr *attr_out)
+ {
+ 	const struct ib_gid_attr *attr;
+ 
+ 	attr = rdma_get_gid_attr(device, port_num, index);
+ 	if (IS_ERR(attr))
+ 		return PTR_ERR(attr);
+ 
+ 	if (attr->ndev)
+ 		dev_hold(attr->ndev);
+ 	*attr_out = *attr;
+ 
+ 	rdma_put_gid_attr(attr);
+ 
+ 	return 0;
+ }
+ 
++>>>>>>> 7aaa1807e698 (IB/cache: Restore compatibility for ib_query_gid)
  #endif /* _IB_CACHE_H */
* Unmerged path include/rdma/ib_cache.h
