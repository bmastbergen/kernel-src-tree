cifs: Accept validate negotiate if server return NT_STATUS_NOT_SUPPORTED

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
commit-author Namjae Jeon <linkinjeon@gmail.com>
commit 969ae8e8d4ee54c99134d3895f2adf96047f5bee
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/969ae8e8.failed

Old windows version or Netapp SMB server will return
NT_STATUS_NOT_SUPPORTED since they do not allow or implement
FSCTL_VALIDATE_NEGOTIATE_INFO. The client should accept the response
provided it's properly signed.

See
https://blogs.msdn.microsoft.com/openspecification/2012/06/28/smb3-secure-dialect-negotiation/

and

MS-SMB2 validate negotiate response processing:
https://msdn.microsoft.com/en-us/library/hh880630.aspx

Samba client had already handled it.
https://bugzilla.samba.org/attachment.cgi?id=13285&action=edit

	Signed-off-by: Namjae Jeon <linkinjeon@gmail.com>
	Signed-off-by: Steve French <stfrench@microsoft.com>
(cherry picked from commit 969ae8e8d4ee54c99134d3895f2adf96047f5bee)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/cifs/smb2pdu.c
diff --cc fs/cifs/smb2pdu.c
index 651e69704e4b,f2980f78149c..000000000000
--- a/fs/cifs/smb2pdu.c
+++ b/fs/cifs/smb2pdu.c
@@@ -676,15 -985,22 +676,27 @@@ int smb3_validate_negotiate(const unsig
  
  	rc = SMB2_ioctl(xid, tcon, NO_FILE_ID, NO_FILE_ID,
  		FSCTL_VALIDATE_NEGOTIATE_INFO, true /* is_fsctl */,
++<<<<<<< HEAD
 +		(char *)&vneg_inbuf, sizeof(struct validate_negotiate_info_req),
 +		(char **)&pneg_rsp, &rsplen);
 +
 +	if (rc != 0) {
++=======
+ 		(char *)pneg_inbuf, inbuflen, (char **)&pneg_rsp, &rsplen);
+ 	if (rc == -EOPNOTSUPP) {
+ 		/*
+ 		 * Old Windows versions or Netapp SMB server can return
+ 		 * not supported error. Client should accept it.
+ 		 */
+ 		cifs_dbg(VFS, "Server does not support validate negotiate\n");
+ 		return 0;
+ 	} else if (rc != 0) {
++>>>>>>> 969ae8e8d4ee (cifs: Accept validate negotiate if server return NT_STATUS_NOT_SUPPORTED)
  		cifs_dbg(VFS, "validate protocol negotiate failed: %d\n", rc);
 -		rc = -EIO;
 -		goto out_free_inbuf;
 +		return -EIO;
  	}
  
 -	rc = -EIO;
 -	if (rsplen != sizeof(*pneg_rsp)) {
 +	if (rsplen != sizeof(struct validate_negotiate_info_rsp)) {
  		cifs_dbg(VFS, "invalid protocol negotiate response size: %d\n",
  			 rsplen);
  
* Unmerged path fs/cifs/smb2pdu.c
