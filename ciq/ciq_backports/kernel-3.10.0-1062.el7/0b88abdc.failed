kvm: nVMX: Restore exit qual for VM-entry failure due to MSR loading

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
commit-author Jim Mattson <jmattson@google.com>
commit 0b88abdc3f964c28ec03bc69eb17cb6b3b034564
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/0b88abdc.failed

This exit qualification was inadvertently dropped when the two
VM-entry failure blocks were coalesced.

Fixes: e79f245ddec1 ("X86/KVM: Properly update 'tsc_offset' to represent the running guest")
	Signed-off-by: Jim Mattson <jmattson@google.com>
	Reviewed-by: Krish Sadhukhan <krish.sadhukhan@oracle.com>
	Reviewed-by: David Hildenbrand <david@redhat.com>
	Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
(cherry picked from commit 0b88abdc3f964c28ec03bc69eb17cb6b3b034564)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kvm/vmx.c
diff --cc arch/x86/kvm/vmx.c
index 5501a1957de2,ba981459d706..000000000000
--- a/arch/x86/kvm/vmx.c
+++ b/arch/x86/kvm/vmx.c
@@@ -10736,8 -11431,8 +10736,7 @@@ static int enter_vmx_non_root_mode(stru
  {
  	struct vcpu_vmx *vmx = to_vmx(vcpu);
  	struct vmcs12 *vmcs12 = get_vmcs12(vcpu);
- 	u32 msr_entry_idx;
  	u32 exit_qual;
 -	int r;
  
  	enter_guest_mode(vcpu);
  
@@@ -10757,16 -11451,12 +10756,25 @@@
  
  	nested_get_vmcs12_pages(vcpu, vmcs12);
  
++<<<<<<< HEAD
 +	msr_entry_idx = nested_vmx_load_msr(vcpu,
 +					    vmcs12->vm_entry_msr_load_addr,
 +					    vmcs12->vm_entry_msr_load_count);
 +	if (msr_entry_idx) {
 +		leave_guest_mode(vcpu);
 +		vmx_switch_vmcs(vcpu, &vmx->vmcs01);
 +		nested_vmx_entry_failure(vcpu, vmcs12,
 +				EXIT_REASON_MSR_LOAD_FAIL, msr_entry_idx);
 +		return 1;
 +	}
++=======
+ 	r = EXIT_REASON_MSR_LOAD_FAIL;
+ 	exit_qual = nested_vmx_load_msr(vcpu,
+ 					vmcs12->vm_entry_msr_load_addr,
+ 					vmcs12->vm_entry_msr_load_count);
+ 	if (exit_qual)
+ 		goto fail;
++>>>>>>> 0b88abdc3f96 (kvm: nVMX: Restore exit qual for VM-entry failure due to MSR loading)
  
  	/*
  	 * Note no nested_vmx_succeed or nested_vmx_fail here. At this point
* Unmerged path arch/x86/kvm/vmx.c
