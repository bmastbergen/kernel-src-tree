fbdev: add remove_conflicting_pci_framebuffers()

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
commit-author Michał Mirosław <mirq-linux@rere.qmqm.pl>
commit 4d18975c78f2d5c91792356501cf369e67594241
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/4d18975c.failed

Almost all PCI drivers using remove_conflicting_framebuffers() wrap it
with the same code.

v2: add kerneldoc for DRM helper
v3: propagate remove_conflicting_framebuffers() return value
  + move kerneldoc to where function is implemented

	Signed-off-by: Michał Mirosław <mirq-linux@rere.qmqm.pl>
	Acked-by: Bartlomiej Zolnierkiewicz <b.zolnierkie@samsung.com>
	Signed-off-by: Daniel Vetter <daniel.vetter@ffwll.ch>
Link: https://patchwork.freedesktop.org/patch/msgid/7db1c278276de420eb45a1b71d06b5eb6bbd49ef.1535810304.git.mirq-linux@rere.qmqm.pl
(cherry picked from commit 4d18975c78f2d5c91792356501cf369e67594241)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/video/fbmem.c
diff --cc drivers/video/fbmem.c
index ea8257aab07c,5ffadc8e681d..000000000000
--- a/drivers/video/fbmem.c
+++ b/drivers/video/fbmem.c
@@@ -32,6 -32,9 +32,12 @@@
  #include <linux/device.h>
  #include <linux/efi.h>
  #include <linux/fb.h>
++<<<<<<< HEAD:drivers/video/fbmem.c
++=======
+ #include <linux/fbcon.h>
+ #include <linux/mem_encrypt.h>
+ #include <linux/pci.h>
++>>>>>>> 4d18975c78f2 (fbdev: add remove_conflicting_pci_framebuffers()):drivers/video/fbdev/core/fbmem.c
  
  #include <asm/fb.h>
  
* Unmerged path drivers/video/fbmem.c
diff --git a/include/drm/drm_fb_helper.h b/include/drm/drm_fb_helper.h
index b069433e7fc1..20ea856db900 100644
--- a/include/drm/drm_fb_helper.h
+++ b/include/drm/drm_fb_helper.h
@@ -577,4 +577,16 @@ drm_fb_helper_remove_conflicting_framebuffers(struct apertures_struct *a,
 #endif
 }
 
+static inline int
+drm_fb_helper_remove_conflicting_pci_framebuffers(struct pci_dev *pdev,
+						  int resource_id,
+						  const char *name)
+{
+#if IS_REACHABLE(CONFIG_FB)
+	return remove_conflicting_pci_framebuffers(pdev, resource_id, name);
+#else
+	return 0;
+#endif
+}
+
 #endif
diff --git a/include/linux/fb.h b/include/linux/fb.h
index bfdb4c5c6056..736ea53dca19 100644
--- a/include/linux/fb.h
+++ b/include/linux/fb.h
@@ -605,6 +605,8 @@ extern ssize_t fb_sys_write(struct fb_info *info, const char __user *buf,
 extern int register_framebuffer(struct fb_info *fb_info);
 extern int unregister_framebuffer(struct fb_info *fb_info);
 extern int unlink_framebuffer(struct fb_info *fb_info);
+extern int remove_conflicting_pci_framebuffers(struct pci_dev *pdev, int res_id,
+					       const char *name);
 extern int remove_conflicting_framebuffers(struct apertures_struct *a,
 					   const char *name, bool primary);
 extern int fb_prepare_logo(struct fb_info *fb_info, int rotate);
