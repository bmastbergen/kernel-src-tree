ethtool: don't allow disabling queues with umem installed

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
commit-author Jakub Kicinski <jakub.kicinski@netronome.com>
commit 1661d346628115c364e2b7d5b15a64ca3bd0dbd4
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/1661d346.failed

We already check the RSS indirection table does not use queues which
would be disabled by channel reconfiguration. Make sure user does not
try to disable queues which have a UMEM and zero-copy AF_XDP socket
installed.

	Signed-off-by: Jakub Kicinski <jakub.kicinski@netronome.com>
	Reviewed-by: Quentin Monnet <quentin.monnet@netronome.com>
	Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
(cherry picked from commit 1661d346628115c364e2b7d5b15a64ca3bd0dbd4)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	include/net/xdp_sock.h
#	net/core/ethtool.c
#	net/xdp/xdp_umem.c
diff --cc net/core/ethtool.c
index 396a7c77a080,5a788adeba0b..000000000000
--- a/net/core/ethtool.c
+++ b/net/core/ethtool.c
@@@ -22,10 -22,12 +22,11 @@@
  #include <linux/bitops.h>
  #include <linux/uaccess.h>
  #include <linux/vmalloc.h>
 -#include <linux/sfp.h>
  #include <linux/slab.h>
  #include <linux/rtnetlink.h>
 -#include <linux/sched/signal.h>
 +#include <linux/sched.h>
  #include <linux/net.h>
+ #include <net/xdp_sock.h>
  
  /*
   * Some useful ethtool_ops methods that're device independent.
@@@ -1770,8 -1656,10 +1771,14 @@@ static noinline_for_stack int ethtool_g
  static noinline_for_stack int ethtool_set_channels(struct net_device *dev,
  						   void __user *useraddr)
  {
++<<<<<<< HEAD
 +	struct ethtool_channels channels, max;
++=======
+ 	struct ethtool_channels channels, curr = { .cmd = ETHTOOL_GCHANNELS };
+ 	u16 from_channel, to_channel;
++>>>>>>> 1661d3466281 (ethtool: don't allow disabling queues with umem installed)
  	u32 max_rx_in_use = 0;
+ 	unsigned int i;
  
  	if (!dev->ethtool_ops->set_channels || !dev->ethtool_ops->get_channels)
  		return -EOPNOTSUPP;
* Unmerged path include/net/xdp_sock.h
* Unmerged path net/xdp/xdp_umem.c
* Unmerged path include/net/xdp_sock.h
* Unmerged path net/core/ethtool.c
* Unmerged path net/xdp/xdp_umem.c
