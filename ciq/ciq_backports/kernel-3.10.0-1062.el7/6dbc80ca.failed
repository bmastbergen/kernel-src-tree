net/mlx5e: clock.c depends on CONFIG_PTP_1588_CLOCK

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
Rebuild_CHGLOG: - [netdrv] mlx5e: clock.c depends on CONFIG_PTP_1588_CLOCK (Alaa Hleihel) [1642498]
Rebuild_FUZZ: 95.92%
commit-author Moshe Shemesh <moshe@mellanox.com>
commit 6dbc80ca41f5a76e0d2ae4e96b2476d68a2ea17f
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/6dbc80ca.failed

lib/clock.c includes clock related functions which require ptp support.
Thus compile out lib/clock.c and add the needed function stubs in case
kconfig CONFIG_PTP_1588_CLOCK is off.

	Signed-off-by: Moshe Shemesh <moshe@mellanox.com>
	Signed-off-by: Saeed Mahameed <saeedm@mellanox.com>
(cherry picked from commit 6dbc80ca41f5a76e0d2ae4e96b2476d68a2ea17f)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlx5/core/Makefile
#	drivers/net/ethernet/mellanox/mlx5/core/en_ethtool.c
#	drivers/net/ethernet/mellanox/mlx5/core/en_main.c
diff --cc drivers/net/ethernet/mellanox/mlx5/core/Makefile
index 7500fab9286b,9e78c48b22dd..000000000000
--- a/drivers/net/ethernet/mellanox/mlx5/core/Makefile
+++ b/drivers/net/ethernet/mellanox/mlx5/core/Makefile
@@@ -12,11 -13,16 +12,18 @@@ mlx5_core-$(CONFIG_MLX5_ACCEL) += accel
  mlx5_core-$(CONFIG_MLX5_FPGA) += fpga/cmd.o fpga/core.o fpga/conn.o fpga/sdk.o \
  		fpga/ipsec.o fpga/tls.o
  
++<<<<<<< HEAD
++=======
+ mlx5_core-$(CONFIG_MLX5_MPFS)  += lib/mpfs.o
+ mlx5_core-$(CONFIG_VXLAN) += lib/vxlan.o
+ mlx5_core-$(CONFIG_PTP_1588_CLOCK) += lib/clock.o
+ 
++>>>>>>> 6dbc80ca41f5 (net/mlx5e: clock.c depends on CONFIG_PTP_1588_CLOCK)
  mlx5_core-$(CONFIG_MLX5_CORE_EN) += en_main.o en_common.o en_fs.o en_ethtool.o \
 -		en_tx.o en_rx.o en_dim.o en_txrx.o en/xdp.o en_stats.o \
 -		en_selftest.o en/port.o
 +		en_tx.o en_rx.o en_dim.o en_txrx.o en_stats.o vxlan.o \
 +		en_arfs.o en_fs_ethtool.o en_selftest.o
  
 -mlx5_core-$(CONFIG_MLX5_EN_ARFS)  += en_arfs.o
 -mlx5_core-$(CONFIG_MLX5_EN_RXNFC) += en_fs_ethtool.o
 +mlx5_core-$(CONFIG_MLX5_MPFS) += lib/mpfs.o
  
  mlx5_core-$(CONFIG_MLX5_ESWITCH) += eswitch.o eswitch_offloads.o en_rep.o en_tc.o
  
diff --cc drivers/net/ethernet/mellanox/mlx5/core/en_ethtool.c
index c26c1d949a7c,98dd3e0ada72..000000000000
--- a/drivers/net/ethernet/mellanox/mlx5/core/en_ethtool.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/en_ethtool.c
@@@ -31,6 -31,8 +31,11 @@@
   */
  
  #include "en.h"
++<<<<<<< HEAD
++=======
+ #include "en/port.h"
+ #include "lib/clock.h"
++>>>>>>> 6dbc80ca41f5 (net/mlx5e: clock.c depends on CONFIG_PTP_1588_CLOCK)
  
  void mlx5e_ethtool_get_drvinfo(struct mlx5e_priv *priv,
  			       struct ethtool_drvinfo *drvinfo)
diff --cc drivers/net/ethernet/mellanox/mlx5/core/en_main.c
index ae360df0ba0b,5a7939e70190..000000000000
--- a/drivers/net/ethernet/mellanox/mlx5/core/en_main.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/en_main.c
@@@ -51,7 -45,10 +51,14 @@@
  #include "en_accel/tls.h"
  #include "accel/ipsec.h"
  #include "accel/tls.h"
++<<<<<<< HEAD
 +#include "vxlan.h"
++=======
+ #include "lib/vxlan.h"
+ #include "lib/clock.h"
+ #include "en/port.h"
+ #include "en/xdp.h"
++>>>>>>> 6dbc80ca41f5 (net/mlx5e: clock.c depends on CONFIG_PTP_1588_CLOCK)
  
  struct mlx5e_rq_param {
  	u32			rqc[MLX5_ST_SZ_DW(rqc)];
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/Makefile
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/en_ethtool.c
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/en_main.c
diff --git a/drivers/net/ethernet/mellanox/mlx5/core/eq.c b/drivers/net/ethernet/mellanox/mlx5/core/eq.c
index dd0338fd04d3..7a754589bc3c 100644
--- a/drivers/net/ethernet/mellanox/mlx5/core/eq.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/eq.c
@@ -37,6 +37,7 @@
 #include "mlx5_core.h"
 #include "fpga/core.h"
 #include "eswitch.h"
+#include "lib/clock.h"
 #include "diag/fw_tracer.h"
 
 enum {
diff --git a/drivers/net/ethernet/mellanox/mlx5/core/lib/clock.h b/drivers/net/ethernet/mellanox/mlx5/core/lib/clock.h
index a8eecedd46c2..02e2e4575e4f 100644
--- a/drivers/net/ethernet/mellanox/mlx5/core/lib/clock.h
+++ b/drivers/net/ethernet/mellanox/mlx5/core/lib/clock.h
@@ -33,8 +33,15 @@
 #ifndef __LIB_CLOCK_H__
 #define __LIB_CLOCK_H__
 
+#if IS_ENABLED(CONFIG_PTP_1588_CLOCK)
 void mlx5_init_clock(struct mlx5_core_dev *mdev);
 void mlx5_cleanup_clock(struct mlx5_core_dev *mdev);
+void mlx5_pps_event(struct mlx5_core_dev *dev, struct mlx5_eqe *eqe);
+
+static inline int mlx5_clock_get_ptp_index(struct mlx5_core_dev *mdev)
+{
+	return mdev->clock.ptp ? ptp_clock_index(mdev->clock.ptp) : -1;
+}
 
 static inline ktime_t mlx5_timecounter_cyc2time(struct mlx5_clock *clock,
 						u64 timestamp)
@@ -48,4 +55,21 @@ static inline ktime_t mlx5_timecounter_cyc2time(struct mlx5_clock *clock,
 	return ns_to_ktime(nsec);
 }
 
+#else
+static inline void mlx5_init_clock(struct mlx5_core_dev *mdev) {}
+static inline void mlx5_cleanup_clock(struct mlx5_core_dev *mdev) {}
+static inline void mlx5_pps_event(struct mlx5_core_dev *dev, struct mlx5_eqe *eqe) {}
+
+static inline int mlx5_clock_get_ptp_index(struct mlx5_core_dev *mdev)
+{
+	return -1;
+}
+
+static inline ktime_t mlx5_timecounter_cyc2time(struct mlx5_clock *clock,
+						u64 timestamp)
+{
+	return 0;
+}
+#endif
+
 #endif
diff --git a/drivers/net/ethernet/mellanox/mlx5/core/mlx5_core.h b/drivers/net/ethernet/mellanox/mlx5/core/mlx5_core.h
index 9eb14efe1c17..3d9fc48cd147 100644
--- a/drivers/net/ethernet/mellanox/mlx5/core/mlx5_core.h
+++ b/drivers/net/ethernet/mellanox/mlx5/core/mlx5_core.h
@@ -98,7 +98,6 @@ void mlx5_core_event(struct mlx5_core_dev *dev, enum mlx5_dev_event event,
 		     unsigned long param);
 void mlx5_core_page_fault(struct mlx5_core_dev *dev,
 			  struct mlx5_pagefault *pfault);
-void mlx5_pps_event(struct mlx5_core_dev *dev, struct mlx5_eqe *eqe);
 void mlx5_port_module_event(struct mlx5_core_dev *dev, struct mlx5_eqe *eqe);
 void mlx5_enter_error_state(struct mlx5_core_dev *dev);
 void mlx5_disable_device(struct mlx5_core_dev *dev);
