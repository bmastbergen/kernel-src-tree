IB/hfi1: Limit VNIC use of SDMA engines to the available count

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
commit-author Michael J. Ruhl <michael.j.ruhl@intel.com>
commit dd6c6a5a2e1e7be615c81ca6d44c2e89e22cb463
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/dd6c6a5a.failed

VNIC assumes that all SDMA engines have been configured for use.  This is
not necessarily true (i.e. if the count was constrained by the module
parameter).

Update VNICs usage to use the configured count, rather than the hardware
count.

	Reviewed-by: Mike Marciniszyn <mike.marciniszyn@intel.com>
	Reviewed-by: Gary Leshner <gary.s.leshner@intel.com>
	Signed-off-by: Michael J. Ruhl <michael.j.ruhl@intel.com>
	Signed-off-by: Dennis Dalessandro <dennis.dalessandro@intel.com>
	Signed-off-by: Jason Gunthorpe <jgg@mellanox.com>
(cherry picked from commit dd6c6a5a2e1e7be615c81ca6d44c2e89e22cb463)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/hw/hfi1/vnic_main.c
diff --cc drivers/infiniband/hw/hfi1/vnic_main.c
index f298ee097aa6,a922db58be14..000000000000
--- a/drivers/infiniband/hw/hfi1/vnic_main.c
+++ b/drivers/infiniband/hw/hfi1/vnic_main.c
@@@ -817,15 -815,15 +817,24 @@@ struct net_device *hfi1_vnic_alloc_rn(s
  		return ERR_PTR(-EOPNOTSUPP);
  
  	size = sizeof(struct opa_vnic_rdma_netdev) + sizeof(*vinfo);
++<<<<<<< HEAD
 +	netdev = alloc_netdev_mqs(size, name, setup,
 +				  dd->chip_sdma_engines, dd->num_vnic_contexts);
++=======
+ 	netdev = alloc_netdev_mqs(size, name, name_assign_type, setup,
+ 				  dd->num_sdma, dd->num_vnic_contexts);
++>>>>>>> dd6c6a5a2e1e (IB/hfi1: Limit VNIC use of SDMA engines to the available count)
  	if (!netdev)
  		return ERR_PTR(-ENOMEM);
  
  	rn = netdev_priv(netdev);
  	vinfo = opa_vnic_dev_priv(netdev);
  	vinfo->dd = dd;
++<<<<<<< HEAD
 +	vinfo->num_tx_q = dd->chip_sdma_engines;
++=======
+ 	vinfo->num_tx_q = dd->num_sdma;
++>>>>>>> dd6c6a5a2e1e (IB/hfi1: Limit VNIC use of SDMA engines to the available count)
  	vinfo->num_rx_q = dd->num_vnic_contexts;
  	vinfo->netdev = netdev;
  	rn->free_rdma_netdev = hfi1_vnic_free_rn;
* Unmerged path drivers/infiniband/hw/hfi1/vnic_main.c
