perf/core: Add sanity check to deal with pinned event failure

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
commit-author Reinette Chatre <reinette.chatre@intel.com>
commit befb1b3c2703897c5b8ffb0044dc5d0e5f27c5d7
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/befb1b3c.failed

It is possible that a failure can occur during the scheduling of a
pinned event. The initial portion of perf_event_read_local() contains
the various error checks an event should pass before it can be
considered valid. Ensure that the potential scheduling failure
of a pinned event is checked for and have a credible error.

	Suggested-by: Peter Zijlstra <peterz@infradead.org>
	Signed-off-by: Reinette Chatre <reinette.chatre@intel.com>
	Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
	Acked-by: Peter Zijlstra (Intel) <peterz@infradead.org>
	Cc: fenghua.yu@intel.com
	Cc: tony.luck@intel.com
	Cc: acme@kernel.org
	Cc: gavin.hindman@intel.com
	Cc: jithu.joseph@intel.com
	Cc: dave.hansen@intel.com
	Cc: hpa@zytor.com
	Cc: stable@vger.kernel.org
Link: https://lkml.kernel.org/r/6486385d1f30336e9973b24c8c65f5079543d3d3.1537377064.git.reinette.chatre@intel.com

(cherry picked from commit befb1b3c2703897c5b8ffb0044dc5d0e5f27c5d7)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	kernel/events/core.c
diff --cc kernel/events/core.c
index 49e3e6f05f32,dcb093e7b377..000000000000
--- a/kernel/events/core.c
+++ b/kernel/events/core.c
@@@ -3824,6 -3935,11 +3824,14 @@@ int perf_event_read_local(struct perf_e
  		goto out;
  	}
  
++<<<<<<< HEAD
++=======
+ 	/* If this is a pinned event it must be running on this CPU */
+ 	if (event->attr.pinned && event->oncpu != smp_processor_id()) {
+ 		ret = -EBUSY;
+ 		goto out;
+ 	}
++>>>>>>> befb1b3c2703 (perf/core: Add sanity check to deal with pinned event failure)
  
  	/*
  	 * If the event is currently on this CPU, its either a per-task event,
* Unmerged path kernel/events/core.c
