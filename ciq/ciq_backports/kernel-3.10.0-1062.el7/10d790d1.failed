watchdog: hpwdt: Disable PreTimeout when Timeout is smaller

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
Rebuild_CHGLOG: - [watchdog] hpwdt: Disable PreTimeout when Timeout is smaller (Joseph Szczypek) [1665272]
Rebuild_FUZZ: 90.74%
commit-author Jerry Hoemann <jerry.hoemann@hpe.com>
commit 10d790d1fa2e9487053f9a3a289ff198736fa964
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/10d790d1.failed

During module install, disable pretimeout if the requested timeout
value is not greater than the minimal pretimeout value that is
supported by hardware.

This makes the module load handling of pretimeout consistent
with the ioctl handling of pretimeout.

	Signed-off-by: Jerry Hoemann <jerry.hoemann@hpe.com>
	Reviewed-by: Guenter Roeck <linux@roeck-us.net>
	Signed-off-by: Guenter Roeck <linux@roeck-us.net>
	Signed-off-by: Wim Van Sebroeck <wim@linux-watchdog.org>
(cherry picked from commit 10d790d1fa2e9487053f9a3a289ff198736fa964)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/watchdog/hpwdt.c
diff --cc drivers/watchdog/hpwdt.c
index a7db4c1c73e8,93562304f7aa..000000000000
--- a/drivers/watchdog/hpwdt.c
+++ b/drivers/watchdog/hpwdt.c
@@@ -386,17 -307,29 +386,32 @@@ static int hpwdt_init_one(struct pci_de
  	if (retval != 0)
  		goto error_init_nmi_decoding;
  
++<<<<<<< HEAD
 +	retval = misc_register(&hpwdt_miscdev);
++=======
+ 	watchdog_set_nowayout(&hpwdt_dev, nowayout);
+ 	if (watchdog_init_timeout(&hpwdt_dev, soft_margin, NULL))
+ 		dev_warn(&dev->dev, "Invalid soft_margin: %d.\n", soft_margin);
+ 
+ 	if (pretimeout && hpwdt_dev.timeout <= PRETIMEOUT_SEC) {
+ 		dev_warn(&dev->dev, "timeout <= pretimeout. Setting pretimeout to zero\n");
+ 		pretimeout = 0;
+ 	}
+ 	hpwdt_dev.pretimeout = pretimeout ? PRETIMEOUT_SEC : 0;
+ 
+ 	hpwdt_dev.parent = &dev->dev;
+ 	retval = watchdog_register_device(&hpwdt_dev);
++>>>>>>> 10d790d1fa2e (watchdog: hpwdt: Disable PreTimeout when Timeout is smaller)
  	if (retval < 0) {
 -		dev_err(&dev->dev, "watchdog register failed: %d.\n", retval);
 -		goto error_wd_register;
 +		dev_warn(&dev->dev,
 +			"Unable to register miscdev on minor=%d (err=%d).\n",
 +			WATCHDOG_MINOR, retval);
 +		goto error_misc_register;
  	}
  
 -	dev_info(&dev->dev, "HPE Watchdog Timer Driver: Version: %s\n",
 -				HPWDT_VERSION);
 -	dev_info(&dev->dev, "timeout: %d seconds (nowayout=%d)\n",
 -				hpwdt_dev.timeout, nowayout);
 -	dev_info(&dev->dev, "pretimeout: %s.\n",
 -				pretimeout ? "on" : "off");
 +	dev_info(&dev->dev, "HPE Watchdog Timer Driver: %s"
 +			", timer margin: %d seconds (nowayout=%d).\n",
 +			HPWDT_VERSION, soft_margin, nowayout);
  
  	if (dev->subsystem_vendor == PCI_VENDOR_ID_HP_3PAR)
  		ilo5 = true;
* Unmerged path drivers/watchdog/hpwdt.c
