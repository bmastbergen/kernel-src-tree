IB/mlx5: Allow XRC usage via verbs in DEVX context

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
commit-author Yishai Hadas <yishaih@mellanox.com>
commit 5aa3771ded54894ce34f4ec6bc2bb403e6771eb2
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/5aa3771d.failed

Allows XRC usage from the verbs flow in a DEVX context.
As XRCD is some shared kernel resource between processes it should be
created with UID=0 to point on that.

As a result once XRC QP/SRQ are created they must be used as well with
UID=0 so that firmware will allow the XRCD usage.

	Signed-off-by: Yishai Hadas <yishaih@mellanox.com>
	Reviewed-by: Artemy Kovalyov <artemyko@mellanox.com>
	Signed-off-by: Leon Romanovsky <leonro@mellanox.com>
	Signed-off-by: Doug Ledford <dledford@redhat.com>
(cherry picked from commit 5aa3771ded54894ce34f4ec6bc2bb403e6771eb2)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/hw/mlx5/qp.c
diff --cc drivers/infiniband/hw/mlx5/qp.c
index 0e92d3e28641,48f2e1fbeff8..000000000000
--- a/drivers/infiniband/hw/mlx5/qp.c
+++ b/drivers/infiniband/hw/mlx5/qp.c
@@@ -5379,7 -5524,7 +5381,11 @@@ struct ib_xrcd *mlx5_ib_alloc_xrcd(stru
  	if (!xrcd)
  		return ERR_PTR(-ENOMEM);
  
++<<<<<<< HEAD
 +	err = mlx5_core_xrcd_alloc(dev->mdev, &xrcd->xrcdn);
++=======
+ 	err = mlx5_cmd_xrcd_alloc(dev->mdev, &xrcd->xrcdn, 0);
++>>>>>>> 5aa3771ded54 (IB/mlx5: Allow XRC usage via verbs in DEVX context)
  	if (err) {
  		kfree(xrcd);
  		return ERR_PTR(-ENOMEM);
@@@ -5394,7 -5539,7 +5400,11 @@@ int mlx5_ib_dealloc_xrcd(struct ib_xrc
  	u32 xrcdn = to_mxrcd(xrcd)->xrcdn;
  	int err;
  
++<<<<<<< HEAD
 +	err = mlx5_core_xrcd_dealloc(dev->mdev, xrcdn);
++=======
+ 	err = mlx5_cmd_xrcd_dealloc(dev->mdev, xrcdn, 0);
++>>>>>>> 5aa3771ded54 (IB/mlx5: Allow XRC usage via verbs in DEVX context)
  	if (err)
  		mlx5_ib_warn(dev, "failed to dealloc xrcdn 0x%x\n", xrcdn);
  
* Unmerged path drivers/infiniband/hw/mlx5/qp.c
diff --git a/drivers/infiniband/hw/mlx5/srq.c b/drivers/infiniband/hw/mlx5/srq.c
index ba4f811f0404..92fb299812c4 100644
--- a/drivers/infiniband/hw/mlx5/srq.c
+++ b/drivers/infiniband/hw/mlx5/srq.c
@@ -144,7 +144,7 @@ static int create_srq_user(struct ib_pd *pd, struct mlx5_ib_srq *srq,
 
 	in->log_page_size = page_shift - MLX5_ADAPTER_PAGE_SHIFT;
 	in->page_offset = offset;
-	in->uid = to_mpd(pd)->uid;
+	in->uid = (in->type != IB_SRQT_XRC) ?  to_mpd(pd)->uid : 0;
 	if (MLX5_CAP_GEN(dev->mdev, cqe_version) == MLX5_CQE_VERSION_V1 &&
 	    in->type != IB_SRQT_BASIC)
 		in->user_index = uidx;
