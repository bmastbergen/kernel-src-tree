ptp: check that rsv field is zero in struct ptp_sys_offset_extended

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
commit-author Eugene Syromiatnikov <esyr@redhat.com>
commit 895ac1376d5abcb94ca1b70a595579f253237790
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/895ac137.failed

Otherwise it is impossible to use it for something else, as it will break
userspace that puts garbage there.

The same check should be done in other structures, but the fact that
data in reserved fields is ignored is already part of the kernel ABI.

	Signed-off-by: Eugene Syromiatnikov <esyr@redhat.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 895ac1376d5abcb94ca1b70a595579f253237790)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/ptp/ptp_chardev.c
diff --cc drivers/ptp/ptp_chardev.c
index ddd1acf31245,7cbea796652a..000000000000
--- a/drivers/ptp/ptp_chardev.c
+++ b/drivers/ptp/ptp_chardev.c
@@@ -213,15 -213,42 +213,49 @@@ long ptp_ioctl(struct posix_clock *pc, 
  			err = -EFAULT;
  		break;
  
++<<<<<<< HEAD
++=======
+ 	case PTP_SYS_OFFSET_EXTENDED:
+ 		if (!ptp->info->gettimex64) {
+ 			err = -EOPNOTSUPP;
+ 			break;
+ 		}
+ 		extoff = memdup_user((void __user *)arg, sizeof(*extoff));
+ 		if (IS_ERR(extoff)) {
+ 			err = PTR_ERR(extoff);
+ 			extoff = NULL;
+ 			break;
+ 		}
+ 		if (extoff->n_samples > PTP_MAX_SAMPLES
+ 		    || extoff->rsv[0] || extoff->rsv[1] || extoff->rsv[2]) {
+ 			err = -EINVAL;
+ 			break;
+ 		}
+ 		for (i = 0; i < extoff->n_samples; i++) {
+ 			err = ptp->info->gettimex64(ptp->info, &ts, &sts);
+ 			if (err)
+ 				goto out;
+ 			extoff->ts[i][0].sec = sts.pre_ts.tv_sec;
+ 			extoff->ts[i][0].nsec = sts.pre_ts.tv_nsec;
+ 			extoff->ts[i][1].sec = ts.tv_sec;
+ 			extoff->ts[i][1].nsec = ts.tv_nsec;
+ 			extoff->ts[i][2].sec = sts.post_ts.tv_sec;
+ 			extoff->ts[i][2].nsec = sts.post_ts.tv_nsec;
+ 		}
+ 		if (copy_to_user((void __user *)arg, extoff, sizeof(*extoff)))
+ 			err = -EFAULT;
+ 		break;
+ 
++>>>>>>> 895ac1376d5a (ptp: check that rsv field is zero in struct ptp_sys_offset_extended)
  	case PTP_SYS_OFFSET:
 -		sysoff = memdup_user((void __user *)arg, sizeof(*sysoff));
 -		if (IS_ERR(sysoff)) {
 -			err = PTR_ERR(sysoff);
 -			sysoff = NULL;
 +		sysoff = kmalloc(sizeof(*sysoff), GFP_KERNEL);
 +		if (!sysoff) {
 +			err = -ENOMEM;
 +			break;
 +		}
 +		if (copy_from_user(sysoff, (void __user *)arg,
 +				   sizeof(*sysoff))) {
 +			err = -EFAULT;
  			break;
  		}
  		if (sysoff->n_samples > PTP_MAX_SAMPLES) {
* Unmerged path drivers/ptp/ptp_chardev.c
