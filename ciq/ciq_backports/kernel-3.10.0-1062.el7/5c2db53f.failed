RDMA/mlx5: Enable reformat on NIC RX if supported

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
commit-author Mark Bloch <markb@mellanox.com>
commit 5c2db53f62633689632aee7be9659418b2bf291f
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/5c2db53f.failed

A L3_TUNNEL_TO_L2 decap flow action requires to enable the encap bit on
the flow table, enable it if supported. This will allow to attach those
flow actions to NIC RX steering. We don't enable if running on a
representor.

	Signed-off-by: Mark Bloch <markb@mellanox.com>
	Signed-off-by: Leon Romanovsky <leonro@mellanox.com>
	Signed-off-by: Jason Gunthorpe <jgg@mellanox.com>
(cherry picked from commit 5c2db53f62633689632aee7be9659418b2bf291f)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/hw/mlx5/main.c
diff --cc drivers/infiniband/hw/mlx5/main.c
index 425b6c51ec22,b5f0ab88e064..000000000000
--- a/drivers/infiniband/hw/mlx5/main.c
+++ b/drivers/infiniband/hw/mlx5/main.c
@@@ -2919,13 -3089,29 +2919,37 @@@ static struct mlx5_ib_flow_prio *get_fl
  		else
  			priority = ib_prio_to_core_prio(flow_attr->priority,
  							dont_trap);
++<<<<<<< HEAD
 +		ns = mlx5_get_flow_namespace(dev->mdev,
 +					     ft_type == MLX5_IB_FT_TX ?
 +					     MLX5_FLOW_NAMESPACE_EGRESS :
 +					     MLX5_FLOW_NAMESPACE_BYPASS);
++=======
+ 		if (ft_type == MLX5_IB_FT_RX) {
+ 			fn_type = MLX5_FLOW_NAMESPACE_BYPASS;
+ 			prio = &dev->flow_db->prios[priority];
+ 			if (!dev->rep &&
+ 			    MLX5_CAP_FLOWTABLE_NIC_RX(dev->mdev, decap))
+ 				flags |= MLX5_FLOW_TABLE_TUNNEL_EN_DECAP;
+ 			if (!dev->rep &&
+ 			    MLX5_CAP_FLOWTABLE_NIC_RX(dev->mdev,
+ 					reformat_l3_tunnel_to_l2))
+ 				flags |= MLX5_FLOW_TABLE_TUNNEL_EN_REFORMAT;
+ 		} else {
+ 			max_table_size =
+ 				BIT(MLX5_CAP_FLOWTABLE_NIC_TX(dev->mdev,
+ 							      log_max_ft_size));
+ 			fn_type = MLX5_FLOW_NAMESPACE_EGRESS;
+ 			prio = &dev->flow_db->egress_prios[priority];
+ 			if (!dev->rep &&
+ 			    MLX5_CAP_FLOWTABLE_NIC_TX(dev->mdev, reformat))
+ 				flags |= MLX5_FLOW_TABLE_TUNNEL_EN_REFORMAT;
+ 		}
+ 		ns = mlx5_get_flow_namespace(dev->mdev, fn_type);
++>>>>>>> 5c2db53f6263 (RDMA/mlx5: Enable reformat on NIC RX if supported)
  		num_entries = MLX5_FS_MAX_ENTRIES;
  		num_groups = MLX5_FS_MAX_TYPES;
 +		prio = &dev->flow_db.prios[priority];
  	} else if (flow_attr->type == IB_FLOW_ATTR_ALL_DEFAULT ||
  		   flow_attr->type == IB_FLOW_ATTR_MC_DEFAULT) {
  		ns = mlx5_get_flow_namespace(dev->mdev,
* Unmerged path drivers/infiniband/hw/mlx5/main.c
