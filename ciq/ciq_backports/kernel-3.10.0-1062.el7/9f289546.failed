vti6: remove !skb->ignore_df check from vti6_xmit()

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
commit-author Alexey Kodanev <alexey.kodanev@oracle.com>
commit 9f2895461439fda2801a7906fb4c5fb3dbb37a0a
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/9f289546.failed

Before the commit d6990976af7c ("vti6: fix PMTU caching and reporting
on xmit") '!skb->ignore_df' check was always true because the function
skb_scrub_packet() was called before it, resetting ignore_df to zero.

In the commit, skb_scrub_packet() was moved below, and now this check
can be false for the packet, e.g. when sending it in the two fragments,
this prevents successful PMTU updates in such case. The next attempts
to send the packet lead to the same tx error. Moreover, vti6 initial
MTU value relies on PMTU adjustments.

This issue can be reproduced with the following LTP test script:
    udp_ipsec_vti.sh -6 -p ah -m tunnel -s 2000

Fixes: ccd740cbc6e0 ("vti6: Add pmtu handling to vti6_xmit.")
	Signed-off-by: Alexey Kodanev <alexey.kodanev@oracle.com>
	Acked-by: Steffen Klassert <steffen.klassert@secunet.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 9f2895461439fda2801a7906fb4c5fb3dbb37a0a)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/ipv6/ip6_vti.c
diff --cc net/ipv6/ip6_vti.c
index 120a9f7b6726,eeaf7455d51e..000000000000
--- a/net/ipv6/ip6_vti.c
+++ b/net/ipv6/ip6_vti.c
@@@ -466,13 -480,9 +466,18 @@@ vti6_xmit(struct sk_buff *skb, struct n
  		goto tx_err_dst_release;
  	}
  
 +	skb_scrub_packet(skb, !net_eq(t->net, dev_net(dev)));
 +	skb_dst_set(skb, dst);
 +	skb->dev = skb_dst(skb)->dev;
 +
  	mtu = dst_mtu(dst);
++<<<<<<< HEAD
 +	if (!skb->ignore_df && skb->len > mtu) {
 +		skb_dst(skb)->ops->update_pmtu(dst, NULL, skb, mtu);
++=======
+ 	if (skb->len > mtu) {
+ 		skb_dst_update_pmtu(skb, mtu);
++>>>>>>> 9f2895461439 (vti6: remove !skb->ignore_df check from vti6_xmit())
  
  		if (skb->protocol == htons(ETH_P_IPV6)) {
  			if (mtu < IPV6_MIN_MTU)
* Unmerged path net/ipv6/ip6_vti.c
