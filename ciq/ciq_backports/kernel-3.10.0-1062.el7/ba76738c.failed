netfilter: conntrack: introduce nf_ct_acct_update()

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
commit-author Pablo Neira Ayuso <pablo@netfilter.org>
commit ba76738c032ec0af3acbecd85c429c6a5c9e5e5e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/ba76738c.failed

Introduce a helper function to update conntrack counters.
__nf_ct_kill_acct() was unnecessarily subtracting skb_network_offset()
that is expected to be zero from the ipv4/ipv6 hooks.

	Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
(cherry picked from commit ba76738c032ec0af3acbecd85c429c6a5c9e5e5e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/netfilter/nf_conntrack_core.c
diff --cc net/netfilter/nf_conntrack_core.c
index 7cbb7812fc97,25e0c2677a12..000000000000
--- a/net/netfilter/nf_conntrack_core.c
+++ b/net/netfilter/nf_conntrack_core.c
@@@ -1322,15 -1273,8 +1337,20 @@@ void __nf_ct_refresh_acct(struct nf_con
  	}
  
  acct:
++<<<<<<< HEAD
 +	if (do_acct) {
 +		struct nf_conn_counter *acct;
 +
 +		acct = nf_conn_acct_find(ct);
 +		if (acct) {
 +			atomic64_inc(&acct[CTINFO2DIR(ctinfo)].packets);
 +			atomic64_add(skb->len, &acct[CTINFO2DIR(ctinfo)].bytes);
 +		}
 +	}
++=======
+ 	if (do_acct)
+ 		nf_ct_acct_update(ct, ctinfo, skb->len);
++>>>>>>> ba76738c032e (netfilter: conntrack: introduce nf_ct_acct_update())
  }
  EXPORT_SYMBOL_GPL(__nf_ct_refresh_acct);
  
@@@ -1339,16 -1283,8 +1359,21 @@@ bool __nf_ct_kill_acct(struct nf_conn *
  		       const struct sk_buff *skb,
  		       int do_acct)
  {
++<<<<<<< HEAD
 +	if (do_acct) {
 +		struct nf_conn_counter *acct;
 +
 +		acct = nf_conn_acct_find(ct);
 +		if (acct) {
 +			atomic64_inc(&acct[CTINFO2DIR(ctinfo)].packets);
 +			atomic64_add(skb->len - skb_network_offset(skb),
 +				     &acct[CTINFO2DIR(ctinfo)].bytes);
 +		}
 +	}
++=======
+ 	if (do_acct)
+ 		nf_ct_acct_update(ct, ctinfo, skb->len);
++>>>>>>> ba76738c032e (netfilter: conntrack: introduce nf_ct_acct_update())
  
  	if (del_timer(&ct->timeout)) {
  		ct->timeout.function((unsigned long)ct);
* Unmerged path net/netfilter/nf_conntrack_core.c
