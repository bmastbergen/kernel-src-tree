ovl: check whiteout in ovl_create_over_whiteout()

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
commit-author Miklos Szeredi <mszeredi@redhat.com>
commit 5e1275808630ea3b2c97c776f40e475017535f72
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/5e127580.failed

Kaixuxia repors that it's possible to crash overlayfs by removing the
whiteout on the upper layer before creating a directory over it.  This is a
reproducer:

 mkdir lower upper work merge
 touch lower/file
 mount -t overlay overlay -olowerdir=lower,upperdir=upper,workdir=work merge
 rm merge/file
 ls -al merge/file
 rm upper/file
 ls -al merge/
 mkdir merge/file

Before commencing with a vfs_rename(..., RENAME_EXCHANGE) verify that the
lookup of "upper" is positive and is a whiteout, and return ESTALE
otherwise.

Reported by: kaixuxia <xiakaixu1987@gmail.com>
	Signed-off-by: Miklos Szeredi <mszeredi@redhat.com>
Fixes: e9be9d5e76e3 ("overlay filesystem")
	Cc: <stable@vger.kernel.org> # v3.18
(cherry picked from commit 5e1275808630ea3b2c97c776f40e475017535f72)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/overlayfs/dir.c
diff --cc fs/overlayfs/dir.c
index 7fb210b2c5dc,c6289147c787..000000000000
--- a/fs/overlayfs/dir.c
+++ b/fs/overlayfs/dir.c
@@@ -433,12 -460,17 +433,24 @@@ static int ovl_create_over_whiteout(str
  			       dentry->d_name.len);
  	err = PTR_ERR(upper);
  	if (IS_ERR(upper))
++<<<<<<< HEAD
++=======
+ 		goto out_unlock;
+ 
+ 	err = -ESTALE;
+ 	if (d_is_negative(upper) || !IS_WHITEOUT(d_inode(upper)))
+ 		goto out_dput;
+ 
+ 	newdentry = ovl_create_temp(workdir, cattr);
+ 	err = PTR_ERR(newdentry);
+ 	if (IS_ERR(newdentry))
++>>>>>>> 5e1275808630 (ovl: check whiteout in ovl_create_over_whiteout())
  		goto out_dput;
  
 +	err = ovl_create_real(wdir, newdentry, cattr, hardlink, true);
 +	if (err)
 +		goto out_dput2;
 +
  	/*
  	 * mode could have been mutilated due to umask (e.g. sgid directory)
  	 */
* Unmerged path fs/overlayfs/dir.c
