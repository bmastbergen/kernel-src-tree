kvm: nVMX: Remove nested_vmx_succeed after successful VM-entry

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
commit-author Jim Mattson <jmattson@google.com>
commit 7881f96cac4d420c94e62a4e1eea243899a7052e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/7881f96c.failed

After a successful VM-entry, RFLAGS is cleared, with the exception of
bit 1, which is always set. This is handled by load_vmcs12_host_state.

	Signed-off-by: Jim Mattson <jmattson@google.com>
	Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
(cherry picked from commit 7881f96cac4d420c94e62a4e1eea243899a7052e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kvm/vmx.c
diff --cc arch/x86/kvm/vmx.c
index 943c67ec799e,29f85ed5a329..000000000000
--- a/arch/x86/kvm/vmx.c
+++ b/arch/x86/kvm/vmx.c
@@@ -11384,19 -11489,21 +11384,28 @@@ static void nested_vmx_vmexit(struct kv
  	 * We are now running in L2, mmu_notifier will force to reload the
  	 * page's hpa for L2 vmcs. Need to reload it for L1 before entering L1.
  	 */
 -	kvm_make_request(KVM_REQ_APIC_PAGE_RELOAD, vcpu);
 +	kvm_vcpu_reload_apic_access_page(vcpu);
  
- 	/*
- 	 * Exiting from L2 to L1, we're now back to L1 which thinks it just
- 	 * finished a VMLAUNCH or VMRESUME instruction, so we need to set the
- 	 * success or failure flag accordingly.
- 	 */
  	if (unlikely(vmx->fail)) {
+ 		/*
+ 		 * After an early L2 VM-entry failure, we're now back
+ 		 * in L1 which thinks it just finished a VMLAUNCH or
+ 		 * VMRESUME instruction, so we need to set the failure
+ 		 * flag and the VM-instruction error field of the VMCS
+ 		 * accordingly.
+ 		 */
  		vmx->fail = 0;
++<<<<<<< HEAD
 +		nested_vmx_failValid(vcpu, vmcs_read32(VM_INSTRUCTION_ERROR));
 +	} else
 +		nested_vmx_succeed(vcpu);
 +	if (enable_shadow_vmcs && exit_reason != -1)
++=======
+ 		nested_vmx_failValid(vcpu, vm_inst_error);
+ 	}
+ 
+ 	if (enable_shadow_vmcs)
++>>>>>>> 7881f96cac4d (kvm: nVMX: Remove nested_vmx_succeed after successful VM-entry)
  		vmx->nested.sync_shadow_vmcs = true;
  
  	/* in case we halted in L2 */
* Unmerged path arch/x86/kvm/vmx.c
