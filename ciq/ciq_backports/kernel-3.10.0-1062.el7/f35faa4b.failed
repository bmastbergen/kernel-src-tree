IB/core: Simplify ib_query_gid to always refer to cache

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
commit-author Parav Pandit <parav@mellanox.com>
commit f35faa4ba9568138eea1c58abb92e8ef415dce41
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/f35faa4b.failed

Currently following inconsistencies exist.
1. ib_query_gid() returns GID from the software cache for a RoCE port
and returns GID from the HCA for an IB port.
This is incorrect because software GID cache is maintained regardless
of HCA port type.

2. GID is queries from the HCA via ib_query_gid and updated in the
software cache for IB link layer. Both of them might not be in sync.

ULPs such as SRP initiator, SRP target, IPoIB driver have historically
used ib_query_gid() API to query the GID. However CM used cached version
during CM processing, When software cache was introduced, this
inconsitency remained.

In order to simplify, improve readability and avoid link layer
specific above inconsistencies, this patch brings following changes.

1. ib_query_gid() always refers to the cache layer regardless of link
layer.

2. cache module who reads the GID entry from HCA and builds the cache,
directly invokes the HCA provider verb's query_gid() callback function.

3. ib_query_port() is being called in early stage where GID cache is not
yet build while reading port immutable property. Therefore it needs to
read the default GID from the HCA for IB link layer to publish the
subnet prefix.

	Signed-off-by: Parav Pandit <parav@mellanox.com>
	Signed-off-by: Leon Romanovsky <leonro@mellanox.com>
	Signed-off-by: Jason Gunthorpe <jgg@mellanox.com>
(cherry picked from commit f35faa4ba9568138eea1c58abb92e8ef415dce41)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/core/device.c
diff --cc drivers/infiniband/core/device.c
index affdae4a3ef9,601ff782e5f3..000000000000
--- a/drivers/infiniband/core/device.c
+++ b/drivers/infiniband/core/device.c
@@@ -868,13 -877,7 +868,17 @@@ int ib_query_gid(struct ib_device *devi
  		 u8 port_num, int index, union ib_gid *gid,
  		 struct ib_gid_attr *attr)
  {
++<<<<<<< HEAD
 +	if (rdma_protocol_roce(device, port_num))
 +		return ib_get_cached_gid(device, port_num, index, gid, attr);
 +
 +	if (attr)
 +		return -EINVAL;
 +
 +	return device->query_gid(device, port_num, index, gid);
++=======
+ 	return ib_get_cached_gid(device, port_num, index, gid, attr);
++>>>>>>> f35faa4ba956 (IB/core: Simplify ib_query_gid to always refer to cache)
  }
  EXPORT_SYMBOL(ib_query_gid);
  
diff --git a/drivers/infiniband/core/cache.c b/drivers/infiniband/core/cache.c
index 8ce9acd96a1f..83787429a4dc 100644
--- a/drivers/infiniband/core/cache.c
+++ b/drivers/infiniband/core/cache.c
@@ -1116,8 +1116,8 @@ static void ib_cache_update(struct ib_device *device,
 
 	if (!use_roce_gid_table) {
 		for (i = 0;  i < gid_cache->table_len; ++i) {
-			ret = ib_query_gid(device, port, i,
-					   gid_cache->table + i, NULL);
+			ret = device->query_gid(device, port, i,
+						gid_cache->table + i);
 			if (ret) {
 				pr_warn("ib_query_gid failed (%d) for %s (index %d)\n",
 					ret, device->name, i);
* Unmerged path drivers/infiniband/core/device.c
