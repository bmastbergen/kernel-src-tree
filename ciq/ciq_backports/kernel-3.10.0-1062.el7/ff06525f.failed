igmp: fix incorrect unsolicit report count after link down and up

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
commit-author Hangbin Liu <liuhangbin@gmail.com>
commit ff06525fcb8ae3c302ac1319bf6c07c026dea964
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/ff06525f.failed

After link down and up, i.e. when call ip_mc_up(), we doesn't init
im->unsolicit_count. So after igmp_timer_expire(), we will not start
timer again and only send one unsolicit report at last.

Fix it by initializing im->unsolicit_count in igmp_group_added(), so
we can respect igmp robustness value.

Fixes: 24803f38a5c0b ("igmp: do not remove igmp souce list info when set link down")
	Signed-off-by: Hangbin Liu <liuhangbin@gmail.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit ff06525fcb8ae3c302ac1319bf6c07c026dea964)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/ipv4/igmp.c
diff --cc net/ipv4/igmp.c
index 38eb23973038,4da39446da2d..000000000000
--- a/net/ipv4/igmp.c
+++ b/net/ipv4/igmp.c
@@@ -1230,9 -1305,13 +1230,11 @@@ static void igmp_group_added(struct ip_
  
  	if (in_dev->dead)
  		return;
+ 
+ 	im->unsolicit_count = net->ipv4.sysctl_igmp_qrv;
  	if (IGMP_V1_SEEN(in_dev) || IGMP_V2_SEEN(in_dev)) {
  		spin_lock_bh(&im->lock);
 -		igmp_start_timer(im, IGMP_INITIAL_REPORT_DELAY);
 +		igmp_start_timer(im, IGMP_Initial_Report_Delay);
  		spin_unlock_bh(&im->lock);
  		return;
  	}
@@@ -1284,11 -1414,10 +1286,15 @@@ static void __ip_mc_inc_group(struct in
  	/* initial mode is (EX, empty) */
  	im->sfmode = mode;
  	im->sfcount[mode] = 1;
 -	refcount_set(&im->refcnt, 1);
 +	atomic_set(&im->refcnt, 1);
  	spin_lock_init(&im->lock);
  #ifdef CONFIG_IP_MULTICAST
++<<<<<<< HEAD
 +	setup_timer(&im->timer, &igmp_timer_expire, (unsigned long)im);
 +	im->unsolicit_count = sysctl_igmp_qrv;
++=======
+ 	timer_setup(&im->timer, igmp_timer_expire, 0);
++>>>>>>> ff06525fcb8a (igmp: fix incorrect unsolicit report count after link down and up)
  #endif
  
  	im->next_rcu = in_dev->mc_list;
* Unmerged path net/ipv4/igmp.c
