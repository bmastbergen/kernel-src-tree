s390/kdump: Make elfcorehdr size calculation ABI compliant

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
Rebuild_CHGLOG: - [s390] kdump: Make elfcorehdr size calculation ABI compliant (Hendrik Brueckner) [1656017]
Rebuild_FUZZ: 95.50%
commit-author Philipp Rudo <prudo@linux.ibm.com>
commit 263b0e480c9b0fda77a89f5d6375d8a39de5c166
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/263b0e48.failed

There are two ways to pass the vmcoreinfo to the crash kernel 1) via the
os_info mechanism and 2) via the lowcore->vmcore_info field. In the Linux
kernel only the second way is used. However, the first way is ABI for
stand-alone kdump. So other OSes use it to pass additional debug info. Make
the elfcorehdr size calculation aware of both possible ways.

Fixes: 8cce437fbb5c ("s390/kdump: Fix elfcorehdr size calculation")
	Signed-off-by: Philipp Rudo <prudo@linux.ibm.com>
	Acked-by: Heiko Carstens <heiko.carstens@de.ibm.com>
	Signed-off-by: Heiko Carstens <heiko.carstens@de.ibm.com>
(cherry picked from commit 263b0e480c9b0fda77a89f5d6375d8a39de5c166)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/s390/kernel/crash_dump.c
diff --cc arch/s390/kernel/crash_dump.c
index 04e93148c09a,4b2773e1ddfe..000000000000
--- a/arch/s390/kernel/crash_dump.c
+++ b/arch/s390/kernel/crash_dump.c
@@@ -489,7 -473,39 +489,43 @@@ static void *nt_vmcoreinfo(void *ptr
  		vmcoreinfo = get_vmcoreinfo_old(&size);
  	if (!vmcoreinfo)
  		return ptr;
++<<<<<<< HEAD
 +	return nt_init(ptr, 0, vmcoreinfo, size, "VMCOREINFO");
++=======
+ 	return nt_init_name(ptr, 0, vmcoreinfo, size, "VMCOREINFO");
+ }
+ 
+ static size_t nt_vmcoreinfo_size(void)
+ {
+ 	const char *name = VMCOREINFO_NOTE_NAME;
+ 	unsigned long size;
+ 	void *vmcoreinfo;
+ 
+ 	vmcoreinfo = os_info_old_entry(OS_INFO_VMCOREINFO, &size);
+ 	if (vmcoreinfo)
+ 		return nt_size_name(size, name);
+ 
+ 	vmcoreinfo = get_vmcoreinfo_old(&size);
+ 	if (!vmcoreinfo)
+ 		return 0;
+ 
+ 	kfree(vmcoreinfo);
+ 	return nt_size_name(size, name);
+ }
+ 
+ /*
+  * Initialize final note (needed for /proc/vmcore code)
+  */
+ static void *nt_final(void *ptr)
+ {
+ 	Elf64_Nhdr *note;
+ 
+ 	note = (Elf64_Nhdr *) ptr;
+ 	note->n_namesz = 0;
+ 	note->n_descsz = 0;
+ 	note->n_type = 0;
+ 	return PTR_ADD(ptr, sizeof(Elf64_Nhdr));
++>>>>>>> 263b0e480c9b (s390/kdump: Make elfcorehdr size calculation ABI compliant)
  }
  
  /*
* Unmerged path arch/s390/kernel/crash_dump.c
