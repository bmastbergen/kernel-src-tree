KVM: VMX: don't configure EPT identity map for unrestricted guest

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
commit-author Sean Christopherson <sean.j.christopherson@intel.com>
commit e90008df1678676fb7e51b4cf38ee0f18c38aeba
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/e90008df.failed

An unrestricted guest can run with hardware CR0.PG==0, i.e.
IA32 paging disabled, in which case there is no need to load
the guest's CR3 with identity mapped IA32 page tables since
hardware will effectively ignore CR3.  If unrestricted guest
is enabled, don't configure the identity mapped IA32 page
table and always load the guest's desired CR3.

	Signed-off-by: Sean Christopherson <sean.j.christopherson@intel.com>
	Signed-off-by: Radim Krčmář <rkrcmar@redhat.com>
(cherry picked from commit e90008df1678676fb7e51b4cf38ee0f18c38aeba)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kvm/vmx.c
diff --cc arch/x86/kvm/vmx.c
index e0eeb7f8160f,39216aee60c0..000000000000
--- a/arch/x86/kvm/vmx.c
+++ b/arch/x86/kvm/vmx.c
@@@ -9484,10 -9802,7 +9485,14 @@@ static struct kvm_vcpu *vmx_create_vcpu
  			goto free_vmcs;
  	}
  
++<<<<<<< HEAD
 +	if (enable_ept) {
 +		if (!kvm->arch.ept_identity_map_addr)
 +			kvm->arch.ept_identity_map_addr =
 +				VMX_EPT_IDENTITY_PAGETABLE_ADDR;
++=======
+ 	if (enable_ept && !enable_unrestricted_guest) {
++>>>>>>> e90008df1678 (KVM: VMX: don't configure EPT identity map for unrestricted guest)
  		err = init_rmode_identity_map(kvm);
  		if (err)
  			goto free_vmcs;
* Unmerged path arch/x86/kvm/vmx.c
