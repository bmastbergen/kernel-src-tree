nfs: Fix a missed page unlock after pg_doio()

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
commit-author Benjamin Coddington <bcodding@redhat.com>
commit fdbd1a2e4a71adcb1ae219fcfd964930d77a7f84
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/fdbd1a2e.failed

We must check pg_error and call error_cleanup after any call to pg_doio.
Currently, we are skipping the unlock of a page if we encounter an error in
nfs_pageio_complete() before handing off the work to the RPC layer.

	Signed-off-by: Benjamin Coddington <bcodding@redhat.com>
	Cc: stable@vger.kernel.org
	Signed-off-by: Trond Myklebust <trond.myklebust@hammerspace.com>
(cherry picked from commit fdbd1a2e4a71adcb1ae219fcfd964930d77a7f84)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/nfs/pagelist.c
diff --cc fs/nfs/pagelist.c
index 8d1eebcb3e8c,3b50edf6f883..000000000000
--- a/fs/nfs/pagelist.c
+++ b/fs/nfs/pagelist.c
@@@ -1171,25 -1174,11 +1185,33 @@@ int nfs_pageio_add_request(struct nfs_p
  	return 1;
  
  out_failed:
++<<<<<<< HEAD
 +	/*
 +	 * We might have failed before sending any reqs over wire.
 +	 * Clean up rest of the reqs in mirror pg_list.
 +	 */
 +	if (desc->pg_error) {
 +		struct nfs_pgio_mirror *mirror;
 +		void (*func)(struct list_head *);
 +
 +		/* remember fatal errors */
 +		if (nfs_error_is_fatal(desc->pg_error))
 +			mapping_set_error(desc->pg_inode->i_mapping,
 +					  desc->pg_error);
 +
 +		func = desc->pg_completion_ops->error_cleanup;
 +		for (midx = 0; midx < desc->pg_mirror_count; midx++) {
 +			mirror = &desc->pg_mirrors[midx];
 +			func(&mirror->pg_list);
 +		}
 +	}
++=======
+ 	/* remember fatal errors */
+ 	if (nfs_error_is_fatal(desc->pg_error))
+ 		nfs_context_set_write_error(req->wb_context,
+ 						desc->pg_error);
+ 	nfs_pageio_error_cleanup(desc);
++>>>>>>> fdbd1a2e4a71 (nfs: Fix a missed page unlock after pg_doio())
  	return 0;
  }
  
* Unmerged path fs/nfs/pagelist.c
