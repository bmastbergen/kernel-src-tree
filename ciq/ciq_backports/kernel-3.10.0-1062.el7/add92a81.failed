crypto: chelsio - Fix memory corruption in DMA Mapped buffers.

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
Rebuild_CHGLOG: - [crypto] chelsio: Fix memory corruption in DMA Mapped buffers (Arjun Vynipadath) [1647732]
Rebuild_FUZZ: 89.47%
commit-author Harsh Jain <harsh@chelsio.com>
commit add92a817e60e308a419693413a38d9d1e663aff
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/add92a81.failed

Update PCI Id in "cpl_rx_phys_dsgl" header. In case pci_chan_id and
tx_chan_id are not derived from same queue, H/W can send request
completion indication before completing DMA Transfer.

Herbert, It would be good if fix can be merge to stable tree.
For 4.14 kernel, It requires some update to avoid mege conficts.

	Cc: <stable@vger.kernel.org>
	Signed-off-by: Harsh Jain <harsh@chelsio.com>
	Signed-off-by: Herbert Xu <herbert@gondor.apana.org.au>
(cherry picked from commit add92a817e60e308a419693413a38d9d1e663aff)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/crypto/chelsio/chcr_algo.c
diff --cc drivers/crypto/chelsio/chcr_algo.c
index b247c17c57c7,010bbf607797..000000000000
--- a/drivers/crypto/chelsio/chcr_algo.c
+++ b/drivers/crypto/chelsio/chcr_algo.c
@@@ -2530,11 -2518,11 +2540,16 @@@ void chcr_add_aead_dst_ent(struct aead_
  	dsgl_walk_init(&dsgl_walk, phys_cpl);
  	if (reqctx->b0_len)
  		dsgl_walk_add_page(&dsgl_walk, reqctx->b0_len, &reqctx->b0_dma);
 -	dsgl_walk_add_sg(&dsgl_walk, req->dst, assoclen, 0);
 +	dsgl_walk_add_sg(&dsgl_walk, req->assoc, assoclen, 0);
  	dsgl_walk_add_page(&dsgl_walk, IV, &reqctx->iv_dma);
  	temp = req->cryptlen + (reqctx->op ? -authsize : authsize);
++<<<<<<< HEAD
 +	dsgl_walk_add_sg(&dsgl_walk, req->dst, temp, 0);
 +	dsgl_walk_end(&dsgl_walk, qid);
++=======
+ 	dsgl_walk_add_sg(&dsgl_walk, req->dst, temp, req->assoclen);
+ 	dsgl_walk_end(&dsgl_walk, qid, ctx->pci_chan_id);
++>>>>>>> add92a817e60 (crypto: chelsio - Fix memory corruption in DMA Mapped buffers.)
  }
  
  void chcr_add_cipher_src_ent(struct ablkcipher_request *req,
* Unmerged path drivers/crypto/chelsio/chcr_algo.c
diff --git a/drivers/crypto/chelsio/chcr_crypto.h b/drivers/crypto/chelsio/chcr_crypto.h
index 54835cb109e5..0d2c70c344f3 100644
--- a/drivers/crypto/chelsio/chcr_crypto.h
+++ b/drivers/crypto/chelsio/chcr_crypto.h
@@ -255,6 +255,8 @@ struct chcr_context {
 	struct chcr_dev *dev;
 	unsigned char tx_qidx;
 	unsigned char rx_qidx;
+	unsigned char tx_chan_id;
+	unsigned char pci_chan_id;
 	struct __crypto_ctx crypto_ctx[0];
 };
 
