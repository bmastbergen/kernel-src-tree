x86/ras/amd: Make sysfs names of banks more user-friendly

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
Rebuild_CHGLOG: - [x86] ras/amd: Make sysfs names of banks more user-friendly (David Arcari) [1676301]
Rebuild_FUZZ: 96.36%
commit-author Yazen Ghannam <Yazen.Ghannam@amd.com>
commit 0b737a9c2af85cc8295f9308d9250f9111bbf94d
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/0b737a9c.failed

Currently, we append the MCA_IPID[InstanceId] to the bank name to create
the sysfs filename. The InstanceId field uniquely identifies a bank
instance but it doesn't look very nice for most banks.

Replace the InstanceId with a simpler, ascending (0, 1, ..) value.
Only use this in the sysfs name when there is more than 1 instance.
Otherwise, just use the bank's name as the sysfs name.

	Signed-off-by: Yazen Ghannam <Yazen.Ghannam@amd.com>
	Signed-off-by: Borislav Petkov <bp@suse.de>
	Cc: Linus Torvalds <torvalds@linux-foundation.org>
	Cc: Peter Zijlstra <peterz@infradead.org>
	Cc: Thomas Gleixner <tglx@linutronix.de>
	Cc: Tony Luck <tony.luck@intel.com>
	Cc: linux-edac <linux-edac@vger.kernel.org>
Link: http://lkml.kernel.org/r/1484322741-41884-3-git-send-email-Yazen.Ghannam@amd.com
Link: http://lkml.kernel.org/r/20170123183514.13356-4-bp@alien8.de
	Signed-off-by: Ingo Molnar <mingo@kernel.org>
(cherry picked from commit 0b737a9c2af85cc8295f9308d9250f9111bbf94d)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kernel/cpu/mcheck/mce_amd.c
diff --cc arch/x86/kernel/cpu/mcheck/mce_amd.c
index 51c289e3aca6,776379e4a39c..000000000000
--- a/arch/x86/kernel/cpu/mcheck/mce_amd.c
+++ b/arch/x86/kernel/cpu/mcheck/mce_amd.c
@@@ -163,8 -185,14 +163,9 @@@ static void get_smca_bank_info(unsigne
  	for (i = 0; i < ARRAY_SIZE(smca_hwid_mcatypes); i++) {
  		s_hwid = &smca_hwid_mcatypes[i];
  		if (hwid_mcatype == s_hwid->hwid_mcatype) {
 -
 -			WARN(smca_banks[bank].hwid,
 -			     "Bank %s already initialized!\n",
 -			     smca_get_name(s_hwid->bank_type));
 -
  			smca_banks[bank].hwid = s_hwid;
  			smca_banks[bank].id = instance_id;
+ 			smca_banks[bank].sysfs_id = s_hwid->count++;
  			break;
  		}
  	}
@@@ -1031,9 -1065,12 +1032,17 @@@ static const char *get_name(unsigned in
  		return NULL;
  	}
  
+ 	if (smca_banks[bank].hwid->count == 1)
+ 		return smca_get_name(bank_type);
+ 
  	snprintf(buf_mcatype, MAX_MCATYPE_NAME_LEN,
++<<<<<<< HEAD
 +		 "%s_%x", smca_names[bank_type].name,
 +			  smca_banks[bank].id);
++=======
+ 		 "%s_%x", smca_get_name(bank_type),
+ 			  smca_banks[bank].sysfs_id);
++>>>>>>> 0b737a9c2af8 (x86/ras/amd: Make sysfs names of banks more user-friendly)
  	return buf_mcatype;
  }
  
diff --git a/arch/x86/include/asm/mce.h b/arch/x86/include/asm/mce.h
index 24cc5fd74543..1ca23944cd25 100644
--- a/arch/x86/include/asm/mce.h
+++ b/arch/x86/include/asm/mce.h
@@ -379,12 +379,13 @@ struct smca_hwid {
 	unsigned int bank_type;	/* Use with smca_bank_types for easy indexing. */
 	u32 hwid_mcatype;	/* (hwid,mcatype) tuple */
 	u32 xec_bitmap;		/* Bitmap of valid ExtErrorCodes; current max is 21. */
+	u8 count;		/* Number of instances. */
 };
 
 struct smca_bank {
 	struct smca_hwid *hwid;
-	/* Instance ID */
-	u32 id;
+	u32 id;			/* Value of MCA_IPID[InstanceId]. */
+	u8 sysfs_id;		/* Value used for sysfs name. */
 };
 
 extern struct smca_bank smca_banks[MAX_NR_BANKS];
* Unmerged path arch/x86/kernel/cpu/mcheck/mce_amd.c
