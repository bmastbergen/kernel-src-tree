mm: numa: add migrated transhuge pages to LRU the same way as base pages

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
Rebuild_CHGLOG: - [mm] numa: add migrated transhuge pages to LRU the same way as base pages (Andrea Arcangeli) [1636066]
Rebuild_FUZZ: 97.14%
commit-author Mel Gorman <mgorman@suse.de>
commit 11de9927f9dd3cb0a0f18064fa4b6976fc37e79c
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/11de9927.failed

Migration of misplaced transhuge pages uses page_add_new_anon_rmap() when
putting the page back as it avoided an atomic operations and added the new
page to the correct LRU.  A side-effect is that the page gets marked
activated as part of the migration meaning that transhuge and base pages
are treated differently from an aging perspective than base page
migration.

This patch uses page_add_anon_rmap() and putback_lru_page() on completion
of a transhuge migration similar to base page migration.  It would require
fewer atomic operations to use lru_cache_add without taking an additional
reference to the page.  The downside would be that it's still different to
base page migration and unevictable pages may be added to the wrong LRU
for cleaning up later.  Testing of the usual workloads did not show any
adverse impact to the change.

	Signed-off-by: Mel Gorman <mgorman@suse.de>
	Cc: Rik van Riel <riel@redhat.com>
	Cc: Sasha Levin <sasha.levin@oracle.com>
	Acked-by: Hugh Dickins <hughd@google.com>
	Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
	Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
(cherry picked from commit 11de9927f9dd3cb0a0f18064fa4b6976fc37e79c)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	mm/migrate.c
diff --cc mm/migrate.c
index dc35415df847,6247be7fa30e..000000000000
--- a/mm/migrate.c
+++ b/mm/migrate.c
@@@ -1876,8 -1852,8 +1876,13 @@@ fail_putback
  	 * guarantee the copy is visible before the pagetable update.
  	 */
  	flush_cache_range(vma, mmun_start, mmun_end);
++<<<<<<< HEAD
 +	page_add_new_anon_rmap(new_page, vma, mmun_start);
 +	pmdp_clear_flush_notify(vma, mmun_start, pmd);
++=======
+ 	page_add_anon_rmap(new_page, vma, mmun_start);
+ 	pmdp_clear_flush(vma, mmun_start, pmd);
++>>>>>>> 11de9927f9dd (mm: numa: add migrated transhuge pages to LRU the same way as base pages)
  	set_pmd_at(mm, mmun_start, pmd, entry);
  	flush_tlb_range(vma, mmun_start, mmun_end);
  	update_mmu_cache_pmd(vma, address, &entry);
* Unmerged path mm/migrate.c
