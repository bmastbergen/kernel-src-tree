perf buildid-cache: Support --purge-all option

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
commit-author Ravi Bangoria <ravi.bangoria@linux.vnet.ibm.com>
commit 9a73c308542bea74df921e9bb9fb07d39bbf2cfa
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/9a73c308.failed

User can remove files from cache using --remove/--purge options but both
needs list of files as an argument. It's not convenient when you want to
flush out entire cache. Add an option to purge all files from cache.

Ex,
  # perf buildid-cache -l
    8a86ef73e44067bca52cc3f6cd3e5446c783391c /tmp/a.out
    ebe71fdcf4b366518cc154d570a33cd461a51c36 /tmp/a.out.1
  # perf buildid-cache -P -v
    Removing /tmp/a.out (8a86ef73e44067bca52cc3f6cd3e5446c783391c): Ok
    Removing /tmp/a.out.1 (ebe71fdcf4b366518cc154d570a33cd461a51c36): Ok
    Purged all: Ok

	Signed-off-by: Ravi Bangoria <ravi.bangoria@linux.vnet.ibm.com>
	Acked-by: Jiri Olsa <jolsa@kernel.org>
	Cc: Alexander Shishkin <alexander.shishkin@linux.intel.com>
	Cc: Kate Stewart <kstewart@linuxfoundation.org>
	Cc: Krister Johansen <kjlx@templeofstupid.com>
	Cc: Masami Hiramatsu <mhiramat@kernel.org>
	Cc: Namhyung Kim <namhyung@kernel.org>
	Cc: Peter Zijlstra <peterz@infradead.org>
	Cc: Philippe Ombredanne <pombredanne@nexb.com>
	Cc: Sihyeon Jang <uneedsihyeon@gmail.com>
	Cc: Thomas Gleixner <tglx@linutronix.de>
Link: http://lkml.kernel.org/r/20180417041346.5617-4-ravi.bangoria@linux.vnet.ibm.com
[ Initialize 'err' in build_id_cache__purge_all(), to fix build on debian:7, as it can be used uninitialized ]
	Signed-off-by: Arnaldo Carvalho de Melo <acme@redhat.com>
(cherry picked from commit 9a73c308542bea74df921e9bb9fb07d39bbf2cfa)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/perf/builtin-buildid-cache.c
diff --cc tools/perf/builtin-buildid-cache.c
index 76cff7bc13f3,7a7403913b57..000000000000
--- a/tools/perf/builtin-buildid-cache.c
+++ b/tools/perf/builtin-buildid-cache.c
@@@ -286,7 -351,11 +314,13 @@@ int cmd_buildid_cache(int argc, const c
  	struct strlist *list;
  	struct str_node *pos;
  	int ret = 0;
 -	int ns_id = -1;
  	bool force = false;
++<<<<<<< HEAD
++=======
+ 	bool list_files = false;
+ 	bool opts_flag = false;
+ 	bool purge_all = false;
++>>>>>>> 9a73c308542b (perf buildid-cache: Support --purge-all option)
  	char const *add_name_list_str = NULL,
  		   *remove_name_list_str = NULL,
  		   *purge_name_list_str = NULL,
@@@ -309,6 -379,8 +343,11 @@@
  		    "file(s) to remove"),
  	OPT_STRING('p', "purge", &purge_name_list_str, "file list",
  		    "file(s) to remove (remove old caches too)"),
++<<<<<<< HEAD
++=======
+ 	OPT_BOOLEAN('P', "purge-all", &purge_all, "purge all cached files"),
+ 	OPT_BOOLEAN('l', "list", &list_files, "list all cached files"),
++>>>>>>> 9a73c308542b (perf buildid-cache: Support --purge-all option)
  	OPT_STRING('M', "missing", &missing_filename, "file",
  		   "to find missing build ids in the cache"),
  	OPT_BOOLEAN('f', "force", &force, "don't complain, do it"),
@@@ -325,11 -398,23 +364,20 @@@
  	argc = parse_options(argc, argv, buildid_cache_options,
  			     buildid_cache_usage, 0);
  
++<<<<<<< HEAD
 +	if (argc || (!add_name_list_str && !kcore_filename &&
 +		     !remove_name_list_str && !purge_name_list_str &&
 +		     !missing_filename && !update_name_list_str))
++=======
+ 	opts_flag = add_name_list_str || kcore_filename ||
+ 		remove_name_list_str || purge_name_list_str ||
+ 		missing_filename || update_name_list_str ||
+ 		purge_all;
+ 
+ 	if (argc || !(list_files || opts_flag))
++>>>>>>> 9a73c308542b (perf buildid-cache: Support --purge-all option)
  		usage_with_options(buildid_cache_usage, buildid_cache_options);
  
 -	/* -l is exclusive. It can not be used with other options. */
 -	if (list_files && opts_flag) {
 -		usage_with_options_msg(buildid_cache_usage,
 -			buildid_cache_options, "-l is exclusive.\n");
 -	}
 -
 -	if (ns_id > 0)
 -		nsi = nsinfo__new(ns_id);
 -
  	if (missing_filename) {
  		data.file.path = missing_filename;
  		data.force     = force;
diff --git a/tools/perf/Documentation/perf-buildid-cache.txt b/tools/perf/Documentation/perf-buildid-cache.txt
index 0a93f271b143..5d166c823f1c 100644
--- a/tools/perf/Documentation/perf-buildid-cache.txt
+++ b/tools/perf/Documentation/perf-buildid-cache.txt
@@ -48,6 +48,9 @@ OPTIONS
 --purge=::
         Purge all cached binaries including older caches which have specified
 	path from the cache.
+-P::
+--purge-all::
+	Purge all cached binaries. This will flush out entire cache.
 -M::
 --missing=::
 	List missing build ids in the cache for the specified file.
* Unmerged path tools/perf/builtin-buildid-cache.c
