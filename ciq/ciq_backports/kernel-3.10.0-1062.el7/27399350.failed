RDMA/core: Assign device ifindex before publishing the device

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
commit-author Parav Pandit <parav@mellanox.com>
commit 273993509f05623934dda14a56237738149b2906
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/27399350.failed

Even though device->ifindex is assigned before adding the device in the
list which is read by netlink flow, it is better to assign rdma device
index before publishing the device in the system to users and clients.

	Signed-off-by: Parav Pandit <parav@mellanox.com>
	Reviewed-by: Daniel Jurgens <danielj@mellanox.com>
	Signed-off-by: Leon Romanovsky <leonro@mellanox.com>
	Signed-off-by: Jason Gunthorpe <jgg@mellanox.com>
(cherry picked from commit 273993509f05623934dda14a56237738149b2906)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/core/device.c
diff --cc drivers/infiniband/core/device.c
index 910f35ee49f7,5a680a88aa87..000000000000
--- a/drivers/infiniband/core/device.c
+++ b/drivers/infiniband/core/device.c
@@@ -526,6 -525,14 +526,17 @@@ int ib_register_device(struct ib_devic
  		goto port_cleanup;
  	}
  
++<<<<<<< HEAD
++=======
+ 	device->index = __dev_new_index();
+ 
+ 	ret = ib_device_register_rdmacg(device);
+ 	if (ret) {
+ 		pr_warn("Couldn't register device with rdma cgroup\n");
+ 		goto cache_cleanup;
+ 	}
+ 
++>>>>>>> 273993509f05 (RDMA/core: Assign device ifindex before publishing the device)
  	memset(&device->attrs, 0, sizeof(device->attrs));
  	ret = device->query_device(device, &device->attrs, &uhw);
  	if (ret) {
* Unmerged path drivers/infiniband/core/device.c
