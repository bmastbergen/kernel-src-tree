net: Fix a bug in removing queues from XPS map

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
Rebuild_CHGLOG: - [net] Fix a bug in removing queues from XPS map (Paolo Abeni) [1623813]
Rebuild_FUZZ: 94.25%
commit-author Amritha Nambiar <amritha.nambiar@intel.com>
commit 6358d49ac23995fdfe157cc8747ab0f274d3954b
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/6358d49a.failed

While removing queues from the XPS map, the individual CPU ID
alone was used to index the CPUs map, this should be changed to also
factor in the traffic class mapping for the CPU-to-queue lookup.

Fixes: 184c449f91fe ("net: Add support for XPS with QoS via traffic classes")
	Signed-off-by: Amritha Nambiar <amritha.nambiar@intel.com>
	Acked-by: Alexander Duyck <alexander.h.duyck@intel.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 6358d49ac23995fdfe157cc8747ab0f274d3954b)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/core/dev.c
diff --cc net/core/dev.c
index 98359d9d215d,2af787e8b130..000000000000
--- a/net/core/dev.c
+++ b/net/core/dev.c
@@@ -2122,14 -2116,22 +2122,26 @@@ static bool remove_xps_queue_cpu(struc
  				 struct xps_dev_maps *dev_maps,
  				 int cpu, u16 offset, u16 count)
  {
 -	int num_tc = dev->num_tc ? : 1;
 -	bool active = false;
 -	int tci;
 +	int i, j;
  
++<<<<<<< HEAD
 +	for (i = count, j = offset; i--; j++) {
 +		if (!remove_xps_queue(dev_maps, cpu, j))
 +			break;
++=======
+ 	for (tci = cpu * num_tc; num_tc--; tci++) {
+ 		int i, j;
+ 
+ 		for (i = count, j = offset; i--; j++) {
+ 			if (!remove_xps_queue(dev_maps, tci, j))
+ 				break;
+ 		}
+ 
+ 		active |= i < 0;
++>>>>>>> 6358d49ac239 (net: Fix a bug in removing queues from XPS map)
  	}
  
 -	return active;
 +	return i < 0;
  }
  
  static void netif_reset_xps_queues(struct net_device *dev, u16 offset,
* Unmerged path net/core/dev.c
