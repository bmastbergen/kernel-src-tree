ovl: verify stored origin fh matches lower dir

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
commit-author Amir Goldstein <amir73il@gmail.com>
commit 37b12916c0f802d956c767db984801d3100c6524
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/37b12916.failed

When the NFS export feature is enabled, overlayfs implicitly enables the
feature "verify_lower". When the "verify_lower" feature is enabled, a
directory inode found in lower layer by name or by redirect_dir is
verified against the file handle of the copy up origin that is stored in
the upper layer.

This introduces a change of behavior for the case of lower layer
modification while overlay is offline. A lower directory created or
moved offline under an exisitng upper directory, will not be merged with
that upper directory.

The NFS export feature should not be used after copying layers, because
the new lower directory inodes would fail verification and won't be
merged with upper directories.

	Signed-off-by: Amir Goldstein <amir73il@gmail.com>
	Signed-off-by: Miklos Szeredi <mszeredi@redhat.com>
(cherry picked from commit 37b12916c0f802d956c767db984801d3100c6524)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/overlayfs/namei.c
diff --cc fs/overlayfs/namei.c
index 0afb8ae29e9b,69ca8eb07519..000000000000
--- a/fs/overlayfs/namei.c
+++ b/fs/overlayfs/namei.c
@@@ -662,8 -725,32 +662,35 @@@ struct dentry *ovl_lookup(struct inode 
  		if (!this)
  			continue;
  
++<<<<<<< HEAD
++=======
+ 		/*
+ 		 * If no origin fh is stored in upper of a merge dir, store fh
+ 		 * of lower dir and set upper parent "impure".
+ 		 */
+ 		if (upperdentry && !ctr && !ofs->noxattr) {
+ 			err = ovl_fix_origin(dentry, this, upperdentry);
+ 			if (err) {
+ 				dput(this);
+ 				goto out_put;
+ 			}
+ 		}
+ 
+ 		/*
+ 		 * When "verify_lower" feature is enabled, do not merge with a
+ 		 * lower dir that does not match a stored origin xattr.
+ 		 */
+ 		if (upperdentry && !ctr && ovl_verify_lower(dentry->d_sb)) {
+ 			err = ovl_verify_origin(upperdentry, this, false);
+ 			if (err) {
+ 				dput(this);
+ 				break;
+ 			}
+ 		}
+ 
++>>>>>>> 37b12916c0f8 (ovl: verify stored origin fh matches lower dir)
  		stack[ctr].dentry = this;
 -		stack[ctr].layer = lower.layer;
 +		stack[ctr].mnt = lowerpath.mnt;
  		ctr++;
  
  		if (d.stop)
* Unmerged path fs/overlayfs/namei.c
