IB/core: Introduce counters read verb

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
commit-author Raed Salem <raeds@mellanox.com>
commit 51d7a5387464f1b1fee3f2db9287409189d83d65
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/51d7a538.failed

The user supplies counters instance and a reference to an output array of
uint64_t.  The driver reads the hardware counters values and writes them
to the output index location in the user supplied array.  All counters
values are represented as uint64_t types.

To be able to successfully read the data the counters must be first bound
to an IB object.

Downstream patches will present binding method for flow counters.

	Reviewed-by: Yishai Hadas <yishaih@mellanox.com>
	Signed-off-by: Raed Salem <raeds@mellanox.com>
	Signed-off-by: Leon Romanovsky <leonro@mellanox.com>
	Signed-off-by: Jason Gunthorpe <jgg@mellanox.com>
(cherry picked from commit 51d7a5387464f1b1fee3f2db9287409189d83d65)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	include/rdma/ib_verbs.h
diff --cc include/rdma/ib_verbs.h
index 991a6332b9b0,3769a1cc99b0..000000000000
--- a/include/rdma/ib_verbs.h
+++ b/include/rdma/ib_verbs.h
@@@ -2159,6 -2180,26 +2159,29 @@@ struct ib_port_pkey_list 
  	struct list_head              pkey_list;
  };
  
++<<<<<<< HEAD
++=======
+ struct ib_counters {
+ 	struct ib_device	*device;
+ 	struct ib_uobject	*uobject;
+ 	/* num of objects attached */
+ 	atomic_t	usecnt;
+ };
+ 
+ enum ib_read_counters_flags {
+ 	/* prefer read values from driver cache */
+ 	IB_READ_COUNTERS_ATTR_PREFER_CACHED = 1 << 0,
+ };
+ 
+ struct ib_counters_read_attr {
+ 	u64	*counters_buff;
+ 	u32	ncounters;
+ 	u32	flags; /* use enum ib_read_counters_flags */
+ };
+ 
+ struct uverbs_attr_bundle;
+ 
++>>>>>>> 51d7a5387464 (IB/core: Introduce counters read verb)
  struct ib_device {
  	/* Do not access @dma_device directly from ULP nor from HW drivers. */
  	struct device                *dma_device;
@@@ -2416,6 -2454,28 +2439,31 @@@
  							   struct ib_rwq_ind_table_init_attr *init_attr,
  							   struct ib_udata *udata);
  	int                        (*destroy_rwq_ind_table)(struct ib_rwq_ind_table *wq_ind_table);
++<<<<<<< HEAD
++=======
+ 	struct ib_flow_action *	   (*create_flow_action_esp)(struct ib_device *device,
+ 							     const struct ib_flow_action_attrs_esp *attr,
+ 							     struct uverbs_attr_bundle *attrs);
+ 	int			   (*destroy_flow_action)(struct ib_flow_action *action);
+ 	int			   (*modify_flow_action_esp)(struct ib_flow_action *action,
+ 							     const struct ib_flow_action_attrs_esp *attr,
+ 							     struct uverbs_attr_bundle *attrs);
+ 	struct ib_dm *             (*alloc_dm)(struct ib_device *device,
+ 					       struct ib_ucontext *context,
+ 					       struct ib_dm_alloc_attr *attr,
+ 					       struct uverbs_attr_bundle *attrs);
+ 	int                        (*dealloc_dm)(struct ib_dm *dm);
+ 	struct ib_mr *             (*reg_dm_mr)(struct ib_pd *pd, struct ib_dm *dm,
+ 						struct ib_dm_mr_attr *attr,
+ 						struct uverbs_attr_bundle *attrs);
+ 	struct ib_counters *	(*create_counters)(struct ib_device *device,
+ 						   struct uverbs_attr_bundle *attrs);
+ 	int	(*destroy_counters)(struct ib_counters	*counters);
+ 	int	(*read_counters)(struct ib_counters *counters,
+ 				 struct ib_counters_read_attr *counters_read_attr,
+ 				 struct uverbs_attr_bundle *attrs);
+ 
++>>>>>>> 51d7a5387464 (IB/core: Introduce counters read verb)
  	/**
  	 * rdma netdev operation
  	 *
* Unmerged path include/rdma/ib_verbs.h
