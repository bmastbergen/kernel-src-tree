net: add LINUX_MIB_PFMEMALLOCDROP counter

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
Rebuild_CHGLOG: - [net] add LINUX_MIB_PFMEMALLOCDROP counter (Marcelo Leitner) [1696664]
Rebuild_FUZZ: 93.51%
commit-author Eric Dumazet <edumazet@google.com>
commit 8fe809a992639b2013c0d8da2ba55cdea28a959a
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/8fe809a9.failed

Debugging issues caused by pfmemalloc is often tedious.

Add a new SNMP counter to more easily diagnose these problems.

	Signed-off-by: Eric Dumazet <edumazet@google.com>
	Cc: Josef Bacik <jbacik@fb.com>
	Acked-by: Josef Bacik <jbacik@fb.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 8fe809a992639b2013c0d8da2ba55cdea28a959a)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/core/filter.c
diff --cc net/core/filter.c
index d9b11f9993e7,0b753cbb2536..000000000000
--- a/net/core/filter.c
+++ b/net/core/filter.c
@@@ -90,8 -76,13 +90,16 @@@ int sk_filter_trim_cap(struct sock *sk
  	 * allow SOCK_MEMALLOC sockets to use it as this socket is
  	 * helping free memory
  	 */
- 	if (skb_pfmemalloc(skb) && !sock_flag(sk, SOCK_MEMALLOC))
+ 	if (skb_pfmemalloc(skb) && !sock_flag(sk, SOCK_MEMALLOC)) {
+ 		NET_INC_STATS(sock_net(sk), LINUX_MIB_PFMEMALLOCDROP);
  		return -ENOMEM;
++<<<<<<< HEAD
++=======
+ 	}
+ 	err = BPF_CGROUP_RUN_PROG_INET_INGRESS(sk, skb);
+ 	if (err)
+ 		return err;
++>>>>>>> 8fe809a99263 (net: add LINUX_MIB_PFMEMALLOCDROP counter)
  
  	err = security_sock_rcv_skb(sk, skb);
  	if (err)
diff --git a/include/uapi/linux/snmp.h b/include/uapi/linux/snmp.h
index 081cc866c1bb..ee9a877f4781 100644
--- a/include/uapi/linux/snmp.h
+++ b/include/uapi/linux/snmp.h
@@ -241,6 +241,7 @@ enum
 	LINUX_MIB_SACKMERGED,
 	LINUX_MIB_SACKSHIFTFALLBACK,
 	LINUX_MIB_TCPBACKLOGDROP,
+	LINUX_MIB_PFMEMALLOCDROP,
 	LINUX_MIB_TCPMINTTLDROP, /* RFC 5082 */
 	LINUX_MIB_TCPDEFERACCEPTDROP,
 	LINUX_MIB_IPRPFILTER, /* IP Reverse Path Filter (rp_filter) */
* Unmerged path net/core/filter.c
diff --git a/net/ipv4/proc.c b/net/ipv4/proc.c
index 6a99f5fc4f8c..5d1b126c025d 100644
--- a/net/ipv4/proc.c
+++ b/net/ipv4/proc.c
@@ -260,6 +260,7 @@ static const struct snmp_mib snmp4_net_list[] = {
 	SNMP_MIB_ITEM("TCPSackMerged", LINUX_MIB_SACKMERGED),
 	SNMP_MIB_ITEM("TCPSackShiftFallback", LINUX_MIB_SACKSHIFTFALLBACK),
 	SNMP_MIB_ITEM("TCPBacklogDrop", LINUX_MIB_TCPBACKLOGDROP),
+	SNMP_MIB_ITEM("PFMemallocDrop", LINUX_MIB_PFMEMALLOCDROP),
 	SNMP_MIB_ITEM("TCPMinTTLDrop", LINUX_MIB_TCPMINTTLDROP),
 	SNMP_MIB_ITEM("TCPDeferAcceptDrop", LINUX_MIB_TCPDEFERACCEPTDROP),
 	SNMP_MIB_ITEM("IPReversePathFilter", LINUX_MIB_IPRPFILTER),
