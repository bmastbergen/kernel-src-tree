gfs2: gfs2_stuffed_write_end cleanup

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
commit-author Andreas Gruenbacher <agruenba@redhat.com>
commit d6382a3505d289ec2df55a822f1fd72d9a72d256
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/d6382a35.failed

First, change the sanity check in gfs2_stuffed_write_end to check for
the actual write size instead of the requested write size.

Second, use the existing teardown code in gfs2_write_end instead of
duplicating it in gfs2_stuffed_write_end.

	Signed-off-by: Andreas Gruenbacher <agruenba@redhat.com>
	Signed-off-by: Bob Peterson <rpeterso@redhat.com>
(cherry picked from commit d6382a3505d289ec2df55a822f1fd72d9a72d256)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/gfs2/aops.c
diff --cc fs/gfs2/aops.c
index cacd7512318a,69f25e3c97ce..000000000000
--- a/fs/gfs2/aops.c
+++ b/fs/gfs2/aops.c
@@@ -941,19 -885,20 +923,28 @@@ static int gfs2_write_end(struct file *
  	BUG_ON(gfs2_glock_is_locked_by_me(ip->i_gl) == NULL);
  
  	ret = gfs2_meta_inode_buffer(ip, &dibh);
++<<<<<<< HEAD
 +	if (unlikely(ret)) {
 +		unlock_page(page);
 +		page_cache_release(page);
 +		goto failed;
 +	}
++=======
+ 	if (unlikely(ret))
+ 		goto out;
++>>>>>>> d6382a3505d2 (gfs2: gfs2_stuffed_write_end cleanup)
  
- 	if (gfs2_is_stuffed(ip))
- 		return gfs2_stuffed_write_end(inode, dibh, pos, len, copied, page);
+ 	if (gfs2_is_stuffed(ip)) {
+ 		ret = gfs2_stuffed_write_end(inode, dibh, pos, copied, page);
+ 		page = NULL;
+ 		goto out2;
+ 	}
  
  	if (!gfs2_is_writeback(ip))
 -		gfs2_page_add_databufs(ip, page, pos & ~PAGE_MASK, len);
 +		gfs2_page_add_databufs(ip, page, from, to);
  
  	ret = generic_write_end(file, mapping, pos, len, copied, page, fsdata);
+ 	page = NULL;
  	if (tr->tr_num_buf_new)
  		__mark_inode_dirty(inode, I_DIRTY_DATASYNC);
  	else
* Unmerged path fs/gfs2/aops.c
