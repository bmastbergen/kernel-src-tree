net: xdp: added bpf_netdev_command XDP_{QUERY, SETUP}_XSK_UMEM

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
Rebuild_CHGLOG: - [net] xdp: added bpf_netdev_command XDP_{QUERY, SETUP}_XSK_UMEM (Petr Oros) [1647135]
Rebuild_FUZZ: 95.80%
commit-author Björn Töpel <bjorn.topel@intel.com>
commit 74515c5750f30244a901c3c0c82a2fe534b3c9c5
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/74515c57.failed

Extend ndo_bpf with two new commands used for query zero-copy support
and register an UMEM to a queue_id of a netdev.

	Signed-off-by: Björn Töpel <bjorn.topel@intel.com>
	Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
(cherry picked from commit 74515c5750f30244a901c3c0c82a2fe534b3c9c5)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	include/linux/netdevice.h
diff --cc include/linux/netdevice.h
index 63a3866ea81e,cc4ea7ab6d24..000000000000
--- a/include/linux/netdevice.h
+++ b/include/linux/netdevice.h
@@@ -1000,22 -805,60 +1000,46 @@@ enum xdp_netdev_command 
  	 * when it is no longer used.
  	 */
  	XDP_SETUP_PROG,
 -	XDP_SETUP_PROG_HW,
  	/* Check if a bpf program is set on the device.  The callee should
 -	 * set @prog_attached to one of XDP_ATTACHED_* values, note that "true"
 -	 * is equivalent to XDP_ATTACHED_DRV.
 +	 * return true if a program is currently attached and running.
  	 */
  	XDP_QUERY_PROG,
++<<<<<<< HEAD
 +};
 +
 +struct netdev_xdp {
 +	enum xdp_netdev_command command;
++=======
+ 	/* BPF program for offload callbacks, invoked at program load time. */
+ 	BPF_OFFLOAD_VERIFIER_PREP,
+ 	BPF_OFFLOAD_TRANSLATE,
+ 	BPF_OFFLOAD_DESTROY,
+ 	BPF_OFFLOAD_MAP_ALLOC,
+ 	BPF_OFFLOAD_MAP_FREE,
+ 	XDP_QUERY_XSK_UMEM,
+ 	XDP_SETUP_XSK_UMEM,
+ };
+ 
+ struct bpf_prog_offload_ops;
+ struct netlink_ext_ack;
+ struct xdp_umem;
+ 
+ struct netdev_bpf {
+ 	enum bpf_netdev_command command;
++>>>>>>> 74515c5750f3 (net: xdp: added bpf_netdev_command XDP_{QUERY, SETUP}_XSK_UMEM)
  	union {
  		/* XDP_SETUP_PROG */
 -		struct {
 -			u32 flags;
 -			struct bpf_prog *prog;
 -			struct netlink_ext_ack *extack;
 -		};
 +		struct bpf_prog *prog;
  		/* XDP_QUERY_PROG */
  		struct {
 -			u8 prog_attached;
 +			bool prog_attached;
  			u32 prog_id;
 -			/* flags with which program was installed */
 -			u32 prog_flags;
 -		};
 -		/* BPF_OFFLOAD_VERIFIER_PREP */
 -		struct {
 -			struct bpf_prog *prog;
 -			const struct bpf_prog_offload_ops *ops; /* callee set */
 -		} verifier;
 -		/* BPF_OFFLOAD_TRANSLATE, BPF_OFFLOAD_DESTROY */
 -		struct {
 -			struct bpf_prog *prog;
 -		} offload;
 -		/* BPF_OFFLOAD_MAP_ALLOC, BPF_OFFLOAD_MAP_FREE */
 -		struct {
 -			struct bpf_offloaded_map *offmap;
  		};
+ 		/* XDP_SETUP_XSK_UMEM */
+ 		struct {
+ 			struct xdp_umem *umem;
+ 			u16 queue_id;
+ 		} xsk;
  	};
  };
  
* Unmerged path include/linux/netdevice.h
