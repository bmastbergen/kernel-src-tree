netfilter: nf_tables: bump set->ndeact on set flush

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
commit-author Pablo Neira Ayuso <pablo@netfilter.org>
commit b2c11e4b9536ebab6b39929e1fe15f57039ab445
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/b2c11e4b.failed

Add missing set->ndeact update on each deactivated element from the set
flush path. Otherwise, sets with fixed size break after flush since
accounting breaks.

 # nft add set x y { type ipv4_addr\; size 2\; }
 # nft add element x y { 1.1.1.1 }
 # nft add element x y { 1.1.1.2 }
 # nft flush set x y
 # nft add element x y { 1.1.1.1 }
 <cmdline>:1:1-28: Error: Could not process rule: Too many open files in system

Fixes: 8411b6442e59 ("netfilter: nf_tables: support for set flushing")
	Reported-by: Elise Lennion <elise.lennion@gmail.com>
	Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
(cherry picked from commit b2c11e4b9536ebab6b39929e1fe15f57039ab445)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/netfilter/nf_tables_api.c
diff --cc net/netfilter/nf_tables_api.c
index e2ddb2bff2ce,1b913760f205..000000000000
--- a/net/netfilter/nf_tables_api.c
+++ b/net/netfilter/nf_tables_api.c
@@@ -3649,6 -3889,35 +3649,38 @@@ err1
  	return err;
  }
  
++<<<<<<< HEAD
++=======
+ static int nft_flush_set(const struct nft_ctx *ctx,
+ 			 struct nft_set *set,
+ 			 const struct nft_set_iter *iter,
+ 			 struct nft_set_elem *elem)
+ {
+ 	struct nft_trans *trans;
+ 	int err;
+ 
+ 	trans = nft_trans_alloc_gfp(ctx, NFT_MSG_DELSETELEM,
+ 				    sizeof(struct nft_trans_elem), GFP_ATOMIC);
+ 	if (!trans)
+ 		return -ENOMEM;
+ 
+ 	if (!set->ops->deactivate_one(ctx->net, set, elem->priv)) {
+ 		err = -ENOENT;
+ 		goto err1;
+ 	}
+ 	set->ndeact++;
+ 
+ 	nft_trans_elem_set(trans) = set;
+ 	nft_trans_elem(trans) = *elem;
+ 	list_add_tail(&trans->list, &ctx->net->nft.commit_list);
+ 
+ 	return 0;
+ err1:
+ 	kfree(trans);
+ 	return err;
+ }
+ 
++>>>>>>> b2c11e4b9536 (netfilter: nf_tables: bump set->ndeact on set flush)
  static int nf_tables_delsetelem(struct net *net, struct sock *nlsk,
  				struct sk_buff *skb, const struct nlmsghdr *nlh,
  				const struct nlattr * const nla[])
* Unmerged path net/netfilter/nf_tables_api.c
