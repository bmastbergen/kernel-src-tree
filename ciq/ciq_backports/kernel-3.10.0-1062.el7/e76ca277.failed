powerpc/sysfs: Fix reference leak of cpu device_nodes present at boot

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
Rebuild_CHGLOG: - [powerpc] sysfs: Fix reference leak of cpu device_nodes present at boot (Desnes Augusto Nunes do Rosario) [1674261]
Rebuild_FUZZ: 93.85%
commit-author Tyrel Datwyler <tyreld@linux.vnet.ibm.com>
commit e76ca27790a514590af782f83f6eae49e0ccf8c9
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/e76ca277.failed

For CPUs present at boot each logical CPU acquires a reference to the
associated device node of the core. This happens in register_cpu() which
is called by topology_init(). The result of this is that we end up with
a reference held by each thread of the core. However, these references
are never freed if the CPU core is DLPAR removed.

This patch fixes the reference leaks by acquiring and releasing the references
in the CPU hotplug callbacks un/register_cpu_online(). With this patch symmetric
reference counting is observed with both CPUs present at boot, and those DLPAR
added after boot.

Fixes: f86e4718f24b ("driver/core: cpu: initialize of_node in cpu's device struture")
	Cc: stable@vger.kernel.org # v3.12+
	Signed-off-by: Tyrel Datwyler <tyreld@linux.vnet.ibm.com>
	Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
(cherry picked from commit e76ca27790a514590af782f83f6eae49e0ccf8c9)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/powerpc/kernel/sysfs.c
diff --cc arch/powerpc/kernel/sysfs.c
index 1b47504224a3,949957b97ead..000000000000
--- a/arch/powerpc/kernel/sysfs.c
+++ b/arch/powerpc/kernel/sysfs.c
@@@ -586,7 -858,20 +590,14 @@@ static void unregister_cpu_online(unsig
  		device_remove_file(s, &dev_attr_pir);
  #endif /* CONFIG_PPC64 */
  
 -#ifdef CONFIG_PPC_FSL_BOOK3E
 -	if (PVR_VER(cur_cpu_spec->pvr_value) == PVR_VER_E6500) {
 -		device_remove_file(s, &dev_attr_pw20_state);
 -		device_remove_file(s, &dev_attr_pw20_wait_time);
 -
 -		device_remove_file(s, &dev_attr_altivec_idle);
 -		device_remove_file(s, &dev_attr_altivec_idle_wait_time);
 -	}
 -#endif
  	cacheinfo_cpu_offline(cpu);
++<<<<<<< HEAD
++=======
+ 	of_node_put(s->of_node);
+ 	s->of_node = NULL;
+ #endif /* CONFIG_HOTPLUG_CPU */
+ 	return 0;
++>>>>>>> e76ca27790a5 (powerpc/sysfs: Fix reference leak of cpu device_nodes present at boot)
  }
  
  #ifdef CONFIG_ARCH_CPU_PROBE_RELEASE
* Unmerged path arch/powerpc/kernel/sysfs.c
