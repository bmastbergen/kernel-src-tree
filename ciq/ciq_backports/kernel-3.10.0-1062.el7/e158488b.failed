locking/rwsem: Fix (possible) missed wakeup

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
commit-author Xie Yongji <xieyongji@baidu.com>
commit e158488be27b157802753a59b336142dc0eb0380
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/e158488b.failed

Because wake_q_add() can imply an immediate wakeup (cmpxchg failure
case), we must not rely on the wakeup being delayed. However, commit:

  e38513905eea ("locking/rwsem: Rework zeroing reader waiter->task")

relies on exactly that behaviour in that the wakeup must not happen
until after we clear waiter->task.

[ peterz: Added changelog. ]

	Signed-off-by: Xie Yongji <xieyongji@baidu.com>
	Signed-off-by: Zhang Yu <zhangyu31@baidu.com>
	Signed-off-by: Peter Zijlstra (Intel) <peterz@infradead.org>
	Cc: Linus Torvalds <torvalds@linux-foundation.org>
	Cc: Peter Zijlstra <peterz@infradead.org>
	Cc: Thomas Gleixner <tglx@linutronix.de>
Fixes: e38513905eea ("locking/rwsem: Rework zeroing reader waiter->task")
Link: https://lkml.kernel.org/r/1543495830-2644-1-git-send-email-xieyongji@baidu.com
	Signed-off-by: Ingo Molnar <mingo@kernel.org>
(cherry picked from commit e158488be27b157802753a59b336142dc0eb0380)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	lib/rwsem.c
diff --cc lib/rwsem.c
index dcbfa1eac830,50d9af615dc4..000000000000
--- a/lib/rwsem.c
+++ b/lib/rwsem.c
@@@ -196,10 -198,10 +196,15 @@@ static void __rwsem_mark_wake(struct rw
  		woken++;
  		tsk = waiter->task;
  
++<<<<<<< HEAD:lib/rwsem.c
 +		wake_q_add(wake_q, tsk);
 +		slist_del(&waiter->list, &sem->wait_list);
++=======
+ 		get_task_struct(tsk);
+ 		list_del(&waiter->list);
++>>>>>>> e158488be27b (locking/rwsem: Fix (possible) missed wakeup):kernel/locking/rwsem-xadd.c
  		/*
- 		 * Ensure that the last operation is setting the reader
+ 		 * Ensure calling get_task_struct() before setting the reader
  		 * waiter to nil such that rwsem_down_read_failed() cannot
  		 * race with do_exit() by always holding a reference count
  		 * to the task to wakeup.
* Unmerged path lib/rwsem.c
