net: Fix nexthop lookups

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
Rebuild_CHGLOG: - [net] Fix nexthop lookups (Guillaume Nault) [1535977]
Rebuild_FUZZ: 88.37%
commit-author David Ahern <dsa@cumulusnetworks.com>
commit 4c9bcd117918ba6096d01194565e9d1814e5ef22
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/4c9bcd11.failed

Andreas reported breakage adding routes with local nexthops:
$ ip route show table main
...
172.28.0.0/24 dev vnf-xe1p0  proto kernel  scope link  src 172.28.0.16

$ ip route add 10.0.0.0/8 via 172.28.0.32 table 100 dev vnf-xe1p0
RTNETLINK answers: Resource temporarily unavailable

3bfd847203c changed the lookup to use the passed in table but for cases like
this the nexthop is in the local table rather than the passed in table.

Fixes: 3bfd847203c ("net: Use passed in table for nexthop lookups")
	Reported-by: Andreas Schultz <aschultz@tpip.net>
	Signed-off-by: David Ahern <dsa@cumulusnetworks.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 4c9bcd117918ba6096d01194565e9d1814e5ef22)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/ipv4/fib_semantics.c
diff --cc net/ipv4/fib_semantics.c
index b3ccf81b8829,01f1c7dcd329..000000000000
--- a/net/ipv4/fib_semantics.c
+++ b/net/ipv4/fib_semantics.c
@@@ -787,7 -704,24 +787,28 @@@ static int fib_check_nh(struct fib_conf
  			/* It is not necessary, but requires a bit of thinking */
  			if (fl4.flowi4_scope < RT_SCOPE_LINK)
  				fl4.flowi4_scope = RT_SCOPE_LINK;
++<<<<<<< HEAD
 +			err = fib_lookup(net, &fl4, &res);
++=======
+ 
+ 			if (cfg->fc_table)
+ 				tbl = fib_get_table(net, cfg->fc_table);
+ 
+ 			if (tbl)
+ 				err = fib_table_lookup(tbl, &fl4, &res,
+ 						       FIB_LOOKUP_IGNORE_LINKSTATE |
+ 						       FIB_LOOKUP_NOREF);
+ 
+ 			/* on error or if no table given do full lookup. This
+ 			 * is needed for example when nexthops are in the local
+ 			 * table rather than the given table
+ 			 */
+ 			if (!tbl || err) {
+ 				err = fib_lookup(net, &fl4, &res,
+ 						 FIB_LOOKUP_IGNORE_LINKSTATE);
+ 			}
+ 
++>>>>>>> 4c9bcd117918 (net: Fix nexthop lookups)
  			if (err) {
  				rcu_read_unlock();
  				return err;
* Unmerged path net/ipv4/fib_semantics.c
