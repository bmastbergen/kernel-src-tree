nfp: flower: release metadata on offload failure

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
commit-author John Hurley <john.hurley@netronome.com>
commit 1166494891da88af25c444e65cd4f32c3e026b46
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/11664948.failed

Calling nfp_compile_flow_metadata both assigns a stats context and
increments a ref counter on (or allocates) a mask id table entry. These
are released by the nfp_modify_flow_metadata call on flow deletion,
however, if a flow add fails after metadata is set then the flow entry
will be deleted but the metadata assignments leaked.

Add an error path to the flow add offload function to ensure allocated
metadata is released in the event of an offload fail.

Fixes: 81f3ddf2547d ("nfp: add control message passing capabilities to flower offloads")
	Signed-off-by: John Hurley <john.hurley@netronome.com>
	Reviewed-by: Pieter Jansen van Vuuren <pieter.jansenvanvuuren@netronome.com>
	Reviewed-by: Jakub Kicinski <jakub.kicinski@netronome.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 1166494891da88af25c444e65cd4f32c3e026b46)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/netronome/nfp/flower/offload.c
diff --cc drivers/net/ethernet/netronome/nfp/flower/offload.c
index 970ddbd64602,c3ad8d737cf0..000000000000
--- a/drivers/net/ethernet/netronome/nfp/flower/offload.c
+++ b/drivers/net/ethernet/netronome/nfp/flower/offload.c
@@@ -495,12 -479,14 +495,20 @@@ nfp_flower_add_offload(struct nfp_app *
  	err = nfp_flower_xmit_flow(netdev, flow_pay,
  				   NFP_FLOWER_CMSG_TYPE_FLOW_ADD);
  	if (err)
- 		goto err_destroy_flow;
+ 		goto err_release_metadata;
  
 +	INIT_HLIST_NODE(&flow_pay->link);
  	flow_pay->tc_flower_cookie = flow->cookie;
++<<<<<<< HEAD
 +	fl_key = nfp_flower_fl_key(flow->cookie);
 +	hash_add_rcu(priv->flow_table, &flow_pay->link, fl_key);
++=======
+ 	err = rhashtable_insert_fast(&priv->flow_table, &flow_pay->fl_node,
+ 				     nfp_flower_table_params);
+ 	if (err)
+ 		goto err_release_metadata;
+ 
++>>>>>>> 1166494891da (nfp: flower: release metadata on offload failure)
  	port->tc_offload_cnt++;
  
  	/* Deallocate flow payload when flower rule has been destroyed. */
* Unmerged path drivers/net/ethernet/netronome/nfp/flower/offload.c
