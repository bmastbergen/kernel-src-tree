scsi: mpt3sas: fix possible memory leak.

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
Rebuild_CHGLOG: - [scsi] mpt3sas: fix possible memory leak (Tomas Henzl) [1513855]
Rebuild_FUZZ: 90.41%
commit-author Chaitra P B <chaitra.basappa@broadcom.com>
commit 87b3576e9eaba85644c643bb55b485b5330a2af5
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/87b3576e.failed

In ioctl exit path driver refers ioc_list to free memory associated with
diag buffers and event_log pointer used to save events by driver.
If ctl_exit() func is called after unregistering driver, then ioc_list will
be empty and hence driver will not be able to free the allocated memory
which in turn causes memory leak.
So call ctl_exit() function before unregistering mpt3sas driver.

	Signed-off-by: Chaitra P B <chaitra.basappa@broadcom.com>
	Signed-off-by: Suganath Prabu S <suganath-prabu.subramani@broadcom.com>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit 87b3576e9eaba85644c643bb55b485b5330a2af5)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/mpt3sas/mpt3sas_scsih.c
diff --cc drivers/scsi/mpt3sas/mpt3sas_scsih.c
index 56509c7a0096,b8d131a455d0..000000000000
--- a/drivers/scsi/mpt3sas/mpt3sas_scsih.c
+++ b/drivers/scsi/mpt3sas/mpt3sas_scsih.c
@@@ -11286,21 -11284,12 +11286,27 @@@ _mpt3sas_init(void
  static void __exit
  _mpt3sas_exit(void)
  {
 +#ifdef MPT2SAS_SCSI
 +	pr_info("mpt2sas version %s unloading\n",
 +				MPT2SAS_DRIVER_VERSION);
 +#else
  	pr_info("mpt3sas version %s unloading\n",
  				MPT3SAS_DRIVER_VERSION);
 +#endif /* MPT2SAS_SCSI */
 +
++<<<<<<< HEAD
 +	pci_unregister_driver(&mpt3sas_driver);
  
 +#ifdef MPT2SAS_SCSI
 +	mpt3sas_ctl_exit(1);
 +#else
 +	mpt3sas_ctl_exit(2);
 +#endif /* MPT2SAS_SCSI */
++=======
+ 	mpt3sas_ctl_exit(hbas_to_enumerate);
++>>>>>>> 87b3576e9eab (scsi: mpt3sas: fix possible memory leak.)
+ 
+ 	pci_unregister_driver(&mpt3sas_driver);
  
  	scsih_exit();
  }
* Unmerged path drivers/scsi/mpt3sas/mpt3sas_scsih.c
