vhost/vsock: fix vhost vsock cid hashing inconsistent

jira LE-1907
cve CVE-2018-14625
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
Rebuild_CHGLOG: - [vhost] vsock: fix vhost vsock cid hashing inconsistent (Stefan Hajnoczi) [1623776] {CVE-2018-14625}
Rebuild_FUZZ: 94.00%
commit-author Zha Bin <zhabin@linux.alibaba.com>
commit 7fbe078c37aba3088359c9256c1a1d0c3e39ee81
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/7fbe078c.failed

The vsock core only supports 32bit CID, but the Virtio-vsock spec define
CID (dst_cid and src_cid) as u64 and the upper 32bits is reserved as
zero. This inconsistency causes one bug in vhost vsock driver. The
scenarios is:

  0. A hash table (vhost_vsock_hash) is used to map an CID to a vsock
  object. And hash_min() is used to compute the hash key. hash_min() is
  defined as:
  (sizeof(val) <= 4 ? hash_32(val, bits) : hash_long(val, bits)).
  That means the hash algorithm has dependency on the size of macro
  argument 'val'.
  0. In function vhost_vsock_set_cid(), a 64bit CID is passed to
  hash_min() to compute the hash key when inserting a vsock object into
  the hash table.
  0. In function vhost_vsock_get(), a 32bit CID is passed to hash_min()
  to compute the hash key when looking up a vsock for an CID.

Because the different size of the CID, hash_min() returns different hash
key, thus fails to look up the vsock object for an CID.

To fix this bug, we keep CID as u64 in the IOCTLs and virtio message
headers, but explicitly convert u64 to u32 when deal with the hash table
and vsock core.

Fixes: 834e772c8db0 ("vhost/vsock: fix use-after-free in network stack callers")
Link: https://github.com/stefanha/virtio/blob/vsock/trunk/content.tex
	Signed-off-by: Zha Bin <zhabin@linux.alibaba.com>
	Reviewed-by: Liu Jiang <gerry@linux.alibaba.com>
	Reviewed-by: Stefan Hajnoczi <stefanha@redhat.com>
	Acked-by: Jason Wang <jasowang@redhat.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 7fbe078c37aba3088359c9256c1a1d0c3e39ee81)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/vhost/vsock.c
diff --cc drivers/vhost/vsock.c
index 1b2746cf27a1,3fbc068eaa9b..000000000000
--- a/drivers/vhost/vsock.c
+++ b/drivers/vhost/vsock.c
@@@ -592,14 -631,19 +592,19 @@@ static int vhost_vsock_set_cid(struct v
  		return -EINVAL;
  
  	/* Refuse if CID is already in use */
 -	mutex_lock(&vhost_vsock_mutex);
 -	other = vhost_vsock_get(guest_cid);
 +	spin_lock_bh(&vhost_vsock_lock);
 +	other = __vhost_vsock_get(guest_cid);
  	if (other && other != vsock) {
 -		mutex_unlock(&vhost_vsock_mutex);
 +		spin_unlock_bh(&vhost_vsock_lock);
  		return -EADDRINUSE;
  	}
 -
 -	if (vsock->guest_cid)
 -		hash_del_rcu(&vsock->hash);
 -
  	vsock->guest_cid = guest_cid;
++<<<<<<< HEAD
 +	spin_unlock_bh(&vhost_vsock_lock);
++=======
+ 	hash_add_rcu(vhost_vsock_hash, &vsock->hash, vsock->guest_cid);
+ 	mutex_unlock(&vhost_vsock_mutex);
++>>>>>>> 7fbe078c37ab (vhost/vsock: fix vhost vsock cid hashing inconsistent)
  
  	return 0;
  }
* Unmerged path drivers/vhost/vsock.c
