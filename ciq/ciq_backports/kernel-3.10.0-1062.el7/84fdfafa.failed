x86/Hyper-V: Set x2apic destination mode to physical when x2apic is available

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
Rebuild_CHGLOG: - [x86] hyper-v: Set x2apic destination mode to physical when x2apic is available (Vitaly Kuznetsov) [1661654]
Rebuild_FUZZ: 97.33%
commit-author Lan Tianyu <Tianyu.Lan@microsoft.com>
commit 84fdfafab849036b5aefa52824b5cb42e887ef0e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/84fdfafa.failed

Hyper-V doesn't provide irq remapping for IO-APIC. To enable x2apic,
set x2apic destination mode to physcial mode when x2apic is available
and Hyper-V IOMMU driver makes sure cpus assigned with IO-APIC irqs have
8-bit APIC id.

	Reviewed-by: Thomas Gleixner <tglx@linutronix.de>
	Reviewed-by: Michael Kelley <mikelley@microsoft.com>
	Signed-off-by: Lan Tianyu <Tianyu.Lan@microsoft.com>
	Signed-off-by: Joerg Roedel <jroedel@suse.de>
(cherry picked from commit 84fdfafab849036b5aefa52824b5cb42e887ef0e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kernel/cpu/mshyperv.c
diff --cc arch/x86/kernel/cpu/mshyperv.c
index b2aa3259715b,3fa238a137d2..000000000000
--- a/arch/x86/kernel/cpu/mshyperv.c
+++ b/arch/x86/kernel/cpu/mshyperv.c
@@@ -249,6 -312,34 +249,37 @@@ static void __init ms_hyperv_init_platf
  	 */
  	x86_platform.apic_post_init = hyperv_init;
  	hyperv_setup_mmu_ops();
++<<<<<<< HEAD
++=======
+ 	/* Setup the IDT for hypervisor callback */
+ 	alloc_intr_gate(HYPERVISOR_CALLBACK_VECTOR, hyperv_callback_vector);
+ 
+ 	/* Setup the IDT for reenlightenment notifications */
+ 	if (ms_hyperv.features & HV_X64_ACCESS_REENLIGHTENMENT)
+ 		alloc_intr_gate(HYPERV_REENLIGHTENMENT_VECTOR,
+ 				hyperv_reenlightenment_vector);
+ 
+ 	/* Setup the IDT for stimer0 */
+ 	if (ms_hyperv.misc_features & HV_STIMER_DIRECT_MODE_AVAILABLE)
+ 		alloc_intr_gate(HYPERV_STIMER0_VECTOR,
+ 				hv_stimer0_callback_vector);
+ 
+ # ifdef CONFIG_SMP
+ 	smp_ops.smp_prepare_boot_cpu = hv_smp_prepare_boot_cpu;
+ # endif
+ 
+ 	/*
+ 	 * Hyper-V doesn't provide irq remapping for IO-APIC. To enable x2apic,
+ 	 * set x2apic destination mode to physcial mode when x2apic is available
+ 	 * and Hyper-V IOMMU driver makes sure cpus assigned with IO-APIC irqs
+ 	 * have 8-bit APIC id.
+ 	 */
+ # ifdef CONFIG_X86_X2APIC
+ 	if (x2apic_supported())
+ 		x2apic_phys = 1;
+ # endif
+ 
++>>>>>>> 84fdfafab849 (x86/Hyper-V: Set x2apic destination mode to physical when x2apic is available)
  #endif
  }
  
* Unmerged path arch/x86/kernel/cpu/mshyperv.c
