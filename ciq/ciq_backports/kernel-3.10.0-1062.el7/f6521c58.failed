cls_flower: Fix comparing of old filter mask with new filter

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
commit-author Paul Blakey <paulb@mellanox.com>
commit f6521c587a586de5fdafb0a322072e5ff67f8e15
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/f6521c58.failed

We incorrectly compare the mask and the result is that we can't modify
an already existing rule.

Fix that by comparing correctly.

Fixes: 05cd271fd61a ("cls_flower: Support multiple masks per priority")
	Reported-by: Vlad Buslov <vladbu@mellanox.com>
	Reviewed-by: Roi Dayan <roid@mellanox.com>
	Reviewed-by: Jiri Pirko <jiri@mellanox.com>
	Signed-off-by: Paul Blakey <paulb@mellanox.com>
	Reviewed-by: Simon Horman <simon.horman@netronome.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit f6521c587a586de5fdafb0a322072e5ff67f8e15)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/sched/cls_flower.c
diff --cc net/sched/cls_flower.c
index eb4e6a91f3e1,2b5be42a9f1c..000000000000
--- a/net/sched/cls_flower.c
+++ b/net/sched/cls_flower.c
@@@ -860,28 -861,26 +860,39 @@@ static void fl_init_dissector(struct cl
  }
  
  static int fl_check_assign_mask(struct cls_fl_head *head,
 -				struct cls_fl_filter *fnew,
 -				struct cls_fl_filter *fold,
  				struct fl_flow_mask *mask)
  {
 -	struct fl_flow_mask *newmask;
 +	int err;
  
 -	fnew->mask = rhashtable_lookup_fast(&head->ht, mask, mask_ht_params);
 -	if (!fnew->mask) {
 -		if (fold)
 +	if (head->mask_assigned) {
 +		if (!fl_mask_eq(&head->mask, mask))
  			return -EINVAL;
++<<<<<<< HEAD
 +		else
 +			return 0;
++=======
+ 
+ 		newmask = fl_create_new_mask(head, mask);
+ 		if (IS_ERR(newmask))
+ 			return PTR_ERR(newmask);
+ 
+ 		fnew->mask = newmask;
+ 	} else if (fold && fold->mask != fnew->mask) {
+ 		return -EINVAL;
++>>>>>>> f6521c587a58 (cls_flower: Fix comparing of old filter mask with new filter)
  	}
  
 +	/* Mask is not assigned yet. So assign it and init hashtable
 +	 * according to that.
 +	 */
 +	err = fl_init_hashtable(head, mask);
 +	if (err)
 +		return err;
 +	memcpy(&head->mask, mask, sizeof(head->mask));
 +	head->mask_assigned = true;
 +
 +	fl_init_dissector(head, mask);
 +
  	return 0;
  }
  
* Unmerged path net/sched/cls_flower.c
