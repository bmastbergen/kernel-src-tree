net-sysfs: Fix memory leak in XPS configuration

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
Rebuild_CHGLOG: - [net] sysfs: Fix memory leak in XPS configuration (Paolo Abeni) [1623813]
Rebuild_FUZZ: 95.56%
commit-author Alexander Duyck <alexander.h.duyck@intel.com>
commit 664088f8d68178809b848ca450f2797efb34e8e7
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/664088f8.failed

This patch reorders the error cases in showing the XPS configuration so
that we hold off on memory allocation until after we have verified that we
can support XPS on a given ring.

Fixes: 184c449f91fe ("net: Add support for XPS with QoS via traffic classes")
	Signed-off-by: Alexander Duyck <alexander.h.duyck@intel.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 664088f8d68178809b848ca450f2797efb34e8e7)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/core/net-sysfs.c
diff --cc net/core/net-sysfs.c
index 9aa878f33481,bb7e80f4ced3..000000000000
--- a/net/core/net-sysfs.c
+++ b/net/core/net-sysfs.c
@@@ -1182,14 -1212,20 +1182,24 @@@ static ssize_t show_xps_map(struct netd
  	struct xps_dev_maps *dev_maps;
  	cpumask_var_t mask;
  	unsigned long index;
 +	size_t len = 0;
 +	int i;
  
+ 	index = get_netdev_queue_index(queue);
+ 
++<<<<<<< HEAD
++=======
+ 	if (dev->num_tc) {
+ 		num_tc = dev->num_tc;
+ 		tc = netdev_txq_to_tc(dev, index);
+ 		if (tc < 0)
+ 			return -EINVAL;
+ 	}
+ 
  	if (!zalloc_cpumask_var(&mask, GFP_KERNEL))
  		return -ENOMEM;
  
- 	index = get_netdev_queue_index(queue);
- 
++>>>>>>> 664088f8d681 (net-sysfs: Fix memory leak in XPS configuration)
  	rcu_read_lock();
  	dev_maps = rcu_dereference(dev->xps_maps);
  	if (dev_maps) {
* Unmerged path net/core/net-sysfs.c
