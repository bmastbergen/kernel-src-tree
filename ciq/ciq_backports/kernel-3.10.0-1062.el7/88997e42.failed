net/8021q: create device with all possible features in wanted_features

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
Rebuild_CHGLOG: - [net] 8021q: create device with all possible features in wanted_features (Davide Caratti) [1640645]
Rebuild_FUZZ: 97.06%
commit-author Andrey Vagin <avagin@openvz.org>
commit 88997e4208aea117627898e5f6f9801cf3cd42d2
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/88997e42.failed

wanted_features is a set of features which have to be enabled if a
hardware allows that.

Currently when a vlan device is created, its wanted_features is set to
current features of its base device.

The problem is that the base device can get new features and they are
not propagated to vlan-s of this device.

If we look at bonding devices, they doesn't have this problem and this
patch suggests to fix this issue by the same way how it works for bonding
devices.

We meet this problem, when we try to create a vlan device over a bonding
device. When a system are booting, real devices require time to be
initialized, so bonding devices created without slaves, then vlan
devices are created and only then ethernet devices are added to the
bonding device. As a result we have vlan devices with disabled
scatter-gather.

* create a bonding device
  $ ip link add bond0 type bond
  $ ethtool -k bond0 | grep scatter
  scatter-gather: off
	tx-scatter-gather: off [requested on]
	tx-scatter-gather-fraglist: off [requested on]

* create a vlan device
  $ ip link add link bond0 name bond0.10 type vlan id 10
  $ ethtool -k bond0.10 | grep scatter
  scatter-gather: off
	tx-scatter-gather: off
	tx-scatter-gather-fraglist: off

* Add a slave device to bond0
  $ ip link set dev eth0 master bond0

And now we can see that the bond0 device has got the scatter-gather
feature, but the bond0.10 hasn't got it.
[root@laptop linux-task-diag]# ethtool -k bond0 | grep scatter
scatter-gather: on
	tx-scatter-gather: on
	tx-scatter-gather-fraglist: on
[root@laptop linux-task-diag]# ethtool -k bond0.10 | grep scatter
scatter-gather: off
	tx-scatter-gather: off
	tx-scatter-gather-fraglist: off

With this patch the vlan device will get all new features from the
bonding device.

Here is a call trace how features which are set in this patch reach
dev->wanted_features.

register_netdevice
   vlan_dev_init
	...
	dev->hw_features = NETIF_F_HW_CSUM | NETIF_F_SG |
		       NETIF_F_FRAGLIST | NETIF_F_GSO_SOFTWARE |
		       NETIF_F_HIGHDMA | NETIF_F_SCTP_CRC |
		       NETIF_F_ALL_FCOE;

	dev->features |= dev->hw_features;
	...
    dev->wanted_features = dev->features & dev->hw_features;
    __netdev_update_features(dev);
        vlan_dev_fix_features
	   ...

	Cc: Alexey Kuznetsov <kuznet@virtuozzo.com>
	Cc: Patrick McHardy <kaber@trash.net>
	Cc: "David S. Miller" <davem@davemloft.net>
	Signed-off-by: Andrei Vagin <avagin@openvz.org>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 88997e4208aea117627898e5f6f9801cf3cd42d2)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/8021q/vlan_dev.c
diff --cc net/8021q/vlan_dev.c
index 965619d9001c,9ee5787634e5..000000000000
--- a/net/8021q/vlan_dev.c
+++ b/net/8021q/vlan_dev.c
@@@ -593,8 -562,11 +593,12 @@@ static int vlan_dev_init(struct net_dev
  			   NETIF_F_HIGHDMA | NETIF_F_SCTP_CRC |
  			   NETIF_F_ALL_FCOE;
  
++<<<<<<< HEAD
 +	dev->features |= real_dev->vlan_features | NETIF_F_LLTX;
++=======
+ 	dev->features |= dev->hw_features | NETIF_F_LLTX;
++>>>>>>> 88997e4208ae (net/8021q: create device with all possible features in wanted_features)
  	dev->gso_max_size = real_dev->gso_max_size;
 -	dev->gso_max_segs = real_dev->gso_max_segs;
 -	if (dev->features & NETIF_F_VLAN_FEATURES)
 -		netdev_warn(real_dev, "VLAN features are set incorrectly.  Q-in-Q configurations may not work correctly.\n");
  
  	dev->vlan_features = real_dev->vlan_features & ~NETIF_F_ALL_FCOE;
  
* Unmerged path net/8021q/vlan_dev.c
