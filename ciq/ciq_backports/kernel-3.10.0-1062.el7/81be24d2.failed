Hang/soft lockup in d_invalidate with simultaneous calls

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
Rebuild_CHGLOG: - [fs] revert "[fs] Hang/soft lockup in d_invalidate with simultaneous calls" (Benjamin Coddington) [1696374]
Rebuild_FUZZ: 92.56%
commit-author Al Viro <viro@ZenIV.linux.org.uk>
commit 81be24d263dbeddaba35827036d6f6787a59c2c3
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/81be24d2.failed

It's not hard to trigger a bunch of d_invalidate() on the same
dentry in parallel.  They end up fighting each other - any
dentry picked for removal by one will be skipped by the rest
and we'll go for the next iteration through the entire
subtree, even if everything is being skipped.  Morevoer, we
immediately go back to scanning the subtree.  The only thing
we really need is to dissolve all mounts in the subtree and
as soon as we've nothing left to do, we can just unhash the
dentry and bugger off.

	Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
(cherry picked from commit 81be24d263dbeddaba35827036d6f6787a59c2c3)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/dcache.c
diff --cc fs/dcache.c
index f8f0822c6dd1,a9f995f6859e..000000000000
--- a/fs/dcache.c
+++ b/fs/dcache.c
@@@ -1444,21 -1536,16 +1444,27 @@@ int d_invalidate(struct dentry *dentry
  
  		d_walk(dentry, &data, detach_and_collect, check_and_drop);
  
- 		if (data.select.found)
+ 		if (!list_empty(&data.select.dispose))
  			shrink_dentry_list(&data.select.dispose);
+ 		else if (!data.mountpoint)
+ 			return;
  
  		if (data.mountpoint) {
 -			detach_mounts(data.mountpoint);
 -			dput(data.mountpoint);
 +			if (may_detach_mounts) {
 +				detach_mounts(data.mountpoint);
 +				dput(data.mountpoint);
 +			} else {
 +				dput(data.mountpoint);
 +				return -EBUSY;
 +			}
  		}
++<<<<<<< HEAD
 +
 +		if (!data.mountpoint && !data.select.found)
 +			return 0;
++=======
+ 		cond_resched();
++>>>>>>> 81be24d263db (Hang/soft lockup in d_invalidate with simultaneous calls)
  	}
  }
  EXPORT_SYMBOL(d_invalidate);
* Unmerged path fs/dcache.c
