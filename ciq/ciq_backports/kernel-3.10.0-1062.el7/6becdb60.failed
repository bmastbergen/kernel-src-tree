fuse: fix control dir setup and teardown

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
commit-author Miklos Szeredi <mszeredi@redhat.com>
commit 6becdb601bae2a043d7fb9762c4d48699528ea6e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/6becdb60.failed

syzbot is reporting NULL pointer dereference at fuse_ctl_remove_conn() [1].
Since fc->ctl_ndents is incremented by fuse_ctl_add_conn() when new_inode()
failed, fuse_ctl_remove_conn() reaches an inode-less dentry and tries to
clear d_inode(dentry)->i_private field.

Fix by only adding the dentry to the array after being fully set up.

When tearing down the control directory, do d_invalidate() on it to get rid
of any mounts that might have been added.

[1] https://syzkaller.appspot.com/bug?id=f396d863067238959c91c0b7cfc10b163638cac6
	Reported-by: syzbot <syzbot+32c236387d66c4516827@syzkaller.appspotmail.com>
Fixes: bafa96541b25 ("[PATCH] fuse: add control filesystem")
	Cc: <stable@vger.kernel.org> # v2.6.18
	Signed-off-by: Miklos Szeredi <mszeredi@redhat.com>
(cherry picked from commit 6becdb601bae2a043d7fb9762c4d48699528ea6e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/fuse/control.c
diff --cc fs/fuse/control.c
index 205e0d5d5307,0b694655d988..000000000000
--- a/fs/fuse/control.c
+++ b/fs/fuse/control.c
@@@ -283,11 -287,14 +287,19 @@@ void fuse_ctl_remove_conn(struct fuse_c
  
  	for (i = fc->ctl_ndents - 1; i >= 0; i--) {
  		struct dentry *dentry = fc->ctl_dentry[i];
++<<<<<<< HEAD
 +		dentry->d_inode->i_private = NULL;
 +		d_drop(dentry);
++=======
+ 		d_inode(dentry)->i_private = NULL;
+ 		if (!i) {
+ 			/* Get rid of submounts: */
+ 			d_invalidate(dentry);
+ 		}
++>>>>>>> 6becdb601bae (fuse: fix control dir setup and teardown)
  		dput(dentry);
  	}
 -	drop_nlink(d_inode(fuse_control_sb->s_root));
 +	drop_nlink(fuse_control_sb->s_root->d_inode);
  }
  
  static int fuse_ctl_fill_super(struct super_block *sb, void *data, int silent)
* Unmerged path fs/fuse/control.c
