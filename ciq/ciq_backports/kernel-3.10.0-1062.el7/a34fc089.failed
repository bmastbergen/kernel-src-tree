RDMA/nldev: provide detailed CQ information

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
commit-author Steve Wise <swise@opengridcomputing.com>
commit a34fc0893eef691863b5c118df8ff8e6c9fbc7b7
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/a34fc089.failed

Implement the RDMA nldev netlink interface for dumping detailed
CQ information.

	Reviewed-by: Leon Romanovsky <leonro@mellanox.com>
	Signed-off-by: Steve Wise <swise@opengridcomputing.com>
	Signed-off-by: Doug Ledford <dledford@redhat.com>
(cherry picked from commit a34fc0893eef691863b5c118df8ff8e6c9fbc7b7)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/core/nldev.c
#	include/uapi/rdma/rdma_netlink.h
diff --cc drivers/infiniband/core/nldev.c
index 67368b6847cb,83e43926c957..000000000000
--- a/drivers/infiniband/core/nldev.c
+++ b/drivers/infiniband/core/nldev.c
@@@ -71,6 -73,18 +71,21 @@@ static const struct nla_policy nldev_po
  	[RDMA_NLDEV_ATTR_RES_PID]		= { .type = NLA_U32 },
  	[RDMA_NLDEV_ATTR_RES_KERN_NAME]		= { .type = NLA_NUL_STRING,
  						    .len = TASK_COMM_LEN },
++<<<<<<< HEAD
++=======
+ 	[RDMA_NLDEV_ATTR_RES_CM_ID]		= { .type = NLA_NESTED },
+ 	[RDMA_NLDEV_ATTR_RES_CM_ID_ENTRY]	= { .type = NLA_NESTED },
+ 	[RDMA_NLDEV_ATTR_RES_PS]		= { .type = NLA_U32 },
+ 	[RDMA_NLDEV_ATTR_RES_SRC_ADDR]	= {
+ 			.len = sizeof(struct __kernel_sockaddr_storage) },
+ 	[RDMA_NLDEV_ATTR_RES_DST_ADDR]	= {
+ 			.len = sizeof(struct __kernel_sockaddr_storage) },
+ 	[RDMA_NLDEV_ATTR_RES_CQ]		= { .type = NLA_NESTED },
+ 	[RDMA_NLDEV_ATTR_RES_CQ_ENTRY]		= { .type = NLA_NESTED },
+ 	[RDMA_NLDEV_ATTR_RES_CQE]		= { .type = NLA_U32 },
+ 	[RDMA_NLDEV_ATTR_RES_USECNT]		= { .type = NLA_U64 },
+ 	[RDMA_NLDEV_ATTR_RES_POLL_CTX]		= { .type = NLA_U8 },
++>>>>>>> a34fc0893eef (RDMA/nldev: provide detailed CQ information)
  };
  
  static int fill_nldev_handle(struct sk_buff *msg, struct ib_device *device)
@@@ -284,7 -364,41 +299,45 @@@ out
  	return -EMSGSIZE;
  }
  
++<<<<<<< HEAD
 +static int nldev_get_doit(struct sk_buff *skb, struct nlmsghdr *nlh)
++=======
+ static int fill_res_cq_entry(struct sk_buff *msg, struct netlink_callback *cb,
+ 			     struct rdma_restrack_entry *res, uint32_t port)
+ {
+ 	struct ib_cq *cq = container_of(res, struct ib_cq, res);
+ 	struct nlattr *entry_attr;
+ 
+ 	entry_attr = nla_nest_start(msg, RDMA_NLDEV_ATTR_RES_CQ_ENTRY);
+ 	if (!entry_attr)
+ 		goto out;
+ 
+ 	if (nla_put_u32(msg, RDMA_NLDEV_ATTR_RES_CQE, cq->cqe))
+ 		goto err;
+ 	if (nla_put_u64_64bit(msg, RDMA_NLDEV_ATTR_RES_USECNT,
+ 			      atomic_read(&cq->usecnt), 0))
+ 		goto err;
+ 
+ 	/* Poll context is only valid for kernel CQs */
+ 	if (rdma_is_kernel_res(res) &&
+ 	    nla_put_u8(msg, RDMA_NLDEV_ATTR_RES_POLL_CTX, cq->poll_ctx))
+ 		goto err;
+ 
+ 	if (fill_res_name_pid(msg, res))
+ 		goto err;
+ 
+ 	nla_nest_end(msg, entry_attr);
+ 	return 0;
+ 
+ err:
+ 	nla_nest_cancel(msg, entry_attr);
+ out:
+ 	return -EMSGSIZE;
+ }
+ 
+ static int nldev_get_doit(struct sk_buff *skb, struct nlmsghdr *nlh,
+ 			  struct netlink_ext_ack *extack)
++>>>>>>> a34fc0893eef (RDMA/nldev: provide detailed CQ information)
  {
  	struct nlattr *tb[RDMA_NLDEV_ATTR_MAX];
  	struct ib_device *device;
@@@ -568,6 -684,16 +621,19 @@@ static const struct nldev_fill_res_entr
  		.nldev_cmd = RDMA_NLDEV_CMD_RES_QP_GET,
  		.nldev_attr = RDMA_NLDEV_ATTR_RES_QP,
  	},
++<<<<<<< HEAD
++=======
+ 	[RDMA_RESTRACK_CM_ID] = {
+ 		.fill_res_func = fill_res_cm_id_entry,
+ 		.nldev_cmd = RDMA_NLDEV_CMD_RES_CM_ID_GET,
+ 		.nldev_attr = RDMA_NLDEV_ATTR_RES_CM_ID,
+ 	},
+ 	[RDMA_RESTRACK_CQ] = {
+ 		.fill_res_func = fill_res_cq_entry,
+ 		.nldev_cmd = RDMA_NLDEV_CMD_RES_CQ_GET,
+ 		.nldev_attr = RDMA_NLDEV_ATTR_RES_CQ,
+ 	},
++>>>>>>> a34fc0893eef (RDMA/nldev: provide detailed CQ information)
  };
  
  static int res_get_common_dumpit(struct sk_buff *skb,
@@@ -710,6 -836,18 +776,21 @@@ static int nldev_res_get_qp_dumpit(stru
  	return res_get_common_dumpit(skb, cb, RDMA_RESTRACK_QP);
  }
  
++<<<<<<< HEAD
++=======
+ static int nldev_res_get_cm_id_dumpit(struct sk_buff *skb,
+ 				      struct netlink_callback *cb)
+ {
+ 	return res_get_common_dumpit(skb, cb, RDMA_RESTRACK_CM_ID);
+ }
+ 
+ static int nldev_res_get_cq_dumpit(struct sk_buff *skb,
+ 				   struct netlink_callback *cb)
+ {
+ 	return res_get_common_dumpit(skb, cb, RDMA_RESTRACK_CQ);
+ }
+ 
++>>>>>>> a34fc0893eef (RDMA/nldev: provide detailed CQ information)
  static const struct rdma_nl_cbs nldev_cb_table[RDMA_NLDEV_NUM_OPS] = {
  	[RDMA_NLDEV_CMD_GET] = {
  		.doit = nldev_get_doit,
@@@ -736,6 -874,12 +817,15 @@@
  		 * too.
  		 */
  	},
++<<<<<<< HEAD
++=======
+ 	[RDMA_NLDEV_CMD_RES_CM_ID_GET] = {
+ 		.dump = nldev_res_get_cm_id_dumpit,
+ 	},
+ 	[RDMA_NLDEV_CMD_RES_CQ_GET] = {
+ 		.dump = nldev_res_get_cq_dumpit,
+ 	},
++>>>>>>> a34fc0893eef (RDMA/nldev: provide detailed CQ information)
  };
  
  void __init nldev_init(void)
diff --cc include/uapi/rdma/rdma_netlink.h
index b90c8cd4c303,36cf1f0025fd..000000000000
--- a/include/uapi/rdma/rdma_netlink.h
+++ b/include/uapi/rdma/rdma_netlink.h
@@@ -237,6 -238,10 +237,13 @@@ enum rdma_nldev_command 
  
  	RDMA_NLDEV_CMD_RES_QP_GET, /* can dump */
  
++<<<<<<< HEAD
++=======
+ 	RDMA_NLDEV_CMD_RES_CM_ID_GET, /* can dump */
+ 
+ 	RDMA_NLDEV_CMD_RES_CQ_GET, /* can dump */
+ 
++>>>>>>> a34fc0893eef (RDMA/nldev: provide detailed CQ information)
  	RDMA_NLDEV_NUM_OPS
  };
  
@@@ -349,6 -354,24 +356,27 @@@ enum rdma_nldev_attr 
  	 */
  	RDMA_NLDEV_ATTR_RES_KERN_NAME,		/* string */
  
++<<<<<<< HEAD
++=======
+ 	RDMA_NLDEV_ATTR_RES_CM_ID,		/* nested table */
+ 	RDMA_NLDEV_ATTR_RES_CM_ID_ENTRY,	/* nested table */
+ 	/*
+ 	 * rdma_cm_id port space.
+ 	 */
+ 	RDMA_NLDEV_ATTR_RES_PS,			/* u32 */
+ 	/*
+ 	 * Source and destination socket addresses
+ 	 */
+ 	RDMA_NLDEV_ATTR_RES_SRC_ADDR,		/* __kernel_sockaddr_storage */
+ 	RDMA_NLDEV_ATTR_RES_DST_ADDR,		/* __kernel_sockaddr_storage */
+ 
+ 	RDMA_NLDEV_ATTR_RES_CQ,			/* nested table */
+ 	RDMA_NLDEV_ATTR_RES_CQ_ENTRY,		/* nested table */
+ 	RDMA_NLDEV_ATTR_RES_CQE,		/* u32 */
+ 	RDMA_NLDEV_ATTR_RES_USECNT,		/* u64 */
+ 	RDMA_NLDEV_ATTR_RES_POLL_CTX,		/* u8 */
+ 
++>>>>>>> a34fc0893eef (RDMA/nldev: provide detailed CQ information)
  	RDMA_NLDEV_ATTR_MAX
  };
  #endif /* _UAPI_RDMA_NETLINK_H */
* Unmerged path drivers/infiniband/core/nldev.c
* Unmerged path include/uapi/rdma/rdma_netlink.h
