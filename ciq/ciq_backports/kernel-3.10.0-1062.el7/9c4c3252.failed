skbuff: preserve sock reference when scrubbing the skb.

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
commit-author Flavio Leitner <fbl@redhat.com>
commit 9c4c325252c54b34d53b3d0ffd535182b744e03d
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/9c4c3252.failed

The sock reference is lost when scrubbing the packet and that breaks
TSQ (TCP Small Queues) and XPS (Transmit Packet Steering) causing
performance impacts of about 50% in a single TCP stream when crossing
network namespaces.

XPS breaks because the queue mapping stored in the socket is not
available, so another random queue might be selected when the stack
needs to transmit something like a TCP ACK, or TCP Retransmissions.
That causes packet re-ordering and/or performance issues.

TSQ breaks because it orphans the packet while it is still in the
host, so packets are queued contributing to the buffer bloat problem.

Preserving the sock reference fixes both issues. The socket is
orphaned anyways in the receiving path before any relevant action
and on TX side the netfilter checks if the reference is local before
use it.

	Signed-off-by: Flavio Leitner <fbl@redhat.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 9c4c325252c54b34d53b3d0ffd535182b744e03d)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	Documentation/networking/ip-sysctl.txt
#	net/core/skbuff.c
diff --cc Documentation/networking/ip-sysctl.txt
index f7eb40bc7baf,f4c042be0216..000000000000
--- a/Documentation/networking/ip-sysctl.txt
+++ b/Documentation/networking/ip-sysctl.txt
@@@ -636,12 -733,12 +636,21 @@@ tcp_limit_output_bytes - INTEGE
  	Controls TCP Small Queue limit per tcp socket.
  	TCP bulk sender tends to increase packets in flight until it
  	gets losses notifications. With SNDBUF autotuning, this can
++<<<<<<< HEAD
 +	result in a large amount of packets queued in qdisc/device
 +	on the local machine, hurting latency of other flows, for
 +	typical pfifo_fast qdiscs.
 +	tcp_limit_output_bytes limits the number of bytes on qdisc
 +	or device to reduce artificial RTT/cwnd and reduce bufferbloat.
 +	Default: 131072
++=======
+ 	result in a large amount of packets queued on the local machine
+ 	(e.g.: qdiscs, CPU backlog, or device) hurting latency of other
+ 	flows, for typical pfifo_fast qdiscs.  tcp_limit_output_bytes
+ 	limits the number of bytes on qdisc or device to reduce artificial
+ 	RTT/cwnd and reduce bufferbloat.
+ 	Default: 262144
++>>>>>>> 9c4c325252c5 (skbuff: preserve sock reference when scrubbing the skb.)
  
  tcp_challenge_ack_limit - INTEGER
  	Limits number of Challenge ACK sent per second, as recommended
diff --cc net/core/skbuff.c
index 046c30c0e472,f59e98ca72c5..000000000000
--- a/net/core/skbuff.c
+++ b/net/core/skbuff.c
@@@ -4404,7 -4910,7 +4404,11 @@@ void skb_scrub_packet(struct sk_buff *s
  	if (!xnet)
  		return;
  
++<<<<<<< HEAD
 +	skb_orphan(skb);
++=======
+ 	ipvs_reset(skb);
++>>>>>>> 9c4c325252c5 (skbuff: preserve sock reference when scrubbing the skb.)
  	skb->mark = 0;
  }
  EXPORT_SYMBOL_GPL(skb_scrub_packet);
* Unmerged path Documentation/networking/ip-sysctl.txt
* Unmerged path net/core/skbuff.c
