kvm: nVMX: Validate CR3 target count on nested VM-entry

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
commit-author Jim Mattson <jmattson@google.com>
commit c7c2c709b60ed2d7e6e6871496f0e963cfad121f
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/c7c2c709.failed

According to the SDM, the CR3-target count must not be greater than
4. Future processors may support a different number of CR3-target
values. Software should read the VMX capability MSR IA32_VMX_MISC to
determine the number of values supported.

	Signed-off-by: Jim Mattson <jmattson@google.com>
	Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
(cherry picked from commit c7c2c709b60ed2d7e6e6871496f0e963cfad121f)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kvm/vmx.c
diff --cc arch/x86/kvm/vmx.c
index 25b1e0648f1e,44508522a1c7..000000000000
--- a/arch/x86/kvm/vmx.c
+++ b/arch/x86/kvm/vmx.c
@@@ -10615,8 -10271,11 +10620,16 @@@ static int check_vmentry_prereqs(struc
  				vmx->nested.nested_vmx_entry_ctls_high))
  		return VMXERR_ENTRY_INVALID_CONTROL_FIELD;
  
++<<<<<<< HEAD
 +	if (((vmcs12->host_cr0 & VMXON_CR0_ALWAYSON) != VMXON_CR0_ALWAYSON) ||
 +	    ((vmcs12->host_cr4 & VMXON_CR4_ALWAYSON) != VMXON_CR4_ALWAYSON) ||
++=======
+ 	if (vmcs12->cr3_target_count > nested_cpu_vmx_misc_cr3_count(vcpu))
+ 		return VMXERR_ENTRY_INVALID_CONTROL_FIELD;
+ 
+ 	if (!nested_host_cr0_valid(vcpu, vmcs12->host_cr0) ||
+ 	    !nested_host_cr4_valid(vcpu, vmcs12->host_cr4) ||
++>>>>>>> c7c2c709b60e (kvm: nVMX: Validate CR3 target count on nested VM-entry)
  	    !nested_cr3_valid(vcpu, vmcs12->host_cr3))
  		return VMXERR_ENTRY_INVALID_HOST_STATE_FIELD;
  
* Unmerged path arch/x86/kvm/vmx.c
