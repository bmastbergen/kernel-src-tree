vti6: fix PMTU caching and reporting on xmit

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
commit-author Eyal Birger <eyal.birger@gmail.com>
commit d6990976af7c5d8f55903bfb4289b6fb030bf754
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/d6990976.failed

When setting the skb->dst before doing the MTU check, the route PMTU
caching and reporting is done on the new dst which is about to be
released.

Instead, PMTU handling should be done using the original dst.

This is aligned with IPv4 VTI.

Fixes: ccd740cbc6 ("vti6: Add pmtu handling to vti6_xmit.")
	Signed-off-by: Eyal Birger <eyal.birger@gmail.com>
	Signed-off-by: Steffen Klassert <steffen.klassert@secunet.com>
(cherry picked from commit d6990976af7c5d8f55903bfb4289b6fb030bf754)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/ipv6/ip6_vti.c
diff --cc net/ipv6/ip6_vti.c
index 120a9f7b6726,c72ae3a4fe09..000000000000
--- a/net/ipv6/ip6_vti.c
+++ b/net/ipv6/ip6_vti.c
@@@ -466,13 -480,9 +466,9 @@@ vti6_xmit(struct sk_buff *skb, struct n
  		goto tx_err_dst_release;
  	}
  
- 	skb_scrub_packet(skb, !net_eq(t->net, dev_net(dev)));
- 	skb_dst_set(skb, dst);
- 	skb->dev = skb_dst(skb)->dev;
- 
  	mtu = dst_mtu(dst);
  	if (!skb->ignore_df && skb->len > mtu) {
 -		skb_dst_update_pmtu(skb, mtu);
 +		skb_dst(skb)->ops->update_pmtu(dst, NULL, skb, mtu);
  
  		if (skb->protocol == htons(ETH_P_IPV6)) {
  			if (mtu < IPV6_MIN_MTU)
@@@ -484,10 -494,15 +480,19 @@@
  				  htonl(mtu));
  		}
  
- 		return -EMSGSIZE;
+ 		err = -EMSGSIZE;
+ 		goto tx_err_dst_release;
  	}
  
++<<<<<<< HEAD
 +	err = dst_output(skb);
++=======
+ 	skb_scrub_packet(skb, !net_eq(t->net, dev_net(dev)));
+ 	skb_dst_set(skb, dst);
+ 	skb->dev = skb_dst(skb)->dev;
+ 
+ 	err = dst_output(t->net, skb->sk, skb);
++>>>>>>> d6990976af7c (vti6: fix PMTU caching and reporting on xmit)
  	if (net_xmit_eval(err) == 0) {
  		struct pcpu_sw_netstats *tstats = this_cpu_ptr(dev->tstats);
  
* Unmerged path net/ipv6/ip6_vti.c
