s390/zcrypt: enable AP bus scan without a valid default domain

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
Rebuild_CHGLOG: - [s390] zcrypt: enable AP bus scan without a valid default domain (Hendrik Brueckner) [1641030]
Rebuild_FUZZ: 95.80%
commit-author Halil Pasic <pasic@linux.ibm.com>
commit 1c472d46283263497adccd7a0bec64ee2f9c09e5
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/1c472d46.failed

The AP bus scan is aborted before doing anything worth mentioning if
ap_select_domain() fails, e.g. if the ap_rights.aqm mask is all zeros.
As the result of this the ap bus fails to manage (e.g. create and
register) devices like it is supposed to.

Let us make ap_scan_bus() work even if ap_select_domain() can't select a
default domain. Let's also make ap_select_domain() return void, as there
are no more callers interested in its return value.

	Signed-off-by: Halil Pasic <pasic@linux.ibm.com>
	Reported-by: Michael Mueller <mimu@linux.ibm.com>
Fixes: 7e0bdbe5c21c "s390/zcrypt: AP bus support for alternate driver(s)"
[freude@linux.ibm.com: title and patch header slightly modified]
	Signed-off-by: Harald Freudenberger <freude@linux.ibm.com>
	Signed-off-by: Martin Schwidefsky <schwidefsky@de.ibm.com>
(cherry picked from commit 1c472d46283263497adccd7a0bec64ee2f9c09e5)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/s390/crypto/ap_bus.c
diff --cc drivers/s390/crypto/ap_bus.c
index eec227533e4a,4b6a091c1225..000000000000
--- a/drivers/s390/crypto/ap_bus.c
+++ b/drivers/s390/crypto/ap_bus.c
@@@ -997,14 -1260,11 +996,11 @@@ static void ap_select_domain(void
  			best_domain = i;
  		}
  	}
 -	if (best_domain >= 0) {
 +	if (best_domain >= 0){
  		ap_domain_index = best_domain;
  		AP_DBF(DBF_DEBUG, "new ap_domain_index=%d\n", ap_domain_index);
- 		spin_unlock_bh(&ap_domain_lock);
- 		return 0;
  	}
  	spin_unlock_bh(&ap_domain_lock);
- 	return -ENODEV;
  }
  
  /*
@@@ -1079,11 -1339,10 +1075,10 @@@ static void ap_scan_bus(struct work_str
  	unsigned int func = 0;
  	int rc, id, dom, borked, domains, defdomdevs = 0;
  
 -	AP_DBF(DBF_DEBUG, "%s running\n", __func__);
 +	AP_DBF(DBF_DEBUG, "ap_scan_bus running\n");
  
  	ap_query_configuration(ap_configuration);
- 	if (ap_select_domain() != 0)
- 		goto out;
+ 	ap_select_domain();
  
  	for (id = 0; id < AP_DEVICES; id++) {
  		/* check if device is registered */
@@@ -1203,11 -1462,11 +1198,16 @@@
  		}
  	} /* end device loop */
  
++<<<<<<< HEAD
 +	if (defdomdevs < 1)
 +		AP_DBF(DBF_INFO, "no queue device with default domain %d available\n",
++=======
+ 	if (ap_domain_index >= 0 && defdomdevs < 1)
+ 		AP_DBF(DBF_INFO,
+ 		       "no queue device with default domain %d available\n",
++>>>>>>> 1c472d462832 (s390/zcrypt: enable AP bus scan without a valid default domain)
  		       ap_domain_index);
  
- out:
  	mod_timer(&ap_config_timer, jiffies + ap_config_time * HZ);
  }
  
* Unmerged path drivers/s390/crypto/ap_bus.c
