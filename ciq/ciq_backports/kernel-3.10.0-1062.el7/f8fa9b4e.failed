mlxsw: spectrum_router: Add extack message for RIF and VRF overflow

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
commit-author David Ahern <dsahern@gmail.com>
commit f8fa9b4e6da77311791c7150a6ecc9368396df3b
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/f8fa9b4e.failed

Add extack argument down to mlxsw_sp_rif_create and mlxsw_sp_vr_create
to set an error message on RIF or VR overflow. Now on overflow of
either resource the user gets an informative message as opposed to
failing with EBUSY.

	Signed-off-by: David Ahern <dsahern@gmail.com>
	Reviewed-by: Ido Schimmel <idosch@mellanox.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit f8fa9b4e6da77311791c7150a6ecc9368396df3b)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlxsw/spectrum_router.c
diff --cc drivers/net/ethernet/mellanox/mlxsw/spectrum_router.c
index b9aa04a87f46,2420f69797a9..000000000000
--- a/drivers/net/ethernet/mellanox/mlxsw/spectrum_router.c
+++ b/drivers/net/ethernet/mellanox/mlxsw/spectrum_router.c
@@@ -785,34 -731,31 +785,46 @@@ static struct mlxsw_sp_fib *mlxsw_sp_vr
  }
  
  static struct mlxsw_sp_vr *mlxsw_sp_vr_create(struct mlxsw_sp *mlxsw_sp,
- 					      u32 tb_id)
+ 					      u32 tb_id,
+ 					      struct netlink_ext_ack *extack)
  {
 +	struct mlxsw_sp_mr_table *mr4_table;
 +	struct mlxsw_sp_fib *fib4;
 +	struct mlxsw_sp_fib *fib6;
  	struct mlxsw_sp_vr *vr;
  	int err;
  
  	vr = mlxsw_sp_vr_find_unused(mlxsw_sp);
- 	if (!vr)
+ 	if (!vr) {
+ 		NL_SET_ERR_MSG(extack, "spectrum: Exceeded number of supported virtual routers");
  		return ERR_PTR(-EBUSY);
++<<<<<<< HEAD
 +	fib4 = mlxsw_sp_fib_create(mlxsw_sp, vr, MLXSW_SP_L3_PROTO_IPV4);
 +	if (IS_ERR(fib4))
 +		return ERR_CAST(fib4);
 +	fib6 = mlxsw_sp_fib_create(mlxsw_sp, vr, MLXSW_SP_L3_PROTO_IPV6);
 +	if (IS_ERR(fib6)) {
 +		err = PTR_ERR(fib6);
++=======
+ 	}
+ 	vr->fib4 = mlxsw_sp_fib_create(vr, MLXSW_SP_L3_PROTO_IPV4);
+ 	if (IS_ERR(vr->fib4))
+ 		return ERR_CAST(vr->fib4);
+ 	vr->fib6 = mlxsw_sp_fib_create(vr, MLXSW_SP_L3_PROTO_IPV6);
+ 	if (IS_ERR(vr->fib6)) {
+ 		err = PTR_ERR(vr->fib6);
++>>>>>>> f8fa9b4e6da7 (mlxsw: spectrum_router: Add extack message for RIF and VRF overflow)
  		goto err_fib6_create;
  	}
 -	vr->mr4_table = mlxsw_sp_mr_table_create(mlxsw_sp, vr->id,
 -						 MLXSW_SP_L3_PROTO_IPV4);
 -	if (IS_ERR(vr->mr4_table)) {
 -		err = PTR_ERR(vr->mr4_table);
 +	mr4_table = mlxsw_sp_mr_table_create(mlxsw_sp, vr->id,
 +					     MLXSW_SP_L3_PROTO_IPV4);
 +	if (IS_ERR(mr4_table)) {
 +		err = PTR_ERR(mr4_table);
  		goto err_mr_table_create;
  	}
 +	vr->fib4 = fib4;
 +	vr->fib6 = fib6;
 +	vr->mr4_table = mr4_table;
  	vr->tb_id = tb_id;
  	return vr;
  
* Unmerged path drivers/net/ethernet/mellanox/mlxsw/spectrum_router.c
