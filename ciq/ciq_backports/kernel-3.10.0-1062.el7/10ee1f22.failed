scsi: mpt3sas: Add an I/O barrier

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
Rebuild_CHGLOG: - [scsi] mpt3sas: Add an I/O barrier (Tomas Henzl) [1513855]
Rebuild_FUZZ: 90.00%
commit-author Tomas Henzl <thenzl@redhat.com>
commit 10ee1f2206a3f5aa869bede4b7505b24203a7715
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/10ee1f22.failed

A barrier should be added to ensure proper ordering of memory mapped
writes.

	Signed-off-by: Tomas Henzl <thenzl@redhat.com>
	Acked-by: Chaitra P B <chaitra.basappa@broadcom.com>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit 10ee1f2206a3f5aa869bede4b7505b24203a7715)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/mpt3sas/mpt3sas_base.c
diff --cc drivers/scsi/mpt3sas/mpt3sas_base.c
index 3f49dd06aaac,293f04119eba..000000000000
--- a/drivers/scsi/mpt3sas/mpt3sas_base.c
+++ b/drivers/scsi/mpt3sas/mpt3sas_base.c
@@@ -2576,6 -3325,30 +2576,33 @@@ mpt3sas_base_free_smid(struct MPT3SAS_A
  }
  
  /**
++<<<<<<< HEAD
++=======
+  * _base_mpi_ep_writeq - 32 bit write to MMIO
+  * @b: data payload
+  * @addr: address in MMIO space
+  * @writeq_lock: spin lock
+  *
+  * This special handling for MPI EP to take care of 32 bit
+  * environment where its not quarenteed to send the entire word
+  * in one transfer.
+  */
+ static inline void
+ _base_mpi_ep_writeq(__u64 b, volatile void __iomem *addr,
+ 					spinlock_t *writeq_lock)
+ {
+ 	unsigned long flags;
+ 	__u64 data_out = cpu_to_le64(b);
+ 
+ 	spin_lock_irqsave(writeq_lock, flags);
+ 	writel((u32)(data_out), addr);
+ 	writel((u32)(data_out >> 32), (addr + 4));
+ 	mmiowb();
+ 	spin_unlock_irqrestore(writeq_lock, flags);
+ }
+ 
+ /**
++>>>>>>> 10ee1f2206a3 (scsi: mpt3sas: Add an I/O barrier)
   * _base_writeq - 64 bit write to MMIO
   * @ioc: per adapter object
   * @b: data payload
* Unmerged path drivers/scsi/mpt3sas/mpt3sas_base.c
