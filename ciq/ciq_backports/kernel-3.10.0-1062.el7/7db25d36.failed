ovl: verify whiteout index entries on mount

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
commit-author Amir Goldstein <amir73il@gmail.com>
commit 7db25d36d9253c58afd3db837dd53e66ae3b1ac9
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/7db25d36.failed

Whiteout index entries are used as an indication that an exported
overlay file handle should be treated as stale (i.e. after unlink
of the overlay inode).

Check on mount that whiteout index entries have a name that looks like
a valid file handle and cleanup invalid index entries.

For whiteout index entries, do not check that they also have valid
origin fh and nlink xattr, because those xattr do not exist for a
whiteout index entry.

	Signed-off-by: Amir Goldstein <amir73il@gmail.com>
	Signed-off-by: Miklos Szeredi <mszeredi@redhat.com>
(cherry picked from commit 7db25d36d9253c58afd3db837dd53e66ae3b1ac9)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/overlayfs/namei.c
diff --cc fs/overlayfs/namei.c
index 0afb8ae29e9b,c6c79753b3b3..000000000000
--- a/fs/overlayfs/namei.c
+++ b/fs/overlayfs/namei.c
@@@ -428,9 -465,19 +425,25 @@@ int ovl_verify_index(struct dentry *ind
  	if (err)
  		goto fail;
  
++<<<<<<< HEAD
 +	err = ovl_check_origin(index, lowerstack, numlower, &stack, &ctr);
 +	if (!err && !ctr)
 +		err = -ESTALE;
++=======
+ 	/*
+ 	 * Whiteout index entries are used as an indication that an exported
+ 	 * overlay file handle should be treated as stale (i.e. after unlink
+ 	 * of the overlay inode). These entries contain no origin xattr.
+ 	 */
+ 	if (ovl_is_whiteout(index))
+ 		goto out;
+ 
+ 	err = ovl_verify_fh(index, OVL_XATTR_ORIGIN, fh);
+ 	if (err)
+ 		goto fail;
+ 
+ 	err = ovl_check_origin_fh(ofs, fh, index, &stack);
++>>>>>>> 7db25d36d925 (ovl: verify whiteout index entries on mount)
  	if (err)
  		goto fail;
  
* Unmerged path fs/overlayfs/namei.c
