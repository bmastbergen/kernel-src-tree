fuse: fsync() did not return IO errors

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
commit-author Alexey Kuznetsov <kuznet@parallels.com>
commit ac7f052b9e1534c8248f814b6f0068ad8d4a06d2
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/ac7f052b.failed

Due to implementation of fuse writeback filemap_write_and_wait_range() does
not catch errors. We have to do this directly after fuse_sync_writes()

	Signed-off-by: Alexey Kuznetsov <kuznet@virtuozzo.com>
	Signed-off-by: Maxim Patlasov <mpatlasov@virtuozzo.com>
	Signed-off-by: Miklos Szeredi <mszeredi@redhat.com>
Fixes: 4d99ff8f12eb ("fuse: Turn writeback cache on")
	Cc: <stable@vger.kernel.org> # v3.15+
(cherry picked from commit ac7f052b9e1534c8248f814b6f0068ad8d4a06d2)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/fuse/file.c
diff --cc fs/fuse/file.c
index d613834754c6,2491f388358b..000000000000
--- a/fs/fuse/file.c
+++ b/fs/fuse/file.c
@@@ -498,12 -462,27 +498,33 @@@ int fuse_fsync_common(struct file *file
  		goto out;
  
  	fuse_sync_writes(inode);
++<<<<<<< HEAD
++=======
+ 
+ 	/*
+ 	 * Due to implementation of fuse writeback
+ 	 * filemap_write_and_wait_range() does not catch errors.
+ 	 * We have to do this directly after fuse_sync_writes()
+ 	 */
+ 	if (test_bit(AS_ENOSPC, &file->f_mapping->flags) &&
+ 	    test_and_clear_bit(AS_ENOSPC, &file->f_mapping->flags))
+ 		err = -ENOSPC;
+ 	if (test_bit(AS_EIO, &file->f_mapping->flags) &&
+ 	    test_and_clear_bit(AS_EIO, &file->f_mapping->flags))
+ 		err = -EIO;
+ 	if (err)
+ 		goto out;
+ 
+ 	err = sync_inode_metadata(inode, 1);
+ 	if (err)
+ 		goto out;
++>>>>>>> ac7f052b9e15 (fuse: fsync() did not return IO errors)
  
 -	if ((!isdir && fc->no_fsync) || (isdir && fc->no_fsyncdir))
 +	req = fuse_get_req_nopages(fc);
 +	if (IS_ERR(req)) {
 +		err = PTR_ERR(req);
  		goto out;
 +	}
  
  	memset(&inarg, 0, sizeof(inarg));
  	inarg.fh = ff->fh;
* Unmerged path fs/fuse/file.c
