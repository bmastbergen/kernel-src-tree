s390/speculation: Support 'mitigations=' cmdline option

jira LE-1907
cve CVE-2019-11091
cve CVE-2018-12130
cve CVE-2018-12127
cve CVE-2018-12126
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
commit-author Josh Poimboeuf <jpoimboe@redhat.com>
commit 0336e04a6520bdaefdb0769d2a70084fa52e81ed
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/0336e04a.failed

Configure s390 runtime CPU speculation bug mitigations in accordance
with the 'mitigations=' cmdline option.  This affects Spectre v1 and
Spectre v2.

The default behavior is unchanged.

	Signed-off-by: Josh Poimboeuf <jpoimboe@redhat.com>
	Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
	Tested-by: Jiri Kosina <jkosina@suse.cz> (on x86)
	Reviewed-by: Jiri Kosina <jkosina@suse.cz>
	Cc: Borislav Petkov <bp@alien8.de>
	Cc: "H . Peter Anvin" <hpa@zytor.com>
	Cc: Andy Lutomirski <luto@kernel.org>
	Cc: Peter Zijlstra <peterz@infradead.org>
	Cc: Jiri Kosina <jikos@kernel.org>
	Cc: Waiman Long <longman@redhat.com>
	Cc: Andrea Arcangeli <aarcange@redhat.com>
	Cc: Jon Masters <jcm@redhat.com>
	Cc: Benjamin Herrenschmidt <benh@kernel.crashing.org>
	Cc: Paul Mackerras <paulus@samba.org>
	Cc: Michael Ellerman <mpe@ellerman.id.au>
	Cc: linuxppc-dev@lists.ozlabs.org
	Cc: Martin Schwidefsky <schwidefsky@de.ibm.com>
	Cc: Heiko Carstens <heiko.carstens@de.ibm.com>
	Cc: linux-s390@vger.kernel.org
	Cc: Catalin Marinas <catalin.marinas@arm.com>
	Cc: Will Deacon <will.deacon@arm.com>
	Cc: linux-arm-kernel@lists.infradead.org
	Cc: linux-arch@vger.kernel.org
	Cc: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
	Cc: Tyler Hicks <tyhicks@canonical.com>
	Cc: Linus Torvalds <torvalds@linux-foundation.org>
	Cc: Randy Dunlap <rdunlap@infradead.org>
	Cc: Steven Price <steven.price@arm.com>
	Cc: Phil Auld <pauld@redhat.com>
Link: https://lkml.kernel.org/r/e4a161805458a5ec88812aac0307ae3908a030fc.1555085500.git.jpoimboe@redhat.com

(cherry picked from commit 0336e04a6520bdaefdb0769d2a70084fa52e81ed)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	Documentation/kernel-parameters.txt
#	arch/s390/kernel/nospec-branch.c
diff --cc Documentation/kernel-parameters.txt
index f6852ae416ce,1ae93872b79f..000000000000
--- a/Documentation/kernel-parameters.txt
+++ b/Documentation/kernel-parameters.txt
@@@ -1989,6 -2513,38 +1989,41 @@@ bytes respectively. Such letter suffixe
  			in the "bleeding edge" mini2440 support kernel at
  			http://repo.or.cz/w/linux-2.6/mini2440.git
  
++<<<<<<< HEAD:Documentation/kernel-parameters.txt
++=======
+ 	mitigations=
+ 			[X86,PPC,S390] Control optional mitigations for CPU
+ 			vulnerabilities.  This is a set of curated,
+ 			arch-independent options, each of which is an
+ 			aggregation of existing arch-specific options.
+ 
+ 			off
+ 				Disable all optional CPU mitigations.  This
+ 				improves system performance, but it may also
+ 				expose users to several CPU vulnerabilities.
+ 				Equivalent to: nopti [X86,PPC]
+ 					       nospectre_v1 [PPC]
+ 					       nobp=0 [S390]
+ 					       nospectre_v2 [X86,PPC,S390]
+ 					       spectre_v2_user=off [X86]
+ 					       spec_store_bypass_disable=off [X86,PPC]
+ 					       l1tf=off [X86]
+ 
+ 			auto (default)
+ 				Mitigate all CPU vulnerabilities, but leave SMT
+ 				enabled, even if it's vulnerable.  This is for
+ 				users who don't want to be surprised by SMT
+ 				getting disabled across kernel upgrades, or who
+ 				have other ways of avoiding SMT-based attacks.
+ 				Equivalent to: (default behavior)
+ 
+ 			auto,nosmt
+ 				Mitigate all CPU vulnerabilities, disabling SMT
+ 				if needed.  This is for users who always want to
+ 				be fully mitigated, even if it means losing SMT.
+ 				Equivalent to: l1tf=flush,nosmt [X86]
+ 
++>>>>>>> 0336e04a6520 (s390/speculation: Support 'mitigations=' cmdline option):Documentation/admin-guide/kernel-parameters.txt
  	mminit_loglevel=
  			[KNL] When CONFIG_DEBUG_MEMORY_INIT is set, this
  			parameter allows control of the logging verbosity for
diff --cc arch/s390/kernel/nospec-branch.c
index b27c6240b64c,649135cbedd5..000000000000
--- a/arch/s390/kernel/nospec-branch.c
+++ b/arch/s390/kernel/nospec-branch.c
@@@ -1,7 -1,7 +1,11 @@@
  // SPDX-License-Identifier: GPL-2.0
  #include <linux/module.h>
  #include <linux/device.h>
++<<<<<<< HEAD
 +#include <asm/facility.h>
++=======
+ #include <linux/cpu.h>
++>>>>>>> 0336e04a6520 (s390/speculation: Support 'mitigations=' cmdline option)
  #include <asm/nospec-branch.h>
  
  static int __init nobp_setup_early(char *str)
* Unmerged path Documentation/kernel-parameters.txt
* Unmerged path arch/s390/kernel/nospec-branch.c
