nfp: don't fail probe on pci_sriov_set_totalvfs() errors

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
commit-author Jakub Kicinski <jakub.kicinski@netronome.com>
commit 5b0ced17edc5710d4e946392d0f2934a9e07b37f
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/5b0ced17.failed

On machines with buggy ACPI tables or when SR-IOV is already enabled
we may not be able to set the SR-IOV VF limit in sysfs, it's not fatal
because the limit is imposed by the driver anyway.  Only the sysfs
'sriov_totalvfs' attribute will be too high.  Print an error to inform
user about the failure but allow probe to continue.

	Signed-off-by: Jakub Kicinski <jakub.kicinski@netronome.com>
	Reviewed-by: Dirk van der Merwe <dirk.vandermerwe@netronome.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 5b0ced17edc5710d4e946392d0f2934a9e07b37f)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/netronome/nfp/nfp_main.c
diff --cc drivers/net/ethernet/netronome/nfp/nfp_main.c
index 629e68787af2,4a540c5e27fe..000000000000
--- a/drivers/net/ethernet/netronome/nfp/nfp_main.c
+++ b/drivers/net/ethernet/netronome/nfp/nfp_main.c
@@@ -235,17 -236,20 +235,28 @@@ static int nfp_pcie_sriov_read_nfd_limi
  	int err;
  
  	pf->limit_vfs = nfp_rtsym_read_le(pf->rtbl, "nfd_vf_cfg_max_vfs", &err);
- 	if (!err)
- 		return pci_sriov_set_totalvfs(pf->pdev, pf->limit_vfs);
+ 	if (err) {
+ 		/* For backwards compatibility if symbol not found allow all */
+ 		pf->limit_vfs = ~0;
+ 		if (err == -ENOENT)
+ 			return 0;
  
++<<<<<<< HEAD
 +	pf->limit_vfs = ~0;
 +	pci_sriov_set_totalvfs(pf->pdev, 0); /* 0 is unset */
 +	/* Allow any setting for backwards compatibility if symbol not found */
 +	if (err == -ENOENT)
 +		return 0;
++=======
+ 		nfp_warn(pf->cpp, "Warning: VF limit read failed: %d\n", err);
+ 		return err;
+ 	}
++>>>>>>> 5b0ced17edc5 (nfp: don't fail probe on pci_sriov_set_totalvfs() errors)
  
- 	nfp_warn(pf->cpp, "Warning: VF limit read failed: %d\n", err);
- 	return err;
+ 	err = pci_sriov_set_totalvfs(pf->pdev, pf->limit_vfs);
+ 	if (err)
+ 		nfp_warn(pf->cpp, "Failed to set VF count in sysfs: %d\n", err);
+ 	return 0;
  }
  
  static int nfp_pcie_sriov_enable(struct pci_dev *pdev, int num_vfs)
* Unmerged path drivers/net/ethernet/netronome/nfp/nfp_main.c
