net/sched: Fix update of lastuse in act modules implementing stats_update

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
Rebuild_CHGLOG: - [net] sched: Fix update of lastuse in act modules implementing stats_update (Davide Caratti) [1699910 1706791]
Rebuild_FUZZ: 97.18%
commit-author Roi Dayan <roid@mellanox.com>
commit 3bb23421a504f01551b7cb9dff0e41dbf16656b0
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/3bb23421.failed

We need to update lastuse to to the most updated value between what
is already set and the new value.
If HW matching fails, i.e. because of an issue, the stats are not updated
but it could be that software did match and updated lastuse.

Fixes: 5712bf9c5c30 ("net/sched: act_mirred: Use passed lastuse argument")
Fixes: 9fea47d93bcc ("net/sched: act_gact: Update statistics when offloaded to hardware")
	Signed-off-by: Roi Dayan <roid@mellanox.com>
	Reviewed-by: Paul Blakey <paulb@mellanox.com>
	Acked-by: Jiri Pirko <jiri@mellanox.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 3bb23421a504f01551b7cb9dff0e41dbf16656b0)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/sched/act_mirred.c
diff --cc net/sched/act_mirred.c
index 6dae7461a73c,08b61849c2a2..000000000000
--- a/net/sched/act_mirred.c
+++ b/net/sched/act_mirred.c
@@@ -236,8 -238,8 +236,13 @@@ static void tcf_stats_update(struct tc_
  	struct tcf_mirred *m = to_mirred(a);
  	struct tcf_t *tm = &m->tcf_tm;
  
++<<<<<<< HEAD
 +	_bstats_cpu_update(this_cpu_ptr(m->common.cpu_bstats), bytes, packets);
 +	tm->lastuse = lastuse;
++=======
+ 	_bstats_cpu_update(this_cpu_ptr(a->cpu_bstats), bytes, packets);
+ 	tm->lastuse = max_t(u64, tm->lastuse, lastuse);
++>>>>>>> 3bb23421a504 (net/sched: Fix update of lastuse in act modules implementing stats_update)
  }
  
  static int tcf_mirred_dump(struct sk_buff *skb, struct tc_action *a, int bind,
diff --git a/net/sched/act_gact.c b/net/sched/act_gact.c
index bbe5e1d20fab..835848b4709d 100644
--- a/net/sched/act_gact.c
+++ b/net/sched/act_gact.c
@@ -159,7 +159,7 @@ static void tcf_gact_stats_update(struct tc_action *a, u64 bytes, u32 packets,
 	if (action == TC_ACT_SHOT)
 		this_cpu_ptr(gact->common.cpu_qstats)->drops += packets;
 
-	tm->lastuse = lastuse;
+	tm->lastuse = max_t(u64, tm->lastuse, lastuse);
 }
 
 static int tcf_gact_dump(struct sk_buff *skb, struct tc_action *a,
* Unmerged path net/sched/act_mirred.c
