RDMA/mlx5: Add NIC TX steering support

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
commit-author Mark Bloch <markb@mellanox.com>
commit 78dd0c430f116a325eeda61416c0b36a8206fbfc
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/78dd0c43.failed

Just like ingress steering, allow a user to create steering rules that
match egress vport traffic. We expose the same number of priorities as
the bypass (NIC RX) steering.

	Signed-off-by: Mark Bloch <markb@mellanox.com>
	Signed-off-by: Leon Romanovsky <leonro@mellanox.com>
	Signed-off-by: Jason Gunthorpe <jgg@mellanox.com>
(cherry picked from commit 78dd0c430f116a325eeda61416c0b36a8206fbfc)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/hw/mlx5/main.c
diff --cc drivers/infiniband/hw/mlx5/main.c
index 1d3555c545d0,ed323db1b6d2..000000000000
--- a/drivers/infiniband/hw/mlx5/main.c
+++ b/drivers/infiniband/hw/mlx5/main.c
@@@ -2906,13 -3074,19 +2906,23 @@@ static struct mlx5_ib_flow_prio *get_fl
  		else
  			priority = ib_prio_to_core_prio(flow_attr->priority,
  							dont_trap);
- 		ns = mlx5_get_flow_namespace(dev->mdev,
- 					     ft_type == MLX5_IB_FT_TX ?
- 					     MLX5_FLOW_NAMESPACE_EGRESS :
- 					     MLX5_FLOW_NAMESPACE_BYPASS);
+ 		if (ft_type == MLX5_IB_FT_RX) {
+ 			fn_type = MLX5_FLOW_NAMESPACE_BYPASS;
+ 			prio = &dev->flow_db->prios[priority];
+ 		} else {
+ 			max_table_size =
+ 				BIT(MLX5_CAP_FLOWTABLE_NIC_TX(dev->mdev,
+ 							      log_max_ft_size));
+ 			fn_type = MLX5_FLOW_NAMESPACE_EGRESS;
+ 			prio = &dev->flow_db->egress_prios[priority];
+ 		}
+ 		ns = mlx5_get_flow_namespace(dev->mdev, fn_type);
  		num_entries = MLX5_FS_MAX_ENTRIES;
  		num_groups = MLX5_FS_MAX_TYPES;
++<<<<<<< HEAD
 +		prio = &dev->flow_db.prios[priority];
++=======
++>>>>>>> 78dd0c430f11 (RDMA/mlx5: Add NIC TX steering support)
  	} else if (flow_attr->type == IB_FLOW_ATTR_ALL_DEFAULT ||
  		   flow_attr->type == IB_FLOW_ATTR_MC_DEFAULT) {
  		ns = mlx5_get_flow_namespace(dev->mdev,
* Unmerged path drivers/infiniband/hw/mlx5/main.c
diff --git a/drivers/infiniband/hw/mlx5/mlx5_ib.h b/drivers/infiniband/hw/mlx5/mlx5_ib.h
index 71b1991d86b3..70134faef0d0 100644
--- a/drivers/infiniband/hw/mlx5/mlx5_ib.h
+++ b/drivers/infiniband/hw/mlx5/mlx5_ib.h
@@ -161,6 +161,7 @@ struct mlx5_ib_flow_handler {
 
 struct mlx5_ib_flow_db {
 	struct mlx5_ib_flow_prio	prios[MLX5_IB_NUM_FLOW_FT];
+	struct mlx5_ib_flow_prio	egress_prios[MLX5_IB_NUM_FLOW_FT];
 	struct mlx5_ib_flow_prio	sniffer[MLX5_IB_NUM_SNIFFER_FTS];
 	struct mlx5_ib_flow_prio	egress[MLX5_IB_NUM_EGRESS_FTS];
 	struct mlx5_flow_table		*lag_demux_ft;
