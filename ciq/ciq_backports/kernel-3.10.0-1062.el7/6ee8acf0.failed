ovl: split out ovl_get_upperpath() from ovl_fill_super()

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
commit-author Miklos Szeredi <mszeredi@redhat.com>
commit 6ee8acf0f72b89b3c6d9df9cbe9b815711af3c7b
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/6ee8acf0.failed

It's okay to get rid of the intermediate error label due to ufs being
zeroed on allocation.

	Signed-off-by: Miklos Szeredi <mszeredi@redhat.com>
(cherry picked from commit 6ee8acf0f72b89b3c6d9df9cbe9b815711af3c7b)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/overlayfs/super.c
diff --cc fs/overlayfs/super.c
index 19e9eb0f1d4f,c1abd66527ce..000000000000
--- a/fs/overlayfs/super.c
+++ b/fs/overlayfs/super.c
@@@ -921,30 -903,9 +954,34 @@@ static int ovl_fill_super(struct super_
  			goto out_free_config;
  		}
  
- 		err = ovl_mount_dir(ufs->config.upperdir, &upperpath);
+ 		err = ovl_get_upperpath(ufs, &upperpath);
  		if (err)
++<<<<<<< HEAD
 +			goto out_free_config;
 +
 +		/* Upper fs should not be r/o */
 +		if (upperpath.mnt->mnt_sb->s_flags & MS_RDONLY) {
 +			pr_err("overlayfs: upper fs is r/o, try multi-lower layers mount\n");
 +			err = -EINVAL;
 +			goto out_put_upperpath;
 +		}
 +
 +		err = ovl_check_namelen(&upperpath, ufs, ufs->config.upperdir);
 +		if (err)
 +			goto out_put_upperpath;
 +
 +		err = -EBUSY;
 +		if (ovl_inuse_trylock(upperpath.dentry)) {
 +			ufs->upperdir_locked = true;
 +		} else if (ufs->config.index) {
 +			pr_err("overlayfs: upperdir is in-use by another mount, mount with '-o index=off' to override exclusive upperdir protection.\n");
 +			goto out_put_upperpath;
 +		} else {
 +			pr_warn("overlayfs: upperdir is in-use by another mount, accessing files from both mounts will result in undefined behavior.\n");
 +		}
++=======
+ 			goto out_unlock_upperdentry;
++>>>>>>> 6ee8acf0f72b (ovl: split out ovl_get_upperpath() from ovl_fill_super())
  
  		err = ovl_mount_dir(ufs->config.workdir, &workpath);
  		if (err)
* Unmerged path fs/overlayfs/super.c
