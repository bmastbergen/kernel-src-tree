svcrdma: Clean up Read chunk path

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
commit-author Chuck Lever <chuck.lever@oracle.com>
commit 07d0ff3b0cd23a4ba7078fb5cc3aeb25e38b3557
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/07d0ff3b.failed

Simplify the error handling at the tail of recv_read_chunk() by
re-arranging rq_pages[] housekeeping and documenting it properly.

NB: In this path, svc_rdma_recvfrom returns zero. Therefore no
subsequent reply processing is done on the svc_rqstp, and thus the
rq_respages field does not need to be updated.

	Signed-off-by: Chuck Lever <chuck.lever@oracle.com>
	Signed-off-by: J. Bruce Fields <bfields@redhat.com>
(cherry picked from commit 07d0ff3b0cd23a4ba7078fb5cc3aeb25e38b3557)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/sunrpc/xprtrdma/svc_rdma_rw.c
diff --cc net/sunrpc/xprtrdma/svc_rdma_rw.c
index 506b9ec4883d,a1ac9997da98..000000000000
--- a/net/sunrpc/xprtrdma/svc_rdma_rw.c
+++ b/net/sunrpc/xprtrdma/svc_rdma_rw.c
@@@ -823,10 -820,9 +830,9 @@@ out
   * - All Read segments in @p have the same Position value.
   */
  int svc_rdma_recv_read_chunk(struct svcxprt_rdma *rdma, struct svc_rqst *rqstp,
 -			     struct svc_rdma_recv_ctxt *head, __be32 *p)
 +			     struct svc_rdma_op_ctxt *head, __be32 *p)
  {
  	struct svc_rdma_read_info *info;
- 	struct page **page;
  	int ret;
  
  	/* The request (with page list) is constructed in
@@@ -852,27 -849,15 +858,27 @@@
  		ret = svc_rdma_build_normal_read_chunk(rqstp, info, p);
  	else
  		ret = svc_rdma_build_pz_read_chunk(rqstp, info, p);
- 
- 	/* Mark the start of the pages that can be used for the reply */
- 	if (info->ri_pageoff > 0)
- 		info->ri_pageno++;
- 	rqstp->rq_respages = &rqstp->rq_pages[info->ri_pageno];
- 	rqstp->rq_next_page = rqstp->rq_respages + 1;
- 
  	if (ret < 0)
- 		goto out;
+ 		goto out_err;
  
  	ret = svc_rdma_post_chunk_ctxt(&info->ri_cc);
++<<<<<<< HEAD
 +
 +out:
 +	/* Read sink pages have been moved from rqstp->rq_pages to
 +	 * head->arg.pages. Force svc_recv to refill those slots
 +	 * in rq_pages.
 +	 */
 +	for (page = rqstp->rq_pages; page < rqstp->rq_respages; page++)
 +		*page = NULL;
 +
++=======
++>>>>>>> 07d0ff3b0cd2 (svcrdma: Clean up Read chunk path)
  	if (ret < 0)
- 		svc_rdma_read_info_free(info);
+ 		goto out_err;
+ 	return 0;
+ 
+ out_err:
+ 	svc_rdma_read_info_free(info);
  	return ret;
  }
* Unmerged path net/sunrpc/xprtrdma/svc_rdma_rw.c
