IB/hfi1: Fix a latency issue for small messages

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
commit-author Michael J. Ruhl <michael.j.ruhl@intel.com>
commit 90b2620e6a8aa08c40cc78d61603e0acd853c33a
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/90b2620e.failed

A recent performance enhancement introduced a latency issue in the
HFI message path.  The new algorithm removed a forced call send for
PIO messages and added a forced schedule event for messages larger
than the MTU.

For PIO, the schedule path can introduce thrashing that can
significantly impact the throughput for small messages.

If a message size is within the PIO threshold, always take the send
path.

Fixes: 0b79b27748cb ("IB/{hfi1, qib, rdmavt}: Schedule multi RC/UC packets instead of posting")
	Reviewed-by: Mike Marciniszyn <mike.marciniszyn@intel.com>
	Signed-off-by: Michael J. Ruhl <michael.j.ruhl@intel.com>
	Signed-off-by: Dennis Dalessandro <dennis.dalessandro@intel.com>
	Signed-off-by: Doug Ledford <dledford@redhat.com>
(cherry picked from commit 90b2620e6a8aa08c40cc78d61603e0acd853c33a)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/hw/hfi1/qp.c
diff --cc drivers/infiniband/hw/hfi1/qp.c
index 3127f24104d4,1a016248039f..000000000000
--- a/drivers/infiniband/hw/hfi1/qp.c
+++ b/drivers/infiniband/hw/hfi1/qp.c
@@@ -331,7 -340,14 +331,18 @@@ int hfi1_check_send_wqe(struct rvt_qp *
  	default:
  		break;
  	}
++<<<<<<< HEAD
 +	return wqe->length <= piothreshold;
++=======
+ 
+ 	/*
+ 	 * System latency between send and schedule is large enough that
+ 	 * forcing call_send to true for piothreshold packets is necessary.
+ 	 */
+ 	if (wqe->length <= piothreshold)
+ 		*call_send = true;
+ 	return 0;
++>>>>>>> 90b2620e6a8a (IB/hfi1: Fix a latency issue for small messages)
  }
  
  /**
* Unmerged path drivers/infiniband/hw/hfi1/qp.c
