scsi: qla2xxx: Fix Management Server NPort handle reservation logic

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
Rebuild_CHGLOG: - [scsi] qla2xxx: Fix Management Server NPort handle reservation logic (Himanshu Madhani) [1628301]
Rebuild_FUZZ: 95.31%
commit-author Quinn Tran <quinn.tran@cavium.com>
commit f6602f3befbb9979cdb031e32211358dd008d05e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/f6602f3b.failed

After selecting the NPort handle/loop_id, set a bit in the loop_id_map to
prevent others from selecting the same NPort handle.

	Signed-off-by: Quinn Tran <quinn.tran@cavium.com>
	Signed-off-by: Himanshu Madhani <himanshu.madhani@cavium.com>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit f6602f3befbb9979cdb031e32211358dd008d05e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/qla2xxx/qla_init.c
diff --cc drivers/scsi/qla2xxx/qla_init.c
index 2d56e66442e3,9d1a8b2c41a9..000000000000
--- a/drivers/scsi/qla2xxx/qla_init.c
+++ b/drivers/scsi/qla2xxx/qla_init.c
@@@ -5572,6 -5615,35 +5572,38 @@@ qla2x00_find_new_loop_id(scsi_qla_host_
  	return (rval);
  }
  
++<<<<<<< HEAD
++=======
+ 
+ /* FW does not set aside Loop id for MGMT Server/FFFFFAh */
+ int
+ qla2x00_reserve_mgmt_server_loop_id(scsi_qla_host_t *vha)
+ {
+ 	int loop_id = FC_NO_LOOP_ID;
+ 	int lid = NPH_MGMT_SERVER - vha->vp_idx;
+ 	unsigned long flags;
+ 	struct qla_hw_data *ha = vha->hw;
+ 
+ 	if (vha->vp_idx == 0) {
+ 		set_bit(NPH_MGMT_SERVER, ha->loop_id_map);
+ 		return NPH_MGMT_SERVER;
+ 	}
+ 
+ 	/* pick id from high and work down to low */
+ 	spin_lock_irqsave(&ha->vport_slock, flags);
+ 	for (; lid > 0; lid--) {
+ 		if (!test_bit(lid, vha->hw->loop_id_map)) {
+ 			set_bit(lid, vha->hw->loop_id_map);
+ 			loop_id = lid;
+ 			break;
+ 		}
+ 	}
+ 	spin_unlock_irqrestore(&ha->vport_slock, flags);
+ 
+ 	return loop_id;
+ }
+ 
++>>>>>>> f6602f3befbb (scsi: qla2xxx: Fix Management Server NPort handle reservation logic)
  /*
   * qla2x00_fabric_login
   *	Issue fabric login command.
diff --git a/drivers/scsi/qla2xxx/qla_gbl.h b/drivers/scsi/qla2xxx/qla_gbl.h
index be81b7dac070..0ec8339b972b 100644
--- a/drivers/scsi/qla2xxx/qla_gbl.h
+++ b/drivers/scsi/qla2xxx/qla_gbl.h
@@ -118,6 +118,7 @@ extern int qla2x00_post_async_prlo_done_work(struct scsi_qla_host *,
     fc_port_t *, uint16_t *);
 int qla_post_iidma_work(struct scsi_qla_host *vha, fc_port_t *fcport);
 void qla_do_iidma_work(struct scsi_qla_host *vha, fc_port_t *fcport);
+int qla2x00_reserve_mgmt_server_loop_id(scsi_qla_host_t *);
 /*
  * Global Data in qla_os.c source file.
  */
* Unmerged path drivers/scsi/qla2xxx/qla_init.c
diff --git a/drivers/scsi/qla2xxx/qla_mid.c b/drivers/scsi/qla2xxx/qla_mid.c
index 78eac8479681..2f4e9f964368 100644
--- a/drivers/scsi/qla2xxx/qla_mid.c
+++ b/drivers/scsi/qla2xxx/qla_mid.c
@@ -492,7 +492,7 @@ qla24xx_create_vhost(struct fc_vport *fc_vport)
 		    "Couldn't allocate vp_id.\n");
 		goto create_vhost_failed;
 	}
-	vha->mgmt_svr_loop_id = NPH_MGMT_SERVER;
+	vha->mgmt_svr_loop_id = qla2x00_reserve_mgmt_server_loop_id(vha);
 
 	vha->dpc_flags = 0L;
 
diff --git a/drivers/scsi/qla2xxx/qla_os.c b/drivers/scsi/qla2xxx/qla_os.c
index 301efcb5851e..8037357aba58 100644
--- a/drivers/scsi/qla2xxx/qla_os.c
+++ b/drivers/scsi/qla2xxx/qla_os.c
@@ -3118,7 +3118,8 @@ qla2x00_probe_one(struct pci_dev *pdev, const struct pci_device_id *id)
 	host = base_vha->host;
 	base_vha->req = req;
 	if (IS_QLA2XXX_MIDTYPE(ha))
-		base_vha->mgmt_svr_loop_id = NPH_MGMT_SERVER;
+		base_vha->mgmt_svr_loop_id =
+			qla2x00_reserve_mgmt_server_loop_id(base_vha);
 	else
 		base_vha->mgmt_svr_loop_id = MANAGEMENT_SERVER +
 						base_vha->vp_idx;
