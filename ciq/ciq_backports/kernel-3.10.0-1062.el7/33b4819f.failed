selftests/powerpc: Add support for skipping tests

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
commit-author Michael Ellerman <mpe@ellerman.id.au>
commit 33b4819f3b93bbcb934e02cbc64ff3c5e9d0149b
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/33b4819f.failed

	Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
	Signed-off-by: Benjamin Herrenschmidt <benh@kernel.crashing.org>
(cherry picked from commit 33b4819f3b93bbcb934e02cbc64ff3c5e9d0149b)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/testing/selftests/powerpc/utils.h
diff --cc tools/testing/selftests/powerpc/utils.h
index 5851c4b0f553,a93777ae0684..000000000000
--- a/tools/testing/selftests/powerpc/utils.h
+++ b/tools/testing/selftests/powerpc/utils.h
@@@ -31,4 -31,19 +31,22 @@@ do {								
  	}							\
  } while (0)
  
++<<<<<<< HEAD
++=======
+ /* The test harness uses this, yes it's gross */
+ #define MAGIC_SKIP_RETURN_VALUE	99
+ 
+ #define SKIP_IF(x)						\
+ do {								\
+ 	if ((x)) {						\
+ 		fprintf(stderr,					\
+ 		"[SKIP] Test skipped on line %d\n", __LINE__);	\
+ 		return MAGIC_SKIP_RETURN_VALUE;			\
+ 	}							\
+ } while (0)
+ 
+ #define _str(s) #s
+ #define str(s) _str(s)
+ 
++>>>>>>> 33b4819f3b93 (selftests/powerpc: Add support for skipping tests)
  #endif /* _SELFTESTS_POWERPC_UTILS_H */
diff --git a/tools/testing/selftests/powerpc/harness.c b/tools/testing/selftests/powerpc/harness.c
index e80c42a584fe..4069151c13a0 100644
--- a/tools/testing/selftests/powerpc/harness.c
+++ b/tools/testing/selftests/powerpc/harness.c
@@ -99,7 +99,10 @@ int test_harness(int (test_function)(void), char *name)
 
 	rc = run_test(test_function, name);
 
-	test_finish(name, rc);
+	if (rc == MAGIC_SKIP_RETURN_VALUE)
+		test_skip(name);
+	else
+		test_finish(name, rc);
 
 	return rc;
 }
diff --git a/tools/testing/selftests/powerpc/subunit.h b/tools/testing/selftests/powerpc/subunit.h
index 98a22920792d..9c6c4e901ab6 100644
--- a/tools/testing/selftests/powerpc/subunit.h
+++ b/tools/testing/selftests/powerpc/subunit.h
@@ -26,6 +26,11 @@ static inline void test_error(char *name)
 	printf("error: %s\n", name);
 }
 
+static inline void test_skip(char *name)
+{
+	printf("skip: %s\n", name);
+}
+
 static inline void test_success(char *name)
 {
 	printf("success: %s\n", name);
* Unmerged path tools/testing/selftests/powerpc/utils.h
