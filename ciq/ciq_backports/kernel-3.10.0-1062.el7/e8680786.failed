ext4: avoid kernel warning when writing the superblock to a dead device

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1062.el7
commit-author Theodore Ts'o <tytso@mit.edu>
commit e86807862e6880809f191c4cea7f88a489f0ed34
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1062.el7/e8680786.failed

The xfstests generic/475 test switches the underlying device with
dm-error while running a stress test.  This results in a large number
of file system errors, and since we can't lock the buffer head when
marking the superblock dirty in the ext4_grp_locked_error() case, it's
possible the superblock to be !buffer_uptodate() without
buffer_write_io_error() being true.

We need to set buffer_uptodate() before we call mark_buffer_dirty() or
this will trigger a WARN_ON.  It's safe to do this since the
superblock must have been properly read into memory or the mount would
have been successful.  So if buffer_uptodate() is not set, we can
safely assume that this happened due to a failed attempt to write the
superblock.

	Signed-off-by: Theodore Ts'o <tytso@mit.edu>
	Cc: stable@vger.kernel.org
(cherry picked from commit e86807862e6880809f191c4cea7f88a489f0ed34)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/ext4/super.c
diff --cc fs/ext4/super.c
index e305015822e9,fb12d3c17c1b..000000000000
--- a/fs/ext4/super.c
+++ b/fs/ext4/super.c
@@@ -4777,8 -4900,9 +4777,14 @@@ static int ext4_commit_super(struct sup
  				&EXT4_SB(sb)->s_freeinodes_counter));
  	BUFFER_TRACE(sbh, "marking dirty");
  	ext4_superblock_csum_set(sb);
++<<<<<<< HEAD
 +	lock_buffer(sbh);
 +	if (buffer_write_io_error(sbh)) {
++=======
+ 	if (sync)
+ 		lock_buffer(sbh);
+ 	if (buffer_write_io_error(sbh) || !buffer_uptodate(sbh)) {
++>>>>>>> e86807862e68 (ext4: avoid kernel warning when writing the superblock to a dead device)
  		/*
  		 * Oh, dear.  A previous attempt to write the
  		 * superblock failed.  This could happen because the
* Unmerged path fs/ext4/super.c
