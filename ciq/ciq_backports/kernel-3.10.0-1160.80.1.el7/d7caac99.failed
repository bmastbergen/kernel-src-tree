x86/cpu/amd: Add Spectral Chicken

jira LE-1907
cve CVE-2022-29901
cve CVE-2022-29900
cve CVE-2022-23825
cve CVE-2022-23816
Rebuild_History Non-Buildable kernel-3.10.0-1160.80.1.el7
commit-author Peter Zijlstra <peterz@infradead.org>
commit d7caac991feeef1b871ee6988fd2c9725df09039
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1160.80.1.el7/d7caac99.failed

Zen2 uarchs have an undocumented, unnamed, MSR that contains a chicken
bit for some speculation behaviour. It needs setting.

Note: very belatedly AMD released naming; it's now officially called
      MSR_AMD64_DE_CFG2 and MSR_AMD64_DE_CFG2_SUPPRESS_NOBR_PRED_BIT
      but shall remain the SPECTRAL CHICKEN.

	Suggested-by: Andrew Cooper <Andrew.Cooper3@citrix.com>
	Signed-off-by: Peter Zijlstra (Intel) <peterz@infradead.org>
	Signed-off-by: Borislav Petkov <bp@suse.de>
	Reviewed-by: Josh Poimboeuf <jpoimboe@kernel.org>
	Signed-off-by: Borislav Petkov <bp@suse.de>
(cherry picked from commit d7caac991feeef1b871ee6988fd2c9725df09039)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kernel/cpu/amd.c
#	arch/x86/kernel/cpu/hygon.c
diff --cc arch/x86/kernel/cpu/amd.c
index d7ce06da0b0b,8cf0659c0521..000000000000
--- a/arch/x86/kernel/cpu/amd.c
+++ b/arch/x86/kernel/cpu/amd.c
@@@ -634,13 -854,34 +634,33 @@@ static void early_init_amd(struct cpuin
  		}
  	}
  
 -	/*
 -	 * Some BIOS implementations do not restore proper RDRAND support
 -	 * across suspend and resume. Check on whether to hide the RDRAND
 -	 * instruction support via CPUID.
 -	 */
 -	clear_rdrand_cpuid_bit(c);
 +	amd_get_topology_early(c);
  }
  
 +static const int amd_erratum_383[];
 +static const int amd_erratum_400[];
 +static bool cpu_has_amd_erratum(struct cpuinfo_x86 *cpu, const int *erratum);
 +
+ void init_spectral_chicken(struct cpuinfo_x86 *c)
+ {
+ 	u64 value;
+ 
+ 	/*
+ 	 * On Zen2 we offer this chicken (bit) on the altar of Speculation.
+ 	 *
+ 	 * This suppresses speculation from the middle of a basic block, i.e. it
+ 	 * suppresses non-branch predictions.
+ 	 *
+ 	 * We use STIBP as a heuristic to filter out Zen2 from the rest of F17H
+ 	 */
+ 	if (!cpu_has(c, X86_FEATURE_HYPERVISOR) && cpu_has(c, X86_FEATURE_AMD_STIBP)) {
+ 		if (!rdmsrl_safe(MSR_ZEN2_SPECTRAL_CHICKEN, &value)) {
+ 			value |= MSR_ZEN2_SPECTRAL_CHICKEN_BIT;
+ 			wrmsrl_safe(MSR_ZEN2_SPECTRAL_CHICKEN, value);
+ 		}
+ 	}
+ }
+ 
  static void init_amd_zn(struct cpuinfo_x86 *c)
  {
  	set_cpu_cap(c, X86_FEATURE_ZEN);
@@@ -738,20 -917,19 +758,35 @@@ static void init_amd(struct cpuinfo_x8
  	/* K6s reports MCEs but don't actually have all the MSRs */
  	if (c->x86 < 6)
  		clear_cpu_cap(c, X86_FEATURE_MCE);
 +#endif
 +
++<<<<<<< HEAD
 +	/* Enable workaround for FXSAVE leak */
 +	if (c->x86 >= 6)
 +		set_cpu_cap(c, X86_FEATURE_FXSAVE_LEAK);
  
 +	if (!c->x86_model_id[0]) {
 +		switch (c->x86) {
 +		case 0xf:
 +			/* Should distinguish Models here, but this is only
 +			   a fallback anyways. */
 +			strcpy(c->x86_model_id, "Hammer");
 +			break;
 +		}
++=======
+ 	switch (c->x86) {
+ 	case 4:    init_amd_k5(c); break;
+ 	case 5:    init_amd_k6(c); break;
+ 	case 6:	   init_amd_k7(c); break;
+ 	case 0xf:  init_amd_k8(c); break;
+ 	case 0x10: init_amd_gh(c); break;
+ 	case 0x12: init_amd_ln(c); break;
+ 	case 0x15: init_amd_bd(c); break;
+ 	case 0x16: init_amd_jg(c); break;
+ 	case 0x17: init_spectral_chicken(c);
+ 		   fallthrough;
+ 	case 0x19: init_amd_zn(c); break;
++>>>>>>> d7caac991fee (x86/cpu/amd: Add Spectral Chicken)
  	}
  
  	/*
* Unmerged path arch/x86/kernel/cpu/hygon.c
diff --git a/arch/x86/include/asm/msr-index.h b/arch/x86/include/asm/msr-index.h
index 0607fd9388b3..57a049a63957 100644
--- a/arch/x86/include/asm/msr-index.h
+++ b/arch/x86/include/asm/msr-index.h
@@ -404,6 +404,9 @@
 #define MSR_AMD64_SEV_ENABLED_BIT	0
 #define MSR_AMD64_SEV_ENABLED		BIT_ULL(MSR_AMD64_SEV_ENABLED_BIT)
 
+#define MSR_ZEN2_SPECTRAL_CHICKEN	0xc00110e3
+#define MSR_ZEN2_SPECTRAL_CHICKEN_BIT	BIT_ULL(1)
+
 /* Fam 16h MSRs */
 #define MSR_F16H_L2I_PERF_CTL		0xc0010230
 #define MSR_F16H_L2I_PERF_CTR		0xc0010231
* Unmerged path arch/x86/kernel/cpu/amd.c
diff --git a/arch/x86/kernel/cpu/cpu.h b/arch/x86/kernel/cpu/cpu.h
index 920081d4dfc9..c665c897c625 100644
--- a/arch/x86/kernel/cpu/cpu.h
+++ b/arch/x86/kernel/cpu/cpu.h
@@ -57,6 +57,8 @@ extern void tsx_disable(void);
 static inline void tsx_init(void) { }
 #endif /* CONFIG_CPU_SUP_INTEL */
 
+extern void init_spectral_chicken(struct cpuinfo_x86 *c);
+
 extern void get_cpu_cap(struct cpuinfo_x86 *c);
 extern void cpu_detect_cache_sizes(struct cpuinfo_x86 *c);
 extern int detect_extended_topology_early(struct cpuinfo_x86 *c);
* Unmerged path arch/x86/kernel/cpu/hygon.c
