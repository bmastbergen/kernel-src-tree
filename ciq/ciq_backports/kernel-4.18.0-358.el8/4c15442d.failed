scsi: qla2xxx: Add host attribute to trigger MPI hang

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-358.el8
commit-author Arun Easi <aeasi@marvell.com>
commit 4c15442d9c06ae6ce0a03fd69c4869f343d67473
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-358.el8/4c15442d.failed

Add a mechanism to trigger MPI pause for debugging purposes.

Link: https://lore.kernel.org/r/20210810043720.1137-2-njavali@marvell.com
	Reviewed-by: Himanshu Madhani <himanshu.madhani@oracle.com>
	Signed-off-by: Arun Easi <aeasi@marvell.com>
	Signed-off-by: Nilesh Javali <njavali@marvell.com>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit 4c15442d9c06ae6ce0a03fd69c4869f343d67473)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/qla2xxx/qla_attr.c
diff --cc drivers/scsi/qla2xxx/qla_attr.c
index f781e4a61afe,4a0a5b4e688d..000000000000
--- a/drivers/scsi/qla2xxx/qla_attr.c
+++ b/drivers/scsi/qla2xxx/qla_attr.c
@@@ -1823,16 -1884,33 +1823,40 @@@ qla2x00_port_speed_show(struct device *
  		return -EINVAL;
  	}
  
 -	return scnprintf(buf, PAGE_SIZE, "%s\n", spd[ha->link_data_rate]);
 +	for (i = 0; i < ARRAY_SIZE(port_speed_str); i++) {
 +		if (port_speed_str[i].rate != ha->link_data_rate)
 +			continue;
 +		speed = port_speed_str[i].str;
 +		break;
 +	}
 +
 +	return scnprintf(buf, PAGE_SIZE, "%s\n", speed);
  }
  
+ static ssize_t
+ qla2x00_mpi_pause_store(struct device *dev,
+ 	struct device_attribute *attr, const char *buf, size_t count)
+ {
+ 	scsi_qla_host_t *vha = shost_priv(class_to_shost(dev));
+ 	int rval = 0;
+ 
+ 	if (sscanf(buf, "%d", &rval) != 1)
+ 		return -EINVAL;
+ 
+ 	ql_log(ql_log_warn, vha, 0x7089, "Pausing MPI...\n");
+ 
+ 	rval = qla83xx_wr_reg(vha, 0x002012d4, 0x30000001);
+ 
+ 	if (rval != QLA_SUCCESS) {
+ 		ql_log(ql_log_warn, vha, 0x708a, "Unable to pause MPI.\n");
+ 		count = 0;
+ 	}
+ 
+ 	return count;
+ }
+ 
+ static DEVICE_ATTR(mpi_pause, S_IWUSR, NULL, qla2x00_mpi_pause_store);
+ 
  /* ----- */
  
  static ssize_t
@@@ -2402,6 -2504,9 +2426,12 @@@ struct device_attribute *qla2x00_host_a
  	&dev_attr_port_speed,
  	&dev_attr_port_no,
  	&dev_attr_fw_attr,
++<<<<<<< HEAD
++=======
+ 	&dev_attr_dport_diagnostics,
+ 	&dev_attr_edif_doorbell,
+ 	&dev_attr_mpi_pause,
++>>>>>>> 4c15442d9c06 (scsi: qla2xxx: Add host attribute to trigger MPI hang)
  	NULL, /* reserve for qlini_mode */
  	NULL, /* reserve for ql2xiniexchg */
  	NULL, /* reserve for ql2xexchoffld */
* Unmerged path drivers/scsi/qla2xxx/qla_attr.c
