kvm: debugfs: fix memory leak in kvm_create_vm_debugfs

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-358.el8
commit-author Pavel Skripkin <paskripkin@gmail.com>
commit 004d62eb4e57db3c391ed0df007cc11c93b6fbeb
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-358.el8/004d62eb.failed

In commit bc9e9e672df9 ("KVM: debugfs: Reuse binary stats descriptors")
loop for filling debugfs_stat_data was copy-pasted 2 times, but
in the second loop pointers are saved over pointers allocated
in the first loop.  All this causes is a memory leak, fix it.

Fixes: bc9e9e672df9 ("KVM: debugfs: Reuse binary stats descriptors")
	Signed-off-by: Pavel Skripkin <paskripkin@gmail.com>
	Reviewed-by: Jing Zhang <jingzhangos@google.com>
Message-Id: <20210701195500.27097-1-paskripkin@gmail.com>
	Reviewed-by: Jing Zhang <jingzhangos@google.com>
	Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
(cherry picked from commit 004d62eb4e57db3c391ed0df007cc11c93b6fbeb)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	virt/kvm/kvm_main.c
diff --cc virt/kvm/kvm_main.c
index 9d090cc95b7f,6980dabe9df5..000000000000
--- a/virt/kvm/kvm_main.c
+++ b/virt/kvm/kvm_main.c
@@@ -738,9 -918,25 +738,31 @@@ static int kvm_create_vm_debugfs(struc
  			return -ENOMEM;
  
  		stat_data->kvm = kvm;
++<<<<<<< HEAD
 +		stat_data->dbgfs_item = p;
 +		kvm->debugfs_stat_data[p - debugfs_entries] = stat_data;
 +		debugfs_create_file(p->name, KVM_DBGFS_GET_MODE(p),
++=======
+ 		stat_data->desc = pdesc;
+ 		stat_data->kind = KVM_STAT_VM;
+ 		kvm->debugfs_stat_data[i] = stat_data;
+ 		debugfs_create_file(pdesc->name, kvm_stats_debugfs_mode(pdesc),
+ 				    kvm->debugfs_dentry, stat_data,
+ 				    &stat_fops_per_vm);
+ 	}
+ 
+ 	for (i = 0; i < kvm_vcpu_stats_header.num_desc; ++i) {
+ 		pdesc = &kvm_vcpu_stats_desc[i];
+ 		stat_data = kzalloc(sizeof(*stat_data), GFP_KERNEL_ACCOUNT);
+ 		if (!stat_data)
+ 			return -ENOMEM;
+ 
+ 		stat_data->kvm = kvm;
+ 		stat_data->desc = pdesc;
+ 		stat_data->kind = KVM_STAT_VCPU;
+ 		kvm->debugfs_stat_data[i + kvm_vm_stats_header.num_desc] = stat_data;
+ 		debugfs_create_file(pdesc->name, kvm_stats_debugfs_mode(pdesc),
++>>>>>>> 004d62eb4e57 (kvm: debugfs: fix memory leak in kvm_create_vm_debugfs)
  				    kvm->debugfs_dentry, stat_data,
  				    &stat_fops_per_vm);
  	}
* Unmerged path virt/kvm/kvm_main.c
