net: bridge: multicast: fix MRD advertisement router port marking race

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-358.el8
commit-author Nikolay Aleksandrov <nikolay@nvidia.com>
commit 000b7287b67555fee39d39fff75229dedde0dcbf
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-358.el8/000b7287.failed

When an MRD advertisement is received on a bridge port with multicast
snooping enabled, we mark it as a router port automatically, that
includes adding that port to the router port list. The multicast lock
protects that list, but it is not acquired in the MRD advertisement case
leading to a race condition, we need to take it to fix the race.

	Cc: stable@vger.kernel.org
	Cc: linus.luessing@c0d3.blue
Fixes: 4b3087c7e37f ("bridge: Snoop Multicast Router Advertisements")
	Signed-off-by: Nikolay Aleksandrov <nikolay@nvidia.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 000b7287b67555fee39d39fff75229dedde0dcbf)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/bridge/br_multicast.c
diff --cc net/bridge/br_multicast.c
index def6f1840985,d0434dc8c03b..000000000000
--- a/net/bridge/br_multicast.c
+++ b/net/bridge/br_multicast.c
@@@ -2603,7 -3277,9 +2603,13 @@@ static int br_ip4_multicast_mrd_rcv(str
  	    igmp_hdr(skb)->type != IGMP_MRDISC_ADV)
  		return -ENOMSG;
  
++<<<<<<< HEAD
 +	br_multicast_mark_router(br, port);
++=======
+ 	spin_lock(&br->multicast_lock);
+ 	br_ip4_multicast_mark_router(br, port);
+ 	spin_unlock(&br->multicast_lock);
++>>>>>>> 000b7287b675 (net: bridge: multicast: fix MRD advertisement router port marking race)
  
  	return 0;
  }
@@@ -2671,7 -3347,9 +2677,13 @@@ static void br_ip6_multicast_mrd_rcv(st
  	if (icmp6_hdr(skb)->icmp6_type != ICMPV6_MRDISC_ADV)
  		return;
  
++<<<<<<< HEAD
 +	br_multicast_mark_router(br, port);
++=======
+ 	spin_lock(&br->multicast_lock);
+ 	br_ip6_multicast_mark_router(br, port);
+ 	spin_unlock(&br->multicast_lock);
++>>>>>>> 000b7287b675 (net: bridge: multicast: fix MRD advertisement router port marking race)
  }
  
  static int br_multicast_ipv6_rcv(struct net_bridge *br,
* Unmerged path net/bridge/br_multicast.c
