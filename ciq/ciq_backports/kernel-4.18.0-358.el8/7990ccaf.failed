ima: Fix the error code for restoring the PCR value

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-358.el8
commit-author Li Huafei <lihuafei1@huawei.com>
commit 7990ccafaa37dc6d8bb095d4d7cd997e8903fd10
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-358.el8/7990ccaf.failed

In ima_restore_measurement_list(), hdr[HDR_PCR].data is pointing to a
buffer of type u8, which contains the dumped 32-bit pcr value.
Currently, only the least significant byte is used to restore the pcr
value. We should convert hdr[HDR_PCR].data to a pointer of type u32
before fetching the value to restore the correct pcr value.

Fixes: 47fdee60b47f ("ima: use ima_parse_buf() to parse measurements headers")
	Signed-off-by: Li Huafei <lihuafei1@huawei.com>
	Reviewed-by: Roberto Sassu <roberto.sassu@huawei.com>
	Signed-off-by: Mimi Zohar <zohar@linux.ibm.com>
(cherry picked from commit 7990ccafaa37dc6d8bb095d4d7cd997e8903fd10)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	security/integrity/ima/ima_template.c
diff --cc security/integrity/ima/ima_template.c
index e0a5324af51f,4e081e650047..000000000000
--- a/security/integrity/ima/ima_template.c
+++ b/security/integrity/ima/ima_template.c
@@@ -451,10 -483,19 +451,26 @@@ int ima_restore_measurement_list(loff_
  		if (ret < 0)
  			break;
  
++<<<<<<< HEAD
 +		memcpy(entry->digest, hdr[HDR_DIGEST].data,
 +		       hdr[HDR_DIGEST].len);
 +		entry->pcr = !ima_canonical_fmt ? *(hdr[HDR_PCR].data) :
 +			     le32_to_cpu(*(hdr[HDR_PCR].data));
++=======
+ 		if (memcmp(hdr[HDR_DIGEST].data, zero, sizeof(zero))) {
+ 			ret = ima_calc_field_array_hash(
+ 						&entry->template_data[0],
+ 						entry);
+ 			if (ret < 0) {
+ 				pr_err("cannot calculate template digest\n");
+ 				ret = -EINVAL;
+ 				break;
+ 			}
+ 		}
+ 
+ 		entry->pcr = !ima_canonical_fmt ? *(u32 *)(hdr[HDR_PCR].data) :
+ 			     le32_to_cpu(*(u32 *)(hdr[HDR_PCR].data));
++>>>>>>> 7990ccafaa37 (ima: Fix the error code for restoring the PCR value)
  		ret = ima_restore_measurement_entry(entry);
  		if (ret < 0)
  			break;
* Unmerged path security/integrity/ima/ima_template.c
