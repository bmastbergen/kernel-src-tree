KVM: SVM: avoid refreshing avic if its state didn't change

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-358.el8
commit-author Maxim Levitsky <mlevitsk@redhat.com>
commit 06ef813466c63ff1a61b5f99592e58d049c2c1ac
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-358.el8/06ef8134.failed

Since AVIC can be inhibited and uninhibited rapidly it is possible that
we have nothing to do by the time the svm_refresh_apicv_exec_ctrl
is called.

Detect and avoid this, which will be useful when we will start calling
avic_vcpu_load/avic_vcpu_put when the avic inhibition state changes.

	Signed-off-by: Maxim Levitsky <mlevitsk@redhat.com>
Message-Id: <20210810205251.424103-14-mlevitsk@redhat.com>
	Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
(cherry picked from commit 06ef813466c63ff1a61b5f99592e58d049c2c1ac)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kvm/x86.c
diff --cc arch/x86/kvm/x86.c
index d169febd772a,bf8cb1021d11..000000000000
--- a/arch/x86/kvm/x86.c
+++ b/arch/x86/kvm/x86.c
@@@ -9077,7 -9244,13 +9079,17 @@@ void kvm_vcpu_update_apicv(struct kvm_v
  	if (!lapic_in_kernel(vcpu))
  		return;
  
++<<<<<<< HEAD
 +	vcpu->arch.apicv_active = kvm_apicv_activated(vcpu->kvm);
++=======
+ 	mutex_lock(&vcpu->kvm->arch.apicv_update_lock);
+ 
+ 	activate = kvm_apicv_activated(vcpu->kvm);
+ 	if (vcpu->arch.apicv_active == activate)
+ 		goto out;
+ 
+ 	vcpu->arch.apicv_active = activate;
++>>>>>>> 06ef813466c6 (KVM: SVM: avoid refreshing avic if its state didn't change)
  	kvm_apic_update_apicv(vcpu);
  	static_call(kvm_x86_refresh_apicv_exec_ctrl)(vcpu);
  
@@@ -9089,6 -9262,9 +9101,12 @@@
  	 */
  	if (!vcpu->arch.apicv_active)
  		kvm_make_request(KVM_REQ_EVENT, vcpu);
++<<<<<<< HEAD
++=======
+ 
+ out:
+ 	mutex_unlock(&vcpu->kvm->arch.apicv_update_lock);
++>>>>>>> 06ef813466c6 (KVM: SVM: avoid refreshing avic if its state didn't change)
  }
  EXPORT_SYMBOL_GPL(kvm_vcpu_update_apicv);
  
* Unmerged path arch/x86/kvm/x86.c
