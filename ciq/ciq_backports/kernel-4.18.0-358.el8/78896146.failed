ARM: psci: cpuidle: Enable PSCI CPUidle driver

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-358.el8
commit-author Lorenzo Pieralisi <lorenzo.pieralisi@arm.com>
commit 788961462f3471617749edf10d0fcafad410d2bb
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-358.el8/78896146.failed

Allow selection of the PSCI CPUidle in the kernel by updating
the respective Kconfig entry.

Remove PSCI callbacks from ARM/ARM64 generic CPU ops
to prevent the PSCI idle driver from clashing with the generic
ARM CPUidle driver initialization, that relies on CPU ops
to initialize and enter idle states.

	Signed-off-by: Lorenzo Pieralisi <lorenzo.pieralisi@arm.com>
	Reviewed-by: Ulf Hansson <ulf.hansson@linaro.org>
	Cc: Will Deacon <will@kernel.org>
	Cc: Ulf Hansson <ulf.hansson@linaro.org>
	Cc: Sudeep Holla <sudeep.holla@arm.com>
	Cc: Daniel Lezcano <daniel.lezcano@linaro.org>
	Cc: Catalin Marinas <catalin.marinas@arm.com>
	Cc: Mark Rutland <mark.rutland@arm.com>
	Cc: "Rafael J. Wysocki" <rjw@rjwysocki.net>
	Signed-off-by: Will Deacon <will@kernel.org>
(cherry picked from commit 788961462f3471617749edf10d0fcafad410d2bb)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/cpuidle/Kconfig.arm
diff --cc drivers/cpuidle/Kconfig.arm
index f52144808455,d8530475493c..000000000000
--- a/drivers/cpuidle/Kconfig.arm
+++ b/drivers/cpuidle/Kconfig.arm
@@@ -12,6 -13,16 +12,19 @@@ config ARM_CPUIDL
            initialized by calling the CPU operations init idle hook
            provided by architecture code.
  
++<<<<<<< HEAD
++=======
+ config ARM_PSCI_CPUIDLE
+ 	bool "PSCI CPU idle Driver"
+ 	depends on ARM_PSCI_FW
+ 	select DT_IDLE_STATES
+ 	select CPU_IDLE_MULTIPLE_DRIVERS
+ 	help
+ 	  Select this to enable PSCI firmware based CPUidle driver for ARM.
+ 	  It provides an idle driver that is capable of detecting and
+ 	  managing idle states through the PSCI firmware interface.
+ 
++>>>>>>> 788961462f34 (ARM: psci: cpuidle: Enable PSCI CPUidle driver)
  config ARM_BIG_LITTLE_CPUIDLE
  	bool "Support for ARM big.LITTLE processors"
  	depends on ARCH_VEXPRESS_TC2_PM || ARCH_EXYNOS
diff --git a/arch/arm64/kernel/cpuidle.c b/arch/arm64/kernel/cpuidle.c
index f2d13810daa8..4ead47093bd1 100644
--- a/arch/arm64/kernel/cpuidle.c
+++ b/arch/arm64/kernel/cpuidle.c
@@ -14,6 +14,7 @@
 #include <linux/cpu_pm.h>
 #include <linux/of.h>
 #include <linux/of_device.h>
+#include <linux/psci.h>
 
 #include <asm/cpuidle.h>
 #include <asm/cpu_ops.h>
@@ -51,15 +52,15 @@ int arm_cpuidle_suspend(int index)
 
 int acpi_processor_ffh_lpi_probe(unsigned int cpu)
 {
-	return arm_cpuidle_init(cpu);
+	return psci_cpu_init_idle(cpu);
 }
 
 int acpi_processor_ffh_lpi_enter(struct acpi_lpi_state *lpi)
 {
 	if (ARM64_LPI_IS_RETENTION_STATE(lpi->arch_flags))
-		return CPU_PM_CPU_IDLE_ENTER_RETENTION(arm_cpuidle_suspend,
+		return CPU_PM_CPU_IDLE_ENTER_RETENTION(psci_cpu_suspend_enter,
 						lpi->index);
 	else
-		return CPU_PM_CPU_IDLE_ENTER(arm_cpuidle_suspend, lpi->index);
+		return CPU_PM_CPU_IDLE_ENTER(psci_cpu_suspend_enter, lpi->index);
 }
 #endif
diff --git a/arch/arm64/kernel/psci.c b/arch/arm64/kernel/psci.c
index 8cdaf25e99cd..391c14fa33e2 100644
--- a/arch/arm64/kernel/psci.c
+++ b/arch/arm64/kernel/psci.c
@@ -112,10 +112,6 @@ static int cpu_psci_cpu_kill(unsigned int cpu)
 
 const struct cpu_operations cpu_psci_ops = {
 	.name		= "psci",
-#ifdef CONFIG_CPU_IDLE
-	.cpu_init_idle	= psci_cpu_init_idle,
-	.cpu_suspend	= psci_cpu_suspend_enter,
-#endif
 	.cpu_init	= cpu_psci_cpu_init,
 	.cpu_prepare	= cpu_psci_cpu_prepare,
 	.cpu_boot	= cpu_psci_cpu_boot,
* Unmerged path drivers/cpuidle/Kconfig.arm
diff --git a/drivers/firmware/psci/psci.c b/drivers/firmware/psci/psci.c
index 7bc0e701fe65..cd8f2ee1179c 100644
--- a/drivers/firmware/psci/psci.c
+++ b/drivers/firmware/psci/psci.c
@@ -458,16 +458,6 @@ int psci_cpu_suspend_enter(unsigned long index)
 
 	return ret;
 }
-
-/* ARM specific CPU idle operations */
-#ifdef CONFIG_ARM
-static const struct cpuidle_ops psci_cpuidle_ops __initconst = {
-	.suspend = psci_cpu_suspend_enter,
-	.init = psci_dt_cpu_init_idle,
-};
-
-CPUIDLE_METHOD_OF_DECLARE(psci, "psci", &psci_cpuidle_ops);
-#endif
 #endif
 
 static int psci_system_suspend(unsigned long unused)
