net: bridge: multicast: fix PIM hello router port marking race

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-358.el8
commit-author Nikolay Aleksandrov <nikolay@nvidia.com>
commit 04bef83a3358946bfc98a5ecebd1b0003d83d882
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-358.el8/04bef83a.failed

When a PIM hello packet is received on a bridge port with multicast
snooping enabled, we mark it as a router port automatically, that
includes adding that port the router port list. The multicast lock
protects that list, but it is not acquired in the PIM message case
leading to a race condition, we need to take it to fix the race.

	Cc: stable@vger.kernel.org
Fixes: 91b02d3d133b ("bridge: mcast: add router port on PIM hello message")
	Signed-off-by: Nikolay Aleksandrov <nikolay@nvidia.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 04bef83a3358946bfc98a5ecebd1b0003d83d882)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/bridge/br_multicast.c
diff --cc net/bridge/br_multicast.c
index def6f1840985,3bbbc6d7b7c3..000000000000
--- a/net/bridge/br_multicast.c
+++ b/net/bridge/br_multicast.c
@@@ -2592,7 -3264,9 +2592,13 @@@ static void br_multicast_pim(struct net
  	    pim_hdr_type(pimhdr) != PIM_TYPE_HELLO)
  		return;
  
++<<<<<<< HEAD
 +	br_multicast_mark_router(br, port);
++=======
+ 	spin_lock(&br->multicast_lock);
+ 	br_ip4_multicast_mark_router(br, port);
+ 	spin_unlock(&br->multicast_lock);
++>>>>>>> 04bef83a3358 (net: bridge: multicast: fix PIM hello router port marking race)
  }
  
  static int br_ip4_multicast_mrd_rcv(struct net_bridge *br,
* Unmerged path net/bridge/br_multicast.c
