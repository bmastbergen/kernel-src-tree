netfilter: nf_conntrack: provide modparam to always register conntrack hooks

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-358.el8
commit-author Pablo Neira Ayuso <pablo@netfilter.org>
commit ba3fbe663635ae7b33a2d972c5d2def036258e42
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-358.el8/ba3fbe66.failed

The connection tracking hooks can be optionally registered per netns
when conntrack is specifically invoked from the ruleset since
0c66dc1ea3f0 ("netfilter: conntrack: register hooks in netns when needed
by ruleset"). Then, since 4d3a57f23dec ("netfilter: conntrack: do not
enable connection tracking unless needed"), the default behaviour is
changed to always register them on demand.

This patch provides a toggle that allows users to always register them.
Without this toggle, in order to use conntrack for statistics
collection, you need a dummy rule that refers to conntrack, eg.

        iptables -I INPUT -m state --state NEW

This patch allows users to restore the original behaviour via modparam,
ie. always register connection tracking, eg.

        modprobe nf_conntrack enable_hooks=1

Hence, no dummy rule is required.

	Reported-by: Laura Garcia <nevola@gmail.com>
	Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
(cherry picked from commit ba3fbe663635ae7b33a2d972c5d2def036258e42)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/netfilter/nf_conntrack_standalone.c
diff --cc net/netfilter/nf_conntrack_standalone.c
index 7124e0586e2f,8928a4d0933e..000000000000
--- a/net/netfilter/nf_conntrack_standalone.c
+++ b/net/netfilter/nf_conntrack_standalone.c
@@@ -639,15 -1102,21 +652,27 @@@ static int nf_conntrack_pernet_init(str
  	if (ret < 0)
  		goto out_proc;
  
 -	ret = nf_conntrack_init_net(net);
 +	net->ct.sysctl_checksum = 1;
 +	net->ct.sysctl_log_invalid = 0;
 +	ret = nf_conntrack_standalone_init_sysctl(net);
  	if (ret < 0)
 -		goto out_init_net;
 +		goto out_sysctl;
  
+ 	if (enable_hooks) {
+ 		ret = nf_ct_netns_get(net, NFPROTO_INET);
+ 		if (ret < 0)
+ 			goto out_hooks;
+ 	}
+ 
  	return 0;
  
++<<<<<<< HEAD
 +out_sysctl:
++=======
+ out_hooks:
+ 	nf_conntrack_fini_net(net);
+ out_init_net:
++>>>>>>> ba3fbe663635 (netfilter: nf_conntrack: provide modparam to always register conntrack hooks)
  	nf_conntrack_standalone_fini_proc(net);
  out_proc:
  	nf_conntrack_cleanup_net(net);
* Unmerged path net/netfilter/nf_conntrack_standalone.c
