early init: fix error handling when opening /dev/console

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-358.el8
commit-author Linus Torvalds <torvalds@linux-foundation.org>
commit 2d3145f8d2809592ef803a30c8a342b5a9e2de9a
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-358.el8/2d3145f8.failed

The comment says "this should never fail", but it definitely can fail
when you have odd initial boot filesystems, or kernel configurations.

So get the error handling right: filp_open() returns an error pointer.

	Reported-by: Jesse Barnes <jsbarnes@google.com>
	Reported-by: youling 257 <youling257@gmail.com>
Fixes: 8243186f0cc7 ("fs: remove ksys_dup()")
	Cc: Dominik Brodowski <linux@dominikbrodowski.net>
	Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
(cherry picked from commit 2d3145f8d2809592ef803a30c8a342b5a9e2de9a)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	init/main.c
diff --cc init/main.c
index 611835c17a39,1ecfd43ed464..000000000000
--- a/init/main.c
+++ b/init/main.c
@@@ -1121,13 -1158,26 +1121,33 @@@ static int __ref kernel_init(void *unus
  
  void console_on_rootfs(void)
  {
 -	struct file *file;
 -	unsigned int i;
 -
 +	/* Open the /dev/console as stdin, this should never fail */
 +	if (ksys_open((const char __user *) "/dev/console", O_RDWR, 0) < 0)
 +		pr_err("Warning: unable to open an initial console.\n");
 +
++<<<<<<< HEAD
 +	/* create stdout/stderr */
 +	(void) ksys_dup(0);
 +	(void) ksys_dup(0);
++=======
+ 	/* Open /dev/console in kernelspace, this should never fail */
+ 	file = filp_open("/dev/console", O_RDWR, 0);
+ 	if (IS_ERR(file))
+ 		goto err_out;
+ 
+ 	/* create stdin/stdout/stderr, this should never fail */
+ 	for (i = 0; i < 3; i++) {
+ 		if (f_dupfd(i, file, 0) != i)
+ 			goto err_out;
+ 	}
+ 
+ 	return;
+ 
+ err_out:
+ 	/* no panic -- this might not be fatal */
+ 	pr_err("Warning: unable to open an initial console.\n");
+ 	return;
++>>>>>>> 2d3145f8d280 (early init: fix error handling when opening /dev/console)
  }
  
  static noinline void __init kernel_init_freeable(void)
* Unmerged path init/main.c
