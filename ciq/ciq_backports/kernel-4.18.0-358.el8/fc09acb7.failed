scsi: scsi_debug: Fix cmd_per_lun, set to max_queue

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-358.el8
commit-author Douglas Gilbert <dgilbert@interlog.com>
commit fc09acb7de31badb2ea9e85d21e071be1a5736e4
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-358.el8/fc09acb7.failed

Make sure that the cmd_per_lun value placed in the host template never
exceeds the can_queue value. If the max_queue driver parameter is not
specified then both cmd_per_lun and can_queue are set to CAN_QUEUE.
CAN_QUEUE is a compile time constant and is used to dimension an array to
hold queued requests. If the max_queue driver parameter is given it is must
be less than or equal to CAN_QUEUE and if so, the host template values are
adjusted.

Remove undocumented code that allowed queue_depth to exceed CAN_QUEUE and
cause stack full type errors. There is a documented way to do that with
every_nth and

    echo 0x8000 > /sys/bus/pseudo/drivers/scsi_debug/opts

See: https://sg.danny.cz/sg/scsi_debug.html

Tweak some formatting, and add a suggestion to the "trim poll_queues"
warning.

Link: https://lore.kernel.org/r/20210415015031.607153-1-dgilbert@interlog.com
	Reported-by: Kashyap Desai <kashyap.desai@broadcom.com>
	Reviewed-by: John Garry <john.garry@hauwei.com>
	Signed-off-by: Douglas Gilbert <dgilbert@interlog.com>
	Signed-off-by: John Garry <john.garry@huawei.com>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit fc09acb7de31badb2ea9e85d21e071be1a5736e4)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/scsi_debug.c
diff --cc drivers/scsi/scsi_debug.c
index 6b348700fb44,a5d1633b5bd8..000000000000
--- a/drivers/scsi/scsi_debug.c
+++ b/drivers/scsi/scsi_debug.c
@@@ -7489,8 -7561,10 +7492,15 @@@ static int sdebug_driver_probe(struct d
  	sdbg_host = to_sdebug_host(dev);
  
  	sdebug_driver_template.can_queue = sdebug_max_queue;
++<<<<<<< HEAD
 +	if (sdebug_clustering)
 +		sdebug_driver_template.use_clustering = ENABLE_CLUSTERING;
++=======
+ 	sdebug_driver_template.cmd_per_lun = sdebug_max_queue;
+ 	if (!sdebug_clustering)
+ 		sdebug_driver_template.dma_boundary = PAGE_SIZE - 1;
+ 
++>>>>>>> fc09acb7de31 (scsi: scsi_debug: Fix cmd_per_lun, set to max_queue)
  	hpnt = scsi_host_alloc(&sdebug_driver_template, sizeof(sdbg_host));
  	if (NULL == hpnt) {
  		pr_err("scsi_host_alloc failed\n");
* Unmerged path drivers/scsi/scsi_debug.c
