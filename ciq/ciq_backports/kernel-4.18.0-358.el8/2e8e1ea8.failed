arm64: Use v8.5-RNG entropy for KASLR seed

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-358.el8
commit-author Mark Brown <broonie@kernel.org>
commit 2e8e1ea88cbcb19a77b7acb67f6ffe39cc15740c
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-358.el8/2e8e1ea8.failed

When seeding KALSR on a system where we have architecture level random
number generation make use of that entropy, mixing it in with the seed
passed by the bootloader. Since this is run very early in init before
feature detection is complete we open code rather than use archrandom.h.

	Signed-off-by: Mark Brown <broonie@kernel.org>
	Reviewed-by: Mark Rutland <mark.rutland@arm.com>
	Reviewed-by: Ard Biesheuvel <ardb@kernel.org>
	Signed-off-by: Will Deacon <will@kernel.org>
(cherry picked from commit 2e8e1ea88cbcb19a77b7acb67f6ffe39cc15740c)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/arm64/kernel/kaslr.c
diff --cc arch/arm64/kernel/kaslr.c
index a3b053f0f5b8,53b8a4ee64ff..000000000000
--- a/arch/arm64/kernel/kaslr.c
+++ b/arch/arm64/kernel/kaslr.c
@@@ -114,8 -115,26 +114,28 @@@ u64 __init kaslr_early_init(u64 dt_phys
  	 */
  	cmdline = kaslr_get_cmdline(fdt);
  	str = strstr(cmdline, "nokaslr");
 -	if (str == cmdline || (str > cmdline && *(str - 1) == ' ')) {
 -		kaslr_status = KASLR_DISABLED_CMDLINE;
 +	if (str == cmdline || (str > cmdline && *(str - 1) == ' '))
  		return 0;
++<<<<<<< HEAD
++=======
+ 	}
+ 
+ 	/*
+ 	 * Mix in any entropy obtainable architecturally, open coded
+ 	 * since this runs extremely early.
+ 	 */
+ 	if (__early_cpu_has_rndr()) {
+ 		unsigned long raw;
+ 
+ 		if (__arm64_rndr(&raw))
+ 			seed ^= raw;
+ 	}
+ 
+ 	if (!seed) {
+ 		kaslr_status = KASLR_DISABLED_NO_SEED;
+ 		return 0;
+ 	}
++>>>>>>> 2e8e1ea88cbc (arm64: Use v8.5-RNG entropy for KASLR seed)
  
  	/*
  	 * OK, so we are proceeding with KASLR enabled. Calculate a suitable
diff --git a/arch/arm64/include/asm/archrandom.h b/arch/arm64/include/asm/archrandom.h
index 5ea5a1ce5a5f..3fe02da70004 100644
--- a/arch/arm64/include/asm/archrandom.h
+++ b/arch/arm64/include/asm/archrandom.h
@@ -59,9 +59,17 @@ static inline bool __must_check arch_get_random_seed_int(unsigned int *v)
 	return ok;
 }
 
+static inline bool __init __early_cpu_has_rndr(void)
+{
+	/* Open code as we run prior to the first call to cpufeature. */
+	unsigned long ftr = read_sysreg_s(SYS_ID_AA64ISAR0_EL1);
+	return (ftr >> ID_AA64ISAR0_RNDR_SHIFT) & 0xf;
+}
+
 #else
 
 static inline bool __arm64_rndr(unsigned long *v) { return false; }
+static inline bool __init __early_cpu_has_rndr(void) { return false; }
 
 #endif /* CONFIG_ARCH_RANDOM */
 #endif /* _ASM_ARCHRANDOM_H */
* Unmerged path arch/arm64/kernel/kaslr.c
