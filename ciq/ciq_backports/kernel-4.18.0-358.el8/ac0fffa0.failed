RDMA/core: Set sgtable nents when using ib_dma_virt_map_sg()

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-358.el8
commit-author Logan Gunthorpe <logang@deltatee.com>
commit ac0fffa0859b8e1e991939663b3ebdd80bf979e6
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-358.el8/ac0fffa0.failed

ib_dma_map_sgtable_attrs() should be mapping the sgls and setting nents
but the ib_uses_virt_dma() path falls back to ib_dma_virt_map_sg() which
will not set the nents in the sgtable.

Check the return value (per the map_sg calling convention) and set
sgt->nents appropriately on success.

Fixes: 79fbd3e1241c ("RDMA: Use the sg_table directly and remove the opencoded version from umem")
Link: https://lore.kernel.org/r/20211013165942.89806-1-logang@deltatee.com
	Reported-by: Bart Van Assche <bvanassche@acm.org>
	Signed-off-by: Logan Gunthorpe <logang@deltatee.com>
	Tested-by: Bart Van Assche <bvanassche@acm.org>
	Signed-off-by: Jason Gunthorpe <jgg@nvidia.com>
(cherry picked from commit ac0fffa0859b8e1e991939663b3ebdd80bf979e6)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	include/rdma/ib_verbs.h
diff --cc include/rdma/ib_verbs.h
index bfcbec0959ce,61c73adccbbd..000000000000
--- a/include/rdma/ib_verbs.h
+++ b/include/rdma/ib_verbs.h
@@@ -4046,6 -4094,39 +4046,42 @@@ static inline void ib_dma_unmap_sg_attr
  }
  
  /**
++<<<<<<< HEAD
++=======
+  * ib_dma_map_sgtable_attrs - Map a scatter/gather table to DMA addresses
+  * @dev: The device for which the DMA addresses are to be created
+  * @sg: The sg_table object describing the buffer
+  * @direction: The direction of the DMA
+  * @attrs: Optional DMA attributes for the map operation
+  */
+ static inline int ib_dma_map_sgtable_attrs(struct ib_device *dev,
+ 					   struct sg_table *sgt,
+ 					   enum dma_data_direction direction,
+ 					   unsigned long dma_attrs)
+ {
+ 	int nents;
+ 
+ 	if (ib_uses_virt_dma(dev)) {
+ 		nents = ib_dma_virt_map_sg(dev, sgt->sgl, sgt->orig_nents);
+ 		if (!nents)
+ 			return -EIO;
+ 		sgt->nents = nents;
+ 		return 0;
+ 	}
+ 	return dma_map_sgtable(dev->dma_device, sgt, direction, dma_attrs);
+ }
+ 
+ static inline void ib_dma_unmap_sgtable_attrs(struct ib_device *dev,
+ 					      struct sg_table *sgt,
+ 					      enum dma_data_direction direction,
+ 					      unsigned long dma_attrs)
+ {
+ 	if (!ib_uses_virt_dma(dev))
+ 		dma_unmap_sgtable(dev->dma_device, sgt, direction, dma_attrs);
+ }
+ 
+ /**
++>>>>>>> ac0fffa0859b (RDMA/core: Set sgtable nents when using ib_dma_virt_map_sg())
   * ib_dma_map_sg - Map a scatter/gather list to DMA addresses
   * @dev: The device for which the DMA addresses are to be created
   * @sg: The array of scatter/gather entries
* Unmerged path include/rdma/ib_verbs.h
