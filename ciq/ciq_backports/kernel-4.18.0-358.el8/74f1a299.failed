Revert "fs: remove ksys_dup()"

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-358.el8
commit-author Dominik Brodowski <linux@dominikbrodowski.net>
commit 74f1a299107b9e1a563831a4ba85f769ab577164
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-358.el8/74f1a299.failed

This reverts commit 8243186f0cc7 ("fs: remove ksys_dup()") and the
subsequent fix for it in commit 2d3145f8d280 ("early init: fix error
handling when opening /dev/console").

Trying to use filp_open() and f_dupfd() instead of pseudo-syscalls
caused more trouble than what is worth it: it requires accessing vfs
internals and it turns out there were other bugs in it too.

In particular, the file reference counting was wrong - because unlike
the original "open+2*dup" sequence it used "filp_open+3*f_dupfd" and
thus had an extra leaked file reference.

That in turn then caused odd problems with Androidx86 long after boot
becaue of how the extra reference to the console kept the session active
even after all file descriptors had been closed.

	Reported-by: youling 257 <youling257@gmail.com>
	Cc: Arvind Sankar <nivedita@alum.mit.edu>
	Cc: Al Viro <viro@zeniv.linux.org.uk>
	Signed-off-by: Dominik Brodowski <linux@dominikbrodowski.net>
	Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
(cherry picked from commit 74f1a299107b9e1a563831a4ba85f769ab577164)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	init/main.c
diff --cc init/main.c
index 611835c17a39,2cd736059416..000000000000
--- a/init/main.c
+++ b/init/main.c
@@@ -94,7 -93,6 +94,10 @@@
  #include <linux/rodata_test.h>
  #include <linux/jump_label.h>
  #include <linux/mem_encrypt.h>
++<<<<<<< HEAD
 +#include <linux/kcsan.h>
++=======
++>>>>>>> 74f1a299107b (Revert "fs: remove ksys_dup()")
  
  #include <asm/io.h>
  #include <asm/bugs.h>
* Unmerged path init/main.c
