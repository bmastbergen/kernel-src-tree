KVM: selftests: Introduce x2APIC register manipulation functions

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-358.el8
commit-author Jim Mattson <jmattson@google.com>
commit 768d134d8cb4cb595966d8c509a9329a075a5fa2
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-358.el8/768d134d.failed

Standardize reads and writes of the x2APIC MSRs.

	Signed-off-by: Jim Mattson <jmattson@google.com>
	Reviewed-by: Oliver Upton <oupton@google.com>
Message-Id: <20210604172611.281819-11-jmattson@google.com>
	Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
(cherry picked from commit 768d134d8cb4cb595966d8c509a9329a075a5fa2)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/testing/selftests/kvm/include/x86_64/apic.h
#	tools/testing/selftests/kvm/lib/x86_64/apic.c
diff --cc tools/testing/selftests/kvm/include/x86_64/apic.h
index 0d0e35c8866b,0be4757f1f20..000000000000
--- a/tools/testing/selftests/kvm/include/x86_64/apic.h
+++ b/tools/testing/selftests/kvm/include/x86_64/apic.h
@@@ -55,4 -59,33 +55,36 @@@
  #define	APIC_ICR2	0x310
  #define		SET_APIC_DEST_FIELD(x)	((x) << 24)
  
++<<<<<<< HEAD
++=======
+ void apic_disable(void);
+ void xapic_enable(void);
+ void x2apic_enable(void);
+ 
+ static inline uint32_t get_bsp_flag(void)
+ {
+ 	return rdmsr(MSR_IA32_APICBASE) & MSR_IA32_APICBASE_BSP;
+ }
+ 
+ static inline uint32_t xapic_read_reg(unsigned int reg)
+ {
+ 	return ((volatile uint32_t *)APIC_DEFAULT_GPA)[reg >> 2];
+ }
+ 
+ static inline void xapic_write_reg(unsigned int reg, uint32_t val)
+ {
+ 	((volatile uint32_t *)APIC_DEFAULT_GPA)[reg >> 2] = val;
+ }
+ 
+ static inline uint64_t x2apic_read_reg(unsigned int reg)
+ {
+ 	return rdmsr(APIC_BASE_MSR + (reg >> 4));
+ }
+ 
+ static inline void x2apic_write_reg(unsigned int reg, uint64_t value)
+ {
+ 	wrmsr(APIC_BASE_MSR + (reg >> 4), value);
+ }
+ 
++>>>>>>> 768d134d8cb4 (KVM: selftests: Introduce x2APIC register manipulation functions)
  #endif /* SELFTEST_KVM_APIC_H */
* Unmerged path tools/testing/selftests/kvm/lib/x86_64/apic.c
* Unmerged path tools/testing/selftests/kvm/include/x86_64/apic.h
* Unmerged path tools/testing/selftests/kvm/lib/x86_64/apic.c
diff --git a/tools/testing/selftests/kvm/x86_64/smm_test.c b/tools/testing/selftests/kvm/x86_64/smm_test.c
index e189af092ad1..d0fe2fdce58c 100644
--- a/tools/testing/selftests/kvm/x86_64/smm_test.c
+++ b/tools/testing/selftests/kvm/x86_64/smm_test.c
@@ -55,8 +55,8 @@ static inline void sync_with_host(uint64_t phase)
 
 static void self_smi(void)
 {
-	wrmsr(APIC_BASE_MSR + (APIC_ICR >> 4),
-	      APIC_DEST_SELF | APIC_INT_ASSERT | APIC_DM_SMI);
+	x2apic_write_reg(APIC_ICR,
+			 APIC_DEST_SELF | APIC_INT_ASSERT | APIC_DM_SMI);
 }
 
 static void l2_guest_code(void)
