KVM: nVMX: Consolidate VM-Enter/VM-Exit TLB flush and MMU sync logic

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-358.el8
commit-author Sean Christopherson <seanjc@google.com>
commit 50a417962a80525da54fa74105bcf17b479cd4bc
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-358.el8/50a41796.failed

Drop the dedicated nested_vmx_transition_mmu_sync() now that the MMU sync
is handled via KVM_REQ_TLB_FLUSH_GUEST, and fold that flush into the
all-encompassing nested_vmx_transition_tlb_flush().

Opportunistically add a comment explaning why nested EPT never needs to
sync the MMU on VM-Enter.

	Signed-off-by: Sean Christopherson <seanjc@google.com>
Message-Id: <20210609234235.1244004-9-seanjc@google.com>
	Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
(cherry picked from commit 50a417962a80525da54fa74105bcf17b479cd4bc)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kvm/vmx/nested.c
diff --cc arch/x86/kvm/vmx/nested.c
index 0561abd324b4,8e2487f21a6f..000000000000
--- a/arch/x86/kvm/vmx/nested.c
+++ b/arch/x86/kvm/vmx/nested.c
@@@ -1129,21 -1087,8 +1087,17 @@@ static int nested_vmx_load_cr3(struct k
  		return -EINVAL;
  	}
  
++<<<<<<< HEAD
 +	/*
 +	 * Unconditionally skip the TLB flush on fast CR3 switch, all TLB
 +	 * flushes are handled by nested_vmx_transition_tlb_flush().
 +	 */
 +	if (!nested_ept) {
 +		kvm_mmu_new_pgd(vcpu, cr3, true, true);
- 
- 		/*
- 		 * A TLB flush on VM-Enter/VM-Exit flushes all linear mappings
- 		 * across all PCIDs, i.e. all PGDs need to be synchronized.
- 		 * See nested_vmx_transition_mmu_sync() for more details.
- 		 */
- 		if (nested_vmx_transition_mmu_sync(vcpu))
- 			kvm_make_request(KVM_REQ_TLB_FLUSH_GUEST, vcpu);
- 	}
++=======
+ 	if (!nested_ept)
+ 		kvm_mmu_new_pgd(vcpu, cr3);
++>>>>>>> 50a417962a80 (KVM: nVMX: Consolidate VM-Enter/VM-Exit TLB flush and MMU sync logic)
  
  	vcpu->arch.cr3 = cr3;
  	kvm_register_mark_available(vcpu, VCPU_EXREG_CR3);
* Unmerged path arch/x86/kvm/vmx/nested.c
