net/l2tp: Fix reference count leak in l2tp_udp_recv_core

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-358.el8
commit-author Xiyu Yang <xiyuyang19@fudan.edu.cn>
commit 9b6ff7eb666415e1558f1ba8a742f5db6a9954de
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-358.el8/9b6ff7eb.failed

The reference count leak issue may take place in an error handling
path. If both conditions of tunnel->version == L2TP_HDR_VER_3 and the
return value of l2tp_v3_ensure_opt_in_linear is nonzero, the function
would directly jump to label invalid, without decrementing the reference
count of the l2tp_session object session increased earlier by
l2tp_tunnel_get_session(). This may result in refcount leaks.

Fix this issue by decrease the reference count before jumping to the
label invalid.

Fixes: 4522a70db7aa ("l2tp: fix reading optional fields of L2TPv3")
	Signed-off-by: Xiyu Yang <xiyuyang19@fudan.edu.cn>
	Signed-off-by: Xin Xiong <xiongx18@fudan.edu.cn>
	Signed-off-by: Xin Tan <tanxin.ctf@gmail.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 9b6ff7eb666415e1558f1ba8a742f5db6a9954de)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/l2tp/l2tp_core.c
diff --cc net/l2tp/l2tp_core.c
index 0d0d4a14310b,93271a2632b8..000000000000
--- a/net/l2tp/l2tp_core.c
+++ b/net/l2tp/l2tp_core.c
@@@ -890,8 -869,10 +890,15 @@@ static int l2tp_udp_recv_core(struct l2
  	}
  
  	if (tunnel->version == L2TP_HDR_VER_3 &&
++<<<<<<< HEAD
 +	    l2tp_v3_ensure_opt_in_linear(session, skb, &ptr, &optr))
 +		goto error;
++=======
+ 	    l2tp_v3_ensure_opt_in_linear(session, skb, &ptr, &optr)) {
+ 		l2tp_session_dec_refcount(session);
+ 		goto invalid;
+ 	}
++>>>>>>> 9b6ff7eb6664 (net/l2tp: Fix reference count leak in l2tp_udp_recv_core)
  
  	l2tp_recv_common(session, skb, ptr, optr, hdrflags, length);
  	l2tp_session_dec_refcount(session);
* Unmerged path net/l2tp/l2tp_core.c
