iommu/arm-smmu: Check smmu->impl pointer before dereferencing

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-358.el8
commit-author Will Deacon <will@kernel.org>
commit b472191f0a0ce6d98d61e939118cfd6ad0ff91e7
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-358.el8/b472191f.failed

Commit 0d97174aeadf ("iommu/arm-smmu: Implement ->probe_finalize()")
added a new optional ->probe_finalize callback to 'struct arm_smmu_impl'
but neglected to check that 'smmu->impl' is present prior to checking
if the new callback is present.

Add the missing check, which avoids dereferencing NULL when probing an
SMMU which doesn't require any implementation-specific callbacks:

  | Unable to handle kernel NULL pointer dereference at virtual address
  | 0000000000000070
  |
  | Call trace:
  |   arm_smmu_probe_finalize+0x14/0x48
  |   of_iommu_configure+0xe4/0x1b8
  |   of_dma_configure_id+0xf8/0x2d8
  |   pci_dma_configure+0x44/0x88
  |   really_probe+0xc0/0x3c0

Fixes: 0d97174aeadf ("iommu/arm-smmu: Implement ->probe_finalize()")
	Reported-by: Marek Szyprowski <m.szyprowski@samsung.com>
	Signed-off-by: Will Deacon <will@kernel.org>
(cherry picked from commit b472191f0a0ce6d98d61e939118cfd6ad0ff91e7)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/iommu/arm/arm-smmu/arm-smmu.c
diff --cc drivers/iommu/arm/arm-smmu/arm-smmu.c
index ec28d8f845f1,2fe73a88e500..000000000000
--- a/drivers/iommu/arm/arm-smmu/arm-smmu.c
+++ b/drivers/iommu/arm/arm-smmu/arm-smmu.c
@@@ -1457,6 -1450,18 +1457,21 @@@ static void arm_smmu_release_device(str
  	iommu_fwspec_free(dev);
  }
  
++<<<<<<< HEAD
++=======
+ static void arm_smmu_probe_finalize(struct device *dev)
+ {
+ 	struct arm_smmu_master_cfg *cfg;
+ 	struct arm_smmu_device *smmu;
+ 
+ 	cfg = dev_iommu_priv_get(dev);
+ 	smmu = cfg->smmu;
+ 
+ 	if (smmu->impl && smmu->impl->probe_finalize)
+ 		smmu->impl->probe_finalize(smmu, dev);
+ }
+ 
++>>>>>>> b472191f0a0c (iommu/arm-smmu: Check smmu->impl pointer before dereferencing)
  static struct iommu_group *arm_smmu_device_group(struct device *dev)
  {
  	struct arm_smmu_master_cfg *cfg = dev_iommu_priv_get(dev);
* Unmerged path drivers/iommu/arm/arm-smmu/arm-smmu.c
