mlxsw: spectrum_switchdev: remove transactional logic for VLAN objects

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-358.el8
commit-author Vladimir Oltean <vladimir.oltean@nxp.com>
commit 4b400fea76e13aec5a5752c1463b74df95178ced
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-358.el8/4b400fea.failed

As of commit 457e20d65924 ("mlxsw: spectrum_switchdev: Avoid returning
errors in commit phase"), the mlxsw driver performs the VLAN object
offloading during the prepare phase. So conversion just seems to be a
matter of removing the code that was running in the commit phase.

Ido Schimmel explains that the reason why mlxsw_sp_span_respin is called
unconditionally is because the bridge driver will ignore -EOPNOTSUPP and
actually add the VLAN on the bridge device - see commit 9c86ce2c1ae3
("net: bridge: Notify about bridge VLANs") and commit ea4721751977
("mlxsw: spectrum_switchdev: Ignore bridge VLAN events"). Since the VLAN
was successfully added on the bridge device, mlxsw_sp_span_respin_work()
should be able to resolve the egress port for a packet that is mirrored
to a gre tap and passes through the bridge device. Therefore keep the
logic as it is.

	Signed-off-by: Vladimir Oltean <vladimir.oltean@nxp.com>
	Acked-by: Linus Walleij <linus.walleij@linaro.org>
	Acked-by: Jiri Pirko <jiri@nvidia.com>
	Reviewed-by: Ido Schimmel <idosch@nvidia.com>
	Reviewed-by: Florian Fainelli <f.fainelli@gmail.com>
	Signed-off-by: Jakub Kicinski <kuba@kernel.org>
(cherry picked from commit 4b400fea76e13aec5a5752c1463b74df95178ced)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlxsw/spectrum_switchdev.c
diff --cc drivers/net/ethernet/mellanox/mlxsw/spectrum_switchdev.c
index 14ce372c3f85,20c4f3c2cf23..000000000000
--- a/drivers/net/ethernet/mellanox/mlxsw/spectrum_switchdev.c
+++ b/drivers/net/ethernet/mellanox/mlxsw/spectrum_switchdev.c
@@@ -1827,17 -1764,15 +1822,29 @@@ static int mlxsw_sp_port_obj_add(struc
  	switch (obj->id) {
  	case SWITCHDEV_OBJ_ID_PORT_VLAN:
  		vlan = SWITCHDEV_OBJ_PORT_VLAN(obj);
++<<<<<<< HEAD
 +		err = mlxsw_sp_port_vlans_add(mlxsw_sp_port, vlan, trans,
 +					      extack);
 +
 +		if (switchdev_trans_ph_prepare(trans)) {
 +			/* The event is emitted before the changes are actually
 +			 * applied to the bridge. Therefore schedule the respin
 +			 * call for later, so that the respin logic sees the
 +			 * updated bridge state.
 +			 */
 +			mlxsw_sp_span_respin(mlxsw_sp_port->mlxsw_sp);
 +		}
++=======
+ 
+ 		err = mlxsw_sp_port_vlans_add(mlxsw_sp_port, vlan, extack);
+ 
+ 		/* The event is emitted before the changes are actually
+ 		 * applied to the bridge. Therefore schedule the respin
+ 		 * call for later, so that the respin logic sees the
+ 		 * updated bridge state.
+ 		 */
+ 		mlxsw_sp_span_respin(mlxsw_sp_port->mlxsw_sp);
++>>>>>>> 4b400fea76e1 (mlxsw: spectrum_switchdev: remove transactional logic for VLAN objects)
  		break;
  	case SWITCHDEV_OBJ_ID_PORT_MDB:
  		err = mlxsw_sp_port_mdb_add(mlxsw_sp_port,
* Unmerged path drivers/net/ethernet/mellanox/mlxsw/spectrum_switchdev.c
