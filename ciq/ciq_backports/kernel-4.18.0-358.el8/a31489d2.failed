Bluetooth: Fix attempting to set RPA timeout when unsupported

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-358.el8
commit-author Edward Vear <edwardvear@gmail.com>
commit a31489d2a368d2f9225ed6a6f595c63bc7d10de8
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-358.el8/a31489d2.failed

During controller initialization, an LE Set RPA Timeout command is sent
to the controller if supported. However, the value checked to determine
if the command is supported is incorrect. Page 1921 of the Bluetooth
Core Spec v5.2 shows that bit 2 of octet 35 of the Supported_Commands
field corresponds to the LE Set RPA Timeout command, but currently
bit 6 of octet 35 is checked. This patch checks the correct value
instead.

This issue led to the error seen in the following btmon output during
initialization of an adapter (rtl8761b) and prevented initialization
from completing.

< HCI Command: LE Set Resolvable Private Address Timeout (0x08|0x002e) plen 2
        Timeout: 900 seconds
> HCI Event: Command Complete (0x0e) plen 4
      LE Set Resolvable Private Address Timeout (0x08|0x002e) ncmd 2
        Status: Unsupported Remote Feature / Unsupported LMP Feature (0x1a)
= Close Index: 00:E0:4C:6B:E5:03

The error did not appear when running with this patch.

	Signed-off-by: Edward Vear <edwardvear@gmail.com>
	Signed-off-by: Marcel Holtmann <marcel@holtmann.org>
	Signed-off-by: Johan Hedberg <johan.hedberg@intel.com>
(cherry picked from commit a31489d2a368d2f9225ed6a6f595c63bc7d10de8)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/bluetooth/hci_core.c
diff --cc net/bluetooth/hci_core.c
index 0693dacbf6e3,c4aa2cbb9269..000000000000
--- a/net/bluetooth/hci_core.c
+++ b/net/bluetooth/hci_core.c
@@@ -750,10 -763,12 +750,19 @@@ static int hci_init3_req(struct hci_req
  			hci_req_add(req, HCI_OP_LE_CLEAR_RESOLV_LIST, 0, NULL);
  		}
  
++<<<<<<< HEAD
 +		if (hdev->commands[34] & 0x40) {
 +			/* Read LE Resolving List Size */
 +			hci_req_add(req, HCI_OP_LE_READ_RESOLV_LIST_SIZE,
 +				    0, NULL);
++=======
+ 		if (hdev->commands[35] & 0x04) {
+ 			__le16 rpa_timeout = cpu_to_le16(hdev->rpa_timeout);
+ 
+ 			/* Set RPA timeout */
+ 			hci_req_add(req, HCI_OP_LE_SET_RPA_TIMEOUT, 2,
+ 				    &rpa_timeout);
++>>>>>>> a31489d2a368 (Bluetooth: Fix attempting to set RPA timeout when unsupported)
  		}
  
  		if (hdev->le_features[0] & HCI_LE_DATA_LEN_EXT) {
* Unmerged path net/bluetooth/hci_core.c
