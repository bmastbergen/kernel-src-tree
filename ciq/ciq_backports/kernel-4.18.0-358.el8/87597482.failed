Bluetooth: Report num supported adv instances for hw offloading

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-358.el8
commit-author Daniel Winkler <danielwinkler@google.com>
commit 87597482c68e1ea5408b25f756eb9c668b304311
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-358.el8/87597482.failed

Here we make sure we properly report the number of supported
advertising slots when we are using hardware offloading. If no
hardware offloading is available, we default this value to
HCI_MAX_ADV_INSTANCES for use in software rotation as before.

This change has been tested on kukui (no ext adv) and hatch (ext adv)
chromebooks by verifying "SupportedInstances" shows 5 (the default) and
6 (slots supported by controller), respectively.

	Signed-off-by: Daniel Winkler <danielwinkler@google.com>
	Signed-off-by: Marcel Holtmann <marcel@holtmann.org>
(cherry picked from commit 87597482c68e1ea5408b25f756eb9c668b304311)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/bluetooth/mgmt.c
diff --cc net/bluetooth/mgmt.c
index a1ee54d5d55e,e9f4ce2bbb94..000000000000
--- a/net/bluetooth/mgmt.c
+++ b/net/bluetooth/mgmt.c
@@@ -6753,7 -7443,14 +6753,18 @@@ static int add_advertising(struct sock 
  		return mgmt_cmd_status(sk, hdev->id, MGMT_OP_ADD_ADVERTISING,
  				       status);
  
++<<<<<<< HEAD
 +	if (cp->instance < 1 || cp->instance > HCI_MAX_ADV_INSTANCES)
++=======
+ 	/* Enabling the experimental LL Privay support disables support for
+ 	 * advertising.
+ 	 */
+ 	if (hci_dev_test_flag(hdev, HCI_ENABLE_LL_PRIVACY))
+ 		return mgmt_cmd_status(sk, hdev->id, MGMT_OP_SET_ADVERTISING,
+ 				       MGMT_STATUS_NOT_SUPPORTED);
+ 
+ 	if (cp->instance < 1 || cp->instance > hdev->le_num_of_adv_sets)
++>>>>>>> 87597482c68e (Bluetooth: Report num supported adv instances for hw offloading)
  		return mgmt_cmd_status(sk, hdev->id, MGMT_OP_ADD_ADVERTISING,
  				       MGMT_STATUS_INVALID_PARAMS);
  
diff --git a/net/bluetooth/hci_core.c b/net/bluetooth/hci_core.c
index 21db1b17916e..3190f8294baf 100644
--- a/net/bluetooth/hci_core.c
+++ b/net/bluetooth/hci_core.c
@@ -2953,7 +2953,7 @@ int hci_add_adv_instance(struct hci_dev *hdev, u8 instance, u32 flags,
 		       sizeof(adv_instance->scan_rsp_data));
 	} else {
 		if (hdev->adv_instance_cnt >= hdev->le_num_of_adv_sets ||
-		    instance < 1 || instance > HCI_MAX_ADV_INSTANCES)
+		    instance < 1 || instance > hdev->le_num_of_adv_sets)
 			return -EOVERFLOW;
 
 		adv_instance = kzalloc(sizeof(*adv_instance), GFP_KERNEL);
* Unmerged path net/bluetooth/mgmt.c
