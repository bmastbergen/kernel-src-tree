Bluetooth: Enable LE Enhanced Connection Complete event.

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-358.el8
commit-author Marcel Holtmann <marcel@holtmann.org>
commit ff3b8df2bd758d97aa3dd7c021864be05fec9bd5
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-358.el8/ff3b8df2.failed

In case LL Privacy is supported by the controller, it is also a good
idea to use the LE Enhanced Connection Complete event for getting all
information about the new connection and its addresses.

	Signed-off-by: Marcel Holtmann <marcel@holtmann.org>
	Signed-off-by: Johan Hedberg <johan.hedberg@intel.com>
(cherry picked from commit ff3b8df2bd758d97aa3dd7c021864be05fec9bd5)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	include/net/bluetooth/hci.h
diff --cc include/net/bluetooth/hci.h
index 956bcff9d80d,1da8cec8e210..000000000000
--- a/include/net/bluetooth/hci.h
+++ b/include/net/bluetooth/hci.h
@@@ -479,6 -460,8 +479,11 @@@ enum 
  #define HCI_LE_SLAVE_FEATURES		0x08
  #define HCI_LE_PING			0x10
  #define HCI_LE_DATA_LEN_EXT		0x20
++<<<<<<< HEAD
++=======
+ #define HCI_LE_LL_PRIVACY		0x40
+ #define HCI_LE_EXT_SCAN_POLICY		0x80
++>>>>>>> ff3b8df2bd75 (Bluetooth: Enable LE Enhanced Connection Complete event.)
  #define HCI_LE_PHY_2M			0x01
  #define HCI_LE_PHY_CODED		0x08
  #define HCI_LE_EXT_ADV			0x10
* Unmerged path include/net/bluetooth/hci.h
diff --git a/net/bluetooth/hci_core.c b/net/bluetooth/hci_core.c
index 20cf17ee6916..ccb7b2fc93ba 100644
--- a/net/bluetooth/hci_core.c
+++ b/net/bluetooth/hci_core.c
@@ -639,6 +639,14 @@ static int hci_init3_req(struct hci_request *req, unsigned long opt)
 		if (hdev->le_features[0] & HCI_LE_DATA_LEN_EXT)
 			events[0] |= 0x40;	/* LE Data Length Change */
 
+		/* If the controller supports LL Privacy feature, enable
+		 * the corresponding event.
+		 */
+		if (hdev->le_features[0] & HCI_LE_LL_PRIVACY)
+			events[1] |= 0x02;	/* LE Enhanced Connection
+						 * Complete
+						 */
+
 		/* If the controller supports Extended Scanner Filter
 		 * Policies, enable the correspondig event.
 		 */
