Bluetooth: btusb: Fix memory leak

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-358.el8
commit-author Luiz Augusto von Dentz <luiz.von.dentz@intel.com>
commit 79f4127a502c5905f04da1f20a7bbe07103fb77c
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-358.el8/79f4127a.failed

This checks if CONFIG_DEV_COREDUMP is enabled before attempting to clone
the skb and also make sure btmtk_process_coredump frees the skb passed
following the same logic.

Fixes: 0b7015132878 ("Bluetooth: btusb: mediatek: add MediaTek devcoredump support")
	Signed-off-by: Luiz Augusto von Dentz <luiz.von.dentz@intel.com>
(cherry picked from commit 79f4127a502c5905f04da1f20a7bbe07103fb77c)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/bluetooth/btmtk.c
#	drivers/bluetooth/btusb.c
diff --cc drivers/bluetooth/btusb.c
index c09b568c9e8c,f390080e56ca..000000000000
--- a/drivers/bluetooth/btusb.c
+++ b/drivers/bluetooth/btusb.c
@@@ -3868,8 -3277,37 +3868,42 @@@ static int btusb_mtk_shutdown(struct hc
  	return 0;
  }
  
++<<<<<<< HEAD
 +MODULE_FIRMWARE(FIRMWARE_MT7663);
 +MODULE_FIRMWARE(FIRMWARE_MT7668);
++=======
+ static int btusb_recv_acl_mtk(struct hci_dev *hdev, struct sk_buff *skb)
+ {
+ 	struct btusb_data *data = hci_get_drvdata(hdev);
+ 	u16 handle = le16_to_cpu(hci_acl_hdr(skb)->handle);
+ 
+ 	switch (handle) {
+ 	case 0xfc6f:		/* Firmware dump from device */
+ 		/* When the firmware hangs, the device can no longer
+ 		 * suspend and thus disable auto-suspend.
+ 		 */
+ 		usb_disable_autosuspend(data->udev);
+ 
+ 		/* We need to forward the diagnostic packet to userspace daemon
+ 		 * for backward compatibility, so we have to clone the packet
+ 		 * extraly for the in-kernel coredump support.
+ 		 */
+ 		if (IS_ENABLED(CONFIG_DEV_COREDUMP)) {
+ 			struct sk_buff *skb_cd = skb_clone(skb, GFP_ATOMIC);
+ 
+ 			if (skb_cd)
+ 				btmtk_process_coredump(hdev, skb_cd);
+ 		}
+ 
+ 		fallthrough;
+ 	case 0x05ff:		/* Firmware debug logging 1 */
+ 	case 0x05fe:		/* Firmware debug logging 2 */
+ 		return hci_recv_diag(hdev, skb);
+ 	}
+ 
+ 	return hci_recv_frame(hdev, skb);
+ }
++>>>>>>> 79f4127a502c (Bluetooth: btusb: Fix memory leak)
  
  #ifdef CONFIG_PM
  /* Configure an out-of-band gpio as wake-up pin, if specified in device tree */
* Unmerged path drivers/bluetooth/btmtk.c
* Unmerged path drivers/bluetooth/btmtk.c
* Unmerged path drivers/bluetooth/btusb.c
