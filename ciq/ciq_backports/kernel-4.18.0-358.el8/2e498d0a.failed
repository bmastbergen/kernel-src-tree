perf: Add support for event removal on exec

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-358.el8
commit-author Marco Elver <elver@google.com>
commit 2e498d0a74e5b88a6689ae1b811f247f91ff188e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-358.el8/2e498d0a.failed

Adds bit perf_event_attr::remove_on_exec, to support removing an event
from a task on exec.

This option supports the case where an event is supposed to be
process-wide only, and should not propagate beyond exec, to limit
monitoring to the original process image only.

	Suggested-by: Peter Zijlstra <peterz@infradead.org>
	Signed-off-by: Marco Elver <elver@google.com>
	Signed-off-by: Peter Zijlstra (Intel) <peterz@infradead.org>
Link: https://lkml.kernel.org/r/20210408103605.1676875-5-elver@google.com
(cherry picked from commit 2e498d0a74e5b88a6689ae1b811f247f91ff188e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	include/uapi/linux/perf_event.h
#	kernel/events/core.c
diff --cc include/uapi/linux/perf_event.h
index 1295157e261a,8c5b9f5ad63f..000000000000
--- a/include/uapi/linux/perf_event.h
+++ b/include/uapi/linux/perf_event.h
@@@ -409,10 -389,9 +409,16 @@@ struct perf_event_attr 
  				cgroup         :  1, /* include cgroup events */
  				text_poke      :  1, /* include text poke events */
  				build_id       :  1, /* use build id in mmap2 events */
++<<<<<<< HEAD
 +				__reserved_1   : 29;
 +#else
 +				__reserved_1   : 35;
 +#endif /*  __GENKSYMS__ */
++=======
+ 				inherit_thread :  1, /* children only inherit if cloned with CLONE_THREAD */
+ 				remove_on_exec :  1, /* event is removed from task on exec */
+ 				__reserved_1   : 27;
++>>>>>>> 2e498d0a74e5 (perf: Add support for event removal on exec)
  
  	union {
  		__u32		wakeup_events;	  /* wakeup every n events */
diff --cc kernel/events/core.c
index 65eb3594599a,e4a584bceb7a..000000000000
--- a/kernel/events/core.c
+++ b/kernel/events/core.c
@@@ -11699,6 -11704,12 +11750,15 @@@ static int perf_copy_attr(struct perf_e
  	    (attr->sample_type & PERF_SAMPLE_WEIGHT_STRUCT))
  		return -EINVAL;
  
++<<<<<<< HEAD
++=======
+ 	if (!attr->inherit && attr->inherit_thread)
+ 		return -EINVAL;
+ 
+ 	if (attr->remove_on_exec && attr->enable_on_exec)
+ 		return -EINVAL;
+ 
++>>>>>>> 2e498d0a74e5 (perf: Add support for event removal on exec)
  out:
  	return ret;
  
* Unmerged path include/uapi/linux/perf_event.h
* Unmerged path kernel/events/core.c
