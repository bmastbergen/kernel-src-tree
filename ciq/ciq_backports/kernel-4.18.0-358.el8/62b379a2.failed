selftests/bpf: Templatize man page generation

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-358.el8
commit-author Joe Stringer <joe@cilium.io>
commit 62b379a233a79e6f4d2e8b14750ae8fa13b8caf8
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-358.el8/62b379a2.failed

Previously, the Makefile here was only targeting a single manual page so
it just hardcoded a bunch of individual rules to specifically handle
build, clean, install, uninstall for that particular page.

Upcoming commits will generate manual pages for an additional section,
so this commit prepares the makefile first by converting the existing
targets into an evaluated set of targets based on the manual page name
and section.

	Signed-off-by: Joe Stringer <joe@cilium.io>
	Signed-off-by: Alexei Starovoitov <ast@kernel.org>
	Reviewed-by: Quentin Monnet <quentin@isovalent.com>
	Acked-by: Toke Høiland-Jørgensen <toke@redhat.com>
Link: https://lore.kernel.org/bpf/20210302171947.2268128-13-joe@cilium.io
(cherry picked from commit 62b379a233a79e6f4d2e8b14750ae8fa13b8caf8)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/bpf/Makefile.helpers
diff --cc tools/bpf/Makefile.helpers
index 94d4653bcfdd,f39ad19317c8..000000000000
--- a/tools/bpf/Makefile.helpers
+++ b/tools/bpf/Makefile.helpers
@@@ -33,27 -31,42 +33,55 @@@ man7: $(DOC_MAN7
  
  RST2MAN_DEP := $(shell command -v rst2man 2>/dev/null)
  
 -# Configure make rules for the man page bpf-$1.$2.
 -# $1 - target for scripts/bpf_doc.py
 -# $2 - man page section to generate the troff file
 -define DOCS_RULES =
 -$(OUTPUT)bpf-$1.rst: ../../../../include/uapi/linux/bpf.h
 -	$$(QUIET_GEN)../../../../scripts/bpf_doc.py $1 \
 -		--filename $$< > $$@
 +$(OUTPUT)$(HELPERS_RST): $(UP2DIR)../../include/uapi/linux/bpf.h
 +	$(QUIET_GEN)$(UP2DIR)../../scripts/bpf_doc.py --filename $< > $@
  
- $(OUTPUT)%.7: $(OUTPUT)%.rst
+ $(OUTPUT)%.$2: $(OUTPUT)%.rst
  ifndef RST2MAN_DEP
- 	$(error "rst2man not found, but required to generate man pages")
+ 	$$(error "rst2man not found, but required to generate man pages")
  endif
- 	$(QUIET_GEN)rst2man $< > $@
+ 	$$(QUIET_GEN)rst2man $$< > $$@
  
++<<<<<<< HEAD:tools/bpf/Makefile.helpers
 +helpers-clean:
 +	$(call QUIET_CLEAN, eBPF_helpers-manpage)
 +	$(Q)$(RM) $(DOC_MAN7) $(OUTPUT)$(HELPERS_RST)
 +
 +helpers-install: helpers
 +	$(call QUIET_INSTALL, eBPF_helpers-manpage)
 +	$(Q)$(INSTALL) -d -m 755 $(DESTDIR)$(man7dir)
 +	$(Q)$(INSTALL) -m 644 $(DOC_MAN7) $(DESTDIR)$(man7dir)
 +
 +helpers-uninstall:
 +	$(call QUIET_UNINST, eBPF_helpers-manpage)
 +	$(Q)$(RM) $(addprefix $(DESTDIR)$(man7dir)/,$(_DOC_MAN7))
 +	$(Q)$(RMDIR) $(DESTDIR)$(man7dir)
 +
 +.PHONY: helpers helpers-clean helpers-install helpers-uninstall
++=======
+ docs-clean-$1:
+ 	$$(call QUIET_CLEAN, eBPF_$1-manpage)
+ 	$(Q)$(RM) $$(DOC_MAN$2) $(OUTPUT)bpf-$1.rst
+ 
+ docs-install-$1: docs
+ 	$$(call QUIET_INSTALL, eBPF_$1-manpage)
+ 	$(Q)$(INSTALL) -d -m 755 $(DESTDIR)$$(man$2dir)
+ 	$(Q)$(INSTALL) -m 644 $$(DOC_MAN$2) $(DESTDIR)$$(man$2dir)
+ 
+ docs-uninstall-$1:
+ 	$$(call QUIET_UNINST, eBPF_$1-manpage)
+ 	$(Q)$(RM) $$(addprefix $(DESTDIR)$$(man$2dir)/,$$(_DOC_MAN$2))
+ 	$(Q)$(RMDIR) $(DESTDIR)$$(man$2dir)
+ 
+ .PHONY: $1 docs-clean-$1 docs-install-$1 docs-uninstall-$1
+ endef
+ 
+ # Create the make targets to generate manual pages by name and section
+ $(eval $(call DOCS_RULES,helpers,7))
+ 
+ docs-clean: $(foreach doctarget,$(DOCTARGETS), docs-clean-$(doctarget))
+ docs-install: $(foreach doctarget,$(DOCTARGETS), docs-install-$(doctarget))
+ docs-uninstall: $(foreach doctarget,$(DOCTARGETS), docs-uninstall-$(doctarget))
+ 
+ .PHONY: docs docs-clean docs-install docs-uninstall man7
++>>>>>>> 62b379a233a7 (selftests/bpf: Templatize man page generation):tools/testing/selftests/bpf/Makefile.docs
* Unmerged path tools/bpf/Makefile.helpers
