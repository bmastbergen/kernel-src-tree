kernel/panic: call the 2nd crash_kexec() only if crash_kexec_post_notifiers is enabled

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
Rebuild_CHGLOG: - [kernel] panic: call the 2nd crash_kexec() only if crash_kexec_post_notifiers is enabled (Xunlei Pang) [1182375 726846]
Rebuild_FUZZ: 95.76%
commit-author HATAYAMA Daisuke <d.hatayama@jp.fujitsu.com>
commit f45d85ff1f3f13d5b67fecb291edc6a771db0c53
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/f45d85ff.failed

For compatibility with the behaviour before the commit f06e5153f4ae2e
("kernel/panic.c: add "crash_kexec_post_notifiers" option for kdump after
panic_notifers"), the 2nd crash_kexec() should be called only if
crash_kexec_post_notifiers is enabled.

Note that crash_kexec() returns immediately if kdump crash kernel is not
loaded, so in this case, this patch makes no functionality change, but the
point is to make it explicit, from the caller panic() side, that the 2nd
crash_kexec() does nothing.

	Signed-off-by: HATAYAMA Daisuke <d.hatayama@jp.fujitsu.com>
	Suggested-by: Ingo Molnar <mingo@kernel.org>
	Cc: "Eric W. Biederman" <ebiederm@xmission.com>
	Cc: Vivek Goyal <vgoyal@redhat.com>
	Cc: Masami Hiramatsu <masami.hiramatsu.pt@hitachi.com>
	Cc: Hidehiro Kawai <hidehiro.kawai.ez@hitachi.com>
	Cc: Baoquan He <bhe@redhat.com>
	Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
	Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
(cherry picked from commit f45d85ff1f3f13d5b67fecb291edc6a771db0c53)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	kernel/panic.c
diff --cc kernel/panic.c
index f3d560562c0c,774614f72cbd..000000000000
--- a/kernel/panic.c
+++ b/kernel/panic.c
@@@ -173,6 -135,16 +173,19 @@@ void panic(const char *fmt, ...
  
  	kmsg_dump(KMSG_DUMP_PANIC);
  
++<<<<<<< HEAD
++=======
+ 	/*
+ 	 * If you doubt kdump always works fine in any situation,
+ 	 * "crash_kexec_post_notifiers" offers you a chance to run
+ 	 * panic_notifiers and dumping kmsg before kdump.
+ 	 * Note: since some panic_notifiers can make crashed kernel
+ 	 * more unstable, it can increase risks of the kdump failure too.
+ 	 */
+ 	if (crash_kexec_post_notifiers)
+ 		crash_kexec(NULL);
+ 
++>>>>>>> f45d85ff1f3f (kernel/panic: call the 2nd crash_kexec() only if crash_kexec_post_notifiers is enabled)
  	bust_spinlocks(0);
  
  	if (!panic_blink)
* Unmerged path kernel/panic.c
