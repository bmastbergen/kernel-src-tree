tools/power/acpi: Enable build for EC userspace tool

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Lv Zheng <lv.zheng@intel.com>
commit 4305cd02436dbe0b61b1930f93053a699af40e6a
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/4305cd02.failed

This patch allows EC userspace tool to be built as an ACPI tool.

	Signed-off-by: Lv Zheng <lv.zheng@intel.com>
	Signed-off-by: Rafael J. Wysocki <rafael.j.wysocki@intel.com>
(cherry picked from commit 4305cd02436dbe0b61b1930f93053a699af40e6a)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/power/acpi/Makefile
diff --cc tools/power/acpi/Makefile
index e5a3c4be2a10,e882c8320135..000000000000
--- a/tools/power/acpi/Makefile
+++ b/tools/power/acpi/Makefile
@@@ -8,149 -8,20 +8,165 @@@
  # as published by the Free Software Foundation; version 2
  # of the License.
  
 -include ../../scripts/Makefile.include
 +OUTPUT=./
 +ifeq ("$(origin O)", "command line")
 +	OUTPUT := $(O)/
 +endif
  
++<<<<<<< HEAD
 +ifneq ($(OUTPUT),)
 +# check that the output directory actually exists
 +OUTDIR := $(shell cd $(OUTPUT) && /bin/pwd)
 +$(if $(OUTDIR),, $(error output directory "$(OUTPUT)" does not exist))
 +endif
 +
 +SUBDIRS = tools/ec
++=======
+ all: acpidump ec
+ clean: acpidump_clean ec_clean
+ install: acpidump_install ec_install
+ uninstall: acpidump_uninstall ec_uninstall
+ 
+ acpidump ec: FORCE
+ 	$(call descend,tools/$@,all)
+ acpidump_clean ec_clean:
+ 	$(call descend,tools/$(@:_clean=),clean)
+ acpidump_install ec_install:
+ 	$(call descend,tools/$(@:_install=),install)
+ acpidump_uninstall ec_uninstall:
+ 	$(call descend,tools/$(@:_uninstall=),uninstall)
++>>>>>>> 4305cd02436d (tools/power/acpi: Enable build for EC userspace tool)
 +
 +# --- CONFIGURATION BEGIN ---
 +
 +# Set the following to `true' to make a unstripped, unoptimized
 +# binary. Leave this set to `false' for production use.
 +DEBUG ?=	true
 +
 +# make the build silent. Set this to something else to make it noisy again.
 +V ?=		false
 +
 +# Prefix to the directories we're installing to
 +DESTDIR ?=
 +
 +# --- CONFIGURATION END ---
 +
 +# Directory definitions. These are default and most probably
 +# do not need to be changed. Please note that DESTDIR is
 +# added in front of any of them
 +
 +bindir ?=	/usr/bin
 +sbindir ?=	/usr/sbin
 +mandir ?=	/usr/man
 +
 +# Toolchain: what tools do we use, and what options do they need:
 +
 +INSTALL = /usr/bin/install -c
 +INSTALL_PROGRAM = ${INSTALL}
 +INSTALL_DATA  = ${INSTALL} -m 644
 +INSTALL_SCRIPT = ${INSTALL_PROGRAM}
 +
 +# If you are running a cross compiler, you may want to set this
 +# to something more interesting, like "arm-linux-".  If you want
 +# to compile vs uClibc, that can be done here as well.
 +CROSS = #/usr/i386-linux-uclibc/usr/bin/i386-uclibc-
 +CC = $(CROSS)gcc
 +LD = $(CROSS)gcc
 +STRIP = $(CROSS)strip
 +HOSTCC = gcc
 +
 +# check if compiler option is supported
 +cc-supports = ${shell if $(CC) ${1} -S -o /dev/null -x c /dev/null > /dev/null 2>&1; then echo "$(1)"; fi;}
 +
 +# use '-Os' optimization if available, else use -O2
 +OPTIMIZATION := $(call cc-supports,-Os,-O2)
 +
 +WARNINGS := -Wall
 +WARNINGS += $(call cc-supports,-Wstrict-prototypes)
 +WARNINGS += $(call cc-supports,-Wdeclaration-after-statement)
 +
 +KERNEL_INCLUDE := ../../../include
 +ACPICA_INCLUDE := ../../../drivers/acpi/acpica
 +CFLAGS += -D_LINUX -I$(KERNEL_INCLUDE) -I$(ACPICA_INCLUDE)
 +CFLAGS += $(WARNINGS)
 +
 +ifeq ($(strip $(V)),false)
 +	QUIET=@
 +	ECHO=@echo
 +else
 +	QUIET=
 +	ECHO=@\#
 +endif
 +export QUIET ECHO
 +
 +# if DEBUG is enabled, then we do not strip or optimize
 +ifeq ($(strip $(DEBUG)),true)
 +	CFLAGS += -O1 -g -DDEBUG
 +	STRIPCMD = /bin/true -Since_we_are_debugging
 +else
 +	CFLAGS += $(OPTIMIZATION) -fomit-frame-pointer
 +	STRIPCMD = $(STRIP) -s --remove-section=.note --remove-section=.comment
 +endif
 +
 +# --- ACPIDUMP BEGIN ---
 +
 +vpath %.c \
 +	../../../drivers/acpi/acpica\
 +	tools/acpidump\
 +	common\
 +	os_specific/service_layers
 +
 +CFLAGS += -DACPI_DUMP_APP -Itools/acpidump
 +
 +DUMP_OBJS = \
 +	apdump.o\
 +	apfiles.o\
 +	apmain.o\
 +	osunixdir.o\
 +	osunixmap.o\
 +	tbprint.o\
 +	tbxfroot.o\
 +	utbuffer.o\
 +	utexcep.o\
 +	utmath.o\
 +	utstring.o\
 +	utxferror.o\
 +	oslinuxtbl.o\
 +	cmfsize.o\
 +	getopt.o
 +
 +DUMP_OBJS := $(addprefix $(OUTPUT)tools/acpidump/,$(DUMP_OBJS))
 +
 +$(OUTPUT)acpidump: $(DUMP_OBJS)
 +	$(ECHO) "  LD      " $@
 +	$(QUIET) $(LD) $(CFLAGS) $(LDFLAGS) $(DUMP_OBJS) -L$(OUTPUT) -o $@
 +	$(QUIET) $(STRIPCMD) $@
 +
 +$(OUTPUT)tools/acpidump/%.o: %.c
 +	$(ECHO) "  CC      " $@
 +	$(QUIET) $(CC) -c $(CFLAGS) -o $@ $<
 +
 +# --- ACPIDUMP END ---
 +
 +all: $(OUTPUT)acpidump
 +	echo $(OUTPUT)
 +
 +clean:
 +	-find $(OUTPUT) \( -not -type d \) -and \( -name '*~' -o -name '*.[oas]' \) -type f -print \
 +	 | xargs rm -f
 +	-rm -f $(OUTPUT)acpidump
 +
 +install-tools:
 +	$(INSTALL) -d $(DESTDIR)${sbindir}
 +	$(INSTALL_PROGRAM) $(OUTPUT)acpidump $(DESTDIR)${sbindir}
 +
 +install-man:
 +	$(INSTALL_DATA) -D man/acpidump.8 $(DESTDIR)${mandir}/man8/acpidump.8
 +
 +install: all install-tools install-man
 +
 +uninstall:
 +	- rm -f $(DESTDIR)${sbindir}/acpidump
 +	- rm -f $(DESTDIR)${mandir}/man8/acpidump.8
  
 -.PHONY: FORCE
 +.PHONY: all utils install-tools install-man install uninstall clean
* Unmerged path tools/power/acpi/Makefile
diff --git a/tools/power/acpi/tools/ec/Makefile b/tools/power/acpi/tools/ec/Makefile
index b7b0b929bd32..75d8a127b6ee 100644
--- a/tools/power/acpi/tools/ec/Makefile
+++ b/tools/power/acpi/tools/ec/Makefile
@@ -1,22 +1,17 @@
-ec_access: ec_access.o
-	$(ECHO) "  LD      " $@
-	$(QUIET) $(LD) $(CFLAGS) $(LDFLAGS) $< -o $@
-	$(QUIET) $(STRIPCMD) $@
+# tools/power/acpi/tools/acpidump/Makefile - ACPI tool Makefile
+#
+# Copyright (c) 2015, Intel Corporation
+#   Author: Lv Zheng <lv.zheng@intel.com>
+#
+# This program is free software; you can redistribute it and/or
+# modify it under the terms of the GNU General Public License
+# as published by the Free Software Foundation; version 2
+# of the License.
 
-%.o: %.c
-	$(ECHO) "  CC      " $@
-	$(QUIET) $(CC) -c $(CFLAGS) -o $@ $<
+include ../../Makefile.config
 
-all: ec_access
+TOOL = ec
+TOOL_OBJS = \
+	ec_access.o
 
-install:
-	$(INSTALL) -d $(DESTDIR)${sbindir}
-	$(INSTALL_PROGRAM) ec_access $(DESTDIR)${sbindir}
-
-uninstall:
-	- rm -f $(DESTDIR)${sbindir}/ec_access
-
-clean:
-	-rm -f $(OUTPUT)ec_access
-
-.PHONY: all install uninstall
+include ../../Makefile.rules
