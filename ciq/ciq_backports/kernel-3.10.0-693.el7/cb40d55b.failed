tools build: Add feature detection for LLVM

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Wang Nan <wangnan0@huawei.com>
commit cb40d55b595cd117ef7c1880247605875b2115e8
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/cb40d55b.failed

Check if basic LLVM compiling environment is ready.

Use llvm-config to detect include and library directories. Avoid using
'llvm-config --cxxflags' because its result contain some unwanted flags
like --sysroot (if LLVM is built by yocto).

Use '?=' to set LLVM_CONFIG, so explicitly passing LLVM_CONFIG to make
would override it.

Use 'llvm-config --libs BPF' to check if BPF backend is compiled in.
Since now BPF bytecode is the only required backend, no need to waste
time linking llvm and clang if BPF backend is missing. This also
introduce an implicit requirement that LLVM should be new enough.  Old
LLVM doesn't support BPF backend.

	Signed-off-by: Wang Nan <wangnan0@huawei.com>
	Cc: Alexei Starovoitov <ast@fb.com>
	Cc: He Kuang <hekuang@huawei.com>
	Cc: Jiri Olsa <jolsa@kernel.org>
	Cc: Joe Stringer <joe@ovn.org>
	Cc: Zefan Li <lizefan@huawei.com>
	Cc: pi3orama@163.com
Link: http://lkml.kernel.org/r/20161126070354.141764-8-wangnan0@huawei.com
	Signed-off-by: Arnaldo Carvalho de Melo <acme@redhat.com>
(cherry picked from commit cb40d55b595cd117ef7c1880247605875b2115e8)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/build/feature/Makefile
diff --cc tools/build/feature/Makefile
index 017397a4639a,c09de59affc9..000000000000
--- a/tools/build/feature/Makefile
+++ b/tools/build/feature/Makefile
@@@ -49,7 -53,9 +49,8 @@@ FILES=					
  FILES := $(addprefix $(OUTPUT),$(FILES))
  
  CC := $(CROSS_COMPILE)gcc -MD
 -CXX := $(CROSS_COMPILE)g++ -MD
  PKG_CONFIG := $(CROSS_COMPILE)pkg-config
+ LLVM_CONFIG ?= llvm-config
  
  all: $(FILES)
  
@@@ -209,6 -218,25 +210,28 @@@ $(OUTPUT)test-lzma.bin
  $(OUTPUT)test-get_cpuid.bin:
  	$(BUILD)
  
++<<<<<<< HEAD
++=======
+ $(OUTPUT)test-bpf.bin:
+ 	$(BUILD)
+ 
+ $(OUTPUT)test-sdt.bin:
+ 	$(BUILD)
+ 
+ $(OUTPUT)test-cxx.bin:
+ 	$(BUILDXX) -std=gnu++11
+ 
+ $(OUTPUT)test-jvmti.bin:
+ 	$(BUILD)
+ 
+ $(OUTPUT)test-llvm.bin:
+ 	$(BUILDXX) -std=gnu++11 					\
+ 		-I$(shell $(LLVM_CONFIG) --includedir) 		\
+ 		-L$(shell $(LLVM_CONFIG) --libdir)		\
+ 		$(shell $(LLVM_CONFIG) --libs Core BPF)		\
+ 		$(shell $(LLVM_CONFIG) --system-libs)
+ 
++>>>>>>> cb40d55b595c (tools build: Add feature detection for LLVM)
  -include $(OUTPUT)*.d
  
  ###############################
* Unmerged path tools/build/feature/Makefile
diff --git a/tools/build/feature/test-llvm.cpp b/tools/build/feature/test-llvm.cpp
new file mode 100644
index 000000000000..d8d2cee35345
--- /dev/null
+++ b/tools/build/feature/test-llvm.cpp
@@ -0,0 +1,8 @@
+#include "llvm/Support/ManagedStatic.h"
+#include "llvm/Support/raw_ostream.h"
+int main()
+{
+	llvm::errs() << "Hello World!\n";
+	llvm::llvm_shutdown();
+	return 0;
+}
