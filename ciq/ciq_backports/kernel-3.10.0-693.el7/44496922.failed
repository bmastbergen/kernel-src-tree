sched/nohz: Fix affine unpinned timers mess

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Wanpeng Li <wanpeng.li@hotmail.com>
commit 444969223c81c7d0a95136b7b4cfdcfbc96ac5bd
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/44496922.failed

The following commit:

  9642d18eee2c ("nohz: Affine unpinned timers to housekeepers")'

intended to affine unpinned timers to housekeepers:

  unpinned timers(full dynaticks, idle)   =>   nearest busy housekeepers(otherwise, fallback to any housekeepers)
  unpinned timers(full dynaticks, busy)   =>   nearest busy housekeepers(otherwise, fallback to any housekeepers)
  unpinned timers(houserkeepers, idle)    =>   nearest busy housekeepers(otherwise, fallback to itself)

However, the !idle_cpu(i) && is_housekeeping_cpu(cpu) check modified the
intention to:

  unpinned timers(full dynaticks, idle)   =>   any housekeepers(no mattter cpu topology)
  unpinned timers(full dynaticks, busy)   =>   any housekeepers(no mattter cpu topology)
  unpinned timers(housekeepers, idle)     =>   any busy cpus(otherwise, fallback to any housekeepers)

This patch fixes it by checking if there are busy housekeepers nearby,
otherwise falls to any housekeepers/itself. After the patch:

  unpinned timers(full dynaticks, idle)   =>   nearest busy housekeepers(otherwise, fallback to any housekeepers)
  unpinned timers(full dynaticks, busy)   =>   nearest busy housekeepers(otherwise, fallback to any housekeepers)
  unpinned timers(housekeepers, idle)     =>   nearest busy housekeepers(otherwise, fallback to itself)

	Signed-off-by: Wanpeng Li <wanpeng.li@hotmail.com>
	Signed-off-by: Peter Zijlstra (Intel) <peterz@infradead.org>
[ Fixed the changelog. ]
	Cc: Frederic Weisbecker <fweisbec@gmail.com>
	Cc: Linus Torvalds <torvalds@linux-foundation.org>
	Cc: Mike Galbraith <efault@gmx.de>
	Cc: Peter Zijlstra <peterz@infradead.org>
	Cc: Thomas Gleixner <tglx@linutronix.de>
	Cc: linux-kernel@vger.kernel.org
Fixes: 'commit 9642d18eee2c ("nohz: Affine unpinned timers to housekeepers")'
Link: http://lkml.kernel.org/r/1462344334-8303-1-git-send-email-wanpeng.li@hotmail.com
	Signed-off-by: Ingo Molnar <mingo@kernel.org>
(cherry picked from commit 444969223c81c7d0a95136b7b4cfdcfbc96ac5bd)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	kernel/sched/core.c
diff --cc kernel/sched/core.c
index 98e40872a037,6f6962a356b4..000000000000
--- a/kernel/sched/core.c
+++ b/kernel/sched/core.c
@@@ -595,7 -530,13 +595,14 @@@ int get_nohz_timer_target(void
  	rcu_read_lock();
  	for_each_domain(cpu, sd) {
  		for_each_cpu(i, sched_domain_span(sd)) {
++<<<<<<< HEAD
 +			if (!idle_cpu(i)) {
++=======
+ 			if (cpu == i)
+ 				continue;
+ 
+ 			if (!idle_cpu(i) && is_housekeeping_cpu(i)) {
++>>>>>>> 444969223c81 (sched/nohz: Fix affine unpinned timers mess)
  				cpu = i;
  				goto unlock;
  			}
* Unmerged path kernel/sched/core.c
