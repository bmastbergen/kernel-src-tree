net/mlx5: E-Switch, Fix vport enable flow

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
Rebuild_CHGLOG: - [netdrv] mlx5: E-Switch, Fix vport enable flow (Don Dutile) [1385330 1417284]
Rebuild_FUZZ: 94.87%
commit-author Mohamad Haj Yahia <mohamad@mellanox.com>
commit 25fff58cb24c8880090d8b8ef7746001a135e876
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/25fff58c.failed

Reorder vport enable flow to mark the vport as enabled before calling
the vport change handler which was modified to handle the case for
when vport is not enabled.

This fixes the case for when the PF netdev is open before sriov is
enabled, once sriov is enabled at esw_enable_vport,
esw_vport_change_handle_locked didn't read the PF context since it
thought the PF vport was not enabled.

When we enable the vport, arming for events is not required anymore,
since it's done on the vport change handle

Fixes: 586cfa7f1d58 ('net/mlx5: E-Switch, Use vport event handler for vport cleanup')
	Signed-off-by: Mohamad Haj Yahia <mohamad@mellanox.com>
	Signed-off-by: Saeed Mahameed <saeedm@mellanox.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 25fff58cb24c8880090d8b8ef7746001a135e876)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlx5/core/eswitch.c
diff --cc drivers/net/ethernet/mellanox/mlx5/core/eswitch.c
index b153747c6dc3,cfec20cffd26..000000000000
--- a/drivers/net/ethernet/mellanox/mlx5/core/eswitch.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/eswitch.c
@@@ -1192,11 -1491,11 +1192,19 @@@ static void esw_enable_vport(struct mlx
  
  	/* Sync with current vport context */
  	vport->enabled_events = enable_events;
++<<<<<<< HEAD
 +	esw_vport_change_handler(&vport->vport_change_handler);
 +
 +	vport->enabled = true;
 +
 +	arm_vport_context_events_cmd(esw->dev, vport_num, enable_events);
++=======
+ 	vport->enabled = true;
+ 
+ 	/* only PF is trusted by default */
+ 	vport->trusted = (vport_num) ? false : true;
+ 	esw_vport_change_handle_locked(vport);
++>>>>>>> 25fff58cb24c (net/mlx5: E-Switch, Fix vport enable flow)
  
  	esw->enabled_vports++;
  	esw_debug(esw->dev, "Enabled VPORT(%d)\n", vport_num);
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/eswitch.c
