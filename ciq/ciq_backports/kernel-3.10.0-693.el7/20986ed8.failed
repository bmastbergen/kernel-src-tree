amd-xgbe: Fix race between access of desc and desc index

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Lendacky, Thomas <Thomas.Lendacky@amd.com>
commit 20986ed826cbb36bb8f2d77f872e3c52d8d30647
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/20986ed8.failed

During Tx cleanup it's still possible for the descriptor data to be
read ahead of the descriptor index. A memory barrier is required between
the read of the descriptor index and the start of the Tx cleanup loop.
This allows a change to a lighter-weight barrier in the Tx transmit
routine just before updating the current descriptor index.

Since the memory barrier does result in extra overhead on arm64, keep
the previous change to not chase the current descriptor value. This
prevents the execution of the barrier for each loop performed.

	Suggested-by: Alexander Duyck <alexander.duyck@gmail.com>
	Signed-off-by: Tom Lendacky <thomas.lendacky@amd.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 20986ed826cbb36bb8f2d77f872e3c52d8d30647)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/amd/xgbe/xgbe-drv.c
diff --cc drivers/net/ethernet/amd/xgbe/xgbe-drv.c
index d58e85811bc9,dde0486667e0..000000000000
--- a/drivers/net/ethernet/amd/xgbe/xgbe-drv.c
+++ b/drivers/net/ethernet/amd/xgbe/xgbe-drv.c
@@@ -1116,10 -1815,15 +1116,19 @@@ static int xgbe_tx_poll(struct xgbe_cha
  	if (!ring)
  		return 0;
  
++<<<<<<< HEAD
 +	spin_lock_irqsave(&ring->lock, flags);
++=======
+ 	cur = ring->cur;
+ 
+ 	/* Be sure we get ring->cur before accessing descriptor data */
+ 	smp_rmb();
+ 
+ 	txq = netdev_get_tx_queue(netdev, channel->queue_index);
++>>>>>>> 20986ed826cb (amd-xgbe: Fix race between access of desc and desc index)
  
  	while ((processed < XGBE_TX_DESC_MAX_PROC) &&
 -	       (ring->dirty != cur)) {
 +	       (ring->dirty != ring->cur)) {
  		rdata = XGBE_GET_DESC_DATA(ring, ring->dirty);
  		rdesc = rdata->rdesc;
  
diff --git a/drivers/net/ethernet/amd/xgbe/xgbe-dev.c b/drivers/net/ethernet/amd/xgbe/xgbe-dev.c
index 0a0dc2f51565..58ce8da349ed 100644
--- a/drivers/net/ethernet/amd/xgbe/xgbe-dev.c
+++ b/drivers/net/ethernet/amd/xgbe/xgbe-dev.c
@@ -1110,7 +1110,7 @@ static void xgbe_pre_xmit(struct xgbe_channel *channel)
 #endif
 
 	/* Make sure ownership is written to the descriptor */
-	wmb();
+	smp_wmb();
 
 	/* Issue a poll command to Tx DMA by writing address
 	 * of next immediate free descriptor */
* Unmerged path drivers/net/ethernet/amd/xgbe/xgbe-drv.c
