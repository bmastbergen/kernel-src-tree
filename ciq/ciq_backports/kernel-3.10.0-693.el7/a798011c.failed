xfs: reinitialise per-AG structures if geometry changes during recovery

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Dave Chinner <dchinner@redhat.com>
commit a798011c8fd4286605b990c1722c16903fc14b7a
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/a798011c.failed

If a crash occurs immediately after a filesystem grow operation, the
updated superblock geometry is found only in the log. After we
recover the log, the superblock is reread and re-initialised and so
has the new geometry in memory. If the new geometry has more AGs
than prior to the grow operation, then the new AGs will not have
in-memory xfs_perag structurea associated with them.

This will result in an oops when the first metadata buffer from a
new AG is looked up in the buffer cache, as the block lies within
the new geometry but then fails to find a perag structure on lookup.
This is easily fixed by simply re-initialising the perag structure
after re-reading the superblock at the conclusion of the first pahse
of log recovery.

This, however, does not fix the case of log recovery requiring
access to metadata in the newly grown space. Fortunately for us,
because the in-core superblock has not been updated, this will
result in detection of access beyond the end of the filesystem
and so recovery will fail at that point. If this proves to be
a problem, then we can address it separately to the current
reported issue.

	Reported-by: Alex Lyakas <alex@zadarastorage.com>
	Tested-by: Alex Lyakas <alex@zadarastorage.com>
	Signed-off-by: Dave Chinner <dchinner@redhat.com>

(cherry picked from commit a798011c8fd4286605b990c1722c16903fc14b7a)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/xfs/xfs_log_recover.c
diff --cc fs/xfs/xfs_log_recover.c
index 67ded68898f9,60c385f43a53..000000000000
--- a/fs/xfs/xfs_log_recover.c
+++ b/fs/xfs/xfs_log_recover.c
@@@ -5076,11 -4925,10 +5077,18 @@@ xlog_do_recover
  	 * Now that we've finished replaying all buffer and inode
  	 * updates, re-read in the superblock and reverify it.
  	 */
++<<<<<<< HEAD
 +	bp = xfs_getsb(log->l_mp, 0);
 +	XFS_BUF_UNDONE(bp);
 +	ASSERT(!(XFS_BUF_ISWRITE(bp)));
 +	XFS_BUF_READ(bp);
 +	XFS_BUF_UNASYNC(bp);
++=======
+ 	bp = xfs_getsb(mp, 0);
+ 	bp->b_flags &= ~(XBF_DONE | XBF_ASYNC);
+ 	ASSERT(!(bp->b_flags & XBF_WRITE));
+ 	bp->b_flags |= XBF_READ;
++>>>>>>> a798011c8fd4 (xfs: reinitialise per-AG structures if geometry changes during recovery)
  	bp->b_ops = &xfs_sb_buf_ops;
  
  	error = xfs_buf_submit_wait(bp);
* Unmerged path fs/xfs/xfs_log_recover.c
