virtio-balloon: do not call blocking ops when !TASK_RUNNING

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Michael S. Tsirkin <mst@redhat.com>
commit 3d2a3774c1b046f548ebea0391a602fd5685a307
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/3d2a3774.failed

virtio balloon has this code:
        wait_event_interruptible(vb->config_change,
                                 (diff = towards_target(vb)) != 0
                                 || vb->need_stats_update
                                 || kthread_should_stop()
                                 || freezing(current));

Which is a problem because towards_target() call might block after
wait_event_interruptible sets task state to TAST_INTERRUPTIBLE, causing
the task_struct::state collision typical of nesting of sleeping
primitives

See also http://lwn.net/Articles/628628/ or Thomas's
bug report
http://article.gmane.org/gmane.linux.kernel.virtualization/24846
for a fuller explanation.

To fix, rewrite using wait_woken.

	Cc: stable@vger.kernel.org
	Reported-by: Thomas Huth <thuth@linux.vnet.ibm.com>
	Signed-off-by: Michael S. Tsirkin <mst@redhat.com>
	Tested-by: Thomas Huth <thuth@linux.vnet.ibm.com>
	Reviewed-by: Cornelia Huck <cornelia.huck@de.ibm.com>
	Signed-off-by: Rusty Russell <rusty@rustcorp.com.au>
(cherry picked from commit 3d2a3774c1b046f548ebea0391a602fd5685a307)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/virtio/virtio_balloon.c
diff --cc drivers/virtio/virtio_balloon.c
index a9ca908865d3,6a356e344f82..000000000000
--- a/drivers/virtio/virtio_balloon.c
+++ b/drivers/virtio/virtio_balloon.c
@@@ -29,7 -29,7 +29,11 @@@
  #include <linux/module.h>
  #include <linux/balloon_compaction.h>
  #include <linux/oom.h>
++<<<<<<< HEAD
 +#include <linux/mm.h>
++=======
+ #include <linux/wait.h>
++>>>>>>> 3d2a3774c1b0 (virtio-balloon: do not call blocking ops when !TASK_RUNNING)
  
  /*
   * Balloon device works in 4K page units.  So each page is pointed to by
* Unmerged path drivers/virtio/virtio_balloon.c
