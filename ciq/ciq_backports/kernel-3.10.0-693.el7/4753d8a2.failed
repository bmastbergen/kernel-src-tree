ext4: return EROFS if device is r/o and journal replay is needed

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Theodore Ts'o <tytso@mit.edu>
commit 4753d8a24d4588657bc0a4cd66d4e282dff15c8c
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/4753d8a2.failed

If the file system requires journal recovery, and the device is
read-ony, return EROFS to the mount system call.  This allows xfstests
generic/050 to pass.

	Signed-off-by: Theodore Ts'o <tytso@mit.edu>
	Cc: stable@vger.kernel.org
(cherry picked from commit 4753d8a24d4588657bc0a4cd66d4e282dff15c8c)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/ext4/super.c
diff --cc fs/ext4/super.c
index 8a6f058f1768,514e5fc59893..000000000000
--- a/fs/ext4/super.c
+++ b/fs/ext4/super.c
@@@ -4088,12 -3924,12 +4088,19 @@@ static int ext4_fill_super(struct super
  	 * The first inode we look at is the journal inode.  Don't try
  	 * root first: it may be modified in the journal!
  	 */
++<<<<<<< HEAD
 +	if (!test_opt(sb, NOLOAD) &&
 +	    EXT4_HAS_COMPAT_FEATURE(sb, EXT4_FEATURE_COMPAT_HAS_JOURNAL)) {
 +		if (ext4_load_journal(sb, es, journal_devnum))
 +			goto failed_mount3;
++=======
+ 	if (!test_opt(sb, NOLOAD) && ext4_has_feature_journal(sb)) {
+ 		err = ext4_load_journal(sb, es, journal_devnum);
+ 		if (err)
+ 			goto failed_mount3a;
++>>>>>>> 4753d8a24d45 (ext4: return EROFS if device is r/o and journal replay is needed)
  	} else if (test_opt(sb, NOLOAD) && !(sb->s_flags & MS_RDONLY) &&
 -		   ext4_has_feature_journal_needs_recovery(sb)) {
 +	      EXT4_HAS_INCOMPAT_FEATURE(sb, EXT4_FEATURE_INCOMPAT_RECOVER)) {
  		ext4_msg(sb, KERN_ERR, "required journal recovery "
  		       "suppressed and not mounted read-only");
  		goto failed_mount_wq;
* Unmerged path fs/ext4/super.c
