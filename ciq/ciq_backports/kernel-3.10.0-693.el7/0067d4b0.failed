blk-mq: Fix tagset reinit in the presence of cpu hot-unplug

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Sagi Grimberg <sagi@grimberg.me>
commit 0067d4b020ea07a58540acb2c5fcd3364bf326e0
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/0067d4b0.failed

In case cpu was unplugged, we need to make sure not to assume
that the tags for that cpu are still allocated. so check
for null tags when reinitializing a tagset.

	Reported-by: Yi Zhang <yizhan@redhat.com>
	Signed-off-by: Sagi Grimberg <sagi@grimberg.me>
	Signed-off-by: Jens Axboe <axboe@fb.com>
(cherry picked from commit 0067d4b020ea07a58540acb2c5fcd3364bf326e0)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	block/blk-mq-tag.c
diff --cc block/blk-mq-tag.c
index d97f0822078c,9d97bfc4d465..000000000000
--- a/block/blk-mq-tag.c
+++ b/block/blk-mq-tag.c
@@@ -480,6 -285,35 +480,38 @@@ void blk_mq_tagset_busy_iter(struct blk
  }
  EXPORT_SYMBOL(blk_mq_tagset_busy_iter);
  
++<<<<<<< HEAD
++=======
+ int blk_mq_reinit_tagset(struct blk_mq_tag_set *set)
+ {
+ 	int i, j, ret = 0;
+ 
+ 	if (!set->ops->reinit_request)
+ 		goto out;
+ 
+ 	for (i = 0; i < set->nr_hw_queues; i++) {
+ 		struct blk_mq_tags *tags = set->tags[i];
+ 
+ 		if (!tags)
+ 			continue;
+ 
+ 		for (j = 0; j < tags->nr_tags; j++) {
+ 			if (!tags->static_rqs[j])
+ 				continue;
+ 
+ 			ret = set->ops->reinit_request(set->driver_data,
+ 						tags->static_rqs[j]);
+ 			if (ret)
+ 				goto out;
+ 		}
+ 	}
+ 
+ out:
+ 	return ret;
+ }
+ EXPORT_SYMBOL_GPL(blk_mq_reinit_tagset);
+ 
++>>>>>>> 0067d4b020ea (blk-mq: Fix tagset reinit in the presence of cpu hot-unplug)
  void blk_mq_queue_tag_busy_iter(struct request_queue *q, busy_iter_fn *fn,
  		void *priv)
  {
* Unmerged path block/blk-mq-tag.c
