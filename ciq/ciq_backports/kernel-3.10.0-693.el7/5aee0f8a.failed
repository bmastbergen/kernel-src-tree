ext4: fix in-superblock mount options processing

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Theodore Ts'o <tytso@mit.edu>
commit 5aee0f8a3f42c94c5012f1673420aee96315925a
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/5aee0f8a.failed

Fix a large number of problems with how we handle mount options in the
superblock.  For one, if the string in the superblock is long enough
that it is not null terminated, we could run off the end of the string
and try to interpret superblocks fields as characters.  It's unlikely
this will cause a security problem, but it could result in an invalid
parse.  Also, parse_options is destructive to the string, so in some
cases if there is a comma-separated string, it would be modified in
the superblock.  (Fortunately it only happens on file systems with a
1k block size.)

	Signed-off-by: Theodore Ts'o <tytso@mit.edu>
	Cc: stable@vger.kernel.org
(cherry picked from commit 5aee0f8a3f42c94c5012f1673420aee96315925a)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/ext4/super.c
diff --cc fs/ext4/super.c
index 78d160093f09,404e6f3c1bed..000000000000
--- a/fs/ext4/super.c
+++ b/fs/ext4/super.c
@@@ -4320,9 -4166,12 +4326,18 @@@ no_journal
  				 "the device does not support discard");
  	}
  
++<<<<<<< HEAD
 +	ext4_msg(sb, KERN_INFO, "mounted filesystem with%s. "
 +		 "Opts: %s%s%s", descr, sbi->s_es->s_mount_opts,
 +		 *sbi->s_es->s_mount_opts ? "; " : "", orig_data);
++=======
+ 	if (___ratelimit(&ext4_mount_msg_ratelimit, "EXT4-fs mount"))
+ 		ext4_msg(sb, KERN_INFO, "mounted filesystem with%s. "
+ 			 "Opts: %.*s%s%s", descr,
+ 			 (int) sizeof(sbi->s_es->s_mount_opts),
+ 			 sbi->s_es->s_mount_opts,
+ 			 *sbi->s_es->s_mount_opts ? "; " : "", orig_data);
++>>>>>>> 5aee0f8a3f42 (ext4: fix in-superblock mount options processing)
  
  	if (es->s_error_count)
  		mod_timer(&sbi->s_err_report, jiffies + 300*HZ); /* 5 minutes */
* Unmerged path fs/ext4/super.c
