sunrpc: don't call sleeping functions from the notifier block callbacks

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Scott Mayhew <smayhew@redhat.com>
commit 546125d1614264d26080817d0c8cddb9b25081fa
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/546125d1.failed

The inet6addr_chain is an atomic notifier chain, so we can't call
anything that might sleep (like lock_sock)... instead of closing the
socket from svc_age_temp_xprts_now (which is called by the notifier
function), just have the rpc service threads do it instead.

	Cc: stable@vger.kernel.org
Fixes: c3d4879e01be "sunrpc: Add a function to close..."
	Signed-off-by: Scott Mayhew <smayhew@redhat.com>
	Signed-off-by: J. Bruce Fields <bfields@redhat.com>
(cherry picked from commit 546125d1614264d26080817d0c8cddb9b25081fa)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/sunrpc/svc_xprt.c
diff --cc net/sunrpc/svc_xprt.c
index c3f652395a80,9c9db55a0c1e..000000000000
--- a/net/sunrpc/svc_xprt.c
+++ b/net/sunrpc/svc_xprt.c
@@@ -1026,12 -1022,11 +1028,20 @@@ void svc_age_temp_xprts_now(struct svc_
  		le = to_be_closed.next;
  		list_del_init(le);
  		xprt = list_entry(le, struct svc_xprt, xpt_list);
++<<<<<<< HEAD
 +		dprintk("svc_age_temp_xprts_now: closing %p\n", xprt);
 +		svsk = container_of(xprt, struct svc_sock, sk_xprt);
 +		sock = svsk->sk_sock;
 +		kernel_setsockopt(sock, SOL_SOCKET, SO_LINGER,
 +				  (char *)&no_linger, sizeof(no_linger));
 +		svc_close_xprt(xprt);
++=======
+ 		set_bit(XPT_CLOSE, &xprt->xpt_flags);
+ 		set_bit(XPT_KILL_TEMP, &xprt->xpt_flags);
+ 		dprintk("svc_age_temp_xprts_now: queuing xprt %p for closing\n",
+ 				xprt);
+ 		svc_xprt_enqueue(xprt);
++>>>>>>> 546125d16142 (sunrpc: don't call sleeping functions from the notifier block callbacks)
  	}
  }
  EXPORT_SYMBOL_GPL(svc_age_temp_xprts_now);
diff --git a/include/linux/sunrpc/svc_xprt.h b/include/linux/sunrpc/svc_xprt.h
index ab02a457da1f..0e42b461cd6d 100644
--- a/include/linux/sunrpc/svc_xprt.h
+++ b/include/linux/sunrpc/svc_xprt.h
@@ -65,6 +65,7 @@ struct svc_xprt {
 #define XPT_LISTENER	10		/* listening endpoint */
 #define XPT_CACHE_AUTH	11		/* cache auth info */
 #define XPT_LOCAL	12		/* connection from loopback interface */
+#define XPT_KILL_TEMP   13		/* call xpo_kill_temp_xprt before closing */
 
 	struct svc_serv		*xpt_server;	/* service for transport */
 	atomic_t    	    	xpt_reserved;	/* space on outq that is rsvd */
* Unmerged path net/sunrpc/svc_xprt.c
