net/mlx5: Store counters in rbtree instead of list

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
Rebuild_CHGLOG: - [netdrv] mlx5: Store counters in rbtree instead of list (Don Dutile) [1385330 1417284]
Rebuild_FUZZ: 95.83%
commit-author Amir Vadai <amir@vadai.me>
commit 29cc6679076a00a6ce193004dcf2d14ae7c428a5
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/29cc6679.failed

In order to use bulk counters, we need to have counters sorted by id.

	Signed-off-by: Amir Vadai <amir@vadai.me>
	Reviewed-by: Or Gerlitz <ogerlitz@mellanox.com>
	Signed-off-by: Saeed Mahameed <saeedm@mellanox.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 29cc6679076a00a6ce193004dcf2d14ae7c428a5)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlx5/core/fs_core.h
#	drivers/net/ethernet/mellanox/mlx5/core/fs_counters.c
#	include/linux/mlx5/driver.h
diff --cc drivers/net/ethernet/mellanox/mlx5/core/fs_core.h
index d607e564f454,9cffb6aeb4e9..000000000000
--- a/drivers/net/ethernet/mellanox/mlx5/core/fs_core.h
+++ b/drivers/net/ethernet/mellanox/mlx5/core/fs_core.h
@@@ -93,6 -104,29 +93,32 @@@ struct mlx5_flow_table 
  	struct list_head		fwd_rules;
  };
  
++<<<<<<< HEAD
++=======
+ struct mlx5_fc_cache {
+ 	u64 packets;
+ 	u64 bytes;
+ 	u64 lastuse;
+ };
+ 
+ struct mlx5_fc {
+ 	struct rb_node node;
+ 	struct list_head list;
+ 
+ 	/* last{packets,bytes} members are used when calculating the delta since
+ 	 * last reading
+ 	 */
+ 	u64 lastpackets;
+ 	u64 lastbytes;
+ 
+ 	u16 id;
+ 	bool deleted;
+ 	bool aging;
+ 
+ 	struct mlx5_fc_cache cache ____cacheline_aligned_in_smp;
+ };
+ 
++>>>>>>> 29cc6679076a (net/mlx5: Store counters in rbtree instead of list)
  /* Type of children is mlx5_flow_rule */
  struct fs_fte {
  	struct fs_node			node;
diff --cc include/linux/mlx5/driver.h
index e2692f7929e8,a041b99fceac..000000000000
--- a/include/linux/mlx5/driver.h
+++ b/include/linux/mlx5/driver.h
@@@ -468,8 -468,34 +468,22 @@@ struct mlx5_irq_info 
  	char name[MLX5_MAX_IRQ_NAME];
  };
  
++<<<<<<< HEAD
++=======
+ struct mlx5_fc_stats {
+ 	struct rb_root counters;
+ 	struct list_head addlist;
+ 	/* protect addlist add/splice operations */
+ 	spinlock_t addlist_lock;
+ 
+ 	struct workqueue_struct *wq;
+ 	struct delayed_work work;
+ 	unsigned long next_query;
+ };
+ 
++>>>>>>> 29cc6679076a (net/mlx5: Store counters in rbtree instead of list)
  struct mlx5_eswitch;
  
 -struct mlx5_rl_entry {
 -	u32                     rate;
 -	u16                     index;
 -	u16                     refcount;
 -};
 -
 -struct mlx5_rl_table {
 -	/* protect rate limit table */
 -	struct mutex            rl_lock;
 -	u16                     max_size;
 -	u32                     max_rate;
 -	u32                     min_rate;
 -	struct mlx5_rl_entry   *rl_entry;
 -};
 -
  struct mlx5_priv {
  	char			name[MLX5_MAX_NAME_LEN];
  	struct mlx5_eq_table	eq_table;
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/fs_counters.c
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/fs_core.h
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/fs_counters.c
* Unmerged path include/linux/mlx5/driver.h
