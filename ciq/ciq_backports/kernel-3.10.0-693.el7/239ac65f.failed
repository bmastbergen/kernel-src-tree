drm/ttm: Make sure BOs being swapped out are cacheable

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
Rebuild_CHGLOG: - [drm] ttm: Make sure BOs being swapped out are cacheable (Rob Clark) [1422186]
Rebuild_FUZZ: 96.15%
commit-author Michel Dänzer <michel.daenzer@amd.com>
commit 239ac65fa5ffab71adf66e642750f940e7241d99
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/239ac65f.failed

The current caching state may not be tt_cached, even though the
placement contains TTM_PL_FLAG_CACHED, because placement can contain
multiple caching flags. Trying to swap out such a BO would trip up the

	BUG_ON(ttm->caching_state != tt_cached);

in ttm_tt_swapout.

	Cc: stable@vger.kernel.org
	Signed-off-by: Michel Dänzer <michel.daenzer@amd.com>
	Reviewed-by: Thomas Hellstrom <thellstrom@vmware.com>
	Reviewed-by: Christian König <christian.koenig@amd.com>.
	Reviewed-by: Sinclair Yeh <syeh@vmware.com>
	Signed-off-by: Christian König <christian.koenig@amd.com>
(cherry picked from commit 239ac65fa5ffab71adf66e642750f940e7241d99)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/gpu/drm/ttm/ttm_bo.c
diff --cc drivers/gpu/drm/ttm/ttm_bo.c
index 3e7c9ac50ccd,86e3b233b722..000000000000
--- a/drivers/gpu/drm/ttm/ttm_bo.c
+++ b/drivers/gpu/drm/ttm/ttm_bo.c
@@@ -1667,15 -1697,11 +1666,20 @@@ static int ttm_bo_swapout(struct ttm_me
  	ttm_bo_list_ref_sub(bo, put_count, true);
  
  	/**
 -	 * Move to system cached
 +	 * Wait for GPU, then move to system cached.
  	 */
  
++<<<<<<< HEAD
 +	ret = ttm_bo_wait(bo, false, false, false);
 +
 +	if (unlikely(ret != 0))
 +		goto out;
 +
 +	if ((bo->mem.placement & swap_placement) != swap_placement) {
++=======
+ 	if (bo->mem.mem_type != TTM_PL_SYSTEM ||
+ 	    bo->ttm->caching_state != tt_cached) {
++>>>>>>> 239ac65fa5ff (drm/ttm: Make sure BOs being swapped out are cacheable)
  		struct ttm_mem_reg evict_mem;
  
  		evict_mem = bo->mem;
* Unmerged path drivers/gpu/drm/ttm/ttm_bo.c
