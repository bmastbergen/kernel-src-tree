HID: wacom - make sure wacom_intuos_inout only process in/out events

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
Rebuild_CHGLOG: - [hid] wacom - make sure wacom_intuos_inout only process in/out events (Aristeu Rozanski) [1346348 1388646 1385026]
Rebuild_FUZZ: 96.18%
commit-author Ping Cheng <pinglinux@gmail.com>
commit 4750f5fe293ae34d334189a77da844f8754862ef
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/4750f5fe.failed

Move general events related data validation to wacom_intuos_general.

	Signed-off-by: Ping Cheng <pingc@wacom.com>
	Reviewed-by: Jason Gerecke <jason.gerecke@wacom.com>
	Signed-off-by: Jiri Kosina <jkosina@suse.cz>
(cherry picked from commit 4750f5fe293ae34d334189a77da844f8754862ef)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/hid/wacom_wac.c
diff --cc drivers/hid/wacom_wac.c
index 98c7d65145c2,c92ea1a24ee4..000000000000
--- a/drivers/hid/wacom_wac.c
+++ b/drivers/hid/wacom_wac.c
@@@ -312,12 -579,13 +312,18 @@@ static int wacom_intuos_inout(struct wa
  {
  	struct wacom_features *features = &wacom->features;
  	unsigned char *data = wacom->data;
++<<<<<<< HEAD
 +	struct input_dev *input = wacom->input;
 +	int idx = 0;
- 
- 	/* tool number */
- 	if (features->type == INTUOS)
- 		idx = data[1] & 0x01;
++=======
+ 	struct input_dev *input = wacom->pen_input;
+ 	int idx = (features->type == INTUOS) ? (data[1] & 0x01) : 0;
++>>>>>>> 4750f5fe293a (HID: wacom - make sure wacom_intuos_inout only process in/out events)
+ 
+ 	if (!(((data[1] & 0xfc) == 0xc0) ||  /* in prox */
+ 	    ((data[1] & 0xfe) == 0x20) ||    /* in range */
+ 	    ((data[1] & 0xfe) == 0x80)))     /* out prox */
+ 		return 0;
  
  	/* Enter report */
  	if ((data[1] & 0xfc) == 0xc0) {
@@@ -412,28 -677,12 +418,37 @@@
  		return 1;
  	}
  
++<<<<<<< HEAD
 +	/*
 +	 * don't report events for invalid data
 +	 */
 +	/* older I4 styli don't work with new Cintiqs */
 +	if ((!((wacom->id[idx] >> 20) & 0x01) &&
 +			(features->type == WACOM_21UX2)) ||
 +	    /* Only large Intuos support Lense Cursor */
 +	    (wacom->tool[idx] == BTN_TOOL_LENS &&
 +		(features->type == INTUOS3 ||
 +		 features->type == INTUOS3S ||
 +		 features->type == INTUOS4 ||
 +		 features->type == INTUOS4S ||
 +		 features->type == INTUOS5 ||
 +		 features->type == INTUOS5S ||
 +		 features->type == INTUOSPM ||
 +		 features->type == INTUOSPS)) ||
 +	   /* Cintiq doesn't send data when RDY bit isn't set */
 +	   (features->type == CINTIQ && !(data[1] & 0x40)))
 +		return 1;
 +
 +	/* Range Report */
 +	if ((data[1] & 0xfe) == 0x20) {
++=======
+ 	wacom->shared->stylus_in_proximity = true;
+ 	if (wacom->shared->touch_down)
+ 		return 1;
+ 
+ 	/* in Range while exiting */
+ 	if (((data[1] & 0xfe) == 0x20) && wacom->reporting_data) {
++>>>>>>> 4750f5fe293a (HID: wacom - make sure wacom_intuos_inout only process in/out events)
  		input_report_key(input, BTN_TOUCH, 0);
  		input_report_abs(input, ABS_PRESSURE, 0);
  		input_report_abs(input, ABS_DISTANCE, wacom->features.distance_max);
@@@ -492,19 -862,69 +507,79 @@@ static void wacom_intuos_general(struc
  {
  	struct wacom_features *features = &wacom->features;
  	unsigned char *data = wacom->data;
 -	struct input_dev *input = wacom->pen_input;
 -	int idx = (features->type == INTUOS) ? (data[1] & 0x01) : 0;
 -	unsigned char type = (data[1] >> 1) & 0x0F;
 -	unsigned int x, y, distance, t;
 +	struct input_dev *input = wacom->input;
 +	unsigned int t;
  
++<<<<<<< HEAD
 +	/* general pen packet */
 +	if ((data[1] & 0xb8) == 0xa0) {
 +		t = (data[6] << 2) | ((data[7] >> 6) & 3);
 +		if (features->type >= INTUOS4S && features->type <= WACOM_24HD) {
 +			t = (t << 1) | (data[1] & 1);
++=======
+ 	if (data[0] != WACOM_REPORT_PENABLED && data[0] != WACOM_REPORT_CINTIQ &&
+ 		data[0] != WACOM_REPORT_INTUOS_PEN)
+ 		return 0;
+ 
+ 	/* don't report events if we don't know the tool ID */
+ 	if (!wacom->id[idx]) {
+ 		/* but reschedule a read of the current tool */
+ 		wacom_intuos_schedule_prox_event(wacom);
+ 		return 1;
+ 	}
+ 
+ 	/*
+ 	 * don't report events for invalid data
+ 	 */
+ 	/* older I4 styli don't work with new Cintiqs */
+ 	if ((!((wacom->id[idx] >> 20) & 0x01) &&
+ 			(features->type == WACOM_21UX2)) ||
+ 	    /* Only large Intuos support Lense Cursor */
+ 	    (wacom->tool[idx] == BTN_TOOL_LENS &&
+ 		(features->type == INTUOS3 ||
+ 		 features->type == INTUOS3S ||
+ 		 features->type == INTUOS4 ||
+ 		 features->type == INTUOS4S ||
+ 		 features->type == INTUOS5 ||
+ 		 features->type == INTUOS5S ||
+ 		 features->type == INTUOSPM ||
+ 		 features->type == INTUOSPS)) ||
+ 	   /* Cintiq doesn't send data when RDY bit isn't set */
+ 	   (features->type == CINTIQ && !(data[1] & 0x40)))
+ 		return 1;
+ 
+ 	x = (be16_to_cpup((__be16 *)&data[2]) << 1) | ((data[9] >> 1) & 1);
+ 	y = (be16_to_cpup((__be16 *)&data[4]) << 1) | (data[9] & 1);
+ 	distance = data[9] >> 2;
+ 	if (features->type < INTUOS3S) {
+ 		x >>= 1;
+ 		y >>= 1;
+ 		distance >>= 1;
+ 	}
+ 	input_report_abs(input, ABS_X, x);
+ 	input_report_abs(input, ABS_Y, y);
+ 	input_report_abs(input, ABS_DISTANCE, distance);
+ 
+ 	switch (type) {
+ 	case 0x00:
+ 	case 0x01:
+ 	case 0x02:
+ 	case 0x03:
+ 		/* general pen packet */
+ 		t = (data[6] << 3) | ((data[7] & 0xC0) >> 5) | (data[1] & 1);
+ 		if (features->pressure_max < 2047)
+ 			t >>= 1;
+ 		input_report_abs(input, ABS_PRESSURE, t);
+ 		if (features->type != INTUOSHT2) {
+ 		    input_report_abs(input, ABS_TILT_X,
+ 				 (((data[7] << 1) & 0x7e) | (data[8] >> 7)) - 64);
+ 		    input_report_abs(input, ABS_TILT_Y, (data[8] & 0x7f) - 64);
++>>>>>>> 4750f5fe293a (HID: wacom - make sure wacom_intuos_inout only process in/out events)
  		}
 +		input_report_abs(input, ABS_PRESSURE, t);
 +		input_report_abs(input, ABS_TILT_X,
 +				 (((data[7] << 1) & 0x7e) | (data[8] >> 7)) - 64);
 +		input_report_abs(input, ABS_TILT_Y, (data[8] & 0x7f) - 64);
  		input_report_key(input, BTN_STYLUS, data[1] & 2);
  		input_report_key(input, BTN_STYLUS2, data[1] & 4);
  		input_report_key(input, BTN_TOUCH, t > 10);
* Unmerged path drivers/hid/wacom_wac.c
