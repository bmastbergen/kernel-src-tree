perf record: Generate tracking events for process forked by perf

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Wang Nan <wangnan0@huawei.com>
commit be7b0c9e376e93a00b6c8631e2721e9dc7c6a1fa
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/be7b0c9e.failed

With 'perf record --switch-output' without -a, record__synthesize() in
record__switch_output() won't generate tracking events because there's
no thread_map in evlist. Which causes newly created perf.data doesn't
contain map and comm information.

This patch creates a fake thread_map and directly call
perf_event__synthesize_thread_map() for those events.

	Signed-off-by: Wang Nan <wangnan0@huawei.com>
	Tested-by: Arnaldo Carvalho de Melo <acme@redhat.com>
	Cc: Adrian Hunter <adrian.hunter@intel.com>
	Cc: Jiri Olsa <jolsa@redhat.com>
	Cc: Masami Hiramatsu <mhiramat@kernel.org>
	Cc: Namhyung Kim <namhyung@kernel.org>
	Cc: Zefan Li <lizefan@huawei.com>
	Cc: pi3orama@163.com
Link: http://lkml.kernel.org/r/1461178794-40467-8-git-send-email-wangnan0@huawei.com
	Signed-off-by: He Kuang <hekuang@huawei.com>
	Signed-off-by: Arnaldo Carvalho de Melo <acme@redhat.com>
(cherry picked from commit be7b0c9e376e93a00b6c8631e2721e9dc7c6a1fa)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/perf/builtin-record.c
diff --cc tools/perf/builtin-record.c
index 36b0c64985d1,f3679c44d3f3..000000000000
--- a/tools/perf/builtin-record.c
+++ b/tools/perf/builtin-record.c
@@@ -530,6 -500,25 +530,28 @@@ record__finish_output(struct record *re
  	return;
  }
  
++<<<<<<< HEAD
++=======
+ static int record__synthesize_workload(struct record *rec)
+ {
+ 	struct {
+ 		struct thread_map map;
+ 		struct thread_map_data map_data;
+ 	} thread_map;
+ 
+ 	thread_map.map.nr = 1;
+ 	thread_map.map.map[0].pid = rec->evlist->workload.pid;
+ 	thread_map.map.map[0].comm = NULL;
+ 	return perf_event__synthesize_thread_map(&rec->tool, &thread_map.map,
+ 						 process_synthesized_event,
+ 						 &rec->session->machines.host,
+ 						 rec->opts.sample_address,
+ 						 rec->opts.proc_map_timeout);
+ }
+ 
+ static int record__synthesize(struct record *rec);
+ 
++>>>>>>> be7b0c9e376e (perf record: Generate tracking events for process forked by perf)
  static int
  record__switch_output(struct record *rec, bool at_exit)
  {
@@@ -558,6 -547,23 +580,26 @@@
  	if (!quiet)
  		fprintf(stderr, "[ perf record: Dump %s.%s ]\n",
  			file->path, timestamp);
++<<<<<<< HEAD
++=======
+ 
+ 	/* Output tracking events */
+ 	if (!at_exit) {
+ 		record__synthesize(rec);
+ 
+ 		/*
+ 		 * In 'perf record --switch-output' without -a,
+ 		 * record__synthesize() in record__switch_output() won't
+ 		 * generate tracking events because there's no thread_map
+ 		 * in evlist. Which causes newly created perf.data doesn't
+ 		 * contain map and comm information.
+ 		 * Create a fake thread_map and directly call
+ 		 * perf_event__synthesize_thread_map() for those events.
+ 		 */
+ 		if (target__none(&rec->opts.target))
+ 			record__synthesize_workload(rec);
+ 	}
++>>>>>>> be7b0c9e376e (perf record: Generate tracking events for process forked by perf)
  	return fd;
  }
  
* Unmerged path tools/perf/builtin-record.c
