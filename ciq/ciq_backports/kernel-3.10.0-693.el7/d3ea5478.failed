rdma: fix buggy code that the compiler warns about

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Linus Torvalds <torvalds@linux-foundation.org>
commit d3ea547853852481dc5eba6d4cb13adab1564d0b
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/d3ea5478.failed

Get rid of this warning:

  drivers/infiniband/sw/rdmavt/cq.c: In function ‘rvt_cq_exit’:
  drivers/infiniband/sw/rdmavt/cq.c:542:2: warning: ‘worker’ may be used uninitialized in this function [-Wmaybe-uninitialized]
    kthread_destroy_worker(worker);
    ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

by fixing the function to actually work.

Fixes: 6efaf10f163d ("IB/rdmavt: Avoid queuing work into a destroyed cq kthread worker")
	Cc: Petr Mladek <pmladek@suse.com>
	Cc: Doug Ledford <dledford@redhat.com>
	Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
(cherry picked from commit d3ea547853852481dc5eba6d4cb13adab1564d0b)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/sw/rdmavt/cq.c
diff --cc drivers/infiniband/sw/rdmavt/cq.c
index 3bbc3f36d3d6,7aa7a4e312f1..000000000000
--- a/drivers/infiniband/sw/rdmavt/cq.c
+++ b/drivers/infiniband/sw/rdmavt/cq.c
@@@ -541,13 -530,15 +541,21 @@@ void rvt_cq_exit(struct rvt_dev_info *r
  {
  	struct kthread_worker *worker;
  
++<<<<<<< HEAD
 +	worker = rdi->worker;
 +	if (!worker)
++=======
+ 	/* block future queuing from send_complete() */
+ 	spin_lock_irq(&rdi->n_cqs_lock);
+ 	worker = rdi->worker;
+ 	if (!worker) {
+ 		spin_unlock_irq(&rdi->n_cqs_lock);
++>>>>>>> d3ea54785385 (rdma: fix buggy code that the compiler warns about)
  		return;
 -	}
 +	/* blocks future queuing from send_complete() */
  	rdi->worker = NULL;
 -	spin_unlock_irq(&rdi->n_cqs_lock);
 -
 -	kthread_destroy_worker(worker);
 +	smp_wmb(); /* See rdi_cq_enter */
 +	flush_kthread_worker(worker);
 +	kthread_stop(worker->task);
 +	kfree(worker);
  }
* Unmerged path drivers/infiniband/sw/rdmavt/cq.c
