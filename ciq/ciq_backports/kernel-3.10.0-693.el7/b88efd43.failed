dm mpath: delay the requeue of blk-mq requests while all paths down

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Mike Snitzer <snitzer@redhat.com>
commit b88efd43f900d608560211a18a38d450f8192948
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/b88efd43.failed

Return DM_MAPIO_DELAY_REQUEUE from .clone_and_map_rq.  Also, return
false from .busy, if all paths are down, so that blk-mq requests get
mapped via .clone_and_map_rq -- which results in DM_MAPIO_DELAY_REQUEUE
being returned to dm-rq.

This change allows for a noticeable reduction in cpu utilization
(reduced kworker load) while all paths are down, e.g.:

system CPU idleness (as measured by fio's --idle-prof=system):
before: system: 86.58%
after:  system: 98.60%

	Signed-off-by: Mike Snitzer <snitzer@redhat.com>
	Reviewed-by: Hannes Reinecke <hare@suse.com>
(cherry picked from commit b88efd43f900d608560211a18a38d450f8192948)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/md/dm-mpath.c
diff --cc drivers/md/dm-mpath.c
index 18be29ec3a10,f31fa1364abc..000000000000
--- a/drivers/md/dm-mpath.c
+++ b/drivers/md/dm-mpath.c
@@@ -469,9 -550,9 +469,15 @@@ static int __multipath_map(struct dm_ta
  		pgpath = choose_pgpath(m, nr_bytes);
  
  	if (!pgpath) {
++<<<<<<< HEAD
 +		if (!must_push_back(m))
 +			r = -EIO;	/* Failed */
 +		return r;
++=======
+ 		if (must_push_back_rq(m))
+ 			return DM_MAPIO_DELAY_REQUEUE;
+ 		return -EIO;	/* Failed */
++>>>>>>> b88efd43f900 (dm mpath: delay the requeue of blk-mq requests while all paths down)
  	} else if (test_bit(MPATHF_QUEUE_IO, &m->flags) ||
  		   test_bit(MPATHF_PG_INIT_REQUIRED, &m->flags)) {
  		pg_init_all_paths(m);
* Unmerged path drivers/md/dm-mpath.c
