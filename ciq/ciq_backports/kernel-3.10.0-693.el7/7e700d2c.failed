acpi/nfit: Fix memory corruption/Unregister mce decoder on failure

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
Rebuild_CHGLOG: - [acpi] nfit: Fix memory corruption/Unregister mce decoder on failure (Prarit Bhargava) [1448312]
Rebuild_FUZZ: 96.06%
commit-author Prarit Bhargava <prarit@redhat.com>
commit 7e700d2c59e5853c9126642976b4f5768f64c9b3
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/7e700d2c.failed

nfit_init() calls nfit_mce_register() on module load.  When the module
load fails the nfit mce decoder is not unregistered.  The module's
memory is freed leaving the decoder chain referencing junk.  This will
cause panics as future registrations will reference the free'd memory.

Unregister the nfit mce decoder on module init failure.

[v2]: register and then unregister mce handler to avoid losing mce events
[v3]: also cleanup nfit workqueue

Fixes: 6839a6d96f4e ("nfit: do an ARS scrub on hitting a latent media error")
	Cc: <stable@vger.kernel.org>
	Cc: "Rafael J. Wysocki" <rjw@rjwysocki.net>
	Cc: Len Brown <lenb@kernel.org>
	Cc: Vishal Verma <vishal.l.verma@intel.com>
	Cc: "Lee, Chun-Yi" <joeyli.kernel@gmail.com>
	Cc: Linda Knippers <linda.knippers@hpe.com>
	Cc: lszubowi@redhat.com
	Acked-by: Jeff Moyer <jmoyer@redhat.com>
	Signed-off-by: Prarit Bhargava <prarit@redhat.com>
	Reviewed-by: Vishal Verma <vishal.l.verma@intel.com>
	Signed-off-by: Dan Williams <dan.j.williams@intel.com>
(cherry picked from commit 7e700d2c59e5853c9126642976b4f5768f64c9b3)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/acpi/nfit.c
diff --cc drivers/acpi/nfit.c
index 274f71c0b7c6,19182d091587..000000000000
--- a/drivers/acpi/nfit.c
+++ b/drivers/acpi/nfit.c
@@@ -2882,7 -3188,15 +2884,19 @@@ static __init int nfit_init(void
  	if (!nfit_wq)
  		return -ENOMEM;
  
++<<<<<<< HEAD:drivers/acpi/nfit.c
 +	return acpi_bus_register_driver(&acpi_nfit_driver);
++=======
+ 	nfit_mce_register();
+ 	ret = acpi_bus_register_driver(&acpi_nfit_driver);
+ 	if (ret) {
+ 		nfit_mce_unregister();
+ 		destroy_workqueue(nfit_wq);
+ 	}
+ 
+ 	return ret;
+ 
++>>>>>>> 7e700d2c59e5 (acpi/nfit: Fix memory corruption/Unregister mce decoder on failure):drivers/acpi/nfit/core.c
  }
  
  static __exit void nfit_exit(void)
* Unmerged path drivers/acpi/nfit.c
