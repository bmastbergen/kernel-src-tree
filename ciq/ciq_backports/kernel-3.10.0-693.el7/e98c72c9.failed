amd-xgbe: Free channel/ring structures later

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Lendacky, Thomas <Thomas.Lendacky@amd.com>
commit e98c72c94205c59745f9ed0ac2837d5b83084a46
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/e98c72c9.failed

The channel structure is freed before freeing the per channel
interrupts resulting in a kernel oops. Move the call to free
the channel structure to after the freeing of the per channel
interrupts.

	Signed-off-by: Tom Lendacky <thomas.lendacky@amd.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit e98c72c94205c59745f9ed0ac2837d5b83084a46)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/amd/xgbe/xgbe-drv.c
diff --cc drivers/net/ethernet/amd/xgbe/xgbe-drv.c
index 6617129433bd,ec5fff38108d..000000000000
--- a/drivers/net/ethernet/amd/xgbe/xgbe-drv.c
+++ b/drivers/net/ethernet/amd/xgbe/xgbe-drv.c
@@@ -828,17 -1366,26 +828,37 @@@ static int xgbe_close(struct net_devic
  	/* Issue software reset to device */
  	hw_if->exit(pdata);
  
 -	/* Free the ring descriptors and buffers */
 +	/* Free all the ring data */
  	desc_if->free_ring_resources(pdata);
  
++<<<<<<< HEAD
 +	/* Release the interrupt */
 +	if (pdata->irq_number != 0) {
 +		devm_free_irq(pdata->dev, pdata->irq_number, pdata);
 +		pdata->irq_number = 0;
 +	}
 +
 +	/* Disable the clock */
 +	clk_disable_unprepare(pdata->sysclock);
++=======
+ 	/* Release the interrupts */
+ 	devm_free_irq(pdata->dev, pdata->dev_irq, pdata);
+ 	if (pdata->per_channel_irq) {
+ 		channel = pdata->channel;
+ 		for (i = 0; i < pdata->channel_count; i++, channel++)
+ 			devm_free_irq(pdata->dev, channel->dma_irq, channel);
+ 	}
+ 
+ 	/* Free the channel and ring structures */
+ 	xgbe_free_channels(pdata);
+ 
+ 	/* Disable the clocks */
+ 	clk_disable_unprepare(pdata->ptpclk);
+ 	clk_disable_unprepare(pdata->sysclk);
+ 
+ 	/* Release the phy */
+ 	xgbe_phy_exit(pdata);
++>>>>>>> e98c72c94205 (amd-xgbe: Free channel/ring structures later)
  
  	DBGPR("<--xgbe_close\n");
  
* Unmerged path drivers/net/ethernet/amd/xgbe/xgbe-drv.c
