qla2xxx: Correction to function qla26xx_dport_diagnostics().

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
Rebuild_CHGLOG: - [scsi] qla2xxx: Correction to function qla26xx_dport_diagnostics() (Chad Dupuis) [1384091]
Rebuild_FUZZ: 99.16%
commit-author Joe Carnuccio <joe.carnuccio@qlogic.com>
commit ef55e5133c3120ec07434b16d09a7c7f026d8c80
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/ef55e513.failed

	Signed-off-by: Joe Carnuccio <joe.carnuccio@qlogic.com>
	Signed-off-by: Himanshu Madhani <himanshu.madhani@qlogic.com>
	Reviewed-by: Hannes Reinecke <hare@suse.com>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit ef55e5133c3120ec07434b16d09a7c7f026d8c80)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/qla2xxx/qla_dbg.c
#	drivers/scsi/qla2xxx/qla_isr.c
#	drivers/scsi/qla2xxx/qla_mbx.c
diff --cc drivers/scsi/qla2xxx/qla_dbg.c
index 53a86c55945d,1a042702d34a..000000000000
--- a/drivers/scsi/qla2xxx/qla_dbg.c
+++ b/drivers/scsi/qla2xxx/qla_dbg.c
@@@ -11,16 -11,15 +11,25 @@@
   * ----------------------------------------------------------------------
   * |             Level            |   Last Value Used  |     Holes	|
   * ----------------------------------------------------------------------
++<<<<<<< HEAD
 + * | Module Init and Probe        |       0x018f       | 0x0146         |
 + * | Mailbox commands             |       0x1181       | 0x111a-0x111b  |
 + * |                              |                    | 0x1155-0x1158  |
 + * |                              |                    | 0x1018-0x1019  |
 + * |                              |                    | 0x1115-0x1116  |
 + * |                              |                    | 0x10ca         |
 + * | Device Discovery             |       0x2095       | 0x2020-0x2022, |
++=======
+  * | Module Init and Probe        |       0x0191       | 0x0146         |
+  * |                              |                    | 0x015b-0x0160	|
+  * |                              |                    | 0x016e		|
+  * | Mailbox commands             |       0x1196       | 0x1193		|
+  * |                              |                    |		|
+  * | Device Discovery             |       0x2003       | 0x2016		|
++>>>>>>> ef55e5133c31 (qla2xxx: Correction to function qla26xx_dport_diagnostics().)
   * |                              |                    | 0x2011-0x2012, |
   * |                              |                    | 0x2099-0x20a4  |
 - * | Queue Command and IO tracing |       0x3074       | 0x300b         |
 + * | Queue Command and IO tracing |       0x3075       | 0x300b         |
   * |                              |                    | 0x3027-0x3028  |
   * |                              |                    | 0x303d-0x3041  |
   * |                              |                    | 0x302d,0x3033  |
diff --cc drivers/scsi/qla2xxx/qla_isr.c
index 816b38009f31,4c800d6ad514..000000000000
--- a/drivers/scsi/qla2xxx/qla_isr.c
+++ b/drivers/scsi/qla2xxx/qla_isr.c
@@@ -1155,9 -1159,10 +1155,16 @@@ global_port_update
  
  	case MBA_DPORT_DIAGNOSTICS:
  		ql_dbg(ql_dbg_async, vha, 0x5052,
++<<<<<<< HEAD
 +		    "D-Port Diagnostics: %04x %04x=%s\n", mb[0], mb[1],
 +		    mb[1] == 0 ? "start" :
 +		    mb[1] == 1 ? "done (ok)" :
++=======
+ 		    "D-Port Diagnostics: %04x result=%s\n",
+ 		    mb[0],
+ 		    mb[1] == 0 ? "start" :
+ 		    mb[1] == 1 ? "done (pass)" :
++>>>>>>> ef55e5133c31 (qla2xxx: Correction to function qla26xx_dport_diagnostics().)
  		    mb[1] == 2 ? "done (error)" : "other");
  		break;
  
diff --cc drivers/scsi/qla2xxx/qla_mbx.c
index fbe27de90b21,bf16e6f5dbf5..000000000000
--- a/drivers/scsi/qla2xxx/qla_mbx.c
+++ b/drivers/scsi/qla2xxx/qla_mbx.c
@@@ -5489,3 -5748,54 +5489,57 @@@ qla2x00_dump_mctp_data(scsi_qla_host_t 
  
  	return rval;
  }
++<<<<<<< HEAD
++=======
+ 
+ int
+ qla26xx_dport_diagnostics(scsi_qla_host_t *vha,
+ 	void *dd_buf, uint size, uint options)
+ {
+ 	int rval;
+ 	mbx_cmd_t mc;
+ 	mbx_cmd_t *mcp = &mc;
+ 	dma_addr_t dd_dma;
+ 
+ 	if (!IS_QLA83XX(vha->hw) && !IS_QLA27XX(vha->hw))
+ 		return QLA_FUNCTION_FAILED;
+ 
+ 	ql_dbg(ql_dbg_mbx + ql_dbg_verbose, vha, 0x1192,
+ 	    "Entered %s.\n", __func__);
+ 
+ 	dd_dma = dma_map_single(&vha->hw->pdev->dev,
+ 	    dd_buf, size, DMA_FROM_DEVICE);
+ 	if (!dd_dma) {
+ 		ql_log(ql_log_warn, vha, 0x1194, "Failed to map dma buffer.\n");
+ 		return QLA_MEMORY_ALLOC_FAILED;
+ 	}
+ 
+ 	memset(dd_buf, 0, size);
+ 
+ 	mcp->mb[0] = MBC_DPORT_DIAGNOSTICS;
+ 	mcp->mb[1] = options;
+ 	mcp->mb[2] = MSW(LSD(dd_dma));
+ 	mcp->mb[3] = LSW(LSD(dd_dma));
+ 	mcp->mb[6] = MSW(MSD(dd_dma));
+ 	mcp->mb[7] = LSW(MSD(dd_dma));
+ 	mcp->mb[8] = size;
+ 	mcp->out_mb = MBX_8|MBX_7|MBX_6|MBX_3|MBX_2|MBX_1|MBX_0;
+ 	mcp->in_mb = MBX_3|MBX_2|MBX_1|MBX_0;
+ 	mcp->buf_size = size;
+ 	mcp->flags = MBX_DMA_IN;
+ 	mcp->tov = MBX_TOV_SECONDS * 4;
+ 	rval = qla2x00_mailbox_command(vha, mcp);
+ 
+ 	if (rval != QLA_SUCCESS) {
+ 		ql_dbg(ql_dbg_mbx, vha, 0x1195, "Failed=%x.\n", rval);
+ 	} else {
+ 		ql_dbg(ql_dbg_mbx + ql_dbg_verbose, vha, 0x1196,
+ 		    "Done %s.\n", __func__);
+ 	}
+ 
+ 	dma_unmap_single(&vha->hw->pdev->dev, dd_dma,
+ 	    size, DMA_FROM_DEVICE);
+ 
+ 	return rval;
+ }
++>>>>>>> ef55e5133c31 (qla2xxx: Correction to function qla26xx_dport_diagnostics().)
* Unmerged path drivers/scsi/qla2xxx/qla_dbg.c
* Unmerged path drivers/scsi/qla2xxx/qla_isr.c
* Unmerged path drivers/scsi/qla2xxx/qla_mbx.c
