dm error: add DAX support

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Mike Snitzer <snitzer@redhat.com>
commit f8df1fdf18839cb4ef2035310bb9b6ec02025598
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/f8df1fdf.failed

Allow the error target to replace an existing DAX-enabled target.

	Signed-off-by: Mike Snitzer <snitzer@redhat.com>
(cherry picked from commit f8df1fdf18839cb4ef2035310bb9b6ec02025598)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/md/dm-table.c
diff --cc drivers/md/dm-table.c
index 15241060f605,3e407a9cde1f..000000000000
--- a/drivers/md/dm-table.c
+++ b/drivers/md/dm-table.c
@@@ -880,6 -922,9 +880,12 @@@ static int dm_table_set_type(struct dm_
  	if (bio_based) {
  		/* We must use this table as bio-based */
  		t->type = DM_TYPE_BIO_BASED;
++<<<<<<< HEAD
++=======
+ 		if (dm_table_supports_dax(t) ||
+ 		    (list_empty(devices) && live_md_type == DM_TYPE_DAX_BIO_BASED))
+ 			t->type = DM_TYPE_DAX_BIO_BASED;
++>>>>>>> f8df1fdf1883 (dm error: add DAX support)
  		return 0;
  	}
  
* Unmerged path drivers/md/dm-table.c
diff --git a/drivers/md/dm-target.c b/drivers/md/dm-target.c
index 5c826b450aad..6eecd6b36f76 100644
--- a/drivers/md/dm-target.c
+++ b/drivers/md/dm-target.c
@@ -148,9 +148,15 @@ static void io_err_release_clone_rq(struct request *clone)
 {
 }
 
+static long io_err_direct_access(struct dm_target *ti, sector_t sector,
+				 void __pmem **kaddr, pfn_t *pfn, long size)
+{
+	return -EIO;
+}
+
 static struct target_type error_target = {
 	.name = "error",
-	.version = {1, 4, 0},
+	.version = {1, 5, 0},
 	.features = DM_TARGET_WILDCARD,
 	.ctr  = io_err_ctr,
 	.dtr  = io_err_dtr,
@@ -158,6 +164,7 @@ static struct target_type error_target = {
 	.map_rq = io_err_map_rq,
 	.clone_and_map_rq = io_err_clone_and_map_rq,
 	.release_clone_rq = io_err_release_clone_rq,
+	.direct_access = io_err_direct_access,
 };
 
 int __init dm_target_init(void)
