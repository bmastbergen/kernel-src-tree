perf tools: Uninline scnprintf() and vscnprint()

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Arnaldo Carvalho de Melo <acme@redhat.com>
commit d0761e37fe3fed7810ed8d6e130b79359f0c3e13
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/d0761e37.failed

They were in tools/include/linux/kernel.h, requiring that it in turn
included stdio.h, which is way too heavy.

	Cc: Adrian Hunter <adrian.hunter@intel.com>
	Cc: David Ahern <dsahern@gmail.com>
	Cc: Jiri Olsa <jolsa@kernel.org>
	Cc: Josh Poimboeuf <jpoimboe@redhat.com>
	Cc: Namhyung Kim <namhyung@kernel.org>
	Cc: Wang Nan <wangnan0@huawei.com>
Link: http://lkml.kernel.org/n/tip-855h8olnkot9v0dajuee1lo3@git.kernel.org
	Signed-off-by: Arnaldo Carvalho de Melo <acme@redhat.com>
(cherry picked from commit d0761e37fe3fed7810ed8d6e130b79359f0c3e13)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/perf/MANIFEST
#	tools/perf/util/color.c
#	tools/perf/util/help-unknown-cmd.c
#	tools/perf/util/python-ext-sources
diff --cc tools/perf/MANIFEST
index 142f4758781a,2bd8c310606c..000000000000
--- a/tools/perf/MANIFEST
+++ b/tools/perf/MANIFEST
@@@ -27,6 -29,8 +27,11 @@@ tools/lib/symbol/kallsyms.
  tools/lib/symbol/kallsyms.h
  tools/lib/find_bit.c
  tools/lib/bitmap.c
++<<<<<<< HEAD
++=======
+ tools/lib/str_error_r.c
+ tools/lib/vsprintf.c
++>>>>>>> d0761e37fe3f (perf tools: Uninline scnprintf() and vscnprint())
  tools/include/asm/atomic.h
  tools/include/asm/barrier.h
  tools/include/asm/bug.h
diff --cc tools/perf/util/color.c
index bae74f7880ea,dbbf89b050a5..000000000000
--- a/tools/perf/util/color.c
+++ b/tools/perf/util/color.c
@@@ -1,5 -1,8 +1,11 @@@
  #include <linux/kernel.h>
  #include "cache.h"
++<<<<<<< HEAD
++=======
+ #include "config.h"
+ #include <stdlib.h>
+ #include <stdio.h>
++>>>>>>> d0761e37fe3f (perf tools: Uninline scnprintf() and vscnprint())
  #include "color.h"
  #include <math.h>
  #include <unistd.h>
diff --cc tools/perf/util/help-unknown-cmd.c
index d62ccaeeadd6,2821f8d77e52..000000000000
--- a/tools/perf/util/help-unknown-cmd.c
+++ b/tools/perf/util/help-unknown-cmd.c
@@@ -1,4 -1,6 +1,9 @@@
  #include "cache.h"
++<<<<<<< HEAD
++=======
+ #include "config.h"
+ #include <stdio.h>
++>>>>>>> d0761e37fe3f (perf tools: Uninline scnprintf() and vscnprint())
  #include <subcmd/help.h>
  #include "../builtin.h"
  #include "levenshtein.h"
diff --cc tools/perf/util/python-ext-sources
index 8162ba0e2e57,5065ec98049c..000000000000
--- a/tools/perf/util/python-ext-sources
+++ b/tools/perf/util/python-ext-sources
@@@ -13,6 -13,8 +13,11 @@@ util/cpumap.
  ../lib/bitmap.c
  ../lib/find_bit.c
  ../lib/hweight.c
++<<<<<<< HEAD
++=======
+ ../lib/str_error_r.c
+ ../lib/vsprintf.c
++>>>>>>> d0761e37fe3f (perf tools: Uninline scnprintf() and vscnprint())
  util/thread_map.c
  util/util.c
  util/xyarray.c
diff --git a/tools/include/linux/kernel.h b/tools/include/linux/kernel.h
index 76df53539c2a..28607db02bd3 100644
--- a/tools/include/linux/kernel.h
+++ b/tools/include/linux/kernel.h
@@ -2,8 +2,7 @@
 #define __TOOLS_LINUX_KERNEL_H
 
 #include <stdarg.h>
-#include <stdio.h>
-#include <stdlib.h>
+#include <stddef.h>
 #include <assert.h>
 
 #define DIV_ROUND_UP(n,d) (((n) + (d) - 1) / (d))
@@ -70,29 +69,8 @@
 #define cpu_to_le64(x)	(x)
 #define cpu_to_le32(x)	(x)
 
-static inline int
-vscnprintf(char *buf, size_t size, const char *fmt, va_list args)
-{
-	int i;
-	ssize_t ssize = size;
-
-	i = vsnprintf(buf, size, fmt, args);
-
-	return (i >= ssize) ? (ssize - 1) : i;
-}
-
-static inline int scnprintf(char * buf, size_t size, const char * fmt, ...)
-{
-	va_list args;
-	ssize_t ssize = size;
-	int i;
-
-	va_start(args, fmt);
-	i = vsnprintf(buf, size, fmt, args);
-	va_end(args);
-
-	return (i >= ssize) ? (ssize - 1) : i;
-}
+int vscnprintf(char *buf, size_t size, const char *fmt, va_list args);
+int scnprintf(char * buf, size_t size, const char * fmt, ...);
 
 /*
  * This looks more complex than it should be. But we need to
diff --git a/tools/lib/vsprintf.c b/tools/lib/vsprintf.c
new file mode 100644
index 000000000000..45f9a06daa56
--- /dev/null
+++ b/tools/lib/vsprintf.c
@@ -0,0 +1,24 @@
+#include <sys/types.h>
+#include <linux/kernel.h>
+#include <stdio.h>
+
+int vscnprintf(char *buf, size_t size, const char *fmt, va_list args)
+{
+       int i = vsnprintf(buf, size, fmt, args);
+       ssize_t ssize = size;
+
+       return (i >= ssize) ? (ssize - 1) : i;
+}
+
+int scnprintf(char * buf, size_t size, const char * fmt, ...)
+{
+       ssize_t ssize = size;
+       va_list args;
+       int i;
+
+       va_start(args, fmt);
+       i = vsnprintf(buf, size, fmt, args);
+       va_end(args);
+
+       return (i >= ssize) ? (ssize - 1) : i;
+}
diff --git a/tools/objtool/builtin-check.c b/tools/objtool/builtin-check.c
index e8a1e69eb92c..92d84b277032 100644
--- a/tools/objtool/builtin-check.c
+++ b/tools/objtool/builtin-check.c
@@ -26,6 +26,7 @@
  */
 
 #include <string.h>
+#include <stdlib.h>
 #include <subcmd/parse-options.h>
 
 #include "builtin.h"
* Unmerged path tools/perf/MANIFEST
diff --git a/tools/perf/util/Build b/tools/perf/util/Build
index d2916db4930b..a37a10cc71b6 100644
--- a/tools/perf/util/Build
+++ b/tools/perf/util/Build
@@ -82,6 +82,7 @@ libperf-y += parse-regs-options.o
 libperf-y += term.o
 libperf-y += help-unknown-cmd.o
 libperf-y += mem-events.o
+libperf-y += vsprintf.o
 
 libperf-$(CONFIG_LIBELF) += symbol-elf.o
 libperf-$(CONFIG_LIBELF) += probe-file.o
@@ -172,3 +173,7 @@ $(OUTPUT)util/libstring.o: ../lib/string.c FORCE
 $(OUTPUT)util/hweight.o: ../lib/hweight.c FORCE
 	$(call rule_mkdir)
 	$(call if_changed_dep,cc_o_c)
+
+$(OUTPUT)util/vsprintf.o: ../lib/vsprintf.c FORCE
+	$(call rule_mkdir)
+	$(call if_changed_dep,cc_o_c)
* Unmerged path tools/perf/util/color.c
diff --git a/tools/perf/util/dso.h b/tools/perf/util/dso.h
index a571f24895ca..ecc4bbd3f82e 100644
--- a/tools/perf/util/dso.h
+++ b/tools/perf/util/dso.h
@@ -4,6 +4,7 @@
 #include <linux/atomic.h>
 #include <linux/types.h>
 #include <linux/rbtree.h>
+#include <sys/types.h>
 #include <stdbool.h>
 #include <pthread.h>
 #include <linux/types.h>
* Unmerged path tools/perf/util/help-unknown-cmd.c
* Unmerged path tools/perf/util/python-ext-sources
