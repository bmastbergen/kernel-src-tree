scsi: megaraid_sas: cpu select rework.

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
Rebuild_CHGLOG: - [scsi] megaraid_sas: cpu select rework (Tomas Henzl) [1417038]
Rebuild_FUZZ: 89.86%
commit-author Shivasharan S <shivasharan.srikanteshwara@broadcom.com>
commit f6c0d55c5b91c0d626d65aebee1a0d6b0a61851d
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/f6c0d55c.failed

No functional change. Code refactor.

	Signed-off-by: Shivasharan S <shivasharan.srikanteshwara@broadcom.com>
	Signed-off-by: Kashyap Desai <kashyap.desai@broadcom.com>
	Reviewed-by: Hannes Reinecke <hare@suse.com>
	Reviewed-by: Tomas Henzl <thenzl@redhat.com>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit f6c0d55c5b91c0d626d65aebee1a0d6b0a61851d)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/megaraid/megaraid_sas_fusion.c
diff --cc drivers/scsi/megaraid/megaraid_sas_fusion.c
index 052f0ebb7f67,514c306ccca0..000000000000
--- a/drivers/scsi/megaraid/megaraid_sas_fusion.c
+++ b/drivers/scsi/megaraid/megaraid_sas_fusion.c
@@@ -1831,8 -1899,10 +1898,15 @@@ megasas_build_ldio_fusion(struct megasa
  			  struct scsi_cmnd *scp,
  			  struct megasas_cmd_fusion *cmd)
  {
++<<<<<<< HEAD
 +	u8 fp_possible;
 +	u32 start_lba_lo, start_lba_hi, device_id, datalength = 0;
++=======
+ 	bool fp_possible;
+ 	u16 ld;
+ 	u32 start_lba_lo, start_lba_hi, device_id, datalength = 0;
+ 	u32 scsi_buff_len;
++>>>>>>> f6c0d55c5b91 (scsi: megaraid_sas: cpu select rework.)
  	struct MPI2_RAID_SCSI_IO_REQUEST *io_request;
  	union MEGASAS_REQUEST_DESCRIPTOR_UNION *req_desc;
  	struct IO_REQUEST_INFO io_info;
@@@ -1840,6 -1910,9 +1914,12 @@@
  	struct MR_DRV_RAID_MAP_ALL *local_map_ptr;
  	u8 *raidLUN;
  	unsigned long spinlock_flags;
++<<<<<<< HEAD
++=======
+ 	union RAID_CONTEXT_UNION *praid_context;
+ 	struct MR_LD_RAID *raid = NULL;
+ 	struct MR_PRIV_DEVICE *mrdev_priv;
++>>>>>>> f6c0d55c5b91 (scsi: megaraid_sas: cpu select rework.)
  
  	device_id = MEGASAS_DEV_INDEX(scp);
  
@@@ -1921,8 -1995,10 +2002,13 @@@
  
  	if ((MR_TargetIdToLdGet(device_id, local_map_ptr) >=
  		instance->fw_supported_vd_count) || (!fusion->fast_path_io)) {
++<<<<<<< HEAD
 +		io_request->RaidContext.raid_context.regLockFlags  = 0;
 +		fp_possible = 0;
++=======
+ 		io_request->RaidContext.raid_context.reg_lock_flags  = 0;
+ 		fp_possible = false;
++>>>>>>> f6c0d55c5b91 (scsi: megaraid_sas: cpu select rework.)
  	} else {
  		if (MR_BuildRaidContext(instance, &io_info,
  					&io_request->RaidContext.raid_context,
@@@ -1943,11 -2021,29 +2031,32 @@@
  		/* In ventura if stream detected for a read and it is read ahead
  		 *  capable make this IO as LDIO
  		 */
- 		if (io_request->RaidContext.raid_context_g35.stream_detected &&
- 				io_info.isRead && io_info.ra_capable)
+ 		if (praid_context->raid_context_g35.stream_detected &&
+ 		    io_info.isRead && io_info.ra_capable)
  			fp_possible = false;
+ 
++<<<<<<< HEAD
++=======
+ 		if (io_info.r1_alt_dev_handle != MR_PD_INVALID) {
+ 			mrdev_priv = scp->device->hostdata;
+ 
+ 			if (atomic_inc_return(&instance->fw_outstanding) >
+ 				(instance->host->can_queue)) {
+ 				fp_possible = false;
+ 				atomic_dec(&instance->fw_outstanding);
+ 			}
+ 		}
+ 
+ 		/* If raid is NULL, set CPU affinity to default CPU0 */
+ 		if (raid)
+ 			megasas_set_raidflag_cpu_affinity(praid_context,
+ 				raid, fp_possible, io_info.isRead);
+ 		else
+ 			praid_context->raid_context_g35.routing_flags.bits.cpu_sel =
+ 				MR_RAID_CTX_CPUSEL_0;
  	}
  
++>>>>>>> f6c0d55c5b91 (scsi: megaraid_sas: cpu select rework.)
  	if (fp_possible) {
  		megasas_set_pd_lba(io_request, scp->cmd_len, &io_info, scp,
  				   local_map_ptr, start_lba_lo);
@@@ -2017,6 -2127,12 +2126,10 @@@
  		}
  		io_request->Function = MEGASAS_MPI2_FUNCTION_LD_IO_REQUEST;
  		io_request->DevHandle = cpu_to_le16(device_id);
++<<<<<<< HEAD
++=======
+ 
++>>>>>>> f6c0d55c5b91 (scsi: megaraid_sas: cpu select rework.)
  	} /* Not FP */
  }
  
* Unmerged path drivers/scsi/megaraid/megaraid_sas_fusion.c
