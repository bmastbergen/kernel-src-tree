selinux: Clean up initialization of isec->sclass

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Andreas Gruenbacher <agruenba@redhat.com>
commit 13457d073c29da92001f6ee809075eaa8757fb96
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/13457d07.failed

Now that isec->initialized == LABEL_INITIALIZED implies that
isec->sclass is valid, skip such inodes immediately in
inode_doinit_with_dentry.

For the remaining inodes, initialize isec->sclass at the beginning of
inode_doinit_with_dentry to simplify the code.

	Signed-off-by: Andreas Gruenbacher <agruenba@redhat.com>
	Signed-off-by: Paul Moore <paul@paul-moore.com>
(cherry picked from commit 13457d073c29da92001f6ee809075eaa8757fb96)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	security/selinux/hooks.c
diff --cc security/selinux/hooks.c
index 906e71910cfe,2a506861a772..000000000000
--- a/security/selinux/hooks.c
+++ b/security/selinux/hooks.c
@@@ -1249,13 -1389,16 +1249,21 @@@ static int inode_doinit_with_dentry(str
  	unsigned len = 0;
  	int rc = 0;
  
++<<<<<<< HEAD
 +	if (isec->initialized)
 +		goto out;
++=======
+ 	if (isec->initialized == LABEL_INITIALIZED)
+ 		return 0;
++>>>>>>> 13457d073c29 (selinux: Clean up initialization of isec->sclass)
  
  	mutex_lock(&isec->lock);
 -	if (isec->initialized == LABEL_INITIALIZED)
 +	if (isec->initialized)
  		goto out_unlock;
  
+ 	if (isec->sclass == SECCLASS_FILE)
+ 		isec->sclass = inode_mode_to_security_class(inode->i_mode);
+ 
  	sbsec = inode->i_sb->s_security;
  	if (!(sbsec->flags & SE_SBINITIALIZED)) {
  		/* Defer initialization until selinux_complete_init,
@@@ -1414,8 -1551,8 +1421,13 @@@
  			 */
  			if (!dentry)
  				goto out_unlock;
++<<<<<<< HEAD
 +			isec->sclass = inode_mode_to_security_class(inode->i_mode);
 +			rc = selinux_proc_get_sid(dentry, isec->sclass, &sid);
++=======
+ 			rc = selinux_genfs_get_sid(dentry, isec->sclass,
+ 						   sbsec->flags, &sid);
++>>>>>>> 13457d073c29 (selinux: Clean up initialization of isec->sclass)
  			dput(dentry);
  			if (rc)
  				goto out_unlock;
* Unmerged path security/selinux/hooks.c
