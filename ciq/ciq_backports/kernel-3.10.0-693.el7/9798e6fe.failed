net: act_mirred: allow statistic updates from offloaded actions

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
Rebuild_CHGLOG: - [net] sched: act_mirred: allow statistic updates from offloaded actions (Ivan Vecera) [1455296]
Rebuild_FUZZ: 95.31%
commit-author Jakub Kicinski <jakub.kicinski@netronome.com>
commit 9798e6fe4f9b6a2847a40e24b75e68afdc7a01b3
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/9798e6fe.failed

Implement .stats_update() callback.  The implementation
is generic and can be reused by other simple actions if
needed.

	Signed-off-by: Jakub Kicinski <jakub.kicinski@netronome.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 9798e6fe4f9b6a2847a40e24b75e68afdc7a01b3)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/sched/act_mirred.c
diff --cc net/sched/act_mirred.c
index 4b6188539f6c,667dc382df82..000000000000
--- a/net/sched/act_mirred.c
+++ b/net/sched/act_mirred.c
@@@ -212,10 -204,18 +212,22 @@@ out
  	return retval;
  }
  
++<<<<<<< HEAD
 +static int tcf_mirred_dump(struct sk_buff *skb, struct tc_action *a, int bind, int ref)
++=======
+ static void tcf_stats_update(struct tc_action *a, u64 bytes, u32 packets,
+ 			     u64 lastuse)
+ {
+ 	tcf_lastuse_update(&a->tcfa_tm);
+ 	_bstats_cpu_update(this_cpu_ptr(a->cpu_bstats), bytes, packets);
+ }
+ 
+ static int tcf_mirred_dump(struct sk_buff *skb, struct tc_action *a, int bind,
+ 			   int ref)
++>>>>>>> 9798e6fe4f9b (net: act_mirred: allow statistic updates from offloaded actions)
  {
  	unsigned char *b = skb_tail_pointer(skb);
 -	struct tcf_mirred *m = to_mirred(a);
 +	struct tcf_mirred *m = a->priv;
  	struct tc_mirred opt = {
  		.index   = m->tcf_index,
  		.action  = m->tcf_action,
@@@ -263,17 -283,39 +275,18 @@@ static struct notifier_block mirred_dev
  	.notifier_call = mirred_device_event,
  };
  
 +
  static struct tc_action_ops act_mirred_ops = {
  	.kind		=	"mirred",
 +	.hinfo		=	&mirred_hash_info,
  	.type		=	TCA_ACT_MIRRED,
 +	.capab		=	TCA_CAP_NONE,
  	.owner		=	THIS_MODULE,
  	.act		=	tcf_mirred,
+ 	.stats_update	=	tcf_stats_update,
  	.dump		=	tcf_mirred_dump,
 -	.cleanup	=	tcf_mirred_release,
 +	.cleanup	=	tcf_mirred_cleanup,
  	.init		=	tcf_mirred_init,
 -	.walk		=	tcf_mirred_walker,
 -	.lookup		=	tcf_mirred_search,
 -	.size		=	sizeof(struct tcf_mirred),
 -};
 -
 -static __net_init int mirred_init_net(struct net *net)
 -{
 -	struct tc_action_net *tn = net_generic(net, mirred_net_id);
 -
 -	return tc_action_net_init(tn, &act_mirred_ops, MIRRED_TAB_MASK);
 -}
 -
 -static void __net_exit mirred_exit_net(struct net *net)
 -{
 -	struct tc_action_net *tn = net_generic(net, mirred_net_id);
 -
 -	tc_action_net_exit(tn);
 -}
 -
 -static struct pernet_operations mirred_net_ops = {
 -	.init = mirred_init_net,
 -	.exit = mirred_exit_net,
 -	.id   = &mirred_net_id,
 -	.size = sizeof(struct tc_action_net),
  };
  
  MODULE_AUTHOR("Jamal Hadi Salim(2002)");
* Unmerged path net/sched/act_mirred.c
