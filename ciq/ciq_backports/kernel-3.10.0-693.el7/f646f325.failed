scsi: ipr: Error path locking fixes

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
Rebuild_CHGLOG: - [scsi] ipr: Error path locking fixes (Gustavo Duarte) [1406512]
Rebuild_FUZZ: 90.62%
commit-author Brian King <brking@linux.vnet.ibm.com>
commit f646f325a829d73abc708088d2b67cd11b775fdf
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/f646f325.failed

This patch closes up some potential race conditions observed in the
error handling paths in ipr while debugging an issue resulting in a hang
with SATA error handling. These patches ensure we are holding the
correct lock when adding and removing commands from the free and pending
queues in some error scenarios.

	Signed-off-by: Brian King <brking@linux.vnet.ibm.com>
	Reviewed-by: Wendy Xiong <wenxiong@linux.vnet.ibm.com>
	Tested-by: Wendy Xiong <wenxiong@linux.vnet.ibm.com>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit f646f325a829d73abc708088d2b67cd11b775fdf)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/ipr.c
diff --cc drivers/scsi/ipr.c
index 3c1f0fe0f139,95f1e6457664..000000000000
--- a/drivers/scsi/ipr.c
+++ b/drivers/scsi/ipr.c
@@@ -5910,36 -5988,7 +5950,40 @@@ static int ipr_build_ioadl(struct ipr_i
  }
  
  /**
++<<<<<<< HEAD
 + * ipr_get_task_attributes - Translate SPI Q-Tag to task attributes
 + * @scsi_cmd:	scsi command struct
 + *
 + * Return value:
 + * 	task attributes
 + **/
 +static u8 ipr_get_task_attributes(struct scsi_cmnd *scsi_cmd)
 +{
 +	u8 tag[2];
 +	u8 rc = IPR_FLAGS_LO_UNTAGGED_TASK;
 +
 +	if (scsi_populate_tag_msg(scsi_cmd, tag)) {
 +		switch (tag[0]) {
 +		case MSG_SIMPLE_TAG:
 +			rc = IPR_FLAGS_LO_SIMPLE_TASK;
 +			break;
 +		case MSG_HEAD_TAG:
 +			rc = IPR_FLAGS_LO_HEAD_OF_Q_TASK;
 +			break;
 +		case MSG_ORDERED_TAG:
 +			rc = IPR_FLAGS_LO_ORDERED_TASK;
 +			break;
 +		};
 +	}
 +
 +	return rc;
 +}
 +
 +/**
 + * ipr_erp_done - Process completion of ERP for a device
++=======
+  * __ipr_erp_done - Process completion of ERP for a device
++>>>>>>> f646f325a829 (scsi: ipr: Error path locking fixes)
   * @ipr_cmd:		ipr command struct
   *
   * This function copies the sense buffer into the scsi_cmd
@@@ -6064,8 -6153,8 +6148,13 @@@ static void ipr_erp_cancel_all(struct i
  
  	ipr_reinit_ipr_cmnd_for_erp(ipr_cmd);
  
++<<<<<<< HEAD
 +	if (!scsi_get_tag_type(scsi_cmd->device)) {
 +		ipr_erp_request_sense(ipr_cmd);
++=======
+ 	if (!scsi_cmd->device->simple_tags) {
+ 		__ipr_erp_request_sense(ipr_cmd);
++>>>>>>> f646f325a829 (scsi: ipr: Error path locking fixes)
  		return;
  	}
  
* Unmerged path drivers/scsi/ipr.c
