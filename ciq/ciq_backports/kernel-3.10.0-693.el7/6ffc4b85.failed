hv: change clockevents unbind tactics

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
Rebuild_CHGLOG: - [hv] change clockevents unbind tactics (Vitaly Kuznetsov) [1396335]
Rebuild_FUZZ: 94.29%
commit-author Vitaly Kuznetsov <vkuznets@redhat.com>
commit 6ffc4b85358f6b7d252420cfa5862312cf5f83d8
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/6ffc4b85.failed

To get prepared to CPU offlining support we need co change the way how we
unbind clockevent devices. As one CPU may go online/offline multiple times
we need to bind it in hv_synic_init() and unbind it in hv_synic_cleanup().
There is an additional corner case: when we unload the module completely we
need to switch to some other clockevent mechanism before stopping VMBus or
we will hang. We can't call hv_synic_cleanup() before unloading VMBus as
we won't be able to send UNLOAD request and get a response so
hv_synic_clockevents_cleanup() has to live. Luckily, we can always call
clockevents_unbind_device(), even if it wasn't bound before and there is
no issue if we call it twice.

	Signed-off-by: Vitaly Kuznetsov <vkuznets@redhat.com>
	Signed-off-by: K. Y. Srinivasan <kys@microsoft.com>
	Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
(cherry picked from commit 6ffc4b85358f6b7d252420cfa5862312cf5f83d8)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/hv/hv.c
diff --cc drivers/hv/hv.c
index 2feae8a946d0,446802ae8f1b..000000000000
--- a/drivers/hv/hv.c
+++ b/drivers/hv/hv.c
@@@ -600,9 -594,10 +600,16 @@@ void hv_synic_cleanup(void *arg
  		return;
  
  	/* Turn off clockevent device */
++<<<<<<< HEAD
 +	if (ms_hyperv.features & HV_X64_MSR_SYNTIMER_AVAILABLE)
 +		hv_ce_setmode(CLOCK_EVT_MODE_SHUTDOWN,
 +			      hv_context.clk_evt[cpu]);
++=======
+ 	if (ms_hyperv.features & HV_X64_MSR_SYNTIMER_AVAILABLE) {
+ 		clockevents_unbind_device(hv_context.clk_evt[cpu], cpu);
+ 		hv_ce_shutdown(hv_context.clk_evt[cpu]);
+ 	}
++>>>>>>> 6ffc4b85358f (hv: change clockevents unbind tactics)
  
  	rdmsrl(HV_X64_MSR_SINT0 + VMBUS_MESSAGE_SINT, shared_sint.as_uint64);
  
* Unmerged path drivers/hv/hv.c
