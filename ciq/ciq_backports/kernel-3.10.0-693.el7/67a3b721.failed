NFSv4.1/pnfs: Layout stateids start out as being invalid

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Trond Myklebust <trond.myklebust@primarydata.com>
commit 67a3b721462c9b3bdc36ad6a583f41706402b3ea
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/67a3b721.failed

	Signed-off-by: Trond Myklebust <trond.myklebust@primarydata.com>
	Reviewed-by: Jeff Layton <jlayton@poochiereds.net>
	Signed-off-by: Anna Schumaker <Anna.Schumaker@Netapp.com>
(cherry picked from commit 67a3b721462c9b3bdc36ad6a583f41706402b3ea)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/nfs/pnfs.c
diff --cc fs/nfs/pnfs.c
index 4d9339084474,f619139621ec..000000000000
--- a/fs/nfs/pnfs.c
+++ b/fs/nfs/pnfs.c
@@@ -1559,9 -1548,28 +1560,34 @@@ lookup_again
  		goto out_unlock;
  	}
  
++<<<<<<< HEAD
 +	first = list_empty(&lo->plh_segs);
 +	if (first) {
 +		/* The first layoutget for the file. Need to serialize per
++=======
+ 	lseg = pnfs_find_lseg(lo, &arg, strict_iomode);
+ 	if (lseg) {
+ 		trace_pnfs_update_layout(ino, pos, count, iomode, lo, lseg,
+ 				PNFS_UPDATE_LAYOUT_FOUND_CACHED);
+ 		goto out_unlock;
+ 	}
+ 
+ 	if (!nfs4_valid_open_stateid(ctx->state)) {
+ 		trace_pnfs_update_layout(ino, pos, count, iomode, lo, lseg,
+ 				PNFS_UPDATE_LAYOUT_INVALID_OPEN);
+ 		goto out_unlock;
+ 	}
+ 
+ 	/*
+ 	 * Choose a stateid for the LAYOUTGET. If we don't have a layout
+ 	 * stateid, or it has been invalidated, then we must use the open
+ 	 * stateid.
+ 	 */
+ 	if (test_bit(NFS_LAYOUT_INVALID_STID, &lo->plh_flags)) {
+ 
+ 		/*
+ 		 * The first layoutget for the file. Need to serialize per
++>>>>>>> 67a3b721462c (NFSv4.1/pnfs: Layout stateids start out as being invalid)
  		 * RFC 5661 Errata 3208.
  		 */
  		if (test_and_set_bit(NFS_LAYOUT_FIRST_LAYOUTGET,
* Unmerged path fs/nfs/pnfs.c
