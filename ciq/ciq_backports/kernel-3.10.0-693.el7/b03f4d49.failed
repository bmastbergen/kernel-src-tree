platform/x86: thinkpad_acpi: Add support for X1 Yoga (2016) Tablet Mode

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
Rebuild_CHGLOG: - [platform] x86: thinkpad_acpi: Add support for X1 Yoga (2016) Tablet Mode (Lyude Paul) [1389438]
Rebuild_FUZZ: 93.23%
commit-author Lyude <lyude@redhat.com>
commit b03f4d49469f3bde9600192af15b8f17f8673679
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/b03f4d49.failed

For whatever reason, the X1 Yoga doesn't support the normal method of
querying for tablet mode. Instead of providing the MHKG method under the
hotkey handle, we're instead given the CMMD method under the EC handle.
Values on this handle are either 0x1, laptop mode, or 0x6, tablet mode.

	Tested-by: Daniel Martin <consume.noise@gmail.com>
	Signed-off-by: Lyude <lyude@redhat.com>
	Signed-off-by: Darren Hart <dvhart@linux.intel.com>
(cherry picked from commit b03f4d49469f3bde9600192af15b8f17f8673679)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/platform/x86/thinkpad_acpi.c
diff --cc drivers/platform/x86/thinkpad_acpi.c
index 6d5105235fe6,cd956de7c1b2..000000000000
--- a/drivers/platform/x86/thinkpad_acpi.c
+++ b/drivers/platform/x86/thinkpad_acpi.c
@@@ -306,7 -305,13 +309,17 @@@ static struct 
  	u32 hotkey:1;
  	u32 hotkey_mask:1;
  	u32 hotkey_wlsw:1;
++<<<<<<< HEAD
 +	u32 hotkey_tablet:1;
++=======
+ 	enum {
+ 		TP_HOTKEY_TABLET_NONE = 0,
+ 		TP_HOTKEY_TABLET_USES_MHKG,
+ 		/* X1 Yoga 2016, seen on BIOS N1FET44W */
+ 		TP_HOTKEY_TABLET_USES_CMMD,
+ 	} hotkey_tablet;
+ 	u32 kbdlight:1;
++>>>>>>> b03f4d49469f (platform/x86: thinkpad_acpi: Add support for X1 Yoga (2016) Tablet Mode)
  	u32 light:1;
  	u32 light_status:1;
  	u32 bright_acpimode:1;
@@@ -3146,6 -3140,37 +3174,40 @@@ static const struct tpacpi_quirk tpacpi
  typedef u16 tpacpi_keymap_entry_t;
  typedef tpacpi_keymap_entry_t tpacpi_keymap_t[TPACPI_HOTKEY_MAP_LEN];
  
++<<<<<<< HEAD
++=======
+ static int hotkey_init_tablet_mode(void)
+ {
+ 	int in_tablet_mode, res;
+ 	char *type;
+ 
+ 	if (acpi_evalf(hkey_handle, &res, "MHKG", "qd")) {
+ 		/* For X41t, X60t, X61t Tablets... */
+ 		tp_features.hotkey_tablet = TP_HOTKEY_TABLET_USES_MHKG;
+ 		in_tablet_mode = !!(res & TP_HOTKEY_TABLET_MASK);
+ 		type = "MHKG";
+ 	} else if (acpi_evalf(ec_handle, &res, "CMMD", "qd")) {
+ 		/* For X1 Yoga (2016) */
+ 		tp_features.hotkey_tablet = TP_HOTKEY_TABLET_USES_CMMD;
+ 		in_tablet_mode = res == TP_EC_CMMD_TABLET_MODE;
+ 		type = "CMMD";
+ 	}
+ 
+ 	if (!tp_features.hotkey_tablet)
+ 		return 0;
+ 
+ 	pr_info("Tablet mode switch found (type: %s), currently in %s mode\n",
+ 		type, in_tablet_mode ? "tablet" : "laptop");
+ 
+ 	res = add_to_attr_set(hotkey_dev_attributes,
+ 			      &dev_attr_hotkey_tablet_mode.attr);
+ 	if (res)
+ 		return -1;
+ 
+ 	return in_tablet_mode;
+ }
+ 
++>>>>>>> b03f4d49469f (platform/x86: thinkpad_acpi: Add support for X1 Yoga (2016) Tablet Mode)
  static int __init hotkey_init(struct ibm_init_struct *iibm)
  {
  	/* Requirements for changing the default keymaps:
diff --git a/Documentation/laptops/thinkpad-acpi.txt b/Documentation/laptops/thinkpad-acpi.txt
index 8bab5fe125f5..f9f594aca35c 100644
--- a/Documentation/laptops/thinkpad-acpi.txt
+++ b/Documentation/laptops/thinkpad-acpi.txt
@@ -557,6 +557,7 @@ Events that are propagated by the driver to userspace:
 0x6022		ALARM: a sensor is extremely hot
 0x6030		System thermal table changed
 0x6040		Nvidia Optimus/AC adapter related (TO BE VERIFIED)
+0x60C0		X1 Yoga 2016, Tablet mode status changed
 
 Battery nearly empty alarms are a last resort attempt to get the
 operating system to hibernate or shutdown cleanly (0x2313), or shutdown
* Unmerged path drivers/platform/x86/thinkpad_acpi.c
