qla2xxx: setup data needed in ISR before setting up the ISR

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Johannes Thumshirn <jthumshirn@suse.de>
commit ef8d1d51aa5ebe4b17b5e837d520df1e398b7adb
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/ef8d1d51.failed

qla2xxx first calls request_irq() and then does the setup of the queue
entry data needed in the interrupt handlers in when using MSI-X. This
could lead to a NULL pointer dereference when an IRQ fires between the
request_irq() call and the assignment of the qentry data structure to
the rsp->msix field. A possible case for such a race would be in the
kdump case when the HBA's IRQs are still enabled but the driver is
undergoing a new initialisation and thus is not aware of already
activated IRQs in the HBA.

	Signed-off-by: Johannes Thumshirn <jthumshirn@suse.de>
	Reviewed-by: Hannes Reinecke <hare@suse.com>
	Reviewed-by: Himanshu Madhani <himanshu.madhani@qlogic.com>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit ef8d1d51aa5ebe4b17b5e837d520df1e398b7adb)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/qla2xxx/qla_isr.c
diff --cc drivers/scsi/qla2xxx/qla_isr.c
index ab3197e4cb8c,ea8641b47c86..000000000000
--- a/drivers/scsi/qla2xxx/qla_isr.c
+++ b/drivers/scsi/qla2xxx/qla_isr.c
@@@ -3046,8 -3099,18 +3048,23 @@@ qla24xx_enable_msix(struct qla_hw_data 
  		if (ret)
  			goto msix_register_fail;
  		qentry->have_irq = 1;
++<<<<<<< HEAD
 +		qentry->rsp = rsp;
 +		rsp->msix = qentry;
++=======
+ 
+ 		/* Register for CPU affinity notification. */
+ 		irq_set_affinity_notifier(qentry->vector, &qentry->irq_notify);
+ 
+ 		/* Schedule work (ie. trigger a notification) to read cpu
+ 		 * mask for this specific irq.
+ 		 * kref_get is required because
+ 		* irq_affinity_notify() will do
+ 		* kref_put().
+ 		*/
+ 		kref_get(&qentry->irq_notify.kref);
+ 		schedule_work(&qentry->irq_notify.work);
++>>>>>>> ef8d1d51aa5e (qla2xxx: setup data needed in ISR before setting up the ISR)
  	}
  
  	/*
* Unmerged path drivers/scsi/qla2xxx/qla_isr.c
