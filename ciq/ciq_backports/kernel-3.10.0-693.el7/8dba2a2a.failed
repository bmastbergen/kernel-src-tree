amd-xgbe: Enable/disable PFC per traffic class

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Lendacky, Thomas <Thomas.Lendacky@amd.com>
commit 8dba2a2a88397dec6bdcae8bf7ceeefd62fd39fc
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/8dba2a2a.failed

Currently the PFC flow control is enabled on all traffic classes if
one or more traffic classes request it. The PFC enable setting of the
traffic class should be used to determine whether to enable or disable
flow control for the traffic class.

	Signed-off-by: Tom Lendacky <thomas.lendacky@amd.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 8dba2a2a88397dec6bdcae8bf7ceeefd62fd39fc)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/amd/xgbe/xgbe-dev.c
diff --cc drivers/net/ethernet/amd/xgbe/xgbe-dev.c
index a748fd8a1c58,6b98a99fbfa4..000000000000
--- a/drivers/net/ethernet/amd/xgbe/xgbe-dev.c
+++ b/drivers/net/ethernet/amd/xgbe/xgbe-dev.c
@@@ -367,8 -525,38 +369,43 @@@ static int xgbe_enable_tx_flow_control(
  	unsigned int i;
  
  	/* Set MTL flow control */
++<<<<<<< HEAD
 +	for (i = 0; i < pdata->hw_feat.rx_q_cnt; i++)
 +		XGMAC_MTL_IOWRITE_BITS(pdata, i, MTL_Q_RQOMR, EHFC, 1);
++=======
+ 	for (i = 0; i < pdata->rx_q_count; i++) {
+ 		unsigned int ehfc = 0;
+ 
+ 		if (pfc && ets) {
+ 			unsigned int prio;
+ 
+ 			for (prio = 0; prio < IEEE_8021QAZ_MAX_TCS; prio++) {
+ 				unsigned int tc;
+ 
+ 				/* Does this queue handle the priority? */
+ 				if (pdata->prio2q_map[prio] != i)
+ 					continue;
+ 
+ 				/* Get the Traffic Class for this priority */
+ 				tc = ets->prio_tc[prio];
+ 
+ 				/* Check if flow control should be enabled */
+ 				if (pfc->pfc_en & (1 << tc)) {
+ 					ehfc = 1;
+ 					break;
+ 				}
+ 			}
+ 		} else {
+ 			ehfc = 1;
+ 		}
+ 
+ 		XGMAC_MTL_IOWRITE_BITS(pdata, i, MTL_Q_RQOMR, EHFC, ehfc);
+ 
+ 		netif_dbg(pdata, drv, pdata->netdev,
+ 			  "flow control %s for RXq%u\n",
+ 			  ehfc ? "enabled" : "disabled", i);
+ 	}
++>>>>>>> 8dba2a2a8839 (amd-xgbe: Enable/disable PFC per traffic class)
  
  	/* Set MAC flow control */
  	max_q_count = XGMAC_MAX_FLOW_CONTROL_QUEUES;
* Unmerged path drivers/net/ethernet/amd/xgbe/xgbe-dev.c
