perf evlist: Map backward events to backward_mmap

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Wang Nan <wangnan0@huawei.com>
commit 078c33862e042b3778dce3bcc8eaef84ab40715c
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/078c3386.failed

In perf_evlist__mmap_per_evsel(), select backward_mmap for backward
events.  Utilize new perf_mmap APIs. Dynamically alloc backward_mmap.

Remove useless functions.

	Signed-off-by: Wang Nan <wangnan0@huawei.com>
	Acked-by: Jiri Olsa <jolsa@kernel.org>
	Cc: He Kuang <hekuang@huawei.com>
	Cc: Masami Hiramatsu <mhiramat@kernel.org>
	Cc: Namhyung Kim <namhyung@kernel.org>
	Cc: Nilay Vaish <nilayvaish@gmail.com>
	Cc: Zefan Li <lizefan@huawei.com>
	Cc: pi3orama@163.com
Link: http://lkml.kernel.org/r/1468485287-33422-9-git-send-email-wangnan0@huawei.com
	Signed-off-by: Arnaldo Carvalho de Melo <acme@redhat.com>
(cherry picked from commit 078c33862e042b3778dce3bcc8eaef84ab40715c)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/perf/util/evlist.c
diff --cc tools/perf/util/evlist.c
index 39e4ab031b6f,7570f903200e..000000000000
--- a/tools/perf/util/evlist.c
+++ b/tools/perf/util/evlist.c
@@@ -1071,11 -1057,22 +1057,30 @@@ static int perf_evlist__mmap_per_evsel(
  	struct perf_evsel *evsel;
  	int revent;
  
++<<<<<<< HEAD
 +	evlist__for_each(evlist, evsel) {
 +		int fd;
 +
 +		if (evsel->overwrite != (evlist->overwrite && evlist->backward))
 +			continue;
++=======
+ 	evlist__for_each_entry(evlist, evsel) {
+ 		struct perf_mmap *maps = evlist->mmap;
+ 		int *output = _output;
+ 		int fd;
+ 
+ 		if (evsel->attr.write_backward) {
+ 			output = _output_backward;
+ 			maps = evlist->backward_mmap;
+ 
+ 			if (!maps) {
+ 				maps = perf_evlist__alloc_mmap(evlist);
+ 				if (!maps)
+ 					return -1;
+ 				evlist->backward_mmap = maps;
+ 			}
+ 		}
++>>>>>>> 078c33862e04 (perf evlist: Map backward events to backward_mmap)
  
  		if (evsel->system_wide && thread)
  			continue;
diff --git a/tools/perf/tests/backward-ring-buffer.c b/tools/perf/tests/backward-ring-buffer.c
index d9ba991a9a30..4b04a4fd4b1b 100644
--- a/tools/perf/tests/backward-ring-buffer.c
+++ b/tools/perf/tests/backward-ring-buffer.c
@@ -31,8 +31,8 @@ static int count_samples(struct perf_evlist *evlist, int *sample_count,
 	for (i = 0; i < evlist->nr_mmaps; i++) {
 		union perf_event *event;
 
-		perf_evlist__mmap_read_catchup(evlist, i);
-		while ((event = perf_evlist__mmap_read_backward(evlist, i)) != NULL) {
+		perf_mmap__read_catchup(&evlist->backward_mmap[i]);
+		while ((event = perf_mmap__read_backward(&evlist->backward_mmap[i])) != NULL) {
 			const u32 type = event->header.type;
 
 			switch (type) {
* Unmerged path tools/perf/util/evlist.c
