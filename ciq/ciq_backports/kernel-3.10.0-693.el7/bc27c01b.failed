blk-mq: Do not invoke .queue_rq() for a stopped queue

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Bart Van Assche <bart.vanassche@sandisk.com>
commit bc27c01b5c46d3bfec42c96537c7a3fae0bb2cc4
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/bc27c01b.failed

The meaning of the BLK_MQ_S_STOPPED flag is "do not call
.queue_rq()". Hence modify blk_mq_make_request() such that requests
are queued instead of issued if a queue has been stopped.

	Reported-by: Ming Lei <tom.leiming@gmail.com>
	Signed-off-by: Bart Van Assche <bart.vanassche@sandisk.com>
	Reviewed-by: Christoph Hellwig <hch@lst.de>
	Reviewed-by: Ming Lei <tom.leiming@gmail.com>
	Reviewed-by: Hannes Reinecke <hare@suse.com>
	Reviewed-by: Johannes Thumshirn <jthumshirn@suse.de>
	Reviewed-by: Sagi Grimberg <sagi@grimberg.me>
	Cc: <stable@vger.kernel.org>
	Signed-off-by: Jens Axboe <axboe@fb.com>
(cherry picked from commit bc27c01b5c46d3bfec42c96537c7a3fae0bb2cc4)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	block/blk-mq.c
diff --cc block/blk-mq.c
index 5a93dd7c2ec2,92edd28b7e76..000000000000
--- a/block/blk-mq.c
+++ b/block/blk-mq.c
@@@ -1308,11 -1316,11 +1308,19 @@@ static void blk_mq_make_request(struct 
  			old_rq = rq;
  		blk_mq_put_ctx(data.ctx);
  		if (!old_rq)
++<<<<<<< HEAD
 +			return;
 +		if (!blk_mq_direct_issue_request(old_rq))
 +			return;
 +		blk_mq_insert_request(old_rq, false, true, true);
 +		return;
++=======
+ 			goto done;
+ 		if (test_bit(BLK_MQ_S_STOPPED, &data.hctx->state) ||
+ 		    blk_mq_direct_issue_request(old_rq, &cookie) != 0)
+ 			blk_mq_insert_request(old_rq, false, true, true);
+ 		goto done;
++>>>>>>> bc27c01b5c46 (blk-mq: Do not invoke .queue_rq() for a stopped queue)
  	}
  
  	if (!blk_mq_merge_queue_io(data.hctx, data.ctx, rq, bio)) {
* Unmerged path block/blk-mq.c
