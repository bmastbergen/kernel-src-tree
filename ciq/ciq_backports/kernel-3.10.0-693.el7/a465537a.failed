qla2xxx: Disable the adapter and skip error recovery in case of register disconnect.

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
Rebuild_CHGLOG: - [scsi] qla2xxx: Disable the adapter and skip error recovery in case of register disconnect (Himanshu Madhani) [1436940]
Rebuild_FUZZ: 99.40%
commit-author Sawan Chandak <sawan.chandak@qlogic.com>
commit a465537ad1a4423e542f9427e4f684334b4b40a5
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/a465537a.failed

If there is error recovery going on due to command timeout and
there is register disconnect, then disable the adapter.

	Signed-off-by: Sawan Chandak <sawan.chandak@qlogic.com>
	Signed-off-by: Himanshu Madhani <himanshu.madhani@qlogic.com>
	Reviewed-by: Hannes Reinecke <hare@suse.com>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit a465537ad1a4423e542f9427e4f684334b4b40a5)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/qla2xxx/qla_dbg.c
#	drivers/scsi/qla2xxx/qla_os.c
diff --cc drivers/scsi/qla2xxx/qla_dbg.c
index 53a86c55945d,97b0a9da0913..000000000000
--- a/drivers/scsi/qla2xxx/qla_dbg.c
+++ b/drivers/scsi/qla2xxx/qla_dbg.c
@@@ -40,9 -39,9 +40,13 @@@
   * |                              |                    | 0x70a5-0x70a6  |
   * |                              |                    | 0x70a8,0x70ab  |
   * |                              |                    | 0x70ad-0x70ae  |
 - * |                              |                    | 0x70d0-0x70d6	|
   * |                              |                    | 0x70d7-0x70db  |
++<<<<<<< HEAD
 + * |                              |                    | 0x70db		|
 + * | Task Management              |       0x803d       | 0x8000,0x800b  |
++=======
+  * | Task Management              |       0x8042       | 0x8000,0x800b  |
++>>>>>>> a465537ad1a4 (qla2xxx: Disable the adapter and skip error recovery in case of register disconnect.)
   * |                              |                    | 0x8019         |
   * |                              |                    | 0x8025,0x8026  |
   * |                              |                    | 0x8031,0x8032  |
diff --cc drivers/scsi/qla2xxx/qla_os.c
index f1f989d1fce1,2674f4c16bc3..000000000000
--- a/drivers/scsi/qla2xxx/qla_os.c
+++ b/drivers/scsi/qla2xxx/qla_os.c
@@@ -1172,7 -1229,15 +1213,19 @@@ qla2xxx_eh_bus_reset(struct scsi_cmnd *
  	scsi_qla_host_t *vha = shost_priv(cmd->device->host);
  	fc_port_t *fcport = (struct fc_port *) cmd->device->hostdata;
  	int ret = FAILED;
++<<<<<<< HEAD
 +	unsigned int id, lun;
++=======
+ 	unsigned int id;
+ 	uint64_t lun;
+ 	struct qla_hw_data *ha = vha->hw;
+ 
+ 	if (qla2x00_isp_reg_stat(ha)) {
+ 		ql_log(ql_log_info, vha, 0x8040,
+ 		    "PCI/Register disconnect, exiting.\n");
+ 		return FAILED;
+ 	}
++>>>>>>> a465537ad1a4 (qla2xxx: Disable the adapter and skip error recovery in case of register disconnect.)
  
  	id = cmd->device->id;
  	lun = cmd->device->lun;
@@@ -1238,9 -1303,17 +1291,16 @@@ qla2xxx_eh_host_reset(struct scsi_cmnd 
  	scsi_qla_host_t *vha = shost_priv(cmd->device->host);
  	struct qla_hw_data *ha = vha->hw;
  	int ret = FAILED;
 -	unsigned int id;
 -	uint64_t lun;
 +	unsigned int id, lun;
  	scsi_qla_host_t *base_vha = pci_get_drvdata(ha->pdev);
  
+ 	if (qla2x00_isp_reg_stat(ha)) {
+ 		ql_log(ql_log_info, vha, 0x8041,
+ 		    "PCI/Register disconnect, exiting.\n");
+ 		schedule_work(&ha->board_disable);
+ 		return SUCCESS;
+ 	}
+ 
  	id = cmd->device->id;
  	lun = cmd->device->lun;
  
diff --git a/drivers/scsi/qla2xxx/qla_attr.c b/drivers/scsi/qla2xxx/qla_attr.c
index 8d2f18f7324e..bd58a9a690f2 100644
--- a/drivers/scsi/qla2xxx/qla_attr.c
+++ b/drivers/scsi/qla2xxx/qla_attr.c
@@ -1830,6 +1830,9 @@ qla2x00_terminate_rport_io(struct fc_rport *rport)
 	if (!fcport)
 		return;
 
+	if (test_bit(UNLOADING, &fcport->vha->dpc_flags))
+		return;
+
 	if (test_bit(ABORT_ISP_ACTIVE, &fcport->vha->dpc_flags))
 		return;
 
* Unmerged path drivers/scsi/qla2xxx/qla_dbg.c
* Unmerged path drivers/scsi/qla2xxx/qla_os.c
