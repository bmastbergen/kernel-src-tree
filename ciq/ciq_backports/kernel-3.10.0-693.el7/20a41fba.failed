amd-xgbe: Use wmb before updating current descriptor count

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Lendacky, Thomas <Thomas.Lendacky@amd.com>
commit 20a41fba679d665cdae2808e2b9cae97c073351f
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/20a41fba.failed

The code currently uses the lightweight dma_wmb barrier before updating
the current descriptor count. Under heavy load, the Tx cleanup routine
was seeing the updated current descriptor count before the updated
descriptor information. As a result, the Tx descriptor was being cleaned
up before it was used because it was not "owned" by the hardware yet,
resulting in a Tx queue hang.

Using the wmb barrier insures that the descriptor is updated before the
descriptor counter preventing the Tx queue hang. For extra insurance,
the Tx cleanup routine is changed to grab the current decriptor count on
entry and uses that initial value in the processing loop rather than
trying to chase the current value.

	Signed-off-by: Tom Lendacky <thomas.lendacky@amd.com>
	Tested-by: Christoffer Dall <christoffer.dall@linaro.org>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 20a41fba679d665cdae2808e2b9cae97c073351f)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/amd/xgbe/xgbe-drv.c
diff --cc drivers/net/ethernet/amd/xgbe/xgbe-drv.c
index d58e85811bc9,d2b77d985441..000000000000
--- a/drivers/net/ethernet/amd/xgbe/xgbe-drv.c
+++ b/drivers/net/ethernet/amd/xgbe/xgbe-drv.c
@@@ -1107,8 -1804,10 +1107,13 @@@ static int xgbe_tx_poll(struct xgbe_cha
  	struct xgbe_ring_data *rdata;
  	struct xgbe_ring_desc *rdesc;
  	struct net_device *netdev = pdata->netdev;
 -	struct netdev_queue *txq;
 +	unsigned long flags;
  	int processed = 0;
++<<<<<<< HEAD
++=======
+ 	unsigned int tx_packets = 0, tx_bytes = 0;
+ 	unsigned int cur;
++>>>>>>> 20a41fba679d (amd-xgbe: Use wmb before updating current descriptor count)
  
  	DBGPR("-->xgbe_tx_poll\n");
  
@@@ -1116,10 -1815,11 +1121,15 @@@
  	if (!ring)
  		return 0;
  
++<<<<<<< HEAD
 +	spin_lock_irqsave(&ring->lock, flags);
++=======
+ 	cur = ring->cur;
+ 	txq = netdev_get_tx_queue(netdev, channel->queue_index);
++>>>>>>> 20a41fba679d (amd-xgbe: Use wmb before updating current descriptor count)
  
  	while ((processed < XGBE_TX_DESC_MAX_PROC) &&
- 	       (ring->dirty != ring->cur)) {
+ 	       (ring->dirty != cur)) {
  		rdata = XGBE_GET_DESC_DATA(ring, ring->dirty);
  		rdesc = rdata->rdesc;
  
* Unmerged path drivers/net/ethernet/amd/xgbe/xgbe-drv.c
