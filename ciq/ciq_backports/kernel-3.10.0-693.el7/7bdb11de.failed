mnt: Factor out unhash_mnt from detach_mnt and umount_tree

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Eric W. Biederman <ebiederm@xmission.com>
commit 7bdb11de8ee4f4ae195e2fa19efd304e0b36c63b
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/7bdb11de.failed

Create a function unhash_mnt that contains the common code between
detach_mnt and umount_tree, and use unhash_mnt in place of the common
code.  This add a unncessary list_del_init(mnt->mnt_child) into
umount_tree but given that mnt_child is already empty this extra
line is a noop.

	Cc: stable@vger.kernel.org
	Signed-off-by: "Eric W. Biederman" <ebiederm@xmission.com>
(cherry picked from commit 7bdb11de8ee4f4ae195e2fa19efd304e0b36c63b)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/namespace.c
diff --cc fs/namespace.c
index 91fbddebae10,e669a3bf86e7..000000000000
--- a/fs/namespace.c
+++ b/fs/namespace.c
@@@ -1228,15 -1365,15 +1236,22 @@@ void umount_tree(struct mount *mnt, in
  		list_del_init(&p->mnt_list);
  		__touch_mnt_namespace(p->mnt_ns);
  		p->mnt_ns = NULL;
 -		if (how & UMOUNT_SYNC)
 -			p->mnt.mnt_flags |= MNT_SYNC_UMOUNT;
 -
 -		pin_insert_group(&p->mnt_umount, &p->mnt_parent->mnt, &unmounted);
 +		list_del_init(&p->mnt_child);
  		if (mnt_has_parent(p)) {
++<<<<<<< HEAD
 +			put_mountpoint(p->mnt_mp);
 +			/* move the reference to mountpoint into ->mnt_ex_mountpoint */
 +			p->mnt_ex_mountpoint.dentry = p->mnt_mountpoint;
 +			p->mnt_ex_mountpoint.mnt = &p->mnt_parent->mnt;
 +			p->mnt_mountpoint = p->mnt.mnt_root;
 +			p->mnt_parent = p;
 +			p->mnt_mp = NULL;
++=======
+ 			mnt_add_count(p->mnt_parent, -1);
+ 			/* old mountpoint will be dropped when we can do that */
+ 			p->mnt_ex_mountpoint = p->mnt_mountpoint;
+ 			unhash_mnt(p);
++>>>>>>> 7bdb11de8ee4 (mnt: Factor out unhash_mnt from detach_mnt and umount_tree)
  		}
  		change_mnt_propagation(p, MS_PRIVATE);
  	}
* Unmerged path fs/namespace.c
