xprtrdma: Move recv_wr to struct rpcrdma_rep

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Chuck Lever <chuck.lever@oracle.com>
commit 6ea8e71150ecdc235fab31f76ed9953d82313923
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/6ea8e711.failed

Clean up: The fields in the recv_wr do not vary. There is no need to
initialize them before each ib_post_recv(). This removes a large-ish
data structure from the stack.

	Signed-off-by: Chuck Lever <chuck.lever@oracle.com>
	Signed-off-by: Anna Schumaker <Anna.Schumaker@Netapp.com>
(cherry picked from commit 6ea8e71150ecdc235fab31f76ed9953d82313923)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/sunrpc/xprtrdma/verbs.c
diff --cc net/sunrpc/xprtrdma/verbs.c
index a763d5a5c6b0,a49c788aa59a..000000000000
--- a/net/sunrpc/xprtrdma/verbs.c
+++ b/net/sunrpc/xprtrdma/verbs.c
@@@ -1194,25 -1306,23 +1198,31 @@@ in
  rpcrdma_ep_post_recv(struct rpcrdma_ia *ia,
  		     struct rpcrdma_rep *rep)
  {
- 	struct ib_recv_wr recv_wr, *recv_wr_fail;
+ 	struct ib_recv_wr *recv_wr_fail;
  	int rc;
  
++<<<<<<< HEAD
 +	recv_wr.next = NULL;
 +	recv_wr.wr_cqe = &rep->rr_cqe;
 +	recv_wr.sg_list = &rep->rr_rdmabuf->rg_iov;
 +	recv_wr.num_sge = 1;
 +
 +	ib_dma_sync_single_for_cpu(ia->ri_device,
 +				   rdmab_addr(rep->rr_rdmabuf),
 +				   rdmab_length(rep->rr_rdmabuf),
 +				   DMA_BIDIRECTIONAL);
 +
 +	rc = ib_post_recv(ia->ri_id->qp, &recv_wr, &recv_wr_fail);
 +
++=======
+ 	if (!rpcrdma_dma_map_regbuf(ia, rep->rr_rdmabuf))
+ 		goto out_map;
+ 	rc = ib_post_recv(ia->ri_id->qp, &rep->rr_recv_wr, &recv_wr_fail);
++>>>>>>> 6ea8e71150ec (xprtrdma: Move recv_wr to struct rpcrdma_rep)
  	if (rc)
 -		goto out_postrecv;
 -	return 0;
 -
 -out_map:
 -	pr_err("rpcrdma: failed to DMA map the Receive buffer\n");
 -	return -EIO;
 -
 -out_postrecv:
 -	pr_err("rpcrdma: ib_post_recv returned %i\n", rc);
 -	return -ENOTCONN;
 +		dprintk("RPC:       %s: ib_post_recv returned %i\n", __func__,
 +			rc);
 +	return rc;
  }
  
  /**
* Unmerged path net/sunrpc/xprtrdma/verbs.c
diff --git a/net/sunrpc/xprtrdma/xprt_rdma.h b/net/sunrpc/xprtrdma/xprt_rdma.h
index 3f48e7e27d19..1cc443536e11 100644
--- a/net/sunrpc/xprtrdma/xprt_rdma.h
+++ b/net/sunrpc/xprtrdma/xprt_rdma.h
@@ -196,6 +196,7 @@ struct rpcrdma_rep {
 	struct rpcrdma_xprt	*rr_rxprt;
 	struct work_struct	rr_work;
 	struct list_head	rr_list;
+	struct ib_recv_wr	rr_recv_wr;
 	struct rpcrdma_regbuf	*rr_rdmabuf;
 };
 
