xen-netfront: avoid crashing on resume after a failure in talk_to_netback()

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Vitaly Kuznetsov <vkuznets@redhat.com>
commit d86b5672b1adb98b4cdd6fbf0224bbfb03db6e2e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/d86b5672.failed

Unavoidable crashes in netfront_resume() and netback_changed() after a
previous fail in talk_to_netback() (e.g. when we fail to read MAC from
xenstore) were discovered. The failure path in talk_to_netback() does
unregister/free for netdev but we don't reset drvdata and we try accessing
it after resume.

Fix the bug by removing the whole xen device completely with
device_unregister(), this guarantees we won't have any calls into netfront
after a failure.

	Signed-off-by: Vitaly Kuznetsov <vkuznets@redhat.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit d86b5672b1adb98b4cdd6fbf0224bbfb03db6e2e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/xen-netfront.c
diff --cc drivers/net/xen-netfront.c
index 8896052a2ee0,7b61adb6270c..000000000000
--- a/drivers/net/xen-netfront.c
+++ b/drivers/net/xen-netfront.c
@@@ -1722,11 -1927,14 +1722,15 @@@ again
  	return 0;
  
   abort_transaction:
 -	xenbus_dev_fatal(dev, err, "%s", message);
 -abort_transaction_no_dev_fatal:
  	xenbus_transaction_end(xbt, 1);
 +	xenbus_dev_fatal(dev, err, "%s", message);
   destroy_ring:
  	xennet_disconnect_backend(info);
 -	xennet_destroy_queues(info);
   out:
++<<<<<<< HEAD
++=======
+ 	device_unregister(&dev->dev);
++>>>>>>> d86b5672b1ad (xen-netfront: avoid crashing on resume after a failure in talk_to_netback())
  	return err;
  }
  
* Unmerged path drivers/net/xen-netfront.c
