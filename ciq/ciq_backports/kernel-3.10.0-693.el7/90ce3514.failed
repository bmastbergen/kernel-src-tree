powerpc/pseries: fix memory leak in queue_hotplug_event() error path

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
Rebuild_CHGLOG: - [powerpc] pseries: fix memory leak in queue_hotplug_event() error path (Thomas Huth) [1323417]
Rebuild_FUZZ: 93.75%
commit-author Andrew Donnellan <andrew.donnellan@au1.ibm.com>
commit 90ce35145cb622b3cd0007d50e1f6a5a97321235
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/90ce3514.failed

If we fail to allocate work, we don't end up using hp_errlog_copy. Free it
in the error path.

	Signed-off-by: Andrew Donnellan <andrew.donnellan@au1.ibm.com>
	Reviewed-by: Nathan Fontenot <nfont@linux.vnet.ibm.com>
	Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
(cherry picked from commit 90ce35145cb622b3cd0007d50e1f6a5a97321235)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/powerpc/platforms/pseries/dlpar.c
diff --cc arch/powerpc/platforms/pseries/dlpar.c
index b59742323995,423e450efe07..000000000000
--- a/arch/powerpc/platforms/pseries/dlpar.c
+++ b/arch/powerpc/platforms/pseries/dlpar.c
@@@ -600,6 -377,47 +600,50 @@@ static int handle_dlpar_errorlog(struc
  	return rc;
  }
  
++<<<<<<< HEAD
++=======
+ static void pseries_hp_work_fn(struct work_struct *work)
+ {
+ 	struct pseries_hp_work *hp_work =
+ 			container_of(work, struct pseries_hp_work, work);
+ 
+ 	if (hp_work->rc)
+ 		*(hp_work->rc) = handle_dlpar_errorlog(hp_work->errlog);
+ 	else
+ 		handle_dlpar_errorlog(hp_work->errlog);
+ 
+ 	if (hp_work->hp_completion)
+ 		complete(hp_work->hp_completion);
+ 
+ 	kfree(hp_work->errlog);
+ 	kfree((void *)work);
+ }
+ 
+ void queue_hotplug_event(struct pseries_hp_errorlog *hp_errlog,
+ 			 struct completion *hotplug_done, int *rc)
+ {
+ 	struct pseries_hp_work *work;
+ 	struct pseries_hp_errorlog *hp_errlog_copy;
+ 
+ 	hp_errlog_copy = kmalloc(sizeof(struct pseries_hp_errorlog),
+ 				 GFP_KERNEL);
+ 	memcpy(hp_errlog_copy, hp_errlog, sizeof(struct pseries_hp_errorlog));
+ 
+ 	work = kmalloc(sizeof(struct pseries_hp_work), GFP_KERNEL);
+ 	if (work) {
+ 		INIT_WORK((struct work_struct *)work, pseries_hp_work_fn);
+ 		work->errlog = hp_errlog_copy;
+ 		work->hp_completion = hotplug_done;
+ 		work->rc = rc;
+ 		queue_work(pseries_hp_wq, (struct work_struct *)work);
+ 	} else {
+ 		*rc = -ENOMEM;
+ 		kfree(hp_errlog_copy);
+ 		complete(hotplug_done);
+ 	}
+ }
+ 
++>>>>>>> 90ce35145cb6 (powerpc/pseries: fix memory leak in queue_hotplug_event() error path)
  static ssize_t dlpar_store(struct class *class, struct class_attribute *attr,
  			   const char *buf, size_t count)
  {
* Unmerged path arch/powerpc/platforms/pseries/dlpar.c
