KVM: x86: make interrupt delivery fast and slow path behave the same

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Radim Krčmář <rkrcmar@redhat.com>
commit b4535b58ae0df8b7cf0fe92a0c23aa3cf862e3cc
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/b4535b58.failed

Slow path tried to prevent IPIs from x2APIC VCPUs from being delivered
to xAPIC VCPUs and vice-versa.  Make slow path behave like fast path,
which never distinguished that.

	Reviewed-by: David Hildenbrand <david@redhat.com>
	Signed-off-by: Radim Krčmář <rkrcmar@redhat.com>
	Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
(cherry picked from commit b4535b58ae0df8b7cf0fe92a0c23aa3cf862e3cc)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kvm/lapic.c
diff --cc arch/x86/kvm/lapic.c
index 323d098efc5e,3ebef53d20a0..000000000000
--- a/arch/x86/kvm/lapic.c
+++ b/arch/x86/kvm/lapic.c
@@@ -615,9 -602,9 +613,13 @@@ static bool kvm_apic_match_physical_add
  		return true;
  
  	if (apic_x2apic_mode(apic))
 -		return mda == kvm_x2apic_id(apic);
 +		return mda == kvm_apic_id(apic);
  
++<<<<<<< HEAD
 +	return mda == SET_APIC_DEST_FIELD(kvm_apic_id(apic));
++=======
+ 	return mda == kvm_xapic_id(apic);
++>>>>>>> b4535b58ae0d (KVM: x86: make interrupt delivery fast and slow path behave the same)
  }
  
  static bool kvm_apic_match_logical_addr(struct kvm_lapic *apic, u32 mda)
@@@ -634,9 -621,8 +636,8 @@@
  		       && (logical_id & mda & 0xffff) != 0;
  
  	logical_id = GET_APIC_LOGICAL_ID(logical_id);
- 	mda = GET_APIC_DEST_FIELD(mda);
  
 -	switch (kvm_lapic_get_reg(apic, APIC_DFR)) {
 +	switch (kvm_apic_get_reg(apic, APIC_DFR)) {
  	case APIC_DFR_FLAT:
  		return (logical_id & mda) != 0;
  	case APIC_DFR_CLUSTER:
* Unmerged path arch/x86/kvm/lapic.c
