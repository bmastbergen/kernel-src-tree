pNFS: Fix pnfs_mark_matching_lsegs_return()

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Trond Myklebust <trond.myklebust@primarydata.com>
commit 2f21596882f4a0edc387051910d56f8732970080
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/2f215968.failed

We don't need to schedule a layoutreturn if the layout segment can
be freed immediately.

	Signed-off-by: Trond Myklebust <trond.myklebust@primarydata.com>
(cherry picked from commit 2f21596882f4a0edc387051910d56f8732970080)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/nfs/pnfs.c
diff --cc fs/nfs/pnfs.c
index 1e9ea46d9552,8d9fa4e40e89..000000000000
--- a/fs/nfs/pnfs.c
+++ b/fs/nfs/pnfs.c
@@@ -1728,12 -1730,33 +1728,36 @@@ out_forget_reply
  	goto out;
  }
  
++<<<<<<< HEAD
 +void
++=======
+ static void
+ pnfs_set_plh_return_iomode(struct pnfs_layout_hdr *lo, enum pnfs_iomode iomode)
+ {
+ 	if (lo->plh_return_iomode == iomode)
+ 		return;
+ 	if (lo->plh_return_iomode != 0)
+ 		iomode = IOMODE_ANY;
+ 	lo->plh_return_iomode = iomode;
+ }
+ 
+ /**
+  * pnfs_mark_matching_lsegs_return - Free or return matching layout segments
+  * @lo: pointer to layout header
+  * @tmp_list: list header to be used with pnfs_free_lseg_list()
+  * @return_range: describe layout segment ranges to be returned
+  *
+  * This function is mainly intended for use by layoutrecall. It attempts
+  * to free the layout segment immediately, or else to mark it for return
+  * as soon as its reference count drops to zero.
+  */
+ int
++>>>>>>> 2f21596882f4 (pNFS: Fix pnfs_mark_matching_lsegs_return())
  pnfs_mark_matching_lsegs_return(struct pnfs_layout_hdr *lo,
  				struct list_head *tmp_list,
 -				const struct pnfs_layout_range *return_range)
 +				struct pnfs_layout_range *return_range)
  {
  	struct pnfs_layout_segment *lseg, *next;
 -	int remaining = 0;
  
  	dprintk("%s:Begin lo %p\n", __func__, lo);
  
@@@ -1749,11 -1772,15 +1773,19 @@@
  				lseg, lseg->pls_range.iomode,
  				lseg->pls_range.offset,
  				lseg->pls_range.length);
+ 			if (mark_lseg_invalid(lseg, tmp_list))
+ 				continue;
+ 			remaining++;
  			set_bit(NFS_LSEG_LAYOUTRETURN, &lseg->pls_flags);
++<<<<<<< HEAD
 +			mark_lseg_invalid(lseg, tmp_list);
 +			set_bit(NFS_LAYOUT_RETURN_BEFORE_CLOSE,
++=======
+ 			pnfs_set_plh_return_iomode(lo, return_range->iomode);
+ 			set_bit(NFS_LAYOUT_RETURN_REQUESTED,
++>>>>>>> 2f21596882f4 (pNFS: Fix pnfs_mark_matching_lsegs_return())
  					&lo->plh_flags);
  		}
 -	return remaining;
  }
  
  void pnfs_error_mark_layout_for_return(struct inode *inode,
* Unmerged path fs/nfs/pnfs.c
