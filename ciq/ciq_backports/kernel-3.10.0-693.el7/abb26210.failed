perf tools: Force fixdep compilation at the start of the build

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Jiri Olsa <jolsa@kernel.org>
commit abb26210a39522a6645bce3f438ed9a26bedb11b
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/abb26210.failed

The fixdep tool needs to be built before everything else, because it fixes
every object dependency file.

We handle this currently by making all objects to depend on fixdep, which is
error prone and is easily forgotten when new object is added.

Instead of this, this patch force fixdep tool to be built as the first target
in the separate make session. This way we don't need to handle extra fixdep
dependencies and we are certain there's no fixdep race with any parallel make
job.

Committer notes:

Testing it:

Before:

  $ rm -rf /tmp/build/perf/ ; mkdir -p /tmp/build/perf ; make -k O=/tmp/build/perf -C tools/perf install-bin
  make: Entering directory '/home/acme/git/linux/tools/perf'
    BUILD:   Doing 'make -j4' parallel build

  Auto-detecting system features:
  ...                         dwarf: [ on  ]
  ...            dwarf_getlocations: [ on  ]
  ...                         glibc: [ on  ]
  ...                          gtk2: [ on  ]
  ...                      libaudit: [ on  ]
  ...                        libbfd: [ on  ]
  ...                        libelf: [ on  ]
  ...                       libnuma: [ on  ]
  ...        numa_num_possible_cpus: [ on  ]
  ...                       libperl: [ on  ]
  ...                     libpython: [ on  ]
  ...                      libslang: [ on  ]
  ...                     libcrypto: [ on  ]
  ...                     libunwind: [ on  ]
  ...            libdw-dwarf-unwind: [ on  ]
  ...                          zlib: [ on  ]
  ...                          lzma: [ on  ]
  ...                     get_cpuid: [ on  ]
  ...                           bpf: [ on  ]

    GEN      /tmp/build/perf/common-cmds.h
    HOSTCC   /tmp/build/perf/fixdep.o
    HOSTLD   /tmp/build/perf/fixdep-in.o
    LINK     /tmp/build/perf/fixdep
    MKDIR    /tmp/build/perf/pmu-events/
    HOSTCC   /tmp/build/perf/pmu-events/json.o
    MKDIR    /tmp/build/perf/pmu-events/
    HOSTCC   /tmp/build/perf/pmu-events/jsmn.o
    HOSTCC   /tmp/build/perf/pmu-events/jevents.o
    HOSTLD   /tmp/build/perf/pmu-events/jevents-in.o
    PERF_VERSION = 4.9.rc8.g868cd5
    CC       /tmp/build/perf/perf-read-vdso32
  <SNIP>

After:

  $ rm -rf /tmp/build/perf/ ; mkdir -p /tmp/build/perf ; make -k O=/tmp/build/perf -C tools/perf install-bin
  make: Entering directory '/home/acme/git/linux/tools/perf'
    BUILD:   Doing 'make -j4' parallel build
    HOSTCC   /tmp/build/perf/fixdep.o
    HOSTLD   /tmp/build/perf/fixdep-in.o
    LINK     /tmp/build/perf/fixdep

  Auto-detecting system features:
  ...                         dwarf: [ on  ]
  ...            dwarf_getlocations: [ on  ]
  ...                         glibc: [ on  ]
  ...                          gtk2: [ on  ]
  ...                      libaudit: [ on  ]
  ...                        libbfd: [ on  ]
  ...                        libelf: [ on  ]
  ...                       libnuma: [ on  ]
  ...        numa_num_possible_cpus: [ on  ]
  ...                       libperl: [ on  ]
  ...                     libpython: [ on  ]
  ...                      libslang: [ on  ]
  ...                     libcrypto: [ on  ]
  ...                     libunwind: [ on  ]
  ...            libdw-dwarf-unwind: [ on  ]
  ...                          zlib: [ on  ]
  ...                          lzma: [ on  ]
  ...                     get_cpuid: [ on  ]
  ...                           bpf: [ on  ]

    GEN      /tmp/build/perf/common-cmds.h
    MKDIR    /tmp/build/perf/fd/
    CC       /tmp/build/perf/fd/array.o
    LD       /tmp/build/perf/fd/libapi-in.o
    MKDIR    /tmp/build/perf/fs/
    CC       /tmp/build/perf/event-parse.o
    CC       /tmp/build/perf/fs/fs.o
    PERF_VERSION = 4.9.rc8.g57a92f
    CC       /tmp/build/perf/event-plugin.o
    MKDIR    /tmp/build/perf/fs/
    CC       /tmp/build/perf/fs/tracing_path.o
  <SNIP>

	Signed-off-by: Jiri Olsa <jolsa@kernel.org>
	Tested-by: Arnaldo Carvalho de Melo <acme@redhat.com>
	Cc: David Ahern <dsahern@gmail.com>
	Cc: Namhyung Kim <namhyung@kernel.org>
	Cc: Peter Zijlstra <a.p.zijlstra@chello.nl>
Link: http://lkml.kernel.org/r/1481030331-31944-3-git-send-email-jolsa@kernel.org
	Signed-off-by: Arnaldo Carvalho de Melo <acme@redhat.com>
(cherry picked from commit abb26210a39522a6645bce3f438ed9a26bedb11b)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/perf/Makefile.perf
diff --cc tools/perf/Makefile.perf
index 9a1c164fc3d3,33b1d9f8555f..000000000000
--- a/tools/perf/Makefile.perf
+++ b/tools/perf/Makefile.perf
@@@ -314,17 -394,125 +343,28 @@@ strip: $(PROGRAMS) $(OUTPUT)per
  
  PERF_IN := $(OUTPUT)perf-in.o
  
++<<<<<<< HEAD
 +export srctree OUTPUT RM CC LD AR CFLAGS V BISON FLEX AWK
 +include $(srctree)/tools/build/Makefile.include
++=======
+ JEVENTS       := $(OUTPUT)pmu-events/jevents
+ JEVENTS_IN    := $(OUTPUT)pmu-events/jevents-in.o
+ 
+ PMU_EVENTS_IN := $(OUTPUT)pmu-events/pmu-events-in.o
+ 
+ export JEVENTS
+ 
+ build := -f $(srctree)/tools/build/Makefile.build dir=. obj
++>>>>>>> abb26210a395 (perf tools: Force fixdep compilation at the start of the build)
  
  $(PERF_IN): prepare FORCE
 -	@(test -f ../../include/uapi/linux/perf_event.h && ( \
 -        (diff -B ../include/uapi/linux/perf_event.h ../../include/uapi/linux/perf_event.h >/dev/null) \
 -        || echo "Warning: tools/include/uapi/linux/perf_event.h differs from kernel" >&2 )) || true
 -	@(test -f ../../include/linux/hash.h && ( \
 -        (diff -B ../include/linux/hash.h ../../include/linux/hash.h >/dev/null) \
 -        || echo "Warning: tools/include/linux/hash.h differs from kernel" >&2 )) || true
 -	@(test -f ../../include/uapi/linux/hw_breakpoint.h && ( \
 -        (diff -B ../include/uapi/linux/hw_breakpoint.h ../../include/uapi/linux/hw_breakpoint.h >/dev/null) \
 -        || echo "Warning: tools/include/uapi/linux/hw_breakpoint.h differs from kernel" >&2 )) || true
 -	@(test -f ../../arch/x86/include/asm/disabled-features.h && ( \
 -        (diff -B ../arch/x86/include/asm/disabled-features.h ../../arch/x86/include/asm/disabled-features.h >/dev/null) \
 -        || echo "Warning: tools/arch/x86/include/asm/disabled-features.h differs from kernel" >&2 )) || true
 -	@(test -f ../../arch/x86/include/asm/required-features.h && ( \
 -        (diff -B ../arch/x86/include/asm/required-features.h ../../arch/x86/include/asm/required-features.h >/dev/null) \
 -        || echo "Warning: tools/arch/x86/include/asm/required-features.h differs from kernel" >&2 )) || true
 -	@(test -f ../../arch/x86/include/asm/cpufeatures.h && ( \
 -        (diff -B ../arch/x86/include/asm/cpufeatures.h ../../arch/x86/include/asm/cpufeatures.h >/dev/null) \
 -        || echo "Warning: tools/arch/x86/include/asm/cpufeatures.h differs from kernel" >&2 )) || true
 -	@(test -f ../../arch/x86/lib/memcpy_64.S && ( \
 -        (diff -B -I "^EXPORT_SYMBOL" -I "^#include <asm/export.h>" ../arch/x86/lib/memcpy_64.S ../../arch/x86/lib/memcpy_64.S >/dev/null) \
 -        || echo "Warning: tools/arch/x86/lib/memcpy_64.S differs from kernel" >&2 )) || true
 -	@(test -f ../../arch/x86/lib/memset_64.S && ( \
 -        (diff -B -I "^EXPORT_SYMBOL" -I "^#include <asm/export.h>" ../arch/x86/lib/memset_64.S ../../arch/x86/lib/memset_64.S >/dev/null) \
 -        || echo "Warning: tools/arch/x86/lib/memset_64.S differs from kernel" >&2 )) || true
 -	@(test -f ../../arch/arm/include/uapi/asm/perf_regs.h && ( \
 -        (diff -B ../arch/arm/include/uapi/asm/perf_regs.h ../../arch/arm/include/uapi/asm/perf_regs.h >/dev/null) \
 -        || echo "Warning: tools/arch/arm/include/uapi/asm/perf_regs.h differs from kernel" >&2 )) || true
 -	@(test -f ../../arch/arm64/include/uapi/asm/perf_regs.h && ( \
 -        (diff -B ../arch/arm64/include/uapi/asm/perf_regs.h ../../arch/arm64/include/uapi/asm/perf_regs.h >/dev/null) \
 -        || echo "Warning: tools/arch/arm64/include/uapi/asm/perf_regs.h differs from kernel" >&2 )) || true
 -	@(test -f ../../arch/powerpc/include/uapi/asm/perf_regs.h && ( \
 -        (diff -B ../arch/powerpc/include/uapi/asm/perf_regs.h ../../arch/powerpc/include/uapi/asm/perf_regs.h >/dev/null) \
 -        || echo "Warning: tools/arch/powerpc/include/uapi/asm/perf_regs.h differs from kernel" >&2 )) || true
 -	@(test -f ../../arch/x86/include/uapi/asm/perf_regs.h && ( \
 -        (diff -B ../arch/x86/include/uapi/asm/perf_regs.h ../../arch/x86/include/uapi/asm/perf_regs.h >/dev/null) \
 -        || echo "Warning: tools/arch/x86/include/uapi/asm/perf_regs.h differs from kernel" >&2 )) || true
 -	@(test -f ../../arch/x86/include/uapi/asm/kvm.h && ( \
 -        (diff -B ../arch/x86/include/uapi/asm/kvm.h ../../arch/x86/include/uapi/asm/kvm.h >/dev/null) \
 -        || echo "Warning: tools/arch/x86/include/uapi/asm/kvm.h differs from kernel" >&2 )) || true
 -	@(test -f ../../arch/x86/include/uapi/asm/kvm_perf.h && ( \
 -        (diff -B ../arch/x86/include/uapi/asm/kvm_perf.h ../../arch/x86/include/uapi/asm/kvm_perf.h >/dev/null) \
 -        || echo "Warning: tools/arch/x86/include/uapi/asm/kvm_perf.h differs from kernel" >&2 )) || true
 -	@(test -f ../../arch/x86/include/uapi/asm/svm.h && ( \
 -        (diff -B ../arch/x86/include/uapi/asm/svm.h ../../arch/x86/include/uapi/asm/svm.h >/dev/null) \
 -        || echo "Warning: tools/arch/x86/include/uapi/asm/svm.h differs from kernel" >&2 )) || true
 -	@(test -f ../../arch/x86/include/uapi/asm/vmx.h && ( \
 -        (diff -B ../arch/x86/include/uapi/asm/vmx.h ../../arch/x86/include/uapi/asm/vmx.h >/dev/null) \
 -        || echo "Warning: tools/arch/x86/include/uapi/asm/vmx.h differs from kernel" >&2 )) || true
 -	@(test -f ../../arch/powerpc/include/uapi/asm/kvm.h && ( \
 -        (diff -B ../arch/powerpc/include/uapi/asm/kvm.h ../../arch/powerpc/include/uapi/asm/kvm.h >/dev/null) \
 -        || echo "Warning: tools/arch/powerpc/include/uapi/asm/kvm.h differs from kernel" >&2 )) || true
 -	@(test -f ../../arch/s390/include/uapi/asm/kvm.h && ( \
 -        (diff -B ../arch/s390/include/uapi/asm/kvm.h ../../arch/s390/include/uapi/asm/kvm.h >/dev/null) \
 -        || echo "Warning: tools/arch/s390/include/uapi/asm/kvm.h differs from kernel" >&2 )) || true
 -	@(test -f ../../arch/s390/include/uapi/asm/kvm_perf.h && ( \
 -        (diff -B ../arch/s390/include/uapi/asm/kvm_perf.h ../../arch/s390/include/uapi/asm/kvm_perf.h >/dev/null) \
 -        || echo "Warning: tools/arch/s390/include/uapi/asm/kvm_perf.h differs from kernel" >&2 )) || true
 -	@(test -f ../../arch/s390/include/uapi/asm/sie.h && ( \
 -        (diff -B ../arch/s390/include/uapi/asm/sie.h ../../arch/s390/include/uapi/asm/sie.h >/dev/null) \
 -        || echo "Warning: tools/arch/s390/include/uapi/asm/sie.h differs from kernel" >&2 )) || true
 -	@(test -f ../../arch/arm/include/uapi/asm/kvm.h && ( \
 -        (diff -B ../arch/arm/include/uapi/asm/kvm.h ../../arch/arm/include/uapi/asm/kvm.h >/dev/null) \
 -        || echo "Warning: tools/arch/arm/include/uapi/asm/kvm.h differs from kernel" >&2 )) || true
 -	@(test -f ../../arch/arm64/include/uapi/asm/kvm.h && ( \
 -        (diff -B ../arch/arm64/include/uapi/asm/kvm.h ../../arch/arm64/include/uapi/asm/kvm.h >/dev/null) \
 -        || echo "Warning: tools/arch/arm64/include/uapi/asm/kvm.h differs from kernel" >&2 )) || true
 -	@(test -f ../../include/asm-generic/bitops/arch_hweight.h && ( \
 -        (diff -B ../include/asm-generic/bitops/arch_hweight.h ../../include/asm-generic/bitops/arch_hweight.h >/dev/null) \
 -        || echo "Warning: tools/include/asm-generic/bitops/arch_hweight.h differs from kernel" >&2 )) || true
 -	@(test -f ../../include/asm-generic/bitops/const_hweight.h && ( \
 -        (diff -B ../include/asm-generic/bitops/const_hweight.h ../../include/asm-generic/bitops/const_hweight.h >/dev/null) \
 -        || echo "Warning: tools/include/asm-generic/bitops/const_hweight.h differs from kernel" >&2 )) || true
 -	@(test -f ../../include/asm-generic/bitops/__fls.h && ( \
 -        (diff -B ../include/asm-generic/bitops/__fls.h ../../include/asm-generic/bitops/__fls.h >/dev/null) \
 -        || echo "Warning: tools/include/asm-generic/bitops/__fls.h differs from kernel" >&2 )) || true
 -	@(test -f ../../include/asm-generic/bitops/fls.h && ( \
 -        (diff -B ../include/asm-generic/bitops/fls.h ../../include/asm-generic/bitops/fls.h >/dev/null) \
 -        || echo "Warning: tools/include/asm-generic/bitops/fls.h differs from kernel" >&2 )) || true
 -	@(test -f ../../include/asm-generic/bitops/fls64.h && ( \
 -        (diff -B ../include/asm-generic/bitops/fls64.h ../../include/asm-generic/bitops/fls64.h >/dev/null) \
 -        || echo "Warning: tools/include/asm-generic/bitops/fls64.h differs from kernel" >&2 )) || true
 -	@(test -f ../../include/linux/coresight-pmu.h && ( \
 -	(diff -B ../include/linux/coresight-pmu.h ../../include/linux/coresight-pmu.h >/dev/null) \
 -	|| echo "Warning: tools/include/linux/coresight-pmu.h differs from kernel" >&2 )) || true
 -	@(test -f ../../include/uapi/asm-generic/mman-common.h && ( \
 -	(diff -B ../include/uapi/asm-generic/mman-common.h ../../include/uapi/asm-generic/mman-common.h >/dev/null) \
 -	|| echo "Warning: tools/include/uapi/asm-generic/mman-common.h differs from kernel" >&2 )) || true
 -	@(test -f ../../include/uapi/asm-generic/mman.h && ( \
 -	(diff -B -I "^#include <\(uapi/\)*asm-generic/mman-common.h>$$" ../include/uapi/asm-generic/mman.h ../../include/uapi/asm-generic/mman.h >/dev/null) \
 -	|| echo "Warning: tools/include/uapi/asm-generic/mman.h differs from kernel" >&2 )) || true
 -	@(test -f ../../include/uapi/linux/mman.h && ( \
 -	(diff -B -I "^#include <\(uapi/\)*asm/mman.h>$$" ../include/uapi/linux/mman.h ../../include/uapi/linux/mman.h >/dev/null) \
 -	|| echo "Warning: tools/include/uapi/linux/mman.h differs from kernel" >&2 )) || true
  	$(Q)$(MAKE) $(build)=perf
  
 -$(JEVENTS_IN): FORCE
 -	$(Q)$(MAKE) -f $(srctree)/tools/build/Makefile.build dir=pmu-events obj=jevents
 -
 -$(JEVENTS): $(JEVENTS_IN)
 -	$(QUIET_LINK)$(HOSTCC) $(JEVENTS_IN) -o $@
 -
 -$(PMU_EVENTS_IN): $(JEVENTS) FORCE
 -	$(Q)$(MAKE) -f $(srctree)/tools/build/Makefile.build dir=pmu-events obj=pmu-events
 -
 -$(OUTPUT)perf: $(PERFLIBS) $(PERF_IN) $(PMU_EVENTS_IN) $(LIBTRACEEVENT_DYNAMIC_LIST)
 +$(OUTPUT)perf: $(PERFLIBS) $(PERF_IN) $(LIBTRACEEVENT_DYNAMIC_LIST)
  	$(QUIET_LINK)$(CC) $(CFLAGS) $(LDFLAGS) $(LIBTRACEEVENT_DYNAMIC_LIST_LDFLAGS) \
 -		$(PERF_IN) $(PMU_EVENTS_IN) $(LIBS) -o $@
 +		$(PERF_IN) $(LIBS) -o $@
  
- $(GTK_IN): fixdep FORCE
+ $(GTK_IN): FORCE
  	$(Q)$(MAKE) $(build)=gtk
  
  $(OUTPUT)libperf-gtk.so: $(GTK_IN) $(PERFLIBS)
@@@ -371,7 -561,7 +411,11 @@@ endi
  __build-dir = $(subst $(OUTPUT),,$(dir $@))
  build-dir   = $(if $(__build-dir),$(__build-dir),.)
  
++<<<<<<< HEAD
 +prepare: $(OUTPUT)PERF-VERSION-FILE $(OUTPUT)common-cmds.h fixdep
++=======
+ prepare: $(OUTPUT)PERF-VERSION-FILE $(OUTPUT)common-cmds.h archheaders
++>>>>>>> abb26210a395 (perf tools: Force fixdep compilation at the start of the build)
  
  $(OUTPUT)%.o: %.c prepare FORCE
  	$(Q)$(MAKE) -f $(srctree)/tools/build/Makefile.build dir=$(build-dir) $@
@@@ -411,7 -611,7 +455,11 @@@ $(patsubst perf-%,%.o,$(PROGRAMS)): $(w
  
  LIBPERF_IN := $(OUTPUT)libperf-in.o
  
++<<<<<<< HEAD
 +$(LIBPERF_IN): fixdep FORCE
++=======
+ $(LIBPERF_IN): prepare FORCE
++>>>>>>> abb26210a395 (perf tools: Force fixdep compilation at the start of the build)
  	$(Q)$(MAKE) $(build)=libperf
  
  $(LIB_FILE): $(LIBPERF_IN)
@@@ -442,7 -642,14 +490,18 @@@ $(LIBAPI)-clean
  	$(call QUIET_CLEAN, libapi)
  	$(Q)$(MAKE) -C $(LIB_DIR) O=$(OUTPUT) clean >/dev/null
  
++<<<<<<< HEAD
 +$(LIBSUBCMD): fixdep FORCE
++=======
+ $(LIBBPF): FORCE
+ 	$(Q)$(MAKE) -C $(BPF_DIR) O=$(OUTPUT) $(OUTPUT)libbpf.a FEATURES_DUMP=$(FEATURE_DUMP_EXPORT)
+ 
+ $(LIBBPF)-clean:
+ 	$(call QUIET_CLEAN, libbpf)
+ 	$(Q)$(MAKE) -C $(BPF_DIR) O=$(OUTPUT) clean >/dev/null
+ 
+ $(LIBSUBCMD): FORCE
++>>>>>>> abb26210a395 (perf tools: Force fixdep compilation at the start of the build)
  	$(Q)$(MAKE) -C $(SUBCMD_DIR) O=$(OUTPUT) $(OUTPUT)libsubcmd.a
  
  $(LIBSUBCMD)-clean:
@@@ -643,5 -855,6 +702,6 @@@ FORCE
  .PHONY: all install clean config-clean strip install-gtk
  .PHONY: shell_compatibility_test please_set_SHELL_PATH_to_a_more_modern_shell
  .PHONY: $(GIT-HEAD-PHONY) TAGS tags cscope FORCE prepare
 -.PHONY: libtraceevent_plugins archheaders
 +.PHONY: libtraceevent_plugins
  
+ endif # force_fixdep
* Unmerged path tools/perf/Makefile.perf
