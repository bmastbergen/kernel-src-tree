amd-xgbe: Perform Tx coalescing on a packet basis

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Lendacky, Thomas <Thomas.Lendacky@amd.com>
commit eb79e640fab1fc163e6f04e0cc007c76b6a46f28
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/eb79e640.failed

The current form of Tx coalescing works on a descriptor basis instead
of on a packet basis and doesn't take into account TSO packets. Update
the Tx coalescing support to work on a packet basis, taking into
account the number of packets associated with a TSO transmit. Also,
only activate the Tx timer if a timer value is set.

	Signed-off-by: Tom Lendacky <thomas.lendacky@amd.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit eb79e640fab1fc163e6f04e0cc007c76b6a46f28)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/amd/xgbe/xgbe-dev.c
diff --cc drivers/net/ethernet/amd/xgbe/xgbe-dev.c
index 81bd491c7d02,b3d2433b52bb..000000000000
--- a/drivers/net/ethernet/amd/xgbe/xgbe-dev.c
+++ b/drivers/net/ethernet/amd/xgbe/xgbe-dev.c
@@@ -994,12 -1439,9 +1010,18 @@@ static void xgbe_pre_xmit(struct xgbe_c
  		XGMAC_SET_BITS_LE(rdesc->desc2, TX_NORMAL_DESC2, VTIR,
  				  TX_NORMAL_DESC2_VLAN_INSERT);
  
++<<<<<<< HEAD
 +	/* Set IC bit based on Tx coalescing settings */
 +	XGMAC_SET_BITS_LE(rdesc->desc2, TX_NORMAL_DESC2, IC, 1);
 +	if (tx_coalesce && (!tx_frames ||
 +			    (++ring->coalesce_count % tx_frames)))
 +		/* Clear IC bit */
 +		XGMAC_SET_BITS_LE(rdesc->desc2, TX_NORMAL_DESC2, IC, 0);
++=======
+ 	/* Timestamp enablement check */
+ 	if (XGMAC_GET_BITS(packet->attributes, TX_PACKET_ATTRIBUTES, PTP))
+ 		XGMAC_SET_BITS_LE(rdesc->desc2, TX_NORMAL_DESC2, TTSE, 1);
++>>>>>>> eb79e640fab1 (amd-xgbe: Perform Tx coalescing on a packet basis)
  
  	/* Mark it as First Descriptor */
  	XGMAC_SET_BITS_LE(rdesc->desc3, TX_NORMAL_DESC3, FD, 1);
@@@ -1067,6 -1502,14 +1082,17 @@@
  	/* Set LAST bit for the last descriptor */
  	XGMAC_SET_BITS_LE(rdesc->desc3, TX_NORMAL_DESC3, LD, 1);
  
++<<<<<<< HEAD
++=======
+ 	/* Set IC bit based on Tx coalescing settings */
+ 	if (tx_set_ic)
+ 		XGMAC_SET_BITS_LE(rdesc->desc2, TX_NORMAL_DESC2, IC, 1);
+ 
+ 	/* Save the Tx info to report back during cleanup */
+ 	rdata->tx.packets = packet->tx_packets;
+ 	rdata->tx.bytes = packet->tx_bytes;
+ 
++>>>>>>> eb79e640fab1 (amd-xgbe: Perform Tx coalescing on a packet basis)
  	/* In case the Tx DMA engine is running, make sure everything
  	 * is written to the descriptor(s) before setting the OWN bit
  	 * for the first descriptor
* Unmerged path drivers/net/ethernet/amd/xgbe/xgbe-dev.c
