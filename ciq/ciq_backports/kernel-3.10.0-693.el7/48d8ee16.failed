net sched actions: aggregate dumping of actions timeinfo

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
Rebuild_CHGLOG: - [net] sched: actions: aggregate dumping of actions timeinfo (Ivan Vecera) [1442088]
Rebuild_FUZZ: 95.41%
commit-author Jamal Hadi Salim <jhs@mojatatu.com>
commit 48d8ee1694dd1ab25614b58f968123a4598f887e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/48d8ee16.failed

	Signed-off-by: Jamal Hadi Salim <jhs@mojatatu.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 48d8ee1694dd1ab25614b58f968123a4598f887e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/sched/act_bpf.c
#	net/sched/act_connmark.c
#	net/sched/act_csum.c
#	net/sched/act_gact.c
#	net/sched/act_ife.c
#	net/sched/act_ipt.c
#	net/sched/act_mirred.c
#	net/sched/act_nat.c
#	net/sched/act_pedit.c
#	net/sched/act_simple.c
#	net/sched/act_skbedit.c
#	net/sched/act_vlan.c
diff --cc net/sched/act_csum.c
index 11fe1a416433,dcd9ababd351..000000000000
--- a/net/sched/act_csum.c
+++ b/net/sched/act_csum.c
@@@ -563,10 -546,9 +563,16 @@@ static int tcf_csum_dump(struct sk_buf
  
  	if (nla_put(skb, TCA_CSUM_PARMS, sizeof(opt), &opt))
  		goto nla_put_failure;
++<<<<<<< HEAD
 +	t.install = jiffies_to_clock_t(jiffies - p->tcf_tm.install);
 +	t.lastuse = jiffies_to_clock_t(jiffies - p->tcf_tm.lastuse);
 +	t.expires = jiffies_to_clock_t(p->tcf_tm.expires);
 +	if (nla_put(skb, TCA_CSUM_TM, sizeof(t), &t))
++=======
+ 
+ 	tcf_tm_dump(&t, &p->tcf_tm);
+ 	if (nla_put_64bit(skb, TCA_CSUM_TM, sizeof(t), &t, TCA_CSUM_PAD))
++>>>>>>> 48d8ee1694dd (net sched actions: aggregate dumping of actions timeinfo)
  		goto nla_put_failure;
  
  	return skb->len;
diff --cc net/sched/act_gact.c
index 085ab295a109,4c6e0085054a..000000000000
--- a/net/sched/act_gact.c
+++ b/net/sched/act_gact.c
@@@ -200,10 -188,8 +200,15 @@@ static int tcf_gact_dump(struct sk_buf
  			goto nla_put_failure;
  	}
  #endif
++<<<<<<< HEAD
 +	t.install = jiffies_to_clock_t(jiffies - gact->tcf_tm.install);
 +	t.lastuse = jiffies_to_clock_t(jiffies - gact->tcf_tm.lastuse);
 +	t.expires = jiffies_to_clock_t(gact->tcf_tm.expires);
 +	if (nla_put(skb, TCA_GACT_TM, sizeof(t), &t))
++=======
+ 	tcf_tm_dump(&t, &gact->tcf_tm);
+ 	if (nla_put_64bit(skb, TCA_GACT_TM, sizeof(t), &t, TCA_GACT_PAD))
++>>>>>>> 48d8ee1694dd (net sched actions: aggregate dumping of actions timeinfo)
  		goto nla_put_failure;
  	return skb->len;
  
diff --cc net/sched/act_ipt.c
index 90a973aacc76,3fcde44b8f4d..000000000000
--- a/net/sched/act_ipt.c
+++ b/net/sched/act_ipt.c
@@@ -279,11 -277,11 +279,18 @@@ static int tcf_ipt_dump(struct sk_buff 
  	    nla_put(skb, TCA_IPT_CNT, sizeof(struct tc_cnt), &c) ||
  	    nla_put_string(skb, TCA_IPT_TABLE, ipt->tcfi_tname))
  		goto nla_put_failure;
++<<<<<<< HEAD
 +	tm.install = jiffies_to_clock_t(jiffies - ipt->tcf_tm.install);
 +	tm.lastuse = jiffies_to_clock_t(jiffies - ipt->tcf_tm.lastuse);
 +	tm.expires = jiffies_to_clock_t(ipt->tcf_tm.expires);
 +	if (nla_put(skb, TCA_IPT_TM, sizeof (tm), &tm))
++=======
+ 
+ 	tcf_tm_dump(&tm, &ipt->tcf_tm);
+ 	if (nla_put_64bit(skb, TCA_IPT_TM, sizeof(tm), &tm, TCA_IPT_PAD))
++>>>>>>> 48d8ee1694dd (net sched actions: aggregate dumping of actions timeinfo)
  		goto nla_put_failure;
+ 
  	kfree(t);
  	return skb->len;
  
diff --cc net/sched/act_mirred.c
index 4b6188539f6c,787751a7981a..000000000000
--- a/net/sched/act_mirred.c
+++ b/net/sched/act_mirred.c
@@@ -228,10 -218,9 +228,16 @@@ static int tcf_mirred_dump(struct sk_bu
  
  	if (nla_put(skb, TCA_MIRRED_PARMS, sizeof(opt), &opt))
  		goto nla_put_failure;
++<<<<<<< HEAD
 +	t.install = jiffies_to_clock_t(jiffies - m->tcf_tm.install);
 +	t.lastuse = jiffies_to_clock_t(jiffies - m->tcf_tm.lastuse);
 +	t.expires = jiffies_to_clock_t(m->tcf_tm.expires);
 +	if (nla_put(skb, TCA_MIRRED_TM, sizeof(t), &t))
++=======
+ 
+ 	tcf_tm_dump(&t, &m->tcf_tm);
+ 	if (nla_put_64bit(skb, TCA_MIRRED_TM, sizeof(t), &t, TCA_MIRRED_PAD))
++>>>>>>> 48d8ee1694dd (net sched actions: aggregate dumping of actions timeinfo)
  		goto nla_put_failure;
  	return skb->len;
  
diff --cc net/sched/act_nat.c
index 76869538d028,06ccb03f25da..000000000000
--- a/net/sched/act_nat.c
+++ b/net/sched/act_nat.c
@@@ -286,10 -264,9 +286,16 @@@ static int tcf_nat_dump(struct sk_buff 
  
  	if (nla_put(skb, TCA_NAT_PARMS, sizeof(opt), &opt))
  		goto nla_put_failure;
++<<<<<<< HEAD
 +	t.install = jiffies_to_clock_t(jiffies - p->tcf_tm.install);
 +	t.lastuse = jiffies_to_clock_t(jiffies - p->tcf_tm.lastuse);
 +	t.expires = jiffies_to_clock_t(p->tcf_tm.expires);
 +	if (nla_put(skb, TCA_NAT_TM, sizeof(t), &t))
++=======
+ 
+ 	tcf_tm_dump(&t, &p->tcf_tm);
+ 	if (nla_put_64bit(skb, TCA_NAT_TM, sizeof(t), &t, TCA_NAT_PAD))
++>>>>>>> 48d8ee1694dd (net sched actions: aggregate dumping of actions timeinfo)
  		goto nla_put_failure;
  
  	return skb->len;
diff --cc net/sched/act_pedit.c
index 0978c6d2f6cf,82d3c1479029..000000000000
--- a/net/sched/act_pedit.c
+++ b/net/sched/act_pedit.c
@@@ -219,11 -200,11 +219,18 @@@ static int tcf_pedit_dump(struct sk_buf
  
  	if (nla_put(skb, TCA_PEDIT_PARMS, s, opt))
  		goto nla_put_failure;
++<<<<<<< HEAD
 +	t.install = jiffies_to_clock_t(jiffies - p->tcf_tm.install);
 +	t.lastuse = jiffies_to_clock_t(jiffies - p->tcf_tm.lastuse);
 +	t.expires = jiffies_to_clock_t(p->tcf_tm.expires);
 +	if (nla_put(skb, TCA_PEDIT_TM, sizeof(t), &t))
++=======
+ 
+ 	tcf_tm_dump(&t, &p->tcf_tm);
+ 	if (nla_put_64bit(skb, TCA_PEDIT_TM, sizeof(t), &t, TCA_PEDIT_PAD))
++>>>>>>> 48d8ee1694dd (net sched actions: aggregate dumping of actions timeinfo)
  		goto nla_put_failure;
+ 
  	kfree(opt);
  	return skb->len;
  
diff --cc net/sched/act_simple.c
index f7b45ab85388,be5fbb51cfed..000000000000
--- a/net/sched/act_simple.c
+++ b/net/sched/act_simple.c
@@@ -182,10 -158,9 +182,16 @@@ static int tcf_simp_dump(struct sk_buf
  	if (nla_put(skb, TCA_DEF_PARMS, sizeof(opt), &opt) ||
  	    nla_put_string(skb, TCA_DEF_DATA, d->tcfd_defdata))
  		goto nla_put_failure;
++<<<<<<< HEAD
 +	t.install = jiffies_to_clock_t(jiffies - d->tcf_tm.install);
 +	t.lastuse = jiffies_to_clock_t(jiffies - d->tcf_tm.lastuse);
 +	t.expires = jiffies_to_clock_t(d->tcf_tm.expires);
 +	if (nla_put(skb, TCA_DEF_TM, sizeof(t), &t))
++=======
+ 
+ 	tcf_tm_dump(&t, &d->tcf_tm);
+ 	if (nla_put_64bit(skb, TCA_DEF_TM, sizeof(t), &t, TCA_DEF_PAD))
++>>>>>>> 48d8ee1694dd (net sched actions: aggregate dumping of actions timeinfo)
  		goto nla_put_failure;
  	return skb->len;
  
diff --cc net/sched/act_skbedit.c
index 8fe9d25c3008,7e2bc3c2b6da..000000000000
--- a/net/sched/act_skbedit.c
+++ b/net/sched/act_skbedit.c
@@@ -182,10 -168,9 +182,16 @@@ static int tcf_skbedit_dump(struct sk_b
  	    nla_put(skb, TCA_SKBEDIT_MARK, sizeof(d->mark),
  		    &d->mark))
  		goto nla_put_failure;
++<<<<<<< HEAD
 +	t.install = jiffies_to_clock_t(jiffies - d->tcf_tm.install);
 +	t.lastuse = jiffies_to_clock_t(jiffies - d->tcf_tm.lastuse);
 +	t.expires = jiffies_to_clock_t(d->tcf_tm.expires);
 +	if (nla_put(skb, TCA_SKBEDIT_TM, sizeof(t), &t))
++=======
+ 
+ 	tcf_tm_dump(&t, &d->tcf_tm);
+ 	if (nla_put_64bit(skb, TCA_SKBEDIT_TM, sizeof(t), &t, TCA_SKBEDIT_PAD))
++>>>>>>> 48d8ee1694dd (net sched actions: aggregate dumping of actions timeinfo)
  		goto nla_put_failure;
  	return skb->len;
  
diff --cc net/sched/act_vlan.c
index d735ecf0b1a7,f0a08a11f54f..000000000000
--- a/net/sched/act_vlan.c
+++ b/net/sched/act_vlan.c
@@@ -168,10 -182,8 +168,15 @@@ static int tcf_vlan_dump(struct sk_buf
  	     nla_put_be16(skb, TCA_VLAN_PUSH_VLAN_PROTOCOL, v->tcfv_push_proto)))
  		goto nla_put_failure;
  
++<<<<<<< HEAD
 +	t.install = jiffies_to_clock_t(jiffies - v->tcf_tm.install);
 +	t.lastuse = jiffies_to_clock_t(jiffies - v->tcf_tm.lastuse);
 +	t.expires = jiffies_to_clock_t(v->tcf_tm.expires);
 +	if (nla_put(skb, TCA_VLAN_TM, sizeof(t), &t))
++=======
+ 	tcf_tm_dump(&t, &v->tcf_tm);
+ 	if (nla_put_64bit(skb, TCA_VLAN_TM, sizeof(t), &t, TCA_VLAN_PAD))
++>>>>>>> 48d8ee1694dd (net sched actions: aggregate dumping of actions timeinfo)
  		goto nla_put_failure;
  	return skb->len;
  
* Unmerged path net/sched/act_bpf.c
* Unmerged path net/sched/act_connmark.c
* Unmerged path net/sched/act_ife.c
diff --git a/include/net/act_api.h b/include/net/act_api.h
index 11aac9abd0ca..122d5b807c5c 100644
--- a/include/net/act_api.h
+++ b/include/net/act_api.h
@@ -51,6 +51,14 @@ static inline unsigned int tcf_hash(u32 index, unsigned int hmask)
 #define ACT_P_CREATED 1
 #define ACT_P_DELETED 1
 
+static inline void tcf_tm_dump(struct tcf_t *dtm, const struct tcf_t *stm)
+{
+	dtm->install = jiffies_to_clock_t(jiffies - stm->install);
+	dtm->lastuse = jiffies_to_clock_t(jiffies - stm->lastuse);
+	dtm->firstuse = jiffies_to_clock_t(jiffies - stm->firstuse);
+	dtm->expires = jiffies_to_clock_t(stm->expires);
+}
+
 struct tc_action {
 	void			*priv;
 	const struct tc_action_ops	*ops;
* Unmerged path net/sched/act_bpf.c
* Unmerged path net/sched/act_connmark.c
* Unmerged path net/sched/act_csum.c
* Unmerged path net/sched/act_gact.c
* Unmerged path net/sched/act_ife.c
* Unmerged path net/sched/act_ipt.c
* Unmerged path net/sched/act_mirred.c
* Unmerged path net/sched/act_nat.c
* Unmerged path net/sched/act_pedit.c
* Unmerged path net/sched/act_simple.c
* Unmerged path net/sched/act_skbedit.c
* Unmerged path net/sched/act_vlan.c
