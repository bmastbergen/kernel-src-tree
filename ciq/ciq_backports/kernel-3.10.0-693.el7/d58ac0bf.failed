perf build: Add clang and llvm compile and linking support

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Wang Nan <wangnan0@huawei.com>
commit d58ac0bf8d1e6ffbfcb0a77e459cf4737b131b75
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/d58ac0bf.failed

Add necessary c++ flags and link libraries to support builtin clang and
LLVM. Add all llvm and clang libraries, so don't need to worry about
clang changes its libraries setting. However, linking perf would take
much longer than usual.

	Signed-off-by: Wang Nan <wangnan0@huawei.com>
	Cc: Alexei Starovoitov <ast@fb.com>
	Cc: He Kuang <hekuang@huawei.com>
	Cc: Jiri Olsa <jolsa@kernel.org>
	Cc: Joe Stringer <joe@ovn.org>
	Cc: Zefan Li <lizefan@huawei.com>
	Cc: pi3orama@163.com
Link: http://lkml.kernel.org/r/20161126070354.141764-10-wangnan0@huawei.com
	Signed-off-by: Arnaldo Carvalho de Melo <acme@redhat.com>
(cherry picked from commit d58ac0bf8d1e6ffbfcb0a77e459cf4737b131b75)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/perf/Makefile.config
#	tools/perf/Makefile.perf
#	tools/perf/tests/make
diff --cc tools/perf/Makefile.config
index 37a8404311a3,b7c9c8051a33..000000000000
--- a/tools/perf/Makefile.config
+++ b/tools/perf/Makefile.config
@@@ -720,6 -766,58 +728,61 @@@ ifndef NO_AUXTRAC
    endif
  endif
  
++<<<<<<< HEAD
++=======
+ ifndef NO_JVMTI
+   ifneq (,$(wildcard /usr/sbin/update-java-alternatives))
+     JDIR=$(shell /usr/sbin/update-java-alternatives -l | head -1 | awk '{print $$3}')
+   else
+     ifneq (,$(wildcard /usr/sbin/alternatives))
+       JDIR=$(shell alternatives --display java | tail -1 | cut -d' ' -f 5 | sed 's%/jre/bin/java.%%g')
+     endif
+   endif
+   ifndef JDIR
+     $(warning No alternatives command found, you need to set JDIR= to point to the root of your Java directory)
+     NO_JVMTI := 1
+   endif
+ endif
+ 
+ ifndef NO_JVMTI
+   FEATURE_CHECK_CFLAGS-jvmti := -I$(JDIR)/include -I$(JDIR)/include/linux
+   $(call feature_check,jvmti)
+   ifeq ($(feature-jvmti), 1)
+     $(call detected_var,JDIR)
+   else
+     $(warning No openjdk development package found, please install JDK package)
+     NO_JVMTI := 1
+   endif
+ endif
+ 
+ USE_CXX = 0
+ USE_CLANGLLVM = 0
+ ifdef LIBCLANGLLVM
+   $(call feature_check,cxx)
+   ifneq ($(feature-cxx), 1)
+     msg := $(warning No g++ found, disable clang and llvm support. Please install g++)
+   else
+     $(call feature_check,llvm)
+     ifneq ($(feature-llvm), 1)
+       msg := $(warning No libLLVM found, disable clang and llvm support. Please install llvm-dev)
+     else
+       $(call feature_check,clang)
+       ifneq ($(feature-clang), 1)
+         msg := $(warning No libclang found, disable clang and llvm support. Please install libclang-dev)
+       else
+         CFLAGS += -DHAVE_LIBCLANGLLVM_SUPPORT
+         CXXFLAGS += -DHAVE_LIBCLANGLLVM_SUPPORT -I$(shell $(LLVM_CONFIG) --includedir)
+         $(call detected,CONFIG_CXX)
+         $(call detected,CONFIG_CLANGLLVM)
+ 	USE_CXX = 1
+ 	USE_LLVM = 1
+ 	USE_CLANG = 1
+       endif
+     endif
+   endif
+ endif
+ 
++>>>>>>> d58ac0bf8d1e (perf build: Add clang and llvm compile and linking support)
  # Among the variables below, these:
  #   perfexecdir
  #   template_dir
diff --cc tools/perf/Makefile.perf
index 451c6ea1ccbc,dfb20dd31865..000000000000
--- a/tools/perf/Makefile.perf
+++ b/tools/perf/Makefile.perf
@@@ -79,8 -79,19 +79,17 @@@ include ../scripts/utilities.ma
  #
  # Define NO_AUXTRACE if you do not want AUX area tracing support
  #
 -# Define NO_LIBBPF if you do not want BPF support
 -#
 -# Define NO_SDT if you do not want to define SDT event in perf tools,
 -# note that it doesn't disable SDT scanning support.
 -#
  # Define FEATURES_DUMP to provide features detection dump file
  # and bypass the feature detection
++<<<<<<< HEAD
++=======
+ #
+ # Define NO_JVMTI if you do not want jvmti agent built
+ #
+ # Define LIBCLANGLLVM if you DO want builtin clang and llvm support.
+ # When selected, pass LLVM_CONFIG=/path/to/llvm-config to `make' if
+ # llvm-config is not in $PATH.
++>>>>>>> d58ac0bf8d1e (perf build: Add clang and llvm compile and linking support)
  
  # As per kernel Makefile, avoid funny character set dependencies
  unexport LC_ALL
@@@ -139,7 -151,12 +149,8 @@@ $(call allow-override,CXX,$(CROSS_COMPI
  
  LD += $(EXTRA_LDFLAGS)
  
 -HOSTCC  ?= gcc
 -HOSTLD  ?= ld
 -HOSTAR  ?= ar
 -
  PKG_CONFIG = $(CROSS_COMPILE)pkg-config
+ LLVM_CONFIG ?= llvm-config
  
  RM      = rm -f
  LN      = ln -f
@@@ -326,15 -377,127 +352,20 @@@ strip: $(PROGRAMS) $(OUTPUT)per
  
  PERF_IN := $(OUTPUT)perf-in.o
  
++<<<<<<< HEAD
 +export srctree OUTPUT RM CC LD AR CFLAGS V BISON FLEX AWK
++=======
+ export srctree OUTPUT RM CC CXX LD AR CFLAGS CXXFLAGS V BISON FLEX AWK
+ export HOSTCC HOSTLD HOSTAR
++>>>>>>> d58ac0bf8d1e (perf build: Add clang and llvm compile and linking support)
  include $(srctree)/tools/build/Makefile.include
  
 -JEVENTS       := $(OUTPUT)pmu-events/jevents
 -JEVENTS_IN    := $(OUTPUT)pmu-events/jevents-in.o
 -
 -PMU_EVENTS_IN := $(OUTPUT)pmu-events/pmu-events-in.o
 -
 -export JEVENTS
 -
 -build := -f $(srctree)/tools/build/Makefile.build dir=. obj
 -
  $(PERF_IN): prepare FORCE
 -	@(test -f ../../include/uapi/linux/perf_event.h && ( \
 -        (diff -B ../include/uapi/linux/perf_event.h ../../include/uapi/linux/perf_event.h >/dev/null) \
 -        || echo "Warning: tools/include/uapi/linux/perf_event.h differs from kernel" >&2 )) || true
 -	@(test -f ../../include/linux/hash.h && ( \
 -        (diff -B ../include/linux/hash.h ../../include/linux/hash.h >/dev/null) \
 -        || echo "Warning: tools/include/linux/hash.h differs from kernel" >&2 )) || true
 -	@(test -f ../../include/uapi/linux/hw_breakpoint.h && ( \
 -        (diff -B ../include/uapi/linux/hw_breakpoint.h ../../include/uapi/linux/hw_breakpoint.h >/dev/null) \
 -        || echo "Warning: tools/include/uapi/linux/hw_breakpoint.h differs from kernel" >&2 )) || true
 -	@(test -f ../../arch/x86/include/asm/disabled-features.h && ( \
 -        (diff -B ../arch/x86/include/asm/disabled-features.h ../../arch/x86/include/asm/disabled-features.h >/dev/null) \
 -        || echo "Warning: tools/arch/x86/include/asm/disabled-features.h differs from kernel" >&2 )) || true
 -	@(test -f ../../arch/x86/include/asm/required-features.h && ( \
 -        (diff -B ../arch/x86/include/asm/required-features.h ../../arch/x86/include/asm/required-features.h >/dev/null) \
 -        || echo "Warning: tools/arch/x86/include/asm/required-features.h differs from kernel" >&2 )) || true
 -	@(test -f ../../arch/x86/include/asm/cpufeatures.h && ( \
 -        (diff -B ../arch/x86/include/asm/cpufeatures.h ../../arch/x86/include/asm/cpufeatures.h >/dev/null) \
 -        || echo "Warning: tools/arch/x86/include/asm/cpufeatures.h differs from kernel" >&2 )) || true
 -	@(test -f ../../arch/x86/lib/memcpy_64.S && ( \
 -        (diff -B -I "^EXPORT_SYMBOL" -I "^#include <asm/export.h>" ../arch/x86/lib/memcpy_64.S ../../arch/x86/lib/memcpy_64.S >/dev/null) \
 -        || echo "Warning: tools/arch/x86/lib/memcpy_64.S differs from kernel" >&2 )) || true
 -	@(test -f ../../arch/x86/lib/memset_64.S && ( \
 -        (diff -B -I "^EXPORT_SYMBOL" -I "^#include <asm/export.h>" ../arch/x86/lib/memset_64.S ../../arch/x86/lib/memset_64.S >/dev/null) \
 -        || echo "Warning: tools/arch/x86/lib/memset_64.S differs from kernel" >&2 )) || true
 -	@(test -f ../../arch/arm/include/uapi/asm/perf_regs.h && ( \
 -        (diff -B ../arch/arm/include/uapi/asm/perf_regs.h ../../arch/arm/include/uapi/asm/perf_regs.h >/dev/null) \
 -        || echo "Warning: tools/arch/arm/include/uapi/asm/perf_regs.h differs from kernel" >&2 )) || true
 -	@(test -f ../../arch/arm64/include/uapi/asm/perf_regs.h && ( \
 -        (diff -B ../arch/arm64/include/uapi/asm/perf_regs.h ../../arch/arm64/include/uapi/asm/perf_regs.h >/dev/null) \
 -        || echo "Warning: tools/arch/arm64/include/uapi/asm/perf_regs.h differs from kernel" >&2 )) || true
 -	@(test -f ../../arch/powerpc/include/uapi/asm/perf_regs.h && ( \
 -        (diff -B ../arch/powerpc/include/uapi/asm/perf_regs.h ../../arch/powerpc/include/uapi/asm/perf_regs.h >/dev/null) \
 -        || echo "Warning: tools/arch/powerpc/include/uapi/asm/perf_regs.h differs from kernel" >&2 )) || true
 -	@(test -f ../../arch/x86/include/uapi/asm/perf_regs.h && ( \
 -        (diff -B ../arch/x86/include/uapi/asm/perf_regs.h ../../arch/x86/include/uapi/asm/perf_regs.h >/dev/null) \
 -        || echo "Warning: tools/arch/x86/include/uapi/asm/perf_regs.h differs from kernel" >&2 )) || true
 -	@(test -f ../../arch/x86/include/uapi/asm/kvm.h && ( \
 -        (diff -B ../arch/x86/include/uapi/asm/kvm.h ../../arch/x86/include/uapi/asm/kvm.h >/dev/null) \
 -        || echo "Warning: tools/arch/x86/include/uapi/asm/kvm.h differs from kernel" >&2 )) || true
 -	@(test -f ../../arch/x86/include/uapi/asm/kvm_perf.h && ( \
 -        (diff -B ../arch/x86/include/uapi/asm/kvm_perf.h ../../arch/x86/include/uapi/asm/kvm_perf.h >/dev/null) \
 -        || echo "Warning: tools/arch/x86/include/uapi/asm/kvm_perf.h differs from kernel" >&2 )) || true
 -	@(test -f ../../arch/x86/include/uapi/asm/svm.h && ( \
 -        (diff -B ../arch/x86/include/uapi/asm/svm.h ../../arch/x86/include/uapi/asm/svm.h >/dev/null) \
 -        || echo "Warning: tools/arch/x86/include/uapi/asm/svm.h differs from kernel" >&2 )) || true
 -	@(test -f ../../arch/x86/include/uapi/asm/vmx.h && ( \
 -        (diff -B ../arch/x86/include/uapi/asm/vmx.h ../../arch/x86/include/uapi/asm/vmx.h >/dev/null) \
 -        || echo "Warning: tools/arch/x86/include/uapi/asm/vmx.h differs from kernel" >&2 )) || true
 -	@(test -f ../../arch/powerpc/include/uapi/asm/kvm.h && ( \
 -        (diff -B ../arch/powerpc/include/uapi/asm/kvm.h ../../arch/powerpc/include/uapi/asm/kvm.h >/dev/null) \
 -        || echo "Warning: tools/arch/powerpc/include/uapi/asm/kvm.h differs from kernel" >&2 )) || true
 -	@(test -f ../../arch/s390/include/uapi/asm/kvm.h && ( \
 -        (diff -B ../arch/s390/include/uapi/asm/kvm.h ../../arch/s390/include/uapi/asm/kvm.h >/dev/null) \
 -        || echo "Warning: tools/arch/s390/include/uapi/asm/kvm.h differs from kernel" >&2 )) || true
 -	@(test -f ../../arch/s390/include/uapi/asm/kvm_perf.h && ( \
 -        (diff -B ../arch/s390/include/uapi/asm/kvm_perf.h ../../arch/s390/include/uapi/asm/kvm_perf.h >/dev/null) \
 -        || echo "Warning: tools/arch/s390/include/uapi/asm/kvm_perf.h differs from kernel" >&2 )) || true
 -	@(test -f ../../arch/s390/include/uapi/asm/sie.h && ( \
 -        (diff -B ../arch/s390/include/uapi/asm/sie.h ../../arch/s390/include/uapi/asm/sie.h >/dev/null) \
 -        || echo "Warning: tools/arch/s390/include/uapi/asm/sie.h differs from kernel" >&2 )) || true
 -	@(test -f ../../arch/arm/include/uapi/asm/kvm.h && ( \
 -        (diff -B ../arch/arm/include/uapi/asm/kvm.h ../../arch/arm/include/uapi/asm/kvm.h >/dev/null) \
 -        || echo "Warning: tools/arch/arm/include/uapi/asm/kvm.h differs from kernel" >&2 )) || true
 -	@(test -f ../../arch/arm64/include/uapi/asm/kvm.h && ( \
 -        (diff -B ../arch/arm64/include/uapi/asm/kvm.h ../../arch/arm64/include/uapi/asm/kvm.h >/dev/null) \
 -        || echo "Warning: tools/arch/arm64/include/uapi/asm/kvm.h differs from kernel" >&2 )) || true
 -	@(test -f ../../include/asm-generic/bitops/arch_hweight.h && ( \
 -        (diff -B ../include/asm-generic/bitops/arch_hweight.h ../../include/asm-generic/bitops/arch_hweight.h >/dev/null) \
 -        || echo "Warning: tools/include/asm-generic/bitops/arch_hweight.h differs from kernel" >&2 )) || true
 -	@(test -f ../../include/asm-generic/bitops/const_hweight.h && ( \
 -        (diff -B ../include/asm-generic/bitops/const_hweight.h ../../include/asm-generic/bitops/const_hweight.h >/dev/null) \
 -        || echo "Warning: tools/include/asm-generic/bitops/const_hweight.h differs from kernel" >&2 )) || true
 -	@(test -f ../../include/asm-generic/bitops/__fls.h && ( \
 -        (diff -B ../include/asm-generic/bitops/__fls.h ../../include/asm-generic/bitops/__fls.h >/dev/null) \
 -        || echo "Warning: tools/include/asm-generic/bitops/__fls.h differs from kernel" >&2 )) || true
 -	@(test -f ../../include/asm-generic/bitops/fls.h && ( \
 -        (diff -B ../include/asm-generic/bitops/fls.h ../../include/asm-generic/bitops/fls.h >/dev/null) \
 -        || echo "Warning: tools/include/asm-generic/bitops/fls.h differs from kernel" >&2 )) || true
 -	@(test -f ../../include/asm-generic/bitops/fls64.h && ( \
 -        (diff -B ../include/asm-generic/bitops/fls64.h ../../include/asm-generic/bitops/fls64.h >/dev/null) \
 -        || echo "Warning: tools/include/asm-generic/bitops/fls64.h differs from kernel" >&2 )) || true
 -	@(test -f ../../include/linux/coresight-pmu.h && ( \
 -	(diff -B ../include/linux/coresight-pmu.h ../../include/linux/coresight-pmu.h >/dev/null) \
 -	|| echo "Warning: tools/include/linux/coresight-pmu.h differs from kernel" >&2 )) || true
 -	@(test -f ../../include/uapi/asm-generic/mman-common.h && ( \
 -	(diff -B ../include/uapi/asm-generic/mman-common.h ../../include/uapi/asm-generic/mman-common.h >/dev/null) \
 -	|| echo "Warning: tools/include/uapi/asm-generic/mman-common.h differs from kernel" >&2 )) || true
 -	@(test -f ../../include/uapi/asm-generic/mman.h && ( \
 -	(diff -B -I "^#include <\(uapi/\)*asm-generic/mman-common.h>$$" ../include/uapi/asm-generic/mman.h ../../include/uapi/asm-generic/mman.h >/dev/null) \
 -	|| echo "Warning: tools/include/uapi/asm-generic/mman.h differs from kernel" >&2 )) || true
 -	@(test -f ../../include/uapi/linux/mman.h && ( \
 -	(diff -B -I "^#include <\(uapi/\)*asm/mman.h>$$" ../include/uapi/linux/mman.h ../../include/uapi/linux/mman.h >/dev/null) \
 -	|| echo "Warning: tools/include/uapi/linux/mman.h differs from kernel" >&2 )) || true
  	$(Q)$(MAKE) $(build)=perf
  
 -$(JEVENTS_IN): FORCE
 -	$(Q)$(MAKE) -f $(srctree)/tools/build/Makefile.build dir=pmu-events obj=jevents
 -
 -$(JEVENTS): $(JEVENTS_IN)
 -	$(QUIET_LINK)$(HOSTCC) $(JEVENTS_IN) -o $@
 -
 -$(PMU_EVENTS_IN): $(JEVENTS) FORCE
 -	$(Q)$(MAKE) -f $(srctree)/tools/build/Makefile.build dir=pmu-events obj=pmu-events
 -
 -$(OUTPUT)perf: $(PERFLIBS) $(PERF_IN) $(PMU_EVENTS_IN) $(LIBTRACEEVENT_DYNAMIC_LIST)
 +$(OUTPUT)perf: $(PERFLIBS) $(PERF_IN) $(LIBTRACEEVENT_DYNAMIC_LIST)
  	$(QUIET_LINK)$(CC) $(CFLAGS) $(LDFLAGS) $(LIBTRACEEVENT_DYNAMIC_LIST_LDFLAGS) \
 -		$(PERF_IN) $(PMU_EVENTS_IN) $(LIBS) -o $@
 +		$(PERF_IN) $(LIBS) -o $@
  
  $(GTK_IN): fixdep FORCE
  	$(Q)$(MAKE) $(build)=gtk
diff --cc tools/perf/tests/make
index 51a2621f5dee,aa49b6600d1f..000000000000
--- a/tools/perf/tests/make
+++ b/tools/perf/tests/make
@@@ -79,7 -79,11 +79,13 @@@ make_no_libnuma     := NO_LIBNUMA=
  make_no_libaudit    := NO_LIBAUDIT=1
  make_no_libbionic   := NO_LIBBIONIC=1
  make_no_auxtrace    := NO_AUXTRACE=1
 -make_no_libbpf	    := NO_LIBBPF=1
  make_no_libcrypto   := NO_LIBCRYPTO=1
++<<<<<<< HEAD
++=======
+ make_with_babeltrace:= LIBBABELTRACE=1
+ make_no_sdt	    := NO_SDT=1
+ make_with_clangllvm := LIBCLANGLLVM=1
++>>>>>>> d58ac0bf8d1e (perf build: Add clang and llvm compile and linking support)
  make_tags           := tags
  make_cscope         := cscope
  make_help           := help
@@@ -134,6 -138,9 +140,12 @@@ run += make_no_libnum
  run += make_no_libaudit
  run += make_no_libbionic
  run += make_no_auxtrace
++<<<<<<< HEAD
++=======
+ run += make_no_libbpf
+ run += make_with_babeltrace
+ run += make_with_clangllvm
++>>>>>>> d58ac0bf8d1e (perf build: Add clang and llvm compile and linking support)
  run += make_help
  run += make_doc
  run += make_perf_o
* Unmerged path tools/perf/Makefile.config
* Unmerged path tools/perf/Makefile.perf
* Unmerged path tools/perf/tests/make
