mmc: block: Restore line inadvertently removed with packed commands

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
Rebuild_CHGLOG: - [mmc] block: Restore line inadvertently removed with packed commands (Don Zickus) [1430497]
Rebuild_FUZZ: 96.12%
commit-author Adrian Hunter <adrian.hunter@intel.com>
commit 5dd784d2e4eb765ae86b3366484d01429bb7adca
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/5dd784d2.failed

	Signed-off-by: Adrian Hunter <adrian.hunter@intel.com>
	Signed-off-by: Ulf Hansson <ulf.hansson@linaro.org>
	Reviewed-by: Linus Walleij <linus.walleij@linaro.org>
(cherry picked from commit 5dd784d2e4eb765ae86b3366484d01429bb7adca)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/mmc/card/block.c
diff --cc drivers/mmc/card/block.c
index 754f918a7b25,19597e3cefcb..000000000000
--- a/drivers/mmc/card/block.c
+++ b/drivers/mmc/card/block.c
@@@ -1924,39 -1588,8 +1924,43 @@@ static int mmc_blk_cmd_err(struct mmc_b
  			ret = blk_end_request(req, 0, blocks << 9);
  		}
  	} else {
++<<<<<<< HEAD
 +		if (!mmc_packed_cmd(mq_rq->cmd_type))
 +			ret = blk_end_request(req, 0, brq->data.bytes_xfered);
++=======
+ 		ret = blk_end_request(req, 0, brq->data.bytes_xfered);
++>>>>>>> 5dd784d2e4eb (mmc: block: Restore line inadvertently removed with packed commands)
 +	}
 +	return ret;
 +}
 +
 +static int mmc_blk_end_packed_req(struct mmc_queue_req *mq_rq)
 +{
 +	struct request *prq;
 +	struct mmc_packed *packed = mq_rq->packed;
 +	int idx = packed->idx_failure, i = 0;
 +	int ret = 0;
 +
 +	while (!list_empty(&packed->list)) {
 +		prq = list_entry_rq(packed->list.next);
 +		if (idx == i) {
 +			/* retry from error index */
 +			packed->nr_entries -= idx;
 +			mq_rq->req = prq;
 +			ret = 1;
 +
 +			if (packed->nr_entries == MMC_PACKED_NR_SINGLE) {
 +				list_del_init(&prq->queuelist);
 +				mmc_blk_clear_packed(mq_rq);
 +			}
 +			return ret;
 +		}
 +		list_del_init(&prq->queuelist);
 +		blk_end_request(prq, 0, blk_rq_bytes(prq));
 +		i++;
  	}
 +
 +	mmc_blk_clear_packed(mq_rq);
  	return ret;
  }
  
* Unmerged path drivers/mmc/card/block.c
