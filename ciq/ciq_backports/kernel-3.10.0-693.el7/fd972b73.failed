amd-xgbe: Check per channel DMA interrupt use in main ISR

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Lendacky, Thomas <Thomas.Lendacky@amd.com>
commit fd972b736bfec7e0297dac9501211abb91b436fd
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/fd972b73.failed

When using per channel DMA interrupts the transmit interrupt (TI) and the
receive interrupt (RI) are masked off so as to not generate an interrupt
to the main ISR. However, should another interrupt fire for the DMA channel
that is handled by the main ISR the TI/RI bits can still be set. This
will cause the wrong and uninitialized napi structure to be used causing a
panic. Add a check to be sure per channel DMA interrupts are not enabled
before acting on those bit flags.

	Signed-off-by: Tom Lendacky <thomas.lendacky@amd.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit fd972b736bfec7e0297dac9501211abb91b436fd)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/amd/xgbe/xgbe-drv.c
diff --cc drivers/net/ethernet/amd/xgbe/xgbe-drv.c
index add1b5ac7b5d,477a7e35d21a..000000000000
--- a/drivers/net/ethernet/amd/xgbe/xgbe-drv.c
+++ b/drivers/net/ethernet/amd/xgbe/xgbe-drv.c
@@@ -227,8 -337,13 +227,18 @@@ static irqreturn_t xgbe_isr(int irq, vo
  		dma_ch_isr = XGMAC_DMA_IOREAD(channel, DMA_CH_SR);
  		DBGPR("  DMA_CH%u_ISR = %08x\n", i, dma_ch_isr);
  
++<<<<<<< HEAD
 +		if (XGMAC_GET_BITS(dma_ch_isr, DMA_CH_SR, TI) ||
 +		    XGMAC_GET_BITS(dma_ch_isr, DMA_CH_SR, RI)) {
++=======
+ 		/* The TI or RI interrupt bits may still be set even if using
+ 		 * per channel DMA interrupts. Check to be sure those are not
+ 		 * enabled before using the private data napi structure.
+ 		 */
+ 		if (!pdata->per_channel_irq &&
+ 		    (XGMAC_GET_BITS(dma_ch_isr, DMA_CH_SR, TI) ||
+ 		     XGMAC_GET_BITS(dma_ch_isr, DMA_CH_SR, RI))) {
++>>>>>>> fd972b736bfe (amd-xgbe: Check per channel DMA interrupt use in main ISR)
  			if (napi_schedule_prep(&pdata->napi)) {
  				/* Disable Tx and Rx interrupts */
  				xgbe_disable_rx_tx_ints(pdata);
* Unmerged path drivers/net/ethernet/amd/xgbe/xgbe-drv.c
