ext4: preserve the needs_recovery flag when the journal is aborted

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Theodore Ts'o <tytso@mit.edu>
commit 97abd7d4b5d9c48ec15c425485f054e1c15e591b
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/97abd7d4.failed

If the journal is aborted, the needs_recovery feature flag should not
be removed.  Otherwise, it's the journal might not get replayed and
this could lead to more data getting lost.

	Signed-off-by: Theodore Ts'o <tytso@mit.edu>
	Cc: stable@vger.kernel.org
(cherry picked from commit 97abd7d4b5d9c48ec15c425485f054e1c15e591b)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/ext4/super.c
diff --cc fs/ext4/super.c
index 8a6f058f1768,3fef82e79131..000000000000
--- a/fs/ext4/super.c
+++ b/fs/ext4/super.c
@@@ -802,10 -848,9 +804,15 @@@ static void ext4_put_super(struct super
  	ext4_release_system_zone(sb);
  	ext4_mb_release(sb);
  	ext4_ext_release(sb);
 +	ext4_xattr_put_super(sb);
  
++<<<<<<< HEAD
 +	if (!(sb->s_flags & MS_RDONLY)) {
 +		EXT4_CLEAR_INCOMPAT_FEATURE(sb, EXT4_FEATURE_INCOMPAT_RECOVER);
++=======
+ 	if (!(sb->s_flags & MS_RDONLY) && !aborted) {
+ 		ext4_clear_feature_journal_needs_recovery(sb);
++>>>>>>> 97abd7d4b5d9 (ext4: preserve the needs_recovery flag when the journal is aborted)
  		es->s_state = cpu_to_le16(sbi->s_mount_state);
  	}
  	if (!(sb->s_flags & MS_RDONLY))
* Unmerged path fs/ext4/super.c
