PCI: hv: Lock PCI bus on device eject

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
Rebuild_CHGLOG: - [pci] hv: Lock PCI bus on device eject (Vitaly Kuznetsov) [1442282]
Rebuild_FUZZ: 92.75%
commit-author Long Li <longli@microsoft.com>
commit 414428c5da1c71986727c2fa5cdf1ed071e398d7
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/414428c5.failed

A PCI_EJECT message can arrive at the same time we are calling
pci_scan_child_bus() in the workqueue for the previous PCI_BUS_RELATIONS
message or in create_root_hv_pci_bus().  In this case we could potentially
modify the bus from multiple places.

Properly lock the bus access.

Thanks Dexuan Cui <decui@microsoft.com> for pointing out the race condition
in create_root_hv_pci_bus().

	Reported-by: Xiaofeng Wang <xiaofwan@redhat.com>
	Signed-off-by: Long Li <longli@microsoft.com>
	Signed-off-by: Bjorn Helgaas <bhelgaas@google.com>
	Acked-by: K. Y. Srinivasan <kys@microsoft.com>
(cherry picked from commit 414428c5da1c71986727c2fa5cdf1ed071e398d7)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/pci/pci-hyperv.c
diff --cc drivers/pci/pci-hyperv.c
index 38242335bf2b,a1b3c1957d43..000000000000
--- a/drivers/pci/pci-hyperv.c
+++ b/drivers/pci/pci-hyperv.c
@@@ -1123,6 -1206,10 +1123,13 @@@ static int create_root_hv_pci_bus(struc
  	if (!hbus->pci_bus)
  		return -ENODEV;
  
++<<<<<<< HEAD:drivers/pci/pci-hyperv.c
++=======
+ 	hbus->pci_bus->msi = &hbus->msi_chip;
+ 	hbus->pci_bus->msi->dev = &hbus->hdev->device;
+ 
+ 	pci_lock_rescan_remove();
++>>>>>>> 414428c5da1c (PCI: hv: Lock PCI bus on device eject):drivers/pci/host/pci-hyperv.c
  	pci_scan_child_bus(hbus->pci_bus);
  	pci_bus_assign_resources(hbus->pci_bus);
  	pci_bus_add_devices(hbus->pci_bus);
* Unmerged path drivers/pci/pci-hyperv.c
