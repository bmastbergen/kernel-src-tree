kvm: svm: Do not support AVIC if not CONFIG_X86_LOCAL_APIC

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Suravee Suthikulpanit <Suravee.Suthikulpanit@amd.com>
commit 5b8abf1f33ccd9f1cbc4248ade3cd507d9319c48
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/5b8abf1f.failed

Add logic to disable AVIC #ifndef CONFIG_X86_LOCAL_APIC.

	Suggested-by: Paolo Bonzini <pbonzini@redhat.com>
	Signed-off-by: Suravee Suthikulpanit <suravee.suthikulpanit@amd.com>
	Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
(cherry picked from commit 5b8abf1f33ccd9f1cbc4248ade3cd507d9319c48)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kvm/svm.c
diff --cc arch/x86/kvm/svm.c
index 6f2d74ac8a7d,16ef31b87452..000000000000
--- a/arch/x86/kvm/svm.c
+++ b/arch/x86/kvm/svm.c
@@@ -200,9 -233,15 +200,18 @@@ static int npt = true
  module_param(npt, int, S_IRUGO);
  
  /* allow nested virtualization in KVM/SVM */
 -static int nested = true;
 +static int nested = false;
  module_param(nested, int, S_IRUGO);
  
++<<<<<<< HEAD
++=======
+ /* enable / disable AVIC */
+ static int avic;
+ #ifdef CONFIG_X86_LOCAL_APIC
+ module_param(avic, int, S_IRUGO);
+ #endif
+ 
++>>>>>>> 5b8abf1f33cc (kvm: svm: Do not support AVIC if not CONFIG_X86_LOCAL_APIC)
  static void svm_set_cr0(struct kvm_vcpu *vcpu, unsigned long cr0);
  static void svm_flush_tlb(struct kvm_vcpu *vcpu);
  static void svm_complete_interrupts(struct vcpu_svm *svm);
@@@ -921,6 -983,15 +930,18 @@@ static __init int svm_hardware_setup(vo
  	} else
  		kvm_disable_tdp();
  
++<<<<<<< HEAD
++=======
+ 	if (avic) {
+ 		if (!npt_enabled ||
+ 		    !boot_cpu_has(X86_FEATURE_AVIC) ||
+ 		    !IS_ENABLED(CONFIG_X86_LOCAL_APIC))
+ 			avic = false;
+ 		else
+ 			pr_info("AVIC enabled\n");
+ 	}
+ 
++>>>>>>> 5b8abf1f33cc (kvm: svm: Do not support AVIC if not CONFIG_X86_LOCAL_APIC)
  	return 0;
  
  err:
* Unmerged path arch/x86/kvm/svm.c
