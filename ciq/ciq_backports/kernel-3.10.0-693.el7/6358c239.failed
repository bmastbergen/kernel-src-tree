raid5-ppl: support disk hot add/remove with PPL

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Artur Paszkiewicz <artur.paszkiewicz@intel.com>
commit 6358c239d88c751a9f14152a8d4ad2b69f5be48f
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/6358c239.failed

Add a function to modify the log by removing an rdev when a drive fails
or adding when a spare/replacement is activated as a raid member.

Removing a disk just clears the child log rdev pointer. No new stripes
will be accepted for this child log in ppl_write_stripe() and running io
units will be processed without writing PPL to the device.

Adding a disk sets the child log rdev pointer and writes an empty PPL
header.

	Signed-off-by: Artur Paszkiewicz <artur.paszkiewicz@intel.com>
	Signed-off-by: Shaohua Li <shli@fb.com>
(cherry picked from commit 6358c239d88c751a9f14152a8d4ad2b69f5be48f)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/md/raid5-log.h
#	drivers/md/raid5-ppl.c
#	drivers/md/raid5.c
diff --cc drivers/md/raid5.c
index 896a84d8eff0,6760af251864..000000000000
--- a/drivers/md/raid5.c
+++ b/drivers/md/raid5.c
@@@ -7262,12 -7640,20 +7262,29 @@@ static int raid5_remove_disk(struct mdd
  		goto abort;
  	}
  	*rdevp = NULL;
++<<<<<<< HEAD
 +	synchronize_rcu();
 +	if (atomic_read(&rdev->nr_pending)) {
 +		/* lost the race, try later */
 +		err = -EBUSY;
 +		*rdevp = rdev;
 +	} else if (p->replacement) {
++=======
+ 	if (!test_bit(RemoveSynchronized, &rdev->flags)) {
+ 		synchronize_rcu();
+ 		if (atomic_read(&rdev->nr_pending)) {
+ 			/* lost the race, try later */
+ 			err = -EBUSY;
+ 			*rdevp = rdev;
+ 		}
+ 	}
+ 	if (!err) {
+ 		err = log_modify(conf, rdev, false);
+ 		if (err)
+ 			goto abort;
+ 	}
+ 	if (p->replacement) {
++>>>>>>> 6358c239d88c (raid5-ppl: support disk hot add/remove with PPL)
  		/* We must have just cleared 'rdev' */
  		p->rdev = p->replacement;
  		clear_bit(Replacement, &p->replacement->flags);
* Unmerged path drivers/md/raid5-log.h
* Unmerged path drivers/md/raid5-ppl.c
* Unmerged path drivers/md/raid5-log.h
* Unmerged path drivers/md/raid5-ppl.c
* Unmerged path drivers/md/raid5.c
