net_sched: fix a use-after-free in tc_ctl_tfilter()

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
Rebuild_CHGLOG: - [net] sched: fix a use-after-free in tc_ctl_tfilter() (Ivan Vecera) [1428588]
Rebuild_FUZZ: 95.92%
commit-author WANG Cong <xiyou.wangcong@gmail.com>
commit d744318574090c3b796915d9d710bdb17db191a1
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/d7443185.failed

When tcf_destroy() returns true, tp could be already destroyed,
we should not use tp->next after that.

For long term, we probably should move tp list to list_head.

Fixes: 1e052be69d04 ("net_sched: destroy proto tp when all filters are gone")
	Cc: Jamal Hadi Salim <jhs@mojatatu.com>
	Signed-off-by: Cong Wang <xiyou.wangcong@gmail.com>
	Acked-by: Jamal Hadi Salim <jhs@mojatatu.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit d744318574090c3b796915d9d710bdb17db191a1)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/sched/cls_api.c
diff --cc net/sched/cls_api.c
index a79e83e16a99,b6ef9a04de06..000000000000
--- a/net/sched/cls_api.c
+++ b/net/sched/cls_api.c
@@@ -310,8 -307,13 +310,18 @@@ replay
  			break;
  		case RTM_DELTFILTER:
  			err = tp->ops->delete(tp, fh);
++<<<<<<< HEAD
 +			if (err == 0)
 +				tfilter_notify(net, skb, n, tp, fh, RTM_DELTFILTER);
++=======
+ 			if (err == 0) {
+ 				struct tcf_proto *next = rtnl_dereference(tp->next);
+ 
+ 				tfilter_notify(net, skb, n, tp, fh, RTM_DELTFILTER);
+ 				if (tcf_destroy(tp, false))
+ 					RCU_INIT_POINTER(*back, next);
+ 			}
++>>>>>>> d74431857409 (net_sched: fix a use-after-free in tc_ctl_tfilter())
  			goto errout;
  		case RTM_GETTFILTER:
  			err = tfilter_notify(net, skb, n, tp, fh, RTM_NEWTFILTER);
* Unmerged path net/sched/cls_api.c
