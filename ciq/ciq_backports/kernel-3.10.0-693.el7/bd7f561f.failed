powerpc/smp: Support more IPI messages

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
Rebuild_CHGLOG: - [powerpc] smp: Support more IPI messages (Thomas Huth) [1384437]
Rebuild_FUZZ: 88.24%
commit-author Suresh Warrier <warrier@linux.vnet.ibm.com>
commit bd7f561f76563f0b21701628874d8adc863b0c25
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/bd7f561f.failed

This patch increases the number of demuxed messages for a
controller with a single ipi to 8 for 64-bit systems.

This is required because we want to use the IPI mechanism
to send messages from a CPU running in KVM real mode in a
guest to a CPU in the host to take some action. Currently,
we only support 4 messages and all 4 are already taken.

Define a fifth message PPC_MSG_RM_HOST_ACTION for this
purpose.

	Signed-off-by: Suresh Warrier <warrier@linux.vnet.ibm.com>
	Acked-by: Michael Ellerman <mpe@ellerman.id.au>
	Signed-off-by: Paul Mackerras <paulus@samba.org>
(cherry picked from commit bd7f561f76563f0b21701628874d8adc863b0c25)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/powerpc/kernel/smp.c
diff --cc arch/powerpc/kernel/smp.c
index 9ec229ceaf25,a53a13047330..000000000000
--- a/arch/powerpc/kernel/smp.c
+++ b/arch/powerpc/kernel/smp.c
@@@ -242,8 -243,8 +242,13 @@@ void smp_muxed_ipi_message_pass(int cpu
  
  irqreturn_t smp_ipi_demux(void)
  {
++<<<<<<< HEAD
 +	struct cpu_messages *info = &__get_cpu_var(ipi_message);
 +	unsigned int all;
++=======
+ 	struct cpu_messages *info = this_cpu_ptr(&ipi_message);
+ 	unsigned long all;
++>>>>>>> bd7f561f7656 (powerpc/smp: Support more IPI messages)
  
  	mb();	/* order any irq clear */
  
diff --git a/arch/powerpc/include/asm/smp.h b/arch/powerpc/include/asm/smp.h
index 5a6614a7f0b2..b7b6f0201b30 100644
--- a/arch/powerpc/include/asm/smp.h
+++ b/arch/powerpc/include/asm/smp.h
@@ -115,6 +115,9 @@ extern int cpu_to_core_id(int cpu);
 #define PPC_MSG_TICK_BROADCAST	2
 #define PPC_MSG_DEBUGGER_BREAK  3
 
+/* This is only used by the powernv kernel */
+#define PPC_MSG_RM_HOST_ACTION	4
+
 /* for irq controllers that have dedicated ipis per message (4) */
 extern int smp_request_message_ipi(int virq, int message);
 extern const char *smp_ipi_name[];
* Unmerged path arch/powerpc/kernel/smp.c
