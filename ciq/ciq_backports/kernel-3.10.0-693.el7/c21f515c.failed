powerpc/pseries: Make the acquire/release of the drc for memory a seperate step

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
Rebuild_CHGLOG: - [powerpc] pseries: Make the acquire/release of the drc for memory a seperate step (Thomas Huth) [1323417]
Rebuild_FUZZ: 94.67%
commit-author John Allen <jallen@linux.vnet.ibm.com>
commit c21f515c743687c6c2b3d38227e6ad8e6b733409
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/c21f515c.failed

When adding and removing LMBs we should make the acquire/release of
the DRC a separate step to allow for a few improvements. First
this will ensure that LMBs removed during a remove by count operation
are all available if a error occurs and we need to add them back. By
first removeing all the LMBs from the kernel before releasing their
DRCs the LMBs are available to add back should an error occur.

Also, this will allow for faster re-add operations of memory for
PRRN event handling since we can skip the unneeded step of having
to release the DRC and the acquire it back.

	Signed-off-by: Nathan Fontenot <nfont@linux.vnet.ibm.com>
	Signed-off-by: John Allen <jallen@linux.vnet.ibm.com>
	Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
(cherry picked from commit c21f515c743687c6c2b3d38227e6ad8e6b733409)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/powerpc/platforms/pseries/hotplug-memory.c
diff --cc arch/powerpc/platforms/pseries/hotplug-memory.c
index a96025209e16,be11fc3cdeb0..000000000000
--- a/arch/powerpc/platforms/pseries/hotplug-memory.c
+++ b/arch/powerpc/platforms/pseries/hotplug-memory.c
@@@ -666,11 -609,17 +664,25 @@@ static int dlpar_add_lmb(struct of_drco
  		return rc;
  	}
  
++<<<<<<< HEAD
 +	rc = dlpar_add_lmb_memory(lmb);
 +	if (rc) {
 +		dlpar_remove_device_tree_lmb(lmb);
 +		dlpar_release_drc(lmb->drc_index);
 +	}
++=======
+ 	block_sz = memory_block_size_bytes();
+ 
+ 	/* Find the node id for this address */
+ 	nid = memory_add_physaddr_to_nid(lmb->base_addr);
+ 
+ 	/* Add the memory */
+ 	rc = add_memory(nid, lmb->base_addr, block_sz);
+ 	if (rc)
+ 		dlpar_remove_device_tree_lmb(lmb);
+ 	else
+ 		lmb->flags |= DRCONF_MEM_ASSIGNED;
++>>>>>>> c21f515c7436 (powerpc/pseries: Make the acquire/release of the drc for memory a seperate step)
  
  	return rc;
  }
* Unmerged path arch/powerpc/platforms/pseries/hotplug-memory.c
