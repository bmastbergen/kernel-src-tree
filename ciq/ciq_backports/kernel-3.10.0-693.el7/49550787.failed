vfio-mdev: Fix remove race

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Alex Williamson <alex.williamson@redhat.com>
commit 49550787a90b5bfa44d8dc424d11824dbe21473d
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/49550787.failed

Using the mtty mdev sample driver we can generate a remove race by
starting one shell that continuously creates mtty devices and several
other shells all attempting to remove devices, in my case four remove
shells.  The fault occurs in mdev_remove_sysfs_files() where the
passed type arg is NULL, which suggests we've received a struct device
in mdev_device_remove() but it's in some sort of teardown state.  The
solution here is to make use of the accidentally unused list_head on
the mdev_device such that the mdev core keeps a list of all the mdev
devices.  This allows us to validate that we have a valid mdev before
we start removal, remove it from the list to prevent others from
working on it, and if the vendor driver refuses to remove, we can
re-add it to the list.

	Cc: Kirti Wankhede <kwankhede@nvidia.com>
	Signed-off-by: Alex Williamson <alex.williamson@redhat.com>
(cherry picked from commit 49550787a90b5bfa44d8dc424d11824dbe21473d)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/vfio/mdev/mdev_core.c
* Unmerged path drivers/vfio/mdev/mdev_core.c
* Unmerged path drivers/vfio/mdev/mdev_core.c
