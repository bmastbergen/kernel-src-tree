powerpc: Convert cmp to cmpd in idle enter sequence

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
Rebuild_CHGLOG: - [powerpc] Convert cmp to cmpd in idle enter sequence (Steve Best) [1418770]
Rebuild_FUZZ: 90.32%
commit-author Segher Boessenkool <segher@kernel.crashing.org>
commit 80f23935cadb1c654e81951f5a8b7ceae0acc1b4
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/80f23935.failed

PowerPC's "cmp" instruction has four operands. Normally people write
"cmpw" or "cmpd" for the second cmp operand 0 or 1. But, frequently
people forget, and write "cmp" with just three operands.

With older binutils this is silently accepted as if this was "cmpw",
while often "cmpd" is wanted. With newer binutils GAS will complain
about this for 64-bit code. For 32-bit code it still silently assumes
"cmpw" is what is meant.

In this instance the code comes directly from ISA v2.07, including the
cmp, but cmpd is correct. Backport to stable so that new toolchains can
build old kernels.

Fixes: 948cf67c4726 ("powerpc: Add NAP mode support on Power7 in HV mode")
	Cc: stable@vger.kernel.org # v3.0
	Reviewed-by: Vaidyanathan Srinivasan <svaidy@linux.vnet.ibm.com>
	Signed-off-by: Segher Boessenkool <segher@kernel.crashing.org>
	Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
(cherry picked from commit 80f23935cadb1c654e81951f5a8b7ceae0acc1b4)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/powerpc/include/asm/cpuidle.h
diff --cc arch/powerpc/include/asm/cpuidle.h
index d2f99ca1e3a6,3919332965af..000000000000
--- a/arch/powerpc/include/asm/cpuidle.h
+++ b/arch/powerpc/include/asm/cpuidle.h
@@@ -17,4 -19,17 +17,20 @@@ extern u32 pnv_fastsleep_workaround_at_
  
  #endif
  
++<<<<<<< HEAD
++=======
+ /* Idle state entry routines */
+ #ifdef	CONFIG_PPC_P7_NAP
+ #define	IDLE_STATE_ENTER_SEQ(IDLE_INST)				\
+ 	/* Magic NAP/SLEEP/WINKLE mode enter sequence */	\
+ 	std	r0,0(r1);					\
+ 	ptesync;						\
+ 	ld	r0,0(r1);					\
+ 1:	cmpd	cr0,r0,r0;					\
+ 	bne	1b;						\
+ 	IDLE_INST;						\
+ 	b	.
+ #endif /* CONFIG_PPC_P7_NAP */
+ 
++>>>>>>> 80f23935cadb (powerpc: Convert cmp to cmpd in idle enter sequence)
  #endif
* Unmerged path arch/powerpc/include/asm/cpuidle.h
