i40e: Driver prints log message on link speed change

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Filip Sadowski <filip.sadowski@intel.com>
commit 7ec9ba11b046b4b7fd768c366870ada60d409295
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/7ec9ba11.failed

This patch makes the driver log link speed change. Before applying the
patch link messages were printed only on state change. Now message is
printed when link is brought up or down and when speed changes.

Change-ID: Ifbee14b4b16c24967450b3cecac6e8351dcc8f74
	Signed-off-by: Filip Sadowski <filip.sadowski@intel.com>
	Tested-by: Andrew Bowers <andrewx.bowers@intel.com>
	Signed-off-by: Jeff Kirsher <jeffrey.t.kirsher@intel.com>
(cherry picked from commit 7ec9ba11b046b4b7fd768c366870ada60d409295)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/intel/i40e/i40e.h
diff --cc drivers/net/ethernet/intel/i40e/i40e.h
index 129cb7d784d7,06e3c230483f..000000000000
--- a/drivers/net/ethernet/intel/i40e/i40e.h
+++ b/drivers/net/ethernet/intel/i40e/i40e.h
@@@ -579,11 -591,12 +579,20 @@@ struct i40e_vsi 
  	/* TC BW limit max quanta within VSI */
  	u8  bw_ets_max_quanta[I40E_MAX_TRAFFIC_CLASS];
  
++<<<<<<< HEAD
 +	struct i40e_pf *back;  /* Backreference to associated PF */
 +	u16 idx;               /* index in pf->vsi[] */
 +	u16 veb_idx;           /* index of VEB parent */
 +	struct kobject *kobj;  /* sysfs object */
 +	bool current_isup;     /* Sync 'link up' logging */
++=======
+ 	struct i40e_pf *back;	/* Backreference to associated PF */
+ 	u16 idx;		/* index in pf->vsi[] */
+ 	u16 veb_idx;		/* index of VEB parent */
+ 	struct kobject *kobj;	/* sysfs object */
+ 	bool current_isup;	/* Sync 'link up' logging */
+ 	enum i40e_aq_link_speed current_speed;	/* Sync link speed logging */
++>>>>>>> 7ec9ba11b046 (i40e: Driver prints log message on link speed change)
  
  	void *priv;	/* client driver data reference. */
  
* Unmerged path drivers/net/ethernet/intel/i40e/i40e.h
diff --git a/drivers/net/ethernet/intel/i40e/i40e_main.c b/drivers/net/ethernet/intel/i40e/i40e_main.c
index beeec4f78000..fe99c0bc4341 100644
--- a/drivers/net/ethernet/intel/i40e/i40e_main.c
+++ b/drivers/net/ethernet/intel/i40e/i40e_main.c
@@ -5118,12 +5118,16 @@ out:
  */
 void i40e_print_link_message(struct i40e_vsi *vsi, bool isup)
 {
+	enum i40e_aq_link_speed new_speed;
 	char *speed = "Unknown";
 	char *fc = "Unknown";
 
-	if (vsi->current_isup == isup)
+	new_speed = vsi->back->hw.phy.link_info.link_speed;
+
+	if ((vsi->current_isup == isup) && (vsi->current_speed == new_speed))
 		return;
 	vsi->current_isup = isup;
+	vsi->current_speed = new_speed;
 	if (!isup) {
 		netdev_info(vsi->netdev, "NIC Link is Down\n");
 		return;
