KVM: disable halt_poll_ns as default for s390x

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author David Hildenbrand <dahi@linux.vnet.ibm.com>
commit 920552b213e3dc832a874b4e7ba29ecddbab31bc
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/920552b2.failed

We observed some performance degradation on s390x with dynamic
halt polling. Until we can provide a proper fix, let's enable
halt_poll_ns as default only for supported architectures.

Architectures are now free to set their own halt_poll_ns
default value.

	Signed-off-by: David Hildenbrand <dahi@linux.vnet.ibm.com>
	Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
(cherry picked from commit 920552b213e3dc832a874b4e7ba29ecddbab31bc)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/arm64/include/asm/kvm_host.h
#	arch/s390/include/asm/kvm_host.h
#	virt/kvm/kvm_main.c
diff --cc arch/s390/include/asm/kvm_host.h
index 297b2c318280,8ced426091e1..000000000000
--- a/arch/s390/include/asm/kvm_host.h
+++ b/arch/s390/include/asm/kvm_host.h
@@@ -25,9 -28,22 +25,24 @@@
  #define KVM_MAX_VCPUS 64
  #define KVM_USER_MEM_SLOTS 32
  
++<<<<<<< HEAD
++=======
+ /*
+  * These seem to be used for allocating ->chip in the routing table,
+  * which we don't use. 4096 is an out-of-thin-air value. If we need
+  * to look at ->chip later on, we'll need to revisit this.
+  */
+ #define KVM_NR_IRQCHIPS 1
+ #define KVM_IRQCHIP_NUM_PINS 4096
+ #define KVM_HALT_POLL_NS_DEFAULT 0
+ 
+ #define SIGP_CTRL_C		0x80
+ #define SIGP_CTRL_SCN_MASK	0x3f
+ 
++>>>>>>> 920552b213e3 (KVM: disable halt_poll_ns as default for s390x)
  struct sca_entry {
 -	__u8	reserved0;
 -	__u8	sigp_ctrl;
 -	__u16	reserved[3];
 +	atomic_t scn;
 +	__u32	reserved;
  	__u64	sda;
  	__u64	reserved2[2];
  } __attribute__((packed));
diff --cc virt/kvm/kvm_main.c
index 72de0bcb7df9,8db1d9361993..000000000000
--- a/virt/kvm/kvm_main.c
+++ b/virt/kvm/kvm_main.c
@@@ -69,8 -66,8 +69,13 @@@
  MODULE_AUTHOR("Qumranet");
  MODULE_LICENSE("GPL");
  
++<<<<<<< HEAD
 +/* halt polling only reduces halt latency by 5-7 us, 400us is enough */
 +static unsigned int halt_poll_ns = 400000;
++=======
+ /* Architectures should define their poll value according to the halt latency */
+ static unsigned int halt_poll_ns = KVM_HALT_POLL_NS_DEFAULT;
++>>>>>>> 920552b213e3 (KVM: disable halt_poll_ns as default for s390x)
  module_param(halt_poll_ns, uint, S_IRUGO | S_IWUSR);
  
  /* Default doubles per-vcpu halt_poll_ns. */
* Unmerged path arch/arm64/include/asm/kvm_host.h
diff --git a/arch/arm/include/asm/kvm_host.h b/arch/arm/include/asm/kvm_host.h
index 1467904f8fc2..56a4626701b4 100644
--- a/arch/arm/include/asm/kvm_host.h
+++ b/arch/arm/include/asm/kvm_host.h
@@ -32,6 +32,7 @@
 #define KVM_PRIVATE_MEM_SLOTS 4
 #define KVM_COALESCED_MMIO_PAGE_OFFSET 1
 #define KVM_HAVE_ONE_REG
+#define KVM_HALT_POLL_NS_DEFAULT 500000
 
 #define KVM_VCPU_MAX_FEATURES 1
 
* Unmerged path arch/arm64/include/asm/kvm_host.h
diff --git a/arch/mips/include/asm/kvm_host.h b/arch/mips/include/asm/kvm_host.h
index 07768128ec0e..4cd2d3a9e98a 100644
--- a/arch/mips/include/asm/kvm_host.h
+++ b/arch/mips/include/asm/kvm_host.h
@@ -26,6 +26,7 @@
 #define KVM_PRIVATE_MEM_SLOTS 	0
 
 #define KVM_COALESCED_MMIO_PAGE_OFFSET 1
+#define KVM_HALT_POLL_NS_DEFAULT 500000
 
 /* Don't support huge pages */
 #define KVM_HPAGE_GFN_SHIFT(x)	0
diff --git a/arch/powerpc/include/asm/kvm_host.h b/arch/powerpc/include/asm/kvm_host.h
index 8841a038084f..6b976d313bc8 100644
--- a/arch/powerpc/include/asm/kvm_host.h
+++ b/arch/powerpc/include/asm/kvm_host.h
@@ -45,6 +45,7 @@
 #ifdef CONFIG_KVM_MMIO
 #define KVM_COALESCED_MMIO_PAGE_OFFSET 1
 #endif
+#define KVM_HALT_POLL_NS_DEFAULT 500000
 
 /* These values are internal and can be increased later */
 #define KVM_NR_IRQCHIPS          1
* Unmerged path arch/s390/include/asm/kvm_host.h
diff --git a/arch/x86/include/asm/kvm_host.h b/arch/x86/include/asm/kvm_host.h
index e9b71b8ce24b..bffc931610df 100644
--- a/arch/x86/include/asm/kvm_host.h
+++ b/arch/x86/include/asm/kvm_host.h
@@ -43,6 +43,7 @@
 
 #define KVM_PIO_PAGE_OFFSET 1
 #define KVM_COALESCED_MMIO_PAGE_OFFSET 2
+#define KVM_HALT_POLL_NS_DEFAULT 500000
 
 #define KVM_IRQCHIP_NUM_PINS  KVM_IOAPIC_NUM_PINS
 
* Unmerged path virt/kvm/kvm_main.c
