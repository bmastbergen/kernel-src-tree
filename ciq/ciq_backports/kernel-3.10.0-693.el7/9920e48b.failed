ipv4: use l4 hash for locally generated multipath flows

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Paolo Abeni <pabeni@redhat.com>
commit 9920e48b830a0f4ec06bcbf0ec3147c88ae72bac
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/9920e48b.failed

This patch changes how the multipath hash is computed for locally
generated flows: now the hash comprises l4 information.

This allows better utilization of the available paths when the existing
flows have the same source IP and the same destination IP: with l3 hash,
even when multiple connections are in place simultaneously, a single path
will be used, while with l4 hash we can use all the available paths.

v2 changes:
- use get_hash_from_flowi4() instead of implementing just another l4 hash
  function

	Signed-off-by: Paolo Abeni <pabeni@redhat.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 9920e48b830a0f4ec06bcbf0ec3147c88ae72bac)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/ipv4/fib_semantics.c
diff --cc net/ipv4/fib_semantics.c
index 5ac53634a26e,f30df0ee4f4d..000000000000
--- a/net/ipv4/fib_semantics.c
+++ b/net/ipv4/fib_semantics.c
@@@ -1447,3 -1557,25 +1447,28 @@@ void fib_select_multipath(struct fib_re
  	res->nh_sel = 0;
  }
  #endif
++<<<<<<< HEAD
++=======
+ 
+ void fib_select_path(struct net *net, struct fib_result *res,
+ 		     struct flowi4 *fl4, int mp_hash)
+ {
+ #ifdef CONFIG_IP_ROUTE_MULTIPATH
+ 	if (res->fi->fib_nhs > 1 && fl4->flowi4_oif == 0) {
+ 		if (mp_hash < 0)
+ 			mp_hash = get_hash_from_flowi4(fl4) >> 1;
+ 
+ 		fib_select_multipath(res, mp_hash);
+ 	}
+ 	else
+ #endif
+ 	if (!res->prefixlen &&
+ 	    res->table->tb_num_default > 1 &&
+ 	    res->type == RTN_UNICAST && !fl4->flowi4_oif)
+ 		fib_select_default(fl4, res);
+ 
+ 	if (!fl4->saddr)
+ 		fl4->saddr = FIB_RES_PREFSRC(net, *res);
+ }
+ EXPORT_SYMBOL_GPL(fib_select_path);
++>>>>>>> 9920e48b830a (ipv4: use l4 hash for locally generated multipath flows)
* Unmerged path net/ipv4/fib_semantics.c
