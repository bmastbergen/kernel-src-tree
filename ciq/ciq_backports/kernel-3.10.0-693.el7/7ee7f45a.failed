mei: bus: enable OS version only for SPT and newer

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Alexander Usyskin <alexander.usyskin@intel.com>
commit 7ee7f45a763bd68c3a606595a8c1bb08c3e6146b
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/7ee7f45a.failed

Sending OS version for support of TPM2_ChangeEPS() is required only
for SPT FW (HMB version 2.0) and newer.
On older platforms the command should be just ignored by the firmware
but some older platforms misbehave so it's safer to send the command
only if required.

Bugzilla: https://bugzilla.kernel.org/show_bug.cgi?id=192051
Fixes: 7279b238bade (mei: send OS type to the FW)
	Signed-off-by: Alexander Usyskin <alexander.usyskin@intel.com>
	Signed-off-by: Tomas Winkler <tomas.winkler@intel.com>
	Tested-by: Jan Niehusmann <jan@gondor.com>
	Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
(cherry picked from commit 7ee7f45a763bd68c3a606595a8c1bb08c3e6146b)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/misc/mei/debugfs.c
#	drivers/misc/mei/hbm.c
#	drivers/misc/mei/hw.h
#	drivers/misc/mei/mei_dev.h
diff --cc drivers/misc/mei/debugfs.c
index 6bdd75424fe8,c6217a4993ad..000000000000
--- a/drivers/misc/mei/debugfs.c
+++ b/drivers/misc/mei/debugfs.c
@@@ -176,6 -178,10 +176,13 @@@ static ssize_t mei_dbgfs_read_devstate(
  				 dev->hbm_f_dot_supported);
  		pos += scnprintf(buf + pos, bufsz - pos, "\tEV: %01d\n",
  				 dev->hbm_f_ev_supported);
++<<<<<<< HEAD
++=======
+ 		pos += scnprintf(buf + pos, bufsz - pos, "\tFA: %01d\n",
+ 				 dev->hbm_f_fa_supported);
+ 		pos += scnprintf(buf + pos, bufsz - pos, "\tOS: %01d\n",
+ 				 dev->hbm_f_os_supported);
++>>>>>>> 7ee7f45a763b (mei: bus: enable OS version only for SPT and newer)
  	}
  
  	pos += scnprintf(buf + pos, bufsz - pos, "pg:  %s, %s\n",
diff --cc drivers/misc/mei/hbm.c
index 20e217474050,25b4a1ba522d..000000000000
--- a/drivers/misc/mei/hbm.c
+++ b/drivers/misc/mei/hbm.c
@@@ -983,6 -985,14 +983,17 @@@ static void mei_hbm_config_features(str
  	/* Notification Event Support */
  	if (dev->version.major_version >= HBM_MAJOR_VERSION_EV)
  		dev->hbm_f_ev_supported = 1;
++<<<<<<< HEAD
++=======
+ 
+ 	/* Fixed Address Client Support */
+ 	if (dev->version.major_version >= HBM_MAJOR_VERSION_FA)
+ 		dev->hbm_f_fa_supported = 1;
+ 
+ 	/* OS ver message Support */
+ 	if (dev->version.major_version >= HBM_MAJOR_VERSION_OS)
+ 		dev->hbm_f_os_supported = 1;
++>>>>>>> 7ee7f45a763b (mei: bus: enable OS version only for SPT and newer)
  }
  
  /**
diff --cc drivers/misc/mei/hw.h
index 4c5d6cfd79b4,e1e4d47d4d7d..000000000000
--- a/drivers/misc/mei/hw.h
+++ b/drivers/misc/mei/hw.h
@@@ -64,6 -70,18 +64,21 @@@
  #define HBM_MINOR_VERSION_EV               0
  #define HBM_MAJOR_VERSION_EV               2
  
++<<<<<<< HEAD
++=======
+ /*
+  * MEI version with fixed address client support
+  */
+ #define HBM_MINOR_VERSION_FA               0
+ #define HBM_MAJOR_VERSION_FA               2
+ 
+ /*
+  * MEI version with OS ver message support
+  */
+ #define HBM_MINOR_VERSION_OS               0
+ #define HBM_MAJOR_VERSION_OS               2
+ 
++>>>>>>> 7ee7f45a763b (mei: bus: enable OS version only for SPT and newer)
  /* Host bus message command opcode */
  #define MEI_HBM_CMD_OP_MSK                  0x7f
  /* Host bus message command RESPONSE */
diff --cc drivers/misc/mei/mei_dev.h
index e8511621b60d,8dadb98662a9..000000000000
--- a/drivers/misc/mei/mei_dev.h
+++ b/drivers/misc/mei/mei_dev.h
@@@ -435,6 -404,9 +435,12 @@@ const char *mei_pg_state_str(enum mei_p
   * @hbm_f_dc_supported  : hbm feature dynamic clients
   * @hbm_f_dot_supported : hbm feature disconnect on timeout
   * @hbm_f_ev_supported  : hbm feature event notification
++<<<<<<< HEAD
++=======
+  * @hbm_f_fa_supported  : hbm feature fixed address client
+  * @hbm_f_ie_supported  : hbm feature immediate reply to enum request
+  * @hbm_f_os_supported  : hbm feature support OS ver message
++>>>>>>> 7ee7f45a763b (mei: bus: enable OS version only for SPT and newer)
   *
   * @me_clients_rwsem: rw lock over me_clients list
   * @me_clients  : list of FW clients
@@@ -527,6 -486,9 +533,12 @@@ struct mei_device 
  	unsigned int hbm_f_dc_supported:1;
  	unsigned int hbm_f_dot_supported:1;
  	unsigned int hbm_f_ev_supported:1;
++<<<<<<< HEAD
++=======
+ 	unsigned int hbm_f_fa_supported:1;
+ 	unsigned int hbm_f_ie_supported:1;
+ 	unsigned int hbm_f_os_supported:1;
++>>>>>>> 7ee7f45a763b (mei: bus: enable OS version only for SPT and newer)
  
  	struct rw_semaphore me_clients_rwsem;
  	struct list_head me_clients;
diff --git a/drivers/misc/mei/bus-fixup.c b/drivers/misc/mei/bus-fixup.c
index 065e8ae2607b..16d2497f33f7 100644
--- a/drivers/misc/mei/bus-fixup.c
+++ b/drivers/misc/mei/bus-fixup.c
@@ -152,6 +152,9 @@ static void mei_mkhi_fix(struct mei_cl_device *cldev)
 {
 	int ret;
 
+	if (!cldev->bus->hbm_f_os_supported)
+		return;
+
 	ret = mei_cldev_enable(cldev);
 	if (ret)
 		return;
* Unmerged path drivers/misc/mei/debugfs.c
* Unmerged path drivers/misc/mei/hbm.c
* Unmerged path drivers/misc/mei/hw.h
* Unmerged path drivers/misc/mei/mei_dev.h
