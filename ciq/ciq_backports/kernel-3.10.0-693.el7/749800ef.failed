autofs: test autofs versions first on sb initialization

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Tomohiro Kusumi <kusumi.tomohiro@gmail.com>
commit 749800ef537848b9569da9bb1463f1de4b96c0a4
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/749800ef.failed

This patch does what the below comment says.  It could be and it's
considered better to do this first before various functions get called
during initialization.

/* Couldn't this be tested earlier? */

Link: http://lkml.kernel.org/r/20160812024744.12352.43075.stgit@pluto.themaw.net
	Signed-off-by: Tomohiro Kusumi <kusumi.tomohiro@gmail.com>
	Signed-off-by: Ian Kent <raven@themaw.net>
	Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
	Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
(cherry picked from commit 749800ef537848b9569da9bb1463f1de4b96c0a4)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/autofs4/inode.c
diff --cc fs/autofs4/inode.c
index 396178847bf6,d76573f62278..000000000000
--- a/fs/autofs4/inode.c
+++ b/fs/autofs4/inode.c
@@@ -292,24 -308,7 +309,28 @@@ int autofs4_fill_super(struct super_blo
  	root_inode->i_fop = &autofs4_root_operations;
  	root_inode->i_op = &autofs4_dir_inode_operations;
  
++<<<<<<< HEAD
 +	/* Couldn't this be tested earlier? */
 +	if (sbi->max_proto < AUTOFS_MIN_PROTO_VERSION ||
 +	    sbi->min_proto > AUTOFS_MAX_PROTO_VERSION) {
 +		AUTOFS_ERROR("kernel does not match daemon version "
 +			     "daemon (%d, %d) kernel (%d, %d)",
 +			sbi->min_proto, sbi->max_proto,
 +			AUTOFS_MIN_PROTO_VERSION, AUTOFS_MAX_PROTO_VERSION);
 +		goto fail_dput;
 +	}
 +
 +	/* Establish highest kernel protocol version */
 +	if (sbi->max_proto > AUTOFS_MAX_PROTO_VERSION)
 +		sbi->version = AUTOFS_MAX_PROTO_VERSION;
 +	else
 +		sbi->version = sbi->max_proto;
 +	sbi->sub_version = AUTOFS_PROTO_SUBVERSION;
 +
 +	DPRINTK("pipe fd = %d, pgrp = %u", pipefd, pid_nr(sbi->oz_pgrp));
++=======
+ 	pr_debug("pipe fd = %d, pgrp = %u\n", pipefd, pid_nr(sbi->oz_pgrp));
++>>>>>>> 749800ef5378 (autofs: test autofs versions first on sb initialization)
  	pipe = fget(pipefd);
  
  	if (!pipe) {
* Unmerged path fs/autofs4/inode.c
