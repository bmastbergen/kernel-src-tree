x86, kaslr: Select random position from e820 maps

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
Rebuild_CHGLOG: - [x86] kaslr: Select random position from e820 maps (Baoquan He) [1290840]
Rebuild_FUZZ: 94.62%
commit-author Kees Cook <keescook@chromium.org>
commit 82fa9637a2ba285bcc7c5050c73010b2c1b3d803
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/82fa9637.failed

Counts available alignment positions across all e820 maps, and chooses
one randomly for the new kernel base address, making sure not to collide
with unsafe memory areas.

	Signed-off-by: Kees Cook <keescook@chromium.org>
Link: http://lkml.kernel.org/r/1381450698-28710-5-git-send-email-keescook@chromium.org
	Signed-off-by: H. Peter Anvin <hpa@linux.intel.com>
(cherry picked from commit 82fa9637a2ba285bcc7c5050c73010b2c1b3d803)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/boot/compressed/aslr.c
#	arch/x86/boot/compressed/misc.c
diff --cc arch/x86/boot/compressed/misc.c
index f432a23615b1,196eaf373a06..000000000000
--- a/arch/x86/boot/compressed/misc.c
+++ b/arch/x86/boot/compressed/misc.c
@@@ -116,14 -109,11 +116,22 @@@ static void error(char *m)
   */
  struct boot_params *real_mode;		/* Pointer to real-mode data */
  
++<<<<<<< HEAD
 +#ifdef CONFIG_X86_64
 +#define memptr long
 +#else
 +#define memptr unsigned
 +#endif
 +
 +static memptr free_mem_ptr;
 +static memptr free_mem_end_ptr;
++=======
+ void *memset(void *s, int c, size_t n);
+ void *memcpy(void *dest, const void *src, size_t n);
+ 
+ memptr free_mem_ptr;
+ memptr free_mem_end_ptr;
++>>>>>>> 82fa9637a2ba (x86, kaslr: Select random position from e820 maps)
  
  static char *vidmem;
  static int vidport;
* Unmerged path arch/x86/boot/compressed/aslr.c
* Unmerged path arch/x86/boot/compressed/aslr.c
* Unmerged path arch/x86/boot/compressed/misc.c
diff --git a/arch/x86/boot/compressed/misc.h b/arch/x86/boot/compressed/misc.h
index 674019d8e235..7503096aaa8d 100644
--- a/arch/x86/boot/compressed/misc.h
+++ b/arch/x86/boot/compressed/misc.h
@@ -23,7 +23,15 @@
 #define BOOT_BOOT_H
 #include "../ctype.h"
 
+#ifdef CONFIG_X86_64
+#define memptr long
+#else
+#define memptr unsigned
+#endif
+
 /* misc.c */
+extern memptr free_mem_ptr;
+extern memptr free_mem_end_ptr;
 extern struct boot_params *real_mode;		/* Pointer to real-mode data */
 void __putstr(const char *s);
 #define error_putstr(__x)  __putstr(__x)
