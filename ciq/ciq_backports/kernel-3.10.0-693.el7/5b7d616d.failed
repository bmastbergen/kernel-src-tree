ipv4: fib: Send notification before deleting FIB alias

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Ido Schimmel <idosch@mellanox.com>
commit 5b7d616dbccc2fd6ae959045e1a9ca17de5dfc2a
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/5b7d616d.failed

When a FIB alias is replaced following NLM_F_REPLACE, the ENTRY_ADD
notification is sent after the reference on the previous FIB info was
dropped. This is problematic as potential listeners might need to access
it in their notification blocks.

Solve this by sending the notification prior to the deletion of the
replaced FIB alias. This is consistent with ENTRY_DEL notifications.

	Signed-off-by: Ido Schimmel <idosch@mellanox.com>
	Signed-off-by: Jiri Pirko <jiri@mellanox.com>
CC: Patrick McHardy <kaber@trash.net>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 5b7d616dbccc2fd6ae959045e1a9ca17de5dfc2a)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/ipv4/fib_trie.c
diff --cc net/ipv4/fib_trie.c
index a731822edc22,1c4d42e46dbb..000000000000
--- a/net/ipv4/fib_trie.c
+++ b/net/ipv4/fib_trie.c
@@@ -1154,15 -1292,23 +1154,25 @@@ int fib_table_insert(struct fib_table *
  			state = fa->fa_state;
  			new_fa->fa_state = state & ~FA_S_ACCESSED;
  			new_fa->fa_slen = fa->fa_slen;
 -			new_fa->tb_id = tb->tb_id;
 -			new_fa->fa_default = -1;
  
+ 			call_fib_entry_notifiers(net, FIB_EVENT_ENTRY_ADD,
+ 						 key, plen, fi,
+ 						 new_fa->fa_tos, cfg->fc_type,
+ 						 tb->tb_id, nlflags);
+ 			rtmsg_fib(RTM_NEWROUTE, htonl(key), new_fa, plen,
+ 				  tb->tb_id, &cfg->fc_nlinfo, nlflags);
+ 
  			hlist_replace_rcu(&fa->fa_list, &new_fa->fa_list);
 -
  			alias_free_mem_rcu(fa);
  
  			fib_release_info(fi_drop);
  			if (state & FA_S_ACCESSED)
  				rt_cache_flush(cfg->fc_nlinfo.nl_net);
++<<<<<<< HEAD
 +			rtmsg_fib(RTM_NEWROUTE, htonl(key), new_fa, plen,
 +				tb->tb_id, &cfg->fc_nlinfo, NLM_F_REPLACE);
++=======
++>>>>>>> 5b7d616dbccc (ipv4: fib: Send notification before deleting FIB alias)
  
  			goto succeeded;
  		}
* Unmerged path net/ipv4/fib_trie.c
