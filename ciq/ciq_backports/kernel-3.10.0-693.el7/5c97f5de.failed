NFSv4.1/pNFS: pnfs_mark_matching_lsegs_return() should set the iomode

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Trond Myklebust <trond.myklebust@primarydata.com>
commit 5c97f5de2c7cd9e2a5f71bc7c53125d9a2833ca9
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/5c97f5de.failed

If pnfs_mark_matching_lsegs_return() needs to mark a layout segment for
return, then it must also set the return iomode.

	Signed-off-by: Trond Myklebust <trond.myklebust@primarydata.com>
(cherry picked from commit 5c97f5de2c7cd9e2a5f71bc7c53125d9a2833ca9)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/nfs/pnfs.c
diff --cc fs/nfs/pnfs.c
index da07387a0367,449c4782cab3..000000000000
--- a/fs/nfs/pnfs.c
+++ b/fs/nfs/pnfs.c
@@@ -1774,10 -1810,9 +1785,16 @@@ void pnfs_error_mark_layout_for_return(
  	LIST_HEAD(free_me);
  
  	spin_lock(&inode->i_lock);
++<<<<<<< HEAD
 +	if (lo->plh_return_iomode == 0)
 +		lo->plh_return_iomode = range.iomode;
 +	else if (lo->plh_return_iomode != range.iomode)
 +		lo->plh_return_iomode = IOMODE_ANY;
++=======
+ 	/* set failure bit so that pnfs path will be retried later */
+ 	pnfs_layout_set_fail_bit(lo, iomode);
+ 	pnfs_set_plh_return_iomode(lo, range.iomode);
++>>>>>>> 5c97f5de2c7c (NFSv4.1/pNFS: pnfs_mark_matching_lsegs_return() should set the iomode)
  	/*
  	 * mark all matching lsegs so that we are sure to have no live
  	 * segments at hand when sending layoutreturn. See pnfs_put_lseg()
* Unmerged path fs/nfs/pnfs.c
