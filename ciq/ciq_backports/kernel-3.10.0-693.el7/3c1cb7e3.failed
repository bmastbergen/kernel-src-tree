perf record: Split output into multiple files via '--switch-output'

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Wang Nan <wangnan0@huawei.com>
commit 3c1cb7e3723caad9b4c1b2f816d86d8605296a4b
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/3c1cb7e3.failed

Allow 'perf record' to split its output into multiple files.

For example:

  # ~/perf record -a --timestamp-filename --switch-output &
  [1] 10763
  # kill -s SIGUSR2 10763
  [ perf record: dump data: Woken up 1 times ]
  # [ perf record: Dump perf.data.2015122622314468 ]

  # kill -s SIGUSR2 10763
  [ perf record: dump data: Woken up 1 times ]
  # [ perf record: Dump perf.data.2015122622314762 ]

  # kill -s SIGUSR2 10763
  [ perf record: dump data: Woken up 1 times ]
  #[ perf record: Dump perf.data.2015122622315171 ]

  # fg
  perf record -a --timestamp-filename --switch-output
  ^C[ perf record: Woken up 1 times to write data ]
  [ perf record: Dump perf.data.2015122622315513 ]
  [ perf record: Captured and wrote 0.014 MB perf.data.<timestamp> (296 samples) ]

  # ls -l
  total 920
  -rw------- 1 root root 797692 Dec 26 22:31 perf.data.2015122622314468
  -rw------- 1 root root  59960 Dec 26 22:31 perf.data.2015122622314762
  -rw------- 1 root root  59912 Dec 26 22:31 perf.data.2015122622315171
  -rw------- 1 root root  19220 Dec 26 22:31 perf.data.2015122622315513

	Signed-off-by: Wang Nan <wangnan0@huawei.com>
	Tested-by: Arnaldo Carvalho de Melo <acme@redhat.com>
	Cc: Adrian Hunter <adrian.hunter@intel.com>
	Cc: Jiri Olsa <jolsa@redhat.com>
	Cc: Masami Hiramatsu <mhiramat@kernel.org>
	Cc: Namhyung Kim <namhyung@kernel.org>
	Cc: Zefan Li <lizefan@huawei.com>
	Cc: pi3orama@163.com
Link: http://lkml.kernel.org/r/1461178794-40467-4-git-send-email-wangnan0@huawei.com
	Signed-off-by: He Kuang <hekuang@huawei.com>
[ Added man page entry, used the re-synthesize patch in this series as a fixup ]
	Signed-off-by: Arnaldo Carvalho de Melo <acme@redhat.com>
(cherry picked from commit 3c1cb7e3723caad9b4c1b2f816d86d8605296a4b)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/perf/builtin-record.c
diff --cc tools/perf/builtin-record.c
index 36b0c64985d1,8ebe953c7af0..000000000000
--- a/tools/perf/builtin-record.c
+++ b/tools/perf/builtin-record.c
@@@ -125,44 -129,9 +126,49 @@@ static volatile int done
  static volatile int signr = -1;
  static volatile int child_finished;
  
 +static volatile enum {
 +	AUXTRACE_SNAPSHOT_OFF = -1,
 +	AUXTRACE_SNAPSHOT_DISABLED = 0,
 +	AUXTRACE_SNAPSHOT_ENABLED = 1,
 +} auxtrace_snapshot_state = AUXTRACE_SNAPSHOT_OFF;
 +
 +static inline void
 +auxtrace_snapshot_on(void)
 +{
 +	auxtrace_snapshot_state = AUXTRACE_SNAPSHOT_DISABLED;
 +}
 +
 +static inline void
 +auxtrace_snapshot_enable(void)
 +{
 +	if (auxtrace_snapshot_state == AUXTRACE_SNAPSHOT_OFF)
 +		return;
 +	auxtrace_snapshot_state = AUXTRACE_SNAPSHOT_ENABLED;
 +}
 +
 +static inline void
 +auxtrace_snapshot_disable(void)
 +{
 +	if (auxtrace_snapshot_state == AUXTRACE_SNAPSHOT_OFF)
 +		return;
 +	auxtrace_snapshot_state = AUXTRACE_SNAPSHOT_DISABLED;
 +}
 +
 +static inline bool
 +auxtrace_snapshot_is_enabled(void)
 +{
 +	if (auxtrace_snapshot_state == AUXTRACE_SNAPSHOT_OFF)
 +		return false;
 +	return auxtrace_snapshot_state == AUXTRACE_SNAPSHOT_ENABLED;
 +}
 +
 +static volatile int auxtrace_snapshot_err;
  static volatile int auxtrace_record__snapshot_started;
++<<<<<<< HEAD
++=======
+ static DEFINE_TRIGGER(auxtrace_snapshot_trigger);
+ static DEFINE_TRIGGER(switch_output_trigger);
++>>>>>>> 3c1cb7e3723c (perf record: Split output into multiple files via '--switch-output')
  
  static void sig_handler(int sig)
  {
@@@ -682,9 -659,12 +695,16 @@@ static int __cmd_record(struct record *
  	signal(SIGINT, sig_handler);
  	signal(SIGTERM, sig_handler);
  
- 	if (rec->opts.auxtrace_snapshot_mode) {
+ 	if (rec->opts.auxtrace_snapshot_mode || rec->switch_output) {
  		signal(SIGUSR2, snapshot_sig_handler);
++<<<<<<< HEAD
 +		auxtrace_snapshot_on();
++=======
+ 		if (rec->opts.auxtrace_snapshot_mode)
+ 			trigger_on(&auxtrace_snapshot_trigger);
+ 		if (rec->switch_output)
+ 			trigger_on(&switch_output_trigger);
++>>>>>>> 3c1cb7e3723c (perf record: Split output into multiple files via '--switch-output')
  	} else {
  		signal(SIGUSR2, SIG_IGN);
  	}
@@@ -803,12 -793,14 +823,22 @@@
  		perf_evlist__enable(rec->evlist);
  	}
  
++<<<<<<< HEAD
 +	auxtrace_snapshot_enable();
++=======
+ 	trigger_ready(&auxtrace_snapshot_trigger);
+ 	trigger_ready(&switch_output_trigger);
++>>>>>>> 3c1cb7e3723c (perf record: Split output into multiple files via '--switch-output')
  	for (;;) {
  		unsigned long long hits = rec->samples;
  
  		if (record__mmap_read_all(rec) < 0) {
++<<<<<<< HEAD
 +			auxtrace_snapshot_disable();
++=======
+ 			trigger_error(&auxtrace_snapshot_trigger);
+ 			trigger_error(&switch_output_trigger);
++>>>>>>> 3c1cb7e3723c (perf record: Split output into multiple files via '--switch-output')
  			err = -1;
  			goto out_child;
  		}
@@@ -851,7 -859,8 +897,12 @@@
  			disabled = true;
  		}
  	}
++<<<<<<< HEAD
 +	auxtrace_snapshot_disable();
++=======
+ 	trigger_off(&auxtrace_snapshot_trigger);
+ 	trigger_off(&switch_output_trigger);
++>>>>>>> 3c1cb7e3723c (perf record: Split output into multiple files via '--switch-output')
  
  	if (forks && workload_exec_errno) {
  		char msg[STRERR_BUFSIZE];
@@@ -1315,9 -1444,13 +1368,21 @@@ out_symbol_exit
  
  static void snapshot_sig_handler(int sig __maybe_unused)
  {
++<<<<<<< HEAD
 +	if (!auxtrace_snapshot_is_enabled())
 +		return;
 +	auxtrace_snapshot_disable();
 +	auxtrace_snapshot_err = auxtrace_record__snapshot_start(record.itr);
 +	auxtrace_record__snapshot_started = 1;
++=======
+ 	if (trigger_is_ready(&auxtrace_snapshot_trigger)) {
+ 		trigger_hit(&auxtrace_snapshot_trigger);
+ 		auxtrace_record__snapshot_started = 1;
+ 		if (auxtrace_record__snapshot_start(record.itr))
+ 			trigger_error(&auxtrace_snapshot_trigger);
+ 	}
+ 
+ 	if (trigger_is_ready(&switch_output_trigger))
+ 		trigger_hit(&switch_output_trigger);
++>>>>>>> 3c1cb7e3723c (perf record: Split output into multiple files via '--switch-output')
  }
diff --git a/tools/perf/Documentation/perf-record.txt b/tools/perf/Documentation/perf-record.txt
index 20052ecd742e..fa543b4f3bd2 100644
--- a/tools/perf/Documentation/perf-record.txt
+++ b/tools/perf/Documentation/perf-record.txt
@@ -328,6 +328,14 @@ Configure all used events to run in kernel space.
 --all-user::
 Configure all used events to run in user space.
 
+--switch-output::
+Generate multiple perf.data files, timestamp prefixed, switching to a new one
+when receiving a SIGUSR2.
+
+A possible use case is to, given an external event, slice the perf.data file
+that gets then processed, possibly via a perf script, to decide if that
+particular perf.data snapshot should be kept or not.
+
 SEE ALSO
 --------
 linkperf:perf-stat[1], linkperf:perf-list[1]
* Unmerged path tools/perf/builtin-record.c
