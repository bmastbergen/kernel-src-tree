dell-smbios: return the SMBIOS buffer from dell_smbios_get_buffer()

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Michał Kępień <kernel@kempniu.pl>
commit bc2104c27aad0c988d23c6abcd46f3313618bdbb
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/bc2104c2.failed

Ultimately, the SMBIOS buffer should not be exported from dell-smbios.
Currently, dell-laptop accesses it directly using a global variable, so
make dell_smbios_get_buffer() return a pointer to the SMBIOS buffer and
replace all uses of the global variable with local variables.

	Signed-off-by: Michał Kępień <kernel@kempniu.pl>
	Reviewed-by: Pali Rohár <pali.rohar@gmail.com>
	Signed-off-by: Darren Hart <dvhart@linux.intel.com>
(cherry picked from commit bc2104c27aad0c988d23c6abcd46f3313618bdbb)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/platform/x86/dell-laptop.c
#	drivers/platform/x86/dell-smbios.c
#	drivers/platform/x86/dell-smbios.h
diff --cc drivers/platform/x86/dell-laptop.c
index 87688ae0318c,5b200f29c55d..000000000000
--- a/drivers/platform/x86/dell-laptop.c
+++ b/drivers/platform/x86/dell-laptop.c
@@@ -555,9 -417,9 +556,13 @@@ static int dell_rfkill_set(void *data, 
  	int status;
  	int ret;
  
++<<<<<<< HEAD
 +	get_buffer();
++=======
+ 	buffer = dell_smbios_get_buffer();
++>>>>>>> bc2104c27aad (dell-smbios: return the SMBIOS buffer from dell_smbios_get_buffer())
  
 -	dell_smbios_send_request(17, 11);
 +	dell_send_request(buffer, 17, 11);
  	ret = buffer->output[0];
  	status = buffer->output[1];
  
@@@ -618,9 -482,9 +625,13 @@@ static void dell_rfkill_query(struct rf
  	int status;
  	int ret;
  
++<<<<<<< HEAD
 +	get_buffer();
++=======
+ 	buffer = dell_smbios_get_buffer();
++>>>>>>> bc2104c27aad (dell-smbios: return the SMBIOS buffer from dell_smbios_get_buffer())
  
 -	dell_smbios_send_request(17, 11);
 +	dell_send_request(buffer, 17, 11);
  	ret = buffer->output[0];
  	status = buffer->output[1];
  
@@@ -658,9 -523,9 +670,13 @@@ static int dell_debugfs_show(struct seq
  	int status;
  	int ret;
  
++<<<<<<< HEAD
 +	get_buffer();
++=======
+ 	buffer = dell_smbios_get_buffer();
++>>>>>>> bc2104c27aad (dell-smbios: return the SMBIOS buffer from dell_smbios_get_buffer())
  
 -	dell_smbios_send_request(17, 11);
 +	dell_send_request(buffer, 17, 11);
  	ret = buffer->output[0];
  	status = buffer->output[1];
  
@@@ -756,9 -622,9 +773,13 @@@ static void dell_update_rfkill(struct w
  	int status;
  	int ret;
  
++<<<<<<< HEAD
 +	get_buffer();
++=======
+ 	buffer = dell_smbios_get_buffer();
++>>>>>>> bc2104c27aad (dell-smbios: return the SMBIOS buffer from dell_smbios_get_buffer())
  
 -	dell_smbios_send_request(17, 11);
 +	dell_send_request(buffer, 17, 11);
  	ret = buffer->output[0];
  	status = buffer->output[1];
  
@@@ -848,11 -716,11 +871,16 @@@ static int __init dell_setup_rfkill(voi
  	if (!force_rfkill && !whitelisted)
  		return 0;
  
++<<<<<<< HEAD
 +	get_buffer();
 +	dell_send_request(buffer, 17, 11);
++=======
+ 	buffer = dell_smbios_get_buffer();
+ 	dell_smbios_send_request(17, 11);
++>>>>>>> bc2104c27aad (dell-smbios: return the SMBIOS buffer from dell_smbios_get_buffer())
  	ret = buffer->output[0];
  	status = buffer->output[1];
 -	dell_smbios_release_buffer();
 +	release_buffer();
  
  	/* dell wireless info smbios call is not supported */
  	if (ret != 0)
@@@ -1012,7 -881,7 +1041,11 @@@ static int dell_send_intensity(struct b
  	if (token == -1)
  		return -ENODEV;
  
++<<<<<<< HEAD
 +	get_buffer();
++=======
+ 	buffer = dell_smbios_get_buffer();
++>>>>>>> bc2104c27aad (dell-smbios: return the SMBIOS buffer from dell_smbios_get_buffer())
  	buffer->input[0] = token;
  	buffer->input[1] = bd->props.brightness;
  
@@@ -1036,7 -906,7 +1070,11 @@@ static int dell_get_intensity(struct ba
  	if (token == -1)
  		return -ENODEV;
  
++<<<<<<< HEAD
 +	get_buffer();
++=======
+ 	buffer = dell_smbios_get_buffer();
++>>>>>>> bc2104c27aad (dell-smbios: return the SMBIOS buffer from dell_smbios_get_buffer())
  	buffer->input[0] = token;
  
  	if (power_supply_is_system_supplied() > 0)
@@@ -1296,10 -1167,10 +1335,14 @@@ static int kbd_get_info(struct kbd_inf
  	u8 units;
  	int ret;
  
++<<<<<<< HEAD
 +	get_buffer();
++=======
+ 	buffer = dell_smbios_get_buffer();
++>>>>>>> bc2104c27aad (dell-smbios: return the SMBIOS buffer from dell_smbios_get_buffer())
  
  	buffer->input[0] = 0x0;
 -	dell_smbios_send_request(4, 11);
 +	dell_send_request(buffer, 4, 11);
  	ret = buffer->output[0];
  
  	if (ret) {
@@@ -1382,12 -1253,13 +1425,17 @@@ static int kbd_set_level(struct kbd_sta
  
  static int kbd_get_state(struct kbd_state *state)
  {
+ 	struct calling_interface_buffer *buffer;
  	int ret;
  
++<<<<<<< HEAD
 +	get_buffer();
++=======
+ 	buffer = dell_smbios_get_buffer();
++>>>>>>> bc2104c27aad (dell-smbios: return the SMBIOS buffer from dell_smbios_get_buffer())
  
  	buffer->input[0] = 0x1;
 -	dell_smbios_send_request(4, 11);
 +	dell_send_request(buffer, 4, 11);
  	ret = buffer->output[0];
  
  	if (ret) {
@@@ -1413,9 -1285,10 +1461,14 @@@
  
  static int kbd_set_state(struct kbd_state *state)
  {
+ 	struct calling_interface_buffer *buffer;
  	int ret;
  
++<<<<<<< HEAD
 +	get_buffer();
++=======
+ 	buffer = dell_smbios_get_buffer();
++>>>>>>> bc2104c27aad (dell-smbios: return the SMBIOS buffer from dell_smbios_get_buffer())
  	buffer->input[0] = 0x2;
  	buffer->input[1] = BIT(state->mode_bit) & 0xFFFF;
  	buffer->input[1] |= (state->triggers & 0xFF) << 16;
@@@ -1462,12 -1336,12 +1516,16 @@@ static int kbd_set_token_bit(u8 bit
  	if (id == -1)
  		return -EINVAL;
  
++<<<<<<< HEAD
 +	get_buffer();
++=======
+ 	buffer = dell_smbios_get_buffer();
++>>>>>>> bc2104c27aad (dell-smbios: return the SMBIOS buffer from dell_smbios_get_buffer())
  	buffer->input[0] = da_tokens[id].location;
  	buffer->input[1] = da_tokens[id].value;
 -	dell_smbios_send_request(1, 0);
 +	dell_send_request(buffer, 1, 0);
  	ret = buffer->output[0];
 -	dell_smbios_release_buffer();
 +	release_buffer();
  
  	return dell_smi_error(ret);
  }
@@@ -1485,12 -1360,12 +1544,16 @@@ static int kbd_get_token_bit(u8 bit
  	if (id == -1)
  		return -EINVAL;
  
++<<<<<<< HEAD
 +	get_buffer();
++=======
+ 	buffer = dell_smbios_get_buffer();
++>>>>>>> bc2104c27aad (dell-smbios: return the SMBIOS buffer from dell_smbios_get_buffer())
  	buffer->input[0] = da_tokens[id].location;
 -	dell_smbios_send_request(0, 0);
 +	dell_send_request(buffer, 0, 0);
  	ret = buffer->output[0];
  	val = buffer->output[1];
 -	dell_smbios_release_buffer();
 +	release_buffer();
  
  	if (ret)
  		return dell_smi_error(ret);
@@@ -2144,12 -2032,12 +2208,16 @@@ static int __init dell_init(void
  
  	token = find_token_location(BRIGHTNESS_TOKEN);
  	if (token != -1) {
++<<<<<<< HEAD
 +		get_buffer();
++=======
+ 		buffer = dell_smbios_get_buffer();
++>>>>>>> bc2104c27aad (dell-smbios: return the SMBIOS buffer from dell_smbios_get_buffer())
  		buffer->input[0] = token;
 -		dell_smbios_send_request(0, 2);
 +		dell_send_request(buffer, 0, 2);
  		if (buffer->output[0] == 0)
  			max_intensity = buffer->output[3];
 -		dell_smbios_release_buffer();
 +		release_buffer();
  	}
  
  	if (max_intensity) {
* Unmerged path drivers/platform/x86/dell-smbios.c
* Unmerged path drivers/platform/x86/dell-smbios.h
* Unmerged path drivers/platform/x86/dell-laptop.c
* Unmerged path drivers/platform/x86/dell-smbios.c
* Unmerged path drivers/platform/x86/dell-smbios.h
