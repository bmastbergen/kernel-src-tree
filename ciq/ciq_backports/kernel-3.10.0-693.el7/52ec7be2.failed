pNFS: Clear out all layout segments if the server unsets lrp->res.lrs_present

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Trond Myklebust <trond.myklebust@primarydata.com>
commit 52ec7be2e27392201adf77892ba883f68df88c99
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/52ec7be2.failed

If the server fails to set lrp->res.lrs_present in the LAYOUTRETURN reply,
then that means it believes the client holds no more layout state for that
file, and that the layout stateid is now invalid.

	Signed-off-by: Trond Myklebust <trond.myklebust@primarydata.com>
(cherry picked from commit 52ec7be2e27392201adf77892ba883f68df88c99)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/nfs/nfs4proc.c
diff --cc fs/nfs/nfs4proc.c
index b5d19c4be62e,c380d2ee4137..000000000000
--- a/fs/nfs/nfs4proc.c
+++ b/fs/nfs/nfs4proc.c
@@@ -8284,12 -8190,16 +8284,21 @@@ static void nfs4_layoutreturn_release(v
  
  	dprintk("--> %s\n", __func__);
  	spin_lock(&lo->plh_inode->i_lock);
++<<<<<<< HEAD
 +	pnfs_mark_matching_lsegs_invalid(lo, &freeme, &lrp->args.range);
 +	pnfs_mark_layout_returned_if_empty(lo);
 +	if (lrp->res.lrs_present && pnfs_layout_is_valid(lo))
++=======
+ 	if (lrp->res.lrs_present) {
+ 		pnfs_mark_matching_lsegs_invalid(lo, &freeme,
+ 				&lrp->args.range,
+ 				be32_to_cpu(lrp->args.stateid.seqid));
++>>>>>>> 52ec7be2e273 (pNFS: Clear out all layout segments if the server unsets lrp->res.lrs_present)
  		pnfs_set_layout_stateid(lo, &lrp->res.stateid, true);
+ 	} else
+ 		pnfs_mark_layout_stateid_invalid(lo, &freeme);
  	pnfs_clear_layoutreturn_waitbit(lo);
  	spin_unlock(&lo->plh_inode->i_lock);
 -	nfs4_sequence_free_slot(&lrp->res.seq_res);
  	pnfs_free_lseg_list(&freeme);
  	pnfs_put_layout_hdr(lrp->args.layout);
  	nfs_iput_and_deactive(lrp->inode);
* Unmerged path fs/nfs/nfs4proc.c
