bridge: vlan: adjust rhashtable initial size and hash locks size

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Nikolay Aleksandrov <nikolay@cumulusnetworks.com>
commit 8af78b6487856d8a896ba15e9255b8e5fa91eb5f
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/8af78b64.failed

As Stephen pointed out the default initial size is more than we need, so
let's start small (4 elements, thus nelem_hint = 3). Also limit the hash
locks to the number of CPUs as we don't need any write-side scaling and
this looks like the minimum.

	Signed-off-by: Nikolay Aleksandrov <nikolay@cumulusnetworks.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 8af78b6487856d8a896ba15e9255b8e5fa91eb5f)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/bridge/br_vlan.c
diff --cc net/bridge/br_vlan.c
index 1122c9d717ea,283d012c3d89..000000000000
--- a/net/bridge/br_vlan.c
+++ b/net/bridge/br_vlan.c
@@@ -5,9 -5,35 +5,37 @@@
  
  #include "br_private.h"
  
 -static inline int br_vlan_cmp(struct rhashtable_compare_arg *arg,
 -			      const void *ptr)
 +static void __vlan_add_pvid(struct net_port_vlans *v, u16 vid)
  {
++<<<<<<< HEAD
 +	if (v->pvid == vid)
++=======
+ 	const struct net_bridge_vlan *vle = ptr;
+ 	u16 vid = *(u16 *)arg->key;
+ 
+ 	return vle->vid != vid;
+ }
+ 
+ static const struct rhashtable_params br_vlan_rht_params = {
+ 	.head_offset = offsetof(struct net_bridge_vlan, vnode),
+ 	.key_offset = offsetof(struct net_bridge_vlan, vid),
+ 	.key_len = sizeof(u16),
+ 	.nelem_hint = 3,
+ 	.locks_mul = 1,
+ 	.max_size = VLAN_N_VID,
+ 	.obj_cmpfn = br_vlan_cmp,
+ 	.automatic_shrinking = true,
+ };
+ 
+ static struct net_bridge_vlan *br_vlan_lookup(struct rhashtable *tbl, u16 vid)
+ {
+ 	return rhashtable_lookup_fast(tbl, &vid, br_vlan_rht_params);
+ }
+ 
+ static void __vlan_add_pvid(u16 *pvid, u16 vid)
+ {
+ 	if (*pvid == vid)
++>>>>>>> 8af78b648785 (bridge: vlan: adjust rhashtable initial size and hash locks size)
  		return;
  
  	smp_wmb();
* Unmerged path net/bridge/br_vlan.c
