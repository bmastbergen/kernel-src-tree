genirq: Add default affinity mask command line option

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Thomas Gleixner <tglx@linutronix.de>
commit fbf198030e0b027538c290300cfaf9e2efdce122
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/fbf19803.failed

If we isolate CPUs, then we don't want random device interrupts on them. Even
w/o the user space irq balancer enabled we can end up with irqs on non boot
cpus and chasing newly requested interrupts is a tedious task.

Allow to restrict the default irq affinity mask.

	Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
	Cc: Rik van Riel <riel@redhat.com>
	Cc: Peter Zijlstra <peterz@infradead.org>
	Cc: Frederic Weisbecker <fweisbec@gmail.com>
	Cc: Chris Metcalf <cmetcalf@ezchip.com>
	Cc: Christoph Lameter <cl@linux.com>
	Cc: Sebastian Siewior <bigeasy@linutronix.de>
Link: http://lkml.kernel.org/r/alpine.DEB.2.11.1602031948190.25254@nanos
	Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
(cherry picked from commit fbf198030e0b027538c290300cfaf9e2efdce122)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	Documentation/kernel-parameters.txt
diff --cc Documentation/kernel-parameters.txt
index 9e68cd5687f9,87298f8592b7..000000000000
--- a/Documentation/kernel-parameters.txt
+++ b/Documentation/kernel-parameters.txt
@@@ -1334,9 -1687,14 +1334,20 @@@ bytes respectively. Such letter suffixe
  	ip=		[IP_PNP]
  			See Documentation/filesystems/nfs/nfsroot.txt.
  
++<<<<<<< HEAD
 +	ip2=		[HW] Set IO/IRQ pairs for up to 4 IntelliPort boards
 +			See comment before ip2_setup() in
 +			drivers/char/ip2/ip2base.c.
++=======
+ 	irqaffinity=	[SMP] Set the default irq affinity mask
+ 			Format:
+ 			<cpu number>,...,<cpu number>
+ 			or
+ 			<cpu number>-<cpu number>
+ 			(must be a positive range in ascending order)
+ 			or a mixture
+ 			<cpu number>,...,<cpu number>-<cpu number>
++>>>>>>> fbf198030e0b (genirq: Add default affinity mask command line option)
  
  	irqfixup	[HW]
  			When an interrupt is not handled search all handlers
* Unmerged path Documentation/kernel-parameters.txt
diff --git a/kernel/irq/irqdesc.c b/kernel/irq/irqdesc.c
index 73bdba5806b3..a7ab03c91622 100644
--- a/kernel/irq/irqdesc.c
+++ b/kernel/irq/irqdesc.c
@@ -23,10 +23,27 @@
 static struct lock_class_key irq_desc_lock_class;
 
 #if defined(CONFIG_SMP)
+static int __init irq_affinity_setup(char *str)
+{
+	zalloc_cpumask_var(&irq_default_affinity, GFP_NOWAIT);
+	cpulist_parse(str, irq_default_affinity);
+	/*
+	 * Set at least the boot cpu. We don't want to end up with
+	 * bugreports caused by random comandline masks
+	 */
+	cpumask_set_cpu(smp_processor_id(), irq_default_affinity);
+	return 1;
+}
+__setup("irqaffinity=", irq_affinity_setup);
+
 static void __init init_irq_default_affinity(void)
 {
-	alloc_cpumask_var(&irq_default_affinity, GFP_NOWAIT);
-	cpumask_setall(irq_default_affinity);
+#ifdef CONFIG_CPUMASK_OFFSTACK
+	if (!irq_default_affinity)
+		zalloc_cpumask_var(&irq_default_affinity, GFP_NOWAIT);
+#endif
+	if (cpumask_empty(irq_default_affinity))
+		cpumask_setall(irq_default_affinity);
 }
 #else
 static void __init init_irq_default_affinity(void)
