HID: wacom: move allocation of inputs earlier

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
Rebuild_CHGLOG: - [hid] wacom: move allocation of inputs earlier (Aristeu Rozanski) [1346348 1388646 1385026]
Rebuild_FUZZ: 94.12%
commit-author Benjamin Tissoires <benjamin.tissoires@redhat.com>
commit 494078b0bb578c4cf1e00275dd3224d793013488
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/494078b0.failed

This allows to have the input devices ready in while parsing the reports
descriptor.

	Signed-off-by: Benjamin Tissoires <benjamin.tissoires@redhat.com>
	Acked-by: Jason Gerecke <killertofu@gmail.com>
	Signed-off-by: Jiri Kosina <jkosina@suse.cz>
(cherry picked from commit 494078b0bb578c4cf1e00275dd3224d793013488)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/hid/wacom_sys.c
diff --cc drivers/hid/wacom_sys.c
index 527bf559d1db,21ac2baa21be..000000000000
--- a/drivers/hid/wacom_sys.c
+++ b/drivers/hid/wacom_sys.c
@@@ -1334,11 -1356,13 +1334,17 @@@ static int wacom_probe(struct usb_inter
  	wacom->intf = intf;
  	mutex_init(&wacom->lock);
  	INIT_WORK(&wacom->work, wacom_wireless_work);
 +	usb_make_path(dev, wacom->phys, sizeof(wacom->phys));
 +	strlcat(wacom->phys, "/input0", sizeof(wacom->phys));
 +
 +	endpoint = &intf->cur_altsetting->endpoint[0].desc;
  
+ 	if (!(features->quirks & WACOM_QUIRK_NO_INPUT)) {
+ 		error = wacom_allocate_inputs(wacom);
+ 		if (error)
+ 			goto fail_allocate_inputs;
+ 	}
+ 
  	/* set the default size in case we do not get them from hid */
  	wacom_set_default_phy(features);
  
@@@ -1386,29 -1422,30 +1392,33 @@@
  		else
  			strlcat(wacom_wac->name, " Pad", WACOM_NAME_MAX);
  
 -		error = wacom_add_shared_data(hdev);
 +		other_dev = wacom_get_sibling(dev, features->oVid, features->oPid);
 +		if (other_dev == NULL || wacom_get_usbdev_data(other_dev) == NULL)
 +			other_dev = dev;
 +		error = wacom_add_shared_data(wacom_wac, other_dev);
  		if (error)
 -			goto fail_shared_data;
 +			goto fail3;
  	}
  
 -	if (!(features->quirks & WACOM_QUIRK_MONITOR) &&
 -	     (features->quirks & WACOM_QUIRK_BATTERY)) {
 -		error = wacom_initialize_battery(wacom);
 -		if (error)
 -			goto fail_battery;
 -	}
 +	usb_fill_int_urb(wacom->irq, dev,
 +			 usb_rcvintpipe(dev, endpoint->bEndpointAddress),
 +			 wacom_wac->data, features->pktlen,
 +			 wacom_sys_irq, wacom, endpoint->bInterval);
 +	wacom->irq->transfer_dma = wacom->data_dma;
 +	wacom->irq->transfer_flags |= URB_NO_TRANSFER_DMA_MAP;
 +
 +	error = wacom_initialize_leds(wacom);
 +	if (error)
 +		goto fail4;
  
  	if (!(features->quirks & WACOM_QUIRK_NO_INPUT)) {
++<<<<<<< HEAD
 +		error = wacom_register_input(wacom);
++=======
+ 		error = wacom_register_inputs(wacom);
++>>>>>>> 494078b0bb57 (HID: wacom: move allocation of inputs earlier)
  		if (error)
 -			goto fail_register_inputs;
 -	}
 -
 -	if (hdev->bus == BUS_BLUETOOTH) {
 -		error = device_create_file(&hdev->dev, &dev_attr_speed);
 -		if (error)
 -			hid_warn(hdev,
 -				 "can't create sysfs speed attribute err: %d\n",
 -				 error);
 +			goto fail5;
  	}
  
  	/* Note that if query fails it is not a hard failure */
@@@ -1425,11 -1468,22 +1435,30 @@@
  
  	return 0;
  
++<<<<<<< HEAD
 + fail5: wacom_destroy_leds(wacom);
 + fail4:	wacom_remove_shared_data(wacom_wac);
 + fail3:	usb_free_urb(wacom->irq);
 + fail2:	usb_free_coherent(dev, WACOM_PKGLEN_MAX, wacom_wac->data, wacom->data_dma);
 + fail1:	kfree(wacom);
++=======
+ fail_hw_start:
+ 	if (hdev->bus == BUS_BLUETOOTH)
+ 		device_remove_file(&hdev->dev, &dev_attr_speed);
+ fail_register_inputs:
+ 	wacom_clean_inputs(wacom);
+ 	wacom_destroy_battery(wacom);
+ fail_battery:
+ 	wacom_remove_shared_data(wacom_wac);
+ fail_shared_data:
+ 	wacom_clean_inputs(wacom);
+ fail_allocate_inputs:
+ fail_type:
+ fail_pktlen:
+ fail_parse:
+ 	kfree(wacom);
+ 	hid_set_drvdata(hdev, NULL);
++>>>>>>> 494078b0bb57 (HID: wacom: move allocation of inputs earlier)
  	return error;
  }
  
* Unmerged path drivers/hid/wacom_sys.c
