libcxgb,iw_cxgb4,cxgbit: add cxgb_compute_wscale()

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
Rebuild_CHGLOG: - [target] libcxgb, iw_cxgb4, cxgbit: add cxgb_compute_wscale() (Don Dutile) [1385866 1417285]
Rebuild_FUZZ: 98.04%
commit-author Varun Prakash <varun@chelsio.com>
commit cc516700c7edab4197d08998ac023c3043369391
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/cc516700.failed

Add cxgb_compute_wscale() in libcxgb_cm.h to remove
it's duplicate definitions from cxgb4/cm.c and
cxgbit/cxgbit_cm.c.

	Signed-off-by: Varun Prakash <varun@chelsio.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit cc516700c7edab4197d08998ac023c3043369391)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/hw/cxgb4/cm.c
#	drivers/net/ethernet/chelsio/libcxgb/libcxgb_cm.h
#	drivers/target/iscsi/cxgbit/cxgbit_cm.c
diff --cc drivers/infiniband/hw/cxgb4/cm.c
index 7fc4048a8a8f,b9d77df0a2f6..000000000000
--- a/drivers/infiniband/hw/cxgb4/cm.c
+++ b/drivers/infiniband/hw/cxgb4/cm.c
@@@ -817,10 -736,10 +817,17 @@@ static int send_connect(struct c4iw_ep 
  	}
  	set_wr_txq(skb, CPL_PRIORITY_SETUP, ep->ctrlq_idx);
  
++<<<<<<< HEAD
 +	best_mtu(ep->com.dev->rdev.lldi.mtus, ep->mtu, &mtu_idx,
 +		 enable_tcp_timestamps,
 +		 (AF_INET == ep->com.remote_addr.ss_family) ? 0 : 1);
 +	wscale = compute_wscale(rcv_win);
++=======
+ 	cxgb_best_mtu(ep->com.dev->rdev.lldi.mtus, ep->mtu, &mtu_idx,
+ 		      enable_tcp_timestamps,
+ 		      (ep->com.remote_addr.ss_family == AF_INET) ? 0 : 1);
+ 	wscale = cxgb_compute_wscale(rcv_win);
++>>>>>>> cc516700c7ed (libcxgb,iw_cxgb4,cxgbit: add cxgb_compute_wscale())
  
  	/*
  	 * Specify the largest window that will fit in opt0. The
@@@ -1997,10 -1916,10 +2004,17 @@@ static int send_fw_act_open_req(struct 
  			htons(FW_OFLD_CONNECTION_WR_CPLRXDATAACK_F);
  	req->tcb.tx_max = (__force __be32) jiffies;
  	req->tcb.rcv_adv = htons(1);
++<<<<<<< HEAD
 +	best_mtu(ep->com.dev->rdev.lldi.mtus, ep->mtu, &mtu_idx,
 +		 enable_tcp_timestamps,
 +		 (AF_INET == ep->com.remote_addr.ss_family) ? 0 : 1);
 +	wscale = compute_wscale(rcv_win);
++=======
+ 	cxgb_best_mtu(ep->com.dev->rdev.lldi.mtus, ep->mtu, &mtu_idx,
+ 		      enable_tcp_timestamps,
+ 		      (ep->com.remote_addr.ss_family == AF_INET) ? 0 : 1);
+ 	wscale = cxgb_compute_wscale(rcv_win);
++>>>>>>> cc516700c7ed (libcxgb,iw_cxgb4,cxgbit: add cxgb_compute_wscale())
  
  	/*
  	 * Specify the largest window that will fit in opt0. The
@@@ -2446,10 -2360,10 +2460,17 @@@ static int accept_cr(struct c4iw_ep *ep
  	OPCODE_TID(rpl) = cpu_to_be32(MK_OPCODE_TID(CPL_PASS_ACCEPT_RPL,
  						    ep->hwtid));
  
++<<<<<<< HEAD
 +	best_mtu(ep->com.dev->rdev.lldi.mtus, ep->mtu, &mtu_idx,
 +		 enable_tcp_timestamps && req->tcpopt.tstamp,
 +		 (AF_INET == ep->com.remote_addr.ss_family) ? 0 : 1);
 +	wscale = compute_wscale(rcv_win);
++=======
+ 	cxgb_best_mtu(ep->com.dev->rdev.lldi.mtus, ep->mtu, &mtu_idx,
+ 		      enable_tcp_timestamps && req->tcpopt.tstamp,
+ 		      (ep->com.remote_addr.ss_family == AF_INET) ? 0 : 1);
+ 	wscale = cxgb_compute_wscale(rcv_win);
++>>>>>>> cc516700c7ed (libcxgb,iw_cxgb4,cxgbit: add cxgb_compute_wscale())
  
  	/*
  	 * Specify the largest window that will fit in opt0. The
diff --cc drivers/target/iscsi/cxgbit/cxgbit_cm.c
index 0ae0b131abfc,cd29c91d01fc..000000000000
--- a/drivers/target/iscsi/cxgbit/cxgbit_cm.c
+++ b/drivers/target/iscsi/cxgbit/cxgbit_cm.c
@@@ -1246,10 -1112,10 +1237,17 @@@ cxgbit_pass_accept_rpl(struct cxgbit_so
  	INIT_TP_WR(rpl5, csk->tid);
  	OPCODE_TID(rpl5) = cpu_to_be32(MK_OPCODE_TID(CPL_PASS_ACCEPT_RPL,
  						     csk->tid));
++<<<<<<< HEAD
 +	cxgbit_best_mtu(csk->com.cdev->lldi.mtus, csk->mtu, &mtu_idx,
 +			req->tcpopt.tstamp,
 +			(csk->com.remote_addr.ss_family == AF_INET) ? 0 : 1);
 +	wscale = cxgbit_compute_wscale(csk->rcv_win);
++=======
+ 	cxgb_best_mtu(csk->com.cdev->lldi.mtus, csk->mtu, &mtu_idx,
+ 		      req->tcpopt.tstamp,
+ 		      (csk->com.remote_addr.ss_family == AF_INET) ? 0 : 1);
+ 	wscale = cxgb_compute_wscale(csk->rcv_win);
++>>>>>>> cc516700c7ed (libcxgb,iw_cxgb4,cxgbit: add cxgb_compute_wscale())
  	/*
  	 * Specify the largest window that will fit in opt0. The
  	 * remainder will be specified in the rx_data_ack.
* Unmerged path drivers/net/ethernet/chelsio/libcxgb/libcxgb_cm.h
* Unmerged path drivers/infiniband/hw/cxgb4/cm.c
diff --git a/drivers/infiniband/hw/cxgb4/iw_cxgb4.h b/drivers/infiniband/hw/cxgb4/iw_cxgb4.h
index d85b16ddfbec..7962e304c3f1 100644
--- a/drivers/infiniband/hw/cxgb4/iw_cxgb4.h
+++ b/drivers/infiniband/hw/cxgb4/iw_cxgb4.h
@@ -883,15 +883,6 @@ static inline struct c4iw_listen_ep *to_listen_ep(struct iw_cm_id *cm_id)
 	return cm_id->provider_data;
 }
 
-static inline int compute_wscale(int win)
-{
-	int wscale = 0;
-
-	while (wscale < 14 && (65535<<wscale) < win)
-		wscale++;
-	return wscale;
-}
-
 static inline int ocqp_supported(const struct cxgb4_lld_info *infop)
 {
 #if defined(__i386__) || defined(__x86_64__) || defined(CONFIG_PPC64)
* Unmerged path drivers/net/ethernet/chelsio/libcxgb/libcxgb_cm.h
* Unmerged path drivers/target/iscsi/cxgbit/cxgbit_cm.c
