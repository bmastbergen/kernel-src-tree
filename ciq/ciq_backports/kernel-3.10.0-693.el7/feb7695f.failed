dm io: fix duplicate bio completion due to missing ref count

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Mike Snitzer <snitzer@redhat.com>
commit feb7695fe9fb83084aa29de0094774f4c9d4c9fc
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/feb7695f.failed

If only a subset of the devices associated with multiple regions support
a given special operation (eg. DISCARD) then the dec_count() that is
used to set error for the region must increment the io->count.

Otherwise, when the dec_count() is called it can cause the dm-io
caller's bio to be completed multiple times.  As was reported against
the dm-mirror target that had mirror legs with a mix of discard
capabilities.

Bug: https://bugzilla.kernel.org/show_bug.cgi?id=196077
	Reported-by: Zhang Yi <yizhan@redhat.com>
	Signed-off-by: Mike Snitzer <snitzer@redhat.com>
(cherry picked from commit feb7695fe9fb83084aa29de0094774f4c9d4c9fc)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/md/dm-io.c
diff --cc drivers/md/dm-io.c
index 29528aa7523b,8d5ca30f6551..000000000000
--- a/drivers/md/dm-io.c
+++ b/drivers/md/dm-io.c
@@@ -291,11 -310,15 +291,17 @@@ static void do_region(int rw, unsigned 
  	/*
  	 * Reject unsupported discard and write same requests.
  	 */
 -	if (op == REQ_OP_DISCARD)
 +	if (rw & REQ_DISCARD)
  		special_cmd_max_sectors = q->limits.max_discard_sectors;
 -	else if (op == REQ_OP_WRITE_ZEROES)
 -		special_cmd_max_sectors = q->limits.max_write_zeroes_sectors;
 -	else if (op == REQ_OP_WRITE_SAME)
 +	else if (rw & REQ_WRITE_SAME)
  		special_cmd_max_sectors = q->limits.max_write_same_sectors;
++<<<<<<< HEAD
 +	if ((rw & (REQ_DISCARD | REQ_WRITE_SAME)) && special_cmd_max_sectors == 0) {
++=======
+ 	if ((op == REQ_OP_DISCARD || op == REQ_OP_WRITE_ZEROES ||
+ 	     op == REQ_OP_WRITE_SAME) && special_cmd_max_sectors == 0) {
+ 		atomic_inc(&io->count);
++>>>>>>> feb7695fe9fb (dm io: fix duplicate bio completion due to missing ref count)
  		dec_count(io, region, -EOPNOTSUPP);
  		return;
  	}
* Unmerged path drivers/md/dm-io.c
