kvm: fix page struct leak in handle_vmon

jira LE-1907
cve CVE-2017-2596
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Paolo Bonzini <pbonzini@redhat.com>
commit 06ce521af9558814b8606c0476c54497cf83a653
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/06ce521a.failed

handle_vmon gets a reference on VMXON region page,
but does not release it. Release the reference.

Found by syzkaller; based on a patch by Dmitry.

	Reported-by: Dmitry Vyukov <dvyukov@google.com>
	Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
(cherry picked from commit 06ce521af9558814b8606c0476c54497cf83a653)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kvm/vmx.c
diff --cc arch/x86/kvm/vmx.c
index b93d99117399,d13073c841ff..000000000000
--- a/arch/x86/kvm/vmx.c
+++ b/arch/x86/kvm/vmx.c
@@@ -6623,14 -6996,18 +6623,23 @@@ static int nested_vmx_check_vmptr(struc
  		}
  
  		page = nested_get_page(vcpu, vmptr);
- 		if (page == NULL ||
- 		    *(u32 *)kmap(page) != VMCS12_REVISION) {
+ 		if (page == NULL) {
  			nested_vmx_failInvalid(vcpu);
+ 			return kvm_skip_emulated_instruction(vcpu);
+ 		}
+ 		if (*(u32 *)kmap(page) != VMCS12_REVISION) {
  			kunmap(page);
++<<<<<<< HEAD
 +			skip_emulated_instruction(vcpu);
 +			return 1;
++=======
+ 			nested_release_page_clean(page);
+ 			nested_vmx_failInvalid(vcpu);
+ 			return kvm_skip_emulated_instruction(vcpu);
++>>>>>>> 06ce521af955 (kvm: fix page struct leak in handle_vmon)
  		}
  		kunmap(page);
+ 		nested_release_page_clean(page);
  		vmx->nested.vmxon_ptr = vmptr;
  		break;
  	case EXIT_REASON_VMCLEAR:
* Unmerged path arch/x86/kvm/vmx.c
