vhost: better detection of available buffers

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
Rebuild_CHGLOG: - [vhost] better detection of available buffers (Wei Xu) [1401433]
Rebuild_FUZZ: 91.36%
commit-author Jason Wang <jasowang@redhat.com>
commit 275bf960ac69744430a6725a4ed7f50d36cf1441
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/275bf960.failed

This patch tries to do several tweaks on vhost_vq_avail_empty() for a
better performance:

- check cached avail index first which could avoid userspace memory access.
- using unlikely() for the failure of userspace access
- check vq->last_avail_idx instead of cached avail index as the last
  step.

This patch is need for batching supports which needs to peek whether
or not there's still available buffers in the ring.

	Reviewed-by: Stefan Hajnoczi <stefanha@redhat.com>
	Signed-off-by: Jason Wang <jasowang@redhat.com>
	Acked-by: Michael S. Tsirkin <mst@redhat.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 275bf960ac69744430a6725a4ed7f50d36cf1441)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/vhost/vhost.c
diff --cc drivers/vhost/vhost.c
index f65052baafd1,9f118388a5b7..000000000000
--- a/drivers/vhost/vhost.c
+++ b/drivers/vhost/vhost.c
@@@ -1649,11 -2241,15 +1649,20 @@@ bool vhost_vq_avail_empty(struct vhost_
  	__virtio16 avail_idx;
  	int r;
  
++<<<<<<< HEAD
 +	r = __get_user(avail_idx, &vq->avail->idx);
 +	if (r)
++=======
+ 	if (vq->avail_idx != vq->last_avail_idx)
++>>>>>>> 275bf960ac69 (vhost: better detection of available buffers)
  		return false;
  
- 	return vhost16_to_cpu(vq, avail_idx) == vq->avail_idx;
+ 	r = vhost_get_user(vq, avail_idx, &vq->avail->idx);
+ 	if (unlikely(r))
+ 		return false;
+ 	vq->avail_idx = vhost16_to_cpu(vq, avail_idx);
+ 
+ 	return vq->avail_idx == vq->last_avail_idx;
  }
  EXPORT_SYMBOL_GPL(vhost_vq_avail_empty);
  
* Unmerged path drivers/vhost/vhost.c
