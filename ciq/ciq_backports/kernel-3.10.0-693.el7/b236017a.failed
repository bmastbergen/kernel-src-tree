ipc: Initialize ipc_namespace->user_ns early.

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
Rebuild_CHGLOG: - [kernel] ipc: Initialize ipc_namespace->user_ns early ("Eric W. Biederman") [1340238]
Rebuild_FUZZ: 98.88%
commit-author Eric W. Biederman <ebiederm@xmission.com>
commit b236017acffa73d52eac9427f42d8993067d20fb
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/b236017a.failed

Allow the ipc namespace initialization code to depend on ns->user_ns
being set during initialization.

In particular this allows mq_init_ns to use ns->user_ns for permission
checks and initializating s_user_ns while the the mq filesystem is
being mounted.

	Acked-by: Seth Forshee <seth.forshee@canonical.com>
	Suggested-by: Seth Forshee <seth.forshee@canonical.com>
	Signed-off-by: "Eric W. Biederman" <ebiederm@xmission.com>
(cherry picked from commit b236017acffa73d52eac9427f42d8993067d20fb)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	ipc/namespace.c
diff --cc ipc/namespace.c
index b54468e48e32,04cb07eb81f1..000000000000
--- a/ipc/namespace.c
+++ b/ipc/namespace.c
@@@ -31,11 -31,15 +31,18 @@@ static struct ipc_namespace *create_ipc
  		kfree(ns);
  		return ERR_PTR(err);
  	}
 -	ns->ns.ops = &ipcns_operations;
  
  	atomic_set(&ns->count, 1);
+ 	ns->user_ns = get_user_ns(user_ns);
+ 
  	err = mq_init_ns(ns);
  	if (err) {
++<<<<<<< HEAD
 +		proc_free_inum(ns->proc_inum);
++=======
+ 		put_user_ns(ns->user_ns);
+ 		ns_free_inum(&ns->ns);
++>>>>>>> b236017acffa (ipc: Initialize ipc_namespace->user_ns early.)
  		kfree(ns);
  		return ERR_PTR(err);
  	}
@@@ -45,16 -49,6 +52,19 @@@
  	msg_init_ns(ns);
  	shm_init_ns(ns);
  
++<<<<<<< HEAD
 +	/*
 +	 * msgmni has already been computed for the new ipc ns.
 +	 * Thus, do the ipcns creation notification before registering that
 +	 * new ipcns in the chain.
 +	 */
 +	ipcns_notify(IPCNS_CREATED);
 +	register_ipcns_notifier(ns);
 +
 +	ns->user_ns = get_user_ns(user_ns);
 +
++=======
++>>>>>>> b236017acffa (ipc: Initialize ipc_namespace->user_ns early.)
  	return ns;
  }
  
* Unmerged path ipc/namespace.c
