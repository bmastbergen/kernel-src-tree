PCI: hv: Specify CPU_AFFINITY_ALL for MSI affinity when >= 32 CPUs

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
Rebuild_CHGLOG: - [pci] hv: Specify CPU_AFFINITY_ALL for MSI affinity when >= 32 CPUs (Vitaly Kuznetsov) [1442282]
Rebuild_FUZZ: 96.06%
commit-author K. Y. Srinivasan <kys@microsoft.com>
commit 433fcf6b7b31f1f233dd50aeb9d066a0f6ed4b9d
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/433fcf6b.failed

When we have 32 or more CPUs in the affinity mask, we should use a special
constant to specify that to the host. Fix this issue.

	Signed-off-by: K. Y. Srinivasan <kys@microsoft.com>
	Signed-off-by: Bjorn Helgaas <bhelgaas@google.com>
	Reviewed-by: Long Li <longli@microsoft.com>
	Cc: <stable@vger.kernel.org>
(cherry picked from commit 433fcf6b7b31f1f233dd50aeb9d066a0f6ed4b9d)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/pci/pci-hyperv.c
diff --cc drivers/pci/pci-hyperv.c
index 38242335bf2b,8c952f694c2f..000000000000
--- a/drivers/pci/pci-hyperv.c
+++ b/drivers/pci/pci-hyperv.c
@@@ -837,9 -898,14 +838,20 @@@ static void hv_compose_msi_msg(struct p
  	 * This bit doesn't have to work on machines with more than 64
  	 * processors because Hyper-V only supports 64 in a guest.
  	 */
++<<<<<<< HEAD:drivers/pci/pci-hyperv.c
 +	for_each_cpu_and(cpu, cfg->domain, cpu_online_mask) {
 +		int_pkt->int_desc.cpu_mask |=
 +			(1ULL << vmbus_cpu_number_to_vp_number(cpu));
++=======
+ 	affinity = irq_data_get_affinity_mask(data);
+ 	if (cpumask_weight(affinity) >= 32) {
+ 		int_pkt->int_desc.cpu_mask = CPU_AFFINITY_ALL;
+ 	} else {
+ 		for_each_cpu_and(cpu, affinity, cpu_online_mask) {
+ 			int_pkt->int_desc.cpu_mask |=
+ 				(1ULL << vmbus_cpu_number_to_vp_number(cpu));
+ 		}
++>>>>>>> 433fcf6b7b31 (PCI: hv: Specify CPU_AFFINITY_ALL for MSI affinity when >= 32 CPUs):drivers/pci/host/pci-hyperv.c
  	}
  
  	ret = vmbus_sendpacket(hpdev->hbus->hdev->channel, int_pkt,
* Unmerged path drivers/pci/pci-hyperv.c
