NTB: Remove dma_sync_wait from ntb_async_rx

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
Rebuild_CHGLOG: - [ntb] Remove dma_sync_wait from ntb_async_rx (Suravee Suthikulpanit) [1303727]
Rebuild_FUZZ: 93.83%
commit-author Allen Hubbe <Allen.Hubbe@emc.com>
commit 905921e74864e80228e7f8cfe75315cd0a8cada8
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/905921e7.failed

The dma_sync_wait can hurt the performance of workloads mixed with both
large and small frames.  Large frames will be copied using the dma
engine.  Small frames will be copied by the cpu.  The dma_sync_wait
prevents the cpu and dma engine copying in parallel.

In the period where the cpu is copying, the dma engine is stopped.  The
dma engine is not doing any useful work to copy large frames during that
time, and the additional time to restart the dma engine for the next
large frame.  This will decrease the throughput for the portion of a
workload with large frames.

In the period where the dma engine is copying, the cpu is held up
waiting for dma to complete.  The small frames processing will be
delayed until the dma is complete.  The RX frames are completed
in-order, and the processing of small frames takes very little time, so
dma_sync_wait may have an insignificant impact on the respose time of
frames.  The more significant impact is to the system, because the delay
in dma_sync_wait is implemented as busy non-blocking wait.  This can
prevent the delayed core from doing any useful work, even if it could be
processing work for other drivers, unrelated to transport RX processing.

After applying the earlier patch to fix out-of-order RX acknoledgement,
the dma_sync_wait is no longer necessary.  Remove it, so that cpu memcpy
will proceed immediately for small frames, in parallel with ongoing dma
for large frames.  Do not hold up the cpu from doing work while dma is
in progress.  The prior fix will continue to ensure in-order completion
of the RX frames to the upper layer, and in-order delivery of the RX
acknoledgement.

	Signed-off-by: Allen Hubbe <Allen.Hubbe@emc.com>
	Signed-off-by: Jon Mason <jdmason@kudzu.us>
(cherry picked from commit 905921e74864e80228e7f8cfe75315cd0a8cada8)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/ntb/ntb_transport.c
diff --cc drivers/ntb/ntb_transport.c
index 0d5e96e60628,f6aae0fbde48..000000000000
--- a/drivers/ntb/ntb_transport.c
+++ b/drivers/ntb/ntb_transport.c
@@@ -1075,15 -1232,15 +1075,20 @@@ static void ntb_async_rx(struct ntb_que
  	if (!chan)
  		goto err;
  
++<<<<<<< HEAD
 +	if (len < copy_bytes) 
 +		goto err_wait;
++=======
+ 	if (len < copy_bytes)
+ 		goto err;
++>>>>>>> 905921e74864 (NTB: Remove dma_sync_wait from ntb_async_rx)
  
  	device = chan->device;
 -	pay_off = (size_t)offset & ~PAGE_MASK;
 -	buff_off = (size_t)buf & ~PAGE_MASK;
 +	pay_off = (size_t) offset & ~PAGE_MASK;
 +	buff_off = (size_t) buf & ~PAGE_MASK;
  
  	if (!is_dma_copy_aligned(device, pay_off, buff_off, len))
- 		goto err_wait;
+ 		goto err;
  
  	unmap = dmaengine_get_unmap_data(device->dev, 2, GFP_NOWAIT);
  	if (!unmap)
* Unmerged path drivers/ntb/ntb_transport.c
