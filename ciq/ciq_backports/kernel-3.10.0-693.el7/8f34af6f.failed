mm, hugetlb: move the error handle logic out of normal code path

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
Rebuild_CHGLOG: - [mm] hugetlb: move the error handle logic out of normal code path (Andrea Arcangeli) [1430172]
Rebuild_FUZZ: 96.77%
commit-author Jianyu Zhan <nasa4836@gmail.com>
commit 8f34af6f93aee88291cec53ae8dff4989e58fbbd
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/8f34af6f.failed

alloc_huge_page() now mixes normal code path with error handle logic.
This patches move out the error handle logic, to make normal code path
more clean and redue code duplicate.

	Signed-off-by: Jianyu Zhan <nasa4836@gmail.com>
	Acked-by: Davidlohr Bueso <davidlohr@hp.com>
	Reviewed-by: Michal Hocko <mhocko@suse.cz>
	Reviewed-by: Aneesh Kumar K.V <aneesh.kumar@linux.vnet.ibm.com>
	Cc: Johannes Weiner <hannes@cmpxchg.org>
	Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
	Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
(cherry picked from commit 8f34af6f93aee88291cec53ae8dff4989e58fbbd)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	mm/hugetlb.c
diff --cc mm/hugetlb.c
index 756884ed9453,244194217e39..000000000000
--- a/mm/hugetlb.c
+++ b/mm/hugetlb.c
@@@ -1532,19 -1393,10 +1530,26 @@@ static struct page *alloc_huge_page(str
  	page = dequeue_huge_page_vma(h, vma, addr, avoid_reserve, chg);
  	if (!page) {
  		spin_unlock(&hugetlb_lock);
++<<<<<<< HEAD
 +		page = __alloc_buddy_huge_page_with_mpol(h, vma, addr);
 +		if (!page) {
 +			hugetlb_cgroup_uncharge_cgroup(idx,
 +						       pages_per_huge_page(h),
 +						       h_cg);
 +			if (chg || avoid_reserve)
 +				hugepage_subpool_put_pages(spool, 1);
 +			return ERR_PTR(-ENOSPC);
 +		}
 +		if (!avoid_reserve && vma_has_reserves(vma, chg)) {
 +			SetPagePrivate(page);
 +			h->resv_huge_pages--;
 +		}
++=======
+ 		page = alloc_buddy_huge_page(h, NUMA_NO_NODE);
+ 		if (!page)
+ 			goto out_uncharge_cgroup;
+ 
++>>>>>>> 8f34af6f93ae (mm, hugetlb: move the error handle logic out of normal code path)
  		spin_lock(&hugetlb_lock);
  		list_move(&page->lru, &h->hugepage_activelist);
  		/* Fall through */
* Unmerged path mm/hugetlb.c
