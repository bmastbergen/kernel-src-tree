dm raid: use read_disk_sb() throughout

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Heinz Mauelshagen <heinzm@redhat.com>
commit e2568465bd55b3ee619d9ebd02cc330feffaae04
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/e2568465.failed

For consistency, call read_disk_sb() from
attempt_restore_of_faulty_devices() instead
of calling sync_page_io() directly.

Explicitly set device to faulty on superblock read error.

	Signed-off-by: Heinz Mauelshagen <heinzm@redhat.com>
	Signed-off-by: Mike Snitzer <snitzer@redhat.com>
(cherry picked from commit e2568465bd55b3ee619d9ebd02cc330feffaae04)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/md/dm-raid.c
diff --cc drivers/md/dm-raid.c
index 47ebd344ee14,c982649497a5..000000000000
--- a/drivers/md/dm-raid.c
+++ b/drivers/md/dm-raid.c
@@@ -1873,10 -1940,12 +1873,16 @@@ static int read_disk_sb(struct md_rdev 
  {
  	BUG_ON(!rdev->sb_page);
  
- 	if (rdev->sb_loaded)
+ 	if (rdev->sb_loaded && !force_reload)
  		return 0;
  
++<<<<<<< HEAD
 +	if (!sync_page_io(rdev, 0, size, rdev->sb_page, READ, true)) {
++=======
+ 	rdev->sb_loaded = 0;
+ 
+ 	if (!sync_page_io(rdev, 0, size, rdev->sb_page, REQ_OP_READ, 0, true)) {
++>>>>>>> e2568465bd55 (dm raid: use read_disk_sb() throughout)
  		DMERR("Failed to read superblock of device at position %d",
  		      rdev->raid_disk);
  		md_error(rdev->mddev, rdev);
@@@ -3432,8 -3546,12 +3438,17 @@@ static void attempt_restore_of_faulty_d
  
  	for (i = 0; i < mddev->raid_disks; i++) {
  		r = &rs->dev[i].rdev;
++<<<<<<< HEAD
 +		if (test_bit(Faulty, &r->flags) && r->sb_page &&
 +		    sync_page_io(r, 0, r->sb_size, r->sb_page, READ, true)) {
++=======
+ 		/* HM FIXME: enhance journal device recovery processing */
+ 		if (test_bit(Journal, &r->flags))
+ 			continue;
+ 
+ 		if (test_bit(Faulty, &r->flags) &&
+ 		    r->meta_bdev && !read_disk_sb(r, r->sb_size, true)) {
++>>>>>>> e2568465bd55 (dm raid: use read_disk_sb() throughout)
  			DMINFO("Faulty %s device #%d has readable super block."
  			       "  Attempting to revive it.",
  			       rs->raid_type->name, i);
* Unmerged path drivers/md/dm-raid.c
