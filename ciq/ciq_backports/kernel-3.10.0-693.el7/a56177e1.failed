cxgb4: Fix number of queue sets corssing the limit

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Ganesh Goudar <ganeshgr@chelsio.com>
commit a56177e18f2e44499a8bf5bc03dbe896dbec657d
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/a56177e1.failed

Do not let number of offload queue sets to go more than
MAX_OFLD_QSETS, which would otherwise crash the driver
on machines with cores more than MAX_OFLD_QSETS.

	Signed-off-by: Ganesh Goudar <ganeshgr@chelsio.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit a56177e18f2e44499a8bf5bc03dbe896dbec657d)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/chelsio/cxgb4/cxgb4_main.c
diff --cc drivers/net/ethernet/chelsio/cxgb4/cxgb4_main.c
index db420692c8e7,57eb4e1345cb..000000000000
--- a/drivers/net/ethernet/chelsio/cxgb4/cxgb4_main.c
+++ b/drivers/net/ethernet/chelsio/cxgb4/cxgb4_main.c
@@@ -4435,26 -4057,11 +4435,34 @@@ static void cfg_queues(struct adapter *
  		 * capped by the number of available cores.
  		 */
  		if (n10g) {
++<<<<<<< HEAD
 +			i = min_t(int, ARRAY_SIZE(s->iscsirxq),
 +				  num_online_cpus());
 +			s->iscsiqsets = roundup(i, adap->params.nports);
 +		} else
 +			s->iscsiqsets = adap->params.nports;
 +		/* For RDMA one Rx queue per channel suffices */
 +		s->rdmaqs = adap->params.nports;
 +		/* Try and allow at least 1 CIQ per cpu rounding down
 +		 * to the number of ports, with a minimum of 1 per port.
 +		 * A 2 port card in a 6 cpu system: 6 CIQs, 3 / port.
 +		 * A 4 port card in a 6 cpu system: 4 CIQs, 1 / port.
 +		 * A 4 port card in a 2 cpu system: 4 CIQs, 1 / port.
 +		 */
 +		s->rdmaciqs = min_t(int, MAX_RDMA_CIQS, num_online_cpus());
 +		s->rdmaciqs = (s->rdmaciqs / adap->params.nports) *
 +				adap->params.nports;
 +		s->rdmaciqs = max_t(int, s->rdmaciqs, adap->params.nports);
 +
 +		if (!is_t4(adap->params.chip))
 +			s->niscsitq = s->iscsiqsets;
++=======
+ 			i = min_t(int, MAX_OFLD_QSETS, num_online_cpus());
+ 			s->ofldqsets = roundup(i, adap->params.nports);
+ 		} else {
+ 			s->ofldqsets = adap->params.nports;
+ 		}
++>>>>>>> a56177e18f2e (cxgb4: Fix number of queue sets corssing the limit)
  	}
  
  	for (i = 0; i < ARRAY_SIZE(s->ethrxq); i++) {
* Unmerged path drivers/net/ethernet/chelsio/cxgb4/cxgb4_main.c
