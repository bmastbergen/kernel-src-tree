ovl: update S_ISGID when setting posix ACLs

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Miklos Szeredi <mszeredi@redhat.com>
commit fd3220d37b1f6f0cab6142d98b0e6c4082e63299
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/fd3220d3.failed

This change fixes xfstest generic/375, which failed to clear the
setgid bit in the following test case on overlayfs:

  touch $testfile
  chown 100:100 $testfile
  chmod 2755 $testfile
  _runas -u 100 -g 101 -- setfacl -m u::rwx,g::rwx,o::rwx $testfile

	Reported-by: Amir Goldstein <amir73il@gmail.com>
	Signed-off-by: Miklos Szeredi <mszeredi@redhat.com>
	Tested-by: Amir Goldstein <amir73il@gmail.com>
Fixes: d837a49bd57f ("ovl: fix POSIX ACL setting")
	Cc: <stable@vger.kernel.org> # v4.8
(cherry picked from commit fd3220d37b1f6f0cab6142d98b0e6c4082e63299)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/overlayfs/super.c
diff --cc fs/overlayfs/super.c
index c3d8b1ec4002,edd46a0e951d..000000000000
--- a/fs/overlayfs/super.c
+++ b/fs/overlayfs/super.c
@@@ -1044,8 -1037,22 +1044,27 @@@ ovl_posix_acl_xattr_set(struct dentry *
  
  	posix_acl_release(acl);
  
++<<<<<<< HEAD
 +	err = ovl_xattr_set(dentry, handler_flags == ACL_TYPE_DEFAULT ? XATTR_NAME_POSIX_ACL_DEFAULT : XATTR_NAME_POSIX_ACL_ACCESS,
 +			     value, size, flags);
++=======
+ 	/*
+ 	 * Check if sgid bit needs to be cleared (actual setacl operation will
+ 	 * be done with mounter's capabilities and so that won't do it for us).
+ 	 */
+ 	if (unlikely(inode->i_mode & S_ISGID) &&
+ 	    handler->flags == ACL_TYPE_ACCESS &&
+ 	    !in_group_p(inode->i_gid) &&
+ 	    !capable_wrt_inode_uidgid(inode, CAP_FSETID)) {
+ 		struct iattr iattr = { .ia_valid = ATTR_KILL_SGID };
+ 
+ 		err = ovl_setattr(dentry, &iattr);
+ 		if (err)
+ 			return err;
+ 	}
+ 
+ 	err = ovl_xattr_set(dentry, handler->name, value, size, flags);
++>>>>>>> fd3220d37b1f (ovl: update S_ISGID when setting posix ACLs)
  	if (!err)
  		ovl_copyattr(ovl_inode_real(inode, NULL), inode);
  
* Unmerged path fs/overlayfs/super.c
