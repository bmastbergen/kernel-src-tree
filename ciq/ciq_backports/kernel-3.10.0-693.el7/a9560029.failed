iwlwifi: mvm: fix accessing fw_id_to_mac_id

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Sara Sharon <sara.sharon@intel.com>
commit a95600294157ca7527ee7c70249fb53e09d8c566
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/a9560029.failed

Access should be by rcu_dereference. Issue was found by sparse.

Fixes: 65e254821cee ("iwlwifi: mvm: use firmware station PM notification for AP_LINK_PS")
	Signed-off-by: Sara Sharon <sara.sharon@intel.com>
	Signed-off-by: Luca Coelho <luciano.coelho@intel.com>
(cherry picked from commit a95600294157ca7527ee7c70249fb53e09d8c566)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/wireless/intel/iwlwifi/mvm/mac80211.c
diff --cc drivers/net/wireless/intel/iwlwifi/mvm/mac80211.c
index 18a8474b5760,486dcceed17a..000000000000
--- a/drivers/net/wireless/intel/iwlwifi/mvm/mac80211.c
+++ b/drivers/net/wireless/intel/iwlwifi/mvm/mac80211.c
@@@ -2331,6 -2381,67 +2331,70 @@@ static void iwl_mvm_mac_sta_notify(stru
  	spin_unlock_bh(&mvmsta->lock);
  }
  
++<<<<<<< HEAD
++=======
+ static void iwl_mvm_mac_sta_notify(struct ieee80211_hw *hw,
+ 				   struct ieee80211_vif *vif,
+ 				   enum sta_notify_cmd cmd,
+ 				   struct ieee80211_sta *sta)
+ {
+ 	__iwl_mvm_mac_sta_notify(hw, cmd, sta);
+ }
+ 
+ void iwl_mvm_sta_pm_notif(struct iwl_mvm *mvm, struct iwl_rx_cmd_buffer *rxb)
+ {
+ 	struct iwl_rx_packet *pkt = rxb_addr(rxb);
+ 	struct iwl_mvm_pm_state_notification *notif = (void *)pkt->data;
+ 	struct ieee80211_sta *sta;
+ 	struct iwl_mvm_sta *mvmsta;
+ 	bool sleeping = (notif->type != IWL_MVM_PM_EVENT_AWAKE);
+ 
+ 	if (WARN_ON(notif->sta_id >= ARRAY_SIZE(mvm->fw_id_to_mac_id)))
+ 		return;
+ 
+ 	rcu_read_lock();
+ 	sta = rcu_dereference(mvm->fw_id_to_mac_id[notif->sta_id]);
+ 	if (WARN_ON(IS_ERR_OR_NULL(sta))) {
+ 		rcu_read_unlock();
+ 		return;
+ 	}
+ 
+ 	mvmsta = iwl_mvm_sta_from_mac80211(sta);
+ 
+ 	if (!mvmsta->vif ||
+ 	    mvmsta->vif->type != NL80211_IFTYPE_AP) {
+ 		rcu_read_unlock();
+ 		return;
+ 	}
+ 
+ 	if (mvmsta->sleeping != sleeping) {
+ 		mvmsta->sleeping = sleeping;
+ 		__iwl_mvm_mac_sta_notify(mvm->hw,
+ 			sleeping ? STA_NOTIFY_SLEEP : STA_NOTIFY_AWAKE,
+ 			sta);
+ 		ieee80211_sta_ps_transition(sta, sleeping);
+ 	}
+ 
+ 	if (sleeping) {
+ 		switch (notif->type) {
+ 		case IWL_MVM_PM_EVENT_AWAKE:
+ 		case IWL_MVM_PM_EVENT_ASLEEP:
+ 			break;
+ 		case IWL_MVM_PM_EVENT_UAPSD:
+ 			ieee80211_sta_uapsd_trigger(sta, IEEE80211_NUM_TIDS);
+ 			break;
+ 		case IWL_MVM_PM_EVENT_PS_POLL:
+ 			ieee80211_sta_pspoll(sta);
+ 			break;
+ 		default:
+ 			break;
+ 		}
+ 	}
+ 
+ 	rcu_read_unlock();
+ }
+ 
++>>>>>>> a95600294157 (iwlwifi: mvm: fix accessing fw_id_to_mac_id)
  static void iwl_mvm_sta_pre_rcu_remove(struct ieee80211_hw *hw,
  				       struct ieee80211_vif *vif,
  				       struct ieee80211_sta *sta)
* Unmerged path drivers/net/wireless/intel/iwlwifi/mvm/mac80211.c
