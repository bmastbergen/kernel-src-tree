mei: bus: fix received data size check in NFC fixup

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Alexander Usyskin <alexander.usyskin@intel.com>
commit 582ab27a063a506ccb55fc48afcc325342a2deba
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/582ab27a.failed

NFC version reply size checked against only header size, not against
full message size. That may lead potentially to uninitialized memory access
in version data.

That leads to warnings when version data is accessed:
drivers/misc/mei/bus-fixup.c: warning: '*((void *)&ver+11)' may be used uninitialized in this function [-Wuninitialized]:  => 212:2

Reported in
Build regressions/improvements in v4.9-rc3
https://lkml.org/lkml/2016/10/30/57

Fixes: 59fcd7c63abf (mei: nfc: Initial nfc implementation)
	Signed-off-by: Alexander Usyskin <alexander.usyskin@intel.com>
	Signed-off-by: Tomas Winkler <tomas.winkler@intel.com>
	Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
(cherry picked from commit 582ab27a063a506ccb55fc48afcc325342a2deba)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/nfc/mei_phy.c
diff --cc drivers/nfc/mei_phy.c
index b2b37bbc784b,6f9563a96488..000000000000
--- a/drivers/nfc/mei_phy.c
+++ b/drivers/nfc/mei_phy.c
@@@ -131,8 -132,8 +131,13 @@@ static int mei_nfc_if_version(struct nf
  	if (!reply)
  		return -ENOMEM;
  
++<<<<<<< HEAD
 +	bytes_recv = mei_cldev_recv(phy->device, (u8 *)reply, if_version_length);
 +	if (bytes_recv < 0 || bytes_recv < sizeof(struct mei_nfc_reply)) {
++=======
+ 	bytes_recv = mei_cldev_recv(phy->cldev, (u8 *)reply, if_version_length);
+ 	if (bytes_recv < 0 || bytes_recv < if_version_length) {
++>>>>>>> 582ab27a063a (mei: bus: fix received data size check in NFC fixup)
  		pr_err("Could not read IF version\n");
  		r = -EIO;
  		goto err;
diff --git a/drivers/misc/mei/bus-fixup.c b/drivers/misc/mei/bus-fixup.c
index b87323f4bb14..1223f4d02d77 100644
--- a/drivers/misc/mei/bus-fixup.c
+++ b/drivers/misc/mei/bus-fixup.c
@@ -178,7 +178,7 @@ static int mei_nfc_if_version(struct mei_cl *cl,
 
 	ret = 0;
 	bytes_recv = __mei_cl_recv(cl, (u8 *)reply, if_version_length);
-	if (bytes_recv < 0 || bytes_recv < sizeof(struct mei_nfc_reply)) {
+	if (bytes_recv < if_version_length) {
 		dev_err(bus->dev, "Could not read IF version\n");
 		ret = -EIO;
 		goto err;
* Unmerged path drivers/nfc/mei_phy.c
