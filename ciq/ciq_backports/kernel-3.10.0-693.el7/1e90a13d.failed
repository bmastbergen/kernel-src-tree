x86/smpboot: Init apic mapping before usage

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
Rebuild_CHGLOG: - [x86] smpboot: Init apic mapping before usage (Prarit Bhargava) [1373738]
Rebuild_FUZZ: 95.12%
commit-author Thomas Gleixner <tglx@linutronix.de>
commit 1e90a13d0c3dc94512af1ccb2b6563e8297838fa
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/1e90a13d.failed

The recent changes, which forced the registration of the boot cpu on UP
systems, which do not have ACPI tables, have been fixed for systems w/o
local APIC, but left a wreckage for systems which have neither ACPI nor
mptables, but the CPU has an APIC, e.g. virtualbox.

The boot process crashes in prefill_possible_map() as it wants to register
the boot cpu, which needs to access the local apic, but the local APIC is
not yet mapped.

There is no reason why init_apic_mapping() can't be invoked before
prefill_possible_map(). So instead of playing another silly early mapping
game, as the ACPI/mptables code does, we just move init_apic_mapping()
before the call to prefill_possible_map().

In hindsight, I should have noticed that combination earlier.

Sorry for the churn (also in stable)!

Fixes: ff8560512b8d ("x86/boot/smp: Don't try to poke disabled/non-existent APIC")
Reported-and-debugged-by: Michal Necasek <michal.necasek@oracle.com>
Reported-and-tested-by: Wolfgang Bauer <wbauer@tmo.at>
	Cc: prarit@redhat.com
	Cc: ville.syrjala@linux.intel.com
	Cc: michael.thayer@oracle.com
	Cc: knut.osmundsen@oracle.com
	Cc: frank.mehnert@oracle.com
	Cc: Borislav Petkov <bp@alien8.de>
	Cc: stable@vger.kernel.org
Link: http://lkml.kernel.org/r/alpine.DEB.2.20.1610282114380.5053@nanos
	Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
(cherry picked from commit 1e90a13d0c3dc94512af1ccb2b6563e8297838fa)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kernel/setup.c
diff --cc arch/x86/kernel/setup.c
index f25e8a66e5ca,9c337b0e8ba7..000000000000
--- a/arch/x86/kernel/setup.c
+++ b/arch/x86/kernel/setup.c
@@@ -1304,16 -1219,19 +1304,26 @@@ void __init setup_arch(char **cmdline_p
  	/*
  	 * get boot-time SMP configuration:
  	 */
 -	get_smp_config();
 +	if (smp_found_config)
 +		get_smp_config();
  
+ 	/*
+ 	 * Systems w/o ACPI and mptables might not have it mapped the local
+ 	 * APIC yet, but prefill_possible_map() might need to access it.
+ 	 */
+ 	init_apic_mappings();
+ 
  	prefill_possible_map();
  
  	init_cpu_to_node();
  
++<<<<<<< HEAD
 +	init_apic_mappings();
 +	if (x86_io_apic_ops.init)
 +		x86_io_apic_ops.init();
++=======
+ 	io_apic_init_mappings();
++>>>>>>> 1e90a13d0c3d (x86/smpboot: Init apic mapping before usage)
  
  	kvm_guest_init();
  
* Unmerged path arch/x86/kernel/setup.c
