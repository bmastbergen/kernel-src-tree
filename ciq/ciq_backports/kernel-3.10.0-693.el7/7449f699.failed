raid1: handle read error also in readonly mode

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Tomasz Majchrzak <tomasz.majchrzak@intel.com>
commit 7449f699b2fb23bdee0a0f03aa4efb5f96fd403f
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/7449f699.failed

If write is the first operation on a disk and it happens not to be
aligned to page size, block layer sends read request first. If read
operation fails, the disk is set as failed as no attempt to fix the
error is made because array is in auto-readonly mode. Similarily, the
disk is set as failed for read-only array.

Take the same approach as in raid10. Don't fail the disk if array is in
readonly or auto-readonly mode. Try to redirect the request first and if
unsuccessful, return a read error.

	Signed-off-by: Tomasz Majchrzak <tomasz.majchrzak@intel.com>
	Signed-off-by: Shaohua Li <shli@fb.com>
(cherry picked from commit 7449f699b2fb23bdee0a0f03aa4efb5f96fd403f)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/md/raid1.c
diff --cc drivers/md/raid1.c
index 61555b115942,29e2df5cd77b..000000000000
--- a/drivers/md/raid1.c
+++ b/drivers/md/raid1.c
@@@ -2350,15 -2323,11 +2356,19 @@@ read_more
  		raid_end_bio_io(r1_bio);
  	} else {
  		const unsigned long do_sync
++<<<<<<< HEAD
 +			= r1_bio->master_bio->bi_rw & REQ_SYNC;
 +		if (bio) {
 +			r1_bio->bios[r1_bio->read_disk] =
 +				mddev->ro ? IO_BLOCKED : NULL;
 +			bio_put(bio);
 +		}
++=======
+ 			= r1_bio->master_bio->bi_opf & REQ_SYNC;
++>>>>>>> 7449f699b2fb (raid1: handle read error also in readonly mode)
  		r1_bio->read_disk = disk;
  		bio = bio_clone_mddev(r1_bio->master_bio, GFP_NOIO, mddev);
 -		bio_trim(bio, r1_bio->sector - bio->bi_iter.bi_sector,
 -			 max_sectors);
 +		bio_trim(bio, r1_bio->sector - bio->bi_sector, max_sectors);
  		r1_bio->bios[r1_bio->read_disk] = bio;
  		rdev = conf->mirrors[disk].rdev;
  		printk_ratelimited(KERN_ERR
* Unmerged path drivers/md/raid1.c
