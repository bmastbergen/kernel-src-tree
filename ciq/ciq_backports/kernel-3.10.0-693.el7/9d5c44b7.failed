libcxgb: export ppm release and tagmask set api

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Varun Prakash <varun@chelsio.com>
commit 9d5c44b7c4f4345341bf96b16fdeb6debc437172
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/9d5c44b7.failed

Export cxgbi_ppm_release() to release
ppod manager and cxgbi_tagmask_set() to
set tag mask, they are used by cxgb3i, cxgb4i
and cxgbit.

	Signed-off-by: Varun Prakash <varun@chelsio.com>
	Reviewed-by: Steve Wise <swise@opengridcomputing.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 9d5c44b7c4f4345341bf96b16fdeb6debc437172)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/chelsio/cxgb4/cxgb4_ppm.c
diff --cc drivers/net/ethernet/chelsio/cxgb4/cxgb4_ppm.c
index d88a7a7b2400,551a365cfb71..000000000000
--- a/drivers/net/ethernet/chelsio/cxgb4/cxgb4_ppm.c
+++ b/drivers/net/ethernet/chelsio/cxgb4/cxgb4_ppm.c
@@@ -462,3 -491,9 +463,12 @@@ unsigned int cxgbi_tagmask_set(unsigne
  
  	return 1 << (bits + PPOD_IDX_SHIFT);
  }
++<<<<<<< HEAD:drivers/net/ethernet/chelsio/cxgb4/cxgb4_ppm.c
++=======
+ EXPORT_SYMBOL(cxgbi_tagmask_set);
+ 
+ MODULE_AUTHOR("Chelsio Communications");
+ MODULE_DESCRIPTION("Chelsio common library");
+ MODULE_VERSION(DRV_VERSION);
+ MODULE_LICENSE("Dual BSD/GPL");
++>>>>>>> 9d5c44b7c4f4 (libcxgb: export ppm release and tagmask set api):drivers/net/ethernet/chelsio/libcxgb/libcxgb_ppm.c
* Unmerged path drivers/net/ethernet/chelsio/cxgb4/cxgb4_ppm.c
diff --git a/drivers/scsi/cxgbi/cxgb3i/cxgb3i.c b/drivers/scsi/cxgbi/cxgb3i/cxgb3i.c
index 80466871664e..8642783e3ab2 100644
--- a/drivers/scsi/cxgbi/cxgb3i/cxgb3i.c
+++ b/drivers/scsi/cxgbi/cxgb3i/cxgb3i.c
@@ -1233,6 +1233,7 @@ static int cxgb3i_ddp_init(struct cxgbi_device *cdev)
 	}
 
 	ppmax = (uinfo.ulimit - uinfo.llimit + 1) >> PPOD_SIZE_SHIFT;
+	tagmask = cxgbi_tagmask_set(ppmax);
 
 	pr_info("T3 %s: 0x%x~0x%x, 0x%x, tagmask 0x%x -> 0x%x.\n",
 		ndev->name, uinfo.llimit, uinfo.ulimit, ppmax, uinfo.tagmask,
diff --git a/drivers/scsi/cxgbi/libcxgbi.c b/drivers/scsi/cxgbi/libcxgbi.c
index 04cacb4ea34c..97ad8e7a8a97 100644
--- a/drivers/scsi/cxgbi/libcxgbi.c
+++ b/drivers/scsi/cxgbi/libcxgbi.c
@@ -113,6 +113,7 @@ static inline void cxgbi_device_destroy(struct cxgbi_device *cdev)
 		"cdev 0x%p, p# %u.\n", cdev, cdev->nports);
 	cxgbi_hbas_remove(cdev);
 	cxgbi_device_portmap_cleanup(cdev);
+	cxgbi_ppm_release(cdev->cdev2ppm(cdev));
 	if (cdev->pmap.max_connect)
 		cxgbi_free_big_mem(cdev->pmap.port_csk);
 	kfree(cdev);
diff --git a/drivers/target/iscsi/cxgbit/cxgbit_main.c b/drivers/target/iscsi/cxgbit/cxgbit_main.c
index 4301a4586f5b..dbd2595bfbe0 100644
--- a/drivers/target/iscsi/cxgbit/cxgbit_main.c
+++ b/drivers/target/iscsi/cxgbit/cxgbit_main.c
@@ -26,6 +26,8 @@ void _cxgbit_free_cdev(struct kref *kref)
 	struct cxgbit_device *cdev;
 
 	cdev = container_of(kref, struct cxgbit_device, kref);
+
+	cxgbi_ppm_release(cdev2ppm(cdev));
 	kfree(cdev);
 }
 
