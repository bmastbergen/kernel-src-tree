IB/srpt: Fix srpt_write_pending()

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Bart Van Assche <bart.vanassche@sandisk.com>
commit fc3af58d3f8b820e3acabb1e1c4f105eb3f283c1
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/fc3af58d.failed

The only allowed return values for the write_pending() callback
function are 0, -EAGAIN and -ENOMEM. Since attempting to perform
RDMA over a disconnecting channel will result in an IB error
completion anyway, remove the code that checks the channel state
from srpt_write_pending().

	Signed-off-by: Bart Van Assche <bart.vanassche@sandisk.com>
	Reviewed-by: Christoph Hellwig <hch@lst.de>
	Reviewed-by: Sagi Grimberg <sagig@mellanox.com>
	Cc: Alex Estrin <alex.estrin@intel.com>
	Signed-off-by: Doug Ledford <dledford@redhat.com>
(cherry picked from commit fc3af58d3f8b820e3acabb1e1c4f105eb3f283c1)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/ulp/srpt/ib_srpt.c
diff --cc drivers/infiniband/ulp/srpt/ib_srpt.c
index 2fcda8eb58d3,12cc695c4455..000000000000
--- a/drivers/infiniband/ulp/srpt/ib_srpt.c
+++ b/drivers/infiniband/ulp/srpt/ib_srpt.c
@@@ -2511,33 -2494,7 +2512,34 @@@ static int srpt_write_pending(struct se
  
  	new_state = srpt_set_cmd_state(ioctx, SRPT_STATE_NEED_DATA);
  	WARN_ON(new_state == SRPT_STATE_DONE);
++<<<<<<< HEAD
 +
 +	ch = ioctx->ch;
 +	BUG_ON(!ch);
 +
 +	switch (ch->state) {
 +	case CH_CONNECTING:
 +		WARN(true, "unexpected channel state %d\n", ch->state);
 +		ret = -EINVAL;
 +		goto out;
 +	case CH_LIVE:
 +		break;
 +	case CH_DISCONNECTING:
 +	case CH_DRAINING:
 +	case CH_RELEASING:
 +		pr_debug("cmd with tag %lld: channel disconnecting\n",
 +			 ioctx->tag);
 +		srpt_set_cmd_state(ioctx, SRPT_STATE_DATA_IN);
 +		ret = -EINVAL;
 +		goto out;
 +	}
 +	ret = srpt_xfer_data(ch, ioctx);
 +
 +out:
 +	return ret;
++=======
+ 	return srpt_xfer_data(ch, ioctx);
++>>>>>>> fc3af58d3f8b (IB/srpt: Fix srpt_write_pending())
  }
  
  static u8 tcm_to_srp_tsk_mgmt_status(const int tcm_mgmt_status)
* Unmerged path drivers/infiniband/ulp/srpt/ib_srpt.c
