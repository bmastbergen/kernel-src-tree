x86/KASLR: Extend kernel image physical address randomization to addresses larger than 4G

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
Rebuild_CHGLOG: - [x86] kaslr: Extend kernel image physical address randomization to addresses larger than 4G (Baoquan He) [1290840]
Rebuild_FUZZ: 97.70%
commit-author Kees Cook <keescook@chromium.org>
commit ed9f007ee68478f6a50ec9971ade25a0129a5c0e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/ed9f007e.failed

We want the physical address to be randomized anywhere between
16MB and the top of physical memory (up to 64TB).

This patch exchanges the prior slots[] array for the new slot_areas[]
array, and lifts the limitation of KERNEL_IMAGE_SIZE on the physical
address offset for 64-bit. As before, process_e820_entry() walks
memory and populates slot_areas[], splitting on any detected mem_avoid
collisions.

Finally, since the slots[] array and its associated functions are not
needed any more, so they are removed.

Based on earlier patches by Baoquan He.

Originally-from: Baoquan He <bhe@redhat.com>
	Signed-off-by: Kees Cook <keescook@chromium.org>
	Cc: Andrew Morton <akpm@linux-foundation.org>
	Cc: Andrey Ryabinin <aryabinin@virtuozzo.com>
	Cc: Andy Lutomirski <luto@kernel.org>
	Cc: Baoquan He <bhe@redhat.com>
	Cc: Borislav Petkov <bp@alien8.de>
	Cc: Brian Gerst <brgerst@gmail.com>
	Cc: Denys Vlasenko <dvlasenk@redhat.com>
	Cc: Dmitry Vyukov <dvyukov@google.com>
	Cc: H. Peter Anvin <hpa@zytor.com>
	Cc: H.J. Lu <hjl.tools@gmail.com>
	Cc: Josh Poimboeuf <jpoimboe@redhat.com>
	Cc: Linus Torvalds <torvalds@linux-foundation.org>
	Cc: Peter Zijlstra <peterz@infradead.org>
	Cc: Thomas Gleixner <tglx@linutronix.de>
	Cc: Yinghai Lu <yinghai@kernel.org>
Link: http://lkml.kernel.org/r/1464216334-17200-5-git-send-email-keescook@chromium.org
	Signed-off-by: Ingo Molnar <mingo@kernel.org>
(cherry picked from commit ed9f007ee68478f6a50ec9971ade25a0129a5c0e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/Kconfig
#	arch/x86/boot/compressed/kaslr.c
diff --cc arch/x86/Kconfig
index 5162fc083bed,770ae5259dff..000000000000
--- a/arch/x86/Kconfig
+++ b/arch/x86/Kconfig
@@@ -1789,12 -1920,51 +1789,55 @@@ config RELOCATABL
  
  	  Note: If CONFIG_RELOCATABLE=y, then the kernel runs from the address
  	  it has been loaded at and the compile time physical address
 -	  (CONFIG_PHYSICAL_START) is used as the minimum location.
 +	  (CONFIG_PHYSICAL_START) is ignored.
  
++<<<<<<< HEAD
 +# Relocation on x86-32 needs some additional build support
++=======
+ config RANDOMIZE_BASE
+ 	bool "Randomize the address of the kernel image (KASLR)"
+ 	depends on RELOCATABLE
+ 	default n
+ 	---help---
+ 	  In support of Kernel Address Space Layout Randomization (KASLR),
+ 	  this randomizes the physical address at which the kernel image
+ 	  is decompressed and the virtual address where the kernel
+ 	  image is mapped, as a security feature that deters exploit
+ 	  attempts relying on knowledge of the location of kernel
+ 	  code internals.
+ 
+ 	  On 64-bit, the kernel physical and virtual addresses are
+ 	  randomized separately. The physical address will be anywhere
+ 	  between 16MB and the top of physical memory (up to 64TB). The
+ 	  virtual address will be randomized from 16MB up to 1GB (9 bits
+ 	  of entropy). Note that this also reduces the memory space
+ 	  available to kernel modules from 1.5GB to 1GB.
+ 
+ 	  On 32-bit, the kernel physical and virtual addresses are
+ 	  randomized together. They will be randomized from 16MB up to
+ 	  512MB (8 bits of entropy).
+ 
+ 	  Entropy is generated using the RDRAND instruction if it is
+ 	  supported. If RDTSC is supported, its value is mixed into
+ 	  the entropy pool as well. If neither RDRAND nor RDTSC are
+ 	  supported, then entropy is read from the i8254 timer. The
+ 	  usable entropy is limited by the kernel being built using
+ 	  2GB addressing, and that PHYSICAL_ALIGN must be at a
+ 	  minimum of 2MB. As a result, only 10 bits of entropy are
+ 	  theoretically possible, but the implementations are further
+ 	  limited due to memory layouts.
+ 
+ 	  If CONFIG_HIBERNATE is also enabled, KASLR is disabled at boot
+ 	  time. To enable it, boot with "kaslr" on the kernel command
+ 	  line (which will also disable hibernation).
+ 
+ 	  If unsure, say N.
+ 
+ # Relocation on x86 needs some additional build support
++>>>>>>> ed9f007ee684 (x86/KASLR: Extend kernel image physical address randomization to addresses larger than 4G)
  config X86_NEED_RELOCS
  	def_bool y
 -	depends on RANDOMIZE_BASE || (X86_32 && RELOCATABLE)
 +	depends on X86_32 && RELOCATABLE
  
  config PHYSICAL_ALIGN
  	hex "Alignment value to which kernel should be aligned"
* Unmerged path arch/x86/boot/compressed/kaslr.c
* Unmerged path arch/x86/Kconfig
* Unmerged path arch/x86/boot/compressed/kaslr.c
