netem: fix a use after free

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
Rebuild_CHGLOG: - [net] sched: netem: fix a use after free (Ivan Vecera) [1382040]
Rebuild_FUZZ: 88.52%
commit-author Eric Dumazet <edumazet@google.com>
commit 21de12ee5568fd1aec47890c72967abf791ac80a
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/21de12ee.failed

If the packet was dropped by lower qdisc, then we must not
access it later.

Save qdisc_pkt_len(skb) in a temp variable.

Fixes: 2ccccf5fb43f ("net_sched: update hierarchical backlog too")
	Signed-off-by: Eric Dumazet <edumazet@google.com>
	Cc: WANG Cong <xiyou.wangcong@gmail.com>
	Cc: Jamal Hadi Salim <jhs@mojatatu.com>
	Cc: Stephen Hemminger <stephen@networkplumber.org>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 21de12ee5568fd1aec47890c72967abf791ac80a)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/sched/sch_netem.c
diff --cc net/sched/sch_netem.c
index 2399444cb1df,178f1630a036..000000000000
--- a/net/sched/sch_netem.c
+++ b/net/sched/sch_netem.c
@@@ -636,13 -650,14 +636,22 @@@ deliver
  #endif
  
  			if (q->qdisc) {
+ 				unsigned int pkt_len = qdisc_pkt_len(skb);
  				int err = qdisc_enqueue(skb, q->qdisc);
  
++<<<<<<< HEAD
 +				if (unlikely(err != NET_XMIT_SUCCESS)) {
 +					if (net_xmit_drop_count(err)) {
 +						qdisc_qstats_drop(sch);
 +						qdisc_tree_decrease_qlen(sch, 1);
 +					}
++=======
+ 				if (err != NET_XMIT_SUCCESS &&
+ 				    net_xmit_drop_count(err)) {
+ 					qdisc_qstats_drop(sch);
+ 					qdisc_tree_reduce_backlog(sch, 1,
+ 								  pkt_len);
++>>>>>>> 21de12ee5568 (netem: fix a use after free)
  				}
  				goto tfifo_dequeue;
  			}
* Unmerged path net/sched/sch_netem.c
