perf build: Add sdt feature detection

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Masami Hiramatsu <mhiramat@kernel.org>
commit e26e63be64a108c1fd12020b93b5b447ffe0532b
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/e26e63be.failed

This checks whether sys/sdt.h is available or not, which is required for
DTRACE_PROBE().

We can disable this feature by passing NO_SDT=1 when building.

This flag will be used for SDT test case and further SDT events in
perftools.

	Signed-off-by: Masami Hiramatsu <mhiramat@kernel.org>
	Cc: Ananth N Mavinakayanahalli <ananth@linux.vnet.ibm.com>
	Cc: Brendan Gregg <brendan.d.gregg@gmail.com>
	Cc: Hemant Kumar <hemant@linux.vnet.ibm.com>
	Cc: Namhyung Kim <namhyung@kernel.org>
	Cc: Peter Zijlstra <peterz@infradead.org>
Link: http://lkml.kernel.org/r/146831795615.17065.17513820540591053933.stgit@devbox
	Signed-off-by: Arnaldo Carvalho de Melo <acme@redhat.com>
(cherry picked from commit e26e63be64a108c1fd12020b93b5b447ffe0532b)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/build/Makefile.feature
#	tools/build/feature/Makefile
#	tools/perf/Makefile.perf
#	tools/perf/tests/make
diff --cc tools/build/Makefile.feature
index ceee323e4d27,a120c6b755a9..000000000000
--- a/tools/build/Makefile.feature
+++ b/tools/build/Makefile.feature
@@@ -61,7 -61,9 +61,13 @@@ FEATURE_TESTS_BASIC :=			
  	libdw-dwarf-unwind		\
  	zlib				\
  	lzma				\
++<<<<<<< HEAD
 +	get_cpuid
++=======
+ 	get_cpuid			\
+ 	bpf				\
+ 	sdt
++>>>>>>> e26e63be64a1 (perf build: Add sdt feature detection)
  
  # FEATURE_TESTS_BASIC + FEATURE_TESTS_EXTRA is the complete list
  # of all feature tests
diff --cc tools/build/feature/Makefile
index 017397a4639a,a0b29a311816..000000000000
--- a/tools/build/feature/Makefile
+++ b/tools/build/feature/Makefile
@@@ -44,7 -44,9 +44,13 @@@ FILES=					
  	test-compile-x32.bin		\
  	test-zlib.bin			\
  	test-lzma.bin			\
++<<<<<<< HEAD
 +	test-get_cpuid.bin
++=======
+ 	test-bpf.bin			\
+ 	test-get_cpuid.bin		\
+ 	test-sdt.bin
++>>>>>>> e26e63be64a1 (perf build: Add sdt feature detection)
  
  FILES := $(addprefix $(OUTPUT),$(FILES))
  
@@@ -209,6 -211,12 +215,15 @@@ $(OUTPUT)test-lzma.bin
  $(OUTPUT)test-get_cpuid.bin:
  	$(BUILD)
  
++<<<<<<< HEAD
++=======
+ $(OUTPUT)test-bpf.bin:
+ 	$(BUILD)
+ 
+ $(OUTPUT)test-sdt.bin:
+ 	$(BUILD)
+ 
++>>>>>>> e26e63be64a1 (perf build: Add sdt feature detection)
  -include $(OUTPUT)*.d
  
  ###############################
diff --cc tools/perf/Makefile.perf
index a7c8b34b274f,a129fbc1ed37..000000000000
--- a/tools/perf/Makefile.perf
+++ b/tools/perf/Makefile.perf
@@@ -79,6 -79,11 +79,14 @@@ include ../scripts/utilities.ma
  #
  # Define NO_AUXTRACE if you do not want AUX area tracing support
  #
++<<<<<<< HEAD
++=======
+ # Define NO_LIBBPF if you do not want BPF support
+ #
+ # Define NO_SDT if you do not want to define SDT event in perf tools,
+ # note that it doesn't disable SDT scanning support.
+ #
++>>>>>>> e26e63be64a1 (perf build: Add sdt feature detection)
  # Define FEATURES_DUMP to provide features detection dump file
  # and bypass the feature detection
  
diff --cc tools/perf/tests/make
index 51a2621f5dee,143f4d549769..000000000000
--- a/tools/perf/tests/make
+++ b/tools/perf/tests/make
@@@ -79,7 -79,10 +79,12 @@@ make_no_libnuma     := NO_LIBNUMA=
  make_no_libaudit    := NO_LIBAUDIT=1
  make_no_libbionic   := NO_LIBBIONIC=1
  make_no_auxtrace    := NO_AUXTRACE=1
 -make_no_libbpf	    := NO_LIBBPF=1
  make_no_libcrypto   := NO_LIBCRYPTO=1
++<<<<<<< HEAD
++=======
+ make_with_babeltrace:= LIBBABELTRACE=1
+ make_no_sdt	    := NO_SDT=1
++>>>>>>> e26e63be64a1 (perf build: Add sdt feature detection)
  make_tags           := tags
  make_cscope         := cscope
  make_help           := help
@@@ -102,8 -105,8 +107,13 @@@ make_static         := LDFLAGS=-stati
  make_minimal        := NO_LIBPERL=1 NO_LIBPYTHON=1 NO_NEWT=1 NO_GTK2=1
  make_minimal        += NO_DEMANGLE=1 NO_LIBELF=1 NO_LIBUNWIND=1 NO_BACKTRACE=1
  make_minimal        += NO_LIBNUMA=1 NO_LIBAUDIT=1 NO_LIBBIONIC=1
++<<<<<<< HEAD
 +make_minimal        += NO_LIBDW_DWARF_UNWIND=1 NO_AUXTRACE=1
 +make_minimal        += NO_LIBCRYPTO=1
++=======
+ make_minimal        += NO_LIBDW_DWARF_UNWIND=1 NO_AUXTRACE=1 NO_LIBBPF=1
+ make_minimal        += NO_LIBCRYPTO=1 NO_SDT=1
++>>>>>>> e26e63be64a1 (perf build: Add sdt feature detection)
  
  # $(run) contains all available tests
  run := make_pure
* Unmerged path tools/build/Makefile.feature
* Unmerged path tools/build/feature/Makefile
diff --git a/tools/build/feature/test-all.c b/tools/build/feature/test-all.c
index d5df8eebc857..c9ed33c22d67 100644
--- a/tools/build/feature/test-all.c
+++ b/tools/build/feature/test-all.c
@@ -145,6 +145,10 @@
 # include "test-libcrypto.c"
 #undef main
 
+#define main main_test_sdt
+# include "test-sdt.c"
+#undef main
+
 int main(int argc, char *argv[])
 {
 	main_test_libpython();
@@ -177,6 +181,7 @@ int main(int argc, char *argv[])
 	main_test_lzma();
 	main_test_get_cpuid();
 	main_test_libcrypto();
+	main_test_sdt();
 
 	return 0;
 }
diff --git a/tools/build/feature/test-sdt.c b/tools/build/feature/test-sdt.c
new file mode 100644
index 000000000000..e4531a6e80ea
--- /dev/null
+++ b/tools/build/feature/test-sdt.c
@@ -0,0 +1,7 @@
+#include <sys/sdt.h>
+
+int main(void)
+{
+	DTRACE_PROBE(provider, name);
+	return 0;
+}
* Unmerged path tools/perf/Makefile.perf
diff --git a/tools/perf/config/Makefile b/tools/perf/config/Makefile
index 494d9b042b4e..021b98f42fae 100644
--- a/tools/perf/config/Makefile
+++ b/tools/perf/config/Makefile
@@ -334,6 +334,16 @@ ifndef NO_LIBELF
   endif # NO_DWARF
 endif # NO_LIBELF
 
+ifndef NO_SDT
+  ifneq ($(feature-sdt), 1)
+    msg := $(warning No sys/sdt.h found, no SDT events are defined, please install systemtap-sdt-devel or systemtap-sdt-dev);
+    NO_SDT := 1;
+  else
+    CFLAGS += -DHAVE_SDT_EVENT
+    $(call detected,CONFIG_SDT_EVENT)
+  endif
+endif
+
 ifdef PERF_HAVE_JITDUMP
   ifndef NO_DWARF
     $(call detected,CONFIG_JITDUMP)
* Unmerged path tools/perf/tests/make
