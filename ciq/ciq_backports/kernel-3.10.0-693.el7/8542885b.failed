s390/dasd: Simplify code in format logic

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
Rebuild_CHGLOG: - [s390] dasd: Simplify code in format logic (Hendrik Brueckner) [1380773]
Rebuild_FUZZ: 93.33%
commit-author Jan Höppner <hoeppner@linux.vnet.ibm.com>
commit 8542885bf5338bfccf779868a5d143620e794ff9
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/8542885b.failed

Currently, dasd_format is calling the format logic of a DASD discipline
with PAV enabled. If that fails with an error code of -EAGAIN the value
of retries is decremented and the discipline function is called with PAV
turned off.

The loop is supposed to try this up to 255 times until success. However,
-EAGAIN can only occur once here and therefore the loop will never reach
the 255 retries.

So, replace the unnecessarily complicated loop logic and simply try again
without PAV enabled in case of an -EAGAIN error.

	Signed-off-by: Jan Höppner <hoeppner@linux.vnet.ibm.com>
	Signed-off-by: Martin Schwidefsky <schwidefsky@de.ibm.com>
(cherry picked from commit 8542885bf5338bfccf779868a5d143620e794ff9)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/s390/block/dasd_ioctl.c
diff --cc drivers/s390/block/dasd_ioctl.c
index 01c4ca98fd2d,16bb5ec4b30b..000000000000
--- a/drivers/s390/block/dasd_ioctl.c
+++ b/drivers/s390/block/dasd_ioctl.c
@@@ -150,9 -203,7 +150,13 @@@ static in
  dasd_format(struct dasd_block *block, struct format_data_t *fdata)
  {
  	struct dasd_device *base;
++<<<<<<< HEAD
 +	int enable_PAV = 1;
 +	int rc, retries;
 +	int start, stop;
++=======
+ 	int rc;
++>>>>>>> 8542885bf533 (s390/dasd: Simplify code in format logic)
  
  	base = block->base;
  	if (base->discipline->format_device == NULL)
@@@ -180,30 -231,11 +184,33 @@@
  		bdput(bdev);
  	}
  
++<<<<<<< HEAD
 +	retries = 255;
 +	/* backup start- and endtrack for retries */
 +	start = fdata->start_unit;
 +	stop = fdata->stop_unit;
 +	do {
 +		rc = base->discipline->format_device(base, fdata, enable_PAV);
 +		if (rc) {
 +			if (rc == -EAGAIN) {
 +				retries--;
 +				/* disable PAV in case of errors */
 +				enable_PAV = 0;
 +				fdata->start_unit = start;
 +				fdata->stop_unit = stop;
 +			} else
 +				return rc;
 +		} else
 +			/* success */
 +			break;
 +	} while (retries);
++=======
+ 	rc = base->discipline->format_device(base, fdata, 1);
+ 	if (rc == -EAGAIN)
+ 		rc = base->discipline->format_device(base, fdata, 0);
++>>>>>>> 8542885bf533 (s390/dasd: Simplify code in format logic)
  
- 	if (!retries)
- 		return -EIO;
- 	else
- 		return 0;
+ 	return rc;
  }
  
  /*
* Unmerged path drivers/s390/block/dasd_ioctl.c
