Drivers: add blist flags

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author K. Y. Srinivasan <kys@microsoft.com>
commit f3cfabce7a2e92564d380de3aad4b43901fb7ae6
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/f3cfabce.failed

Add blist flags to permit the reading of the VPD pages even when
the target may claim SPC-2 compliance. MSFT targets currently
claim SPC-2 compliance while they implement post SPC-2 features.
With this patch we can correctly handle WRITE_SAME_16 issues.

	Signed-off-by: K. Y. Srinivasan <kys@microsoft.com>
	Reviewed-by: Hannes Reinecke <hare@suse.de>
	Signed-off-by: Christoph Hellwig <hch@lst.de>
(cherry picked from commit f3cfabce7a2e92564d380de3aad4b43901fb7ae6)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/storvsc_drv.c
diff --cc drivers/scsi/storvsc_drv.c
index bd6a9090628c,fecac5d03fdd..000000000000
--- a/drivers/scsi/storvsc_drv.c
+++ b/drivers/scsi/storvsc_drv.c
@@@ -396,6 -327,10 +396,13 @@@ MODULE_PARM_DESC(storvsc_vcpus_per_sub_
   */
  static int storvsc_timeout = 180;
  
++<<<<<<< HEAD
++=======
+ static int msft_blist_flags = BLIST_TRY_VPD_PAGES;
+ 
+ #define STORVSC_MAX_IO_REQUESTS				200
+ 
++>>>>>>> f3cfabce7a2e (Drivers: add blist flags)
  static void storvsc_on_channel_callback(void *context);
  
  #define STORVSC_MAX_LUNS_PER_TARGET			255
@@@ -1277,21 -1452,12 +1284,30 @@@ static int storvsc_device_configure(str
  	sdevice->no_write_same = 1;
  
  	/*
++<<<<<<< HEAD
 +	 * If the host is WIN8 or WIN8 R2, claim conformance to SPC-3
 +	 * if the device is a MSFT virtual device.  If the host is
 +	 * WIN10 or newer, allow write_same.
 +	 */
 +	if (!strncmp(sdevice->vendor, "Msft", 4)) {
 +		switch (vmstor_proto_version) {
 +		case VMSTOR_PROTO_VERSION_WIN8:
 +		case VMSTOR_PROTO_VERSION_WIN8_1:
 +			sdevice->scsi_level = SCSI_SPC_3;
 +			break;
 +		}
 +
 +		if (vmstor_proto_version >= VMSTOR_PROTO_VERSION_WIN10)
 +			sdevice->no_write_same = 0;
 +	}
++=======
+ 	 * Add blist flags to permit the reading of the VPD pages even when
+ 	 * the target may claim SPC-2 compliance. MSFT targets currently
+ 	 * claim SPC-2 compliance while they implement post SPC-2 features.
+ 	 * With this patch we can correctly handle WRITE_SAME_16 issues.
+ 	 */
+ 	sdevice->sdev_bflags |= msft_blist_flags;
++>>>>>>> f3cfabce7a2e (Drivers: add blist flags)
  
  	return 0;
  }
* Unmerged path drivers/scsi/storvsc_drv.c
