md: don't fail an array if there are unacknowledged bad blocks

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
Rebuild_CHGLOG: - [md] don't fail an array if there are unacknowledged bad blocks (Jes Sorensen) [1380016]
Rebuild_FUZZ: 96.67%
commit-author Tomasz Majchrzak <tomasz.majchrzak@intel.com>
commit dcbcb48650ecd8de747b2e21e0ee9484b462cb74
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/dcbcb486.failed

If external metadata handler supports bad blocks and unacknowledged bad
blocks are present, don't report disk via sysfs as faulty. Such
situation can be still handled so disk just has to be blocked for a
moment. It makes it consistent with kernel state as corresponding rdev
flag is also not set.

When the disk in being unblocked there are few cases:
1. Disk has been in blocked and faulty state, it is being unblocked but
it still remains in faulty state. Metadata handler will remove it from
array in the next call.
2. There is no bad block support in external metadata handler and bad
blocks are present - put the disk in blocked and faulty state (see
case 1).
3. There is bad block support in external metadata handler and all bad
blocks are acknowledged - clear all flags, continue.
4. There is bad block support in external metadata handler but there are
still unacknowledged bad blocks - clear all flags, continue. It is fine
to clear Blocked flag because it was probably not set anyway (if it was
it is case 1). BlockedBadBlocks flag can also be cleared because the
request waiting for it will set it again when it finds out that some bad
block is still not acknowledged. Recovery is not necessary but there are
no problems if the flag is set. Sysfs rdev state is still reported as
blocked (due to unacknowledged bad blocks) so metadata handler will
process remaining bad blocks and unblock disk again.

	Signed-off-by: Tomasz Majchrzak <tomasz.majchrzak@intel.com>
	Signed-off-by: Shaohua Li <shli@fb.com>
(cherry picked from commit dcbcb48650ecd8de747b2e21e0ee9484b462cb74)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/md/md.c
diff --cc drivers/md/md.c
index 8dcf5aabafe0,7f56d67471f6..000000000000
--- a/drivers/md/md.c
+++ b/drivers/md/md.c
@@@ -2480,46 -2528,34 +2480,58 @@@ state_show(struct md_rdev *rdev, char *
  	unsigned long flags = ACCESS_ONCE(rdev->flags);
  
  	if (test_bit(Faulty, &flags) ||
++<<<<<<< HEAD
 +	    rdev->badblocks.unacked_exist) {
 +		len+= sprintf(page+len, "%sfaulty",sep);
 +		sep = ",";
 +	}
 +	if (test_bit(In_sync, &flags)) {
 +		len += sprintf(page+len, "%sin_sync",sep);
 +		sep = ",";
 +	}
 +	if (test_bit(Journal, &flags)) {
 +		len += sprintf(page+len, "%sjournal",sep);
 +		sep = ",";
 +	}
 +	if (test_bit(WriteMostly, &flags)) {
 +		len += sprintf(page+len, "%swrite_mostly",sep);
 +		sep = ",";
 +	}
++=======
+ 	    (!test_bit(ExternalBbl, &flags) &&
+ 	    rdev->badblocks.unacked_exist))
+ 		len += sprintf(page+len, "faulty%s", sep);
+ 	if (test_bit(In_sync, &flags))
+ 		len += sprintf(page+len, "in_sync%s", sep);
+ 	if (test_bit(Journal, &flags))
+ 		len += sprintf(page+len, "journal%s", sep);
+ 	if (test_bit(WriteMostly, &flags))
+ 		len += sprintf(page+len, "write_mostly%s", sep);
++>>>>>>> dcbcb48650ec (md: don't fail an array if there are unacknowledged bad blocks)
  	if (test_bit(Blocked, &flags) ||
  	    (rdev->badblocks.unacked_exist
 -	     && !test_bit(Faulty, &flags)))
 -		len += sprintf(page+len, "blocked%s", sep);
 +	     && !test_bit(Faulty, &flags))) {
 +		len += sprintf(page+len, "%sblocked", sep);
 +		sep = ",";
 +	}
  	if (!test_bit(Faulty, &flags) &&
  	    !test_bit(Journal, &flags) &&
 -	    !test_bit(In_sync, &flags))
 -		len += sprintf(page+len, "spare%s", sep);
 -	if (test_bit(WriteErrorSeen, &flags))
 -		len += sprintf(page+len, "write_error%s", sep);
 -	if (test_bit(WantReplacement, &flags))
 -		len += sprintf(page+len, "want_replacement%s", sep);
 -	if (test_bit(Replacement, &flags))
 -		len += sprintf(page+len, "replacement%s", sep);
 -	if (test_bit(ExternalBbl, &flags))
 -		len += sprintf(page+len, "external_bbl%s", sep);
 -
 -	if (len)
 -		len -= strlen(sep);
 +	    !test_bit(In_sync, &flags)) {
 +		len += sprintf(page+len, "%sspare", sep);
 +		sep = ",";
 +	}
 +	if (test_bit(WriteErrorSeen, &flags)) {
 +		len += sprintf(page+len, "%swrite_error", sep);
 +		sep = ",";
 +	}
 +	if (test_bit(WantReplacement, &flags)) {
 +		len += sprintf(page+len, "%swant_replacement", sep);
 +		sep = ",";
 +	}
 +	if (test_bit(Replacement, &flags)) {
 +		len += sprintf(page+len, "%sreplacement", sep);
 +		sep = ",";
 +	}
  
  	return len+sprintf(page+len, "\n");
  }
* Unmerged path drivers/md/md.c
