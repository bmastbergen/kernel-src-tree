Btrfs: fix listxattrs not listing all xattrs packed in the same item

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Filipe Manana <fdmanana@suse.com>
commit daac7ba61a0d338c66b70c47d205ba7465718155
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/daac7ba6.failed

In the listxattrs handler, we were not listing all the xattrs that are
packed in the same btree item, which happens when multiple xattrs have
a name that when crc32c hashed produce the same checksum value.

Fix this by processing them all.

The following test case for xfstests reproduces the issue:

  seq=`basename $0`
  seqres=$RESULT_DIR/$seq
  echo "QA output created by $seq"
  tmp=/tmp/$$
  status=1	# failure is the default!
  trap "_cleanup; exit \$status" 0 1 2 3 15

  _cleanup()
  {
      cd /
      rm -f $tmp.*
  }

  # get standard environment, filters and checks
  . ./common/rc
  . ./common/filter
  . ./common/attr

  # real QA test starts here
  _supported_fs generic
  _supported_os Linux
  _require_scratch
  _require_attrs

  rm -f $seqres.full

  _scratch_mkfs >>$seqres.full 2>&1
  _scratch_mount

  # Create our test file with a few xattrs. The first 3 xattrs have a name
  # that when given as input to a crc32c function result in the same checksum.
  # This made btrfs list only one of the xattrs through listxattrs system call
  # (because it packs xattrs with the same name checksum into the same btree
  # item).
  touch $SCRATCH_MNT/testfile
  $SETFATTR_PROG -n user.foobar -v 123 $SCRATCH_MNT/testfile
  $SETFATTR_PROG -n user.WvG1c1Td -v qwerty $SCRATCH_MNT/testfile
  $SETFATTR_PROG -n user.J3__T_Km3dVsW_ -v hello $SCRATCH_MNT/testfile
  $SETFATTR_PROG -n user.something -v pizza $SCRATCH_MNT/testfile
  $SETFATTR_PROG -n user.ping -v pong $SCRATCH_MNT/testfile

  # Now call getfattr with --dump, which calls the listxattrs system call.
  # It should list all the xattrs we have set before.
  $GETFATTR_PROG --absolute-names --dump $SCRATCH_MNT/testfile | _filter_scratch

  status=0
  exit

	Signed-off-by: Filipe Manana <fdmanana@suse.com>
	Signed-off-by: Chris Mason <clm@fb.com>
(cherry picked from commit daac7ba61a0d338c66b70c47d205ba7465718155)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/btrfs/xattr.c
diff --cc fs/btrfs/xattr.c
index 6c456858d2e4,145d2b89e62d..000000000000
--- a/fs/btrfs/xattr.c
+++ b/fs/btrfs/xattr.c
@@@ -259,16 -260,12 +259,17 @@@ out
  
  ssize_t btrfs_listxattr(struct dentry *dentry, char *buffer, size_t size)
  {
++<<<<<<< HEAD
 +	struct btrfs_key key, found_key;
 +	struct inode *inode = dentry->d_inode;
++=======
+ 	struct btrfs_key key;
+ 	struct inode *inode = d_inode(dentry);
++>>>>>>> daac7ba61a0d (Btrfs: fix listxattrs not listing all xattrs packed in the same item)
  	struct btrfs_root *root = BTRFS_I(inode)->root;
  	struct btrfs_path *path;
- 	struct extent_buffer *leaf;
- 	struct btrfs_dir_item *di;
- 	int ret = 0, slot;
+ 	int ret = 0;
  	size_t total_size = 0, size_left = size;
- 	unsigned long name_ptr;
- 	size_t name_len;
  
  	/*
  	 * ok we want all objects associated with this id.
* Unmerged path fs/btrfs/xattr.c
