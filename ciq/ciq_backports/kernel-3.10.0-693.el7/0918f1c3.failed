fsnotify: turn fsnotify reaper thread into a workqueue job

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Jeff Layton <jlayton@poochiereds.net>
commit 0918f1c309b86301605650c836ddd2021d311ae2
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/0918f1c3.failed

We don't require a dedicated thread for fsnotify cleanup.  Switch it
over to a workqueue job instead that runs on the system_unbound_wq.

In the interest of not thrashing the queued job too often when there are
a lot of marks being removed, we delay the reaper job slightly when
queueing it, to allow several to gather on the list.

	Signed-off-by: Jeff Layton <jeff.layton@primarydata.com>
	Tested-by: Eryu Guan <guaneryu@gmail.com>
	Reviewed-by: Jan Kara <jack@suse.cz>
	Cc: Eric Paris <eparis@parisplace.org>
	Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
	Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
(cherry picked from commit 0918f1c309b86301605650c836ddd2021d311ae2)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/notify/mark.c
diff --cc fs/notify/mark.c
index b46c40e4c8a2,7115c5d7d373..000000000000
--- a/fs/notify/mark.c
+++ b/fs/notify/mark.c
@@@ -152,12 -193,8 +156,17 @@@ void fsnotify_destroy_mark_locked(struc
  	spin_lock(&destroy_lock);
  	list_add(&mark->g_list, &destroy_list);
  	spin_unlock(&destroy_lock);
++<<<<<<< HEAD
 +	wake_up(&destroy_waitq);
 +	/*
 +	 * We don't necessarily have a ref on mark from caller so the above destroy
 +	 * may have actually freed it, unless this group provides a 'freeing_mark'
 +	 * function which must be holding a reference.
 +	 */
++=======
+ 	queue_delayed_work(system_unbound_wq, &reaper_work,
+ 				FSNOTIFY_REAPER_DELAY);
++>>>>>>> 0918f1c309b8 (fsnotify: turn fsnotify reaper thread into a workqueue job)
  
  	/*
  	 * Some groups like to know that marks are being freed.  This is a
* Unmerged path fs/notify/mark.c
