dm: free io_barrier after blk_cleanup_queue call

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Tahsin Erdogan <tahsin@google.com>
commit d09960b0032174eb493c4c13be5b9c9ef36dc9a7
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/d09960b0.failed

dm_old_request_fn() has paths that access md->io_barrier.  The party
destroying io_barrier should ensure that no future execution of
dm_old_request_fn() is possible.  Move io_barrier destruction to below
blk_cleanup_queue() to ensure this and avoid a NULL pointer crash during
request-based DM device shutdown.

	Cc: stable@vger.kernel.org # 4.3+
	Signed-off-by: Tahsin Erdogan <tahsin@google.com>
	Signed-off-by: Mike Snitzer <snitzer@redhat.com>
(cherry picked from commit d09960b0032174eb493c4c13be5b9c9ef36dc9a7)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/md/dm.c
diff --cc drivers/md/dm.c
index a500e5a5f71c,ec513ee864f2..000000000000
--- a/drivers/md/dm.c
+++ b/drivers/md/dm.c
@@@ -1559,6 -1412,38 +1559,41 @@@ void dm_init_normal_md_queue(struct map
  	blk_queue_bounce_limit(md->queue, BLK_BOUNCE_ANY);
  }
  
++<<<<<<< HEAD
++=======
+ static void cleanup_mapped_device(struct mapped_device *md)
+ {
+ 	if (md->wq)
+ 		destroy_workqueue(md->wq);
+ 	if (md->kworker_task)
+ 		kthread_stop(md->kworker_task);
+ 	mempool_destroy(md->io_pool);
+ 	mempool_destroy(md->rq_pool);
+ 	if (md->bs)
+ 		bioset_free(md->bs);
+ 
+ 	if (md->disk) {
+ 		spin_lock(&_minor_lock);
+ 		md->disk->private_data = NULL;
+ 		spin_unlock(&_minor_lock);
+ 		del_gendisk(md->disk);
+ 		put_disk(md->disk);
+ 	}
+ 
+ 	if (md->queue)
+ 		blk_cleanup_queue(md->queue);
+ 
+ 	cleanup_srcu_struct(&md->io_barrier);
+ 
+ 	if (md->bdev) {
+ 		bdput(md->bdev);
+ 		md->bdev = NULL;
+ 	}
+ 
+ 	dm_mq_cleanup_mapped_device(md);
+ }
+ 
++>>>>>>> d09960b00321 (dm: free io_barrier after blk_cleanup_queue call)
  /*
   * Allocate and initialise a blank device with a given minor.
   */
* Unmerged path drivers/md/dm.c
