scsi: storvsc: Workaround for virtual DVD SCSI version

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
Rebuild_CHGLOG: - [scsi] storvsc: Workaround for virtual DVD SCSI version (Cathy Avery) [1437552]
Rebuild_FUZZ: 94.12%
commit-author Stephen Hemminger <stephen@networkplumber.org>
commit f1c635b439a5c01776fe3a25b1e2dc546ea82e6f
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/f1c635b4.failed

Hyper-V host emulation of SCSI for virtual DVD device reports SCSI
version 0 (UNKNOWN) but is still capable of supporting REPORTLUN.

Without this patch, a GEN2 Linux guest on Hyper-V will not boot 4.11
successfully with virtual DVD ROM device. What happens is that the SCSI
scan process falls back to doing sequential probing by INQUIRY.  But the
storvsc driver has a previous workaround that masks/blocks all errors
reports from INQUIRY (or MODE_SENSE) commands.  This workaround causes
the scan to then populate a full set of bogus LUN's on the target and
then sends kernel spinning off into a death spiral doing block reads on
the non-existent LUNs.

By setting the correct blacklist flags, the target with the DVD device
is scanned with REPORTLUN and that works correctly.

Patch needs to go in current 4.11, it is safe but not necessary in older
kernels.

	Signed-off-by: Stephen Hemminger <sthemmin@microsoft.com>
	Reviewed-by: K. Y. Srinivasan <kys@microsoft.com>
	Reviewed-by: Christoph Hellwig <hch@lst.de>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit f1c635b439a5c01776fe3a25b1e2dc546ea82e6f)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/storvsc_drv.c
diff --cc drivers/scsi/storvsc_drv.c
index bd6a9090628c,f555174f2cb7..000000000000
--- a/drivers/scsi/storvsc_drv.c
+++ b/drivers/scsi/storvsc_drv.c
@@@ -396,6 -400,10 +396,13 @@@ MODULE_PARM_DESC(storvsc_vcpus_per_sub_
   */
  static int storvsc_timeout = 180;
  
++<<<<<<< HEAD
++=======
+ #if IS_ENABLED(CONFIG_SCSI_FC_ATTRS)
+ static struct scsi_transport_template *fc_transport_template;
+ #endif
+ 
++>>>>>>> f1c635b439a5 (scsi: storvsc: Workaround for virtual DVD SCSI version)
  static void storvsc_on_channel_callback(void *context);
  
  #define STORVSC_MAX_LUNS_PER_TARGET			255
* Unmerged path drivers/scsi/storvsc_drv.c
