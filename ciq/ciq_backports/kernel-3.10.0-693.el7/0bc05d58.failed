switchdev: allow caller to explicitly request attr_set as deferred

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-693.el7
commit-author Jiri Pirko <jiri@mellanox.com>
commit 0bc05d585d381c30de3fdf955730df31593d2101
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-693.el7/0bc05d58.failed

Caller should know if he can call attr_set directly (when holding RTNL)
or if he has to defer the att_set processing for later.

This also allows drivers to sleep inside attr_set and report operation
status back to switchdev core. Switchdev core then warns if status is
not ok, instead of silent errors happening in drivers.

Benefit from newly introduced switchdev deferred ops infrastructure.

	Signed-off-by: Jiri Pirko <jiri@mellanox.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 0bc05d585d381c30de3fdf955730df31593d2101)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	include/net/switchdev.h
#	net/bridge/br_stp.c
#	net/switchdev/switchdev.c
diff --cc net/bridge/br_stp.c
index 48a6519f8bc7,80c34d70218c..000000000000
--- a/net/bridge/br_stp.c
+++ b/net/bridge/br_stp.c
@@@ -38,7 -39,18 +38,22 @@@ void br_log_state(const struct net_brid
  
  void br_set_state(struct net_bridge_port *p, unsigned int state)
  {
++<<<<<<< HEAD
 +	p->state = state;
++=======
+ 	struct switchdev_attr attr = {
+ 		.id = SWITCHDEV_ATTR_ID_PORT_STP_STATE,
+ 		.flags = SWITCHDEV_F_DEFER,
+ 		.u.stp_state = state,
+ 	};
+ 	int err;
+ 
+ 	p->state = state;
+ 	err = switchdev_port_attr_set(p->dev, &attr);
+ 	if (err)
+ 		br_warn(p->br, "error setting offload STP state on port %u(%s)\n",
+ 				(unsigned int) p->port_no, p->dev->name);
++>>>>>>> 0bc05d585d38 (switchdev: allow caller to explicitly request attr_set as deferred)
  }
  
  /* called under bridge lock */
* Unmerged path include/net/switchdev.h
* Unmerged path net/switchdev/switchdev.c
* Unmerged path include/net/switchdev.h
* Unmerged path net/bridge/br_stp.c
* Unmerged path net/switchdev/switchdev.c
