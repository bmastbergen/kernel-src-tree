ALSA: hda - Minor refactoring

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
Rebuild_CHGLOG: - [alsa] hda - Minor refactoring (Jaroslav Kysela) [1197064]
Rebuild_FUZZ: 88.46%
commit-author Takashi Iwai <tiwai@suse.de>
commit 602518a21b4c0673fee2146d46be4eb2464553b2
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/602518a2.failed

Move the small portion of the common sequence in hda_intel.c and
hda_tegra.c into hda_controller.c.

	Signed-off-by: Takashi Iwai <tiwai@suse.de>
(cherry picked from commit 602518a21b4c0673fee2146d46be4eb2464553b2)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	sound/pci/hda/hda_intel.c
#	sound/pci/hda/hda_tegra.c
diff --cc sound/pci/hda/hda_intel.c
index 8224bf75d072,8a1471851ca7..000000000000
--- a/sound/pci/hda/hda_intel.c
+++ b/sound/pci/hda/hda_intel.c
@@@ -1738,9 -1743,6 +1738,12 @@@ static int substream_alloc_pages(struc
  	int ret;
  
  	mark_runtime_wc(chip, azx_dev, substream, false);
++<<<<<<< HEAD
 +	azx_dev->bufsize = 0;
 +	azx_dev->period_bytes = 0;
 +	azx_dev->format_val = 0;
++=======
++>>>>>>> 602518a21b4c (ALSA: hda - Minor refactoring)
  	ret = snd_pcm_lib_malloc_pages(substream, size);
  	if (ret < 0)
  		return ret;
diff --cc sound/pci/hda/hda_tegra.c
index 6c19abff991c,d5349809f43d..000000000000
--- a/sound/pci/hda/hda_tegra.c
+++ b/sound/pci/hda/hda_tegra.c
@@@ -105,9 -104,6 +105,12 @@@ static int substream_alloc_pages(struc
  {
  	struct azx_dev *azx_dev = get_azx_dev(substream);
  
++<<<<<<< HEAD
 +	azx_dev->bufsize = 0;
 +	azx_dev->period_bytes = 0;
 +	azx_dev->format_val = 0;
++=======
++>>>>>>> 602518a21b4c (ALSA: hda - Minor refactoring)
  	return snd_pcm_lib_malloc_pages(substream, size);
  }
  
diff --git a/sound/pci/hda/hda_controller.c b/sound/pci/hda/hda_controller.c
index 0d7233e1e418..7df762994f50 100644
--- a/sound/pci/hda/hda_controller.c
+++ b/sound/pci/hda/hda_controller.c
@@ -423,18 +423,22 @@ static int azx_pcm_hw_params(struct snd_pcm_substream *substream,
 {
 	struct azx_pcm *apcm = snd_pcm_substream_chip(substream);
 	struct azx *chip = apcm->chip;
+	struct azx_dev *azx_dev = get_azx_dev(substream);
 	int ret;
 
-	dsp_lock(get_azx_dev(substream));
-	if (dsp_is_locked(get_azx_dev(substream))) {
+	dsp_lock(azx_dev);
+	if (dsp_is_locked(azx_dev)) {
 		ret = -EBUSY;
 		goto unlock;
 	}
 
+	azx_dev->core.bufsize = 0;
+	azx_dev->core.period_bytes = 0;
+	azx_dev->core.format_val = 0;
 	ret = chip->ops->substream_alloc_pages(chip, substream,
 					  params_buffer_bytes(hw_params));
 unlock:
-	dsp_unlock(get_azx_dev(substream));
+	dsp_unlock(azx_dev);
 	return ret;
 }
 
* Unmerged path sound/pci/hda/hda_intel.c
* Unmerged path sound/pci/hda/hda_tegra.c
