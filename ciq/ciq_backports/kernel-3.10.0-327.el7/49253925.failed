s390/vdso: fix clock_gettime for CLOCK_THREAD_CPUTIME_ID, -2 and -3

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
Rebuild_CHGLOG: - [s390] vdso: fix clock_gettime for CLOCK_THREAD_CPUTIME_ID, -2 and -3 (Hendrik Brueckner) [1195671]
Rebuild_FUZZ: 96.12%
commit-author Martin Schwidefsky <schwidefsky@de.ibm.com>
commit 49253925c0be02ed4eb7d94a426731107dd8059d
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/49253925.failed

Git commit 8d8f2e18a6dbd3d09dd918788422e6ac8c878e96
"s390/vdso: ectg gettime support for CLOCK_THREAD_CPUTIME_ID"
broke clock_gettime for CLOCK_THREAD_CPUTIME_ID.

Git commit c742b31c03f37c5c499178f09f57381aa6c70131
"fast vdso implementation for CLOCK_THREAD_CPUTIME_ID"
introduced the ECTG for clock id -2. Correct would have been
clock id -3.

Fix the whole mess, CLOCK_THREAD_CPUTIME_ID is based on
CPUCLOCK_SCHED and can not be speed up by the vdso. A speedup
is only available for clock id -3 which is CPUCLOCK_VIRT for
the task currently running on the CPU.

	Signed-off-by: Martin Schwidefsky <schwidefsky@de.ibm.com>
(cherry picked from commit 49253925c0be02ed4eb7d94a426731107dd8059d)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/s390/kernel/vdso64/clock_gettime.S
diff --cc arch/s390/kernel/vdso64/clock_gettime.S
index 91940ed33a4a,61541fb93dc6..000000000000
--- a/arch/s390/kernel/vdso64/clock_gettime.S
+++ b/arch/s390/kernel/vdso64/clock_gettime.S
@@@ -19,13 -19,16 +19,18 @@@
  	.type  __kernel_clock_gettime,@function
  __kernel_clock_gettime:
  	.cfi_startproc
 -	aghi	%r15,-16
  	larl	%r5,_vdso_data
 -	cghi	%r2,__CLOCK_REALTIME_COARSE
 -	je	4f
  	cghi	%r2,__CLOCK_REALTIME
++<<<<<<< HEAD
 +	je	4f
 +	cghi	%r2,__CLOCK_THREAD_CPUTIME_ID
 +	je	9f
 +	cghi	%r2,-2		/* Per-thread CPUCLOCK with PID=0, VIRT=1 */
++=======
+ 	je	5f
+ 	cghi	%r2,-3		/* Per-thread CPUCLOCK with PID=0, VIRT=1 */
++>>>>>>> 49253925c0be (s390/vdso: fix clock_gettime for CLOCK_THREAD_CPUTIME_ID, -2 and -3)
  	je	9f
 -	cghi	%r2,__CLOCK_MONOTONIC_COARSE
 -	je	3f
  	cghi	%r2,__CLOCK_MONOTONIC
  	jne	12f
  
@@@ -80,10 -100,11 +85,10 @@@
  	j	6b
  7:	stg	%r0,0(%r3)			/* store tp->tv_sec */
  	stg	%r1,8(%r3)			/* store tp->tv_nsec */
 -	lghi	%r2,0
 -	aghi	%r15,16
 +8:	lghi	%r2,0
  	br	%r14
  
- 	/* CLOCK_THREAD_CPUTIME_ID for this thread */
+ 	/* CPUCLOCK_VIRT for this thread */
  9:	icm	%r0,15,__VDSO_ECTG_OK(%r5)
  	jz	12f
  	ear	%r2,%a4
* Unmerged path arch/s390/kernel/vdso64/clock_gettime.S
