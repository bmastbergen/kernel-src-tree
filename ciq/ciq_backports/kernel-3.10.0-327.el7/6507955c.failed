powerpc/powernv: Fallback to old HMI handling behavior for old firmware

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
Rebuild_CHGLOG: - [powerpc] powernv: Fallback to old HMI handling behavior for old firmware (Gustavo Duarte) [1221091]
Rebuild_FUZZ: 94.03%
commit-author Mahesh Salgaonkar <mahesh@linux.vnet.ibm.com>
commit 6507955c9781a75f1b085f0cf0a77b9df06f0197
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/6507955c.failed

Recently we moved HMI handling into Linux kernel instead of taking
HMI directly in OPAL. This new change is dependent on new OPAL call
for HMI recovery which was introduced in newer firmware. While this new
change works fine with latest OPAL firmware, we broke the HMI handling
if we run newer kernel on old OPAL firmware that results in system hang.

This patch fixes this issue by falling back to old HMI behavior on older
OPAL firmware.

This patch introduces a check for opal token OPAL_HANDLE_HMI to see
if we are running on newer firmware or old firmware. On newer firmware
this check would return OPAL_TOKEN_PRESENT, otherwise we are running on
old firmware and fallback to old HMI behavior.

Old firmware: POWER8 System Firmware Release as of today <= SV810_087
Action: Let OPAL handle HMIs

Newer firmware: in development/yet to be released.
Action: Let Linux host handle HMIs.

This patch depends on opal check token patch posted at ppc-devel
https://lists.ozlabs.org/pipermail/linuxppc-dev/2014-August/120224.html

	Signed-off-by: Mahesh Salgaonkar <mahesh@linux.vnet.ibm.com>
[mpe: Minor comment and printk rewording]
	Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
(cherry picked from commit 6507955c9781a75f1b085f0cf0a77b9df06f0197)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/powerpc/platforms/powernv/opal.c
diff --cc arch/powerpc/platforms/powernv/opal.c
index 2542700371c7,34d96615db6c..000000000000
--- a/arch/powerpc/platforms/powernv/opal.c
+++ b/arch/powerpc/platforms/powernv/opal.c
@@@ -194,9 -194,27 +194,33 @@@ static int __init opal_register_excepti
  	 * fwnmi area at 0x7000 to provide the glue space to OPAL
  	 */
  	glue = 0x7000;
++<<<<<<< HEAD
 +	opal_register_exception_handler(OPAL_HYPERVISOR_MAINTENANCE_HANDLER,
 +					0, glue);
 +	glue += 128;
++=======
+ 
+ 	/*
+ 	 * Check if we are running on newer firmware that exports
+ 	 * OPAL_HANDLE_HMI token. If yes, then don't ask OPAL to patch
+ 	 * the HMI interrupt and we catch it directly in Linux.
+ 	 *
+ 	 * For older firmware (i.e currently released POWER8 System Firmware
+ 	 * as of today <= SV810_087), we fallback to old behavior and let OPAL
+ 	 * patch the HMI vector and handle it inside OPAL firmware.
+ 	 *
+ 	 * For newer firmware (in development/yet to be released) we will
+ 	 * start catching/handling HMI directly in Linux.
+ 	 */
+ 	if (!opal_check_token(OPAL_HANDLE_HMI)) {
+ 		pr_info("opal: Old firmware detected, OPAL handles HMIs.\n");
+ 		opal_register_exception_handler(
+ 				OPAL_HYPERVISOR_MAINTENANCE_HANDLER,
+ 				0, glue);
+ 		glue += 128;
+ 	}
+ 
++>>>>>>> 6507955c9781 (powerpc/powernv: Fallback to old HMI handling behavior for old firmware)
  	opal_register_exception_handler(OPAL_SOFTPATCH_HANDLER, 0, glue);
  #endif
  
* Unmerged path arch/powerpc/platforms/powernv/opal.c
