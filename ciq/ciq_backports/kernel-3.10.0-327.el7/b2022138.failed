ALSA: pcm: Don't ignore internal PCMs in snd_pcm_dev_disconnect()

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
Rebuild_CHGLOG: - [alsa] pcm: Don't ignore internal PCMs in snd_pcm_dev_disconnect() (Jaroslav Kysela) [1197064]
Rebuild_FUZZ: 95.16%
commit-author Takashi Iwai <tiwai@suse.de>
commit b20221385c40155f13068be75b865170a1ad5d1e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/b2022138.failed

Some codes in snd_pcm_dev_disconnect() are still valid even for
internal PCMs, but they are skipped because of the check of
list_empty(&pcm->list) at the beginning.  Remove this check and put
pcm->internal checks appropriately for internal PCM object to process
through this function.

	Acked-by: Liam Girdwood <liam.r.girdwood@linux.intel.com>
	Signed-off-by: Takashi Iwai <tiwai@suse.de>
(cherry picked from commit b20221385c40155f13068be75b865170a1ad5d1e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	sound/core/pcm.c
diff --cc sound/core/pcm.c
index 70f328e816f5,e9b87465c73d..000000000000
--- a/sound/core/pcm.c
+++ b/sound/core/pcm.c
@@@ -1131,12 -1121,9 +1131,9 @@@ static int snd_pcm_dev_disconnect(struc
  	struct snd_pcm *pcm = device->device_data;
  	struct snd_pcm_notify *notify;
  	struct snd_pcm_substream *substream;
 -	int cidx;
 +	int cidx, devtype;
  
  	mutex_lock(&register_mutex);
- 	if (list_empty(&pcm->list))
- 		goto unlock;
- 
  	mutex_lock(&pcm->open_mutex);
  	wake_up(&pcm->open_wait);
  	list_del_init(&pcm->list);
@@@ -1156,16 -1143,8 +1153,21 @@@
  			notify->n_disconnect(pcm);
  	}
  	for (cidx = 0; cidx < 2; cidx++) {
++<<<<<<< HEAD
 +		devtype = -1;
 +		switch (cidx) {
 +		case SNDRV_PCM_STREAM_PLAYBACK:
 +			devtype = SNDRV_DEVICE_TYPE_PCM_PLAYBACK;
 +			break;
 +		case SNDRV_PCM_STREAM_CAPTURE:
 +			devtype = SNDRV_DEVICE_TYPE_PCM_CAPTURE;
 +			break;
 +		}
 +		snd_unregister_device(devtype, pcm->card, pcm->device);
++=======
+ 		if (!pcm->internal)
+ 			snd_unregister_device(&pcm->streams[cidx].dev);
++>>>>>>> b20221385c40 (ALSA: pcm: Don't ignore internal PCMs in snd_pcm_dev_disconnect())
  		if (pcm->streams[cidx].chmap_kctl) {
  			snd_ctl_remove(pcm->card, pcm->streams[cidx].chmap_kctl);
  			pcm->streams[cidx].chmap_kctl = NULL;
* Unmerged path sound/core/pcm.c
