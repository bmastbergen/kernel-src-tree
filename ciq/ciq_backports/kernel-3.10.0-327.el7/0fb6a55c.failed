ixgbe: fix crash on rmmod after probe fail

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
commit-author Emil Tantilov <emil.s.tantilov@intel.com>
commit 0fb6a55cc31ff216ef86332404ad3e425cb669eb
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/0fb6a55c.failed

The driver has logic to free up used data in case any of the checks in
ixgbe_probe() fail, however there is a similar set of cleanups that can
occur on driver unload in ixgbe_remove() which can cause the rmmod command
to crash.

This patch aims to fix the logic by moving pci_set_drvdata() after all error
checks and then adds a check in ixgbe_remove() to skip it altogether if
adapter comes up empty.

	Signed-off-by: Emil Tantilov <emil.s.tantilov@intel.com>
	Signed-off-by: Jeff Kirsher <jeffrey.t.kirsher@intel.com>
(cherry picked from commit 0fb6a55cc31ff216ef86332404ad3e425cb669eb)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/intel/ixgbe/ixgbe_main.c
diff --cc drivers/net/ethernet/intel/ixgbe/ixgbe_main.c
index beae21a8db4c,82d418729dd4..000000000000
--- a/drivers/net/ethernet/intel/ixgbe/ixgbe_main.c
+++ b/drivers/net/ethernet/intel/ixgbe/ixgbe_main.c
@@@ -7981,8 -8566,14 +7982,18 @@@ err_dma
  static void ixgbe_remove(struct pci_dev *pdev)
  {
  	struct ixgbe_adapter *adapter = pci_get_drvdata(pdev);
++<<<<<<< HEAD
 +	struct net_device *netdev = adapter->netdev;
++=======
+ 	struct net_device *netdev;
+ 	bool disable_dev;
++>>>>>>> 0fb6a55cc31f (ixgbe: fix crash on rmmod after probe fail)
+ 
+ 	/* if !adapter then we already cleaned up in probe */
+ 	if (!adapter)
+ 		return;
  
+ 	netdev  = adapter->netdev;
  	ixgbe_dbg_adapter_exit(adapter);
  
  	set_bit(__IXGBE_REMOVING, &adapter->state);
* Unmerged path drivers/net/ethernet/intel/ixgbe/ixgbe_main.c
