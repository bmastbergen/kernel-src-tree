ALSA: line6: Let snd_card_new() allocate private data

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
Rebuild_CHGLOG: - [alsa] line6: Let snd_card_new() allocate private data (Jaroslav Kysela) [1197064]
Rebuild_FUZZ: 94.00%
commit-author Takashi Iwai <tiwai@suse.de>
commit aca514b82356dcc3575da33453382bd27593aea1
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/aca514b8.failed

Instead of allocating the private data individually in each driver's
probe at first, let snd_card_new() allocate the data that is called in
line6_probe().  This simplifies the primary probe functions.

	Tested-by: Chris Rorvick <chris@rorvick.com>
	Signed-off-by: Takashi Iwai <tiwai@suse.de>
(cherry picked from commit aca514b82356dcc3575da33453382bd27593aea1)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/staging/line6/driver.h
#	drivers/staging/line6/pod.c
#	drivers/staging/line6/toneport.c
#	drivers/staging/line6/variax.c
#	sound/usb/line6/driver.c
#	sound/usb/line6/podhd.c
diff --cc drivers/staging/line6/driver.h
index 4fd9dad58be7,fce10f12f0d3..000000000000
--- a/drivers/staging/line6/driver.h
+++ b/drivers/staging/line6/driver.h
@@@ -211,4 -179,17 +211,20 @@@ extern int line6_version_request_async(
  extern int line6_write_data(struct usb_line6 *line6, int address, void *data,
  			    size_t datalen);
  
++<<<<<<< HEAD:drivers/staging/line6/driver.h
++=======
+ int line6_probe(struct usb_interface *interface,
+ 		const struct usb_device_id *id,
+ 		const struct line6_properties *properties,
+ 		int (*private_init)(struct usb_line6 *, const struct usb_device_id *id),
+ 		size_t data_size);
+ 
+ void line6_disconnect(struct usb_interface *interface);
+ 
+ #ifdef CONFIG_PM
+ int line6_suspend(struct usb_interface *interface, pm_message_t message);
+ int line6_resume(struct usb_interface *interface);
+ #endif
+ 
++>>>>>>> aca514b82356 (ALSA: line6: Let snd_card_new() allocate private data):sound/usb/line6/driver.h
  #endif
diff --cc drivers/staging/line6/pod.c
index 711d2c74641b,6f7cd585f2d8..000000000000
--- a/drivers/staging/line6/pod.c
+++ b/drivers/staging/line6/pod.c
@@@ -407,44 -484,131 +407,50 @@@ static int pod_try_init(struct usb_inte
  	return 0;
  }
  
 -#define LINE6_DEVICE(prod) USB_DEVICE(0x0e41, prod)
 -#define LINE6_IF_NUM(prod, n) USB_DEVICE_INTERFACE_NUMBER(0x0e41, prod, n)
 -
 -/* table of devices that work with this driver */
 -static const struct usb_device_id pod_id_table[] = {
 -	{ LINE6_DEVICE(0x4250),    .driver_info = LINE6_BASSPODXT },
 -	{ LINE6_DEVICE(0x4642),    .driver_info = LINE6_BASSPODXTLIVE },
 -	{ LINE6_DEVICE(0x4252),    .driver_info = LINE6_BASSPODXTPRO },
 -	{ LINE6_IF_NUM(0x5051, 1), .driver_info = LINE6_POCKETPOD },
 -	{ LINE6_DEVICE(0x5044),    .driver_info = LINE6_PODXT },
 -	{ LINE6_IF_NUM(0x4650, 0), .driver_info = LINE6_PODXTLIVE_POD },
 -	{ LINE6_DEVICE(0x5050),    .driver_info = LINE6_PODXTPRO },
 -	{}
 -};
 +/*
 +	 Init POD device (and clean up in case of failure).
 +*/
 +int line6_pod_init(struct usb_interface *interface, struct usb_line6_pod *pod)
 +{
 +	int err = pod_try_init(interface, pod);
  
 -MODULE_DEVICE_TABLE(usb, pod_id_table);
 -
 -static const struct line6_properties pod_properties_table[] = {
 -	[LINE6_BASSPODXT] = {
 -		.id = "BassPODxt",
 -		.name = "BassPODxt",
 -		.capabilities	= LINE6_CAP_CONTROL
 -				| LINE6_CAP_PCM
 -				| LINE6_CAP_HWMON,
 -		.altsetting = 5,
 -		.ep_ctrl_r = 0x84,
 -		.ep_ctrl_w = 0x03,
 -		.ep_audio_r = 0x82,
 -		.ep_audio_w = 0x01,
 -	},
 -	[LINE6_BASSPODXTLIVE] = {
 -		.id = "BassPODxtLive",
 -		.name = "BassPODxt Live",
 -		.capabilities	= LINE6_CAP_CONTROL
 -				| LINE6_CAP_PCM
 -				| LINE6_CAP_HWMON,
 -		.altsetting = 1,
 -		.ep_ctrl_r = 0x84,
 -		.ep_ctrl_w = 0x03,
 -		.ep_audio_r = 0x82,
 -		.ep_audio_w = 0x01,
 -	},
 -	[LINE6_BASSPODXTPRO] = {
 -		.id = "BassPODxtPro",
 -		.name = "BassPODxt Pro",
 -		.capabilities	= LINE6_CAP_CONTROL
 -				| LINE6_CAP_PCM
 -				| LINE6_CAP_HWMON,
 -		.altsetting = 5,
 -		.ep_ctrl_r = 0x84,
 -		.ep_ctrl_w = 0x03,
 -		.ep_audio_r = 0x82,
 -		.ep_audio_w = 0x01,
 -	},
 -	[LINE6_POCKETPOD] = {
 -		.id = "PocketPOD",
 -		.name = "Pocket POD",
 -		.capabilities	= LINE6_CAP_CONTROL,
 -		.altsetting = 0,
 -		.ep_ctrl_r = 0x82,
 -		.ep_ctrl_w = 0x02,
 -		/* no audio channel */
 -	},
 -	[LINE6_PODXT] = {
 -		.id = "PODxt",
 -		.name = "PODxt",
 -		.capabilities	= LINE6_CAP_CONTROL
 -				| LINE6_CAP_PCM
 -				| LINE6_CAP_HWMON,
 -		.altsetting = 5,
 -		.ep_ctrl_r = 0x84,
 -		.ep_ctrl_w = 0x03,
 -		.ep_audio_r = 0x82,
 -		.ep_audio_w = 0x01,
 -	},
 -	[LINE6_PODXTLIVE_POD] = {
 -		.id = "PODxtLive",
 -		.name = "PODxt Live",
 -		.capabilities	= LINE6_CAP_CONTROL
 -				| LINE6_CAP_PCM
 -				| LINE6_CAP_HWMON,
 -		.altsetting = 1,
 -		.ep_ctrl_r = 0x84,
 -		.ep_ctrl_w = 0x03,
 -		.ep_audio_r = 0x82,
 -		.ep_audio_w = 0x01,
 -	},
 -	[LINE6_PODXTPRO] = {
 -		.id = "PODxtPro",
 -		.name = "PODxt Pro",
 -		.capabilities	= LINE6_CAP_CONTROL
 -				| LINE6_CAP_PCM
 -				| LINE6_CAP_HWMON,
 -		.altsetting = 5,
 -		.ep_ctrl_r = 0x84,
 -		.ep_ctrl_w = 0x03,
 -		.ep_audio_r = 0x82,
 -		.ep_audio_w = 0x01,
 -	},
 -};
 +	if (err < 0)
 +		pod_destruct(interface);
 +
 +	return err;
 +}
  
  /*
 -	Probe USB device.
 +	POD device disconnected.
  */
 -static int pod_probe(struct usb_interface *interface,
 -		     const struct usb_device_id *id)
 +void line6_pod_disconnect(struct usb_interface *interface)
  {
++<<<<<<< HEAD:drivers/staging/line6/pod.c
 +	struct usb_line6_pod *pod;
 +
 +	if (interface == NULL)
 +		return;
 +	pod = usb_get_intfdata(interface);
 +
 +	if (pod != NULL) {
 +		struct snd_line6_pcm *line6pcm = pod->line6.line6pcm;
 +		struct device *dev = &interface->dev;
 +
 +		if (line6pcm != NULL)
 +			line6_pcm_disconnect(line6pcm);
 +
 +		if (dev != NULL) {
 +			/* remove sysfs entries: */
 +			device_remove_file(dev, &dev_attr_device_id);
 +			device_remove_file(dev, &dev_attr_firmware_version);
 +			device_remove_file(dev, &dev_attr_serial_number);
 +		}
 +	}
 +
 +	pod_destruct(interface);
++=======
+ 	return line6_probe(interface, id,
+ 			   &pod_properties_table[id->driver_info],
+ 			   pod_init, sizeof(struct usb_line6_pod));
++>>>>>>> aca514b82356 (ALSA: line6: Let snd_card_new() allocate private data):sound/usb/line6/pod.c
  }
 -
 -static struct usb_driver pod_driver = {
 -	.name = KBUILD_MODNAME,
 -	.probe = pod_probe,
 -	.disconnect = line6_disconnect,
 -#ifdef CONFIG_PM
 -	.suspend = line6_suspend,
 -	.resume = line6_resume,
 -	.reset_resume = line6_resume,
 -#endif
 -	.id_table = pod_id_table,
 -};
 -
 -module_usb_driver(pod_driver);
 -
 -MODULE_DESCRIPTION("Line 6 POD USB driver");
 -MODULE_LICENSE("GPL");
diff --cc drivers/staging/line6/toneport.c
index 4f8fc09cde1e,33d16ecf18a0..000000000000
--- a/drivers/staging/line6/toneport.c
+++ b/drivers/staging/line6/toneport.c
@@@ -381,61 -454,128 +381,67 @@@ static int toneport_try_init(struct usb
  
  	toneport_setup(toneport);
  
 -	/* register audio system: */
 -	return snd_card_register(line6->card);
 +	setup_timer(&toneport->timer, toneport_start_pcm,
 +		    (unsigned long)toneport);
 +	mod_timer(&toneport->timer, jiffies + TONEPORT_PCM_DELAY * HZ);
 +
 +	return 0;
  }
  
 -#ifdef CONFIG_PM
  /*
 -	Resume Toneport device after reset.
 +	 Init Toneport device (and clean up in case of failure).
  */
 -static int toneport_reset_resume(struct usb_interface *interface)
 +int line6_toneport_init(struct usb_interface *interface,
 +			struct usb_line6_toneport *toneport)
  {
 -	toneport_setup(usb_get_intfdata(interface));
 -	return line6_resume(interface);
 +	int err = toneport_try_init(interface, toneport);
 +
 +	if (err < 0)
 +		toneport_destruct(interface);
 +
 +	return err;
  }
 -#endif
 -
 -#define LINE6_DEVICE(prod) USB_DEVICE(0x0e41, prod)
 -#define LINE6_IF_NUM(prod, n) USB_DEVICE_INTERFACE_NUMBER(0x0e41, prod, n)
 -
 -/* table of devices that work with this driver */
 -static const struct usb_device_id toneport_id_table[] = {
 -	{ LINE6_DEVICE(0x4750),    .driver_info = LINE6_GUITARPORT },
 -	{ LINE6_DEVICE(0x4153),    .driver_info = LINE6_PODSTUDIO_GX },
 -	{ LINE6_DEVICE(0x4150),    .driver_info = LINE6_PODSTUDIO_UX1 },
 -	{ LINE6_IF_NUM(0x4151, 0), .driver_info = LINE6_PODSTUDIO_UX2 },
 -	{ LINE6_DEVICE(0x4147),    .driver_info = LINE6_TONEPORT_GX },
 -	{ LINE6_DEVICE(0x4141),    .driver_info = LINE6_TONEPORT_UX1 },
 -	{ LINE6_IF_NUM(0x4142, 0), .driver_info = LINE6_TONEPORT_UX2 },
 -	{}
 -};
  
 -MODULE_DEVICE_TABLE(usb, toneport_id_table);
 -
 -static const struct line6_properties toneport_properties_table[] = {
 -	[LINE6_GUITARPORT] = {
 -		.id = "GuitarPort",
 -		.name = "GuitarPort",
 -		.capabilities	= LINE6_CAP_PCM,
 -		.altsetting = 2,  /* 1..4 seem to be ok */
 -		/* no control channel */
 -		.ep_audio_r = 0x82,
 -		.ep_audio_w = 0x01,
 -	},
 -	[LINE6_PODSTUDIO_GX] = {
 -		.id = "PODStudioGX",
 -		.name = "POD Studio GX",
 -		.capabilities	= LINE6_CAP_PCM,
 -		.altsetting = 2,  /* 1..4 seem to be ok */
 -		/* no control channel */
 -		.ep_audio_r = 0x82,
 -		.ep_audio_w = 0x01,
 -	},
 -	[LINE6_PODSTUDIO_UX1] = {
 -		.id = "PODStudioUX1",
 -		.name = "POD Studio UX1",
 -		.capabilities	= LINE6_CAP_PCM,
 -		.altsetting = 2,  /* 1..4 seem to be ok */
 -		/* no control channel */
 -		.ep_audio_r = 0x82,
 -		.ep_audio_w = 0x01,
 -	},
 -	[LINE6_PODSTUDIO_UX2] = {
 -		.id = "PODStudioUX2",
 -		.name = "POD Studio UX2",
 -		.capabilities	= LINE6_CAP_PCM,
 -		.altsetting = 2,  /* defaults to 44.1kHz, 16-bit */
 -		/* no control channel */
 -		.ep_audio_r = 0x82,
 -		.ep_audio_w = 0x01,
 -	},
 -	[LINE6_TONEPORT_GX] = {
 -		.id = "TonePortGX",
 -		.name = "TonePort GX",
 -		.capabilities	= LINE6_CAP_PCM,
 -		.altsetting = 2,  /* 1..4 seem to be ok */
 -		/* no control channel */
 -		.ep_audio_r = 0x82,
 -		.ep_audio_w = 0x01,
 -	},
 -	[LINE6_TONEPORT_UX1] = {
 -		.id = "TonePortUX1",
 -		.name = "TonePort UX1",
 -		.capabilities	= LINE6_CAP_PCM,
 -		.altsetting = 2,  /* 1..4 seem to be ok */
 -		/* no control channel */
 -		.ep_audio_r = 0x82,
 -		.ep_audio_w = 0x01,
 -	},
 -	[LINE6_TONEPORT_UX2] = {
 -		.id = "TonePortUX2",
 -		.name = "TonePort UX2",
 -		.capabilities	= LINE6_CAP_PCM,
 -		.altsetting = 2,  /* defaults to 44.1kHz, 16-bit */
 -		/* no control channel */
 -		.ep_audio_r = 0x82,
 -		.ep_audio_w = 0x01,
 -	},
 -};
 +/*
 +	Resume Toneport device after reset.
 +*/
 +void line6_toneport_reset_resume(struct usb_line6_toneport *toneport)
 +{
 +	toneport_setup(toneport);
 +}
  
  /*
 -	Probe USB device.
 +	Toneport device disconnected.
  */
 -static int toneport_probe(struct usb_interface *interface,
 -			  const struct usb_device_id *id)
 +void line6_toneport_disconnect(struct usb_interface *interface)
  {
++<<<<<<< HEAD:drivers/staging/line6/toneport.c
 +	struct usb_line6_toneport *toneport;
 +
 +	if (interface == NULL)
 +		return;
 +
 +	toneport = usb_get_intfdata(interface);
 +	del_timer_sync(&toneport->timer);
 +
 +	if (toneport_has_led(toneport->line6.usbdev->descriptor.idProduct)) {
 +		device_remove_file(&interface->dev, &dev_attr_led_red);
 +		device_remove_file(&interface->dev, &dev_attr_led_green);
 +	}
 +
 +	if (toneport != NULL) {
 +		struct snd_line6_pcm *line6pcm = toneport->line6.line6pcm;
 +
 +		if (line6pcm != NULL) {
 +			line6_pcm_release(line6pcm, LINE6_BITS_PCM_MONITOR);
 +			line6_pcm_disconnect(line6pcm);
 +		}
 +	}
 +
 +	toneport_destruct(interface);
++=======
+ 	return line6_probe(interface, id,
+ 			   &toneport_properties_table[id->driver_info],
+ 			   toneport_init, sizeof(struct usb_line6_toneport));
++>>>>>>> aca514b82356 (ALSA: line6: Let snd_card_new() allocate private data):sound/usb/line6/toneport.c
  }
 -
 -static struct usb_driver toneport_driver = {
 -	.name = KBUILD_MODNAME,
 -	.probe = toneport_probe,
 -	.disconnect = line6_disconnect,
 -#ifdef CONFIG_PM
 -	.suspend = line6_suspend,
 -	.resume = line6_resume,
 -	.reset_resume = toneport_reset_resume,
 -#endif
 -	.id_table = toneport_id_table,
 -};
 -
 -module_usb_driver(toneport_driver);
 -
 -MODULE_DESCRIPTION("TonePort USB driver");
 -MODULE_LICENSE("GPL");
diff --cc drivers/staging/line6/variax.c
index bd0f694fa8d8,9701ffa61365..000000000000
--- a/drivers/staging/line6/variax.c
+++ b/drivers/staging/line6/variax.c
@@@ -207,27 -254,66 +207,33 @@@ static int variax_try_init(struct usb_i
  	return 0;
  }
  
 -#define LINE6_DEVICE(prod) USB_DEVICE(0x0e41, prod)
 -#define LINE6_IF_NUM(prod, n) USB_DEVICE_INTERFACE_NUMBER(0x0e41, prod, n)
 -
 -/* table of devices that work with this driver */
 -static const struct usb_device_id variax_id_table[] = {
 -	{ LINE6_IF_NUM(0x4650, 1), .driver_info = LINE6_PODXTLIVE_VARIAX },
 -	{ LINE6_DEVICE(0x534d),    .driver_info = LINE6_VARIAX },
 -	{}
 -};
 -
 -MODULE_DEVICE_TABLE(usb, variax_id_table);
 -
 -static const struct line6_properties variax_properties_table[] = {
 -	[LINE6_PODXTLIVE_VARIAX] = {
 -		.id = "PODxtLive",
 -		.name = "PODxt Live",
 -		.capabilities	= LINE6_CAP_CONTROL
 -				| LINE6_CAP_PCM
 -				| LINE6_CAP_HWMON,
 -		.altsetting = 1,
 -		.ep_ctrl_r = 0x86,
 -		.ep_ctrl_w = 0x05,
 -		.ep_audio_r = 0x82,
 -		.ep_audio_w = 0x01,
 -	},
 -	[LINE6_VARIAX] = {
 -		.id = "Variax",
 -		.name = "Variax Workbench",
 -		.capabilities	= LINE6_CAP_CONTROL,
 -		.altsetting = 1,
 -		.ep_ctrl_r = 0x82,
 -		.ep_ctrl_w = 0x01,
 -		/* no audio channel */
 -	}
 -};
 -
  /*
 -	Probe USB device.
 +	 Init workbench device (and clean up in case of failure).
  */
 -static int variax_probe(struct usb_interface *interface,
 -			const struct usb_device_id *id)
 +int line6_variax_init(struct usb_interface *interface,
 +		      struct usb_line6_variax *variax)
  {
++<<<<<<< HEAD:drivers/staging/line6/variax.c
 +	int err = variax_try_init(interface, variax);
 +
 +	if (err < 0)
 +		variax_destruct(interface);
 +
 +	return err;
++=======
+ 	return line6_probe(interface, id,
+ 			   &variax_properties_table[id->driver_info],
+ 			   variax_init, sizeof(struct usb_line6_variax));
++>>>>>>> aca514b82356 (ALSA: line6: Let snd_card_new() allocate private data):sound/usb/line6/variax.c
  }
  
 -static struct usb_driver variax_driver = {
 -	.name = KBUILD_MODNAME,
 -	.probe = variax_probe,
 -	.disconnect = line6_disconnect,
 -#ifdef CONFIG_PM
 -	.suspend = line6_suspend,
 -	.resume = line6_resume,
 -	.reset_resume = line6_resume,
 -#endif
 -	.id_table = variax_id_table,
 -};
 -
 -module_usb_driver(variax_driver);
 +/*
 +	Workbench device disconnected.
 +*/
 +void line6_variax_disconnect(struct usb_interface *interface)
 +{
 +	if (interface == NULL)
 +		return;
  
 -MODULE_DESCRIPTION("Vairax Workbench USB driver");
 -MODULE_LICENSE("GPL");
 +	variax_destruct(interface);
 +}
* Unmerged path sound/usb/line6/driver.c
* Unmerged path sound/usb/line6/podhd.c
* Unmerged path drivers/staging/line6/driver.h
* Unmerged path drivers/staging/line6/pod.c
* Unmerged path drivers/staging/line6/toneport.c
* Unmerged path drivers/staging/line6/variax.c
* Unmerged path sound/usb/line6/driver.c
* Unmerged path sound/usb/line6/podhd.c
