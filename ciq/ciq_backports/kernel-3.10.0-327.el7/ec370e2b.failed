IB/iser: Unbind at conn_stop stage

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
Rebuild_CHGLOG: - [infiniband] iser: Unbind at conn_stop stage (Amir Vadai) [1164539]
Rebuild_FUZZ: 95.38%
commit-author Ariel Nahum <arieln@mellanox.com>
commit ec370e2b63526931a65f4668626dbb43896788c6
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/ec370e2b.failed

Previously we didn't need to unbind the iser_conn and iscsi_conn since
we always relied on iscsi daemon to teardown the connection and never
let it finish before we cleanup all that is needed in iser.  This is
not the case anymore (for DEVICE_REMOVAL event).  So avoid any possible
chance we cause iscsi_conn dereference after iscsi_conn was freed.

We also call iser_conn_terminate (safe to call multiple times) just
for the corner case of iscsi daemon stopping an old connection before
invoking endpoint removal (might happen if it was violently killed).

Notice we are unbinding under a lock - which is required.

	Signed-off-by: Ariel Nahum <arieln@mellanox.com>
	Signed-off-by: Sagi Grimberg <sagig@mellanox.com>
	Signed-off-by: Roi Dayan <roid@mellanox.com>
	Signed-off-by: Or Gerlitz <ogerlitz@mellanox.com>
	Signed-off-by: Roland Dreier <roland@purestorage.com>
(cherry picked from commit ec370e2b63526931a65f4668626dbb43896788c6)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/ulp/iser/iscsi_iser.c
diff --cc drivers/infiniband/ulp/iser/iscsi_iser.c
index 93ce62fe1594,7298e696c6cf..000000000000
--- a/drivers/infiniband/ulp/iser/iscsi_iser.c
+++ b/drivers/infiniband/ulp/iser/iscsi_iser.c
@@@ -413,9 -413,16 +413,22 @@@ iscsi_iser_conn_stop(struct iscsi_cls_c
  	 * Userspace may have goofed up and not bound the connection or
  	 * might have only partially setup the connection.
  	 */
++<<<<<<< HEAD
 +	if (ib_conn) {
 +		conn->dd_data = NULL;
 +		complete(&ib_conn->stop_completion);
++=======
+ 	if (iser_conn) {
+ 		mutex_lock(&iser_conn->state_mutex);
+ 		iser_conn_terminate(iser_conn);
+ 
+ 		/* unbind */
+ 		iser_conn->iscsi_conn = NULL;
+ 		conn->dd_data = NULL;
+ 
+ 		complete(&iser_conn->stop_completion);
+ 		mutex_unlock(&iser_conn->state_mutex);
++>>>>>>> ec370e2b6352 (IB/iser: Unbind at conn_stop stage)
  	}
  }
  
* Unmerged path drivers/infiniband/ulp/iser/iscsi_iser.c
