net/mlx4_core: Disable Granular QoS per VF under IB/Eth VPI configuration

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
Rebuild_CHGLOG: - [netdrv] mlx4_core: Disable Granular QoS per VF under IB/Eth VPI configuration (Amir Vadai) [1164527 1164530 1164531 1164536 1164537]
Rebuild_FUZZ: 97.18%
commit-author Or Gerlitz <ogerlitz@mellanox.com>
commit ac0a72a3e6e8d817f60ce4d9a8f3b43dc256d847
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/ac0a72a3.failed

Due to firmware bug, under VPI configuration when port1 = IB and
port2 = Eth, Granular QoS per VF isn't working properly. More over,
the whole QP0/QP1 Para-Virtualization in the mlx4 IB driver is
broken on that config.

Hence, we must disable Granular QoS per VF under that configuration
till a fix is introduced. Once that happens, a new device capability
will be used to mark the feature support on that specific configuration.

	Reported-by: Doug Ledford <dledford@redhat.com>
	Signed-off-by: Or Gerlitz <ogerlitz@mellanox.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit ac0a72a3e6e8d817f60ce4d9a8f3b43dc256d847)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlx4/main.c
diff --cc drivers/net/ethernet/mellanox/mlx4/main.c
index 3392a2db1658,68b5a5563af7..000000000000
--- a/drivers/net/ethernet/mellanox/mlx4/main.c
+++ b/drivers/net/ethernet/mellanox/mlx4/main.c
@@@ -429,7 -479,15 +429,19 @@@ static int mlx4_dev_cap(struct mlx4_de
  		}
  	}
  
++<<<<<<< HEAD
 +	dev->caps.max_counters = dev_cap->max_counters;
++=======
+ 	if (mlx4_is_master(dev) && (dev->caps.num_ports == 2) &&
+ 	    (port_type_array[0] == MLX4_PORT_TYPE_IB) &&
+ 	    (port_type_array[1] == MLX4_PORT_TYPE_ETH)) {
+ 		mlx4_warn(dev,
+ 			  "Granular QoS per VF not supported with IB/Eth configuration\n");
+ 		dev->caps.flags2 &= ~MLX4_DEV_CAP_FLAG2_QOS_VPP;
+ 	}
+ 
+ 	dev->caps.max_counters = 1 << ilog2(dev_cap->max_counters);
++>>>>>>> ac0a72a3e6e8 (net/mlx4_core: Disable Granular QoS per VF under IB/Eth VPI configuration)
  
  	dev->caps.reserved_qps_cnt[MLX4_QP_REGION_FW] = dev_cap->reserved_qps;
  	dev->caps.reserved_qps_cnt[MLX4_QP_REGION_ETH_ADDR] =
* Unmerged path drivers/net/ethernet/mellanox/mlx4/main.c
