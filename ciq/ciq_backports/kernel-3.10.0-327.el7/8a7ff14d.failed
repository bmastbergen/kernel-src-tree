IB/mlx4: Do not attemp to report HCA clock offset on VFs

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
Rebuild_CHGLOG: - [infiniband] mlx4: Do not attemp to report HCA clock offset on VFs (Amir Vadai) [1238185]
Rebuild_FUZZ: 97.25%
commit-author Matan Barak <matanb@mellanox.com>
commit 8a7ff14dcb40bade309cd2ad04c746bb1d169c4e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/8a7ff14d.failed

mlx4 VFs can provide CQE raw time-stamping services, but they
don't have the hca core clock mapped to their PCI bars.

As such, we should not attempt to query and report the clock offset
to user space for VFs. Doing so causes query_device over VFs to fail
with -ENOSUPP.

Fixes: 4b664c4355b2 ('IB/mlx4: Add support for CQ time-stamping')
	Signed-off-by: Matan Barak <matanb@mellanox.com>
	Signed-off-by: Or Gerlitz <ogerlitz@mellanox.com>
	Signed-off-by: Doug Ledford <dledford@redhat.com>
(cherry picked from commit 8a7ff14dcb40bade309cd2ad04c746bb1d169c4e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/hw/mlx4/main.c
diff --cc drivers/infiniband/hw/mlx4/main.c
index 7be9683a71c1,f419a728a22b..000000000000
--- a/drivers/infiniband/hw/mlx4/main.c
+++ b/drivers/infiniband/hw/mlx4/main.c
@@@ -229,7 -250,25 +229,26 @@@ static int mlx4_ib_query_device(struct 
  	props->max_total_mcast_qp_attach = props->max_mcast_qp_attach *
  					   props->max_mcast_grp;
  	props->max_map_per_fmr = dev->dev->caps.max_fmr_maps;
 -	props->hca_core_clock = dev->dev->caps.hca_core_clock * 1000UL;
 -	props->timestamp_mask = 0xFFFFFFFFFFFFULL;
  
++<<<<<<< HEAD
++=======
+ 	if (!mlx4_is_slave(dev->dev))
+ 		err = mlx4_get_internal_clock_params(dev->dev, &clock_params);
+ 
+ 	if (uhw->outlen >= resp.response_length + sizeof(resp.hca_core_clock_offset)) {
+ 		resp.response_length += sizeof(resp.hca_core_clock_offset);
+ 		if (!err && !mlx4_is_slave(dev->dev)) {
+ 			resp.comp_mask |= QUERY_DEVICE_RESP_MASK_TIMESTAMP;
+ 			resp.hca_core_clock_offset = clock_params.offset % PAGE_SIZE;
+ 		}
+ 	}
+ 
+ 	if (uhw->outlen) {
+ 		err = ib_copy_to_udata(uhw, &resp, resp.response_length);
+ 		if (err)
+ 			goto out;
+ 	}
++>>>>>>> 8a7ff14dcb40 (IB/mlx4: Do not attemp to report HCA clock offset on VFs)
  out:
  	kfree(in_mad);
  	kfree(out_mad);
* Unmerged path drivers/infiniband/hw/mlx4/main.c
