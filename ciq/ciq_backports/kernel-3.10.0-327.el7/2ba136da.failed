fix regression in SCSI_IOCTL_SEND_COMMAND

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
commit-author Tony Battersby <tonyb@cybernetics.com>
commit 2ba136daa3ae1e881c9f586f283fcaa164767dce
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/2ba136da.failed

blk_rq_set_block_pc() memsets rq->cmd to 0, so it should come
immediately after blk_get_request() to avoid overwriting the
user-supplied CDB.  Also check for failure to allocate rq.

Fixes: f27b087b81b7 ("block: add blk_rq_set_block_pc()")
	Cc: <stable@vger.kernel.org> # 3.16.x
	Signed-off-by: Tony Battersby <tonyb@cybernetics.com>
	Signed-off-by: Jens Axboe <axboe@fb.com>
(cherry picked from commit 2ba136daa3ae1e881c9f586f283fcaa164767dce)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	block/scsi_ioctl.c
diff --cc block/scsi_ioctl.c
index 4ba25dadd137,5dd477bfb4bc..000000000000
--- a/block/scsi_ioctl.c
+++ b/block/scsi_ioctl.c
@@@ -466,9 -457,10 +466,16 @@@ int sg_scsi_ioctl(struct request_queue 
  
  	rq = blk_get_request(q, in_len ? WRITE : READ, __GFP_WAIT);
  	if (!rq) {
++<<<<<<< HEAD
 +		err = -ENODEV;
 +		goto error_free_buffer;
 +	}
++=======
+ 		err = -ENOMEM;
+ 		goto error;
+ 	}
+ 	blk_rq_set_block_pc(rq);
++>>>>>>> 2ba136daa3ae (fix regression in SCSI_IOCTL_SEND_COMMAND)
  
  	cmdlen = COMMAND_SIZE(opcode);
  
@@@ -540,9 -532,9 +546,15 @@@
  	}
  	
  error:
++<<<<<<< HEAD
 +	blk_put_request(rq);
 +error_free_buffer:
 +	kfree(buffer);
++=======
+ 	kfree(buffer);
+ 	if (rq)
+ 		blk_put_request(rq);
++>>>>>>> 2ba136daa3ae (fix regression in SCSI_IOCTL_SEND_COMMAND)
  	return err;
  }
  EXPORT_SYMBOL_GPL(sg_scsi_ioctl);
* Unmerged path block/scsi_ioctl.c
