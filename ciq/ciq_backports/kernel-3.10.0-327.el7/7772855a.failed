sg: fix EWOULDBLOCK errors with scsi-mq

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
commit-author Tony Battersby <tonyb@cybernetics.com>
commit 7772855a996ec6e16944b120ab5ce21050279821
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/7772855a.failed

With scsi-mq enabled, userspace programs can get unexpected EWOULDBLOCK
(a.k.a. EAGAIN) errors when submitting commands to the SCSI generic
driver.  Fix by calling blk_get_request() with GFP_KERNEL instead of
GFP_ATOMIC.

Note: to avoid introducing a potential deadlock, this patch should be
applied after the patch titled "sg: fix unkillable I/O wait deadlock
with scsi-mq".

	Cc: <stable@vger.kernel.org> # 3.17+
	Signed-off-by: Tony Battersby <tonyb@cybernetics.com>
	Acked-by: Douglas Gilbert <dgilbert@interlog.com>
	Tested-by: Douglas Gilbert <dgilbert@interlog.com>
	Signed-off-by: James Bottomley <JBottomley@Parallels.com>
(cherry picked from commit 7772855a996ec6e16944b120ab5ce21050279821)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/sg.c
diff --cc drivers/scsi/sg.c
index 61b2fae940eb,5cb2a5e80b2b..000000000000
--- a/drivers/scsi/sg.c
+++ b/drivers/scsi/sg.c
@@@ -1712,10 -1680,25 +1712,30 @@@ sg_start_req(Sg_request *srp, unsigned 
  			return -ENOMEM;
  	}
  
++<<<<<<< HEAD
 +	rq = blk_get_request(q, rw, GFP_ATOMIC);
 +	if (!rq) {
++=======
+ 	/*
+ 	 * NOTE
+ 	 *
+ 	 * With scsi-mq enabled, there are a fixed number of preallocated
+ 	 * requests equal in number to shost->can_queue.  If all of the
+ 	 * preallocated requests are already in use, then using GFP_ATOMIC with
+ 	 * blk_get_request() will return -EWOULDBLOCK, whereas using GFP_KERNEL
+ 	 * will cause blk_get_request() to sleep until an active command
+ 	 * completes, freeing up a request.  Neither option is ideal, but
+ 	 * GFP_KERNEL is the better choice to prevent userspace from getting an
+ 	 * unexpected EWOULDBLOCK.
+ 	 *
+ 	 * With scsi-mq disabled, blk_get_request() with GFP_KERNEL usually
+ 	 * does not sleep except under memory pressure.
+ 	 */
+ 	rq = blk_get_request(q, rw, GFP_KERNEL);
+ 	if (IS_ERR(rq)) {
++>>>>>>> 7772855a996e (sg: fix EWOULDBLOCK errors with scsi-mq)
  		kfree(long_cmdp);
 -		return PTR_ERR(rq);
 +		return -ENOMEM;
  	}
  
  	blk_rq_set_block_pc(rq);
* Unmerged path drivers/scsi/sg.c
