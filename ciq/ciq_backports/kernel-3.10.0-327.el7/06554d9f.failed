KVM: PPC: Book3S HV: Exit on H_DOORBELL if HOST_IPI is set

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
Rebuild_CHGLOG: - [powerpc] kvm: book3s-hv: Exit on H_DOORBELL if HOST_IPI is set (David Gibson) [1259571]
Rebuild_FUZZ: 93.69%
commit-author Gautham R. Shenoy <ego@linux.vnet.ibm.com>
commit 06554d9f6cc8f0b5ec903db19726a15dfc7b09d6
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/06554d9f.failed

The code that handles the case when we receive a H_DOORBELL interrupt
has a comment which says "Hypervisor doorbell - exit only if host IPI
flag set".  However, the current code does not actually check if the
host IPI flag is set.  This is due to a comparison instruction that
got missed.

As a result, the current code performs the exit to host only
if some sibling thread or a sibling sub-core is exiting to the
host.  This implies that, an IPI sent to a sibling core in
(subcores-per-core != 1) mode will be missed by the host unless the
sibling core is on the exit path to the host.

This patch adds the missing comparison operation which will ensure
that when HOST_IPI flag is set, we unconditionally exit to the host.

Fixes: 66feed61cdf6
	Cc: stable@vger.kernel.org # v4.1+
	Signed-off-by: Gautham R. Shenoy <ego@linux.vnet.ibm.com>
	Reviewed-by: David Gibson <david@gibson.dropbear.id.au>
	Signed-off-by: Paul Mackerras <paulus@samba.org>
(cherry picked from commit 06554d9f6cc8f0b5ec903db19726a15dfc7b09d6)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/powerpc/kvm/book3s_hv_rmhandlers.S
diff --cc arch/powerpc/kvm/book3s_hv_rmhandlers.S
index 2d0869ef1418,2273dcacef39..000000000000
--- a/arch/powerpc/kvm/book3s_hv_rmhandlers.S
+++ b/arch/powerpc/kvm/book3s_hv_rmhandlers.S
@@@ -1149,14 -1209,17 +1149,25 @@@ END_FTR_SECTION_IFSET(CPU_FTR_ARCH_206
  	cmpwi	r12,BOOK3S_INTERRUPT_SYSCALL
  	beq	hcall_try_real_mode
  
++<<<<<<< HEAD
 +	/* Only handle external interrupts here on arch 206 and later */
 +BEGIN_FTR_SECTION
 +	b	ext_interrupt_to_host
 +END_FTR_SECTION_IFCLR(CPU_FTR_ARCH_206)
 +
++=======
+ 	/* Hypervisor doorbell - exit only if host IPI flag set */
+ 	cmpwi	r12, BOOK3S_INTERRUPT_H_DOORBELL
+ 	bne	3f
+ 	lbz	r0, HSTATE_HOST_IPI(r13)
+ 	cmpwi	r0, 0
+ 	beq	4f
+ 	b	guest_exit_cont
+ 3:
++>>>>>>> 06554d9f6cc8 (KVM: PPC: Book3S HV: Exit on H_DOORBELL if HOST_IPI is set)
  	/* External interrupt ? */
  	cmpwi	r12, BOOK3S_INTERRUPT_EXTERNAL
 -	bne+	guest_exit_cont
 +	bne+	ext_interrupt_to_host
  
  	/* External interrupt, first check for host_ipi. If this is
  	 * set, we know the host wants us out so let's do it now
* Unmerged path arch/powerpc/kvm/book3s_hv_rmhandlers.S
