IB/iser: Fix unload during ep_poll wrong dereference

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
Rebuild_CHGLOG: - [infiniband] iser: Fix unload during ep_poll wrong dereference (Amir Vadai) [1164539]
Rebuild_FUZZ: 97.03%
commit-author Sagi Grimberg <sagig@mellanox.com>
commit c4de4663e0fa858e3a84f9b32b2e1dd2de23fab2
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/c4de4663.failed

In case the user unloaded ib_iser while ep_connect is in
progress, we need to destroy the endpoint although ep_disconnect
wasn't invoked (we detect this by the iser conn state != DOWN).
However, if we got an REJECTED/UNREACHABLE CM event we move the
connection state to DOWN which will prevent us from destroying
the endpoint in the module unload stage. Fix this by setting the
connection state to TERMINATING in iser_conn_error so we can still
destroy the endpoint at unload stage.

	Reported-by: Ariel Nahum <arieln@mellanox.com>
	Signed-off-by: Sagi Grimberg <sagig@mellanox.com>
	Signed-off-by: Doug Ledford <dledford@redhat.com>
(cherry picked from commit c4de4663e0fa858e3a84f9b32b2e1dd2de23fab2)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/ulp/iser/iser_verbs.c
diff --cc drivers/infiniband/ulp/iser/iser_verbs.c
index 4cafd44ad193,070c5af28a75..000000000000
--- a/drivers/infiniband/ulp/iser/iser_verbs.c
+++ b/drivers/infiniband/ulp/iser/iser_verbs.c
@@@ -671,10 -718,10 +671,15 @@@ void iser_conn_terminate(struct iser_co
   **/
  static void iser_connect_error(struct rdma_cm_id *cma_id)
  {
 -	struct iser_conn *iser_conn;
 +	struct iser_conn *ib_conn;
  
++<<<<<<< HEAD
 +	ib_conn = (struct iser_conn *)cma_id->context;
 +	ib_conn->state = ISER_CONN_DOWN;
++=======
+ 	iser_conn = (struct iser_conn *)cma_id->context;
+ 	iser_conn->state = ISER_CONN_TERMINATING;
++>>>>>>> c4de4663e0fa (IB/iser: Fix unload during ep_poll wrong dereference)
  }
  
  /**
* Unmerged path drivers/infiniband/ulp/iser/iser_verbs.c
