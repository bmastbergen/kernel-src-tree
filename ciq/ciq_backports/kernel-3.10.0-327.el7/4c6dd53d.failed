dm mpath: fix leak of dm_mpath_io structure in blk-mq .queue_rq error path

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
Rebuild_CHGLOG: - [md] dm-mpath: fix leak of dm_mpath_io structure in blk-mq .queue_rq error path (Mike Snitzer) [1166127 1208542]
Rebuild_FUZZ: 98.65%
commit-author Mike Snitzer <snitzer@redhat.com>
commit 4c6dd53dd3674c310d7379c6b3273daa9fd95c79
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/4c6dd53d.failed

Otherwise kmemleak reported:

unreferenced object 0xffff88009b14e2b0 (size 16):
  comm "fio", pid 4274, jiffies 4294978034 (age 1253.210s)
  hex dump (first 16 bytes):
    40 12 f3 99 01 88 ff ff 00 10 00 00 00 00 00 00  @...............
  backtrace:
    [<ffffffff81600029>] kmemleak_alloc+0x49/0xb0
    [<ffffffff811679a8>] kmem_cache_alloc+0xf8/0x160
    [<ffffffff8111c950>] mempool_alloc_slab+0x10/0x20
    [<ffffffff8111cb37>] mempool_alloc+0x57/0x150
    [<ffffffffa04d2b61>] __multipath_map.isra.17+0xe1/0x220 [dm_multipath]
    [<ffffffffa04d2cb5>] multipath_clone_and_map+0x15/0x20 [dm_multipath]
    [<ffffffffa02889b5>] map_request.isra.39+0xd5/0x220 [dm_mod]
    [<ffffffffa028b0e4>] dm_mq_queue_rq+0x134/0x240 [dm_mod]
    [<ffffffff812cccb5>] __blk_mq_run_hw_queue+0x1d5/0x380
    [<ffffffff812ccaa5>] blk_mq_run_hw_queue+0xc5/0x100
    [<ffffffff812ce350>] blk_sq_make_request+0x240/0x300
    [<ffffffff812c0f30>] generic_make_request+0xc0/0x110
    [<ffffffff812c0ff2>] submit_bio+0x72/0x150
    [<ffffffff811c07cb>] do_blockdev_direct_IO+0x1f3b/0x2da0
    [<ffffffff811c166e>] __blockdev_direct_IO+0x3e/0x40
    [<ffffffff8120aa1a>] ext4_direct_IO+0x1aa/0x390

Fixes: e5863d9ad ("dm: allocate requests in target when stacking on blk-mq devices")
	Reported-by: Bart Van Assche <bart.vanassche@sandisk.com>
	Signed-off-by: Mike Snitzer <snitzer@redhat.com>
	Cc: stable@vger.kernel.org # 4.0+
(cherry picked from commit 4c6dd53dd3674c310d7379c6b3273daa9fd95c79)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/md/dm-mpath.c
diff --cc drivers/md/dm-mpath.c
index add6391f3f8e,eff7bdd7731d..000000000000
--- a/drivers/md/dm-mpath.c
+++ b/drivers/md/dm-mpath.c
@@@ -428,10 -428,12 +428,17 @@@ static int __multipath_map(struct dm_ta
  	} else {
  		/* blk-mq request-based interface */
  		*__clone = blk_get_request(bdev_get_queue(bdev),
++<<<<<<< HEAD
 +					   rq_data_dir(rq), GFP_KERNEL);
 +		if (IS_ERR(*__clone))
++=======
+ 					   rq_data_dir(rq), GFP_ATOMIC);
+ 		if (IS_ERR(*__clone)) {
++>>>>>>> 4c6dd53dd367 (dm mpath: fix leak of dm_mpath_io structure in blk-mq .queue_rq error path)
  			/* ENOMEM, requeue */
+ 			clear_mapinfo(m, map_context);
  			return r;
+ 		}
  		(*__clone)->bio = (*__clone)->biotail = NULL;
  		(*__clone)->rq_disk = bdev->bd_disk;
  		(*__clone)->cmd_flags |= REQ_FAILFAST_TRANSPORT;
* Unmerged path drivers/md/dm-mpath.c
