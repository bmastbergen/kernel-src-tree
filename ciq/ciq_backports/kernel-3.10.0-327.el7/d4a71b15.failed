ip_tunnel: Do not use stale inner_iph pointer.

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
Rebuild_CHGLOG: - [net] ip_tunnel: Do not use stale inner_iph pointer (Florian Westphal) [1187739]
Rebuild_FUZZ: 98.90%
commit-author Pravin B Shelar <pshelar@nicira.com>
commit d4a71b155c12d0d429c6b69d94076d6d57e2a7a7
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/d4a71b15.failed

While sending packet skb_cow_head() can change skb header which
invalidates inner_iph pointer to skb header. Following patch
avoid using it. Found by code inspection.

This bug was introduced by commit 0e6fbc5b6c6218 (ip_tunnels: extend
iptunnel_xmit()).

	Signed-off-by: Pravin B Shelar <pshelar@nicira.com>
	Acked-by: Eric Dumazet <edumazet@google.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit d4a71b155c12d0d429c6b69d94076d6d57e2a7a7)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/ipv4/ip_tunnel.c
diff --cc net/ipv4/ip_tunnel.c
index b1eeb95951d8,d3fbad422e0e..000000000000
--- a/net/ipv4/ip_tunnel.c
+++ b/net/ipv4/ip_tunnel.c
@@@ -656,8 -651,8 +657,13 @@@ void ip_tunnel_xmit(struct sk_buff *skb
  		}
  	}
  
++<<<<<<< HEAD
 +	err = iptunnel_xmit(skb->sk, rt, skb, fl4.saddr, fl4.daddr, protocol,
 +			    ip_tunnel_ecn_encap(tos, inner_iph, skb), ttl, df);
++=======
+ 	err = iptunnel_xmit(rt, skb, fl4.saddr, fl4.daddr, protocol,
+ 			    tos, ttl, df, !net_eq(tunnel->net, dev_net(dev)));
++>>>>>>> d4a71b155c12 (ip_tunnel: Do not use stale inner_iph pointer.)
  	iptunnel_xmit_stats(err, &dev->stats, dev->tstats);
  
  	return;
* Unmerged path net/ipv4/ip_tunnel.c
