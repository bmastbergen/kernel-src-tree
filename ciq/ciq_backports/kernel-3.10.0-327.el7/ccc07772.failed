KVM: PPC: Book3S HV: Don't wake thread with no vcpu on guest IPI

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
Rebuild_CHGLOG: - [kvm] ppc: book3s-hv: Don't wake thread with no vcpu on guest IPI (Laurent Vivier) [1213669]
Rebuild_FUZZ: 94.31%
commit-author Paul Mackerras <paulus@samba.org>
commit ccc07772c99befeda7a7a4b1d05a6f3b762518c2
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/ccc07772.failed

When running a multi-threaded guest and vcpu 0 in a virtual core
is not running in the guest (i.e. it is busy elsewhere in the host),
thread 0 of the physical core will switch the MMU to the guest and
then go to nap mode in the code at kvm_do_nap.  If the guest sends
an IPI to thread 0 using the msgsndp instruction, that will wake
up thread 0 and cause all the threads in the guest to exit to the
host unnecessarily.  To avoid the unnecessary exit, this arranges
for the PECEDP bit to be cleared in this situation.  When napping
due to a H_CEDE from the guest, we still set PECEDP so that the
thread will wake up on an IPI sent using msgsndp.

	Signed-off-by: Paul Mackerras <paulus@samba.org>
	Signed-off-by: Alexander Graf <agraf@suse.de>
(cherry picked from commit ccc07772c99befeda7a7a4b1d05a6f3b762518c2)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/powerpc/kvm/book3s_hv_rmhandlers.S
diff --cc arch/powerpc/kvm/book3s_hv_rmhandlers.S
index 499fdba9ddf8,12d7e4c8dc54..000000000000
--- a/arch/powerpc/kvm/book3s_hv_rmhandlers.S
+++ b/arch/powerpc/kvm/book3s_hv_rmhandlers.S
@@@ -2176,15 -2124,24 +2177,27 @@@ END_FTR_SECTION_IFCLR(CPU_FTR_ARCH_206
  	/* save FP state */
  	bl	kvmppc_save_fp
  
++<<<<<<< HEAD
++=======
+ #ifdef CONFIG_KVM_BOOK3S_HV_EXIT_TIMING
+ 	ld	r4, HSTATE_KVM_VCPU(r13)
+ 	addi	r3, r4, VCPU_TB_CEDE
+ 	bl	kvmhv_accumulate_time
+ #endif
+ 
+ 	lis	r3, LPCR_PECEDP@h	/* Do wake on privileged doorbell */
+ 
++>>>>>>> ccc07772c99b (KVM: PPC: Book3S HV: Don't wake thread with no vcpu on guest IPI)
  	/*
  	 * Take a nap until a decrementer or external or doobell interrupt
- 	 * occurs, with PECE1, PECE0 and PECEDP set in LPCR. Also clear the
- 	 * runlatch bit before napping.
+ 	 * occurs, with PECE1 and PECE0 set in LPCR.
+ 	 * On POWER8, if we are ceding, also set PECEDP.
+ 	 * Also clear the runlatch bit before napping.
  	 */
  kvm_do_nap:
 -	mfspr	r0, SPRN_CTRLF
 -	clrrdi	r0, r0, 1
 -	mtspr	SPRN_CTRLT, r0
 +	mfspr	r2, SPRN_CTRLF
 +	clrrdi	r2, r2, 1
 +	mtspr	SPRN_CTRLT, r2
  
  	li	r0,1
  	stb	r0,HSTATE_HWTHREAD_REQ(r13)
* Unmerged path arch/powerpc/kvm/book3s_hv_rmhandlers.S
