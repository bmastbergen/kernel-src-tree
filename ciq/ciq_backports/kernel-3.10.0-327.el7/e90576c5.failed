ALSA: line6: Consolidate PCM stream buffer allocation and free

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
Rebuild_CHGLOG: - [alsa] line6: Consolidate PCM stream buffer allocation and free (Jaroslav Kysela) [1197064]
Rebuild_FUZZ: 94.92%
commit-author Takashi Iwai <tiwai@suse.de>
commit e90576c5955c83cd7e8c191b47f70d1946015041
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/e90576c5.failed

The PCM stream buffer allocation and free are identical for both
playback and capture streams.  Provide single helper functions.
These are used only in pcm.c, thus they can be even static.

	Tested-by: Chris Rorvick <chris@rorvick.com>
	Signed-off-by: Takashi Iwai <tiwai@suse.de>
(cherry picked from commit e90576c5955c83cd7e8c191b47f70d1946015041)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/staging/line6/capture.c
#	drivers/staging/line6/playback.c
#	sound/usb/line6/pcm.c
diff --cc drivers/staging/line6/capture.c
index 7ed8560f3c0a,47cfcc2ab387..000000000000
--- a/drivers/staging/line6/capture.c
+++ b/drivers/staging/line6/capture.c
@@@ -193,12 -141,6 +193,15 @@@ void line6_capture_check_period(struct 
  	}
  }
  
++<<<<<<< HEAD:drivers/staging/line6/capture.c
 +void line6_free_capture_buffer(struct snd_line6_pcm *line6pcm)
 +{
 +	kfree(line6pcm->buffer_in);
 +	line6pcm->buffer_in = NULL;
 +}
 +
++=======
++>>>>>>> e90576c5955c (ALSA: line6: Consolidate PCM stream buffer allocation and free):sound/usb/line6/capture.c
  /*
   * Callback for completed capture URB.
   */
diff --cc drivers/staging/line6/playback.c
index d11db09086cb,750d91dced57..000000000000
--- a/drivers/staging/line6/playback.c
+++ b/drivers/staging/line6/playback.c
@@@ -293,63 -290,6 +293,66 @@@ int line6_submit_audio_out_all_urbs(str
  	return 0;
  }
  
++<<<<<<< HEAD:drivers/staging/line6/playback.c
 +/*
 +	Unlink all currently active playback URBs.
 +*/
 +void line6_unlink_audio_out_urbs(struct snd_line6_pcm *line6pcm)
 +{
 +	unsigned int i;
 +
 +	for (i = LINE6_ISO_BUFFERS; i--;) {
 +		if (test_bit(i, &line6pcm->active_urb_out)) {
 +			if (!test_and_set_bit(i, &line6pcm->unlink_urb_out)) {
 +				struct urb *u = line6pcm->urb_audio_out[i];
 +				usb_unlink_urb(u);
 +			}
 +		}
 +	}
 +}
 +
 +/*
 +	Wait until unlinking of all currently active playback URBs has been
 +	finished.
 +*/
 +void line6_wait_clear_audio_out_urbs(struct snd_line6_pcm *line6pcm)
 +{
 +	int timeout = HZ;
 +	unsigned int i;
 +	int alive;
 +
 +	do {
 +		alive = 0;
 +		for (i = LINE6_ISO_BUFFERS; i--;) {
 +			if (test_bit(i, &line6pcm->active_urb_out))
 +				alive++;
 +		}
 +		if (!alive)
 +			break;
 +		set_current_state(TASK_UNINTERRUPTIBLE);
 +		schedule_timeout(1);
 +	} while (--timeout > 0);
 +	if (alive)
 +		snd_printk(KERN_ERR "timeout: still %d active urbs..\n", alive);
 +}
 +
 +/*
 +	Unlink all currently active playback URBs, and wait for finishing.
 +*/
 +void line6_unlink_wait_clear_audio_out_urbs(struct snd_line6_pcm *line6pcm)
 +{
 +	line6_unlink_audio_out_urbs(line6pcm);
 +	line6_wait_clear_audio_out_urbs(line6pcm);
 +}
 +
 +void line6_free_playback_buffer(struct snd_line6_pcm *line6pcm)
 +{
 +	kfree(line6pcm->buffer_out);
 +	line6pcm->buffer_out = NULL;
 +}
 +
++=======
++>>>>>>> e90576c5955c (ALSA: line6: Consolidate PCM stream buffer allocation and free):sound/usb/line6/playback.c
  /*
  	Callback for completed playback URB.
  */
* Unmerged path sound/usb/line6/pcm.c
* Unmerged path drivers/staging/line6/capture.c
diff --git a/drivers/staging/line6/capture.h b/drivers/staging/line6/capture.h
index 4157bcb598a9..5bb2e77db5c3 100644
--- a/drivers/staging/line6/capture.h
+++ b/drivers/staging/line6/capture.h
@@ -24,7 +24,6 @@ extern void line6_capture_copy(struct snd_line6_pcm *line6pcm, char *fbuf,
 extern void line6_capture_check_period(struct snd_line6_pcm *line6pcm,
 				       int length);
 extern int line6_create_audio_in_urbs(struct snd_line6_pcm *line6pcm);
-extern void line6_free_capture_buffer(struct snd_line6_pcm *line6pcm);
 extern int line6_submit_audio_in_all_urbs(struct snd_line6_pcm *line6pcm);
 extern void line6_unlink_audio_in_urbs(struct snd_line6_pcm *line6pcm);
 extern void line6_unlink_wait_clear_audio_in_urbs(struct snd_line6_pcm
* Unmerged path drivers/staging/line6/playback.c
diff --git a/drivers/staging/line6/playback.h b/drivers/staging/line6/playback.h
index 743bd6f74c57..f3760626304a 100644
--- a/drivers/staging/line6/playback.h
+++ b/drivers/staging/line6/playback.h
@@ -30,7 +30,6 @@
 extern struct snd_pcm_ops snd_line6_playback_ops;
 
 extern int line6_create_audio_out_urbs(struct snd_line6_pcm *line6pcm);
-extern void line6_free_playback_buffer(struct snd_line6_pcm *line6pcm);
 extern int line6_submit_audio_out_all_urbs(struct snd_line6_pcm *line6pcm);
 extern void line6_unlink_audio_out_urbs(struct snd_line6_pcm *line6pcm);
 extern void line6_unlink_wait_clear_audio_out_urbs(struct snd_line6_pcm
* Unmerged path sound/usb/line6/pcm.c
