net/mlx4_core: Handle AER flow properly

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
Rebuild_CHGLOG: - [netdrv] mlx4_core: Handle AER flow properly (Amir Vadai) [1164527 1164530 1164531 1164536 1164537]
Rebuild_FUZZ: 94.59%
commit-author Yishai Hadas <yishaih@mellanox.com>
commit 2ba5fbd62b2534335f4e3b844ecc7860115525a3
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/2ba5fbd6.failed

Fix AER callbacks to work properly, it includes:
- Refractoring AER to be aligned with Reset flow support.
- Sync with concurrent catas flow.

In addition, fix the shutdown PCI callback to sync with
concurrent catas flow.

	Signed-off-by: Yishai Hadas <yishaih@mellanox.com>
	Signed-off-by: Or Gerlitz <ogerlitz@mellanox.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 2ba5fbd62b2534335f4e3b844ecc7860115525a3)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlx4/main.c
diff --cc drivers/net/ethernet/mellanox/mlx4/main.c
index e21046536e8b,6bb0fca137cd..000000000000
--- a/drivers/net/ethernet/mellanox/mlx4/main.c
+++ b/drivers/net/ethernet/mellanox/mlx4/main.c
@@@ -2832,13 -3104,25 +2832,19 @@@ static int mlx4_init_one(struct pci_de
  		return -ENOMEM;
  
  	dev       = &priv->dev;
 -	dev->persist = kzalloc(sizeof(*dev->persist), GFP_KERNEL);
 -	if (!dev->persist) {
 -		kfree(priv);
 -		return -ENOMEM;
 -	}
 -	dev->persist->pdev = pdev;
 -	dev->persist->dev = dev;
 -	pci_set_drvdata(pdev, dev->persist);
 +	dev->pdev = pdev;
 +	pci_set_drvdata(pdev, dev);
  	priv->pci_dev_data = id->driver_data;
 -	mutex_init(&dev->persist->device_state_mutex);
 -	mutex_init(&dev->persist->interface_state_mutex);
  
  	ret =  __mlx4_init_one(pdev, id->driver_data, priv);
 -	if (ret) {
 -		kfree(dev->persist);
 +	if (ret)
  		kfree(priv);
++<<<<<<< HEAD
++=======
+ 	} else {
+ 		pci_save_state(pdev);
+ 	}
++>>>>>>> 2ba5fbd62b25 (net/mlx4_core: Handle AER flow properly)
  
  	return ret;
  }
* Unmerged path drivers/net/ethernet/mellanox/mlx4/main.c
