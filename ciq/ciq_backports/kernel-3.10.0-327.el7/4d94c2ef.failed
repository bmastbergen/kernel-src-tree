nfsd: move nfsd_fh_match to nfsfh.h

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
commit-author Christoph Hellwig <hch@lst.de>
commit 4d94c2ef2008a07fb1467e33da156de6fba9aad1
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/4d94c2ef.failed

The pnfs code will need it too.  Also remove the nfsd_ prefix to match the
other filehandle helpers in that file.

	Signed-off-by: Christoph Hellwig <hch@lst.de>
(cherry picked from commit 4d94c2ef2008a07fb1467e33da156de6fba9aad1)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/nfsd/nfs4state.c
diff --cc fs/nfsd/nfs4state.c
index 3e7464bc7f87,eb0336e526d2..000000000000
--- a/fs/nfsd/nfs4state.c
+++ b/fs/nfsd/nfs4state.c
@@@ -3295,17 -3282,14 +3287,24 @@@ move_to_close_lru(struct nfs4_ol_statei
  
  /* search file_hashtbl[] for file */
  static struct nfs4_file *
 -find_file_locked(struct knfsd_fh *fh, unsigned int hashval)
 +find_file_locked(struct knfsd_fh *fh)
  {
 +	unsigned int hashval = file_hashval(fh);
  	struct nfs4_file *fp;
  
++<<<<<<< HEAD
 +	lockdep_assert_held(&state_lock);
 +
 +	hlist_for_each_entry(fp, &file_hashtbl[hashval], fi_hash) {
 +		if (nfsd_fh_match(&fp->fi_fhandle, fh)) {
 +			get_nfs4_file(fp);
 +			return fp;
++=======
+ 	hlist_for_each_entry_rcu(fp, &file_hashtbl[hashval], fi_hash) {
+ 		if (fh_match(&fp->fi_fhandle, fh)) {
+ 			if (atomic_inc_not_zero(&fp->fi_ref))
+ 				return fp;
++>>>>>>> 4d94c2ef2008 (nfsd: move nfsd_fh_match to nfsfh.h)
  		}
  	}
  	return NULL;
* Unmerged path fs/nfsd/nfs4state.c
diff --git a/fs/nfsd/nfsfh.h b/fs/nfsd/nfsfh.h
index 08236d70c667..e24d95436db3 100644
--- a/fs/nfsd/nfsfh.h
+++ b/fs/nfsd/nfsfh.h
@@ -187,6 +187,15 @@ fh_init(struct svc_fh *fhp, int maxsize)
 	return fhp;
 }
 
+static inline bool fh_match(struct knfsd_fh *fh1, struct knfsd_fh *fh2)
+{
+	if (fh1->fh_size != fh2->fh_size)
+		return false;
+	if (memcmp(fh1->fh_base.fh_pad, fh2->fh_base.fh_pad, fh1->fh_size) != 0)
+		return false;
+	return true;
+}
+
 #ifdef CONFIG_NFSD_V3
 /*
  * The wcc data stored in current_fh should be cleared
