Drivers: hv: vmbus: don't send CHANNELMSG_UNLOAD on pre-Win2012R2 hosts

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
Rebuild_CHGLOG: - [hv] vmbus: don't send CHANNELMSG_UNLOAD on pre-Win2012R2 hosts (Vitaly Kuznetsov) [1248352]
Rebuild_FUZZ: 89.92%
commit-author Vitaly Kuznetsov <vkuznets@redhat.com>
commit 4a54243fc08f0edda1303bb666f0da68c378c036
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/4a54243f.failed

Pre-Win2012R2 hosts don't properly handle CHANNELMSG_UNLOAD and
wait_for_completion() hangs. Avoid sending such request on old hosts.

	Signed-off-by: Vitaly Kuznetsov <vkuznets@redhat.com>
	Signed-off-by: K. Y. Srinivasan <kys@microsoft.com>
	Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
(cherry picked from commit 4a54243fc08f0edda1303bb666f0da68c378c036)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/hv/channel_mgmt.c
diff --cc drivers/hv/channel_mgmt.c
index 6052b9503b13,00ba3f36f193..000000000000
--- a/drivers/hv/channel_mgmt.c
+++ b/drivers/hv/channel_mgmt.c
@@@ -456,6 -454,34 +456,37 @@@ static void init_vp_index(struct vmbus_
  }
  
  /*
++<<<<<<< HEAD
++=======
+  * vmbus_unload_response - Handler for the unload response.
+  */
+ static void vmbus_unload_response(struct vmbus_channel_message_header *hdr)
+ {
+ 	/*
+ 	 * This is a global event; just wakeup the waiting thread.
+ 	 * Once we successfully unload, we can cleanup the monitor state.
+ 	 */
+ 	complete(&vmbus_connection.unload_event);
+ }
+ 
+ void vmbus_initiate_unload(void)
+ {
+ 	struct vmbus_channel_message_header hdr;
+ 
+ 	/* Pre-Win2012R2 hosts don't support reconnect */
+ 	if (vmbus_proto_version < VERSION_WIN8_1)
+ 		return;
+ 
+ 	init_completion(&vmbus_connection.unload_event);
+ 	memset(&hdr, 0, sizeof(struct vmbus_channel_message_header));
+ 	hdr.msgtype = CHANNELMSG_UNLOAD;
+ 	vmbus_post_msg(&hdr, sizeof(struct vmbus_channel_message_header));
+ 
+ 	wait_for_completion(&vmbus_connection.unload_event);
+ }
+ 
+ /*
++>>>>>>> 4a54243fc08f (Drivers: hv: vmbus: don't send CHANNELMSG_UNLOAD on pre-Win2012R2 hosts)
   * vmbus_onoffer - Handler for channel offers from vmbus in parent partition.
   *
   */
* Unmerged path drivers/hv/channel_mgmt.c
