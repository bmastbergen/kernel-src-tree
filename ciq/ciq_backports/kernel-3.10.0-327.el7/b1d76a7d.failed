powerpc/eeh: Recover EEH error on ownership change for BCM5719

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
Rebuild_CHGLOG: - [powerpc] eeh: Recover EEH error on ownership change for BCM5719 (Laurent Vivier) [1213675]
Rebuild_FUZZ: 93.10%
commit-author Gavin Shan <gwshan@linux.vnet.ibm.com>
commit b1d76a7d57762332cd8e0c020470d43c5ad3948e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/b1d76a7d.failed

In PCI passthrou scenario, we need simulate EEH recovery for Emulex
adapters when their ownership changes, as we did in commit 5cfb20b96
("powerpc/eeh: Emulate EEH recovery for VFIO devices"). Broadcom
BCM5719 adpaters are facing same problem and needs same cure.

	Reported-by: Rajeshkumar Subramanian <rajeshkumars@in.ibm.com>
	Signed-off-by: Gavin Shan <gwshan@linux.vnet.ibm.com>
	Signed-off-by: Benjamin Herrenschmidt <benh@kernel.crashing.org>
(cherry picked from commit b1d76a7d57762332cd8e0c020470d43c5ad3948e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/powerpc/kernel/eeh.c
diff --cc arch/powerpc/kernel/eeh.c
index b7697ea6a6ff,f1c6b115cb37..000000000000
--- a/arch/powerpc/kernel/eeh.c
+++ b/arch/powerpc/kernel/eeh.c
@@@ -1208,6 -1216,61 +1208,64 @@@ int eeh_unfreeze_pe(struct eeh_pe *pe, 
  	return ret;
  }
  
++<<<<<<< HEAD
++=======
+ 
+ static struct pci_device_id eeh_reset_ids[] = {
+ 	{ PCI_DEVICE(0x19a2, 0x0710) },	/* Emulex, BE     */
+ 	{ PCI_DEVICE(0x10df, 0xe220) },	/* Emulex, Lancer */
+ 	{ PCI_DEVICE(0x14e4, 0x1657) }, /* Broadcom BCM5719 */
+ 	{ 0 }
+ };
+ 
+ static int eeh_pe_change_owner(struct eeh_pe *pe)
+ {
+ 	struct eeh_dev *edev, *tmp;
+ 	struct pci_dev *pdev;
+ 	struct pci_device_id *id;
+ 	int flags, ret;
+ 
+ 	/* Check PE state */
+ 	flags = (EEH_STATE_MMIO_ACTIVE | EEH_STATE_DMA_ACTIVE);
+ 	ret = eeh_ops->get_state(pe, NULL);
+ 	if (ret < 0 || ret == EEH_STATE_NOT_SUPPORT)
+ 		return 0;
+ 
+ 	/* Unfrozen PE, nothing to do */
+ 	if ((ret & flags) == flags)
+ 		return 0;
+ 
+ 	/* Frozen PE, check if it needs PE level reset */
+ 	eeh_pe_for_each_dev(pe, edev, tmp) {
+ 		pdev = eeh_dev_to_pci_dev(edev);
+ 		if (!pdev)
+ 			continue;
+ 
+ 		for (id = &eeh_reset_ids[0]; id->vendor != 0; id++) {
+ 			if (id->vendor != PCI_ANY_ID &&
+ 			    id->vendor != pdev->vendor)
+ 				continue;
+ 			if (id->device != PCI_ANY_ID &&
+ 			    id->device != pdev->device)
+ 				continue;
+ 			if (id->subvendor != PCI_ANY_ID &&
+ 			    id->subvendor != pdev->subsystem_vendor)
+ 				continue;
+ 			if (id->subdevice != PCI_ANY_ID &&
+ 			    id->subdevice != pdev->subsystem_device)
+ 				continue;
+ 
+ 			goto reset;
+ 		}
+ 	}
+ 
+ 	return eeh_unfreeze_pe(pe, true);
+ 
+ reset:
+ 	return eeh_pe_reset_and_recover(pe);
+ }
+ 
++>>>>>>> b1d76a7d5776 (powerpc/eeh: Recover EEH error on ownership change for BCM5719)
  /**
   * eeh_dev_open - Increase count of pass through devices for PE
   * @pdev: PCI device
* Unmerged path arch/powerpc/kernel/eeh.c
