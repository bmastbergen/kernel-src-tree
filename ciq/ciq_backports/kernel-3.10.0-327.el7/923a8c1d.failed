iwlwifi: mvm: fix antenna selection when BT is active

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
commit-author Emmanuel Grumbach <emmanuel.grumbach@intel.com>
commit 923a8c1d8069104726bde55c37cec66324ccc328
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/923a8c1d.failed

When BT is active, we want to avoid the shared antenna for
management frame to make sure we don't disturb BT. There
was a bug in that code because it chose the antenna
BIT(ANT_A) where ANT_A is already a bitmap (0x1). This
means that the antenna chosen in the end was ANT_B.
While this is not optimal on devices with 2 antennas (it'd
disturb BT), it is critical on single antenna devices like
3160 which couldn't connect at all when BT was active.

This fixes:
https://bugzilla.kernel.org/show_bug.cgi?id=97181

CC: <stable@vger.kernel.org> [3.17+]
Fixes: 34c8b24ff284 ("iwlwifi: mvm: BT Coex - avoid the shared antenna for management frames")
	Signed-off-by: Emmanuel Grumbach <emmanuel.grumbach@intel.com>
(cherry picked from commit 923a8c1d8069104726bde55c37cec66324ccc328)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/wireless/iwlwifi/mvm/tx.c
diff --cc drivers/net/wireless/iwlwifi/mvm/tx.c
index 3846a6c41eb1,89116864d2a0..000000000000
--- a/drivers/net/wireless/iwlwifi/mvm/tx.c
+++ b/drivers/net/wireless/iwlwifi/mvm/tx.c
@@@ -203,9 -247,15 +203,19 @@@ static void iwl_mvm_set_tx_cmd_rate(str
  	rate_plcp = iwl_mvm_mac80211_idx_to_hwrate(rate_idx);
  
  	mvm->mgmt_last_antenna_idx =
 -		iwl_mvm_next_antenna(mvm, iwl_mvm_get_valid_tx_ant(mvm),
 +		iwl_mvm_next_antenna(mvm, mvm->fw->valid_tx_ant,
  				     mvm->mgmt_last_antenna_idx);
++<<<<<<< HEAD
 +	rate_flags = BIT(mvm->mgmt_last_antenna_idx) << RATE_MCS_ANT_POS;
++=======
+ 
+ 	if (info->band == IEEE80211_BAND_2GHZ &&
+ 	    !iwl_mvm_bt_coex_is_shared_ant_avail(mvm))
+ 		rate_flags = mvm->cfg->non_shared_ant << RATE_MCS_ANT_POS;
+ 	else
+ 		rate_flags =
+ 			BIT(mvm->mgmt_last_antenna_idx) << RATE_MCS_ANT_POS;
++>>>>>>> 923a8c1d8069 (iwlwifi: mvm: fix antenna selection when BT is active)
  
  	/* Set CCK flag as needed */
  	if ((rate_idx >= IWL_FIRST_CCK_RATE) && (rate_idx <= IWL_LAST_CCK_RATE))
* Unmerged path drivers/net/wireless/iwlwifi/mvm/tx.c
