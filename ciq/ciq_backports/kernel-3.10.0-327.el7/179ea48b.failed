powerpc/eeh: Block CFG upon frozen Shiner adapter

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
Rebuild_CHGLOG: - [powerpc] eeh: Block CFG upon frozen Shiner adapter (Laurent Vivier) [1213675]
Rebuild_FUZZ: 91.11%
commit-author Gavin Shan <gwshan@linux.vnet.ibm.com>
commit 179ea48bc7c04dba3526d66d9f358c2f4f3b3776
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/179ea48b.failed

The Broadcom Shiner 2-ports 10G ethernet adapter has same problem
commit 6f20bda0 ("powerpc/eeh: Block PCI config access upon frozen
PE") fixes. Put it to the black list as well.

   # lspci -s 0004:01:00.0
   0004:01:00.0 Ethernet controller: Broadcom Corporation \
                NetXtreme II BCM57810 10 Gigabit Ethernet (rev 10)
   # lspci -n -s 0004:01:00.0
   0004:01:00.0 0200: 14e4:168e (rev 10)

	Reported-by: John Walthour <jwalthour@us.ibm.com>
	Signed-off-by: Gavin Shan <gwshan@linux.vnet.ibm.com>
	Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
(cherry picked from commit 179ea48bc7c04dba3526d66d9f358c2f4f3b3776)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/powerpc/platforms/powernv/eeh-powernv.c
diff --cc arch/powerpc/platforms/powernv/eeh-powernv.c
index d9afbdd8c6cc,1d19e7917d7f..000000000000
--- a/arch/powerpc/platforms/powernv/eeh-powernv.c
+++ b/arch/powerpc/platforms/powernv/eeh-powernv.c
@@@ -143,7 -161,41 +143,45 @@@ static int powernv_eeh_dev_probe(struc
  	edev->pe_config_addr	= phb->bdfn_to_pe(phb, dev->bus, dev->devfn & 0xff);
  
  	/* Create PE */
++<<<<<<< HEAD
 +	eeh_add_to_parent_pe(edev);
++=======
+ 	ret = eeh_add_to_parent_pe(edev);
+ 	if (ret) {
+ 		pr_warn("%s: Can't add PCI dev %s to parent PE (%d)\n",
+ 			__func__, pci_name(dev), ret);
+ 		return ret;
+ 	}
+ 
+ 	/*
+ 	 * If the PE contains any one of following adapters, the
+ 	 * PCI config space can't be accessed when dumping EEH log.
+ 	 * Otherwise, we will run into fenced PHB caused by shortage
+ 	 * of outbound credits in the adapter. The PCI config access
+ 	 * should be blocked until PE reset. MMIO access is dropped
+ 	 * by hardware certainly. In order to drop PCI config requests,
+ 	 * one more flag (EEH_PE_CFG_RESTRICTED) is introduced, which
+ 	 * will be checked in the backend for PE state retrival. If
+ 	 * the PE becomes frozen for the first time and the flag has
+ 	 * been set for the PE, we will set EEH_PE_CFG_BLOCKED for
+ 	 * that PE to block its config space.
+ 	 *
+ 	 * Broadcom Austin 4-ports NICs (14e4:1657)
+ 	 * Broadcom Shiner 2-ports 10G NICs (14e4:168e)
+ 	 */
+ 	if ((dev->vendor == PCI_VENDOR_ID_BROADCOM && dev->device == 0x1657) ||
+ 	    (dev->vendor == PCI_VENDOR_ID_BROADCOM && dev->device == 0x168e))
+ 		edev->pe->state |= EEH_PE_CFG_RESTRICTED;
+ 
+ 	/*
+ 	 * Cache the PE primary bus, which can't be fetched when
+ 	 * full hotplug is in progress. In that case, all child
+ 	 * PCI devices of the PE are expected to be removed prior
+ 	 * to PE reset.
+ 	 */
+ 	if (!edev->pe->bus)
+ 		edev->pe->bus = dev->bus;
++>>>>>>> 179ea48bc7c0 (powerpc/eeh: Block CFG upon frozen Shiner adapter)
  
  	/*
  	 * Enable EEH explicitly so that we will do EEH check
* Unmerged path arch/powerpc/platforms/powernv/eeh-powernv.c
