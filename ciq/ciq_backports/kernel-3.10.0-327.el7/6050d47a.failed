ext4: bail out from make_indexed_dir() on first error

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
commit-author Jan Kara <jack@suse.cz>
commit 6050d47adcadbb53582434d919ed7f038d936712
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/6050d47a.failed

When ext4_handle_dirty_dx_node() or ext4_handle_dirty_dirent_node()
fail, there's really something wrong with the fs and there's no point in
continuing further. Just return error from make_indexed_dir() in that
case. Also initialize frames array so that if we return early due to
error, dx_release() doesn't try to dereference uninitialized memory
(which could happen also due to error in do_split()).

Coverity-id: 741300
	Signed-off-by: Jan Kara <jack@suse.cz>
	Signed-off-by: Theodore Ts'o <tytso@mit.edu>
	Cc: stable@vger.kernel.org
(cherry picked from commit 6050d47adcadbb53582434d919ed7f038d936712)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/ext4/namei.c
diff --cc fs/ext4/namei.c
index dd45ec4893ea,426211882f72..000000000000
--- a/fs/ext4/namei.c
+++ b/fs/ext4/namei.c
@@@ -1849,19 -1823,17 +1850,30 @@@ static int make_indexed_dir(handle_t *h
  	frame->bh = bh;
  	bh = bh2;
  
- 	ext4_handle_dirty_dx_node(handle, dir, frame->bh);
- 	ext4_handle_dirty_dirent_node(handle, dir, bh);
+ 	retval = ext4_handle_dirty_dx_node(handle, dir, frame->bh);
+ 	if (retval)
+ 		goto out_frames;	
+ 	retval = ext4_handle_dirty_dirent_node(handle, dir, bh);
+ 	if (retval)
+ 		goto out_frames;	
  
++<<<<<<< HEAD
 +	de = do_split(handle,dir, &bh, frame, &hinfo, &retval);
 +	if (!de) {
 +		/*
 +		 * Even if the block split failed, we have to properly write
 +		 * out all the changes we did so far. Otherwise we can end up
 +		 * with corrupted filesystem.
 +		 */
 +		ext4_mark_inode_dirty(handle, dir);
 +		dx_release(frames);
 +		return retval;
++=======
+ 	de = do_split(handle,dir, &bh, frame, &hinfo);
+ 	if (IS_ERR(de)) {
+ 		retval = PTR_ERR(de);
+ 		goto out_frames;
++>>>>>>> 6050d47adcad (ext4: bail out from make_indexed_dir() on first error)
  	}
  	dx_release(frames);
  
* Unmerged path fs/ext4/namei.c
