s390: add z13 code generation support

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
Rebuild_CHGLOG: - [s390] add z13 code generation support (Hendrik Brueckner) [1204860]
Rebuild_FUZZ: 91.18%
commit-author Martin Schwidefsky <schwidefsky@de.ibm.com>
commit f8b2dcbd9e6d1479b9b5a9e9e78bbaf783bde819
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/f8b2dcbd.failed

Allow to generate code that only runs on z13 machines.

	Signed-off-by: Martin Schwidefsky <schwidefsky@de.ibm.com>
(cherry picked from commit f8b2dcbd9e6d1479b9b5a9e9e78bbaf783bde819)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/s390/Makefile
#	arch/s390/kernel/head.S
diff --cc arch/s390/Makefile
index c4510e904ed5,e742ec5de9a7..000000000000
--- a/arch/s390/Makefile
+++ b/arch/s390/Makefile
@@@ -35,13 -35,17 +35,27 @@@ endi
  
  export LD_BFD
  
++<<<<<<< HEAD
 +cflags-$(CONFIG_MARCH_G5)   += $(call cc-option,-march=g5)
 +cflags-$(CONFIG_MARCH_Z900) += $(call cc-option,-march=z900)
 +cflags-$(CONFIG_MARCH_Z990) += $(call cc-option,-march=z990)
 +cflags-$(CONFIG_MARCH_Z9_109) += $(call cc-option,-march=z9-109)
 +cflags-$(CONFIG_MARCH_Z10) += $(call cc-option,-march=z10)
 +cflags-$(CONFIG_MARCH_Z196) += $(call cc-option,-march=z196)
 +cflags-$(CONFIG_MARCH_ZEC12) += $(call cc-option,-march=zEC12)
++=======
+ mflags-$(CONFIG_MARCH_G5)     := -march=g5
+ mflags-$(CONFIG_MARCH_Z900)   := -march=z900
+ mflags-$(CONFIG_MARCH_Z990)   := -march=z990
+ mflags-$(CONFIG_MARCH_Z9_109) := -march=z9-109
+ mflags-$(CONFIG_MARCH_Z10)    := -march=z10
+ mflags-$(CONFIG_MARCH_Z196)   := -march=z196
+ mflags-$(CONFIG_MARCH_ZEC12)  := -march=zEC12
+ mflags-$(CONFIG_MARCH_Z13)   := -march=z13
+ 
+ aflags-y += $(mflags-y)
+ cflags-y += $(mflags-y)
++>>>>>>> f8b2dcbd9e6d (s390: add z13 code generation support)
  
  cflags-$(CONFIG_MARCH_G5_TUNE)		+= -mtune=g5
  cflags-$(CONFIG_MARCH_Z900_TUNE)	+= -mtune=z900
diff --cc arch/s390/kernel/head.S
index fd8db63dfc94,132f4c9ade60..000000000000
--- a/arch/s390/kernel/head.S
+++ b/arch/s390/kernel/head.S
@@@ -436,14 -436,16 +436,21 @@@ ENTRY(startup_kdump
  # followed by the facility words.
  
  #if defined(CONFIG_64BIT)
++<<<<<<< HEAD
 +#if defined(CONFIG_MARCH_ZEC12)
 +	.long 3, 0xc100efe3, 0xf46ce000, 0x00400000
++=======
+ #if defined(CONFIG_MARCH_Z13)
+ 	.long 3, 0xc100eff2, 0xf46ce800, 0x00400000
+ #elif defined(CONFIG_MARCH_ZEC12)
+ 	.long 3, 0xc100eff2, 0xf46ce800, 0x00400000
++>>>>>>> f8b2dcbd9e6d (s390: add z13 code generation support)
  #elif defined(CONFIG_MARCH_Z196)
 -	.long 2, 0xc100eff2, 0xf46c0000
 +	.long 2, 0xc100efe3, 0xf46c0000
  #elif defined(CONFIG_MARCH_Z10)
 -	.long 2, 0xc100eff2, 0xf0680000
 +	.long 2, 0xc100efe3, 0xf0680000
  #elif defined(CONFIG_MARCH_Z9_109)
 -	.long 1, 0xc100efc2
 +	.long 1, 0xc100efc3
  #elif defined(CONFIG_MARCH_Z990)
  	.long 1, 0xc0002000
  #elif defined(CONFIG_MARCH_Z900)
diff --git a/arch/s390/Kconfig b/arch/s390/Kconfig
index 36a4b5105648..0f0130dede56 100644
--- a/arch/s390/Kconfig
+++ b/arch/s390/Kconfig
@@ -173,6 +173,10 @@ config HAVE_MARCH_ZEC12_FEATURES
 	def_bool n
 	select HAVE_MARCH_Z196_FEATURES
 
+config HAVE_MARCH_Z13_FEATURES
+	def_bool n
+	select HAVE_MARCH_ZEC12_FEATURES
+
 choice
 	prompt "Processor type"
 	default MARCH_G5
@@ -232,6 +236,14 @@ config MARCH_ZEC12
 	  2827 series). The kernel will be slightly faster but will not work on
 	  older machines.
 
+config MARCH_Z13
+	bool "IBM z13"
+	select HAVE_MARCH_Z13_FEATURES if 64BIT
+	help
+	  Select this to enable optimizations for IBM z13 (2964 series).
+	  The kernel will be slightly faster but will not work on older
+	  machines.
+
 endchoice
 
 config MARCH_G5_TUNE
@@ -255,6 +267,9 @@ config MARCH_Z196_TUNE
 config MARCH_ZEC12_TUNE
 	def_bool TUNE_ZEC12 || MARCH_ZEC12 && TUNE_DEFAULT
 
+config MARCH_Z13_TUNE
+	def_bool TUNE_Z13 || MARCH_Z13 && TUNE_DEFAULT
+
 choice
 	prompt "Tune code generation"
 	default TUNE_DEFAULT
@@ -293,6 +308,9 @@ config TUNE_Z196
 config TUNE_ZEC12
 	bool "IBM zBC12 and zEC12"
 
+config TUNE_Z13
+	bool "IBM z13"
+
 endchoice
 
 config 64BIT
* Unmerged path arch/s390/Makefile
* Unmerged path arch/s390/kernel/head.S
diff --git a/arch/s390/kernel/setup.c b/arch/s390/kernel/setup.c
index 4f03e6e1cd12..6932d18239a6 100644
--- a/arch/s390/kernel/setup.c
+++ b/arch/s390/kernel/setup.c
@@ -952,6 +952,9 @@ static void __init setup_hwcaps(void)
 	case 0x2828:
 		strcpy(elf_platform, "zEC12");
 		break;
+	case 0x2964:
+		strcpy(elf_platform, "z13");
+		break;
 	}
 }
 
