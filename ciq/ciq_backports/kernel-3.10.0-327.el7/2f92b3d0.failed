ceph: properly mark empty directory as complete

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
commit-author Yan, Zheng <zyan@redhat.com>
commit 2f92b3d0a9a583a5a4dd786a84fc42e6f1aa40fa
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/2f92b3d0.failed

ceph_add_cap() calls __check_cap_issue(), which clears directory
inode' complete flag. so we should set the complete flag for empty
directory should be set after calling ceph_add_cap().

	Signed-off-by: Yan, Zheng <zyan@redhat.com>
(cherry picked from commit 2f92b3d0a9a583a5a4dd786a84fc42e6f1aa40fa)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/ceph/inode.c
diff --cc fs/ceph/inode.c
index 3ef0ed3e35e4,f88a0f059dc8..000000000000
--- a/fs/ceph/inode.c
+++ b/fs/ceph/inode.c
@@@ -826,17 -840,6 +826,20 @@@ static int fill_inode(struct inode *ino
  		       ceph_vinop(inode), inode->i_mode);
  	}
  
++<<<<<<< HEAD
 +	/* set dir completion flag? */
 +	if (S_ISDIR(inode->i_mode) &&
 +	    ci->i_files == 0 && ci->i_subdirs == 0 &&
 +	    ceph_snap(inode) == CEPH_NOSNAP &&
 +	    (le32_to_cpu(info->cap.caps) & CEPH_CAP_FILE_SHARED) &&
 +	    (issued & CEPH_CAP_FILE_EXCL) == 0 &&
 +	    !__ceph_dir_is_complete(ci)) {
 +		dout(" marking %p complete (empty)\n", inode);
 +		__ceph_dir_set_complete(ci, atomic_read(&ci->i_release_count));
 +	}
 +
++=======
++>>>>>>> 2f92b3d0a9a5 (ceph: properly mark empty directory as complete)
  	/* were we issued a capability? */
  	if (info->cap.caps) {
  		if (ceph_snap(inode) == CEPH_NOSNAP) {
* Unmerged path fs/ceph/inode.c
