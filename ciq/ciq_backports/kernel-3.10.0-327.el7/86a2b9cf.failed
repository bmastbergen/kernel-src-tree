bonding: ratelimit pr_warn()s in 802.3ad mode

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
commit-author Veaceslav Falico <vfalico@redhat.com>
commit 86a2b9cfccea1fb1fcb16a549ccddfe40be391d1
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/86a2b9cf.failed

Only ratelimit the ones that might spam, omiting the ones from
enslave/deslave.

CC: Jay Vosburgh <fubar@us.ibm.com>
CC: Andy Gospodarek <andy@greyhouse.net>
	Signed-off-by: Veaceslav Falico <vfalico@redhat.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 86a2b9cfccea1fb1fcb16a549ccddfe40be391d1)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/bonding/bond_3ad.c
diff --cc drivers/net/bonding/bond_3ad.c
index dc508c87249d,b667a51ed215..000000000000
--- a/drivers/net/bonding/bond_3ad.c
+++ b/drivers/net/bonding/bond_3ad.c
@@@ -1312,15 -1280,18 +1312,27 @@@ static void ad_port_selection_logic(str
  				break;
  			}
  		}
++<<<<<<< HEAD
 +		if (!curr_port) { // meaning: the port was related to an aggregator but was not on the aggregator port list
 +			pr_warning("%s: Warning: Port %d (on %s) was related to aggregator %d but was not on its port list\n",
 +				   port->slave->bond->dev->name,
 +				   port->actor_port_number,
 +				   port->slave->dev->name,
 +				   port->aggregator->aggregator_identifier);
++=======
+ 		if (!curr_port) {
+ 			/* meaning: the port was related to an aggregator
+ 			 * but was not on the aggregator port list
+ 			 */
+ 			pr_warn_ratelimited("%s: Warning: Port %d (on %s) was related to aggregator %d but was not on its port list\n",
+ 					    port->slave->bond->dev->name,
+ 					    port->actor_port_number,
+ 					    port->slave->dev->name,
+ 					    port->aggregator->aggregator_identifier);
++>>>>>>> 86a2b9cfccea (bonding: ratelimit pr_warn()s in 802.3ad mode)
  		}
  	}
 -	/* search on all aggregators for a suitable aggregator for this port */
 +	// search on all aggregators for a suitable aggregator for this port
  	bond_for_each_slave(bond, slave, iter) {
  		aggregator = &(SLAVE_AD_INFO(slave).aggregator);
  
@@@ -1470,9 -1445,9 +1482,15 @@@ static struct aggregator *ad_agg_select
  		break;
  
  	default:
++<<<<<<< HEAD
 +		pr_warning("%s: Impossible agg select mode %d\n",
 +			   curr->slave->bond->dev->name,
 +			   __get_agg_selection_mode(curr->lag_ports));
++=======
+ 		pr_warn_ratelimited("%s: Impossible agg select mode %d\n",
+ 				    curr->slave->bond->dev->name,
+ 				    __get_agg_selection_mode(curr->lag_ports));
++>>>>>>> 86a2b9cfccea (bonding: ratelimit pr_warn()s in 802.3ad mode)
  		break;
  	}
  
@@@ -1580,10 -1558,11 +1598,16 @@@ static void ad_agg_selection_logic(stru
  				 agg->is_individual, agg->is_active);
  		}
  
 -		/* check if any partner replys */
 +		// check if any partner replys
  		if (best->is_individual) {
++<<<<<<< HEAD
 +			pr_warning("%s: Warning: No 802.3ad response from the link partner for any adapters in the bond\n",
 +				   best->slave ? best->slave->bond->dev->name : "NULL");
++=======
+ 			pr_warn_ratelimited("%s: Warning: No 802.3ad response from the link partner for any adapters in the bond\n",
+ 					    best->slave ?
+ 					    best->slave->bond->dev->name : "NULL");
++>>>>>>> 86a2b9cfccea (bonding: ratelimit pr_warn()s in 802.3ad mode)
  		}
  
  		best->is_active = 1;
@@@ -2111,24 -2059,30 +2135,29 @@@ void bond_3ad_state_machine_handler(str
  {
  	struct bonding *bond = container_of(work, struct bonding,
  					    ad_work.work);
 -	struct aggregator *aggregator;
 -	struct list_head *iter;
 -	struct slave *slave;
  	struct port *port;
 -	bool should_notify_rtnl = BOND_SLAVE_NOTIFY_LATER;
 -
 -	read_lock(&bond->lock);
 -	rcu_read_lock();
 +	struct aggregator *aggregator;
  
 -	/* check if there are any slaves */
 -	if (!bond_has_slaves(bond))
 +	if (!rtnl_trylock()) {
 +		queue_delayed_work(bond->wq, &bond->ad_work, ad_delta_in_ticks);
 +		return;
 +	}
 +	//check if there are any slaves
 +	if (bond->slave_cnt == 0)
  		goto re_arm;
  
 -	/* check if agg_select_timer timer after initialize is timed out */
 -	if (BOND_AD_INFO(bond).agg_select_timer &&
 -	    !(--BOND_AD_INFO(bond).agg_select_timer)) {
 -		slave = bond_first_slave_rcu(bond);
 -		port = slave ? &(SLAVE_AD_INFO(slave).port) : NULL;
 -
 -		/* select the active aggregator for the bond */
 -		if (port) {
 +	// check if agg_select_timer timer after initialize is timed out
 +	if (BOND_AD_INFO(bond).agg_select_timer && !(--BOND_AD_INFO(bond).agg_select_timer)) {
 +		// select the active aggregator for the bond
 +		if ((port = __get_first_port(bond))) {
  			if (!port->slave) {
++<<<<<<< HEAD
 +				pr_warning("%s: Warning: bond's first port is uninitialized\n",
 +					   bond->dev->name);
++=======
+ 				pr_warn_ratelimited("%s: Warning: bond's first port is uninitialized\n",
+ 						    bond->dev->name);
++>>>>>>> 86a2b9cfccea (bonding: ratelimit pr_warn()s in 802.3ad mode)
  				goto re_arm;
  			}
  
@@@ -2138,11 -2092,12 +2167,16 @@@
  		bond_3ad_set_carrier(bond);
  	}
  
 -	/* for each port run the state machines */
 -	bond_for_each_slave_rcu(bond, slave, iter) {
 -		port = &(SLAVE_AD_INFO(slave).port);
 +	// for each port run the state machines
 +	for (port = __get_first_port(bond); port; port = __get_next_port(port)) {
  		if (!port->slave) {
++<<<<<<< HEAD
 +			pr_warning("%s: Warning: Found an uninitialized port\n",
 +				   bond->dev->name);
++=======
+ 			pr_warn_ratelimited("%s: Warning: Found an uninitialized port\n",
+ 					    bond->dev->name);
++>>>>>>> 86a2b9cfccea (bonding: ratelimit pr_warn()s in 802.3ad mode)
  			goto re_arm;
  		}
  
@@@ -2190,8 -2158,8 +2224,13 @@@ static int bond_3ad_rx_indication(struc
  		port = &(SLAVE_AD_INFO(slave).port);
  
  		if (!port->slave) {
++<<<<<<< HEAD
 +			pr_warning("%s: Warning: port of slave %s is uninitialized\n",
 +				   slave->dev->name, slave->bond->dev->name);
++=======
+ 			pr_warn_ratelimited("%s: Warning: port of slave %s is uninitialized\n",
+ 					    slave->dev->name, slave->bond->dev->name);
++>>>>>>> 86a2b9cfccea (bonding: ratelimit pr_warn()s in 802.3ad mode)
  			return ret;
  		}
  
* Unmerged path drivers/net/bonding/bond_3ad.c
