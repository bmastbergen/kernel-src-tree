iommu/vt-d: Fix VM domain ID leak

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
Rebuild_CHGLOG: - [iommu] vt-d: Fix VM domain ID leak (Alex Williamson) [1242331]
Rebuild_FUZZ: 90.00%
commit-author Alex Williamson <alex.williamson@redhat.com>
commit 46ebb7af7b93792de65e124e1ab8b89a108a41f2
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/46ebb7af.failed

This continues the attempt to fix commit fb170fb4c548 ("iommu/vt-d:
Introduce helper functions to make code symmetric for readability").
The previous attempt in commit 71684406905f ("iommu/vt-d: Detach
domain *only* from attached iommus") overlooked the fact that
dmar_domain.iommu_bmp gets cleared for VM domains when devices are
detached:

intel_iommu_detach_device
  domain_remove_one_dev_info
    domain_detach_iommu

The domain is detached from the iommu, but the iommu is still attached
to the domain, for whatever reason.  Thus when we get to domain_exit(),
we can't rely on iommu_bmp for VM domains to find the active iommus,
we must check them all.  Without that, the corresponding bit in
intel_iommu.domain_ids doesn't get cleared and repeated VM domain
creation and destruction will run out of domain IDs.  Meanwhile we
still can't call iommu_detach_domain() on arbitrary non-VM domains or
we risk clearing in-use domain IDs, as 71684406905f attempted to
address.

It's tempting to modify iommu_detach_domain() to test the domain
iommu_bmp, but the call ordering from domain_remove_one_dev_info()
prevents it being able to work as fb170fb4c548 seems to have intended.
Caching of unused VM domains on the iommu object seems to be the root
of the problem, but this code is far too fragile for that kind of
rework to be proposed for stable, so we simply revert this chunk to
its state prior to fb170fb4c548.

Fixes: fb170fb4c548 ("iommu/vt-d: Introduce helper functions to make
                      code symmetric for readability")
Fixes: 71684406905f ("iommu/vt-d: Detach domain *only* from attached
                      iommus")
	Signed-off-by: Alex Williamson <alex.williamson@redhat.com>
	Cc: Jiang Liu <jiang.liu@linux.intel.com>
	Cc: stable@vger.kernel.org # v3.17+
	Signed-off-by: Joerg Roedel <jroedel@suse.de>
(cherry picked from commit 46ebb7af7b93792de65e124e1ab8b89a108a41f2)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/iommu/intel-iommu.c
diff --cc drivers/iommu/intel-iommu.c
index 9cb753b363f2,0649b94f5958..000000000000
--- a/drivers/iommu/intel-iommu.c
+++ b/drivers/iommu/intel-iommu.c
@@@ -1743,8 -1831,8 +1743,11 @@@ static int domain_init(struct dmar_doma
  static void domain_exit(struct dmar_domain *domain)
  {
  	struct dmar_drhd_unit *drhd;
++<<<<<<< HEAD
++=======
+ 	struct intel_iommu *iommu;
++>>>>>>> 46ebb7af7b93 (iommu/vt-d: Fix VM domain ID leak)
  	struct page *freelist = NULL;
- 	int i;
  
  	/* Domain 0 is reserved, so dont process it */
  	if (!domain)
* Unmerged path drivers/iommu/intel-iommu.c
