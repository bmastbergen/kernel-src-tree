mac80211: fix the beacon csa counter for mesh and ibss

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
commit-author Chun-Yeow Yeoh <yeohchunyeow@gmail.com>
commit 8df734e865b74d9f273216482a45a38269dc767a
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/8df734e8.failed

The csa counter has moved from sdata to beacon/presp but
it is not updated accordingly for mesh and ibss. Fix this.

Fixes: af296bdb8da4 ("mac80211: move csa counters from sdata to beacon/presp")
	Signed-off-by: Chun-Yeow Yeoh <yeohchunyeow@gmail.com>
	Signed-off-by: Johannes Berg <johannes.berg@intel.com>
(cherry picked from commit 8df734e865b74d9f273216482a45a38269dc767a)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/mac80211/mesh.c
diff --cc net/mac80211/mesh.c
index e64982ce0f8f,817098add1d6..000000000000
--- a/net/mac80211/mesh.c
+++ b/net/mac80211/mesh.c
@@@ -679,7 -680,8 +679,12 @@@ ieee80211_mesh_build_beacon(struct ieee
  		*pos++ = 0x0;
  		*pos++ = ieee80211_frequency_to_channel(
  				csa->settings.chandef.chan->center_freq);
++<<<<<<< HEAD
 +		sdata->csa_counter_offset_beacon[0] = hdr_len + 6;
++=======
+ 		bcn->csa_current_counter = csa->settings.count;
+ 		bcn->csa_counter_offsets[0] = hdr_len + 6;
++>>>>>>> 8df734e865b7 (mac80211: fix the beacon csa counter for mesh and ibss)
  		*pos++ = csa->settings.count;
  		*pos++ = WLAN_EID_CHAN_SWITCH_PARAM;
  		*pos++ = 6;
diff --git a/net/mac80211/cfg.c b/net/mac80211/cfg.c
index 592f4b152ba8..46f9ccc9cad1 100644
--- a/net/mac80211/cfg.c
+++ b/net/mac80211/cfg.c
@@ -3515,6 +3515,7 @@ static int ieee80211_mgmt_tx(struct wiphy *wiphy, struct wireless_dev *wdev,
 	/* Update CSA counters */
 	if (sdata->vif.csa_active &&
 	    (sdata->vif.type == NL80211_IFTYPE_AP ||
+	     sdata->vif.type == NL80211_IFTYPE_MESH_POINT ||
 	     sdata->vif.type == NL80211_IFTYPE_ADHOC) &&
 	    params->n_csa_offsets) {
 		int i;
diff --git a/net/mac80211/ibss.c b/net/mac80211/ibss.c
index 851bbf156a8f..dbc20adc52d3 100644
--- a/net/mac80211/ibss.c
+++ b/net/mac80211/ibss.c
@@ -145,6 +145,7 @@ ieee80211_ibss_build_presp(struct ieee80211_sub_if_data *sdata,
 				csa_settings->chandef.chan->center_freq);
 		sdata->csa_counter_offset_beacon[0] = (pos - presp->head);
 		*pos++ = csa_settings->count;
+		presp->csa_current_counter = csa_settings->count;
 	}
 
 	/* put the remaining rates in WLAN_EID_EXT_SUPP_RATES */
* Unmerged path net/mac80211/mesh.c
