Input: synaptics - handle spurious release of trackstick buttons

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
Rebuild_CHGLOG: - [input] mouse: synaptics - handle spurious release of trackstick buttons (Benjamin Tissoires) [1186106 1186112]
Rebuild_FUZZ: 93.75%
commit-author Benjamin Tissoires <benjamin.tissoires@redhat.com>
commit ebc80840b850db72f7ae84fbcf77630ae5409629
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/ebc80840.failed

The Fimware 8.1 has a bug in which the extra buttons are only sent when the
ExtBit is 1.  This should be fixed in a future FW update which should have
a bump of the minor version.

	Cc: stable@vger.kernel.org
	Signed-off-by: Benjamin Tissoires <benjamin.tissoires@redhat.com>
	Acked-by: Hans de Goede <hdegoede@redhat.com>
	Signed-off-by: Dmitry Torokhov <dmitry.torokhov@gmail.com>
(cherry picked from commit ebc80840b850db72f7ae84fbcf77630ae5409629)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/input/mouse/synaptics.c
diff --cc drivers/input/mouse/synaptics.c
index a5e38586d8ba,2f42a712f3e0..000000000000
--- a/drivers/input/mouse/synaptics.c
+++ b/drivers/input/mouse/synaptics.c
@@@ -768,6 -820,30 +768,29 @@@ static void synaptics_report_semi_mt_da
  	}
  }
  
+ static void synaptics_report_ext_buttons(struct psmouse *psmouse,
+ 					 const struct synaptics_hw_state *hw)
+ {
+ 	struct input_dev *dev = psmouse->dev;
+ 	struct synaptics_data *priv = psmouse->private;
 -	int ext_bits = (SYN_CAP_MULTI_BUTTON_NO(priv->ext_cap) + 1) >> 1;
+ 	int i;
+ 
+ 	if (!SYN_CAP_MULTI_BUTTON_NO(priv->ext_cap))
+ 		return;
+ 
+ 	/* Bug in FW 8.1, buttons are reported only when ExtBit is 1 */
+ 	if (SYN_ID_FULL(priv->identity) == 0x801 &&
+ 	    !((psmouse->packet[0] ^ psmouse->packet[3]) & 0x02))
+ 		return;
+ 
+ 	for (i = 0; i < ext_bits; i++) {
+ 		input_report_key(dev, BTN_0 + 2 * i,
+ 			hw->ext_buttons & (1 << i));
+ 		input_report_key(dev, BTN_1 + 2 * i,
+ 			hw->ext_buttons & (1 << (i + ext_bits)));
+ 	}
+ }
+ 
  static void synaptics_report_buttons(struct psmouse *psmouse,
  				     const struct synaptics_hw_state *hw)
  {
@@@ -786,8 -861,7 +808,12 @@@
  		input_report_key(dev, BTN_BACK, hw->down);
  	}
  
++<<<<<<< HEAD
 +	for (i = 0; i < SYN_CAP_MULTI_BUTTON_NO(priv->ext_cap); i++)
 +		input_report_key(dev, BTN_0 + i, hw->ext_buttons & (1 << i));
++=======
+ 	synaptics_report_ext_buttons(psmouse, hw);
++>>>>>>> ebc80840b850 (Input: synaptics - handle spurious release of trackstick buttons)
  }
  
  static void synaptics_report_slot(struct input_dev *dev, int slot,
* Unmerged path drivers/input/mouse/synaptics.c
