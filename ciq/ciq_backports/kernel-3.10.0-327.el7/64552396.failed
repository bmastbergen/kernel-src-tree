perf/x86/intel/rapl: Fix energy counter measurements but supporing per domain energy units

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
Rebuild_CHGLOG: - [perf] x86/intel/rapl: Fix energy counter measurements but supporing per domain energy units (Jiri Olsa) [1222189]
Rebuild_FUZZ: 97.14%
commit-author Jacob Pan <jacob.jun.pan@linux.intel.com>
commit 645523960102fa0ac0578d070630e49ab05f06d1
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/64552396.failed

RAPL energy hardware unit can vary within a single CPU package, e.g.
HSW server DRAM has a fixed energy unit of 15.3 uJ (2^-16) whereas
the unit on other domains can be enumerated from power unit MSR.

There might be other variations in the future, this patch adds
per cpu model quirk to allow special handling of certain cpus.

hw_unit is also removed from per cpu data since it is not per cpu
and the sampling rate for energy counter is typically not high.

Without this patch, DRAM domain on HSW servers will be counted
4x higher than the real energy counter.

	Signed-off-by: Jacob Pan <jacob.jun.pan@linux.intel.com>
	Signed-off-by: Peter Zijlstra (Intel) <peterz@infradead.org>
	Reviewed-by: Stephane Eranian <eranian@google.com>
	Cc: Andi Kleen <andi.kleen@intel.com>
	Cc: Arnaldo Carvalho de Melo <acme@kernel.org>
	Cc: H. Peter Anvin <hpa@zytor.com>
	Cc: Paul Mackerras <paulus@samba.org>
	Cc: Thomas Gleixner <tglx@linutronix.de>
	Cc: Vince Weaver <vincent.weaver@maine.edu>
Link: http://lkml.kernel.org/r/1427405325-780-1-git-send-email-jacob.jun.pan@linux.intel.com
	Signed-off-by: Ingo Molnar <mingo@kernel.org>
(cherry picked from commit 645523960102fa0ac0578d070630e49ab05f06d1)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kernel/cpu/perf_event_intel_rapl.c
diff --cc arch/x86/kernel/cpu/perf_event_intel_rapl.c
index 99665819deeb,999289b94025..000000000000
--- a/arch/x86/kernel/cpu/perf_event_intel_rapl.c
+++ b/arch/x86/kernel/cpu/perf_event_intel_rapl.c
@@@ -142,7 -164,7 +164,11 @@@ static inline u64 rapl_scale(u64 v, in
  	 * or use ldexp(count, -32).
  	 * Watts = Joules/Time delta
  	 */
++<<<<<<< HEAD
 +	return v << (32 - __get_cpu_var(rapl_pmu)->hw_unit);
++=======
+ 	return v << (32 - rapl_hw_unit[cfg - 1]);
++>>>>>>> 645523960102 (perf/x86/intel/rapl: Fix energy counter measurements but supporing per domain energy units)
  }
  
  static u64 rapl_event_update(struct perf_event *event)
@@@ -716,9 -760,9 +768,9 @@@ static int __init rapl_pmu_init(void
  		return -1;
  	}
  
 -	pmu = __this_cpu_read(rapl_pmu);
 +	pmu = __get_cpu_var(rapl_pmu);
  
- 	pr_info("RAPL PMU detected, hw unit 2^-%d Joules,"
+ 	pr_info("RAPL PMU detected,"
  		" API unit is 2^-32 Joules,"
  		" %d fixed counters"
  		" %llu ms ovfl timer\n",
* Unmerged path arch/x86/kernel/cpu/perf_event_intel_rapl.c
