ceph: fix dcache/nocache mount option

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
commit-author Yan, Zheng <zyan@redhat.com>
commit e2c3de046c5a1f3525772b4cacc7731cb626ab61
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/e2c3de04.failed

	Signed-off-by: Yan, Zheng <zyan@redhat.com>
(cherry picked from commit e2c3de046c5a1f3525772b4cacc7731cb626ab61)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/ceph/dir.c
diff --cc fs/ceph/dir.c
index e7ea638f2428,92a6b6018511..000000000000
--- a/fs/ceph/dir.c
+++ b/fs/ceph/dir.c
@@@ -288,10 -280,11 +288,15 @@@ static int ceph_readdir(struct file *fi
  
  	/* can we use the dcache? */
  	spin_lock(&ci->i_ceph_lock);
++<<<<<<< HEAD
 +	if ((filp->f_pos == 2 || fi->dentry) &&
++=======
+ 	if ((ctx->pos == 2 || fi->dentry) &&
+ 	    ceph_test_mount_opt(fsc, DCACHE) &&
++>>>>>>> e2c3de046c5a (ceph: fix dcache/nocache mount option)
  	    !ceph_test_mount_opt(fsc, NOASYNCREADDIR) &&
  	    ceph_snap(inode) != CEPH_SNAPDIR &&
 -	    __ceph_dir_is_complete_ordered(ci) &&
 +	    __ceph_dir_is_complete(ci) &&
  	    __ceph_caps_issued_mask(ci, CEPH_CAP_FILE_SHARED, 1)) {
  		u32 shared_gen = ci->i_shared_gen;
  		spin_unlock(&ci->i_ceph_lock);
* Unmerged path fs/ceph/dir.c
diff --git a/fs/ceph/super.h b/fs/ceph/super.h
index a446e2b2d462..ee6dcc8b472c 100644
--- a/fs/ceph/super.h
+++ b/fs/ceph/super.h
@@ -30,7 +30,8 @@
 #define CEPH_MOUNT_OPT_INO32           (1<<8) /* 32 bit inos */
 #define CEPH_MOUNT_OPT_DCACHE          (1<<9) /* use dcache for readdir etc */
 
-#define CEPH_MOUNT_OPT_DEFAULT    (CEPH_MOUNT_OPT_RBYTES)
+#define CEPH_MOUNT_OPT_DEFAULT    (CEPH_MOUNT_OPT_RBYTES | \
+				   CEPH_MOUNT_OPT_DCACHE)
 
 #define ceph_set_mount_opt(fsc, opt) \
 	(fsc)->mount_options->flags |= CEPH_MOUNT_OPT_##opt;
