hpsa: cleanup for init_one step 2 in kdump

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
commit-author Robert Elliott <elliott@hp.com>
commit 9ecd953aa8b07819af0f1f561f52cb4bd43e8735
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/9ecd953a.failed

In hpsa_undo_allocations_after_kdump_soft_reset,
the things allocated in hpsa_init_one step 2 -
h->resubmit_wq and h->lockup_detected  need to
be freed, in the right order.

	Reviewed-by: Scott Teel <scott.teel@pmcs.com>
	Reviewed-by: Kevin Barnett <kevin.barnett@pmcs.com>
	Reviewed-by: Tomas Henzl <thenzl@redhat.com>
	Reviewed-by: Hannes Reinecke <hare@Suse.de>
	Signed-off-by: Robert Elliott <elliott@hp.com>
	Signed-off-by: Don Brace <don.brace@pmcs.com>
	Reviewed-by: Christoph Hellwig <hch@lst.de>
	Signed-off-by: James Bottomley <JBottomley@Odin.com>
(cherry picked from commit 9ecd953aa8b07819af0f1f561f52cb4bd43e8735)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/hpsa.c
diff --cc drivers/scsi/hpsa.c
index 90f94892d231,1979b7e45c93..000000000000
--- a/drivers/scsi/hpsa.c
+++ b/drivers/scsi/hpsa.c
@@@ -6508,19 -7371,22 +6508,38 @@@ static void hpsa_free_reply_queues(stru
  
  static void hpsa_undo_allocations_after_kdump_soft_reset(struct ctlr_info *h)
  {
++<<<<<<< HEAD
 +	hpsa_free_irqs(h);
 +	hpsa_free_sg_chain_blocks(h);
 +	hpsa_free_cmd_pool(h);
 +	kfree(h->blockFetchTable);		/* perf 2 */
 +	hpsa_free_reply_queues(h);		/* perf 1 */
 +	hpsa_free_ioaccel1_cmd_and_bft(h);	/* perf 1 */
 +	hpsa_free_ioaccel2_cmd_and_bft(h);	/* perf 1 */
 +	hpsa_free_cfgtables(h);			/* pci_init 4 */
 +	iounmap(h->vaddr);			/* pci_init 3 */
 +	hpsa_disable_interrupt_mode(h);		/* pci_init 2 */
 +	pci_disable_device(h->pdev);
 +	pci_release_regions(h->pdev);		/* pci_init 2 */
 +	kfree(h);
++=======
+ 	hpsa_free_performant_mode(h);		/* init_one 7 */
+ 	hpsa_free_sg_chain_blocks(h);		/* init_one 6 */
+ 	hpsa_free_cmd_pool(h);			/* init_one 5 */
+ 	hpsa_free_irqs(h);			/* init_one 4 */
+ 	hpsa_free_pci_init(h);			/* init_one 3 */
+ 	free_percpu(h->lockup_detected);	/* init_one 2 */
+ 	h->lockup_detected = NULL;		/* init_one 2 */
+ 	if (h->resubmit_wq) {
+ 		destroy_workqueue(h->resubmit_wq);	/* init_one 1 */
+ 		h->resubmit_wq = NULL;
+ 	}
+ 	if (h->rescan_ctlr_wq) {
+ 		destroy_workqueue(h->rescan_ctlr_wq);
+ 		h->rescan_ctlr_wq = NULL;
+ 	}
+ 	kfree(h);				/* init_one 1 */
++>>>>>>> 9ecd953aa8b0 (hpsa: cleanup for init_one step 2 in kdump)
  }
  
  /* Called when controller lockup detected. */
* Unmerged path drivers/scsi/hpsa.c
