powerpc/powernv: Merge common platform device initialisation

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
Rebuild_CHGLOG: - [powerpc] powernv: Merge common platform device initialisation (Gustavo Duarte) [1221110 1229224]
Rebuild_FUZZ: 92.86%
commit-author Jeremy Kerr <jk@ozlabs.org>
commit 48c06154952a18c5cd4d074ec3de627430cb6d23
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/48c06154.failed

opal_ipmi_init and opal_flash_init are equivalent, except for the
compatbile string. Merge these two into a common opal_pdev_init
function.

	Signed-off-by: Jeremy Kerr <jk@ozlabs.org>
	Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
(cherry picked from commit 48c06154952a18c5cd4d074ec3de627430cb6d23)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/powerpc/platforms/powernv/opal.c
diff --cc arch/powerpc/platforms/powernv/opal.c
index b32c77b1797c,fdce840f0006..000000000000
--- a/arch/powerpc/platforms/powernv/opal.c
+++ b/arch/powerpc/platforms/powernv/opal.c
@@@ -592,6 -599,51 +592,54 @@@ static void __init opal_dump_region_ini
  		pr_warn("DUMP: Failed to register kernel log buffer. "
  			"rc = %d\n", rc);
  }
++<<<<<<< HEAD
++=======
+ 
+ static void opal_pdev_init(struct device_node *opal_node,
+ 		const char *compatible)
+ {
+ 	struct device_node *np;
+ 
+ 	for_each_child_of_node(opal_node, np)
+ 		if (of_device_is_compatible(np, compatible))
+ 			of_platform_device_create(np, NULL, NULL);
+ }
+ 
+ static void opal_i2c_create_devs(void)
+ {
+ 	struct device_node *np;
+ 
+ 	for_each_compatible_node(np, NULL, "ibm,opal-i2c")
+ 		of_platform_device_create(np, NULL, NULL);
+ }
+ 
+ static int kopald(void *unused)
+ {
+ 	__be64 events;
+ 
+ 	set_freezable();
+ 	do {
+ 		try_to_freeze();
+ 		opal_poll_events(&events);
+ 		opal_handle_events(be64_to_cpu(events));
+ 		msleep_interruptible(opal_heartbeat);
+ 	} while (!kthread_should_stop());
+ 
+ 	return 0;
+ }
+ 
+ static void opal_init_heartbeat(void)
+ {
+ 	/* Old firwmware, we assume the HVC heartbeat is sufficient */
+ 	if (of_property_read_u32(opal_node, "ibm,heartbeat-ms",
+ 				 &opal_heartbeat) != 0)
+ 		opal_heartbeat = 0;
+ 
+ 	if (opal_heartbeat)
+ 		kthread_run(kopald, NULL, "kopald");
+ }
+ 
++>>>>>>> 48c06154952a (powerpc/powernv: Merge common platform device initialisation)
  static int __init opal_init(void)
  {
  	struct device_node *np, *consoles;
@@@ -655,6 -709,10 +703,13 @@@
  		opal_msglog_init();
  	}
  
++<<<<<<< HEAD
++=======
+ 	/* Initialize platform devices: IPMI backend & flash interface */
+ 	opal_pdev_init(opal_node, "ibm,opal-ipmi");
+ 	opal_pdev_init(opal_node, "ibm,opal-flash");
+ 
++>>>>>>> 48c06154952a (powerpc/powernv: Merge common platform device initialisation)
  	return 0;
  }
  machine_subsys_initcall(powernv, opal_init);
* Unmerged path arch/powerpc/platforms/powernv/opal.c
