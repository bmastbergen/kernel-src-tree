userns: Don't allow unprivileged creation of gid mappings

jira LE-1907
cve CVE-2014-8989
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
Rebuild_CHGLOG: - [kernel] userns: Don't allow unprivileged creation of gid mappings ("Eric W. Biederman") [1138782 1170689] {CVE-2014-8989}
Rebuild_FUZZ: 99.13%
commit-author Eric W. Biederman <ebiederm@xmission.com>
commit be7c6dba2332cef0677fbabb606e279ae76652c3
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/be7c6dba.failed

As any gid mapping will allow and must allow for backwards
compatibility dropping groups don't allow any gid mappings to be
established without CAP_SETGID in the parent user namespace.

For a small class of applications this change breaks userspace
and removes useful functionality.  This small class of applications
includes tools/testing/selftests/mount/unprivilged-remount-test.c

Most of the removed functionality will be added back with the addition
of a one way knob to disable setgroups.  Once setgroups is disabled
setting the gid_map becomes as safe as setting the uid_map.

For more common applications that set the uid_map and the gid_map
with privilege this change will have no affect.

This is part of a fix for CVE-2014-8989.

	Cc: stable@vger.kernel.org
	Reviewed-by: Andy Lutomirski <luto@amacapital.net>
	Signed-off-by: "Eric W. Biederman" <ebiederm@xmission.com>
(cherry picked from commit be7c6dba2332cef0677fbabb606e279ae76652c3)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	kernel/user_namespace.c
diff --cc kernel/user_namespace.c
index 4c18c0aeb2f0,1ce6d67c07b7..000000000000
--- a/kernel/user_namespace.c
+++ b/kernel/user_namespace.c
@@@ -814,11 -821,6 +814,14 @@@ static bool new_idmap_permitted(const s
  			kuid_t uid = make_kuid(ns->parent, id);
  			if (uid_eq(uid, file->f_cred->fsuid))
  				return true;
++<<<<<<< HEAD
 +		}
 +		else if (cap_setid == CAP_SETGID) {
 +			kgid_t gid = make_kgid(ns->parent, id);
 +			if (gid_eq(gid, file->f_cred->fsgid))
 +				return true;
++=======
++>>>>>>> be7c6dba2332 (userns: Don't allow unprivileged creation of gid mappings)
  		}
  	}
  
* Unmerged path kernel/user_namespace.c
