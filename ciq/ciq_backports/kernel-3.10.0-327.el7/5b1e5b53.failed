Drivers: hv: vmbus: Remove the channel from the channel list(s) on failure

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
Rebuild_CHGLOG: - [hv] vmbus: Remove the channel from the channel list(s) on failure (Vitaly Kuznetsov) [1203682]
Rebuild_FUZZ: 90.37%
commit-author K. Y. Srinivasan <kys@microsoft.com>
commit 5b1e5b530753e660080d402b81b88684893157d5
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/5b1e5b53.failed

Properly rollback state in vmbus_pocess_offer() in the failure paths.

	Signed-off-by: K. Y. Srinivasan <kys@microsoft.com>
	Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
(cherry picked from commit 5b1e5b530753e660080d402b81b88684893157d5)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/hv/channel_mgmt.c
diff --cc drivers/hv/channel_mgmt.c
index f9943186ea53,b1e5a5fdaf7f..000000000000
--- a/drivers/hv/channel_mgmt.c
+++ b/drivers/hv/channel_mgmt.c
@@@ -376,14 -398,26 +376,29 @@@ static void vmbus_process_offer(struct 
  		pr_err("unable to add child device object (relid %d)\n",
  			   newchannel->offermsg.child_relid);
  
- 		spin_lock_irqsave(&vmbus_connection.channel_lock, flags);
- 		list_del(&newchannel->listentry);
- 		spin_unlock_irqrestore(&vmbus_connection.channel_lock, flags);
  		kfree(newchannel->device_obj);
- 		goto err_free_chan;
+ 		goto err_deq_chan;
  	}
 -
 +out:
  	return;
++<<<<<<< HEAD
++=======
+ 
+ err_deq_chan:
+ 	spin_lock_irqsave(&vmbus_connection.channel_lock, flags);
+ 	list_del(&newchannel->listentry);
+ 	spin_unlock_irqrestore(&vmbus_connection.channel_lock, flags);
+ 
+ 	if (newchannel->target_cpu != get_cpu()) {
+ 		put_cpu();
+ 		smp_call_function_single(newchannel->target_cpu,
+ 					 percpu_channel_deq, newchannel, true);
+ 	} else {
+ 		percpu_channel_deq(newchannel);
+ 		put_cpu();
+ 	}
+ 
++>>>>>>> 5b1e5b530753 (Drivers: hv: vmbus: Remove the channel from the channel list(s) on failure)
  err_free_chan:
  	free_channel(newchannel);
  }
* Unmerged path drivers/hv/channel_mgmt.c
