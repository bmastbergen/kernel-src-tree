mlx4_core: Fix fallback from MSI-X to INTx

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
commit-author Benjamin Poirier <bpoirier@suse.de>
commit f4ecf29fd78d19a9301e638eaa1419e5c8fbdce1
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/f4ecf29f.failed

The test in mlx4_load_one() to remove MLX4_FLAG_MSI_X expects mlx4_NOP() to
fail with -EBUSY. It is also necessary to avoid the reset since the device
is not fully reinitialized before calling mlx4_start_hca() a second time.

Note that this will also affect mlx4_test_interrupts(), the only other user
of MLX4_CMD_NOP.

Fixes: f5aef5a ("net/mlx4_core: Activate reset flow upon fatal command cases")
	Signed-off-by: Benjamin Poirier <bpoirier@suse.de>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit f4ecf29fd78d19a9301e638eaa1419e5c8fbdce1)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlx4/cmd.c
diff --cc drivers/net/ethernet/mellanox/mlx4/cmd.c
index bdca055a820e,529ef0594b90..000000000000
--- a/drivers/net/ethernet/mellanox/mlx4/cmd.c
+++ b/drivers/net/ethernet/mellanox/mlx4/cmd.c
@@@ -574,8 -714,13 +574,18 @@@ static int mlx4_cmd_wait(struct mlx4_de
  					 msecs_to_jiffies(timeout))) {
  		mlx4_warn(dev, "command 0x%x timed out (go bit not cleared)\n",
  			  op);
++<<<<<<< HEAD
 +		err = -EBUSY;
 +		goto out;
++=======
+ 		if (op == MLX4_CMD_NOP) {
+ 			err = -EBUSY;
+ 			goto out;
+ 		} else {
+ 			err = -EIO;
+ 			goto out_reset;
+ 		}
++>>>>>>> f4ecf29fd78d (mlx4_core: Fix fallback from MSI-X to INTx)
  	}
  
  	err = context->result;
* Unmerged path drivers/net/ethernet/mellanox/mlx4/cmd.c
