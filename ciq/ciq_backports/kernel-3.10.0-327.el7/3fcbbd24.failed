nfsd: ensure that delegation stateid hash references are only put once

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
commit-author Jeff Layton <jlayton@poochiereds.net>
commit 3fcbbd244ed1d20dc0eb7d48d729503992fa9b7d
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/3fcbbd24.failed

It's possible that a DELEGRETURN could race with (e.g.) client expiry,
in which case we could end up putting the delegation hash reference more
than once.

Have unhash_delegation_locked return a bool that indicates whether it
was already unhashed. In the case of destroy_delegation we only
conditionally put the hash reference if that returns true.

The other callers of unhash_delegation_locked call it while walking
list_heads that shouldn't yet be detached. If we find that it doesn't
return true in those cases, then throw a WARN_ON as that indicates that
we have a partially hashed delegation, and that something is likely very
wrong.

	Tested-by: Andrew W Elble <aweits@rit.edu>
	Tested-by: Anna Schumaker <Anna.Schumaker@netapp.com>
	Signed-off-by: Jeff Layton <jeff.layton@primarydata.com>
	Cc: stable@vger.kernel.org
	Signed-off-by: J. Bruce Fields <bfields@redhat.com>
(cherry picked from commit 3fcbbd244ed1d20dc0eb7d48d729503992fa9b7d)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/nfsd/nfs4state.c
diff --cc fs/nfsd/nfs4state.c
index f5d6dfdbfcd3,416f32e34a33..000000000000
--- a/fs/nfsd/nfs4state.c
+++ b/fs/nfsd/nfs4state.c
@@@ -724,11 -800,16 +728,21 @@@ unhash_delegation_locked(struct nfs4_de
  
  static void destroy_delegation(struct nfs4_delegation *dp)
  {
+ 	bool unhashed;
+ 
  	spin_lock(&state_lock);
- 	unhash_delegation_locked(dp);
+ 	unhashed = unhash_delegation_locked(dp);
  	spin_unlock(&state_lock);
++<<<<<<< HEAD
 +	nfs4_put_deleg_lease(dp->dl_stid.sc_file);
 +	nfs4_put_stid(&dp->dl_stid);
++=======
+ 	if (unhashed) {
+ 		put_clnt_odstate(dp->dl_clnt_odstate);
+ 		nfs4_put_deleg_lease(dp->dl_stid.sc_file);
+ 		nfs4_put_stid(&dp->dl_stid);
+ 	}
++>>>>>>> 3fcbbd244ed1 (nfsd: ensure that delegation stateid hash references are only put once)
  }
  
  static void revoke_delegation(struct nfs4_delegation *dp)
* Unmerged path fs/nfsd/nfs4state.c
