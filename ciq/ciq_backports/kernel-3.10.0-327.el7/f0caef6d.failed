IB/iser: Terminate connection before cleaning inflight tasks

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
Rebuild_CHGLOG: - [infiniband] iser: Terminate connection before cleaning inflight tasks (Amir Vadai) [1164539]
Rebuild_FUZZ: 97.44%
commit-author Sagi Grimberg <sagig@mellanox.com>
commit f0caef6d407bf0fc8dfba5cddf7318170187f194
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/f0caef6d.failed

When closing the connection, we should first terminate the connection
(in case it was not previously terminated) to guarantee the QP is in
error state and we are done with servicing IO. Only then go ahead with
tasks cleanup via iscsi_conn_stop.

	Signed-off-by: Sagi Grimberg <sagig@mellanox.com>
	Signed-off-by: Or Gerlitz <ogerlitz@mellanox.com>
	Signed-off-by: Roland Dreier <roland@purestorage.com>
(cherry picked from commit f0caef6d407bf0fc8dfba5cddf7318170187f194)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/ulp/iser/iscsi_iser.c
diff --cc drivers/infiniband/ulp/iser/iscsi_iser.c
index 9e53334ea7c7,0af32cdb34a1..000000000000
--- a/drivers/infiniband/ulp/iser/iscsi_iser.c
+++ b/drivers/infiniband/ulp/iser/iscsi_iser.c
@@@ -503,9 -539,19 +503,19 @@@ iscsi_iser_conn_stop(struct iscsi_cls_c
  	 * Userspace may have goofed up and not bound the connection or
  	 * might have only partially setup the connection.
  	 */
++<<<<<<< HEAD
 +	if (ib_conn) {
++=======
+ 	if (iser_conn) {
+ 		mutex_lock(&iser_conn->state_mutex);
+ 		iser_conn_terminate(iser_conn);
+ 		iscsi_conn_stop(cls_conn, flag);
+ 
+ 		/* unbind */
+ 		iser_conn->iscsi_conn = NULL;
++>>>>>>> f0caef6d407b (IB/iser: Terminate connection before cleaning inflight tasks)
  		conn->dd_data = NULL;
 -
 -		complete(&iser_conn->stop_completion);
 -		mutex_unlock(&iser_conn->state_mutex);
 -	} else {
 -		iscsi_conn_stop(cls_conn, flag);
 +		complete(&ib_conn->stop_completion);
  	}
  }
  
* Unmerged path drivers/infiniband/ulp/iser/iscsi_iser.c
