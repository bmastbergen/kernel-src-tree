userns: limit the maximum depth of user_namespace->parent chain

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
commit-author Oleg Nesterov <oleg@redhat.com>
commit 8742f229b635bf1c1c84a3dfe5e47c814c20b5c8
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/8742f229.failed

Ensure that user_namespace->parent chain can't grow too much.
Currently we use the hardroded 32 as limit.

	Reported-by: Andy Lutomirski <luto@amacapital.net>
	Signed-off-by: Oleg Nesterov <oleg@redhat.com>
	Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
(cherry picked from commit 8742f229b635bf1c1c84a3dfe5e47c814c20b5c8)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	kernel/user_namespace.c
diff --cc kernel/user_namespace.c
index 536ecfbaf4d7,9064b919a406..000000000000
--- a/kernel/user_namespace.c
+++ b/kernel/user_namespace.c
@@@ -62,8 -62,8 +62,13 @@@ int create_user_ns(struct cred *new
  	kgid_t group = new->egid;
  	int ret;
  
++<<<<<<< HEAD
 +	/* Currently disabled in RHEL7 */
 +	return -EINVAL;
++=======
+ 	if (parent_ns->level > 32)
+ 		return -EUSERS;
++>>>>>>> 8742f229b635 (userns: limit the maximum depth of user_namespace->parent chain)
  
  	/*
  	 * Verify that we can not violate the policy of which files
diff --git a/include/linux/user_namespace.h b/include/linux/user_namespace.h
index cf21958a4945..81525ce2441a 100644
--- a/include/linux/user_namespace.h
+++ b/include/linux/user_namespace.h
@@ -23,6 +23,7 @@ struct user_namespace {
 	struct uid_gid_map	projid_map;
 	atomic_t		count;
 	struct user_namespace	*parent;
+	int			level;
 	kuid_t			owner;
 	kgid_t			group;
 	unsigned int		proc_inum;
* Unmerged path kernel/user_namespace.c
