igb: flush when in xmit_more mode and under descriptor pressure

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
commit-author David S. Miller <davem@davemloft.net>
commit 6f19e12f623067d6a330748f932ca4a81b828ffb
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/6f19e12f.failed

Mirror the changes made to ixgbe in commit 2367a17390138f68b3aa28f2f220b8d7ff8d91f4
("ixgbe: flush when in xmit_more mode and under descriptor pressure")

	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 6f19e12f623067d6a330748f932ca4a81b828ffb)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/intel/igb/igb_main.c
diff --cc drivers/net/ethernet/intel/igb/igb_main.c
index cca298badddb,89de7fee5e94..000000000000
--- a/drivers/net/ethernet/intel/igb/igb_main.c
+++ b/drivers/net/ethernet/intel/igb/igb_main.c
@@@ -4915,13 -4950,17 +4950,21 @@@ static void igb_tx_map(struct igb_ring 
  
  	tx_ring->next_to_use = i;
  
++<<<<<<< HEAD
 +	writel(i, tx_ring->tail);
 +
 +	/* we need this if more than one processor can write to our tail
 +	 * at a time, it synchronizes IO on IA64/Altix systems
 +	 */
 +	mmiowb();
++=======
+ 	/* Make sure there is space in the ring for the next send. */
+ 	igb_maybe_stop_tx(tx_ring, DESC_NEEDED);
+ 
+ 	if (netif_xmit_stopped(txring_txq(tx_ring)) || !skb->xmit_more) {
+ 		writel(i, tx_ring->tail);
++>>>>>>> 6f19e12f6230 (igb: flush when in xmit_more mode and under descriptor pressure)
  
 -		/* we need this if more than one processor can write to our tail
 -		 * at a time, it synchronizes IO on IA64/Altix systems
 -		 */
 -		mmiowb();
 -	}
  	return;
  
  dma_error:
* Unmerged path drivers/net/ethernet/intel/igb/igb_main.c
