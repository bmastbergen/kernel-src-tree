net: Verify permission to link_net in newlink

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
Rebuild_CHGLOG: - [net] Verify permission to link_net in newlink (Jiri Benc) [1210260]
Rebuild_FUZZ: 94.12%
commit-author Eric W. Biederman <ebiederm@xmission.com>
commit 06615bed60c1fb7c37adddb75bdc80da873b5edb
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/06615bed.failed

When applicable verify that the caller has permisson to the underlying
network namespace for a newly created network device.

Similary checks exist for the network namespace a network device will
be created in.

Fixes: 317f4810e45e ("rtnl: allow to create device with IFLA_LINK_NETNSID set")
	Signed-off-by: "Eric W. Biederman" <ebiederm@xmission.com>
	Acked-by: Nicolas Dichtel <nicolas.dichtel@6wind.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 06615bed60c1fb7c37adddb75bdc80da873b5edb)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/core/rtnetlink.c
diff --cc net/core/rtnetlink.c
index 187818c8949a,2c49355d16c2..000000000000
--- a/net/core/rtnetlink.c
+++ b/net/core/rtnetlink.c
@@@ -1911,7 -2122,25 +1911,29 @@@ replay
  		if (IS_ERR(dest_net))
  			return PTR_ERR(dest_net);
  
++<<<<<<< HEAD
 +		dev = rtnl_create_link(dest_net, ifname, ops, tb);
++=======
+ 		err = -EPERM;
+ 		if (!netlink_ns_capable(skb, dest_net->user_ns, CAP_NET_ADMIN))
+ 			goto out;
+ 
+ 		if (tb[IFLA_LINK_NETNSID]) {
+ 			int id = nla_get_s32(tb[IFLA_LINK_NETNSID]);
+ 
+ 			link_net = get_net_ns_by_id(dest_net, id);
+ 			if (!link_net) {
+ 				err =  -EINVAL;
+ 				goto out;
+ 			}
+ 			err = -EPERM;
+ 			if (!netlink_ns_capable(skb, link_net->user_ns, CAP_NET_ADMIN))
+ 				goto out;
+ 		}
+ 
+ 		dev = rtnl_create_link(link_net ? : dest_net, ifname,
+ 				       name_assign_type, ops, tb);
++>>>>>>> 06615bed60c1 (net: Verify permission to link_net in newlink)
  		if (IS_ERR(dev)) {
  			err = PTR_ERR(dev);
  			goto out;
* Unmerged path net/core/rtnetlink.c
