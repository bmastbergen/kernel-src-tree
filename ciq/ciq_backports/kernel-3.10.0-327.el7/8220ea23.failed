net: inet_diag: always export IPV6_V6ONLY sockopt for listening sockets

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
Rebuild_CHGLOG: - [net] inet_diag: always export IPV6_V6ONLY sockopt for listening sockets (Phil Sutter) [1247309]
Rebuild_FUZZ: 96.35%
commit-author Phil Sutter <phil@nwl.cc>
commit 8220ea23243178c16b87fc3ccadf071647b64e04
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/8220ea23.failed

Reconsidering my commit 20462155 "net: inet_diag: export IPV6_V6ONLY
sockopt", I am not happy with the limitations it causes for socket
analysing code in userspace. Exporting the value only if it is set makes
it hard for userspace to decide whether the option is not set or the
kernel does not support exporting the option at all.

>From an auditor's perspective, the interesting question for listening
AF_INET6 sockets is: "Does it NOT have IPV6_V6ONLY set?" Because it is
the unexpected case. This patch allows to answer this question reliably.

	Signed-off-by: Phil Sutter <phil@nwl.cc>
	Cc: Eric Dumazet <edumazet@google.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 8220ea23243178c16b87fc3ccadf071647b64e04)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/ipv4/inet_diag.c
diff --cc net/ipv4/inet_diag.c
index 4eeba4e497a0,c3b1f3a0f4cf..000000000000
--- a/net/ipv4/inet_diag.c
+++ b/net/ipv4/inet_diag.c
@@@ -147,6 -151,10 +147,13 @@@ int inet_sk_diag_fill(struct sock *sk, 
  			if (nla_put_u8(skb, INET_DIAG_TCLASS,
  				       inet6_sk(sk)->tclass) < 0)
  				goto errout;
++<<<<<<< HEAD
++=======
+ 
+ 		if (((1 << sk->sk_state) & (TCPF_LISTEN | TCPF_CLOSE)) &&
+ 		    nla_put_u8(skb, INET_DIAG_SKV6ONLY, ipv6_only_sock(sk)))
+ 			goto errout;
++>>>>>>> 8220ea232431 (net: inet_diag: always export IPV6_V6ONLY sockopt for listening sockets)
  	}
  #endif
  
* Unmerged path net/ipv4/inet_diag.c
