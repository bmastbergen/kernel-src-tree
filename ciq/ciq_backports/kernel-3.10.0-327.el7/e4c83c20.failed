i40e/i40evf: add exec_aq command to nvmupdate utility

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
commit-author Shannon Nelson <shannon.nelson@intel.com>
commit e4c83c20f87fe1d3da6b3a7ecaf40ae8717c7842
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/e4c83c20.failed

Add a facility to run AQ commands through the nvmupdate utility in order
to allow the update tools to interact with the FW and do special
commands needed for updates and configuration changes.

Change-ID: I5c41523e4055b37f8e4ee479f7a0574368f4a588
	Signed-off-by: Shannon Nelson <shannon.nelson@intel.com>
	Tested-by: Andrew Bowers <andrewx.bowers@intel.com>
	Signed-off-by: Jeff Kirsher <jeffrey.t.kirsher@intel.com>
(cherry picked from commit e4c83c20f87fe1d3da6b3a7ecaf40ae8717c7842)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/intel/i40e/i40e_nvm.c
#	drivers/net/ethernet/intel/i40e/i40e_type.h
#	drivers/net/ethernet/intel/i40evf/i40e_type.h
diff --cc drivers/net/ethernet/intel/i40e/i40e_nvm.c
index bc4977277193,50d4aa3cf658..000000000000
--- a/drivers/net/ethernet/intel/i40e/i40e_nvm.c
+++ b/drivers/net/ethernet/intel/i40e/i40e_nvm.c
@@@ -633,6 -641,8 +636,11 @@@ static char *i40e_nvm_update_state_str[
  	"I40E_NVMUPD_CSUM_CON",
  	"I40E_NVMUPD_CSUM_SA",
  	"I40E_NVMUPD_CSUM_LCB",
++<<<<<<< HEAD
++=======
+ 	"I40E_NVMUPD_STATUS",
+ 	"I40E_NVMUPD_EXEC_AQ",
++>>>>>>> e4c83c20f87f (i40e/i40evf: add exec_aq command to nvmupdate utility)
  };
  
  /**
diff --cc drivers/net/ethernet/intel/i40e/i40e_type.h
index f65183243a02,a78b0771476c..000000000000
--- a/drivers/net/ethernet/intel/i40e/i40e_type.h
+++ b/drivers/net/ethernet/intel/i40e/i40e_type.h
@@@ -305,6 -305,8 +305,11 @@@ enum i40e_nvmupd_cmd 
  	I40E_NVMUPD_CSUM_CON,
  	I40E_NVMUPD_CSUM_SA,
  	I40E_NVMUPD_CSUM_LCB,
++<<<<<<< HEAD
++=======
+ 	I40E_NVMUPD_STATUS,
+ 	I40E_NVMUPD_EXEC_AQ,
++>>>>>>> e4c83c20f87f (i40e/i40evf: add exec_aq command to nvmupdate utility)
  };
  
  enum i40e_nvmupd_state {
diff --cc drivers/net/ethernet/intel/i40evf/i40e_type.h
index f0f29b3edffe,4d36615403f5..000000000000
--- a/drivers/net/ethernet/intel/i40evf/i40e_type.h
+++ b/drivers/net/ethernet/intel/i40evf/i40e_type.h
@@@ -304,6 -304,8 +304,11 @@@ enum i40e_nvmupd_cmd 
  	I40E_NVMUPD_CSUM_CON,
  	I40E_NVMUPD_CSUM_SA,
  	I40E_NVMUPD_CSUM_LCB,
++<<<<<<< HEAD
++=======
+ 	I40E_NVMUPD_STATUS,
+ 	I40E_NVMUPD_EXEC_AQ,
++>>>>>>> e4c83c20f87f (i40e/i40evf: add exec_aq command to nvmupdate utility)
  };
  
  enum i40e_nvmupd_state {
diff --git a/drivers/net/ethernet/intel/i40e/i40e_adminq.c b/drivers/net/ethernet/intel/i40e/i40e_adminq.c
index 9bdeba724b75..00a80d8cad0d 100644
--- a/drivers/net/ethernet/intel/i40e/i40e_adminq.c
+++ b/drivers/net/ethernet/intel/i40e/i40e_adminq.c
@@ -655,6 +655,9 @@ i40e_status i40e_shutdown_adminq(struct i40e_hw *hw)
 
 	/* destroy the locks */
 
+	if (hw->nvm_buff.va)
+		i40e_free_virt_mem(hw, &hw->nvm_buff);
+
 	return ret_code;
 }
 
* Unmerged path drivers/net/ethernet/intel/i40e/i40e_nvm.c
* Unmerged path drivers/net/ethernet/intel/i40e/i40e_type.h
diff --git a/drivers/net/ethernet/intel/i40evf/i40e_adminq.c b/drivers/net/ethernet/intel/i40evf/i40e_adminq.c
index 15c8ac892704..0940db731382 100644
--- a/drivers/net/ethernet/intel/i40evf/i40e_adminq.c
+++ b/drivers/net/ethernet/intel/i40evf/i40e_adminq.c
@@ -596,6 +596,9 @@ i40e_status i40evf_shutdown_adminq(struct i40e_hw *hw)
 
 	/* destroy the locks */
 
+	if (hw->nvm_buff.va)
+		i40e_free_virt_mem(hw, &hw->nvm_buff);
+
 	return ret_code;
 }
 
* Unmerged path drivers/net/ethernet/intel/i40evf/i40e_type.h
