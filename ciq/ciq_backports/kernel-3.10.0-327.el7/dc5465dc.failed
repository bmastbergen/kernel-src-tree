Input: synaptics - fix middle button on Lenovo 2015 products

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
Rebuild_CHGLOG: - [input] mouse: synaptics - fix middle button on Lenovo 2015 products (Benjamin Tissoires) [1186106 1186112]
Rebuild_FUZZ: 93.33%
commit-author Dmitry Torokhov <dmitry.torokhov@gmail.com>
commit dc5465dc8a6d5cae8a0e1d8826bdcb2e4cb261ab
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/dc5465dc.failed

On the X1 Carbon 3rd gen (with a 2015 broadwell cpu), the physical middle
button of the trackstick (attached to the touchpad serio device, of course)
seems to get lost.

Actually, the touchpads reports 3 extra buttons, which falls in the switch
below to the '2' case. Let's handle the case of odd numbers also, so that
the middle button finds its way back.

	Cc: stable@vger.kernel.org
	Signed-off-by: Benjamin Tissoires <benjamin.tissoires@redhat.com>
	Acked-by: Hans de Goede <hdegoede@redhat.com>
	Signed-off-by: Dmitry Torokhov <dmitry.torokhov@gmail.com>
(cherry picked from commit dc5465dc8a6d5cae8a0e1d8826bdcb2e4cb261ab)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/input/mouse/synaptics.c
diff --cc drivers/input/mouse/synaptics.c
index a5e38586d8ba,e78cc5578527..000000000000
--- a/drivers/input/mouse/synaptics.c
+++ b/drivers/input/mouse/synaptics.c
@@@ -637,6 -658,20 +637,23 @@@ static void synaptics_parse_agm(const u
  	priv->agm_pending = true;
  }
  
++<<<<<<< HEAD
++=======
+ static void synaptics_parse_ext_buttons(const unsigned char buf[],
+ 					struct synaptics_data *priv,
+ 					struct synaptics_hw_state *hw)
+ {
+ 	unsigned int ext_bits =
+ 		(SYN_CAP_MULTI_BUTTON_NO(priv->ext_cap) + 1) >> 1;
+ 	unsigned int ext_mask = GENMASK(ext_bits - 1, 0);
+ 
+ 	hw->ext_buttons = buf[4] & ext_mask;
+ 	hw->ext_buttons |= (buf[5] & ext_mask) << ext_bits;
+ }
+ 
+ static bool is_forcepad;
+ 
++>>>>>>> dc5465dc8a6d (Input: synaptics - fix middle button on Lenovo 2015 products)
  static int synaptics_parse_hw_state(const unsigned char buf[],
  				    struct synaptics_data *priv,
  				    struct synaptics_hw_state *hw)
@@@ -670,43 -756,9 +687,28 @@@
  			hw->down = ((buf[0] ^ buf[3]) & 0x02) ? 1 : 0;
  		}
  
++<<<<<<< HEAD
 +		if ((SYN_CAP_ADV_GESTURE(priv->ext_cap_0c) ||
 +			SYN_CAP_IMAGE_SENSOR(priv->ext_cap_0c)) &&
 +		    hw->w == 2) {
 +			synaptics_parse_agm(buf, priv, hw);
 +			return 1;
 +		}
 +
 +		hw->x = (((buf[3] & 0x10) << 8) |
 +			 ((buf[1] & 0x0f) << 8) |
 +			 buf[4]);
 +		hw->y = (((buf[3] & 0x20) << 7) |
 +			 ((buf[1] & 0xf0) << 4) |
 +			 buf[5]);
 +		hw->z = buf[2];
 +
 +		if (SYN_CAP_MULTI_BUTTON_NO(priv->ext_cap) &&
++=======
+ 		if (SYN_CAP_MULTI_BUTTON_NO(priv->ext_cap) > 0 &&
++>>>>>>> dc5465dc8a6d (Input: synaptics - fix middle button on Lenovo 2015 products)
  		    ((buf[0] ^ buf[3]) & 0x02)) {
- 			switch (SYN_CAP_MULTI_BUTTON_NO(priv->ext_cap) & ~0x01) {
- 			default:
- 				/*
- 				 * if nExtBtn is greater than 8 it should be
- 				 * considered invalid and treated as 0
- 				 */
- 				break;
- 			case 8:
- 				hw->ext_buttons |= ((buf[5] & 0x08)) ? 0x80 : 0;
- 				hw->ext_buttons |= ((buf[4] & 0x08)) ? 0x40 : 0;
- 			case 6:
- 				hw->ext_buttons |= ((buf[5] & 0x04)) ? 0x20 : 0;
- 				hw->ext_buttons |= ((buf[4] & 0x04)) ? 0x10 : 0;
- 			case 4:
- 				hw->ext_buttons |= ((buf[5] & 0x02)) ? 0x08 : 0;
- 				hw->ext_buttons |= ((buf[4] & 0x02)) ? 0x04 : 0;
- 			case 2:
- 				hw->ext_buttons |= ((buf[5] & 0x01)) ? 0x02 : 0;
- 				hw->ext_buttons |= ((buf[4] & 0x01)) ? 0x01 : 0;
- 			}
+ 			synaptics_parse_ext_buttons(buf, priv, hw);
  		}
  	} else {
  		hw->x = (((buf[1] & 0x1f) << 8) | buf[2]);
* Unmerged path drivers/input/mouse/synaptics.c
