mlx4: restore conditional call to napi_complete_done()

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
commit-author Eric Dumazet <edumazet@google.com>
commit 2e1af7d74f4f7b4d4c1b0fbf5da3b5f92d9c332f
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/2e1af7d7.failed

After commit 1a28817282 ("mlx4: use napi_complete_done()") we ended up
calling napi_complete_done() in the case NAPI poll consumed all its
budget.

This added extra interrupt pressure, this patch restores proper
behavior.

	Signed-off-by: Eric Dumazet <edumazet@google.com>
Fixes: 1a28817282 ("mlx4: use napi_complete_done()")
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 2e1af7d74f4f7b4d4c1b0fbf5da3b5f92d9c332f)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlx4/en_rx.c
diff --cc drivers/net/ethernet/mellanox/mlx4/en_rx.c
index e85698cba13a,5a193f40a14c..000000000000
--- a/drivers/net/ethernet/mellanox/mlx4/en_rx.c
+++ b/drivers/net/ethernet/mellanox/mlx4/en_rx.c
@@@ -1048,21 -910,18 +1048,32 @@@ int mlx4_en_poll_rx_cq(struct napi_stru
  		cpu_curr = smp_processor_id();
  		aff = irq_desc_get_irq_data(cq->irq_desc)->affinity;
  
++<<<<<<< HEAD
 +		if (unlikely(!cpumask_test_cpu(cpu_curr, aff))) {
 +			/* Current cpu is not according to smp_irq_affinity -
 +			 * probably affinity changed. need to stop this NAPI
 +			 * poll, and restart it on the right CPU
 +			 */
 +			napi_complete(napi);
 +			mlx4_en_arm_cq(priv, cq);
 +			return 0;
 +		}
 +#endif
 +	} else {
 +		/* Done for now */
 +		napi_complete(napi);
 +		mlx4_en_arm_cq(priv, cq);
++=======
+ 		if (likely(cpumask_test_cpu(cpu_curr, aff)))
+ 			return budget;
+ 
+ 		/* Current cpu is not according to smp_irq_affinity -
+ 		 * probably affinity changed. need to stop this NAPI
+ 		 * poll, and restart it on the right CPU
+ 		 */
+ 		done = 0;
++>>>>>>> 2e1af7d74f4f (mlx4: restore conditional call to napi_complete_done())
  	}
 -	/* Done for now */
 -	napi_complete_done(napi, done);
 -	mlx4_en_arm_cq(priv, cq);
  	return done;
  }
  
* Unmerged path drivers/net/ethernet/mellanox/mlx4/en_rx.c
