be2net: Allow GRE to work concurrently while a VxLAN tunnel is configured

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
commit-author Sriharsha Basavapatna <sriharsha.basavapatna@emulex.com>
commit 16dde0d6ac159531a5e03cd3f8bc8a401d9f3fb6
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/16dde0d6.failed

Other tunnels like GRE break while VxLAN offloads are enabled in Skyhawk-R. To
avoid this, we should restrict offload features on a per-packet basis in such
conditions.

	Signed-off-by: Sriharsha Basavapatna <sriharsha.basavapatna@emulex.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 16dde0d6ac159531a5e03cd3f8bc8a401d9f3fb6)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/emulex/benet/be_main.c
diff --cc drivers/net/ethernet/emulex/benet/be_main.c
index a5afe9c031b4,d48806b5cd88..000000000000
--- a/drivers/net/ethernet/emulex/benet/be_main.c
+++ b/drivers/net/ethernet/emulex/benet/be_main.c
@@@ -4468,9 -4460,45 +4469,47 @@@ done
  	adapter->vxlan_port_count--;
  }
  
 -static netdev_features_t be_features_check(struct sk_buff *skb,
 -					   struct net_device *dev,
 -					   netdev_features_t features)
 +static bool be_gso_check(struct sk_buff *skb, struct net_device *dev)
  {
++<<<<<<< HEAD
 +	return vxlan_gso_check(skb);
++=======
+ 	struct be_adapter *adapter = netdev_priv(dev);
+ 	u8 l4_hdr = 0;
+ 
+ 	/* The code below restricts offload features for some tunneled packets.
+ 	 * Offload features for normal (non tunnel) packets are unchanged.
+ 	 */
+ 	if (!skb->encapsulation ||
+ 	    !(adapter->flags & BE_FLAGS_VXLAN_OFFLOADS))
+ 		return features;
+ 
+ 	/* It's an encapsulated packet and VxLAN offloads are enabled. We
+ 	 * should disable tunnel offload features if it's not a VxLAN packet,
+ 	 * as tunnel offloads have been enabled only for VxLAN. This is done to
+ 	 * allow other tunneled traffic like GRE work fine while VxLAN
+ 	 * offloads are configured in Skyhawk-R.
+ 	 */
+ 	switch (vlan_get_protocol(skb)) {
+ 	case htons(ETH_P_IP):
+ 		l4_hdr = ip_hdr(skb)->protocol;
+ 		break;
+ 	case htons(ETH_P_IPV6):
+ 		l4_hdr = ipv6_hdr(skb)->nexthdr;
+ 		break;
+ 	default:
+ 		return features;
+ 	}
+ 
+ 	if (l4_hdr != IPPROTO_UDP ||
+ 	    skb->inner_protocol_type != ENCAP_TYPE_ETHER ||
+ 	    skb->inner_protocol != htons(ETH_P_TEB) ||
+ 	    skb_inner_mac_header(skb) - skb_transport_header(skb) !=
+ 	    sizeof(struct udphdr) + sizeof(struct vxlanhdr))
+ 		return features & ~(NETIF_F_ALL_CSUM | NETIF_F_GSO_MASK);
+ 
+ 	return features;
++>>>>>>> 16dde0d6ac15 (be2net: Allow GRE to work concurrently while a VxLAN tunnel is configured)
  }
  #endif
  
* Unmerged path drivers/net/ethernet/emulex/benet/be_main.c
