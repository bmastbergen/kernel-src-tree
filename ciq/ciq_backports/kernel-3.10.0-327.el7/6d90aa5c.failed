net/mlx4_core: Make sure there are no pending async events when freeing CQ

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
Rebuild_CHGLOG: - [netdrv] mlx4_core: Make sure there are no pending async events when freeing CQ (Amir Vadai) [1164527 1164530 1164531 1164536 1164537]
Rebuild_FUZZ: 97.22%
commit-author Matan Barak <matanb@mellanox.com>
commit 6d90aa5cf17b1149115a002d7582b5d28ee43359
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/6d90aa5c.failed

When freeing a CQ, we need to make sure there are no
asynchronous events (on the ASYNC EQ) that could
relate to this CQ before freeing it.

This is done by introducing synchronize_irq.

	Signed-off-by: Matan Barak <matanb@mellanox.com>
	Signed-off-by: Ido Shamay <idos@mellanox.com>
	Signed-off-by: Or Gerlitz <ogerlitz@mellanox.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 6d90aa5cf17b1149115a002d7582b5d28ee43359)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlx4/cq.c
diff --cc drivers/net/ethernet/mellanox/mlx4/cq.c
index a59d96b90f17,3348e646db70..000000000000
--- a/drivers/net/ethernet/mellanox/mlx4/cq.c
+++ b/drivers/net/ethernet/mellanox/mlx4/cq.c
@@@ -369,7 -368,10 +369,14 @@@ void mlx4_cq_free(struct mlx4_dev *dev
  	if (err)
  		mlx4_warn(dev, "HW2SW_CQ failed (%d) for CQN %06x\n", err, cq->cqn);
  
++<<<<<<< HEAD
 +	synchronize_irq(priv->eq_table.eq[cq->vector].irq);
++=======
+ 	synchronize_irq(priv->eq_table.eq[MLX4_CQ_TO_EQ_VECTOR(cq->vector)].irq);
+ 	if (priv->eq_table.eq[MLX4_CQ_TO_EQ_VECTOR(cq->vector)].irq !=
+ 	    priv->eq_table.eq[MLX4_EQ_ASYNC].irq)
+ 		synchronize_irq(priv->eq_table.eq[MLX4_EQ_ASYNC].irq);
++>>>>>>> 6d90aa5cf17b (net/mlx4_core: Make sure there are no pending async events when freeing CQ)
  
  	spin_lock_irq(&cq_table->lock);
  	radix_tree_delete(&cq_table->tree, cq->cqn);
* Unmerged path drivers/net/ethernet/mellanox/mlx4/cq.c
