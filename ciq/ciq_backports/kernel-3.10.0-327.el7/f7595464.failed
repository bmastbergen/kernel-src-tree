ACPI / TPM: Fix resume regression on Chromebooks

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
Rebuild_CHGLOG: - [char] tpm: Fix resume regression on Chromebooks (Jarod Wilson) [1182709]
Rebuild_FUZZ: 92.13%
commit-author Rafael J. Wysocki <rafael.j.wysocki@intel.com>
commit f759546498d820670934c901a2fdf1ce948d2e5c
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/f7595464.failed

Chromebooks (at least Acer C720 and Pixel) implement an ACPI object
for TPM, but don't implement the _DSM method to support PPI.  As
a result, the TPM driver fails to load on those machines after
commit 1569a4c4ceba (ACPI / TPM: detect PPI features by checking
availability of _DSM functions) which causes them to fail to
resume from system suspend, becuase they require the TPM hardware
to be put into the right state during resume and the TPM driver
is necessary for that.

Fix the problem by making tpm_add_ppi() return 0 when tpm_ppi_handle
is still NULL after walking the ACPI namespace in search for the PPI
_DSM, which allows the TPM driver to load and operate the hardware
(during system resume in particular), but avoid creating the PPI
sysfs group in that case.

This change is based on a prototype patch from Jiang Liu.

Fixes: 1569a4c4ceba (ACPI / TPM: detect PPI features by checking availability of _DSM functions)
References: https://bugzilla.kernel.org/show_bug.cgi?id=74021
	Reported-by: James Duley <jagduley@gmail.com>
	Reported-by: Phillip Dixon <phil@dixon.gen.nz>
	Tested-by: Brandon Casey <drafnel@gmail.com>
	Cc: 3.14+ <stable@vger.kernel.org> # 3.14+
	Signed-off-by: Rafael J. Wysocki <rafael.j.wysocki@intel.com>
(cherry picked from commit f759546498d820670934c901a2fdf1ce948d2e5c)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/char/tpm/tpm_ppi.c
diff --cc drivers/char/tpm/tpm_ppi.c
index 1e9cc11ac76a,61dcc8011ec7..000000000000
--- a/drivers/char/tpm/tpm_ppi.c
+++ b/drivers/char/tpm/tpm_ppi.c
@@@ -453,7 -325,10 +453,14 @@@ static struct attribute_group ppi_attr_
  
  int tpm_add_ppi(struct kobject *parent)
  {
++<<<<<<< HEAD
 +	return sysfs_create_group(parent, &ppi_attr_grp);
++=======
+ 	/* Cache TPM ACPI handle and version string */
+ 	acpi_walk_namespace(ACPI_TYPE_DEVICE, ACPI_ROOT_OBJECT, ACPI_UINT32_MAX,
+ 			    ppi_callback, NULL, NULL, &tpm_ppi_handle);
+ 	return tpm_ppi_handle ? sysfs_create_group(parent, &ppi_attr_grp) : 0;
++>>>>>>> f759546498d8 (ACPI / TPM: Fix resume regression on Chromebooks)
  }
  
  void tpm_remove_ppi(struct kobject *parent)
* Unmerged path drivers/char/tpm/tpm_ppi.c
