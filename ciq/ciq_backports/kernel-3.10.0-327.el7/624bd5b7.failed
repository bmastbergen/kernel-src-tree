nfs: Add DEALLOCATE support

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
commit-author Anna Schumaker <Anna.Schumaker@netapp.com>
commit 624bd5b7b683c978c6d5f4e9f6142cfb3470983d
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/624bd5b7.failed

This patch adds support for using the NFS v4.2 operation DEALLOCATE to
punch holes in a file.

	Signed-off-by: Anna Schumaker <Anna.Schumaker@Netapp.com>
	Signed-off-by: Trond Myklebust <trond.myklebust@primarydata.com>
(cherry picked from commit 624bd5b7b683c978c6d5f4e9f6142cfb3470983d)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/nfs/nfs42.h
#	fs/nfs/nfs42proc.c
#	fs/nfs/nfs42xdr.c
#	fs/nfs/nfs4file.c
#	fs/nfs/nfs4proc.c
#	fs/nfs/nfs4xdr.c
#	include/linux/nfs4.h
#	include/linux/nfs_fs_sb.h
diff --cc fs/nfs/nfs4file.c
index cb5f89c48651,8b46389c4c5b..000000000000
--- a/fs/nfs/nfs4file.c
+++ b/fs/nfs/nfs4file.c
@@@ -115,12 -121,59 +115,58 @@@ nfs4_file_fsync(struct file *file, loff
  	return ret;
  }
  
++<<<<<<< HEAD
++=======
+ #ifdef CONFIG_NFS_V4_2
+ static loff_t nfs4_file_llseek(struct file *filep, loff_t offset, int whence)
+ {
+ 	loff_t ret;
+ 
+ 	switch (whence) {
+ 	case SEEK_HOLE:
+ 	case SEEK_DATA:
+ 		ret = nfs42_proc_llseek(filep, offset, whence);
+ 		if (ret != -ENOTSUPP)
+ 			return ret;
+ 	default:
+ 		return nfs_file_llseek(filep, offset, whence);
+ 	}
+ }
+ 
+ static long nfs42_fallocate(struct file *filep, int mode, loff_t offset, loff_t len)
+ {
+ 	struct inode *inode = file_inode(filep);
+ 	long ret;
+ 
+ 	if (!S_ISREG(inode->i_mode))
+ 		return -EOPNOTSUPP;
+ 
+ 	if ((mode != 0) && (mode != (FALLOC_FL_PUNCH_HOLE | FALLOC_FL_KEEP_SIZE)))
+ 		return -EOPNOTSUPP;
+ 
+ 	ret = inode_newsize_ok(inode, offset + len);
+ 	if (ret < 0)
+ 		return ret;
+ 
+ 	mutex_lock(&inode->i_mutex);
+ 	if (mode & FALLOC_FL_PUNCH_HOLE)
+ 		ret = nfs42_proc_deallocate(filep, offset, len);
+ 	else
+ 		ret = nfs42_proc_allocate(filep, offset, len);
+ 	mutex_unlock(&inode->i_mutex);
+ 
+ 	nfs_zap_caches(inode);
+ 	return ret;
+ }
+ #endif /* CONFIG_NFS_V4_2 */
+ 
++>>>>>>> 624bd5b7b683 (nfs: Add DEALLOCATE support)
  const struct file_operations nfs4_file_operations = {
 -#ifdef CONFIG_NFS_V4_2
 -	.llseek		= nfs4_file_llseek,
 -#else
  	.llseek		= nfs_file_llseek,
 -#endif
 -	.read		= new_sync_read,
 -	.write		= new_sync_write,
 -	.read_iter	= nfs_file_read,
 -	.write_iter	= nfs_file_write,
 +	.read		= do_sync_read,
 +	.write		= do_sync_write,
 +	.aio_read	= nfs_file_read,
 +	.aio_write	= nfs_file_write,
  	.mmap		= nfs_file_mmap,
  	.open		= nfs4_file_open,
  	.flush		= nfs_file_flush,
diff --cc fs/nfs/nfs4proc.c
index 21f0de0c3a8b,e7f8d5ff2581..000000000000
--- a/fs/nfs/nfs4proc.c
+++ b/fs/nfs/nfs4proc.c
@@@ -8502,7 -8423,10 +8502,14 @@@ static const struct nfs4_minor_version_
  		| NFS_CAP_CHANGE_ATTR
  		| NFS_CAP_POSIX_LOCK
  		| NFS_CAP_STATEID_NFSV41
++<<<<<<< HEAD
 +		| NFS_CAP_ATOMIC_OPEN_V1,
++=======
+ 		| NFS_CAP_ATOMIC_OPEN_V1
+ 		| NFS_CAP_ALLOCATE
+ 		| NFS_CAP_DEALLOCATE
+ 		| NFS_CAP_SEEK,
++>>>>>>> 624bd5b7b683 (nfs: Add DEALLOCATE support)
  	.init_client = nfs41_init_client,
  	.shutdown_client = nfs41_shutdown_client,
  	.match_stateid = nfs41_match_stateid,
diff --cc fs/nfs/nfs4xdr.c
index bd5ef45c5e50,03d0fa62a06e..000000000000
--- a/fs/nfs/nfs4xdr.c
+++ b/fs/nfs/nfs4xdr.c
@@@ -7506,6 -7392,11 +7506,14 @@@ struct rpc_procinfo	nfs4_procedures[] 
  			enc_bind_conn_to_session, dec_bind_conn_to_session),
  	PROC(DESTROY_CLIENTID,	enc_destroy_clientid,	dec_destroy_clientid),
  #endif /* CONFIG_NFS_V4_1 */
++<<<<<<< HEAD
++=======
+ #ifdef CONFIG_NFS_V4_2
+ 	PROC(SEEK,		enc_seek,		dec_seek),
+ 	PROC(ALLOCATE,		enc_allocate,		dec_allocate),
+ 	PROC(DEALLOCATE,	enc_deallocate,		dec_deallocate),
+ #endif /* CONFIG_NFS_V4_2 */
++>>>>>>> 624bd5b7b683 (nfs: Add DEALLOCATE support)
  };
  
  const struct rpc_version nfs_version4 = {
diff --cc include/linux/nfs4.h
index d56c4c28a3c0,022b761dbf0a..000000000000
--- a/include/linux/nfs4.h
+++ b/include/linux/nfs4.h
@@@ -489,6 -487,11 +489,14 @@@ enum 
  	NFSPROC4_CLNT_GETDEVICELIST,
  	NFSPROC4_CLNT_BIND_CONN_TO_SESSION,
  	NFSPROC4_CLNT_DESTROY_CLIENTID,
++<<<<<<< HEAD
++=======
+ 
+ 	/* nfs42 */
+ 	NFSPROC4_CLNT_SEEK,
+ 	NFSPROC4_CLNT_ALLOCATE,
+ 	NFSPROC4_CLNT_DEALLOCATE,
++>>>>>>> 624bd5b7b683 (nfs: Add DEALLOCATE support)
  };
  
  /* nfs41 types */
diff --cc include/linux/nfs_fs_sb.h
index 922be2e050f5,1e37fbb78f7a..000000000000
--- a/include/linux/nfs_fs_sb.h
+++ b/include/linux/nfs_fs_sb.h
@@@ -230,5 -230,8 +230,11 @@@ struct nfs_server 
  #define NFS_CAP_STATEID_NFSV41	(1U << 16)
  #define NFS_CAP_ATOMIC_OPEN_V1	(1U << 17)
  #define NFS_CAP_SECURITY_LABEL	(1U << 18)
++<<<<<<< HEAD
++=======
+ #define NFS_CAP_SEEK		(1U << 19)
+ #define NFS_CAP_ALLOCATE	(1U << 20)
+ #define NFS_CAP_DEALLOCATE	(1U << 21)
++>>>>>>> 624bd5b7b683 (nfs: Add DEALLOCATE support)
  
  #endif
* Unmerged path fs/nfs/nfs42.h
* Unmerged path fs/nfs/nfs42proc.c
* Unmerged path fs/nfs/nfs42xdr.c
* Unmerged path fs/nfs/nfs42.h
* Unmerged path fs/nfs/nfs42proc.c
* Unmerged path fs/nfs/nfs42xdr.c
* Unmerged path fs/nfs/nfs4file.c
* Unmerged path fs/nfs/nfs4proc.c
* Unmerged path fs/nfs/nfs4xdr.c
* Unmerged path include/linux/nfs4.h
* Unmerged path include/linux/nfs_fs_sb.h
