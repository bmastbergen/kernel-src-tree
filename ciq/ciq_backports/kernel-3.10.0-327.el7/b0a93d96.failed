storvsc: force SPC-3 compliance on win8 and win8 r2 hosts

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
commit-author K. Y. Srinivasan <kys@microsoft.com>
commit b0a93d96b2814c725161f91a4e35d0c29ec0f95b
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/b0a93d96.failed

On win8 and win8 r2 hosts force SPC-3 compliance for MSFT virtual disks.
Ubuntu has been carrying a similar patch outside the tree for a while now.
Starting with win10, the host will support SPC-3 compliance. Based on all
the testing that has been done on win8 and win8 r2 hosts, we are comfortable
claiming SPC-3 compliance on these hosts as well. This will enable TRIM
support on these hosts.

Suggested by: James Bottomley <James.Bottomley@HansenPartnership.com>
	Signed-off-by: K. Y. Srinivasan <kys@microsoft.com>
	Reviewed-by: Long Li <longli@microsoft.com>
	Signed-off-by: Christoph Hellwig <hch@lst.de>
(cherry picked from commit b0a93d96b2814c725161f91a4e35d0c29ec0f95b)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/storvsc_drv.c
diff --cc drivers/scsi/storvsc_drv.c
index 06fba1265516,efc6e446b6c8..000000000000
--- a/drivers/scsi/storvsc_drv.c
+++ b/drivers/scsi/storvsc_drv.c
@@@ -1384,6 -1386,27 +1384,30 @@@ static int storvsc_device_configure(str
  
  	sdevice->no_write_same = 1;
  
++<<<<<<< HEAD
++=======
+ 	/*
+ 	 * Add blist flags to permit the reading of the VPD pages even when
+ 	 * the target may claim SPC-2 compliance. MSFT targets currently
+ 	 * claim SPC-2 compliance while they implement post SPC-2 features.
+ 	 * With this patch we can correctly handle WRITE_SAME_16 issues.
+ 	 */
+ 	sdevice->sdev_bflags |= msft_blist_flags;
+ 
+ 	/*
+ 	 * If the host is WIN8 or WIN8 R2, claim conformance to SPC-3
+ 	 * if the device is a MSFT virtual device.
+ 	 */
+ 	if (!strncmp(sdevice->vendor, "Msft", 4)) {
+ 		switch (vmbus_proto_version) {
+ 		case VERSION_WIN8:
+ 		case VERSION_WIN8_1:
+ 			sdevice->scsi_level = SCSI_SPC_3;
+ 			break;
+ 		}
+ 	}
+ 
++>>>>>>> b0a93d96b281 (storvsc: force SPC-3 compliance on win8 and win8 r2 hosts)
  	return 0;
  }
  
* Unmerged path drivers/scsi/storvsc_drv.c
