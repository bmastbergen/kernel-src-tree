nfs: add a helper to set NFS_ODIRECT_RESCHED_WRITES to direct writes

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
commit-author Peng Tao <tao.peng@primarydata.com>
commit 012fa16dca0da6c487dd066829ff0b0954925fe6
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/012fa16d.failed

To allow pnfs LD to ask direct writes to be resend.

	Signed-off-by: Peng Tao <tao.peng@primarydata.com>
(cherry picked from commit 012fa16dca0da6c487dd066829ff0b0954925fe6)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/nfs/direct.c
diff --cc fs/nfs/direct.c
index 74e3798cd593,4fad6b727eb4..000000000000
--- a/fs/nfs/direct.c
+++ b/fs/nfs/direct.c
@@@ -108,6 -116,35 +108,38 @@@ static inline int put_dreq(struct nfs_d
  	return atomic_dec_and_test(&dreq->io_count);
  }
  
++<<<<<<< HEAD
++=======
+ void nfs_direct_set_resched_writes(struct nfs_direct_req *dreq)
+ {
+ 	dreq->flags = NFS_ODIRECT_RESCHED_WRITES;
+ }
+ EXPORT_SYMBOL_GPL(nfs_direct_set_resched_writes);
+ 
+ static void
+ nfs_direct_good_bytes(struct nfs_direct_req *dreq, struct nfs_pgio_header *hdr)
+ {
+ 	int i;
+ 	ssize_t count;
+ 
+ 	WARN_ON_ONCE(hdr->pgio_mirror_idx >= dreq->mirror_count);
+ 
+ 	dreq->mirrors[hdr->pgio_mirror_idx].count += hdr->good_bytes;
+ 
+ 	if (hdr->pgio_mirror_idx == 0)
+ 		dreq->count += hdr->good_bytes;
+ 
+ 	/* update the dreq->count by finding the minimum agreed count from all
+ 	 * mirrors */
+ 	count = dreq->mirrors[0].count;
+ 
+ 	for (i = 1; i < dreq->mirror_count; i++)
+ 		count = min(count, dreq->mirrors[i].count);
+ 
+ 	dreq->count = count;
+ }
+ 
++>>>>>>> 012fa16dca0d (nfs: add a helper to set NFS_ODIRECT_RESCHED_WRITES to direct writes)
  /*
   * nfs_direct_select_verf - select the right verifier
   * @dreq - direct request possibly spanning multiple servers
* Unmerged path fs/nfs/direct.c
diff --git a/fs/nfs/internal.h b/fs/nfs/internal.h
index 9fe4201d709b..2203184f5f32 100644
--- a/fs/nfs/internal.h
+++ b/fs/nfs/internal.h
@@ -484,6 +484,7 @@ static inline void nfs_inode_dio_wait(struct inode *inode)
 	inode_dio_wait(inode);
 }
 extern ssize_t nfs_dreq_bytes_left(struct nfs_direct_req *dreq);
+extern void nfs_direct_set_resched_writes(struct nfs_direct_req *dreq);
 
 /* nfs4proc.c */
 extern void __nfs4_read_done_cb(struct nfs_pgio_header *);
