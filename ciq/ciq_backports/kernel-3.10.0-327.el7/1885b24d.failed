blk-mq: Add helper to abort requeued requests

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
commit-author Jens Axboe <axboe@fb.com>
commit 1885b24d23716e09b9c952822b05fd7f68099cdb
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/1885b24d.failed

Adds a helper function a driver can use to abort requeued requests in
case any are pending when h/w queues are being removed.

	Signed-off-by: Jens Axboe <axboe@fb.com>
(cherry picked from commit 1885b24d23716e09b9c952822b05fd7f68099cdb)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	block/blk-mq.c
diff --cc block/blk-mq.c
index 1af283c80294,261ccd89e15d..000000000000
--- a/block/blk-mq.c
+++ b/block/blk-mq.c
@@@ -552,10 -539,31 +552,35 @@@ void blk_mq_kick_requeue_list(struct re
  }
  EXPORT_SYMBOL(blk_mq_kick_requeue_list);
  
++<<<<<<< HEAD
 +static inline bool is_flush_request(struct request *rq, unsigned int tag)
++=======
+ void blk_mq_abort_requeue_list(struct request_queue *q)
+ {
+ 	unsigned long flags;
+ 	LIST_HEAD(rq_list);
+ 
+ 	spin_lock_irqsave(&q->requeue_lock, flags);
+ 	list_splice_init(&q->requeue_list, &rq_list);
+ 	spin_unlock_irqrestore(&q->requeue_lock, flags);
+ 
+ 	while (!list_empty(&rq_list)) {
+ 		struct request *rq;
+ 
+ 		rq = list_first_entry(&rq_list, struct request, queuelist);
+ 		list_del_init(&rq->queuelist);
+ 		rq->errors = -EIO;
+ 		blk_mq_end_request(rq, rq->errors);
+ 	}
+ }
+ EXPORT_SYMBOL(blk_mq_abort_requeue_list);
+ 
+ static inline bool is_flush_request(struct request *rq,
+ 		struct blk_flush_queue *fq, unsigned int tag)
++>>>>>>> 1885b24d2371 (blk-mq: Add helper to abort requeued requests)
  {
  	return ((rq->cmd_flags & REQ_FLUSH_SEQ) &&
 -			fq->flush_rq->tag == tag);
 +			rq->q->flush_rq->tag == tag);
  }
  
  struct request *blk_mq_tag_to_rq(struct blk_mq_tags *tags, unsigned int tag)
* Unmerged path block/blk-mq.c
diff --git a/include/linux/blk-mq.h b/include/linux/blk-mq.h
index a58379f22a1c..31a9ed2dc38b 100644
--- a/include/linux/blk-mq.h
+++ b/include/linux/blk-mq.h
@@ -235,6 +235,7 @@ void blk_mq_requeue_request(struct request *rq);
 void blk_mq_add_to_requeue_list(struct request *rq, bool at_head);
 void blk_mq_cancel_requeue_work(struct request_queue *q);
 void blk_mq_kick_requeue_list(struct request_queue *q);
+void blk_mq_abort_requeue_list(struct request_queue *q);
 void blk_mq_complete_request(struct request *rq);
 
 void blk_mq_stop_hw_queue(struct blk_mq_hw_ctx *hctx);
