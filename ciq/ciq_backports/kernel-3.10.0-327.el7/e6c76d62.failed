perf build: Move feature checks code under tools/build

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
Rebuild_CHGLOG: - [perf] build: Move feature checks code under tools/build (Jiri Olsa) [1222189]
Rebuild_FUZZ: 95.15%
commit-author Jiri Olsa <jolsa@kernel.org>
commit e6c76d620379fd65fc0310aee1785ff7b1b10236
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/e6c76d62.failed

Moving feature checks code under tools/build directory.

Changing also $feature_dir to point to new feature directory location
and perf Makefiles to include Makefile.feature from new location.

	Signed-off-by: Jiri Olsa <jolsa@kernel.org>
	Cc: Corey Ashford <cjashfor@linux.vnet.ibm.com>
	Cc: David Ahern <david.ahern@oracle.com>
	Cc: Namhyung Kim <namhyung@kernel.org>
	Cc: Paul Mackerras <paulus@samba.org>
	Cc: Peter Zijlstra <peterz@infradead.org>
Link: http://lkml.kernel.org/n/tip-3lamtb30dhf4wo99y1n8kxg0@git.kernel.org
	Signed-off-by: Arnaldo Carvalho de Melo <acme@redhat.com>
(cherry picked from commit e6c76d620379fd65fc0310aee1785ff7b1b10236)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/build/Makefile.feature
#	tools/build/feature/.gitignore
#	tools/perf/Makefile.perf
#	tools/perf/config/Makefile
diff --cc tools/perf/Makefile.perf
index 0066e52a44e4,d5b9e0dae334..000000000000
--- a/tools/perf/Makefile.perf
+++ b/tools/perf/Makefile.perf
@@@ -885,14 -521,14 +885,18 @@@ $(INSTALL_DOC_TARGETS)
  #
  config-clean:
  	$(call QUIET_CLEAN, config)
++<<<<<<< HEAD
 +	@$(MAKE) -C config/feature-checks clean >/dev/null
++=======
+ 	$(Q)$(MAKE) -C $(srctree)/tools/build/feature/ clean >/dev/null
++>>>>>>> e6c76d620379 (perf build: Move feature checks code under tools/build)
  
 -clean: $(LIBTRACEEVENT)-clean $(LIBAPI)-clean config-clean
 -	$(call QUIET_CLEAN, core-objs)  $(RM) $(LIB_FILE) $(OUTPUT)perf-archive $(OUTPUT)perf-with-kcore $(LANG_BINDINGS)
 -	$(Q)find . -name '*.o' -delete -o -name '\.*.cmd' -delete -o -name '\.*.d' -delete
 -	$(Q)$(RM) .config-detected
 +clean: $(LIBTRACEEVENT)-clean $(LIBAPIKFS)-clean config-clean
 +	$(call QUIET_CLEAN, core-objs)  $(RM) $(LIB_OBJS) $(BUILTIN_OBJS) $(LIB_FILE) $(OUTPUT)perf-archive $(OUTPUT)perf-with-kcore $(OUTPUT)perf.o $(LANG_BINDINGS) $(GTK_OBJS)
 +	@find . -name '*.o' -delete -o -name '\.*.cmd' -delete -o -name '\.*.d' -delete
 +	@$(RM) .config-detected
  	$(call QUIET_CLEAN, core-progs) $(RM) $(ALL_PROGRAMS) perf perf-read-vdso32 perf-read-vdsox32
 -	$(call QUIET_CLEAN, core-gen)   $(RM)  *.spec *.pyc *.pyo */*.pyc */*.pyo $(OUTPUT)common-cmds.h TAGS tags cscope* $(OUTPUT)PERF-VERSION-FILE $(OUTPUT)FEATURE-DUMP $(OUTPUT)util/*-bison* $(OUTPUT)util/*-flex*
 +	$(call QUIET_CLEAN, core-gen)   $(RM)  *.spec *.pyc *.pyo */*.pyc */*.pyo $(OUTPUT)common-cmds.h TAGS tags cscope* $(OUTPUT)PERF-VERSION-FILE $(OUTPUT)PERF-CFLAGS $(OUTPUT)PERF-FEATURES $(OUTPUT)util/*-bison* $(OUTPUT)util/*-flex*
  	$(QUIET_SUBDIR0)Documentation $(QUIET_SUBDIR1) clean
  	$(python-clean)
  
diff --cc tools/perf/config/Makefile
index 49715ac798cd,6d1918a6b83b..000000000000
--- a/tools/perf/config/Makefile
+++ b/tools/perf/config/Makefile
@@@ -170,104 -176,7 +170,108 @@@ LDFLAGS += -Wl,-z,noexecstac
  
  EXTLIBS = -lpthread -lrt -lm -ldl
  
++<<<<<<< HEAD
 +ifneq ($(OUTPUT),)
 +  OUTPUT_FEATURES = $(OUTPUT)config/feature-checks/
 +  $(shell mkdir -p $(OUTPUT_FEATURES))
 +endif
 +
 +feature_check = $(eval $(feature_check_code))
 +define feature_check_code
 +  feature-$(1) := $(shell $(MAKE) OUTPUT=$(OUTPUT_FEATURES) CFLAGS="$(EXTRA_CFLAGS) $(FEATURE_CHECK_CFLAGS-$(1))" LDFLAGS="$(LDFLAGS) $(FEATURE_CHECK_LDFLAGS-$(1))" -C config/feature-checks test-$1.bin >/dev/null 2>/dev/null && echo 1 || echo 0)
 +endef
 +
 +feature_set = $(eval $(feature_set_code))
 +define feature_set_code
 +  feature-$(1) := 1
 +endef
 +
 +#
 +# Build the feature check binaries in parallel, ignore errors, ignore return value and suppress output:
 +#
 +
 +#
 +# Note that this is not a complete list of all feature tests, just
 +# those that are typically built on a fully configured system.
 +#
 +# [ Feature tests not mentioned here have to be built explicitly in
 +#   the rule that uses them - an example for that is the 'bionic'
 +#   feature check. ]
 +#
 +FEATURE_TESTS =			\
 +	backtrace			\
 +	dwarf				\
 +	fortify-source			\
 +	sync-compare-and-swap		\
 +	glibc				\
 +	gtk2				\
 +	gtk2-infobar			\
 +	libaudit			\
 +	libbfd				\
 +	libelf				\
 +	libelf-getphdrnum		\
 +	libelf-mmap			\
 +	libnuma				\
 +	libperl				\
 +	libpython			\
 +	libpython-version		\
 +	libslang			\
 +	libunwind			\
 +	pthread-attr-setaffinity-np	\
 +	stackprotector-all		\
 +	timerfd				\
 +	libdw-dwarf-unwind		\
 +	libbabeltrace			\
 +	zlib
 +
 +FEATURE_DISPLAY =			\
 +	dwarf				\
 +	glibc				\
 +	gtk2				\
 +	libaudit			\
 +	libbfd				\
 +	libelf				\
 +	libnuma				\
 +	libperl				\
 +	libpython			\
 +	libslang			\
 +	libunwind			\
 +	libdw-dwarf-unwind		\
 +	libbabeltrace			\
 +	zlib
 +
 +# Set FEATURE_CHECK_(C|LD)FLAGS-all for all FEATURE_TESTS features.
 +# If in the future we need per-feature checks/flags for features not
 +# mentioned in this list we need to refactor this ;-).
 +set_test_all_flags = $(eval $(set_test_all_flags_code))
 +define set_test_all_flags_code
 +  FEATURE_CHECK_CFLAGS-all  += $(FEATURE_CHECK_CFLAGS-$(1))
 +  FEATURE_CHECK_LDFLAGS-all += $(FEATURE_CHECK_LDFLAGS-$(1))
 +endef
 +
 +$(foreach feat,$(FEATURE_TESTS),$(call set_test_all_flags,$(feat)))
 +
 +#
 +# Special fast-path for the 'all features are available' case:
 +#
 +$(call feature_check,all,$(MSG))
 +
 +#
 +# Just in case the build freshly failed, make sure we print the
 +# feature matrix:
 +#
 +ifeq ($(feature-all), 1)
 +  #
 +  # test-all.c passed - just set all the core feature flags to 1:
 +  #
 +  $(foreach feat,$(FEATURE_TESTS),$(call feature_set,$(feat)))
 +else
 +  $(shell $(MAKE) OUTPUT=$(OUTPUT_FEATURES) CFLAGS="$(EXTRA_CFLAGS)" LDFLAGS=$(LDFLAGS) -i -j -C config/feature-checks $(addsuffix .bin,$(FEATURE_TESTS)) >/dev/null 2>&1)
 +  $(foreach feat,$(FEATURE_TESTS),$(call feature_check,$(feat)))
 +endif
++=======
+ include $(srctree)/tools/build/Makefile.feature
++>>>>>>> e6c76d620379 (perf build: Move feature checks code under tools/build)
  
  ifeq ($(feature-stackprotector-all), 1)
    CFLAGS += -fstack-protector-all
* Unmerged path tools/build/Makefile.feature
* Unmerged path tools/build/feature/.gitignore
* Unmerged path tools/build/Makefile.feature
* Unmerged path tools/build/feature/.gitignore
diff --git a/tools/perf/config/feature-checks/Makefile b/tools/build/feature/Makefile
similarity index 100%
rename from tools/perf/config/feature-checks/Makefile
rename to tools/build/feature/Makefile
diff --git a/tools/perf/config/feature-checks/test-all.c b/tools/build/feature/test-all.c
similarity index 100%
rename from tools/perf/config/feature-checks/test-all.c
rename to tools/build/feature/test-all.c
diff --git a/tools/perf/config/feature-checks/test-backtrace.c b/tools/build/feature/test-backtrace.c
similarity index 100%
rename from tools/perf/config/feature-checks/test-backtrace.c
rename to tools/build/feature/test-backtrace.c
diff --git a/tools/perf/config/feature-checks/test-bionic.c b/tools/build/feature/test-bionic.c
similarity index 100%
rename from tools/perf/config/feature-checks/test-bionic.c
rename to tools/build/feature/test-bionic.c
diff --git a/tools/perf/config/feature-checks/test-compile.c b/tools/build/feature/test-compile.c
similarity index 100%
rename from tools/perf/config/feature-checks/test-compile.c
rename to tools/build/feature/test-compile.c
diff --git a/tools/perf/config/feature-checks/test-cplus-demangle.c b/tools/build/feature/test-cplus-demangle.c
similarity index 100%
rename from tools/perf/config/feature-checks/test-cplus-demangle.c
rename to tools/build/feature/test-cplus-demangle.c
diff --git a/tools/perf/config/feature-checks/test-dwarf.c b/tools/build/feature/test-dwarf.c
similarity index 100%
rename from tools/perf/config/feature-checks/test-dwarf.c
rename to tools/build/feature/test-dwarf.c
diff --git a/tools/perf/config/feature-checks/test-fortify-source.c b/tools/build/feature/test-fortify-source.c
similarity index 100%
rename from tools/perf/config/feature-checks/test-fortify-source.c
rename to tools/build/feature/test-fortify-source.c
diff --git a/tools/perf/config/feature-checks/test-glibc.c b/tools/build/feature/test-glibc.c
similarity index 100%
rename from tools/perf/config/feature-checks/test-glibc.c
rename to tools/build/feature/test-glibc.c
diff --git a/tools/perf/config/feature-checks/test-gtk2-infobar.c b/tools/build/feature/test-gtk2-infobar.c
similarity index 100%
rename from tools/perf/config/feature-checks/test-gtk2-infobar.c
rename to tools/build/feature/test-gtk2-infobar.c
diff --git a/tools/perf/config/feature-checks/test-gtk2.c b/tools/build/feature/test-gtk2.c
similarity index 100%
rename from tools/perf/config/feature-checks/test-gtk2.c
rename to tools/build/feature/test-gtk2.c
diff --git a/tools/perf/config/feature-checks/test-hello.c b/tools/build/feature/test-hello.c
similarity index 100%
rename from tools/perf/config/feature-checks/test-hello.c
rename to tools/build/feature/test-hello.c
diff --git a/tools/perf/config/feature-checks/test-libaudit.c b/tools/build/feature/test-libaudit.c
similarity index 100%
rename from tools/perf/config/feature-checks/test-libaudit.c
rename to tools/build/feature/test-libaudit.c
diff --git a/tools/perf/config/feature-checks/test-libbabeltrace.c b/tools/build/feature/test-libbabeltrace.c
similarity index 100%
rename from tools/perf/config/feature-checks/test-libbabeltrace.c
rename to tools/build/feature/test-libbabeltrace.c
diff --git a/tools/perf/config/feature-checks/test-libbfd.c b/tools/build/feature/test-libbfd.c
similarity index 100%
rename from tools/perf/config/feature-checks/test-libbfd.c
rename to tools/build/feature/test-libbfd.c
diff --git a/tools/perf/config/feature-checks/test-libdw-dwarf-unwind.c b/tools/build/feature/test-libdw-dwarf-unwind.c
similarity index 100%
rename from tools/perf/config/feature-checks/test-libdw-dwarf-unwind.c
rename to tools/build/feature/test-libdw-dwarf-unwind.c
diff --git a/tools/perf/config/feature-checks/test-libelf-getphdrnum.c b/tools/build/feature/test-libelf-getphdrnum.c
similarity index 100%
rename from tools/perf/config/feature-checks/test-libelf-getphdrnum.c
rename to tools/build/feature/test-libelf-getphdrnum.c
diff --git a/tools/perf/config/feature-checks/test-libelf-mmap.c b/tools/build/feature/test-libelf-mmap.c
similarity index 100%
rename from tools/perf/config/feature-checks/test-libelf-mmap.c
rename to tools/build/feature/test-libelf-mmap.c
diff --git a/tools/perf/config/feature-checks/test-libelf.c b/tools/build/feature/test-libelf.c
similarity index 100%
rename from tools/perf/config/feature-checks/test-libelf.c
rename to tools/build/feature/test-libelf.c
diff --git a/tools/perf/config/feature-checks/test-libnuma.c b/tools/build/feature/test-libnuma.c
similarity index 100%
rename from tools/perf/config/feature-checks/test-libnuma.c
rename to tools/build/feature/test-libnuma.c
diff --git a/tools/perf/config/feature-checks/test-libperl.c b/tools/build/feature/test-libperl.c
similarity index 100%
rename from tools/perf/config/feature-checks/test-libperl.c
rename to tools/build/feature/test-libperl.c
diff --git a/tools/perf/config/feature-checks/test-libpython-version.c b/tools/build/feature/test-libpython-version.c
similarity index 100%
rename from tools/perf/config/feature-checks/test-libpython-version.c
rename to tools/build/feature/test-libpython-version.c
diff --git a/tools/perf/config/feature-checks/test-libpython.c b/tools/build/feature/test-libpython.c
similarity index 100%
rename from tools/perf/config/feature-checks/test-libpython.c
rename to tools/build/feature/test-libpython.c
diff --git a/tools/perf/config/feature-checks/test-libslang.c b/tools/build/feature/test-libslang.c
similarity index 100%
rename from tools/perf/config/feature-checks/test-libslang.c
rename to tools/build/feature/test-libslang.c
diff --git a/tools/perf/config/feature-checks/test-libunwind-debug-frame.c b/tools/build/feature/test-libunwind-debug-frame.c
similarity index 100%
rename from tools/perf/config/feature-checks/test-libunwind-debug-frame.c
rename to tools/build/feature/test-libunwind-debug-frame.c
diff --git a/tools/perf/config/feature-checks/test-libunwind.c b/tools/build/feature/test-libunwind.c
similarity index 100%
rename from tools/perf/config/feature-checks/test-libunwind.c
rename to tools/build/feature/test-libunwind.c
diff --git a/tools/perf/config/feature-checks/test-pthread-attr-setaffinity-np.c b/tools/build/feature/test-pthread-attr-setaffinity-np.c
similarity index 100%
rename from tools/perf/config/feature-checks/test-pthread-attr-setaffinity-np.c
rename to tools/build/feature/test-pthread-attr-setaffinity-np.c
diff --git a/tools/perf/config/feature-checks/test-stackprotector-all.c b/tools/build/feature/test-stackprotector-all.c
similarity index 100%
rename from tools/perf/config/feature-checks/test-stackprotector-all.c
rename to tools/build/feature/test-stackprotector-all.c
diff --git a/tools/perf/config/feature-checks/test-sync-compare-and-swap.c b/tools/build/feature/test-sync-compare-and-swap.c
similarity index 100%
rename from tools/perf/config/feature-checks/test-sync-compare-and-swap.c
rename to tools/build/feature/test-sync-compare-and-swap.c
diff --git a/tools/perf/config/feature-checks/test-timerfd.c b/tools/build/feature/test-timerfd.c
similarity index 100%
rename from tools/perf/config/feature-checks/test-timerfd.c
rename to tools/build/feature/test-timerfd.c
diff --git a/tools/perf/config/feature-checks/test-zlib.c b/tools/build/feature/test-zlib.c
similarity index 100%
rename from tools/perf/config/feature-checks/test-zlib.c
rename to tools/build/feature/test-zlib.c
* Unmerged path tools/perf/Makefile.perf
* Unmerged path tools/perf/config/Makefile
