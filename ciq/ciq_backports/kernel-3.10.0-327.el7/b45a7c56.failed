ALSA: line6: Drop superfluous snd_device for PCM

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
Rebuild_CHGLOG: - [alsa] line6: Drop superfluous snd_device for PCM (Jaroslav Kysela) [1197064]
Rebuild_FUZZ: 93.33%
commit-author Takashi Iwai <tiwai@suse.de>
commit b45a7c565473d29bd7e02ac8ca86232a24ca247f
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/b45a7c56.failed

Instead of handling the card-specific resource in snd_device, attach
it into pcm->private_data and release it directly in private_free.
This simplifies the code and structure.

	Tested-by: Chris Rorvick <chris@rorvick.com>
	Signed-off-by: Takashi Iwai <tiwai@suse.de>
(cherry picked from commit b45a7c565473d29bd7e02ac8ca86232a24ca247f)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/staging/line6/pcm.c
diff --cc drivers/staging/line6/pcm.c
index a7856bad3cc6,520cf540e83c..000000000000
--- a/drivers/staging/line6/pcm.c
+++ b/drivers/staging/line6/pcm.c
@@@ -412,69 -413,25 +402,85 @@@ void line6_pcm_disconnect(struct snd_li
  int line6_init_pcm(struct usb_line6 *line6,
  		   struct line6_pcm_properties *properties)
  {
++<<<<<<< HEAD:drivers/staging/line6/pcm.c
 +	static struct snd_device_ops pcm_ops = {
 +		.dev_free = snd_line6_pcm_free,
 +	};
 +
 +	int err;
 +	int ep_read = 0, ep_write = 0;
++=======
+ 	int i, err;
+ 	unsigned ep_read = line6->properties->ep_audio_r;
+ 	unsigned ep_write = line6->properties->ep_audio_w;
+ 	struct snd_pcm *pcm;
++>>>>>>> b45a7c565473 (ALSA: line6: Drop superfluous snd_device for PCM):sound/usb/line6/pcm.c
  	struct snd_line6_pcm *line6pcm;
  
 -	if (!(line6->properties->capabilities & LINE6_CAP_PCM))
 +	if (!(line6->properties->capabilities & LINE6_BIT_PCM))
  		return 0;	/* skip PCM initialization and report success */
  
++<<<<<<< HEAD:drivers/staging/line6/pcm.c
 +	/* initialize PCM subsystem based on product id: */
 +	switch (line6->product) {
 +	case LINE6_DEVID_BASSPODXT:
 +	case LINE6_DEVID_BASSPODXTLIVE:
 +	case LINE6_DEVID_BASSPODXTPRO:
 +	case LINE6_DEVID_PODXT:
 +	case LINE6_DEVID_PODXTLIVE:
 +	case LINE6_DEVID_PODXTPRO:
 +	case LINE6_DEVID_PODHD300:
 +		ep_read = 0x82;
 +		ep_write = 0x01;
 +		break;
 +
 +	case LINE6_DEVID_PODHD500:
 +	case LINE6_DEVID_PODX3:
 +	case LINE6_DEVID_PODX3LIVE:
 +		ep_read = 0x86;
 +		ep_write = 0x02;
 +		break;
 +
 +	case LINE6_DEVID_POCKETPOD:
 +		ep_read = 0x82;
 +		ep_write = 0x02;
 +		break;
 +
 +	case LINE6_DEVID_GUITARPORT:
 +	case LINE6_DEVID_PODSTUDIO_GX:
 +	case LINE6_DEVID_PODSTUDIO_UX1:
 +	case LINE6_DEVID_PODSTUDIO_UX2:
 +	case LINE6_DEVID_TONEPORT_GX:
 +	case LINE6_DEVID_TONEPORT_UX1:
 +	case LINE6_DEVID_TONEPORT_UX2:
 +		ep_read = 0x82;
 +		ep_write = 0x01;
 +		break;
 +
 +	/* this is for interface_number == 1:
 +	case LINE6_DEVID_TONEPORT_UX2:
 +	case LINE6_DEVID_PODSTUDIO_UX2:
 +		ep_read  = 0x87;
 +		ep_write = 0x00;
 +		break; */
 +
 +	default:
 +		MISSING_CASE;
 +	}
 +
 +	line6pcm = kzalloc(sizeof(struct snd_line6_pcm), GFP_KERNEL);
++=======
+ 	err = snd_line6_new_pcm(line6, &pcm);
+ 	if (err < 0)
+ 		return err;
++>>>>>>> b45a7c565473 (ALSA: line6: Drop superfluous snd_device for PCM):sound/usb/line6/pcm.c
  
- 	if (line6pcm == NULL)
+ 	line6pcm = kzalloc(sizeof(*line6pcm), GFP_KERNEL);
+ 	if (!line6pcm)
  		return -ENOMEM;
  
+ 	line6pcm->pcm = pcm;
+ 	line6pcm->properties = properties;
  	line6pcm->volume_playback[0] = line6pcm->volume_playback[1] = 255;
  	line6pcm->volume_monitor = 255;
  	line6pcm->line6 = line6;
@@@ -488,24 -443,16 +494,32 @@@
  			usb_maxpacket(line6->usbdev,
  				usb_sndisocpipe(line6->usbdev, ep_write), 1));
  
++<<<<<<< HEAD:drivers/staging/line6/pcm.c
 +	line6pcm->properties = properties;
 +	line6->line6pcm = line6pcm;
 +
 +	/* PCM device: */
 +	err = snd_device_new(line6->card, SNDRV_DEV_PCM, line6, &pcm_ops);
 +	if (err < 0)
 +		return err;
 +
 +	snd_card_set_dev(line6->card, line6->ifcdev);
 +
 +	err = snd_line6_new_pcm(line6pcm);
 +	if (err < 0)
 +		return err;
 +
++=======
++>>>>>>> b45a7c565473 (ALSA: line6: Drop superfluous snd_device for PCM):sound/usb/line6/pcm.c
  	spin_lock_init(&line6pcm->lock_audio_out);
  	spin_lock_init(&line6pcm->lock_audio_in);
  	spin_lock_init(&line6pcm->lock_trigger);
 -	line6pcm->impulse_period = LINE6_IMPULSE_DEFAULT_PERIOD;
  
+ 	line6->line6pcm = line6pcm;
+ 
+ 	pcm->private_data = line6pcm;
+ 	pcm->private_free = line6_cleanup_pcm;
+ 
  	err = line6_create_audio_out_urbs(line6pcm);
  	if (err < 0)
  		return err;
* Unmerged path drivers/staging/line6/pcm.c
