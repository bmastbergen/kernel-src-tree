ALSA: hda - Move send_cmd / get_response to hdac_bus_ops

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
Rebuild_CHGLOG: - [alsa] hda - Move send_cmd / get_response to hdac_bus_ops (Jaroslav Kysela) [1197064]
Rebuild_FUZZ: 94.34%
commit-author Takashi Iwai <tiwai@suse.de>
commit 7e8be1b309be28e4c92818fed1c55bdac919c7dd
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/7e8be1b3.failed

One less redirection.

	Signed-off-by: Takashi Iwai <tiwai@suse.de>
(cherry picked from commit 7e8be1b309be28e4c92818fed1c55bdac919c7dd)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	sound/pci/hda/hda_codec.c
#	sound/pci/hda/hda_codec.h
#	sound/pci/hda/hda_controller.c
diff --cc sound/pci/hda/hda_codec.c
index d744f45d5fe3,7e3dcaba6365..000000000000
--- a/sound/pci/hda/hda_codec.c
+++ b/sound/pci/hda/hda_codec.c
@@@ -789,11 -532,14 +790,20 @@@ int snd_hda_bus_new(struct snd_card *ca
  	if (!bus)
  		return -ENOMEM;
  
++<<<<<<< HEAD
++=======
+ 	err = snd_hdac_bus_init(&bus->core, card->dev, ops, NULL);
+ 	if (err < 0) {
+ 		kfree(bus);
+ 		return err;
+ 	}
+ 
++>>>>>>> 7e8be1b309be (ALSA: hda - Move send_cmd / get_response to hdac_bus_ops)
  	bus->card = card;
 +	mutex_init(&bus->cmd_mutex);
  	mutex_init(&bus->prepare_mutex);
 +	INIT_LIST_HEAD(&bus->codec_list);
 +	INIT_WORK(&bus->unsol.work, process_unsol_events);
  
  	err = snd_device_new(card, SNDRV_DEV_BUS, bus, &dev_ops);
  	if (err < 0) {
diff --cc sound/pci/hda/hda_codec.h
index 00c6f394c5ce,b4261721d8f1..000000000000
--- a/sound/pci/hda/hda_codec.h
+++ b/sound/pci/hda/hda_codec.h
@@@ -70,10 -42,6 +70,13 @@@ struct hda_pcm_stream
  
  /* bus operators */
  struct hda_bus_ops {
++<<<<<<< HEAD
 +	/* send a single command */
 +	int (*command)(struct hda_bus *bus, unsigned int cmd);
 +	/* get a response from the last command */
 +	unsigned int (*get_response)(struct hda_bus *bus, unsigned int addr);
++=======
++>>>>>>> 7e8be1b309be (ALSA: hda - Move send_cmd / get_response to hdac_bus_ops)
  	/* free the private data */
  	void (*private_free)(struct hda_bus *);
  	/* attach a PCM stream */
diff --cc sound/pci/hda/hda_controller.c
index 0d7233e1e418,666dee232e95..000000000000
--- a/sound/pci/hda/hda_controller.c
+++ b/sound/pci/hda/hda_controller.c
@@@ -1338,18 -1343,24 +1339,29 @@@ static int azx_send_cmd(struct hdac_bu
  }
  
  /* get a response */
++<<<<<<< HEAD
 +static unsigned int azx_get_response(struct hda_bus *bus,
 +				     unsigned int addr)
++=======
+ static int azx_get_response(struct hdac_bus *_bus, unsigned int addr,
+ 			    unsigned int *res)
++>>>>>>> 7e8be1b309be (ALSA: hda - Move send_cmd / get_response to hdac_bus_ops)
  {
+ 	struct hda_bus *bus = to_hda_bus(_bus);
  	struct azx *chip = bus->private_data;
  	if (chip->disabled)
  		return 0;
  	if (chip->single_cmd)
 -		return azx_single_get_response(bus, addr, res);
 +		return azx_single_get_response(bus, addr);
  	else
 -		return azx_rirb_get_response(bus, addr, res);
 +		return azx_rirb_get_response(bus, addr);
  }
  
+ static const struct hdac_bus_ops bus_core_ops = {
+ 	.command = azx_send_cmd,
+ 	.get_response = azx_get_response,
+ };
+ 
  #ifdef CONFIG_SND_HDA_DSP_LOADER
  /*
   * DSP loading code (e.g. for CA0132)
@@@ -1758,15 -1769,17 +1770,29 @@@ static int probe_codec(struct azx *chip
  {
  	unsigned int cmd = (addr << 28) | (AC_NODE_ROOT << 20) |
  		(AC_VERB_PARAMETERS << 8) | AC_PAR_VENDOR_ID;
++<<<<<<< HEAD
 +	unsigned int res;
 +
 +	mutex_lock(&chip->bus->cmd_mutex);
 +	chip->probing = 1;
 +	azx_send_cmd(chip->bus, cmd);
 +	res = azx_get_response(chip->bus, addr);
 +	chip->probing = 0;
 +	mutex_unlock(&chip->bus->cmd_mutex);
 +	if (res == -1)
++=======
+ 	struct hdac_bus *bus = &chip->bus->core;
+ 	int err;
+ 	unsigned int res;
+ 
+ 	mutex_lock(&bus->cmd_mutex);
+ 	chip->probing = 1;
+ 	azx_send_cmd(bus, cmd);
+ 	err = azx_get_response(bus, addr, &res);
+ 	chip->probing = 0;
+ 	mutex_unlock(&bus->cmd_mutex);
+ 	if (err < 0 || res == -1)
++>>>>>>> 7e8be1b309be (ALSA: hda - Move send_cmd / get_response to hdac_bus_ops)
  		return -EIO;
  	dev_dbg(chip->card->dev, "codec #%d probed OK\n", addr);
  	return 0;
@@@ -1822,13 -1819,8 +1848,11 @@@ static int get_jackpoll_interval(struc
  }
  
  static struct hda_bus_ops bus_ops = {
- 	.command = azx_send_cmd,
- 	.get_response = azx_get_response,
  	.attach_pcm = azx_attach_pcm_stream,
  	.bus_reset = azx_bus_reset,
 +#ifdef CONFIG_PM
 +	.pm_notify = azx_power_notify,
 +#endif
  #ifdef CONFIG_SND_HDA_DSP_LOADER
  	.load_dsp_prepare = azx_load_dsp_prepare,
  	.load_dsp_trigger = azx_load_dsp_trigger,
* Unmerged path sound/pci/hda/hda_codec.c
* Unmerged path sound/pci/hda/hda_codec.h
* Unmerged path sound/pci/hda/hda_controller.c
