ALSA: line6/toneport: Move setup_timer() at the beginning

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
Rebuild_CHGLOG: - [alsa] line6/toneport: Move setup_timer() at the beginning (Jaroslav Kysela) [1197064]
Rebuild_FUZZ: 94.44%
commit-author Takashi Iwai <tiwai@suse.de>
commit 6dd1c05cd7c26a463bbcca1ab50b59b86d88de64
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/6dd1c05c.failed

... so that timer_del_sync() in the destructor can be called safely at
any time.  Also move the mod_timer() call in toneport_setup(), which
is a bit clearer place.

	Tested-by: Chris Rorvick <chris@rorvick.com>
	Signed-off-by: Takashi Iwai <tiwai@suse.de>
(cherry picked from commit 6dd1c05cd7c26a463bbcca1ab50b59b86d88de64)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/staging/line6/toneport.c
diff --cc drivers/staging/line6/toneport.c
index 4f8fc09cde1e,fb6d5e1e2ade..000000000000
--- a/drivers/staging/line6/toneport.c
+++ b/drivers/staging/line6/toneport.c
@@@ -314,29 -354,48 +314,38 @@@ static void toneport_setup(struct usb_l
  		toneport_send_cmd(usbdev,
  				  toneport_source_info[toneport->source].code,
  				  0x0000);
 -	default:
 -		break;
  	}
  
 -	if (toneport_has_led(toneport->type))
 +	if (toneport_has_led(usbdev->descriptor.idProduct))
  		toneport_update_led(&usbdev->dev);
+ 
+ 	mod_timer(&toneport->timer, jiffies + TONEPORT_PCM_DELAY * HZ);
  }
  
 -/*
 -	Toneport device disconnected.
 -*/
 -static void line6_toneport_disconnect(struct usb_interface *interface)
 -{
 -	struct usb_line6_toneport *toneport;
 -	u16 idProduct;
 -
 -	toneport = usb_get_intfdata(interface);
 -	del_timer_sync(&toneport->timer);
 -	idProduct = le16_to_cpu(toneport->line6.usbdev->descriptor.idProduct);
 -
 -	if (toneport_has_led(idProduct)) {
 -		device_remove_file(&interface->dev, &dev_attr_led_red);
 -		device_remove_file(&interface->dev, &dev_attr_led_green);
 -	}
 -}
 -
 -
  /*
  	 Try to init Toneport device.
  */
 -static int toneport_init(struct usb_interface *interface,
 -			 struct usb_line6 *line6)
 +static int toneport_try_init(struct usb_interface *interface,
 +			     struct usb_line6_toneport *toneport)
  {
  	int err;
 -	struct usb_line6_toneport *toneport =  (struct usb_line6_toneport *) line6;
 +	struct usb_line6 *line6 = &toneport->line6;
 +	struct usb_device *usbdev = line6->usbdev;
  
++<<<<<<< HEAD:drivers/staging/line6/toneport.c
 +	if ((interface == NULL) || (toneport == NULL))
 +		return -ENODEV;
 +
 +	/* initialize audio system: */
 +	err = line6_init_audio(line6);
 +	if (err < 0)
 +		return err;
++=======
+ 	setup_timer(&toneport->timer, toneport_start_pcm,
+ 		    (unsigned long)toneport);
+ 
+ 	line6->disconnect = line6_toneport_disconnect;
++>>>>>>> 6dd1c05cd7c2 (ALSA: line6/toneport: Move setup_timer() at the beginning):sound/usb/line6/toneport.c
  
  	/* initialize PCM subsystem: */
  	err = line6_init_pcm(line6, &toneport_pcm_properties);
@@@ -381,27 -440,11 +390,32 @@@
  
  	toneport_setup(toneport);
  
++<<<<<<< HEAD:drivers/staging/line6/toneport.c
 +	setup_timer(&toneport->timer, toneport_start_pcm,
 +		    (unsigned long)toneport);
 +	mod_timer(&toneport->timer, jiffies + TONEPORT_PCM_DELAY * HZ);
 +
 +	return 0;
 +}
 +
 +/*
 +	 Init Toneport device (and clean up in case of failure).
 +*/
 +int line6_toneport_init(struct usb_interface *interface,
 +			struct usb_line6_toneport *toneport)
 +{
 +	int err = toneport_try_init(interface, toneport);
 +
 +	if (err < 0)
 +		toneport_destruct(interface);
 +
 +	return err;
++=======
+ 	/* register audio system: */
+ 	return snd_card_register(line6->card);
++>>>>>>> 6dd1c05cd7c2 (ALSA: line6/toneport: Move setup_timer() at the beginning):sound/usb/line6/toneport.c
  }
  
 -#ifdef CONFIG_PM
  /*
  	Resume Toneport device after reset.
  */
* Unmerged path drivers/staging/line6/toneport.c
