ALSA: hda - Fix click noise at start on Dell XPS13

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
Rebuild_CHGLOG: - [alsa] hda - Fix click noise at start on Dell XPS13 (Jaroslav Kysela) [1197064]
Rebuild_FUZZ: 93.62%
commit-author Takashi Iwai <tiwai@suse.de>
commit 3e1b0c4a9d563d7fc6e22dc92613cd3237bb5ce0
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/3e1b0c4a.failed

Dell XPS13 produces a click noise at boot up, and Gabriele spotted out
that it's triggered by the initial pin control of the mic (NID 0x19).
This has to be set to Hi-Z Vref while the driver initializes to Vref
80% as a normal mic.

This patch fixes the generic parser code not to override the target
vref if it has been already set by the driver, and adds a proper
initialization of the target vref for this pin in the Realtek driver
side.

Reported-and-tested-by: Gabriele Mazzotta <gabriele.mzt@gmail.com>
	Signed-off-by: Takashi Iwai <tiwai@suse.de>
(cherry picked from commit 3e1b0c4a9d563d7fc6e22dc92613cd3237bb5ce0)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	sound/pci/hda/patch_realtek.c
diff --cc sound/pci/hda/patch_realtek.c
index 89c320d60a91,e2afd53cc14c..000000000000
--- a/sound/pci/hda/patch_realtek.c
+++ b/sound/pci/hda/patch_realtek.c
@@@ -4194,13 -4190,19 +4194,24 @@@ static unsigned int alc_power_filter_xp
  static void alc_fixup_dell_xps13(struct hda_codec *codec,
  				const struct hda_fixup *fix, int action)
  {
- 	if (action == HDA_FIXUP_ACT_PROBE) {
- 		struct alc_spec *spec = codec->spec;
- 		struct hda_input_mux *imux = &spec->gen.input_mux;
- 		int i;
+ 	struct alc_spec *spec = codec->spec;
+ 	struct hda_input_mux *imux = &spec->gen.input_mux;
+ 	int i;
  
++<<<<<<< HEAD
 +		spec->shutup = alc_no_shutup;
 +		codec->power_filter = alc_power_filter_xps13;
++=======
+ 	switch (action) {
+ 	case HDA_FIXUP_ACT_PRE_PROBE:
+ 		/* mic pin 0x19 must be initialized with Vref Hi-Z, otherwise
+ 		 * it causes a click noise at start up
+ 		 */
+ 		snd_hda_codec_set_pin_target(codec, 0x19, PIN_VREFHIZ);
+ 		break;
+ 	case HDA_FIXUP_ACT_PROBE:
+ 		spec->shutup = alc_shutup_dell_xps13;
++>>>>>>> 3e1b0c4a9d56 (ALSA: hda - Fix click noise at start on Dell XPS13)
  
  		/* Make the internal mic the default input source. */
  		for (i = 0; i < imux->num_items; i++) {
diff --git a/sound/pci/hda/hda_generic.c b/sound/pci/hda/hda_generic.c
index 6bea9c07d551..22595bc663c1 100644
--- a/sound/pci/hda/hda_generic.c
+++ b/sound/pci/hda/hda_generic.c
@@ -3261,7 +3261,8 @@ static int create_input_ctls(struct hda_codec *codec)
 		val = PIN_IN;
 		if (cfg->inputs[i].type == AUTO_PIN_MIC)
 			val |= snd_hda_get_default_vref(codec, pin);
-		if (pin != spec->hp_mic_pin)
+		if (pin != spec->hp_mic_pin &&
+		    !snd_hda_codec_get_pin_target(codec, pin))
 			set_pin_target(codec, pin, val, false);
 
 		if (mixer) {
* Unmerged path sound/pci/hda/patch_realtek.c
