powercap / RAPL: further relax energy counter checks

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
Rebuild_CHGLOG: - [powercap] rapl: further relax energy counter checks (Prarit Bhargava) [1238347]
Rebuild_FUZZ: 88.17%
commit-author Jacob Pan <jacob.jun.pan@linux.intel.com>
commit 9d31c676c6019df0c078950a0ddca87da4706b14
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/9d31c676.failed

Energy counters may roll slowly for some RAPL domains, checking all
of them can be time consuming and takes unpredictable amount of time.
Therefore, we relax the sanity check by only checking availability of the
MSRs and non-zero value of the energy status counters. It has been shown
sufficient for all the platforms tested to filter out inactive domains.

	Signed-off-by: Jacob Pan <jacob.jun.pan@linux.intel.com>
	Acked-by: Durgadoss R <durgadoss.r@intel.com>
	Signed-off-by: Rafael J. Wysocki <rafael.j.wysocki@intel.com>
(cherry picked from commit 9d31c676c6019df0c078950a0ddca87da4706b14)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/powercap/intel_rapl.c
diff --cc drivers/powercap/intel_rapl.c
index 299a8496dbe2,1c987d20c6b8..000000000000
--- a/drivers/powercap/intel_rapl.c
+++ b/drivers/powercap/intel_rapl.c
@@@ -1147,21 -1143,13 +1146,28 @@@ static int rapl_check_domain(int cpu, i
  		pr_err("invalid domain id %d\n", domain);
  		return -EINVAL;
  	}
- 	if (rdmsrl_safe_on_cpu(cpu, msr, &val1))
+ 	/* make sure domain counters are available and contains non-zero
+ 	 * values, otherwise skip it.
+ 	 */
+ 	if (rdmsrl_safe_on_cpu(cpu, msr, &val) || !val)
  		return -ENODEV;
  
++<<<<<<< HEAD
 +	/* energy counters roll slowly on some domains */
 +	while (++retry < 10) {
 +		usleep_range(10000, 15000);
 +		rdmsrl_safe_on_cpu(cpu, msr, &val2);
 +		if ((val1 & ENERGY_STATUS_MASK) != (val2 & ENERGY_STATUS_MASK))
 +			return 0;
 +	}
 +	/* if energy counter does not change, report as bad domain */
 +	pr_info("domain %s energy ctr %llu:%llu not working, skip\n",
 +		rapl_domain_names[domain], val1, val2);
 +
 +	return -ENODEV;
++=======
+ 	return 0;
++>>>>>>> 9d31c676c601 (powercap / RAPL: further relax energy counter checks)
  }
  
  /* Detect active and valid domains for the given CPU, caller must
* Unmerged path drivers/powercap/intel_rapl.c
