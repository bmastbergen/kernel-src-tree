regmap: regcache-rbtree: Fix present bitmap resize

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
commit-author Lars-Peter Clausen <lars@metafoo.de>
commit 328f494d95aac8bd4896aea2328bc281053bcb71
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/328f494d.failed

When inserting a new register into a block at the lower end the present
bitmap is currently shifted into the wrong direction. The effect of this is
that the bitmap becomes corrupted and registers which are present might be
reported as not present and vice versa.

Fix this by shifting left rather than right.

Fixes: 472fdec7380c("regmap: rbtree: Reduce number of nodes, take 2")
	Reported-by: Daniel Baluta <daniel.baluta@gmail.com>
	Signed-off-by: Lars-Peter Clausen <lars@metafoo.de>
	Signed-off-by: Mark Brown <broonie@kernel.org>
	Cc: stable@vger.kernel.org
(cherry picked from commit 328f494d95aac8bd4896aea2328bc281053bcb71)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/base/regmap/regcache-rbtree.c
diff --cc drivers/base/regmap/regcache-rbtree.c
index 1c02c0706128,81751a49d8bf..000000000000
--- a/drivers/base/regmap/regcache-rbtree.c
+++ b/drivers/base/regmap/regcache-rbtree.c
@@@ -297,10 -296,19 +297,15 @@@ static int regcache_rbtree_insert_to_bl
  	if (!blk)
  		return -ENOMEM;
  
 -	present = krealloc(rbnode->cache_present,
 -		    BITS_TO_LONGS(blklen) * sizeof(*present), GFP_KERNEL);
 -	if (!present) {
 -		kfree(blk);
 -		return -ENOMEM;
 -	}
 -
  	/* insert the register value in the correct place in the rbnode block */
 -	if (pos == 0) {
 +	if (pos == 0)
  		memmove(blk + offset * map->cache_word_size,
  			blk, rbnode->blklen * map->cache_word_size);
++<<<<<<< HEAD
++=======
+ 		bitmap_shift_left(present, present, offset, blklen);
+ 	}
++>>>>>>> 328f494d95aa (regmap: regcache-rbtree: Fix present bitmap resize)
  
  	/* update the rbnode block, its size and the base register */
  	rbnode->block = blk;
* Unmerged path drivers/base/regmap/regcache-rbtree.c
