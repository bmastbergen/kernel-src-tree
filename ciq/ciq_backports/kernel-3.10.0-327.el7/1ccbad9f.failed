nfs: fix DIO good bytes calculation

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
commit-author Peng Tao <tao.peng@primarydata.com>
commit 1ccbad9f9f9bd36db26a10f0b17fbaf12b3ae93a
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/1ccbad9f.failed

For direct read that has IO size larger than rsize, we'll split
it into several READ requests and nfs_direct_good_bytes() would
count completed bytes incorrectly by eating last zero count reply.

Fix it by handling mirror and non-mirror cases differently such that
we only count mirrored writes differently.

This fixes 5fadeb47("nfs: count DIO good bytes correctly with mirroring").

	Reported-by: Jean Spector <jean@primarydata.com>
	Cc: <stable@vger.kernel.org> # v3.19+
	Signed-off-by: Peng Tao <tao.peng@primarydata.com>
	Signed-off-by: Trond Myklebust <trond.myklebust@primarydata.com>
(cherry picked from commit 1ccbad9f9f9bd36db26a10f0b17fbaf12b3ae93a)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/nfs/direct.c
diff --cc fs/nfs/direct.c
index 74e3798cd593,e97a67e40b48..000000000000
--- a/fs/nfs/direct.c
+++ b/fs/nfs/direct.c
@@@ -108,6 -117,41 +108,44 @@@ static inline int put_dreq(struct nfs_d
  	return atomic_dec_and_test(&dreq->io_count);
  }
  
++<<<<<<< HEAD
++=======
+ void nfs_direct_set_resched_writes(struct nfs_direct_req *dreq)
+ {
+ 	dreq->flags = NFS_ODIRECT_RESCHED_WRITES;
+ }
+ EXPORT_SYMBOL_GPL(nfs_direct_set_resched_writes);
+ 
+ static void
+ nfs_direct_good_bytes(struct nfs_direct_req *dreq, struct nfs_pgio_header *hdr)
+ {
+ 	int i;
+ 	ssize_t count;
+ 
+ 	WARN_ON_ONCE(hdr->pgio_mirror_idx >= dreq->mirror_count);
+ 
+ 	if (dreq->mirror_count == 1) {
+ 		dreq->mirrors[hdr->pgio_mirror_idx].count += hdr->good_bytes;
+ 		dreq->count += hdr->good_bytes;
+ 	} else {
+ 		/* mirrored writes */
+ 		count = dreq->mirrors[hdr->pgio_mirror_idx].count;
+ 		if (count + dreq->io_start < hdr->io_start + hdr->good_bytes) {
+ 			count = hdr->io_start + hdr->good_bytes - dreq->io_start;
+ 			dreq->mirrors[hdr->pgio_mirror_idx].count = count;
+ 		}
+ 		/* update the dreq->count by finding the minimum agreed count from all
+ 		 * mirrors */
+ 		count = dreq->mirrors[0].count;
+ 
+ 		for (i = 1; i < dreq->mirror_count; i++)
+ 			count = min(count, dreq->mirrors[i].count);
+ 
+ 		dreq->count = count;
+ 	}
+ }
+ 
++>>>>>>> 1ccbad9f9f9b (nfs: fix DIO good bytes calculation)
  /*
   * nfs_direct_select_verf - select the right verifier
   * @dreq - direct request possibly spanning multiple servers
* Unmerged path fs/nfs/direct.c
