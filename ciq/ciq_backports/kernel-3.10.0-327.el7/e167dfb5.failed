blk-mq: add BLK_MQ_F_DEFER_ISSUE support flag

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
commit-author Jens Axboe <axboe@fb.com>
commit e167dfb53cb85fde7b15f644e9dbef7ba31896b6
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/e167dfb5.failed

Drivers can now tell blk-mq if they take advantage of the deferred
issue through 'last' or not. If they do, don't do queue-direct
for sync IO. This is a preparation patch for the nvme conversion.

	Signed-off-by: Jens Axboe <axboe@fb.com>
(cherry picked from commit e167dfb53cb85fde7b15f644e9dbef7ba31896b6)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	block/blk-mq.c
#	include/linux/blk-mq.h
diff --cc block/blk-mq.c
index 13238b516d55,b355b5957cd7..000000000000
--- a/block/blk-mq.c
+++ b/block/blk-mq.c
@@@ -1219,7 -1172,17 +1219,21 @@@ static void blk_mq_make_request(struct 
  		goto run_queue;
  	}
  
++<<<<<<< HEAD
 +	if (is_sync) {
++=======
+ 	/*
+ 	 * If the driver supports defer issued based on 'last', then
+ 	 * queue it up like normal since we can potentially save some
+ 	 * CPU this way.
+ 	 */
+ 	if (is_sync && !(data.hctx->flags & BLK_MQ_F_DEFER_ISSUE)) {
+ 		struct blk_mq_queue_data bd = {
+ 			.rq = rq,
+ 			.list = NULL,
+ 			.last = 1
+ 		};
++>>>>>>> e167dfb53cb8 (blk-mq: add BLK_MQ_F_DEFER_ISSUE support flag)
  		int ret;
  
  		blk_mq_bio_to_request(rq, bio);
diff --cc include/linux/blk-mq.h
index a58379f22a1c,c3b64ec5321e..000000000000
--- a/include/linux/blk-mq.h
+++ b/include/linux/blk-mq.h
@@@ -176,10 -143,10 +176,17 @@@ enum 
  	BLK_MQ_RQ_QUEUE_ERROR	= 2,	/* end IO with error */
  
  	BLK_MQ_F_SHOULD_MERGE	= 1 << 0,
++<<<<<<< HEAD
 +	BLK_MQ_F_SHOULD_SORT	= 1 << 1,
 +	BLK_MQ_F_TAG_SHARED	= 1 << 2,
 +	BLK_MQ_F_SG_MERGE	= 1 << 3,
 +	BLK_MQ_F_SYSFS_UP	= 1 << 4,
++=======
+ 	BLK_MQ_F_TAG_SHARED	= 1 << 1,
+ 	BLK_MQ_F_SG_MERGE	= 1 << 2,
+ 	BLK_MQ_F_SYSFS_UP	= 1 << 3,
+ 	BLK_MQ_F_DEFER_ISSUE	= 1 << 4,
++>>>>>>> e167dfb53cb8 (blk-mq: add BLK_MQ_F_DEFER_ISSUE support flag)
  
  	BLK_MQ_S_STOPPED	= 0,
  	BLK_MQ_S_TAG_ACTIVE	= 1,
* Unmerged path block/blk-mq.c
* Unmerged path include/linux/blk-mq.h
