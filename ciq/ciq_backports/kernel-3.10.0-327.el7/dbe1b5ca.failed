xfs: Make xfs_vn_rename compliant with renameat2() syscall

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
commit-author Carlos Maiolino <cmaiolino@redhat.com>
commit dbe1b5ca26396b6c61d711c8ac4de13ebb02e9f6
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/dbe1b5ca.failed

To be able to support RENAME_EXCHANGE flag from renameat2() system
call, XFS must have its inode_operations updated, exporting .rename2
method, instead of .rename.

This patch just replaces the (now old) .rename method by .rename2,
using the same infra-structure, but checking rename flags.  Calls to
.rename2 using RENAME_EXCHANGE flag, although now handled inside
XFS, still return -EINVAL.

RENAME_NOREPLACE is handled via VFS and we don't need to care about
it inside xfs_vn_rename.

	Signed-off-by: Carlos Maiolino <cmaiolino@redhat.com>
	Reviewed-by: Brian Foster <bfoster@redhat.com>
	Signed-off-by: Dave Chinner <david@fromorbit.com>


(cherry picked from commit dbe1b5ca26396b6c61d711c8ac4de13ebb02e9f6)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/xfs/xfs_iops.c
diff --cc fs/xfs/xfs_iops.c
index bb87ff3ee39b,abb838a565ee..000000000000
--- a/fs/xfs/xfs_iops.c
+++ b/fs/xfs/xfs_iops.c
@@@ -367,9 -394,9 +372,15 @@@ xfs_vn_rename
  	xfs_dentry_to_name(&oname, odentry, 0);
  	xfs_dentry_to_name(&nname, ndentry, odentry->d_inode->i_mode);
  
++<<<<<<< HEAD
 +	return -xfs_rename(XFS_I(odir), &oname, XFS_I(odentry->d_inode),
 +			   XFS_I(ndir), &nname, new_inode ?
 +						XFS_I(new_inode) : NULL);
++=======
+ 	return xfs_rename(XFS_I(odir), &oname, XFS_I(odentry->d_inode),
+ 			  XFS_I(ndir), &nname,
+ 			  new_inode ? XFS_I(new_inode) : NULL);
++>>>>>>> dbe1b5ca2639 (xfs: Make xfs_vn_rename compliant with renameat2() syscall)
  }
  
  /*
@@@ -1124,8 -1149,9 +1135,8 @@@ static const struct inode_operations xf
  	 */
  	.rmdir			= xfs_vn_unlink,
  	.mknod			= xfs_vn_mknod,
- 	.rename			= xfs_vn_rename,
+ 	.rename2		= xfs_vn_rename,
  	.get_acl		= xfs_get_acl,
 -	.set_acl		= xfs_set_acl,
  	.getattr		= xfs_vn_getattr,
  	.setattr		= xfs_vn_setattr,
  	.setxattr		= generic_setxattr,
@@@ -1150,8 -1177,9 +1161,8 @@@ static const struct inode_operations xf
  	 */
  	.rmdir			= xfs_vn_unlink,
  	.mknod			= xfs_vn_mknod,
- 	.rename			= xfs_vn_rename,
+ 	.rename2		= xfs_vn_rename,
  	.get_acl		= xfs_get_acl,
 -	.set_acl		= xfs_set_acl,
  	.getattr		= xfs_vn_getattr,
  	.setattr		= xfs_vn_setattr,
  	.setxattr		= generic_setxattr,
* Unmerged path fs/xfs/xfs_iops.c
