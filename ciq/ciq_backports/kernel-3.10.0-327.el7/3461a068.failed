PCI: pciehp: Wait for hotplug command completion lazily

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
Rebuild_CHGLOG: - [pci] pciehp: Wait for hotplug command completion lazily (Myron Stowe) [1223472]
Rebuild_FUZZ: 95.24%
commit-author Bjorn Helgaas <bhelgaas@google.com>
commit 3461a068661cd8b833ede63c5a5f089839ae98f8
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/3461a068.failed

Previously we issued a hotplug command and waited for it to complete.  But
there's no need to wait until we're ready to issue the *next* command.  The
next command will probably be much later, so the first one may have already
completed and we may not have to actually wait at all.

Because of hardware errata, some controllers generate command completion
events for some commands but not others.  In the case of Intel CF118 (see
spec update reference), the controller indicates command completion only
for Slot Control writes that change the value of the following bits:

  Power Controller Control
  Power Indicator Control
  Attention Indicator Control
  Electromechanical Interlock Control

Changes to other bits, e.g., the interrupt enable bits, do not cause the
Command Completed bit to be set.  Controllers from AMD and Nvidia are
reported to have similar errata.

These errata cause timeouts when pcie_enable_notification() enables
interrupts.  Previously that timeout occurred at boot-time.  With this
change, the timeout occurs later, when we change the state of the slot
power, indicators, or interlock.  This speeds up boot but causes a timeout
at the first hotplug event on the slot.  Subsequent events don't timeout
because only the first (boot-time) hotplug command updates Slot Control
without touching the power/indicator/interlock controls.

Link: http://www.intel.com/content/www/us/en/processors/xeon/xeon-e7-v2-spec-update.html
	Tested-by: Rajat Jain <rajatxjain@gmail.com>	(IDT 807a controller)
	Signed-off-by: Bjorn Helgaas <bhelgaas@google.com>
	Acked-by: Yinghai Lu <yinghai@kernel.org>
(cherry picked from commit 3461a068661cd8b833ede63c5a5f089839ae98f8)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/pci/hotplug/pciehp_hpc.c
diff --cc drivers/pci/hotplug/pciehp_hpc.c
index f253bb808636,b3e700d2a7f7..000000000000
--- a/drivers/pci/hotplug/pciehp_hpc.c
+++ b/drivers/pci/hotplug/pciehp_hpc.c
@@@ -189,22 -201,8 +192,25 @@@ static void pcie_write_cmd(struct contr
  	ctrl->cmd_busy = 1;
  	smp_mb();
  	pcie_capability_write_word(pdev, PCI_EXP_SLTCTL, slot_ctrl);
 -	ctrl->slot_ctrl = slot_ctrl;
  
++<<<<<<< HEAD
 +	/*
 +	 * Wait for command completion.
 +	 */
 +	if (!ctrl->no_cmd_complete) {
 +		int poll = 0;
 +		/*
 +		 * if hotplug interrupt is not enabled or command
 +		 * completed interrupt is not enabled, we need to poll
 +		 * command completed event.
 +		 */
 +		if (!(slot_ctrl & PCI_EXP_SLTCTL_HPIE) ||
 +		    !(slot_ctrl & PCI_EXP_SLTCTL_CCIE))
 +			poll = 1;
 +                pcie_wait_cmd(ctrl, poll);
 +	}
++=======
++>>>>>>> 3461a068661c (PCI: pciehp: Wait for hotplug command completion lazily)
  	mutex_unlock(&ctrl->ctrl_lock);
  }
  
* Unmerged path drivers/pci/hotplug/pciehp_hpc.c
