ACPI / video: Add systems that should favour native backlight interface

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
Rebuild_CHGLOG: - [acpi] video: Add systems that should favour native backlight interface (Benjamin Tissoires) [1218354]
Rebuild_FUZZ: 94.81%
commit-author Aaron Lu <aaron.lu@intel.com>
commit 0e9f81d3b7cd0649a3bc437391b6a0650f98f844
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/0e9f81d3.failed

Some system's ACPI video backlight control interface is broken and the
native backlight control interface should be used by default. This patch
sets the use_native_backlight parameter to true for those systems so
that video backlight control interface will not be created. For detailed
models that are added here, reference the following list.

Note that the user specified kernel cmdline option will always have the
highest priority, i.e. if use_native_backlight=0 is specified and the
system is in the DMI table, the video module will not skip registering
backlight interface for it.

Thinkpad T430s:
	Reported-by: Theodore Tso <tytso@mit.edu>
Reported-and-tested-by: Peter Weber <bugs@ttyhoney.com>
References: https://bugzilla.kernel.org/show_bug.cgi?id=51231
Thinkpad X230:
Reported-and-tested-by: Igor Gnatenko <i.gnatenko.brain@gmail.com>
References: https://bugzilla.kernel.org/show_bug.cgi?id=51231
ThinkPad X1 Carbon:
Reported-and-tested-by: Igor Gnatenko <i.gnatenko.brain@gmail.com>
Lenovo Yoga 13:
	Reported-by: Lennart Poettering <lennart@poettering.net>
Reported-and-tested-by: Kevin Smith <thirdwiggin@gmail.com>
References: https://bugzilla.kernel.org/show_bug.cgi?id=63811
Dell Inspiron 7520:
	Reported-by: Rinat Ibragimov <ibragimovrinat@mail.ru>
Acer Aspire 5733Z:
	Reported-by: <sov.info@mail.ru>
References: https://bugzilla.kernel.org/show_bug.cgi?id=62941
Acer Aspire V5-431:
	Reported-by: Thomas Christensen <christensenthomas@gmail.com>
References: https://bugzilla.kernel.org/show_bug.cgi?id=68751
HP ProBook 4340s:
Reported-and-tested-by: Vladimir Sherenkov <a_12300@mail.ru>
References: http://redmine.russianfedora.pro/issues/1258
HP EliteBook/ProBook 2013 models, ZBook and some others:
Provided-by: Takashi Iwai <tiwai@suse.de>
	Signed-off-by: Aaron Lu <aaron.lu@intel.com>
	Tested-by: Mika Westerberg <mika.westerberg@linux.intel.com>
	Signed-off-by: Rafael J. Wysocki <rafael.j.wysocki@intel.com>
(cherry picked from commit 0e9f81d3b7cd0649a3bc437391b6a0650f98f844)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/acpi/video.c
diff --cc drivers/acpi/video.c
index ece8a0d517fe,b6ba88ed31ae..000000000000
--- a/drivers/acpi/video.c
+++ b/drivers/acpi/video.c
@@@ -80,13 -81,16 +80,22 @@@ static bool allow_duplicates
  module_param(allow_duplicates, bool, 0644);
  
  /*
++<<<<<<< HEAD
 + * Some BIOSes claim they use minimum backlight at boot,
 + * and this may bring dimming screen after boot
 + */
 +static bool use_bios_initial_backlight = 1;
 +module_param(use_bios_initial_backlight, bool, 0644);
++=======
+  * For Windows 8 systems: used to decide if video module
+  * should skip registering backlight interface of its own.
+  */
+ static int use_native_backlight_param = -1;
+ module_param_named(use_native_backlight, use_native_backlight_param, int, 0444);
+ static bool use_native_backlight_dmi = false;
++>>>>>>> 0e9f81d3b7cd (ACPI / video: Add systems that should favour native backlight interface)
  
 -static int register_count;
 -static struct mutex video_list_lock;
 -static struct list_head video_bus_head;
 +static int register_count = 0;
  static int acpi_video_bus_add(struct acpi_device *device);
  static int acpi_video_bus_remove(struct acpi_device *device);
  static void acpi_video_bus_notify(struct acpi_device *device, u32 event);
@@@ -227,6 -232,22 +236,25 @@@ static int acpi_video_get_next_level(st
  static int acpi_video_switch_brightness(struct acpi_video_device *device,
  					 int event);
  
++<<<<<<< HEAD
++=======
+ static bool acpi_video_use_native_backlight(void)
+ {
+ 	if (use_native_backlight_param != -1)
+ 		return use_native_backlight_param;
+ 	else
+ 		return use_native_backlight_dmi;
+ }
+ 
+ static bool acpi_video_verify_backlight_support(void)
+ {
+ 	if (acpi_osi_is_win8() && acpi_video_use_native_backlight() &&
+ 	    backlight_device_registered(BACKLIGHT_RAW))
+ 		return false;
+ 	return acpi_video_backlight_support();
+ }
+ 
++>>>>>>> 0e9f81d3b7cd (ACPI / video: Add systems that should favour native backlight interface)
  /* backlight device sysfs support */
  static int acpi_video_get_brightness(struct backlight_device *bd)
  {
@@@ -388,9 -407,9 +416,15 @@@ static int __init video_set_bqc_offset(
  	return 0;
  }
  
++<<<<<<< HEAD
 +static int video_ignore_initial_backlight(const struct dmi_system_id *d)
 +{
 +	use_bios_initial_backlight = 0;
++=======
+ static int __init video_set_use_native_backlight(const struct dmi_system_id *d)
+ {
+ 	use_native_backlight_dmi = true;
++>>>>>>> 0e9f81d3b7cd (ACPI / video: Add systems that should favour native backlight interface)
  	return 0;
  }
  
@@@ -439,51 -458,117 +473,165 @@@ static struct dmi_system_id video_dmi_t
  		},
  	},
  	{
++<<<<<<< HEAD
 +	 .callback = video_ignore_initial_backlight,
 +	 .ident = "HP Folio 13-2000",
 +	 .matches = {
 +		DMI_MATCH(DMI_BOARD_VENDOR, "Hewlett-Packard"),
 +		DMI_MATCH(DMI_PRODUCT_NAME, "HP Folio 13 - 2000 Notebook PC"),
 +		},
 +	},
 +	{
 +	 .callback = video_ignore_initial_backlight,
 +	 .ident = "Fujitsu E753",
 +	 .matches = {
 +		DMI_MATCH(DMI_BOARD_VENDOR, "FUJITSU"),
 +		DMI_MATCH(DMI_PRODUCT_NAME, "LIFEBOOK E753"),
 +		},
 +	},
 +	{
 +	 .callback = video_ignore_initial_backlight,
 +	 .ident = "HP Pavilion dm4",
 +	 .matches = {
 +		DMI_MATCH(DMI_BOARD_VENDOR, "Hewlett-Packard"),
 +		DMI_MATCH(DMI_PRODUCT_NAME, "HP Pavilion dm4 Notebook PC"),
 +		},
 +	},
 +	{
 +	 .callback = video_ignore_initial_backlight,
 +	 .ident = "HP Pavilion g6 Notebook PC",
 +	 .matches = {
 +		 DMI_MATCH(DMI_BOARD_VENDOR, "Hewlett-Packard"),
 +		 DMI_MATCH(DMI_PRODUCT_NAME, "HP Pavilion g6 Notebook PC"),
 +		},
 +	},
 +	{
 +	 .callback = video_ignore_initial_backlight,
 +	 .ident = "HP 1000 Notebook PC",
 +	 .matches = {
 +		DMI_MATCH(DMI_BOARD_VENDOR, "Hewlett-Packard"),
 +		DMI_MATCH(DMI_PRODUCT_NAME, "HP 1000 Notebook PC"),
 +		},
 +	},
 +	{
 +	 .callback = video_ignore_initial_backlight,
 +	 .ident = "HP Pavilion m4",
 +	 .matches = {
 +		DMI_MATCH(DMI_BOARD_VENDOR, "Hewlett-Packard"),
 +		DMI_MATCH(DMI_PRODUCT_NAME, "HP Pavilion m4 Notebook PC"),
++=======
+ 	 .callback = video_set_use_native_backlight,
+ 	 .ident = "ThinkPad T430s",
+ 	 .matches = {
+ 		DMI_MATCH(DMI_SYS_VENDOR, "LENOVO"),
+ 		DMI_MATCH(DMI_PRODUCT_VERSION, "ThinkPad T430s"),
+ 		},
+ 	},
+ 	{
+ 	 .callback = video_set_use_native_backlight,
+ 	 .ident = "ThinkPad X230",
+ 	 .matches = {
+ 		DMI_MATCH(DMI_SYS_VENDOR, "LENOVO"),
+ 		DMI_MATCH(DMI_PRODUCT_VERSION, "ThinkPad X230"),
+ 		},
+ 	},
+ 	{
+ 	.callback = video_set_use_native_backlight,
+ 	.ident = "ThinkPad X1 Carbon",
+ 	.matches = {
+ 		DMI_MATCH(DMI_SYS_VENDOR, "LENOVO"),
+ 		DMI_MATCH(DMI_PRODUCT_VERSION, "ThinkPad X1 Carbon"),
+ 		},
+ 	},
+ 	{
+ 	 .callback = video_set_use_native_backlight,
+ 	 .ident = "Lenovo Yoga 13",
+ 	 .matches = {
+ 		DMI_MATCH(DMI_SYS_VENDOR, "LENOVO"),
+ 		DMI_MATCH(DMI_PRODUCT_VERSION, "Lenovo IdeaPad Yoga 13"),
+ 		},
+ 	},
+ 	{
+ 	 .callback = video_set_use_native_backlight,
+ 	 .ident = "Dell Inspiron 7520",
+ 	 .matches = {
+ 		DMI_MATCH(DMI_SYS_VENDOR, "Dell Inc."),
+ 		DMI_MATCH(DMI_PRODUCT_VERSION, "Inspiron 7520"),
+ 		},
+ 	},
+ 	{
+ 	 .callback = video_set_use_native_backlight,
+ 	 .ident = "Acer Aspire 5733Z",
+ 	 .matches = {
+ 		DMI_MATCH(DMI_SYS_VENDOR, "Acer"),
+ 		DMI_MATCH(DMI_PRODUCT_NAME, "Aspire 5733Z"),
+ 		},
+ 	},
+ 	{
+ 	 .callback = video_set_use_native_backlight,
+ 	 .ident = "Acer Aspire V5-431",
+ 	 .matches = {
+ 		DMI_MATCH(DMI_SYS_VENDOR, "Acer"),
+ 		DMI_MATCH(DMI_PRODUCT_NAME, "Aspire V5-431"),
+ 		},
+ 	},
+ 	{
+ 	.callback = video_set_use_native_backlight,
+ 	.ident = "HP ProBook 4340s",
+ 	.matches = {
+ 		DMI_MATCH(DMI_SYS_VENDOR, "Hewlett-Packard"),
+ 		DMI_MATCH(DMI_PRODUCT_VERSION, "HP ProBook 4340s"),
+ 		},
+ 	},
+ 	{
+ 	.callback = video_set_use_native_backlight,
+ 	.ident = "HP ProBook 2013 models",
+ 	.matches = {
+ 		DMI_MATCH(DMI_SYS_VENDOR, "Hewlett-Packard"),
+ 		DMI_MATCH(DMI_PRODUCT_NAME, "HP ProBook "),
+ 		DMI_MATCH(DMI_PRODUCT_NAME, " G1"),
+ 		},
+ 	},
+ 	{
+ 	.callback = video_set_use_native_backlight,
+ 	.ident = "HP EliteBook 2013 models",
+ 	.matches = {
+ 		DMI_MATCH(DMI_SYS_VENDOR, "Hewlett-Packard"),
+ 		DMI_MATCH(DMI_PRODUCT_NAME, "HP EliteBook "),
+ 		DMI_MATCH(DMI_PRODUCT_NAME, " G1"),
+ 		},
+ 	},
+ 	{
+ 	.callback = video_set_use_native_backlight,
+ 	.ident = "HP ZBook 14",
+ 	.matches = {
+ 		DMI_MATCH(DMI_SYS_VENDOR, "Hewlett-Packard"),
+ 		DMI_MATCH(DMI_PRODUCT_NAME, "HP ZBook 14"),
+ 		},
+ 	},
+ 	{
+ 	.callback = video_set_use_native_backlight,
+ 	.ident = "HP ZBook 15",
+ 	.matches = {
+ 		DMI_MATCH(DMI_SYS_VENDOR, "Hewlett-Packard"),
+ 		DMI_MATCH(DMI_PRODUCT_NAME, "HP ZBook 15"),
+ 		},
+ 	},
+ 	{
+ 	.callback = video_set_use_native_backlight,
+ 	.ident = "HP ZBook 17",
+ 	.matches = {
+ 		DMI_MATCH(DMI_SYS_VENDOR, "Hewlett-Packard"),
+ 		DMI_MATCH(DMI_PRODUCT_NAME, "HP ZBook 17"),
+ 		},
+ 	},
+ 	{
+ 	.callback = video_set_use_native_backlight,
+ 	.ident = "HP EliteBook 8780w",
+ 	.matches = {
+ 		DMI_MATCH(DMI_SYS_VENDOR, "Hewlett-Packard"),
+ 		DMI_MATCH(DMI_PRODUCT_NAME, "HP EliteBook 8780w"),
++>>>>>>> 0e9f81d3b7cd (ACPI / video: Add systems that should favour native backlight interface)
  		},
  	},
  	{}
diff --git a/drivers/acpi/blacklist.c b/drivers/acpi/blacklist.c
index 40c91f5052ef..a715c7b7a0f6 100644
--- a/drivers/acpi/blacklist.c
+++ b/drivers/acpi/blacklist.c
@@ -261,14 +261,6 @@ static struct dmi_system_id acpi_osi_dmi_table[] __initdata = {
 	},
 	{
 	.callback = dmi_disable_osi_win8,
-	.ident = "Dell Inspiron 15R SE",
-	.matches = {
-		     DMI_MATCH(DMI_SYS_VENDOR, "Dell Inc."),
-		     DMI_MATCH(DMI_PRODUCT_NAME, "Inspiron 7520"),
-		},
-	},
-	{
-	.callback = dmi_disable_osi_win8,
 	.ident = "ThinkPad Edge E530",
 	.matches = {
 		     DMI_MATCH(DMI_SYS_VENDOR, "LENOVO"),
* Unmerged path drivers/acpi/video.c
