x86, irq: Clean up unused IOAPIC interface

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
Rebuild_CHGLOG: - [x86] irq: Clean up unused IOAPIC interface (Steve Best) [1231358]
Rebuild_FUZZ: 93.67%
commit-author Jiang Liu <jiang.liu@linux.intel.com>
commit 9f354b0252b81c870ac7534d71906280cb573f86
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/9f354b02.failed

Now we have converted all x86 platforms to use the common irqdomain map
interface. There's no caller of io_apic_set_pci_routing(),
setup_IO_APIC_irq_extra() and io_apic_setup_irq_pin_once() any more,
so kill them.

	Signed-off-by: Jiang Liu <jiang.liu@linux.intel.com>
	Cc: Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>
	Cc: Tony Luck <tony.luck@intel.com>
	Cc: Joerg Roedel <joro@8bytes.org>
	Cc: Paul Gortmaker <paul.gortmaker@windriver.com>
	Cc: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
	Cc: Benjamin Herrenschmidt <benh@kernel.crashing.org>
	Cc: Grant Likely <grant.likely@linaro.org>
	Cc: Rafael J. Wysocki <rjw@rjwysocki.net>
	Cc: Bjorn Helgaas <bhelgaas@google.com>
	Cc: Randy Dunlap <rdunlap@infradead.org>
	Cc: Yinghai Lu <yinghai@kernel.org>
Link: http://lkml.kernel.org/r/1402302011-23642-35-git-send-email-jiang.liu@linux.intel.com
	Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
(cherry picked from commit 9f354b0252b81c870ac7534d71906280cb573f86)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kernel/apic/io_apic.c
diff --cc arch/x86/kernel/apic/io_apic.c
index 07a33b81b46c,6e3d4c771832..000000000000
--- a/arch/x86/kernel/apic/io_apic.c
+++ b/arch/x86/kernel/apic/io_apic.c
@@@ -100,7 -108,9 +100,13 @@@ static struct ioapic 
  	struct mpc_ioapic mp_config;
  	/* IO APIC gsi routing info */
  	struct mp_ioapic_gsi  gsi_config;
++<<<<<<< HEAD
 +	DECLARE_BITMAP(pin_programmed, MP_MAX_IOAPIC_PIN + 1);
++=======
+ 	struct ioapic_domain_cfg irqdomain_cfg;
+ 	struct irq_domain *irqdomain;
+ 	struct mp_pin_info *pin_info;
++>>>>>>> 9f354b0252b8 (x86, irq: Clean up unused IOAPIC interface)
  } ioapics[MAX_IO_APICS];
  
  #define mpc_ioapic_ver(ioapic_idx)	ioapics[ioapic_idx].mp_config.apicver
@@@ -1435,38 -1523,6 +1441,41 @@@ static void __init setup_IO_APIC_irqs(v
  }
  
  /*
++<<<<<<< HEAD
 + * for the gsi that is not in first ioapic
 + * but could not use acpi_register_gsi()
 + * like some special sci in IBM x3330
 + */
 +void setup_IO_APIC_irq_extra(u32 gsi)
 +{
 +	int ioapic_idx = 0, pin, idx, irq, node = cpu_to_node(0);
 +	struct io_apic_irq_attr attr;
 +
 +	/*
 +	 * Convert 'gsi' to 'ioapic.pin'.
 +	 */
 +	ioapic_idx = mp_find_ioapic(gsi);
 +	if (ioapic_idx < 0)
 +		return;
 +
 +	pin = mp_find_ioapic_pin(ioapic_idx, gsi);
 +	idx = find_irq_entry(ioapic_idx, pin, mp_INT);
 +	if (idx == -1)
 +		return;
 +
 +	irq = pin_2_irq(idx, ioapic_idx, pin);
 +	if (mp_init_irq_at_boot(ioapic_idx, irq))
 +		return;
 +
 +	set_io_apic_irq_attr(&attr, ioapic_idx, pin, irq_trigger(idx),
 +			     irq_polarity(idx));
 +
 +	io_apic_setup_irq_pin_once(irq, node, &attr);
 +}
 +
 +/*
++=======
++>>>>>>> 9f354b0252b8 (x86, irq: Clean up unused IOAPIC interface)
   * Set up the timer pin, possibly with the 8259A-master behind.
   */
  static void __init setup_timer_IRQ0_pin(unsigned int ioapic_idx,
@@@ -3389,24 -3425,6 +3398,27 @@@ io_apic_setup_irq_pin(unsigned int irq
  	return ret;
  }
  
++<<<<<<< HEAD
 +int io_apic_setup_irq_pin_once(unsigned int irq, int node,
 +			       struct io_apic_irq_attr *attr)
 +{
 +	unsigned int ioapic_idx = attr->ioapic, pin = attr->ioapic_pin;
 +	int ret;
 +
 +	/* Avoid redundant programming */
 +	if (test_bit(pin, ioapics[ioapic_idx].pin_programmed)) {
 +		pr_debug("Pin %d-%d already programmed\n",
 +			 mpc_ioapic_id(ioapic_idx), pin);
 +		return 0;
 +	}
 +	ret = io_apic_setup_irq_pin(irq, node, attr);
 +	if (!ret)
 +		set_bit(pin, ioapics[ioapic_idx].pin_programmed);
 +	return ret;
 +}
 +
++=======
++>>>>>>> 9f354b0252b8 (x86, irq: Clean up unused IOAPIC interface)
  static int __init io_apic_get_redir_entries(int ioapic)
  {
  	union IO_APIC_reg_01	reg_01;
@@@ -3456,25 -3468,9 +3468,9 @@@ int __init arch_probe_nr_irqs(void
  	if (nr < nr_irqs)
  		nr_irqs = nr;
  
 -	return 0;
 +	return NR_IRQS_LEGACY;
  }
  
- int io_apic_set_pci_routing(struct device *dev, int irq,
- 			    struct io_apic_irq_attr *irq_attr)
- {
- 	int node;
- 
- 	if (!IO_APIC_IRQ(irq)) {
- 		apic_printk(APIC_QUIET,KERN_ERR "IOAPIC[%d]: Invalid reference to IRQ 0\n",
- 			    irq_attr->ioapic);
- 		return -EINVAL;
- 	}
- 
- 	node = dev ? dev_to_node(dev) : cpu_to_node(0);
- 
- 	return io_apic_setup_irq_pin_once(irq, node, irq_attr);
- }
- 
  #ifdef CONFIG_X86_32
  static int __init io_apic_get_unique_id(int ioapic, int apic_id)
  {
diff --git a/arch/x86/include/asm/io_apic.h b/arch/x86/include/asm/io_apic.h
index 7eb3755fee9a..7d914a01af80 100644
--- a/arch/x86/include/asm/io_apic.h
+++ b/arch/x86/include/asm/io_apic.h
@@ -142,9 +142,6 @@ extern int noioapicreroute;
 
 struct io_apic_irq_attr;
 struct irq_cfg;
-extern int io_apic_set_pci_routing(struct device *dev, int irq,
-		 struct io_apic_irq_attr *irq_attr);
-extern void setup_IO_APIC_irq_extra(u32 gsi);
 extern void ioapic_insert_resources(void);
 
 extern int native_setup_ioapic_entry(int, struct IO_APIC_route_entry *,
@@ -156,8 +153,6 @@ extern void native_compose_msi_msg(struct pci_dev *pdev,
 				   unsigned int irq, unsigned int dest,
 				   struct msi_msg *msg, u8 hpet_id);
 extern void native_eoi_ioapic_pin(int apic, int pin, int vector);
-extern int io_apic_setup_irq_pin_once(unsigned int irq, int node,
-				      struct io_apic_irq_attr *attr);
 
 extern int save_ioapic_entries(void);
 extern void mask_ioapic_entries(void);
@@ -220,10 +215,6 @@ static inline void ioapic_insert_resources(void) { }
 static inline int mp_find_ioapic(u32 gsi) { return 0; }
 static inline u32 mp_pin_to_gsi(int ioapic, int pin) { return UINT_MAX; }
 
-struct io_apic_irq_attr;
-static inline int io_apic_set_pci_routing(struct device *dev, int irq,
-		 struct io_apic_irq_attr *irq_attr) { return 0; }
-
 static inline int save_ioapic_entries(void)
 {
 	return -ENOMEM;
* Unmerged path arch/x86/kernel/apic/io_apic.c
