regmap: rbtree: Factor out node allocation

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
commit-author Mark Brown <broonie@opensource.wolfsonmicro.com>
commit 0186645d2549f94c3a8067c97cad261c678d6718
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/0186645d.failed

In preparation for being slightly smarter about how we allocate memory
factor out the node allocation.

	Signed-off-by: Mark Brown <broonie@opensource.wolfsonmicro.com>
(cherry picked from commit 0186645d2549f94c3a8067c97cad261c678d6718)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/base/regmap/regcache-rbtree.c
diff --cc drivers/base/regmap/regcache-rbtree.c
index bb8c3bbc7812,3a000145ac6e..000000000000
--- a/drivers/base/regmap/regcache-rbtree.c
+++ b/drivers/base/regmap/regcache-rbtree.c
@@@ -354,23 -375,15 +375,27 @@@ static int regcache_rbtree_write(struc
  				return 0;
  			}
  		}
- 		/* we did not manage to find a place to insert it in an existing
- 		 * block so create a new rbnode with a single register in its block.
- 		 * This block will get populated further if any other adjacent
- 		 * registers get modified in the future.
+ 
+ 		/* We did not manage to find a place to insert it in
+ 		 * an existing block so create a new rbnode.
  		 */
- 		rbnode = kzalloc(sizeof *rbnode, GFP_KERNEL);
+ 		rbnode = regcache_rbtree_node_alloc(map, reg);
  		if (!rbnode)
  			return -ENOMEM;
++<<<<<<< HEAD
 +		rbnode->blklen = 1;
 +		rbnode->base_reg = reg;
 +		rbnode->block = kmalloc(rbnode->blklen * map->cache_word_size,
 +					GFP_KERNEL);
 +		if (!rbnode->block) {
 +			kfree(rbnode);
 +			return -ENOMEM;
 +		}
 +		regcache_rbtree_set_register(map, rbnode, 0, value);
++=======
+ 		regcache_rbtree_set_register(map, rbnode,
+ 					     reg - rbnode->base_reg, value);
++>>>>>>> 0186645d2549 (regmap: rbtree: Factor out node allocation)
  		regcache_rbtree_insert(map, &rbtree_ctx->root, rbnode);
  		rbtree_ctx->cached_rbnode = rbnode;
  	}
* Unmerged path drivers/base/regmap/regcache-rbtree.c
