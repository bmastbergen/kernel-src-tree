bonding: remove vlan_list/current_alb_vlan

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
commit-author Veaceslav Falico <vfalico@redhat.com>
commit e868b0c938d9cc0d7ed4bd77d5c37676e833ed95
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/e868b0c9.failed

Currently there are no real users of vlan_list/current_alb_vlan, only the
helpers which maintain them, so remove them.

CC: Jay Vosburgh <fubar@us.ibm.com>
CC: Andy Gospodarek <andy@greyhouse.net>
	Signed-off-by: Veaceslav Falico <vfalico@redhat.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit e868b0c938d9cc0d7ed4bd77d5c37676e833ed95)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/bonding/bond_main.c
diff --cc drivers/net/bonding/bond_main.c
index 444915a7a548,b87ad7606b2b..000000000000
--- a/drivers/net/bonding/bond_main.c
+++ b/drivers/net/bonding/bond_main.c
@@@ -450,13 -341,6 +340,16 @@@ static int bond_vlan_rx_add_vid(struct 
  			goto unwind;
  	}
  
++<<<<<<< HEAD
 +	res = bond_add_vlan(bond, vid);
 +	if (res) {
 +		pr_err("%s: Error: Failed to add vlan id %d\n",
 +		       bond_dev->name, vid);
 +		return res;
 +	}
 +
++=======
++>>>>>>> e868b0c938d9 (bonding: remove vlan_list/current_alb_vlan)
  	return 0;
  
  unwind:
@@@ -478,17 -361,12 +371,16 @@@ static int bond_vlan_rx_kill_vid(struc
  {
  	struct bonding *bond = netdev_priv(bond_dev);
  	struct slave *slave;
++<<<<<<< HEAD
 +	int i, res;
++=======
++>>>>>>> e868b0c938d9 (bonding: remove vlan_list/current_alb_vlan)
  
 -	bond_for_each_slave(bond, slave)
 +	bond_for_each_slave(bond, slave, i)
  		vlan_vid_del(slave->dev, proto, vid);
  
- 	res = bond_del_vlan(bond, vid);
- 	if (res) {
- 		pr_err("%s: Error: Failed to remove vlan id %d\n",
- 		       bond_dev->name, vid);
- 		return res;
- 	}
+ 	if (bond_is_lb(bond))
+ 		bond_alb_clear_vlan(bond, vid);
  
  	return 0;
  }
@@@ -4361,7 -4072,7 +4252,11 @@@ static void bond_setup(struct net_devic
  static void bond_uninit(struct net_device *bond_dev)
  {
  	struct bonding *bond = netdev_priv(bond_dev);
++<<<<<<< HEAD
 +	struct vlan_entry *vlan, *tmp;
++=======
+ 	struct slave *slave, *tmp_slave;
++>>>>>>> e868b0c938d9 (bonding: remove vlan_list/current_alb_vlan)
  
  	bond_netpoll_cleanup(bond_dev);
  
@@@ -4373,13 -4084,6 +4268,16 @@@
  	list_del(&bond->bond_list);
  
  	bond_debug_unregister(bond);
++<<<<<<< HEAD
 +
 +	__hw_addr_flush(&bond->mc_list);
 +
 +	list_for_each_entry_safe(vlan, tmp, &bond->vlan_list, vlan_list) {
 +		list_del(&vlan->vlan_list);
 +		kfree(vlan);
 +	}
++=======
++>>>>>>> e868b0c938d9 (bonding: remove vlan_list/current_alb_vlan)
  }
  
  /*------------------------- Module initialization ---------------------------*/
diff --git a/drivers/net/bonding/bond_alb.c b/drivers/net/bonding/bond_alb.c
index 501007eefc23..d9be866b9b10 100644
--- a/drivers/net/bonding/bond_alb.c
+++ b/drivers/net/bonding/bond_alb.c
@@ -1789,11 +1789,6 @@ int bond_alb_set_mac_address(struct net_device *bond_dev, void *addr)
 
 void bond_alb_clear_vlan(struct bonding *bond, unsigned short vlan_id)
 {
-	if (bond->alb_info.current_alb_vlan &&
-	    (bond->alb_info.current_alb_vlan->vlan_id == vlan_id)) {
-		bond->alb_info.current_alb_vlan = NULL;
-	}
-
 	if (bond->alb_info.rlb_enabled) {
 		rlb_clear_vlan(bond, vlan_id);
 	}
diff --git a/drivers/net/bonding/bond_alb.h b/drivers/net/bonding/bond_alb.h
index e13917222cd4..e02c9c558c41 100644
--- a/drivers/net/bonding/bond_alb.h
+++ b/drivers/net/bonding/bond_alb.h
@@ -169,7 +169,6 @@ struct alb_bond_info {
 						 * rx traffic should be
 						 * rebalanced
 						 */
-	struct vlan_entry	*current_alb_vlan;
 };
 
 int bond_alb_initialize(struct bonding *bond, int rlb_enabled);
* Unmerged path drivers/net/bonding/bond_main.c
diff --git a/drivers/net/bonding/bonding.h b/drivers/net/bonding/bonding.h
index 9c9dedcb8f85..62d7241767d7 100644
--- a/drivers/net/bonding/bonding.h
+++ b/drivers/net/bonding/bonding.h
@@ -167,11 +167,6 @@ struct bond_parm_tbl {
 
 #define BOND_MAX_MODENAME_LEN 20
 
-struct vlan_entry {
-	struct list_head vlan_list;
-	unsigned short vlan_id;
-};
-
 struct slave {
 	struct net_device *dev; /* first - useful for panic debug */
 	struct slave *next;
@@ -238,7 +233,6 @@ struct bonding {
 	struct   ad_bond_info ad_info;
 	struct   alb_bond_info alb_info;
 	struct   bond_params params;
-	struct   list_head vlan_list;
 	struct   workqueue_struct *wq;
 	struct   delayed_work mii_work;
 	struct   delayed_work arp_work;
