of/base: Fix PowerPC address parsing hack

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
Rebuild_CHGLOG: - [of] base: Fix PowerPC address parsing hack (Gustavo Duarte) [1230093]
Rebuild_FUZZ: 96.20%
commit-author Benjamin Herrenschmidt <benh@kernel.crashing.org>
commit 746c9e9f92dde2789908e51a354ba90a1962a2eb
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/746c9e9f.failed

We have a historical hack that treats missing ranges properties as the
equivalent of an empty one. This is needed for ancient PowerMac "bad"
device-trees, and shouldn't be enabled for any other PowerPC platform,
otherwise we get some nasty layout of devices in sysfs or even
duplication when a set of otherwise identically named devices is
created multiple times under a different parent node with no ranges
property.

This fix is needed for the PowerNV i2c busses to be exposed properly
and will fix a number of other embedded cases.

	Signed-off-by: Benjamin Herrenschmidt <benh@kernel.crashing.org>
CC: <stable@vger.kernel.org>
	Acked-by: Grant Likely <grant.likely@linaro.org>
	Signed-off-by: Rob Herring <robh@kernel.org>
(cherry picked from commit 746c9e9f92dde2789908e51a354ba90a1962a2eb)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/of/address.c
diff --cc drivers/of/address.c
index 4a469cbfa88c,06af494184d6..000000000000
--- a/drivers/of/address.c
+++ b/drivers/of/address.c
@@@ -366,12 -490,10 +381,16 @@@ static int of_translate_one(struct devi
  	 * This code is only enabled on powerpc. --gcl
  	 */
  	ranges = of_get_property(parent, rprop, &rlen);
++<<<<<<< HEAD
 +#if !defined(CONFIG_PPC)
 +	if (ranges == NULL) {
 +		pr_debug("OF: no ranges; cannot translate\n");
++=======
+ 	if (ranges == NULL && !of_empty_ranges_quirk()) {
+ 		pr_err("OF: no ranges; cannot translate\n");
++>>>>>>> 746c9e9f92dd (of/base: Fix PowerPC address parsing hack)
  		return 1;
  	}
- #endif /* !defined(CONFIG_PPC) */
  	if (ranges == NULL || rlen == 0) {
  		offset = of_read_number(addr, na);
  		memset(addr, 0, pna * 4);
* Unmerged path drivers/of/address.c
