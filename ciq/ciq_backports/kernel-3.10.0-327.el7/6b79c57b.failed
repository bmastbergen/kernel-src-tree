mm: numa: disable change protection for vma(VM_HUGETLB)

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
Rebuild_CHGLOG: - [mm] numa: disable change protection for vma(VM_HUGETLB) (Larry Woodman) [1251007]
Rebuild_FUZZ: 96.23%
commit-author Naoya Horiguchi <n-horiguchi@ah.jp.nec.com>
commit 6b79c57b92cdd90853002980609af516d14c4f9c
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/6b79c57b.failed

Currently when a process accesses a hugetlb range protected with
PROTNONE, unexpected COWs are triggered, which finally puts the hugetlb
subsystem into a broken/uncontrollable state, where for example
h->resv_huge_pages is subtracted too much and wraps around to a very
large number, and the free hugepage pool is no longer maintainable.

This patch simply stops changing protection for vma(VM_HUGETLB) to fix
the problem.  And this also allows us to avoid useless overhead of minor
faults.

	Signed-off-by: Naoya Horiguchi <n-horiguchi@ah.jp.nec.com>
	Suggested-by: Mel Gorman <mgorman@suse.de>
	Cc: Hugh Dickins <hughd@google.com>
	Cc: "Kirill A. Shutemov" <kirill@shutemov.name>
	Cc: David Rientjes <rientjes@google.com>
	Cc: Rik van Riel <riel@redhat.com>
	Cc: Peter Zijlstra <a.p.zijlstra@chello.nl>
	Cc: Ingo Molnar <mingo@elte.hu>
	Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
	Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
(cherry picked from commit 6b79c57b92cdd90853002980609af516d14c4f9c)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	kernel/sched/fair.c
diff --cc kernel/sched/fair.c
index 6868c5f9839f,241213be507c..000000000000
--- a/kernel/sched/fair.c
+++ b/kernel/sched/fair.c
@@@ -1858,8 -2165,10 +1858,14 @@@ void task_numa_work(struct callback_hea
  		vma = mm->mmap;
  	}
  	for (; vma; vma = vma->vm_next) {
++<<<<<<< HEAD
 +		if (!vma_migratable(vma) || !vma_policy_mof(p, vma))
++=======
+ 		if (!vma_migratable(vma) || !vma_policy_mof(vma) ||
+ 			is_vm_hugetlb_page(vma)) {
++>>>>>>> 6b79c57b92cd (mm: numa: disable change protection for vma(VM_HUGETLB))
  			continue;
+ 		}
  
  		/*
  		 * Shared library pages mapped by multiple processes are not
* Unmerged path kernel/sched/fair.c
