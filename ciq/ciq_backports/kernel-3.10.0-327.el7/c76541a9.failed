blk-mq: Exit queue on alloc failure

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
commit-author Keith Busch <keith.busch@intel.com>
commit c76541a932113faa5b3be65a3f0a3d4ebbc86aeb
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/c76541a9.failed

Fixes usage counter when a request could not be allocated.

	Signed-off-by: Keith Busch <keith.busch@intel.com>
	Signed-off-by: Jens Axboe <axboe@fb.com>
(cherry picked from commit c76541a932113faa5b3be65a3f0a3d4ebbc86aeb)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	block/blk-mq.c
diff --cc block/blk-mq.c
index 4aac2968b62c,bfe0f1f9cfa0..000000000000
--- a/block/blk-mq.c
+++ b/block/blk-mq.c
@@@ -254,6 -258,10 +254,13 @@@ struct request *blk_mq_alloc_request(st
  		ctx = alloc_data.ctx;
  	}
  	blk_mq_put_ctx(ctx);
++<<<<<<< HEAD
++=======
+ 	if (!rq) {
+ 		blk_mq_queue_exit(q);
+ 		return ERR_PTR(-EWOULDBLOCK);
+ 	}
++>>>>>>> c76541a93211 (blk-mq: Exit queue on alloc failure)
  	return rq;
  }
  EXPORT_SYMBOL(blk_mq_alloc_request);
* Unmerged path block/blk-mq.c
