net/ipv6: update flowi6_oif in ip6_dst_lookup_flow if not set

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
Rebuild_CHGLOG: - [net] ipv6: update flowi6_oif in ip6_dst_lookup_flow if not set (Phil Sutter) [1243591]
Rebuild_FUZZ: 96.61%
commit-author Phil Sutter <phil@nwl.cc>
commit a0a9f33bdf8bf9061c31faab46d8eb46ff644622
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/a0a9f33b.failed

Newly created flows don't have flowi6_oif set (at least if the
associated socket is not interface-bound). This leads to a mismatch in
__xfrm6_selector_match() for policies which specify an interface in the
selector (sel->ifindex != 0).

Backtracing shows this happens in code-paths originating from e.g.
ip6_datagram_connect(), rawv6_sendmsg() or tcp_v6_connect(). (UDP was
not tested for.)

In summary, this patch fixes policy matching on outgoing interface for
locally generated packets.

	Signed-off-by: Phil Sutter <phil@nwl.cc>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit a0a9f33bdf8bf9061c31faab46d8eb46ff644622)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/ipv6/ip6_output.c
diff --cc net/ipv6/ip6_output.c
index 6d9299d02831,c5fc85286ef6..000000000000
--- a/net/ipv6/ip6_output.c
+++ b/net/ipv6/ip6_output.c
@@@ -973,8 -1023,8 +973,13 @@@ struct dst_entry *ip6_dst_lookup_flow(s
  		return ERR_PTR(err);
  	if (final_dst)
  		fl6->daddr = *final_dst;
++<<<<<<< HEAD
 +	if (can_sleep)
 +		fl6->flowi6_flags |= FLOWI_FLAG_CAN_SLEEP;
++=======
+ 	if (!fl6->flowi6_oif)
+ 		fl6->flowi6_oif = dst->dev->ifindex;
++>>>>>>> a0a9f33bdf8b (net/ipv6: update flowi6_oif in ip6_dst_lookup_flow if not set)
  
  	return xfrm_lookup_route(sock_net(sk), dst, flowi6_to_flowi(fl6), sk, 0);
  }
* Unmerged path net/ipv6/ip6_output.c
