KVM: PPC: Book3S HV: Use decrementer to wake napping threads

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
Rebuild_CHGLOG: - [kvm] ppc: book3s-hv: Use decrementer to wake napping threads (Laurent Vivier) [1213669]
Rebuild_FUZZ: 93.91%
commit-author Paul Mackerras <paulus@samba.org>
commit fd6d53b12410b4b73e3996629350dee3f4a7994f
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/fd6d53b1.failed

This arranges for threads that are napping due to their vcpu having
ceded or due to not having a vcpu to wake up at the end of the guest's
timeslice without having to be poked with an IPI.  We do that by
arranging for the decrementer to contain a value no greater than the
number of timebase ticks remaining until the end of the timeslice.
In the case of a thread with no vcpu, this number is in the hypervisor
decrementer already.  In the case of a ceded vcpu, we use the smaller
of the HDEC value and the DEC value.

Using the DEC like this when ceded means we need to save and restore
the guest decrementer value around the nap.

	Signed-off-by: Paul Mackerras <paulus@samba.org>
	Signed-off-by: Alexander Graf <agraf@suse.de>
(cherry picked from commit fd6d53b12410b4b73e3996629350dee3f4a7994f)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/powerpc/kvm/book3s_hv_rmhandlers.S
diff --cc arch/powerpc/kvm/book3s_hv_rmhandlers.S
index 499fdba9ddf8,16719af88bcc..000000000000
--- a/arch/powerpc/kvm/book3s_hv_rmhandlers.S
+++ b/arch/powerpc/kvm/book3s_hv_rmhandlers.S
@@@ -2176,15 -2133,45 +2185,47 @@@ END_FTR_SECTION_IFCLR(CPU_FTR_ARCH_206
  	/* save FP state */
  	bl	kvmppc_save_fp
  
++<<<<<<< HEAD
++=======
+ 	/*
+ 	 * Set DEC to the smaller of DEC and HDEC, so that we wake
+ 	 * no later than the end of our timeslice (HDEC interrupts
+ 	 * don't wake us from nap).
+ 	 */
+ 	mfspr	r3, SPRN_DEC
+ 	mfspr	r4, SPRN_HDEC
+ 	mftb	r5
+ 	cmpw	r3, r4
+ 	ble	67f
+ 	mtspr	SPRN_DEC, r4
+ 67:
+ 	/* save expiry time of guest decrementer */
+ 	extsw	r3, r3
+ 	add	r3, r3, r5
+ 	ld	r4, HSTATE_KVM_VCPU(r13)
+ 	ld	r5, HSTATE_KVM_VCORE(r13)
+ 	ld	r6, VCORE_TB_OFFSET(r5)
+ 	subf	r3, r6, r3	/* convert to host TB value */
+ 	std	r3, VCPU_DEC_EXPIRES(r4)
+ 
+ #ifdef CONFIG_KVM_BOOK3S_HV_EXIT_TIMING
+ 	ld	r4, HSTATE_KVM_VCPU(r13)
+ 	addi	r3, r4, VCPU_TB_CEDE
+ 	bl	kvmhv_accumulate_time
+ #endif
+ 
+ 	lis	r3, LPCR_PECEDP@h	/* Do wake on privileged doorbell */
+ 
++>>>>>>> fd6d53b12410 (KVM: PPC: Book3S HV: Use decrementer to wake napping threads)
  	/*
  	 * Take a nap until a decrementer or external or doobell interrupt
 -	 * occurs, with PECE1 and PECE0 set in LPCR.
 -	 * On POWER8, if we are ceding, also set PECEDP.
 -	 * Also clear the runlatch bit before napping.
 +	 * occurs, with PECE1, PECE0 and PECEDP set in LPCR. Also clear the
 +	 * runlatch bit before napping.
  	 */
  kvm_do_nap:
 -	mfspr	r0, SPRN_CTRLF
 -	clrrdi	r0, r0, 1
 -	mtspr	SPRN_CTRLT, r0
 +	mfspr	r2, SPRN_CTRLF
 +	clrrdi	r2, r2, 1
 +	mtspr	SPRN_CTRLT, r2
  
  	li	r0,1
  	stb	r0,HSTATE_HWTHREAD_REQ(r13)
* Unmerged path arch/powerpc/kvm/book3s_hv_rmhandlers.S
