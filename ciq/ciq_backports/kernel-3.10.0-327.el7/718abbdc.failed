qla2xxx: Restore physical port WWPN only, when port down detected for FA-WWPN port.

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
Rebuild_CHGLOG: - [scsi] qla2xxx: Restore physical port WWPN only, when port down detected for FA-WWPN port (Chad Dupuis) [1187302]
Rebuild_FUZZ: 99.39%
commit-author Sawan Chandak <sawan.chandak@qlogic.com>
commit 718abbdca79f8ad87b359cc2cbcc4b1cb3aa6759
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/718abbdc.failed

For FA-WWPN is enabled port, if NPIV created on that port and,
if port link is brought down, then WWPN was restored from flash for both
physical and NPIV port. This will result in NPIV port and physical port
sharing same WWPN. Any application refreshing ports information  will
not be able to scan NPIV port because of this behavior. So while restoring WWPN,
only restore physical port WWPN.

	Signed-off-by: Sawan Chandak <sawan.chandak@qlogic.com>
	Signed-off-by: Himanshu Madhani <himanshu.madhani@qlogic.com>
	Reviewed-by: Hannes Reinecke <hare@suse.de>
	Signed-off-by: James Bottomley <JBottomley@Odin.com>
(cherry picked from commit 718abbdca79f8ad87b359cc2cbcc4b1cb3aa6759)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/qla2xxx/qla_isr.c
diff --cc drivers/scsi/qla2xxx/qla_isr.c
index 213c09acbead,6dc14cd782b2..000000000000
--- a/drivers/scsi/qla2xxx/qla_isr.c
+++ b/drivers/scsi/qla2xxx/qla_isr.c
@@@ -721,6 -753,26 +721,29 @@@ skip_rio
  		if (atomic_read(&vha->loop_state) != LOOP_DOWN) {
  			atomic_set(&vha->loop_state, LOOP_DOWN);
  			atomic_set(&vha->loop_down_timer, LOOP_DOWN_TIME);
++<<<<<<< HEAD
++=======
+ 			/*
+ 			 * In case of loop down, restore WWPN from
+ 			 * NVRAM in case of FA-WWPN capable ISP
+ 			 * Restore for Physical Port only
+ 			 */
+ 			if (!vha->vp_idx) {
+ 				if (ha->flags.fawwpn_enabled) {
+ 					void *wwpn = ha->init_cb->port_name;
+ 					memcpy(vha->port_name, wwpn, WWN_SIZE);
+ 					fc_host_port_name(vha->host) =
+ 					    wwn_to_u64(vha->port_name);
+ 					ql_dbg(ql_dbg_init + ql_dbg_verbose,
+ 					    vha, 0x0144, "LOOP DOWN detected,"
+ 					    "restore WWPN %016llx\n",
+ 					    wwn_to_u64(vha->port_name));
+ 				}
+ 
+ 				clear_bit(VP_CONFIG_OK, &vha->vp_flags);
+ 			}
+ 
++>>>>>>> 718abbdca79f (qla2xxx: Restore physical port WWPN only, when port down detected for FA-WWPN port.)
  			vha->device_flags |= DFLG_NO_CABLE;
  			qla2x00_mark_all_devices_lost(vha, 1);
  		}
* Unmerged path drivers/scsi/qla2xxx/qla_isr.c
