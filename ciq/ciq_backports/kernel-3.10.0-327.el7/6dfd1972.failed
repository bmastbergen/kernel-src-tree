drm/radeon: fix freeze for laptop with Turks/Thames GPU.

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
Rebuild_CHGLOG: - [drm] radeon: fix freeze for laptop with Turks/Thames GPU (Rob Clark) [1249805]
Rebuild_FUZZ: 95.33%
commit-author Jérôme Glisse <jglisse@redhat.com>
commit 6dfd197283bffc23a2b046a7f065588de7e1fc1e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/6dfd1972.failed

Laptop with Turks/Thames GPU will freeze if dpm is enabled. It seems
the SMC engine is relying on some state inside the CP engine. CP needs
to chew at least one packet for it to get in good state for dynamic
power management.

This patch simply disabled and re-enable DPM after the ring test which
is enough to avoid the freeze.

	Signed-off-by: Jérôme Glisse <jglisse@redhat.com>
	Cc: stable@vger.kernel.org
	Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
(cherry picked from commit 6dfd197283bffc23a2b046a7f065588de7e1fc1e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/gpu/drm/radeon/radeon_device.c
diff --cc drivers/gpu/drm/radeon/radeon_device.c
index cb46407f93d2,a7fdfa4f0857..000000000000
--- a/drivers/gpu/drm/radeon/radeon_device.c
+++ b/drivers/gpu/drm/radeon/radeon_device.c
@@@ -1371,9 -1456,28 +1371,31 @@@ int radeon_device_init(struct radeon_de
  		radeon_agp_disable(rdev);
  		r = radeon_init(rdev);
  		if (r)
 -			goto failed;
 +			return r;
  	}
  
++<<<<<<< HEAD
++=======
+ 	r = radeon_ib_ring_tests(rdev);
+ 	if (r)
+ 		DRM_ERROR("ib ring test failed (%d).\n", r);
+ 
+ 	/*
+ 	 * Turks/Thames GPU will freeze whole laptop if DPM is not restarted
+ 	 * after the CP ring have chew one packet at least. Hence here we stop
+ 	 * and restart DPM after the radeon_ib_ring_tests().
+ 	 */
+ 	if (rdev->pm.dpm_enabled &&
+ 	    (rdev->pm.pm_method == PM_METHOD_DPM) &&
+ 	    (rdev->family == CHIP_TURKS) &&
+ 	    (rdev->flags & RADEON_IS_MOBILITY)) {
+ 		mutex_lock(&rdev->pm.mutex);
+ 		radeon_dpm_disable(rdev);
+ 		radeon_dpm_enable(rdev);
+ 		mutex_unlock(&rdev->pm.mutex);
+ 	}
+ 
++>>>>>>> 6dfd197283bf (drm/radeon: fix freeze for laptop with Turks/Thames GPU.)
  	if ((radeon_testing & 1)) {
  		if (rdev->accel_working)
  			radeon_test_moves(rdev);
* Unmerged path drivers/gpu/drm/radeon/radeon_device.c
