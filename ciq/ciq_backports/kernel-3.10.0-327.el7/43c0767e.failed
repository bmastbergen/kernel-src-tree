of/platform: Move platform devices under /sys/devices/platform

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
Rebuild_CHGLOG: - [of] platform: Move platform devices under /sys/devices/platform (Gustavo Duarte) [1230093]
Rebuild_FUZZ: 97.52%
commit-author Grant Likely <grant.likely@linaro.org>
commit 43c0767e17ac70e494b6a381b3a20be6a1a75c70
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/43c0767e.failed

Currently the devices created by drivers/of/platform.c get created at
the root of /sys/devices. This goes against the typical pattern for
sysfs where the top level /sys/devices structure contains categories of
devices, and the structure of devices is placed below that. To fix this,
make the code in drivers/of/platform.c follow the drivers/base/platform.c
behaviour, and use &platform_bus as the default parent for all new
platform_devices and amba_devices.

This change has been discussed for a long time, but nobody has actually
acted on it. Userspace code that expects to find devices under a fixed
/sys/devices/... path will be affected. It isn't /supposed/ to do that,
but if anyone complains then I'll add a default-off workaround option to
put them back into the root.

	Signed-off-by: Grant Likely <grant.likely@linaro.org>
	Acked-by: Benjamin Herrenschmidt <benh@kernel.crashing.org>
	Acked-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
	Cc: Rob Herring <robh+dt@kernel.org>
	Cc: Arnd Bergmann <arnd@arndb.de>
(cherry picked from commit 43c0767e17ac70e494b6a381b3a20be6a1a75c70)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/of/platform.c
diff --cc drivers/of/platform.c
index e0a6514ab46c,7c6771986c06..000000000000
--- a/drivers/of/platform.c
+++ b/drivers/of/platform.c
@@@ -172,10 -138,7 +172,14 @@@ struct platform_device *of_device_alloc
  	}
  
  	dev->dev.of_node = of_node_get(np);
++<<<<<<< HEAD
 +#if defined(CONFIG_MICROBLAZE)
 +	dev->dev.dma_mask = &dev->archdata.dma_mask;
 +#endif
 +	dev->dev.parent = parent;
++=======
+ 	dev->dev.parent = parent ? : &platform_bus;
++>>>>>>> 43c0767e17ac (of/platform: Move platform devices under /sys/devices/platform)
  
  	if (bus_id)
  		dev_set_name(&dev->dev, "%s", bus_id);
@@@ -264,13 -283,15 +268,13 @@@ static struct amba_device *of_amba_devi
  		return NULL;
  
  	dev = amba_device_alloc(NULL, 0, 0);
 -	if (!dev) {
 -		pr_err("%s(): amba_device_alloc() failed for %s\n",
 -		       __func__, node->full_name);
 -		goto err_clear_flag;
 -	}
 +	if (!dev)
 +		return NULL;
  
  	/* setup generic device info */
 +	dev->dev.coherent_dma_mask = ~0;
  	dev->dev.of_node = of_node_get(node);
- 	dev->dev.parent = parent;
+ 	dev->dev.parent = parent ? : &platform_bus;
  	dev->dev.platform_data = platform_data;
  	if (bus_id)
  		dev_set_name(&dev->dev, "%s", bus_id);
* Unmerged path drivers/of/platform.c
