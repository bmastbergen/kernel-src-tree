dm table: fall back to getting device using name_to_dev_t()

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
Rebuild_CHGLOG: - [md] dm-table: fall back to getting device using name_to_dev_t() (Mike Snitzer) [1166127 1208542]
Rebuild_FUZZ: 98.31%
commit-author Dan Ehrenberg <dehrenberg@chromium.org>
commit 644bda6f346038bce7ad3ed48f7044c10dde6d47
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/644bda6f.failed

If a device is used as the root filesystem, it can't be built
off of devices which are within the root filesystem (just like
command line arguments to root=).  For this reason, Linux has a
pseudo-filesystem for root= and MD initialization (based on the
function name_to_dev_t) which handles different ways of specifying
devices including PARTUUID and major:minor.

Switch to using name_to_dev_t() in dm_get_device().  Rather than
having DM assume that all things which are not major:minor are paths in
an already-mounted filesystem, change dm_get_device() to first attempt
to look up the device in the filesystem, and if not found it will fall
back to using name_to_dev_t().

In terms of backwards compatibility, there are some cases where
behavior will be different:
- If you have a file in the current working directory named 1:2 and
  you initialze DM there, then it will try to use that file rather
  than the disk with that major:minor pair as a backing device.
- Similarly for other bdev types which name_to_dev_t() knows how to
  interpret, the previous behavior was to repeatedly check for the
  existence of the file (e.g., while waiting for rootfs to come up)
  but the new behavior is to use the name_to_dev_t() interpretation.
  For example, if you have a file named /dev/ubiblock0_0 which is
  a symlink to /dev/sda3, but it is not yet present when DM starts
  to initialize, then the name_to_dev_t() interpretation will take
  precedence.

These incompatibilities would only show up in really strange setups
with bad practices so we shouldn't have to worry about them.

	Signed-off-by: Dan Ehrenberg <dehrenberg@chromium.org>
	Signed-off-by: Mike Snitzer <snitzer@redhat.com>
(cherry picked from commit 644bda6f346038bce7ad3ed48f7044c10dde6d47)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/md/dm-table.c
diff --cc drivers/md/dm-table.c
index f0e1b4aff2f4,e0f618b43c25..000000000000
--- a/drivers/md/dm-table.c
+++ b/drivers/md/dm-table.c
@@@ -18,6 -18,8 +18,11 @@@
  #include <linux/mutex.h>
  #include <linux/delay.h>
  #include <linux/atomic.h>
++<<<<<<< HEAD
++=======
+ #include <linux/blk-mq.h>
+ #include <linux/mount.h>
++>>>>>>> 644bda6f3460 (dm table: fall back to getting device using name_to_dev_t())
  
  #define DM_MSG_PREFIX "table"
  
* Unmerged path drivers/md/dm-table.c
