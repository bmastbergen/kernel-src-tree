ixgbe: Correct X540 semaphore error

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
commit-author Mark Rustad <mark.d.rustad@intel.com>
commit acb1ce223b3e6a340e46fe7b21a9dd4797618ace
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/acb1ce22.failed

In the function ixgbe_get_swfw_sync_semaphore, an incorrect
check was treating success as failure and vice-versa. This led
to manipulating the IXGBE_SWFW_SYNC register without holding
the software semaphore first, which is an error. In addition,
if getting the REGSMP bit in the IXGBE_SW_FW_SYNC register
timed out, no error code would be returned, making the caller
think that it had successfully acquired the lock. Fix both of
those issues and clean up the function a bit, such as make the
name in the comment match the function.

	Signed-off-by: Mark Rustad <mark.d.rustad@intel.com>
	Tested-by: Phil Schmitt <phillip.j.schmitt@intel.com>
	Signed-off-by: Jeff Kirsher <jeffrey.t.kirsher@intel.com>
(cherry picked from commit acb1ce223b3e6a340e46fe7b21a9dd4797618ace)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/intel/ixgbe/ixgbe_x540.c
diff --cc drivers/net/ethernet/intel/ixgbe/ixgbe_x540.c
index 202411a49822,1e26794febd6..000000000000
--- a/drivers/net/ethernet/intel/ixgbe/ixgbe_x540.c
+++ b/drivers/net/ethernet/intel/ixgbe/ixgbe_x540.c
@@@ -700,22 -681,22 +697,37 @@@ static s32 ixgbe_get_swfw_sync_semaphor
  		usleep_range(50, 100);
  	}
  
++<<<<<<< HEAD
 +	/* Now get the semaphore between SW/FW through the REGSMP bit */
 +	if (status) {
 +		for (i = 0; i < timeout; i++) {
 +			swsm = IXGBE_READ_REG(hw, IXGBE_SWFW_SYNC);
 +			if (!(swsm & IXGBE_SWFW_REGSMP))
 +				break;
 +
 +			usleep_range(50, 100);
 +		}
 +	} else {
 +		hw_dbg(hw, "Software semaphore SMBI between device drivers "
 +		           "not granted.\n");
++=======
+ 	if (i == timeout) {
+ 		hw_dbg(hw,
+ 		       "Software semaphore SMBI between device drivers not granted.\n");
+ 		return IXGBE_ERR_EEPROM;
++>>>>>>> acb1ce223b3e (ixgbe: Correct X540 semaphore error)
  	}
  
- 	return status;
+ 	/* Now get the semaphore between SW/FW through the REGSMP bit */
+ 	for (i = 0; i < timeout; i++) {
+ 		swsm = IXGBE_READ_REG(hw, IXGBE_SWFW_SYNC);
+ 		if (!(swsm & IXGBE_SWFW_REGSMP))
+ 			return 0;
+ 
+ 		usleep_range(50, 100);
+ 	}
+ 
+ 	return IXGBE_ERR_EEPROM;
  }
  
  /**
* Unmerged path drivers/net/ethernet/intel/ixgbe/ixgbe_x540.c
