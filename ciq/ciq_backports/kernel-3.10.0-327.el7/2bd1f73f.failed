ALSA: hda - remove controller dependency on i915 power well for Baytrail/Braswell

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
Rebuild_CHGLOG: - [alsa] hda - remove controller dependency on i915 power well for Baytrail/Braswell (Jaroslav Kysela) [1197064]
Rebuild_FUZZ: 96.15%
commit-author Mengdong Lin <mengdong.lin@intel.com>
commit 2bd1f73f4242ee19d8c610bcffe6e7a813451ce0
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/2bd1f73f.failed

For Baytrail (Valleyview) and Braswell (Cherryview), only the HDMI codec is
in the display power well while the HD-A controller isn't. So the controller
flag 'need_i915_power' is not set to release the display power after probe,
and the codec flag 'link_power_control" is set to request/release the display
power via bus link_power ops.

	Signed-off-by: Mengdong Lin <mengdong.lin@intel.com>
	Signed-off-by: Takashi Iwai <tiwai@suse.de>
(cherry picked from commit 2bd1f73f4242ee19d8c610bcffe6e7a813451ce0)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	sound/pci/hda/hda_intel.c
diff --cc sound/pci/hda/hda_intel.c
index 1b8eb97f0430,9253b71ffc1a..000000000000
--- a/sound/pci/hda/hda_intel.c
+++ b/sound/pci/hda/hda_intel.c
@@@ -1875,8 -1892,19 +1875,16 @@@ static int azx_probe_continue(struct az
  	int dev = chip->dev_index;
  	int err;
  
 -	hda->probe_continued = 1;
 -
 -	/* Request display power well for the HDA controller or codec. For
 -	 * Haswell/Broadwell, both the display HDA controller and codec need
 -	 * this power. For other platforms, like Baytrail/Braswell, only the
 -	 * display codec needs the power and it can be released after probe.
 -	 */
 +	/* Request power well for Haswell HDA controller and codec */
  	if (chip->driver_caps & AZX_DCAPS_I915_POWERWELL) {
++<<<<<<< HEAD
++=======
+ 		/* Baytral/Braswell controllers don't need this power */
+ 		if (pci->device != 0x0f04 && pci->device != 0x2284)
+ 			hda->need_i915_power = 1;
+ 
+ 
++>>>>>>> 2bd1f73f4242 (ALSA: hda - remove controller dependency on i915 power well for Baytrail/Braswell)
  #ifdef CONFIG_SND_HDA_I915
  		err = hda_i915_init(hda);
  		if (err < 0)
* Unmerged path sound/pci/hda/hda_intel.c
diff --git a/sound/pci/hda/patch_hdmi.c b/sound/pci/hda/patch_hdmi.c
index 6b5acaea2dba..5100e6f0aa9e 100644
--- a/sound/pci/hda/patch_hdmi.c
+++ b/sound/pci/hda/patch_hdmi.c
@@ -2336,6 +2336,15 @@ static int patch_generic_hdmi(struct hda_codec *codec)
 		intel_haswell_fixup_enable_dp12(codec);
 	}
 
+	/* For Valleyview/Cherryview, only the display codec is in the display
+	 * power well and can use link_power ops to request/release the power.
+	 * For Haswell/Broadwell, the controller is also in the power well and
+	 * can cover the codec power request, and so need not set this flag.
+	 * For previous platforms, there is no such power well feature.
+	 */
+	if (is_valleyview_plus(codec))
+		codec->core.link_power_control = 1;
+
 	if (is_haswell_plus(codec) || is_valleyview_plus(codec))
 		codec->depop_delay = 0;
 
