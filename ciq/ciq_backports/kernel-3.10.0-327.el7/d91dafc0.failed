powerpc/eeh: Delay probing EEH device during hotplug

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
Rebuild_CHGLOG: - [powerpc] eeh: Delay probing EEH device during hotplug (Laurent Vivier) [1213675]
Rebuild_FUZZ: 91.67%
commit-author Gavin Shan <gwshan@linux.vnet.ibm.com>
commit d91dafc02f42e23c1a906202ebde5d7c49ef058d
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/d91dafc0.failed

Commit 1c509148b ("powerpc/eeh: Do probe on pci_dn") probes EEH
devices in early stage, which is reasonable to pSeries platform.
However, it's wrong for PowerNV platform because the PE# isn't
determined until the resources (IO and MMIO) are assigned to
PE in hotplug case. So we have to delay probing EEH devices
for PowerNV platform until the PE# is assigned.

Fixes: ff57b454ddb9 ("powerpc/eeh: Do probe on pci_dn")
	Signed-off-by: Gavin Shan <gwshan@linux.vnet.ibm.com>
	Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
(cherry picked from commit d91dafc02f42e23c1a906202ebde5d7c49ef058d)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/powerpc/kernel/eeh.c
diff --cc arch/powerpc/kernel/eeh.c
index 6021b67a433c,9ee61d15653d..000000000000
--- a/arch/powerpc/kernel/eeh.c
+++ b/arch/powerpc/kernel/eeh.c
@@@ -991,27 -1053,24 +991,32 @@@ core_initcall_sync(eeh_init)
   * on the CEC architecture, type of the device, on earlier boot
   * command-line arguments & etc.
   */
 -void eeh_add_device_early(struct pci_dn *pdn)
 +void eeh_add_device_early(struct device_node *dn)
  {
  	struct pci_controller *phb;
 -	struct eeh_dev *edev = pdn_to_eeh_dev(pdn);
  
 -	if (!edev || !eeh_enabled())
 +	/*
 +	 * If we're doing EEH probe based on PCI device, we
 +	 * would delay the probe until late stage because
 +	 * the PCI device isn't available this moment.
 +	 */
 +	if (!eeh_probe_mode_devtree())
  		return;
  
++<<<<<<< HEAD
 +	if (!of_node_to_eeh_dev(dn))
 +		return;
 +	phb = of_node_to_eeh_dev(dn)->phb;
++=======
+ 	if (!eeh_has_flag(EEH_PROBE_MODE_DEVTREE))
+ 		return;
++>>>>>>> d91dafc02f42 (powerpc/eeh: Delay probing EEH device during hotplug)
  
  	/* USB Bus children of PCI devices will not have BUID's */
 -	phb = edev->phb;
 -	if (NULL == phb ||
 -	    (eeh_has_flag(EEH_PROBE_MODE_DEVTREE) && 0 == phb->buid))
 +	if (NULL == phb || 0 == phb->buid)
  		return;
  
 -	eeh_ops->probe(pdn, NULL);
 +	eeh_ops->of_probe(dn, NULL);
  }
  
  /**
* Unmerged path arch/powerpc/kernel/eeh.c
