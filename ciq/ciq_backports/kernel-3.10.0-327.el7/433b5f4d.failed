hpsa: decrement h->commands_outstanding in fail_all_outstanding_cmds

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
commit-author Stephen Cameron <stephenmcameron@gmail.com>
commit 433b5f4dba2307e33ea65169009965f26496b6df
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/433b5f4d.failed

make tracking of outstanding commands more robust

	Reviewed-by: Scott Teel <scott.teel@pmcs.com>
	Reviewed-by: Kevin Barnett <kevin.barnett@pmcs.com>
	Reviewed-by: Tomas Henzl <thenzl@redhat.com>
	Reviewed-by: Hannes Reinecke <hare@Suse.de>
	Signed-off-by: Don Brace <don.brace@pmcs.com>
	Reviewed-by: Christoph Hellwig <hch@lst.de>
	Signed-off-by: James Bottomley <JBottomley@Odin.com>
(cherry picked from commit 433b5f4dba2307e33ea65169009965f26496b6df)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/hpsa.c
diff --cc drivers/scsi/hpsa.c
index 4400efc84107,d5a5a6413b6d..000000000000
--- a/drivers/scsi/hpsa.c
+++ b/drivers/scsi/hpsa.c
@@@ -6469,17 -6881,24 +6469,28 @@@ static void hpsa_undo_allocations_after
  /* Called when controller lockup detected. */
  static void fail_all_outstanding_cmds(struct ctlr_info *h)
  {
 -	int i, refcount;
 -	struct CommandList *c;
 -	int failcount = 0;
 +	int i;
 +	struct CommandList *c = NULL;
  
 -	flush_workqueue(h->resubmit_wq); /* ensure all cmds are fully built */
  	for (i = 0; i < h->nr_cmds; i++) {
 +		if (!test_bit(i & (BITS_PER_LONG - 1),
 +				h->cmd_pool_bits + (i / BITS_PER_LONG)))
 +			continue;
  		c = h->cmd_pool + i;
++<<<<<<< HEAD
 +		c->err_info->CommandStatus = CMD_HARDWARE_ERR;
 +		finish_cmd(c);
++=======
+ 		refcount = atomic_inc_return(&c->refcount);
+ 		if (refcount > 1) {
+ 			c->err_info->CommandStatus = CMD_CTLR_LOCKUP;
+ 			finish_cmd(c);
+ 			atomic_dec(&h->commands_outstanding);
+ 			failcount++;
+ 		}
+ 		cmd_free(h, c);
++>>>>>>> 433b5f4dba23 (hpsa: decrement h->commands_outstanding in fail_all_outstanding_cmds)
  	}
 -	dev_warn(&h->pdev->dev,
 -		"failed %d commands in fail_all\n", failcount);
  }
  
  static void set_lockup_detected_for_all_cpus(struct ctlr_info *h, u32 value)
* Unmerged path drivers/scsi/hpsa.c
