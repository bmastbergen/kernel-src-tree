x86, MCE, AMD: Drop software-defined bank in error thresholding

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
Rebuild_CHGLOG: - [x86] mce: Drop software-defined bank in error thresholding (Prarit Bhargava) [1217770]
Rebuild_FUZZ: 91.38%
commit-author Borislav Petkov <bp@suse.de>
commit a3a529d104ec5149fb9a667dce988635941be1ed
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/a3a529d1.failed

Aravind had the good question about why we're assigning a
software-defined bank when reporting error thresholding errors instead
of simply using the bank which reports the last error causing the
overflow.

Digging through git history, it pointed to

95268664390b ("[PATCH] x86_64: mce_amd support for family 0x10 processors")

which added that functionality. The problem with this, however, is that
tools don't know about software-defined banks and get puzzled. So drop
that K8_MCE_THRESHOLD_BASE and simply use the hw bank reporting the
thresholding interrupt.

Save us a couple of MSR reads while at it.

	Reported-by: Aravind Gopalakrishnan <aravind.gopalakrishnan@amd.com>
Link: https://lkml.kernel.org/r/5435B206.60402@amd.com
	Signed-off-by: Borislav Petkov <bp@suse.de>
(cherry picked from commit a3a529d104ec5149fb9a667dce988635941be1ed)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kernel/cpu/mcheck/mce_amd.c
diff --cc arch/x86/kernel/cpu/mcheck/mce_amd.c
index 72af0a7be258,6606523ff1c1..000000000000
--- a/arch/x86/kernel/cpu/mcheck/mce_amd.c
+++ b/arch/x86/kernel/cpu/mcheck/mce_amd.c
@@@ -311,21 -310,20 +311,34 @@@ static void amd_threshold_interrupt(voi
  			 * Log the machine check that caused the threshold
  			 * event.
  			 */
 -			if (high & MASK_OVERFLOW_HI)
 -				goto log;
 +			machine_check_poll(MCP_TIMESTAMP,
 +					&__get_cpu_var(mce_poll_banks));
 +
 +			if (high & MASK_OVERFLOW_HI) {
 +				rdmsrl(address, m.misc);
 +				rdmsrl(MSR_IA32_MC0_STATUS + bank * 4,
 +				       m.status);
 +				m.bank = K8_MCE_THRESHOLD_BASE
 +				       + bank * NR_BLOCKS
 +				       + block;
 +				mce_log(&m);
 +				return;
 +			}
  		}
  	}
++<<<<<<< HEAD
++=======
+ 	return;
+ 
+ log:
+ 	mce_setup(&m);
+ 	rdmsrl(MSR_IA32_MCx_STATUS(bank), m.status);
+ 	m.misc = ((u64)high << 32) | low;
+ 	m.bank = bank;
+ 	mce_log(&m);
+ 
+ 	wrmsrl(MSR_IA32_MCx_STATUS(bank), 0);
++>>>>>>> a3a529d104ec (x86, MCE, AMD: Drop software-defined bank in error thresholding)
  }
  
  /*
diff --git a/arch/x86/include/asm/mce.h b/arch/x86/include/asm/mce.h
index 958b90f761e5..276392f121fb 100644
--- a/arch/x86/include/asm/mce.h
+++ b/arch/x86/include/asm/mce.h
@@ -78,7 +78,6 @@
 /* Software defined banks */
 #define MCE_EXTENDED_BANK	128
 #define MCE_THERMAL_BANK	(MCE_EXTENDED_BANK + 0)
-#define K8_MCE_THRESHOLD_BASE   (MCE_EXTENDED_BANK + 1)
 
 #define MCE_LOG_LEN 32
 #define MCE_LOG_SIGNATURE	"MACHINECHECK"
* Unmerged path arch/x86/kernel/cpu/mcheck/mce_amd.c
