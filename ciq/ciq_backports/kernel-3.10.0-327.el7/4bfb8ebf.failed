iscsi_tcp: export port being used

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
commit-author Mike Christie <michaelc@cs.wisc.edu>
commit 4bfb8ebf4c21f372a8677f9aa99963985e9e6539
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/4bfb8ebf.failed

This just has iscsi_tcp support ISCSI_PARAM_LOCAL_PORT which
exports the local port being used by the iscsi connection.

	Signed-off-by: Mike Christie <michaelc@cs.wisc.edu>
	Signed-off-by: Christoph Hellwig <hch@lst.de>
(cherry picked from commit 4bfb8ebf4c21f372a8677f9aa99963985e9e6539)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/iscsi_tcp.c
diff --cc drivers/scsi/iscsi_tcp.c
index a70e7d920c87,427af0f24b0f..000000000000
--- a/drivers/scsi/iscsi_tcp.c
+++ b/drivers/scsi/iscsi_tcp.c
@@@ -726,14 -726,19 +726,29 @@@ static int iscsi_sw_tcp_conn_get_param(
  	switch(param) {
  	case ISCSI_PARAM_CONN_PORT:
  	case ISCSI_PARAM_CONN_ADDRESS:
++<<<<<<< HEAD
 +		spin_lock_bh(&conn->session->lock);
++=======
+ 	case ISCSI_PARAM_LOCAL_PORT:
+ 		spin_lock_bh(&conn->session->frwd_lock);
++>>>>>>> 4bfb8ebf4c21 (iscsi_tcp: export port being used)
  		if (!tcp_sw_conn || !tcp_sw_conn->sock) {
 -			spin_unlock_bh(&conn->session->frwd_lock);
 +			spin_unlock_bh(&conn->session->lock);
  			return -ENOTCONN;
  		}
++<<<<<<< HEAD
 +		rc = kernel_getpeername(tcp_sw_conn->sock,
 +					(struct sockaddr *)&addr, &len);
 +		spin_unlock_bh(&conn->session->lock);
++=======
+ 		if (param == ISCSI_PARAM_LOCAL_PORT)
+ 			rc = kernel_getsockname(tcp_sw_conn->sock,
+ 						(struct sockaddr *)&addr, &len);
+ 		else
+ 			rc = kernel_getpeername(tcp_sw_conn->sock,
+ 						(struct sockaddr *)&addr, &len);
+ 		spin_unlock_bh(&conn->session->frwd_lock);
++>>>>>>> 4bfb8ebf4c21 (iscsi_tcp: export port being used)
  		if (rc)
  			return rc;
  
* Unmerged path drivers/scsi/iscsi_tcp.c
diff --git a/drivers/scsi/libiscsi.c b/drivers/scsi/libiscsi.c
index 0c863af09254..5f938799f297 100644
--- a/drivers/scsi/libiscsi.c
+++ b/drivers/scsi/libiscsi.c
@@ -3475,6 +3475,7 @@ int iscsi_conn_get_addr_param(struct sockaddr_storage *addr,
 			len = sprintf(buf, "%pI6\n", &sin6->sin6_addr);
 		break;
 	case ISCSI_PARAM_CONN_PORT:
+	case ISCSI_PARAM_LOCAL_PORT:
 		if (sin)
 			len = sprintf(buf, "%hu\n", be16_to_cpu(sin->sin_port));
 		else
