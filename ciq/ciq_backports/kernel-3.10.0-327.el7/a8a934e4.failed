s390: fix control register update

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-327.el7
Rebuild_CHGLOG: - [s390] fix control register update (Hendrik Brueckner) [1204860]
Rebuild_FUZZ: 90.00%
commit-author Martin Schwidefsky <schwidefsky@de.ibm.com>
commit a8a934e44f2bd0ed613e1aa0471e3478c6a9228a
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-327.el7/a8a934e4.failed

The git commit c63badebfebacdba827ab1cc1d420fc81bd8d818
"s390: optimize control register update" broke the update for
control register 0. After the update do the lctlg from the correct
value.

	Cc: <stable@vger.kernel.org> # 3.14
	Signed-off-by: Martin Schwidefsky <schwidefsky@de.ibm.com>
(cherry picked from commit a8a934e44f2bd0ed613e1aa0471e3478c6a9228a)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/s390/kernel/ptrace.c
diff --cc arch/s390/kernel/ptrace.c
index b113cc3c32f6,1c82619eb4f7..000000000000
--- a/arch/s390/kernel/ptrace.c
+++ b/arch/s390/kernel/ptrace.c
@@@ -56,17 -56,26 +56,34 @@@ void update_per_regs(struct task_struc
  #ifdef CONFIG_64BIT
  	/* Take care of the enable/disable of transactional execution. */
  	if (MACHINE_HAS_TE) {
 -		unsigned long cr, cr_new;
 +		unsigned long cr0, cr0_new;
  
 -		__ctl_store(cr, 0, 0);
 -		/* Set or clear transaction execution TXC bit 8. */
 -		cr_new = cr | (1UL << 55);
 +		__ctl_store(cr0, 0, 0);
 +		/* set or clear transaction execution bit 8. */
  		if (task->thread.per_flags & PER_FLAG_NO_TE)
++<<<<<<< HEAD
 +			cr0_new = cr0 & ~(1UL << 55);
 +		else
 +			cr0_new = cr0 | (1UL << 55);
 +		/* Only load control register 0 if necessary. */
 +		if (cr0 != cr0_new)
 +			__ctl_load(cr0_new, 0, 0);
++=======
+ 			cr_new &= ~(1UL << 55);
+ 		if (cr_new != cr)
+ 			__ctl_load(cr_new, 0, 0);
+ 		/* Set or clear transaction execution TDC bits 62 and 63. */
+ 		__ctl_store(cr, 2, 2);
+ 		cr_new = cr & ~3UL;
+ 		if (task->thread.per_flags & PER_FLAG_TE_ABORT_RAND) {
+ 			if (task->thread.per_flags & PER_FLAG_TE_ABORT_RAND_TEND)
+ 				cr_new |= 1UL;
+ 			else
+ 				cr_new |= 2UL;
+ 		}
+ 		if (cr_new != cr)
+ 			__ctl_load(cr_new, 2, 2);
++>>>>>>> a8a934e44f2b (s390: fix control register update)
  	}
  #endif
  	/* Copy user specified PER registers */
* Unmerged path arch/s390/kernel/ptrace.c
