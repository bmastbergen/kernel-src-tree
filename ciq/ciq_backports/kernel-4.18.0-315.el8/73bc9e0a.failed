mac80211: don't apply flow control on management frames

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-315.el8
commit-author Johannes Berg <johannes.berg@intel.com>
commit 73bc9e0af5945d03d398668dd97885742a5e85f7
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-315.el8/73bc9e0a.failed

In some cases (depending on the driver, but it's true e.g. for
iwlwifi) we're using an internal TXQ for management packets,
mostly to simplify the code and to have a place to queue them.
However, it appears that in certain cases we can confuse the
code and management frames are dropped, which is certainly not
what we want.

Short-circuit the processing of management frames. To keep the
impact minimal, only put them on the frags queue and check the
tid == management only for doing that and to skip the airtime
fairness checks, if applicable.

	Signed-off-by: Johannes Berg <johannes.berg@intel.com>
	Acked-by: Toke Høiland-Jørgensen <toke@redhat.com>
Link: https://lore.kernel.org/r/20210319232800.0e876c800866.Id2b66eb5a17f3869b776c39b5ca713272ea09d5d@changeid
	Signed-off-by: Johannes Berg <johannes.berg@intel.com>
(cherry picked from commit 73bc9e0af5945d03d398668dd97885742a5e85f7)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/mac80211/tx.c
diff --cc net/mac80211/tx.c
index 074e551a1818,ac765dd19d02..000000000000
--- a/net/mac80211/tx.c
+++ b/net/mac80211/tx.c
@@@ -1397,11 -1383,23 +1397,28 @@@ static void ieee80211_txq_enqueue(struc
  {
  	struct fq *fq = &local->fq;
  	struct fq_tin *tin = &txqi->tin;
 -	u32 flow_idx = fq_flow_idx(fq, skb);
  
  	ieee80211_set_skb_enqueue_time(skb);
++<<<<<<< HEAD
 +	fq_tin_enqueue(fq, tin, skb,
 +		       fq_skb_free_func,
 +		       fq_flow_get_default_func);
++=======
+ 
+ 	spin_lock_bh(&fq->lock);
+ 	/*
+ 	 * For management frames, don't really apply codel etc.,
+ 	 * we don't want to apply any shaping or anything we just
+ 	 * want to simplify the driver API by having them on the
+ 	 * txqi.
+ 	 */
+ 	if (unlikely(txqi->txq.tid == IEEE80211_NUM_TIDS))
+ 		__skb_queue_tail(&txqi->frags, skb);
+ 	else
+ 		fq_tin_enqueue(fq, tin, flow_idx, skb,
+ 			       fq_skb_free_func);
+ 	spin_unlock_bh(&fq->lock);
++>>>>>>> 73bc9e0af594 (mac80211: don't apply flow control on management frames)
  }
  
  static bool fq_vlan_filter_func(struct fq *fq, struct fq_tin *tin,
* Unmerged path net/mac80211/tx.c
