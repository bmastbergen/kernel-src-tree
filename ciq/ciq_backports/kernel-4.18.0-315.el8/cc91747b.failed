mt76: mt7915: fix rate setting of tx descriptor in testmode

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-315.el8
commit-author Shayne Chen <shayne.chen@mediatek.com>
commit cc91747be98f2a3fc305cf3efc8f3a9b7f6a9f3b
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-315.el8/cc91747b.failed

Fix ofdm rate index and ldpc setting in rate setting field of tx
descriptor.

	Signed-off-by: Shayne Chen <shayne.chen@mediatek.com>
	Signed-off-by: Felix Fietkau <nbd@nbd.name>
(cherry picked from commit cc91747be98f2a3fc305cf3efc8f3a9b7f6a9f3b)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/wireless/mediatek/mt76/mt7915/mac.c
diff --cc drivers/net/wireless/mediatek/mt76/mt7915/mac.c
index fe20a844fa3b,f99c2690d73c..000000000000
--- a/drivers/net/wireless/mediatek/mt76/mt7915/mac.c
+++ b/drivers/net/wireless/mediatek/mt76/mt7915/mac.c
@@@ -601,18 -656,20 +601,24 @@@ void mt7915_mac_fill_rx_vector(struct m
  #endif
  
  static void
 -mt7915_mac_write_txwi_tm(struct mt7915_phy *phy, __le32 *txwi,
 -			 struct sk_buff *skb)
 +mt7915_mac_write_txwi_tm(struct mt7915_dev *dev, struct mt76_phy *mphy,
 +			 __le32 *txwi, struct sk_buff *skb)
  {
  #ifdef CONFIG_NL80211_TESTMODE
++<<<<<<< HEAD
 +	struct mt76_testmode_data *td = &dev->mt76.test;
++=======
+ 	struct mt76_testmode_data *td = &phy->mt76->test;
+ 	const struct ieee80211_rate *r;
+ 	u8 bw, mode, nss = td->tx_rate_nss;
++>>>>>>> cc91747be98f (mt76: mt7915: fix rate setting of tx descriptor in testmode)
  	u8 rate_idx = td->tx_rate_idx;
- 	u8 nss = td->tx_rate_nss;
- 	u8 bw, mode;
  	u16 rateval = 0;
  	u32 val;
+ 	bool cck = false;
+ 	int band;
  
 -	if (skb != phy->mt76->test.tx_skb)
 +	if (skb != dev->mt76.test.tx_skb)
  		return;
  
  	switch (td->tx_rate_mode) {
@@@ -693,12 -760,13 +709,13 @@@
  	if (mode >= MT_PHY_TYPE_HE_SU)
  		val |= FIELD_PREP(MT_TXD6_HELTF, td->tx_ltf);
  
- 	if (td->tx_rate_ldpc || bw > 0)
+ 	if (td->tx_rate_ldpc || (bw > 0 && mode >= MT_PHY_TYPE_HE_SU))
  		val |= MT_TXD6_LDPC;
  
+ 	txwi[3] &= ~cpu_to_le32(MT_TXD3_SN_VALID);
  	txwi[6] |= cpu_to_le32(val);
  	txwi[7] |= cpu_to_le32(FIELD_PREP(MT_TXD7_SPE_IDX,
 -					  phy->test.spe_idx));
 +					  dev->test.spe_idx));
  #endif
  }
  
* Unmerged path drivers/net/wireless/mediatek/mt76/mt7915/mac.c
