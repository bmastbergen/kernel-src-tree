libbpf: Factor out common ELF operations and improve logging

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-315.el8
commit-author Andrii Nakryiko <andriin@fb.com>
commit 88a82120282bdef4c331e20991e3057f417beae4
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-315.el8/88a82120.failed

Factor out common ELF operations done throughout the libbpf. This simplifies
usage across multiple places in libbpf, as well as hide error reporting from
higher-level functions and make error logging more consistent.

	Signed-off-by: Andrii Nakryiko <andriin@fb.com>
	Signed-off-by: Alexei Starovoitov <ast@kernel.org>
Link: https://lore.kernel.org/bpf/20200820231250.1293069-3-andriin@fb.com
(cherry picked from commit 88a82120282bdef4c331e20991e3057f417beae4)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/lib/bpf/libbpf.c
diff --cc tools/lib/bpf/libbpf.c
index e8a159519d3d,dfb18d3ee590..000000000000
--- a/tools/lib/bpf/libbpf.c
+++ b/tools/lib/bpf/libbpf.c
@@@ -2274,12 -2248,11 +2248,16 @@@ static int bpf_object__init_user_btf_ma
  	if (obj->efile.btf_maps_shndx < 0)
  		return 0;
  
- 	scn = elf_getscn(obj->efile.elf, obj->efile.btf_maps_shndx);
- 	if (scn)
- 		data = elf_getdata(scn, NULL);
+ 	scn = elf_sec_by_idx(obj, obj->efile.btf_maps_shndx);
+ 	data = elf_sec_data(obj, scn);
  	if (!scn || !data) {
++<<<<<<< HEAD
 +		pr_warn("failed to get Elf_Data from map section %d (%s)\n",
 +			obj->efile.btf_maps_shndx, MAPS_ELF_SEC);
++=======
+ 		pr_warn("elf: failed to get %s map definitions for %s\n",
+ 			MAPS_ELF_SEC, obj->path);
++>>>>>>> 88a82120282b (libbpf: Factor out common ELF operations and improve logging)
  		return -EINVAL;
  	}
  
* Unmerged path tools/lib/bpf/libbpf.c
