scsi: storvsc: Enable scatterlist entry lengths > 4Kbytes

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-315.el8
commit-author Michael Kelley <mikelley@microsoft.com>
commit 3d9c3dcc58e968403f29767726407bc680e087b5
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-315.el8/3d9c3dcc.failed

storvsc currently sets .dma_boundary to limit scatterlist entries to 4
Kbytes, which is less efficient with huge pages that offer large chunks of
contiguous physical memory. Improve the algorithm for creating the Hyper-V
guest physical address PFN array so that scatterlist entries with lengths >
4Kbytes are handled.  As a result, remove the .dma_boundary setting.

The improved algorithm also adds support for scatterlist entries with
offsets >= 4Kbytes, which is supported by many other SCSI low-level
drivers.  And it retains support for architectures where possibly PAGE_SIZE
!= HV_HYP_PAGE_SIZE (such as ARM64).

Link: https://lore.kernel.org/r/1614120294-1930-1-git-send-email-mikelley@microsoft.com
	Reviewed-by: Vitaly Kuznetsov <vkuznets@redhat.com>
	Signed-off-by: Michael Kelley <mikelley@microsoft.com>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit 3d9c3dcc58e968403f29767726407bc680e087b5)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/storvsc_drv.c
diff --cc drivers/scsi/storvsc_drv.c
index 52a4cb1e9552,e6718a74e5da..000000000000
--- a/drivers/scsi/storvsc_drv.c
+++ b/drivers/scsi/storvsc_drv.c
@@@ -1867,9 -1847,8 +1849,14 @@@ static struct scsi_host_template scsi_d
  	.slave_configure =	storvsc_device_configure,
  	.cmd_per_lun =		2048,
  	.this_id =		-1,
++<<<<<<< HEAD
 +	.use_clustering =	ENABLE_CLUSTERING,
 +	/* Make sure we dont get a sg segment crosses a page boundary */
 +	.dma_boundary =		PAGE_SIZE-1,
++=======
+ 	/* Ensure there are no gaps in presented sgls */
+ 	.virt_boundary_mask =	PAGE_SIZE-1,
++>>>>>>> 3d9c3dcc58e9 (scsi: storvsc: Enable scatterlist entry lengths > 4Kbytes)
  	.no_write_same =	1,
  	.track_queue_depth =	1,
  	.change_queue_depth =	storvsc_change_queue_depth,
* Unmerged path drivers/scsi/storvsc_drv.c
diff --git a/include/linux/hyperv.h b/include/linux/hyperv.h
index 5a5208da6a4e..e6d8e3b8a4ef 100644
--- a/include/linux/hyperv.h
+++ b/include/linux/hyperv.h
@@ -1750,6 +1750,7 @@ static inline unsigned long virt_to_hvpfn(void *addr)
 #define NR_HV_HYP_PAGES_IN_PAGE	(PAGE_SIZE / HV_HYP_PAGE_SIZE)
 #define offset_in_hvpage(ptr)	((unsigned long)(ptr) & ~HV_HYP_PAGE_MASK)
 #define HVPFN_UP(x)	(((x) + HV_HYP_PAGE_SIZE-1) >> HV_HYP_PAGE_SHIFT)
+#define HVPFN_DOWN(x)	((x) >> HV_HYP_PAGE_SHIFT)
 #define page_to_hvpfn(page)	(page_to_pfn(page) * NR_HV_HYP_PAGES_IN_PAGE)
 
 #endif /* _HYPERV_H */
