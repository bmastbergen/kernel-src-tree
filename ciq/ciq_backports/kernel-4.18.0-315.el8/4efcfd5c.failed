mt76: mt7615: load ROM patch before checking patch semaphore status

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-315.el8
commit-author Felix Fietkau <nbd@nbd.name>
commit 4efcfd5c36bd0d7c0f62713216a2291562eccfaa
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-315.el8/4efcfd5c.failed

For MT7663, the availability of the patch files is used to detect, which
corresponding firmware is going to be used (AP firmware or STA offload
firmware). If the ROM patch was already applied, it could attempt to
load the wrong firmware (without considering the alternative).

	Signed-off-by: Felix Fietkau <nbd@nbd.name>
(cherry picked from commit 4efcfd5c36bd0d7c0f62713216a2291562eccfaa)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/wireless/mediatek/mt76/mt7615/mcu.c
diff --cc drivers/net/wireless/mediatek/mt76/mt7615/mcu.c
index 38396c2e7057,2e113fd431f5..000000000000
--- a/drivers/net/wireless/mediatek/mt76/mt7615/mcu.c
+++ b/drivers/net/wireless/mediatek/mt76/mt7615/mcu.c
@@@ -1999,20 -1341,9 +1999,23 @@@ static int mt7615_load_patch(struct mt7
  	const struct firmware *fw = NULL;
  	int len, ret, sem;
  
++<<<<<<< HEAD
 +	sem = mt7615_mcu_patch_sem_ctrl(dev, 1);
 +	switch (sem) {
 +	case PATCH_IS_DL:
 +		return 0;
 +	case PATCH_NOT_DL_SEM_SUCCESS:
 +		break;
 +	default:
 +		dev_err(dev->mt76.dev, "Failed to get patch semaphore\n");
 +		return -EAGAIN;
 +	}
 +
++=======
++>>>>>>> 4efcfd5c36bd (mt76: mt7615: load ROM patch before checking patch semaphore status)
  	ret = firmware_request_nowarn(&fw, name, dev->mt76.dev);
  	if (ret)
- 		goto out;
+ 		return ret;
  
  	if (!fw || !fw->data || fw->size < sizeof(*hdr)) {
  		dev_err(dev->mt76.dev, "Invalid firmware\n");
@@@ -2045,9 -1389,7 +2060,13 @@@
  		dev_err(dev->mt76.dev, "Failed to start patch\n");
  
  out:
++<<<<<<< HEAD
 +	release_firmware(fw);
 +
 +	sem = mt7615_mcu_patch_sem_ctrl(dev, 0);
++=======
+ 	sem = mt76_connac_mcu_patch_sem_ctrl(&dev->mt76, false);
++>>>>>>> 4efcfd5c36bd (mt76: mt7615: load ROM patch before checking patch semaphore status)
  	switch (sem) {
  	case PATCH_REL_SEM_SUCCESS:
  		break;
* Unmerged path drivers/net/wireless/mediatek/mt76/mt7615/mcu.c
