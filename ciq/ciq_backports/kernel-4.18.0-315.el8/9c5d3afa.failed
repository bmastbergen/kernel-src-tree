mac80211_hwsim: check that n_limits makes sense

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-315.el8
commit-author Johannes Berg <johannes.berg@intel.com>
commit 9c5d3afac436beef91b7a6312068e9360c7d8446
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-315.el8/9c5d3afa.failed

Under certain circumstances, radios created via netlink could
have n_limits be zero and no possible interface types, which
makes no sense. Reject this early to prevent a WARN_ON() in
cfg80211.

Fixes: 99e3a44bac37 ("mac80211_hwsim: allow setting iftype support")
	Reported-by: syzbot+73fd8b0aa60c67fa4b60@syzkaller.appspotmail.com
	Signed-off-by: Johannes Berg <johannes.berg@intel.com>
(cherry picked from commit 9c5d3afac436beef91b7a6312068e9360c7d8446)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/wireless/mac80211_hwsim.c
diff --cc drivers/net/wireless/mac80211_hwsim.c
index fc163a346a61,320edcac4699..000000000000
--- a/drivers/net/wireless/mac80211_hwsim.c
+++ b/drivers/net/wireless/mac80211_hwsim.c
@@@ -2601,22 -2749,35 +2601,51 @@@ static int mac80211_hwsim_new_radio(str
  		hw->wiphy->max_scan_ssids = 255;
  		hw->wiphy->max_scan_ie_len = IEEE80211_MAX_DATA_LEN;
  		hw->wiphy->max_remain_on_channel_duration = 1000;
 +		hw->wiphy->iface_combinations = &data->if_combination;
 +		if (param->p2p_device)
 +			data->if_combination = hwsim_if_comb_p2p_dev[0];
 +		else
 +			data->if_combination = hwsim_if_comb[0];
 +		hw->wiphy->n_iface_combinations = 1;
 +		/* For channels > 1 DFS is not allowed */
  		data->if_combination.radar_detect_widths = 0;
  		data->if_combination.num_different_channels = data->channels;
 +	} else if (param->p2p_device) {
 +		hw->wiphy->iface_combinations = hwsim_if_comb_p2p_dev;
 +		hw->wiphy->n_iface_combinations =
 +			ARRAY_SIZE(hwsim_if_comb_p2p_dev);
  	} else {
++<<<<<<< HEAD
 +		hw->wiphy->iface_combinations = hwsim_if_comb;
 +		hw->wiphy->n_iface_combinations = ARRAY_SIZE(hwsim_if_comb);
++=======
+ 		data->if_combination.num_different_channels = 1;
+ 		data->if_combination.radar_detect_widths =
+ 					BIT(NL80211_CHAN_WIDTH_20_NOHT) |
+ 					BIT(NL80211_CHAN_WIDTH_20) |
+ 					BIT(NL80211_CHAN_WIDTH_40) |
+ 					BIT(NL80211_CHAN_WIDTH_80) |
+ 					BIT(NL80211_CHAN_WIDTH_160);
+ 	}
+ 
+ 	if (!n_limits) {
+ 		err = -EINVAL;
+ 		goto failed_hw;
+ 	}
+ 
+ 	data->if_combination.n_limits = n_limits;
+ 	data->if_combination.max_interfaces = 2048;
+ 	data->if_combination.limits = data->if_limits;
+ 
+ 	hw->wiphy->iface_combinations = &data->if_combination;
+ 	hw->wiphy->n_iface_combinations = 1;
+ 
+ 	if (param->ciphers) {
+ 		memcpy(data->ciphers, param->ciphers,
+ 		       param->n_ciphers * sizeof(u32));
+ 		hw->wiphy->cipher_suites = data->ciphers;
+ 		hw->wiphy->n_cipher_suites = param->n_ciphers;
++>>>>>>> 9c5d3afac436 (mac80211_hwsim: check that n_limits makes sense)
  	}
  
  	INIT_DELAYED_WORK(&data->roc_start, hw_roc_start);
* Unmerged path drivers/net/wireless/mac80211_hwsim.c
