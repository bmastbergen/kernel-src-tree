xfs: open code ioend needs workqueue helper

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-315.el8
commit-author Brian Foster <bfoster@redhat.com>
commit 7adb8f14e134d5f885d47c4ccd620836235f0b7f
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-315.el8/7adb8f14.failed

Open code xfs_ioend_needs_workqueue() into the only remaining
caller.

	Signed-off-by: Brian Foster <bfoster@redhat.com>
	Reviewed-by: Christoph Hellwig <hch@lst.de>
	Reviewed-by: Darrick J. Wong <djwong@kernel.org>
	Signed-off-by: Darrick J. Wong <djwong@kernel.org>
(cherry picked from commit 7adb8f14e134d5f885d47c4ccd620836235f0b7f)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/xfs/xfs_aops.c
diff --cc fs/xfs/xfs_aops.c
index 58e937be24ce,1b255e56e37f..000000000000
--- a/fs/xfs/xfs_aops.c
+++ b/fs/xfs/xfs_aops.c
@@@ -235,13 -206,6 +235,16 @@@ xfs_end_io
  	}
  }
  
++<<<<<<< HEAD
 +static inline bool xfs_ioend_needs_workqueue(struct iomap_ioend *ioend)
 +{
 +	return ioend->io_private ||
 +		ioend->io_type == IOMAP_UNWRITTEN ||
 +		(ioend->io_flags & IOMAP_F_SHARED);
 +}
 +
++=======
++>>>>>>> 7adb8f14e134 (xfs: open code ioend needs workqueue helper)
  STATIC void
  xfs_end_bio(
  	struct bio		*bio)
@@@ -499,17 -463,11 +502,19 @@@ xfs_prepare_ioend
  				ioend->io_offset, ioend->io_size);
  	}
  
 +	/* Reserve log space if we might write beyond the on-disk inode size. */
 +	if (!status &&
 +	    ((ioend->io_flags & IOMAP_F_SHARED) ||
 +	     ioend->io_type != IOMAP_UNWRITTEN) &&
 +	    xfs_ioend_is_append(ioend) &&
 +	    !ioend->io_private)
 +		status = xfs_setfilesize_trans_alloc(ioend);
 +
  	memalloc_nofs_restore(nofs_flag);
  
- 	if (xfs_ioend_needs_workqueue(ioend))
+ 	/* send ioends that might require a transaction to the completion wq */
+ 	if (xfs_ioend_is_append(ioend) || ioend->io_type == IOMAP_UNWRITTEN ||
+ 	    (ioend->io_flags & IOMAP_F_SHARED))
  		ioend->io_bio->bi_end_io = xfs_end_bio;
  	return status;
  }
* Unmerged path fs/xfs/xfs_aops.c
