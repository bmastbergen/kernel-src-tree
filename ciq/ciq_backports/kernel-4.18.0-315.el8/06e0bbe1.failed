mt76: mt7615: mt7915: disable txpower sku when testmode enabled

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-315.el8
commit-author Shayne Chen <shayne.chen@mediatek.com>
commit 06e0bbe1c57b785a03eb7d412bd5fa332078f184
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-315.el8/06e0bbe1.failed

When testmode can be enabled, the start() callback would already be
called, causing that txpower sku feature isn't really disabled after
testmode is enabled. This patch fix the issue.

	Signed-off-by: Shayne Chen <shayne.chen@mediatek.com>
	Signed-off-by: Felix Fietkau <nbd@nbd.name>
(cherry picked from commit 06e0bbe1c57b785a03eb7d412bd5fa332078f184)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/wireless/mediatek/mt76/mt7615/main.c
#	drivers/net/wireless/mediatek/mt76/mt7915/main.c
diff --cc drivers/net/wireless/mediatek/mt76/mt7615/main.c
index 56dd0b4e4460,3f6c752957b0..000000000000
--- a/drivers/net/wireless/mediatek/mt76/mt7615/main.c
+++ b/drivers/net/wireless/mediatek/mt76/mt7615/main.c
@@@ -321,7 -321,7 +321,11 @@@ int mt7615_set_channel(struct mt7615_ph
  	mt7615_mac_set_timing(phy);
  	ret = mt7615_dfs_init_radar_detector(phy);
  	mt7615_mac_cca_stats_reset(phy);
++<<<<<<< HEAD
 +	mt7615_mcu_set_sku_en(phy, !mt76_testmode_enabled(&dev->mt76));
++=======
+ 	mt7615_mcu_set_sku_en(phy, true);
++>>>>>>> 06e0bbe1c57b (mt76: mt7615: mt7915: disable txpower sku when testmode enabled)
  
  	mt7615_mac_reset_counters(dev);
  	phy->noise = 0;
diff --cc drivers/net/wireless/mediatek/mt76/mt7915/main.c
index e5708026df54,73c5ee10fd3e..000000000000
--- a/drivers/net/wireless/mediatek/mt76/mt7915/main.c
+++ b/drivers/net/wireless/mediatek/mt76/mt7915/main.c
@@@ -44,7 -44,7 +44,11 @@@ static int mt7915_start(struct ieee8021
  		mt7915_mac_enable_nf(dev, 1);
  	}
  
++<<<<<<< HEAD
 +	mt7915_mcu_set_sku_en(phy, !mt76_testmode_enabled(&dev->mt76));
++=======
+ 	mt7915_mcu_set_sku_en(phy, true);
++>>>>>>> 06e0bbe1c57b (mt76: mt7615: mt7915: disable txpower sku when testmode enabled)
  	mt7915_mcu_set_chan_info(phy, MCU_EXT_CMD_SET_RX_PATH);
  
  	set_bit(MT76_STATE_RUNNING, &phy->mt76->state);
* Unmerged path drivers/net/wireless/mediatek/mt76/mt7615/main.c
diff --git a/drivers/net/wireless/mediatek/mt76/mt7615/testmode.c b/drivers/net/wireless/mediatek/mt76/mt7615/testmode.c
index 8fc97a52411a..1f592556cd9d 100644
--- a/drivers/net/wireless/mediatek/mt76/mt7615/testmode.c
+++ b/drivers/net/wireless/mediatek/mt76/mt7615/testmode.c
@@ -137,6 +137,8 @@ mt7615_tm_init_phy(struct mt7615_dev *dev, struct mt7615_phy *phy)
 	if (!test_bit(MT76_STATE_RUNNING, &phy->mt76->state))
 		return;
 
+	mt7615_mcu_set_sku_en(phy, phy->mt76->test.state == MT76_TM_STATE_OFF);
+
 	mutex_unlock(&dev->mt76.mutex);
 	mt7615_set_channel(phy);
 	mt7615_ops.configure_filter(phy->mt76->hw, 0, &total_flags, 0);
* Unmerged path drivers/net/wireless/mediatek/mt76/mt7915/main.c
diff --git a/drivers/net/wireless/mediatek/mt76/mt7915/testmode.c b/drivers/net/wireless/mediatek/mt76/mt7915/testmode.c
index fe56ab18e974..1729793c3a4c 100644
--- a/drivers/net/wireless/mediatek/mt76/mt7915/testmode.c
+++ b/drivers/net/wireless/mediatek/mt76/mt7915/testmode.c
@@ -189,6 +189,8 @@ mt7915_tm_init(struct mt7915_dev *dev)
 	if (!test_bit(MT76_STATE_RUNNING, &dev->phy.mt76->state))
 		return;
 
+	mt7915_mcu_set_sku_en(phy, !en);
+
 	mt7915_tm_mode_ctrl(dev, en);
 	mt7915_tm_reg_backup_restore(dev, &dev->phy);
 	mt7915_tm_set_trx(dev, &dev->phy, TM_MAC_TXRX, !en);
