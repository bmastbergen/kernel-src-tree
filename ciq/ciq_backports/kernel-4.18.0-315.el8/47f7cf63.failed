libbpf: Skip CO-RE relocations for not loaded BPF programs

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-315.el8
commit-author Andrii Nakryiko <andrii@kernel.org>
commit 47f7cf6325f7d38e33d3dc38fa55bbe605f5b335
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-315.el8/47f7cf63.failed

Bypass CO-RE relocations step for BPF programs that are not going to be
loaded. This allows to have BPF programs compiled in and disabled dynamically
if kernel is not supposed to provide enough relocation information. In such
case, there won't be unnecessary warnings about failed relocations.

Fixes: d929758101fc ("libbpf: Support disabling auto-loading BPF programs")
	Signed-off-by: Andrii Nakryiko <andrii@kernel.org>
	Signed-off-by: Alexei Starovoitov <ast@kernel.org>
Link: https://lore.kernel.org/bpf/20201008001025.292064-2-andrii@kernel.org
(cherry picked from commit 47f7cf6325f7d38e33d3dc38fa55bbe605f5b335)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/lib/bpf/libbpf.c
diff --cc tools/lib/bpf/libbpf.c
index 6b3d1475cbfd,07d62771472f..000000000000
--- a/tools/lib/bpf/libbpf.c
+++ b/tools/lib/bpf/libbpf.c
@@@ -5526,6 -5757,20 +5526,23 @@@ bpf_object__relocate_core(struct bpf_ob
  			 sec_name, sec->num_info);
  
  		for_each_btf_ext_rec(seg, sec, i, rec) {
++<<<<<<< HEAD
++=======
+ 			insn_idx = rec->insn_off / BPF_INSN_SZ;
+ 			prog = find_prog_by_sec_insn(obj, sec_idx, insn_idx);
+ 			if (!prog) {
+ 				pr_warn("sec '%s': failed to find program at insn #%d for CO-RE offset relocation #%d\n",
+ 					sec_name, insn_idx, i);
+ 				err = -EINVAL;
+ 				goto out;
+ 			}
+ 			/* no need to apply CO-RE relocation if the program is
+ 			 * not going to be loaded
+ 			 */
+ 			if (!prog->load)
+ 				continue;
+ 
++>>>>>>> 47f7cf6325f7 (libbpf: Skip CO-RE relocations for not loaded BPF programs)
  			err = bpf_core_apply_relo(prog, rec, i, obj->btf,
  						  targ_btf, cand_cache);
  			if (err) {
* Unmerged path tools/lib/bpf/libbpf.c
