mt76: mt7921: introduce MT_WFDMA_DUMMY_CR definition

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-315.el8
commit-author Lorenzo Bianconi <lorenzo@kernel.org>
commit f2d167c7dd2c0bc444e2d5639bcf856d0ea09a71
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-315.el8/f2d167c7.failed

Introduce MT_WFDMA_DUMMY_CR definition and remove magic numbers

	Signed-off-by: Lorenzo Bianconi <lorenzo@kernel.org>
	Signed-off-by: Felix Fietkau <nbd@nbd.name>
(cherry picked from commit f2d167c7dd2c0bc444e2d5639bcf856d0ea09a71)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/wireless/mediatek/mt76/mt7921/mac.c
diff --cc drivers/net/wireless/mediatek/mt76/mt7921/mac.c
index bcbd59a23f9b,f3a537c6e3c8..000000000000
--- a/drivers/net/wireless/mediatek/mt76/mt7921/mac.c
+++ b/drivers/net/wireless/mediatek/mt76/mt7921/mac.c
@@@ -1178,29 -1219,65 +1178,39 @@@ mt7921_wait_reset_state(struct mt7921_d
  }
  
  static void
 -mt7921_dma_reset(struct mt7921_dev *dev)
 +mt7921_dma_reset(struct mt7921_phy *phy)
  {
 +	struct mt7921_dev *dev = phy->dev;
  	int i;
  
 -	/* reset */
 -	mt76_clear(dev, MT_WFDMA0_RST,
 -		   MT_WFDMA0_RST_DMASHDL_ALL_RST | MT_WFDMA0_RST_LOGIC_RST);
 -
 -	mt76_set(dev, MT_WFDMA0_RST,
 -		 MT_WFDMA0_RST_DMASHDL_ALL_RST | MT_WFDMA0_RST_LOGIC_RST);
 -
 -	/* disable WFDMA0 */
  	mt76_clear(dev, MT_WFDMA0_GLO_CFG,
 -		   MT_WFDMA0_GLO_CFG_TX_DMA_EN | MT_WFDMA0_GLO_CFG_RX_DMA_EN |
 -		   MT_WFDMA0_GLO_CFG_CSR_DISP_BASE_PTR_CHAIN_EN |
 -		   MT_WFDMA0_GLO_CFG_OMIT_TX_INFO |
 -		   MT_WFDMA0_GLO_CFG_OMIT_RX_INFO |
 -		   MT_WFDMA0_GLO_CFG_OMIT_RX_INFO_PFET2);
 +		   MT_WFDMA0_GLO_CFG_TX_DMA_EN | MT_WFDMA0_GLO_CFG_RX_DMA_EN);
  
 -	mt76_poll(dev, MT_WFDMA0_GLO_CFG,
 -		  MT_WFDMA0_GLO_CFG_TX_DMA_BUSY |
 -		  MT_WFDMA0_GLO_CFG_RX_DMA_BUSY, 0, 1000);
 +	usleep_range(1000, 2000);
  
 -	/* reset hw queues */
 +	mt76_queue_tx_cleanup(dev, dev->mt76.q_mcu[MT_MCUQ_WA], true);
  	for (i = 0; i < __MT_TXQ_MAX; i++)
 -		mt76_queue_reset(dev, dev->mphy.q_tx[i]);
 +		mt76_queue_tx_cleanup(dev, phy->mt76->q_tx[i], true);
  
 -	for (i = 0; i < __MT_MCUQ_MAX; i++)
 -		mt76_queue_reset(dev, dev->mt76.q_mcu[i]);
 -
 -	mt76_for_each_q_rx(&dev->mt76, i)
 -		mt76_queue_reset(dev, &dev->mt76.q_rx[i]);
 +	mt76_for_each_q_rx(&dev->mt76, i) {
 +		mt76_queue_rx_reset(dev, i);
 +	}
  
 -	/* configure perfetch settings */
 +	/* re-init prefetch settings after reset */
  	mt7921_dma_prefetch(dev);
  
 -	/* reset dma idx */
 -	mt76_wr(dev, MT_WFDMA0_RST_DTX_PTR, ~0);
 -
 -	/* configure delay interrupt */
 -	mt76_wr(dev, MT_WFDMA0_PRI_DLY_INT_CFG0, 0);
 -
 -	mt76_set(dev, MT_WFDMA0_GLO_CFG,
 -		 MT_WFDMA0_GLO_CFG_TX_WB_DDONE |
 -		 MT_WFDMA0_GLO_CFG_FIFO_LITTLE_ENDIAN |
 -		 MT_WFDMA0_GLO_CFG_CLK_GAT_DIS |
 -		 MT_WFDMA0_GLO_CFG_OMIT_TX_INFO |
 -		 MT_WFDMA0_GLO_CFG_CSR_DISP_BASE_PTR_CHAIN_EN |
 -		 MT_WFDMA0_GLO_CFG_OMIT_RX_INFO_PFET2);
 -
  	mt76_set(dev, MT_WFDMA0_GLO_CFG,
  		 MT_WFDMA0_GLO_CFG_TX_DMA_EN | MT_WFDMA0_GLO_CFG_RX_DMA_EN);
++<<<<<<< HEAD
++=======
+ 
+ 	mt76_set(dev, MT_WFDMA_DUMMY_CR, MT_WFDMA_NEED_REINIT);
+ 
+ 	/* enable interrupts for TX/RX rings */
+ 	mt7921_irq_enable(dev,
+ 			  MT_INT_RX_DONE_ALL | MT_INT_TX_DONE_ALL |
+ 			  MT_INT_MCU_CMD);
++>>>>>>> f2d167c7dd2c (mt76: mt7921: introduce MT_WFDMA_DUMMY_CR definition)
  }
  
  void mt7921_tx_token_put(struct mt7921_dev *dev)
diff --git a/drivers/net/wireless/mediatek/mt76/mt7921/dma.c b/drivers/net/wireless/mediatek/mt76/mt7921/dma.c
index cd9665610284..2d6ac55ea9b2 100644
--- a/drivers/net/wireless/mediatek/mt76/mt7921/dma.c
+++ b/drivers/net/wireless/mediatek/mt76/mt7921/dma.c
@@ -323,7 +323,7 @@ int mt7921_dma_init(struct mt7921_dev *dev)
 	mt76_set(dev, MT_WFDMA0_GLO_CFG,
 		 MT_WFDMA0_GLO_CFG_TX_DMA_EN | MT_WFDMA0_GLO_CFG_RX_DMA_EN);
 
-	mt76_set(dev, 0x54000120, BIT(1));
+	mt76_set(dev, MT_WFDMA_DUMMY_CR, MT_WFDMA_NEED_REINIT);
 
 	/* enable interrupts for TX/RX rings */
 	mt7921_irq_enable(dev, MT_INT_RX_DONE_ALL | MT_INT_TX_DONE_ALL |
* Unmerged path drivers/net/wireless/mediatek/mt76/mt7921/mac.c
diff --git a/drivers/net/wireless/mediatek/mt76/mt7921/regs.h b/drivers/net/wireless/mediatek/mt76/mt7921/regs.h
index 28451c7d9573..b95910ab6907 100644
--- a/drivers/net/wireless/mediatek/mt76/mt7921/regs.h
+++ b/drivers/net/wireless/mediatek/mt76/mt7921/regs.h
@@ -385,6 +385,12 @@
 #define MT_TOP_MISC			MT_TOP(0xf0)
 #define MT_TOP_MISC_FW_STATE		GENMASK(2, 0)
 
+#define MT_MCU_WPDMA0_BASE		0x54000000
+#define MT_MCU_WPDMA0(ofs)		(MT_MCU_WPDMA0_BASE + (ofs))
+
+#define MT_WFDMA_DUMMY_CR		MT_MCU_WPDMA0(0x120)
+#define MT_WFDMA_NEED_REINIT		BIT(1)
+
 #define MT_HW_BOUND			0x70010020
 #define MT_HW_CHIPID			0x70010200
 #define MT_HW_REV			0x70010204
