PCI/ERR: Clear status of the reporting device

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-315.el8
commit-author Keith Busch <kbusch@kernel.org>
commit 7d7cbeaba5b7aea8e1e4eb988d6b5e7cb3c34490
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-315.el8/7d7cbeab.failed

Error handling operates on the first Downstream Port above the detected
error, but the error may have been reported by a downstream device.
Clear the AER status of the device that reported the error rather than
the first Downstream Port.

Link: https://lore.kernel.org/r/20210104230300.1277180-2-kbusch@kernel.org
	Tested-by: Hedi Berriche <hedi.berriche@hpe.com>
	Signed-off-by: Keith Busch <kbusch@kernel.org>
	Signed-off-by: Bjorn Helgaas <bhelgaas@google.com>
	Acked-by: Sean V Kelley <sean.v.kelley@intel.com>
	Acked-by: Hedi Berriche <hedi.berriche@hpe.com>
(cherry picked from commit 7d7cbeaba5b7aea8e1e4eb988d6b5e7cb3c34490)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/pci/pcie/err.c
diff --cc drivers/pci/pcie/err.c
index c74d622dbbc4,a84f0bf4c1e2..000000000000
--- a/drivers/pci/pcie/err.c
+++ b/drivers/pci/pcie/err.c
@@@ -195,13 -227,20 +195,27 @@@ pci_ers_result_t pcie_do_recovery(struc
  	if (status != PCI_ERS_RESULT_RECOVERED)
  		goto failed;
  
 -	pci_dbg(bridge, "broadcast resume message\n");
 -	pci_walk_bridge(bridge, report_resume, &status);
 +	pci_dbg(dev, "broadcast resume message\n");
 +	pci_walk_bus(bus, report_resume, &status);
  
++<<<<<<< HEAD
 +	if (pcie_aer_is_native(dev))
 +		pcie_clear_device_status(dev);
 +	pci_aer_clear_nonfatal_status(dev);
 +	pci_info(dev, "device recovery successful\n");
++=======
+ 	/*
+ 	 * If we have native control of AER, clear error status in the device
+ 	 * that detected the error.  If the platform retained control of AER,
+ 	 * it is responsible for clearing this status.  In that case, the
+ 	 * signaling device may not even be visible to the OS.
+ 	 */
+ 	if (host->native_aer || pcie_ports_native) {
+ 		pcie_clear_device_status(dev);
+ 		pci_aer_clear_nonfatal_status(dev);
+ 	}
+ 	pci_info(bridge, "device recovery successful\n");
++>>>>>>> 7d7cbeaba5b7 (PCI/ERR: Clear status of the reporting device)
  	return status;
  
  failed:
* Unmerged path drivers/pci/pcie/err.c
