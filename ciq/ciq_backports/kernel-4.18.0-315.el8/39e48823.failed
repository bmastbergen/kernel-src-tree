mt76: mt7915: rework set state part in testmode

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-315.el8
commit-author Shayne Chen <shayne.chen@mediatek.com>
commit 39e48823e16ad0431730bebb91685f62623b5c99
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-315.el8/39e48823.failed

This is a preliminary patch to simplify setting state in mt7915
testmode, for adding the new continuous tx state.

	Signed-off-by: Shayne Chen <shayne.chen@mediatek.com>
	Signed-off-by: Felix Fietkau <nbd@nbd.name>
(cherry picked from commit 39e48823e16ad0431730bebb91685f62623b5c99)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/wireless/mediatek/mt76/mt7915/testmode.c
diff --cc drivers/net/wireless/mediatek/mt76/mt7915/testmode.c
index fe56ab18e974,62d999bbeb04..000000000000
--- a/drivers/net/wireless/mediatek/mt76/mt7915/testmode.c
+++ b/drivers/net/wireless/mediatek/mt76/mt7915/testmode.c
@@@ -182,11 -395,11 +182,17 @@@ mt7915_tm_reg_backup_restore(struct mt7
  }
  
  static void
++<<<<<<< HEAD
 +mt7915_tm_init(struct mt7915_dev *dev)
 +{
 +	bool en = !(dev->mt76.test.state == MT76_TM_STATE_OFF);
++=======
+ mt7915_tm_init(struct mt7915_phy *phy, bool en)
+ {
+ 	struct mt7915_dev *dev = phy->dev;
++>>>>>>> 39e48823e16a (mt76: mt7915: rework set state part in testmode)
  
 -	if (!test_bit(MT76_STATE_RUNNING, &phy->mt76->state))
 +	if (!test_bit(MT76_STATE_RUNNING, &dev->phy.mt76->state))
  		return;
  
  	mt7915_tm_mode_ctrl(dev, en);
@@@ -253,24 -493,23 +259,36 @@@ mt7915_tm_update_params(struct mt7915_d
  }
  
  static int
 -mt7915_tm_set_state(struct mt76_phy *mphy, enum mt76_testmode_state state)
 +mt7915_tm_set_state(struct mt76_dev *mdev, enum mt76_testmode_state state)
  {
 -	struct mt76_testmode_data *td = &mphy->test;
 -	struct mt7915_phy *phy = mphy->priv;
 +	struct mt7915_dev *dev = container_of(mdev, struct mt7915_dev, mt76);
 +	struct mt76_testmode_data *td = &mdev->test;
  	enum mt76_testmode_state prev_state = td->state;
  
 -	mphy->test.state = state;
 -
 +	mdev->test.state = state;
 +
++<<<<<<< HEAD
 +	if (prev_state == MT76_TM_STATE_TX_FRAMES)
 +		mt7915_tm_set_tx_frames(dev, false);
 +	else if (state == MT76_TM_STATE_TX_FRAMES)
 +		mt7915_tm_set_tx_frames(dev, true);
 +	else if (prev_state == MT76_TM_STATE_RX_FRAMES)
 +		mt7915_tm_set_rx_frames(dev, false);
 +	else if (state == MT76_TM_STATE_RX_FRAMES)
 +		mt7915_tm_set_rx_frames(dev, true);
 +	else if (prev_state == MT76_TM_STATE_OFF || state == MT76_TM_STATE_OFF)
 +		mt7915_tm_init(dev);
++=======
+ 	if (prev_state == MT76_TM_STATE_TX_FRAMES ||
+ 	    state == MT76_TM_STATE_TX_FRAMES)
+ 		mt7915_tm_set_tx_frames(phy, state == MT76_TM_STATE_TX_FRAMES);
+ 	else if (prev_state == MT76_TM_STATE_RX_FRAMES ||
+ 		 state == MT76_TM_STATE_RX_FRAMES)
+ 		mt7915_tm_set_rx_frames(phy, state == MT76_TM_STATE_RX_FRAMES);
+ 	else if (prev_state == MT76_TM_STATE_OFF ||
+ 		 state == MT76_TM_STATE_OFF)
+ 		mt7915_tm_init(phy, !(state == MT76_TM_STATE_OFF));
++>>>>>>> 39e48823e16a (mt76: mt7915: rework set state part in testmode)
  
  	if ((state == MT76_TM_STATE_IDLE &&
  	     prev_state == MT76_TM_STATE_OFF) ||
* Unmerged path drivers/net/wireless/mediatek/mt76/mt7915/testmode.c
