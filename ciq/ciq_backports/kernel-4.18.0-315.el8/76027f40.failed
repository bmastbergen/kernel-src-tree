mt76: mt7915: bring up the WA event rx queue for band1

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-315.el8
commit-author Felix Fietkau <nbd@nbd.name>
commit 76027f40f5ee04bf15cde3a83af9b873c2affa28
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-315.el8/76027f40.failed

This is needed for DBDC cards to work correctly on both bands simultaneously

	Signed-off-by: Felix Fietkau <nbd@nbd.name>
(cherry picked from commit 76027f40f5ee04bf15cde3a83af9b873c2affa28)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/wireless/mediatek/mt76/mt76.h
#	drivers/net/wireless/mediatek/mt76/mt7915/dma.c
#	drivers/net/wireless/mediatek/mt76/mt7915/pci.c
#	drivers/net/wireless/mediatek/mt76/mt7915/regs.h
diff --cc drivers/net/wireless/mediatek/mt76/mt76.h
index e5947573fe0b,90fbdaec8b89..000000000000
--- a/drivers/net/wireless/mediatek/mt76/mt76.h
+++ b/drivers/net/wireless/mediatek/mt76/mt76.h
@@@ -80,6 -80,8 +80,11 @@@ enum mt76_rxq_id 
  	MT_RXQ_MAIN,
  	MT_RXQ_MCU,
  	MT_RXQ_MCU_WA,
++<<<<<<< HEAD
++=======
+ 	MT_RXQ_EXT,
+ 	MT_RXQ_EXT_WA,
++>>>>>>> 76027f40f5ee (mt76: mt7915: bring up the WA event rx queue for band1)
  	__MT_RXQ_MAX
  };
  
diff --cc drivers/net/wireless/mediatek/mt76/mt7915/dma.c
index 4f7c5fd83efb,d47d8f4376c6..000000000000
--- a/drivers/net/wireless/mediatek/mt76/mt7915/dma.c
+++ b/drivers/net/wireless/mediatek/mt76/mt7915/dma.c
@@@ -281,6 -280,22 +281,25 @@@ int mt7915_dma_init(struct mt7915_dev *
  	if (ret)
  		return ret;
  
++<<<<<<< HEAD
++=======
+ 	if (dev->dbdc_support) {
+ 		ret = mt76_queue_alloc(dev, &dev->mt76.q_rx[MT_RXQ_EXT],
+ 				       MT7915_RXQ_BAND1, MT7915_RX_RING_SIZE,
+ 				       rx_buf_size, MT_RX_DATA_RING_BASE);
+ 		if (ret)
+ 			return ret;
+ 
+ 		/* event from WA */
+ 		ret = mt76_queue_alloc(dev, &dev->mt76.q_rx[MT_RXQ_EXT_WA],
+ 				       MT7915_RXQ_MCU_WA_EXT,
+ 				       MT7915_RX_MCU_RING_SIZE,
+ 				       rx_buf_size, MT_RX_EVENT_RING_BASE);
+ 		if (ret)
+ 			return ret;
+ 	}
+ 
++>>>>>>> 76027f40f5ee (mt76: mt7915: bring up the WA event rx queue for band1)
  	ret = mt76_init_queues(dev);
  	if (ret < 0)
  		return ret;
diff --cc drivers/net/wireless/mediatek/mt76/mt7915/pci.c
index 3ac5bbb94d29,99f11588601d..000000000000
--- a/drivers/net/wireless/mediatek/mt76/mt7915/pci.c
+++ b/drivers/net/wireless/mediatek/mt76/mt7915/pci.c
@@@ -21,8 -21,15 +21,18 @@@ static voi
  mt7915_rx_poll_complete(struct mt76_dev *mdev, enum mt76_rxq_id q)
  {
  	struct mt7915_dev *dev = container_of(mdev, struct mt7915_dev, mt76);
++<<<<<<< HEAD
++=======
+ 	static const u32 rx_irq_mask[] = {
+ 		[MT_RXQ_MAIN] = MT_INT_RX_DONE_DATA0,
+ 		[MT_RXQ_EXT] = MT_INT_RX_DONE_DATA1,
+ 		[MT_RXQ_MCU] = MT_INT_RX_DONE_WM,
+ 		[MT_RXQ_MCU_WA] = MT_INT_RX_DONE_WA,
+ 		[MT_RXQ_EXT_WA] = MT_INT_RX_DONE_WA_EXT,
+ 	};
++>>>>>>> 76027f40f5ee (mt76: mt7915: bring up the WA event rx queue for band1)
  
 -	mt7915_irq_enable(dev, rx_irq_mask[q]);
 +	mt7915_irq_enable(dev, MT_INT_RX_DONE(q));
  }
  
  /* TODO: support 2/4/6/8 MSI-X vectors */
@@@ -49,15 -56,21 +59,18 @@@ static irqreturn_t mt7915_irq_handler(i
  	if (intr & MT_INT_TX_DONE_MCU)
  		napi_schedule(&dev->mt76.tx_napi);
  
 -	if (intr & MT_INT_RX_DONE_DATA0)
 -		napi_schedule(&dev->mt76.napi[MT_RXQ_MAIN]);
 -
 -	if (intr & MT_INT_RX_DONE_DATA1)
 -		napi_schedule(&dev->mt76.napi[MT_RXQ_EXT]);
 +	if (intr & MT_INT_RX_DONE_DATA)
 +		napi_schedule(&dev->mt76.napi[0]);
  
  	if (intr & MT_INT_RX_DONE_WM)
 -		napi_schedule(&dev->mt76.napi[MT_RXQ_MCU]);
 +		napi_schedule(&dev->mt76.napi[1]);
  
  	if (intr & MT_INT_RX_DONE_WA)
 -		napi_schedule(&dev->mt76.napi[MT_RXQ_MCU_WA]);
 +		napi_schedule(&dev->mt76.napi[2]);
  
+ 	if (intr & MT_INT_RX_DONE_WA_EXT)
+ 		napi_schedule(&dev->mt76.napi[MT_RXQ_EXT_WA]);
+ 
  	if (intr & MT_INT_MCU_CMD) {
  		u32 val = mt76_rr(dev, MT_MCU_CMD);
  
diff --cc drivers/net/wireless/mediatek/mt76/mt7915/regs.h
index fded019fc897,77402eb13b9c..000000000000
--- a/drivers/net/wireless/mediatek/mt76/mt7915/regs.h
+++ b/drivers/net/wireless/mediatek/mt76/mt7915/regs.h
@@@ -339,11 -344,12 +339,16 @@@
  
  #define MT_INT_SOURCE_CSR		MT_WFDMA_EXT_CSR(0x10)
  #define MT_INT_MASK_CSR			MT_WFDMA_EXT_CSR(0x14)
 -#define MT_INT_RX_DONE_DATA0		BIT(16)
 -#define MT_INT_RX_DONE_DATA1		BIT(17)
 +#define MT_INT_RX_DONE_DATA		BIT(16)
  #define MT_INT_RX_DONE_WM		BIT(0)
  #define MT_INT_RX_DONE_WA		BIT(1)
++<<<<<<< HEAD
 +#define MT_INT_RX_DONE(_n)		((_n) ? BIT((_n) - 1) : BIT(16))
 +#define MT_INT_RX_DONE_ALL		(BIT(0) | BIT(1) | BIT(16))
++=======
+ #define MT_INT_RX_DONE_WA_EXT		BIT(2)
+ #define MT_INT_RX_DONE_ALL		(GENMASK(2, 0) | GENMASK(17, 16))
++>>>>>>> 76027f40f5ee (mt76: mt7915: bring up the WA event rx queue for band1)
  #define MT_INT_TX_DONE_MCU_WA		BIT(15)
  #define MT_INT_TX_DONE_FWDL		BIT(26)
  #define MT_INT_TX_DONE_MCU_WM		BIT(27)
* Unmerged path drivers/net/wireless/mediatek/mt76/mt76.h
* Unmerged path drivers/net/wireless/mediatek/mt76/mt7915/dma.c
diff --git a/drivers/net/wireless/mediatek/mt76/mt7915/mt7915.h b/drivers/net/wireless/mediatek/mt76/mt7915/mt7915.h
index 925c97e4a517..5d0fe6ae3f4e 100644
--- a/drivers/net/wireless/mediatek/mt76/mt7915/mt7915.h
+++ b/drivers/net/wireless/mediatek/mt76/mt7915/mt7915.h
@@ -61,6 +61,7 @@ enum mt7915_rxq_id {
 	MT7915_RXQ_BAND1,
 	MT7915_RXQ_MCU_WM = 0,
 	MT7915_RXQ_MCU_WA,
+	MT7915_RXQ_MCU_WA_EXT,
 };
 
 struct mt7915_sta_stats {
* Unmerged path drivers/net/wireless/mediatek/mt76/mt7915/pci.c
* Unmerged path drivers/net/wireless/mediatek/mt76/mt7915/regs.h
