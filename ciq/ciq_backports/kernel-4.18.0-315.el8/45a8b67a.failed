mt76: mt7915: fix eeprom DBDC band selection

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-315.el8
commit-author Felix Fietkau <nbd@nbd.name>
commit 45a8b67a355279f932807ac8740c0f080f065907
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-315.el8/45a8b67a.failed

When the EEPROM band fields contain default values, assign 2.4 GHz to the
first band and 5 GHz to the second.

	Signed-off-by: Felix Fietkau <nbd@nbd.name>
(cherry picked from commit 45a8b67a355279f932807ac8740c0f080f065907)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/wireless/mediatek/mt76/mt7915/eeprom.c
diff --cc drivers/net/wireless/mediatek/mt76/mt7915/eeprom.c
index d65910cc0709,660398ac53c2..000000000000
--- a/drivers/net/wireless/mediatek/mt76/mt7915/eeprom.c
+++ b/drivers/net/wireless/mediatek/mt76/mt7915/eeprom.c
@@@ -43,35 -46,57 +43,63 @@@ static int mt7915_check_eeprom(struct m
  	}
  }
  
++<<<<<<< HEAD
++=======
+ void mt7915_eeprom_parse_band_config(struct mt7915_phy *phy)
+ {
+ 	struct mt7915_dev *dev = phy->dev;
+ 	bool ext_phy = phy != &dev->phy;
+ 	u32 val;
+ 
+ 	val = mt7915_eeprom_read(dev, MT_EE_WIFI_CONF + ext_phy);
+ 	val = FIELD_GET(MT_EE_WIFI_CONF0_BAND_SEL, val);
+ 	if (val == MT_EE_BAND_SEL_DEFAULT && dev->dbdc_support)
+ 		val = ext_phy ? MT_EE_BAND_SEL_5GHZ : MT_EE_BAND_SEL_2GHZ;
+ 
+ 	switch (val) {
+ 	case MT_EE_BAND_SEL_5GHZ:
+ 		phy->mt76->cap.has_5ghz = true;
+ 		break;
+ 	case MT_EE_BAND_SEL_2GHZ:
+ 		phy->mt76->cap.has_2ghz = true;
+ 		break;
+ 	default:
+ 		phy->mt76->cap.has_2ghz = true;
+ 		phy->mt76->cap.has_5ghz = true;
+ 		break;
+ 	}
+ }
+ 
++>>>>>>> 45a8b67a3552 (mt76: mt7915: fix eeprom DBDC band selection)
  static void mt7915_eeprom_parse_hw_cap(struct mt7915_dev *dev)
  {
 -	u8 nss, nss_band, *eeprom = dev->mt76.eeprom.data;
 -
 -	mt7915_eeprom_parse_band_config(&dev->phy);
 -
 -	/* read tx mask from eeprom */
 -	nss = FIELD_GET(MT_EE_WIFI_CONF0_TX_PATH, eeprom[MT_EE_WIFI_CONF]);
 -	if (!nss || nss > 4)
 -		nss = 4;
 -
 -	nss_band = nss;
 -
 -	if (dev->dbdc_support) {
 -		nss_band = FIELD_GET(MT_EE_WIFI_CONF3_TX_PATH_B0,
 -				     eeprom[MT_EE_WIFI_CONF + 3]);
 -		if (!nss_band || nss_band > 2)
 -			nss_band = 2;
 +	u8 *eeprom = dev->mt76.eeprom.data;
 +	u8 tx_mask, max_nss = 4;
 +	u32 val = mt7915_eeprom_read(dev, MT_EE_WIFI_CONF);
  
 -		if (nss_band >= nss)
 -			nss = 4;
 +	val = FIELD_GET(MT_EE_WIFI_CONF_BAND_SEL, val);
 +	switch (val) {
 +	case MT_EE_5GHZ:
 +		dev->mphy.cap.has_5ghz = true;
 +		break;
 +	case MT_EE_2GHZ:
 +		dev->mphy.cap.has_2ghz = true;
 +		break;
 +	default:
 +		dev->mphy.cap.has_2ghz = true;
 +		dev->mphy.cap.has_5ghz = true;
 +		break;
  	}
  
 -	dev->chainmask = BIT(nss) - 1;
 -	dev->mphy.antenna_mask = BIT(nss_band) - 1;
 -	dev->mphy.chainmask = dev->mphy.antenna_mask;
 +	/* read tx mask from eeprom */
 +	tx_mask =  FIELD_GET(MT_EE_WIFI_CONF_TX_MASK,
 +			     eeprom[MT_EE_WIFI_CONF]);
 +	if (!tx_mask || tx_mask > max_nss)
 +		tx_mask = max_nss;
 +
 +	dev->chainmask = BIT(tx_mask) - 1;
 +	dev->mphy.antenna_mask = dev->chainmask;
 +	dev->phy.chainmask = dev->chainmask;
  }
  
  int mt7915_eeprom_init(struct mt7915_dev *dev)
* Unmerged path drivers/net/wireless/mediatek/mt76/mt7915/eeprom.c
diff --git a/drivers/net/wireless/mediatek/mt76/mt7915/eeprom.h b/drivers/net/wireless/mediatek/mt76/mt7915/eeprom.h
index 4e31d6ab4fa6..d0065ad6dadb 100644
--- a/drivers/net/wireless/mediatek/mt76/mt7915/eeprom.h
+++ b/drivers/net/wireless/mediatek/mt76/mt7915/eeprom.h
@@ -31,10 +31,10 @@ enum mt7915_eeprom_field {
 #define MT_EE_WIFI_CONF_TSSI1_5G		BIT(4)
 
 enum mt7915_eeprom_band {
-	MT_EE_DUAL_BAND,
-	MT_EE_5GHZ,
-	MT_EE_2GHZ,
-	MT_EE_DBDC,
+	MT_EE_BAND_SEL_DEFAULT,
+	MT_EE_BAND_SEL_5GHZ,
+	MT_EE_BAND_SEL_2GHZ,
+	MT_EE_BAND_SEL_DUAL,
 };
 
 #define SKU_DELTA_VAL		GENMASK(5, 0)
