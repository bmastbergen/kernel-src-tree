mt76: testmode: add support to set user-defined spe index

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-315.el8
commit-author Shayne Chen <shayne.chen@mediatek.com>
commit fdc9c18eb44dc3fb8f4f5ba4b2e387087ea642c7
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-315.el8/fdc9c18e.failed

Add spatial extension (spe) index as a configurable parameter in testmode.
This is used for specifically configuring TX path, such as different
WF TX priority, number of antennas and spatial streams.

If spe_idx is not set, TX path depends on tx_antenna_mask; otherwise,
both spe_idx and tx_antenna_mask are referenced to decide TX path.

	Signed-off-by: Shayne Chen <shayne.chen@mediatek.com>
	Signed-off-by: Felix Fietkau <nbd@nbd.name>
(cherry picked from commit fdc9c18eb44dc3fb8f4f5ba4b2e387087ea642c7)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/wireless/mediatek/mt76/mt7915/testmode.c
#	drivers/net/wireless/mediatek/mt76/testmode.c
diff --cc drivers/net/wireless/mediatek/mt76/mt7915/testmode.c
index fe56ab18e974,6ad1c3b49bfe..000000000000
--- a/drivers/net/wireless/mediatek/mt76/mt7915/testmode.c
+++ b/drivers/net/wireless/mediatek/mt76/mt7915/testmode.c
@@@ -201,23 -205,32 +201,46 @@@ mt7915_tm_set_tx_frames(struct mt7915_d
  {
  	static const u8 spe_idx_map[] = {0, 0, 1, 0, 3, 2, 4, 0,
  					 9, 8, 6, 10, 16, 12, 18, 0};
++<<<<<<< HEAD
 +	struct sk_buff *skb = dev->mt76.test.tx_skb;
++=======
+ 	struct mt76_testmode_data *td = &phy->mt76->test;
+ 	struct sk_buff *skb = phy->mt76->test.tx_skb;
+ 	struct mt7915_dev *dev = phy->dev;
++>>>>>>> fdc9c18eb44d (mt76: testmode: add support to set user-defined spe index)
  	struct ieee80211_tx_info *info;
  
 -	mt7915_tm_set_trx(phy, TM_MAC_RX_RXV, false);
 +	mt7915_tm_set_trx(dev, &dev->phy, TM_MAC_RX_RXV, false);
  
  	if (en) {
++<<<<<<< HEAD
 +		u8 tx_ant = dev->mt76.test.tx_antenna_mask;
 +
++=======
++>>>>>>> fdc9c18eb44d (mt76: testmode: add support to set user-defined spe index)
  		mutex_unlock(&dev->mt76.mutex);
 -		mt7915_set_channel(phy);
 +		mt7915_set_channel(&dev->phy);
  		mutex_lock(&dev->mt76.mutex);
  
++<<<<<<< HEAD
 +		mt7915_mcu_set_chan_info(&dev->phy, MCU_EXT_CMD_SET_RX_PATH);
 +		dev->test.spe_idx = spe_idx_map[tx_ant];
++=======
+ 		mt7915_mcu_set_chan_info(phy, MCU_EXT_CMD_SET_RX_PATH);
+ 
+ 		if (td->tx_spe_idx) {
+ 			phy->test.spe_idx = td->tx_spe_idx;
+ 		} else {
+ 			u8 tx_ant = td->tx_antenna_mask;
+ 
+ 			if (phy != &dev->phy)
+ 				tx_ant >>= 2;
+ 			phy->test.spe_idx = spe_idx_map[tx_ant];
+ 		}
++>>>>>>> fdc9c18eb44d (mt76: testmode: add support to set user-defined spe index)
  	}
  
 -	mt7915_tm_set_trx(phy, TM_MAC_TX, en);
 +	mt7915_tm_set_trx(dev, &dev->phy, TM_MAC_TX, en);
  
  	if (!en || !skb)
  		return;
diff --cc drivers/net/wireless/mediatek/mt76/testmode.c
index d1b171697e28,ad8edf137b36..000000000000
--- a/drivers/net/wireless/mediatek/mt76/testmode.c
+++ b/drivers/net/wireless/mediatek/mt76/testmode.c
@@@ -347,8 -358,9 +348,14 @@@ int mt76_testmode_cmd(struct ieee80211_
  	    mt76_tm_get_u8(tb[MT76_TM_ATTR_TX_RATE_LDPC], &td->tx_rate_ldpc, 0, 1) ||
  	    mt76_tm_get_u8(tb[MT76_TM_ATTR_TX_RATE_STBC], &td->tx_rate_stbc, 0, 1) ||
  	    mt76_tm_get_u8(tb[MT76_TM_ATTR_TX_LTF], &td->tx_ltf, 0, 2) ||
++<<<<<<< HEAD
 +	    mt76_tm_get_u8(tb[MT76_TM_ATTR_TX_ANTENNA], &td->tx_antenna_mask, 1,
 +			   phy->antenna_mask) ||
++=======
+ 	    mt76_tm_get_u8(tb[MT76_TM_ATTR_TX_ANTENNA], &td->tx_antenna_mask,
+ 			   1 << (ext_phy * 2), phy->antenna_mask << (ext_phy * 2)) ||
+ 	    mt76_tm_get_u8(tb[MT76_TM_ATTR_TX_SPE_IDX], &td->tx_spe_idx, 0, 27) ||
++>>>>>>> fdc9c18eb44d (mt76: testmode: add support to set user-defined spe index)
  	    mt76_tm_get_u8(tb[MT76_TM_ATTR_TX_POWER_CONTROL],
  			   &td->tx_power_control, 0, 1))
  		goto out;
diff --git a/drivers/net/wireless/mediatek/mt76/mt76.h b/drivers/net/wireless/mediatek/mt76/mt76.h
index b1381101ffac..47238544131a 100644
--- a/drivers/net/wireless/mediatek/mt76/mt76.h
+++ b/drivers/net/wireless/mediatek/mt76/mt76.h
@@ -535,6 +535,7 @@ struct mt76_testmode_data {
 	u8 tx_ltf;
 
 	u8 tx_antenna_mask;
+	u8 tx_spe_idx;
 
 	u32 freq_offset;
 
* Unmerged path drivers/net/wireless/mediatek/mt76/mt7915/testmode.c
* Unmerged path drivers/net/wireless/mediatek/mt76/testmode.c
diff --git a/drivers/net/wireless/mediatek/mt76/testmode.h b/drivers/net/wireless/mediatek/mt76/testmode.h
index 7efad685a17c..45f0047ea7f1 100644
--- a/drivers/net/wireless/mediatek/mt76/testmode.h
+++ b/drivers/net/wireless/mediatek/mt76/testmode.h
@@ -35,6 +35,8 @@
  * @MT76_TM_ATTR_FREQ_OFFSET: RF frequency offset (u32)
  *
  * @MT76_TM_ATTR_STATS: statistics (nested, see &enum mt76_testmode_stats_attr)
+ *
+ * @MT76_TM_ATTR_TX_SPE_IDX: tx spatial extension index (u8)
  */
 enum mt76_testmode_attr {
 	MT76_TM_ATTR_UNSPEC,
@@ -63,6 +65,8 @@ enum mt76_testmode_attr {
 
 	MT76_TM_ATTR_STATS,
 
+	MT76_TM_ATTR_TX_SPE_IDX,
+
 	/* keep last */
 	NUM_MT76_TM_ATTRS,
 	MT76_TM_ATTR_MAX = NUM_MT76_TM_ATTRS - 1,
