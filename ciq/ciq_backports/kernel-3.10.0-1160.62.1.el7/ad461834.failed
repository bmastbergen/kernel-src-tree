fs: factor out common code in fget_light() and fget_raw_light()

jira LE-1907
cve CVE-2021-4083
Rebuild_History Non-Buildable kernel-3.10.0-1160.62.1.el7
commit-author Oleg Nesterov <oleg@redhat.com>
commit ad46183445043b562856c60b74db664668fb364b
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1160.62.1.el7/ad461834.failed

Apart from FMODE_PATH check fget_light() and fget_raw_light() are
identical, shift the code into the new helper, __fget_light(fd, mask).
Saves 208 bytes.

	Signed-off-by: Oleg Nesterov <oleg@redhat.com>
	Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
(cherry picked from commit ad46183445043b562856c60b74db664668fb364b)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/file.c
diff --cc fs/file.c
index 44bd634b636a,50c1208f6450..000000000000
--- a/fs/file.c
+++ b/fs/file.c
@@@ -779,8 -690,8 +779,13 @@@ struct file *__fget_light(unsigned int 
  
  	*fput_needed = 0;
  	if (atomic_read(&files->count) == 1) {
++<<<<<<< HEAD
 +		file = fcheck_files(files, fd);
 +		if (file && (file->f_mode & FMODE_PATH))
++=======
+ 		file = __fcheck_files(files, fd);
+ 		if (file && (file->f_mode & mask))
++>>>>>>> ad4618344504 (fs: factor out common code in fget_light() and fget_raw_light())
  			file = NULL;
  	} else {
  		rcu_read_lock();
@@@ -802,26 -717,7 +811,30 @@@ EXPORT_SYMBOL(fget_light)
  
  struct file *fget_raw_light(unsigned int fd, int *fput_needed)
  {
++<<<<<<< HEAD
 +	struct file *file;
 +	struct files_struct *files = current->files;
 +
 +	*fput_needed = 0;
 +	if (atomic_read(&files->count) == 1) {
 +		file = fcheck_files(files, fd);
 +	} else {
 +		rcu_read_lock();
 +		file = fcheck_files(files, fd);
 +		if (file) {
 +			if (atomic_long_inc_not_zero(&file->f_count))
 +				*fput_needed = 1;
 +			else
 +				/* Didn't get the reference, someone's freed */
 +				file = NULL;
 +		}
 +		rcu_read_unlock();
 +	}
 +
 +	return file;
++=======
+ 	return __fget_light(fd, 0, fput_needed);
++>>>>>>> ad4618344504 (fs: factor out common code in fget_light() and fget_raw_light())
  }
  
  void set_close_on_exec(unsigned int fd, int flag)
* Unmerged path fs/file.c
