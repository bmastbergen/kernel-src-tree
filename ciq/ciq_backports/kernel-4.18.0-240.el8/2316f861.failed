perf annotate: Simplify disasm_line allocation and freeing code

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Ravi Bangoria <ravi.bangoria@linux.ibm.com>
commit 2316f861ae9ca640708f9529ae40a6f0bd7ae048
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/2316f861.failed

We are allocating disasm_line object in annotation_line__new() instead
of disasm_line__new(). Similarly annotation_line__delete() is actually
freeing disasm_line object as well. This complexity is because of
privsize.  But we don't need privsize anymore so get rid of privsize and
simplify disasm_line allocation and freeing code.

	Signed-off-by: Ravi Bangoria <ravi.bangoria@linux.ibm.com>
	Acked-by: Jiri Olsa <jolsa@redhat.com>
	Cc: Ian Rogers <irogers@google.com>
	Cc: Jin Yao <yao.jin@linux.intel.com>
	Cc: Namhyung Kim <namhyung@kernel.org>
	Cc: Song Liu <songliubraving@fb.com>
Link: http://lore.kernel.org/lkml/20200204045233.474937-3-ravi.bangoria@linux.ibm.com
	Signed-off-by: Arnaldo Carvalho de Melo <acme@redhat.com>
(cherry picked from commit 2316f861ae9ca640708f9529ae40a6f0bd7ae048)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/perf/util/annotate.c
diff --cc tools/perf/util/annotate.c
index b06815227267,f11031a40290..000000000000
--- a/tools/perf/util/annotate.c
+++ b/tools/perf/util/annotate.c
@@@ -1140,60 -1143,36 +1140,59 @@@ out
  }
  
  struct annotate_args {
- 	size_t			 privsize;
  	struct arch		*arch;
  	struct map_symbol	 ms;
 -	struct evsel	*evsel;
 +	struct perf_evsel	*evsel;
  	struct annotation_options *options;
  	s64			 offset;
  	char			*line;
  	int			 line_nr;
  };
  
- static void annotation_line__delete(struct annotation_line *al)
+ static void annotation_line__init(struct annotation_line *al,
+ 				  struct annotate_args *args,
+ 				  int nr)
  {
- 	void *ptr = (void *) al - al->privsize;
+ 	al->offset = args->offset;
+ 	al->line = strdup(args->line);
+ 	al->line_nr = args->line_nr;
+ 	al->data_nr = nr;
+ }
  
+ static void annotation_line__exit(struct annotation_line *al)
+ {
  	free_srcline(al->path);
  	zfree(&al->line);
- 	free(ptr);
  }
  
- /*
-  * Allocating the annotation line data with following
-  * structure:
-  *
-  *    --------------------------------------
-  *    private space | struct annotation_line
-  *    --------------------------------------
-  *
-  * Size of the private space is stored in 'struct annotation_line'.
-  *
-  */
- static struct annotation_line *
- annotation_line__new(struct annotate_args *args, size_t privsize)
+ static size_t disasm_line_size(int nr)
  {
  	struct annotation_line *al;
++<<<<<<< HEAD
 +	struct perf_evsel *evsel = args->evsel;
 +	size_t size = privsize + sizeof(*al);
 +	int nr = 1;
 +
 +	if (perf_evsel__is_group_event(evsel))
 +		nr = evsel->nr_members;
 +
 +	size += sizeof(al->data[0]) * nr;
 +
 +	al = zalloc(size);
 +	if (al) {
 +		al = (void *) al + privsize;
 +		al->privsize   = privsize;
 +		al->offset     = args->offset;
 +		al->line       = strdup(args->line);
 +		al->line_nr    = args->line_nr;
 +		al->data_nr    = nr;
 +	}
 +
 +	return al;
++=======
+ 
+ 	return (sizeof(struct disasm_line) + (sizeof(al->data[0]) * nr));
++>>>>>>> 2316f861ae9c (perf annotate: Simplify disasm_line allocation and freeing code)
  }
  
  /*
@@@ -2141,14 -2127,12 +2142,17 @@@ void symbol__calc_percent(struct symbo
  	annotation__calc_percent(notes, evsel, symbol__size(sym));
  }
  
 -int symbol__annotate(struct map_symbol *ms, struct evsel *evsel,
 -		     struct annotation_options *options, struct arch **parch)
 +int symbol__annotate(struct symbol *sym, struct map *map,
 +		     struct perf_evsel *evsel, size_t privsize,
 +		     struct annotation_options *options,
 +		     struct arch **parch)
  {
++<<<<<<< HEAD
++=======
+ 	struct symbol *sym = ms->sym;
++>>>>>>> 2316f861ae9c (perf annotate: Simplify disasm_line allocation and freeing code)
  	struct annotation *notes = symbol__annotation(sym);
  	struct annotate_args args = {
- 		.privsize	= privsize,
  		.evsel		= evsel,
  		.options	= options,
  	};
* Unmerged path tools/perf/util/annotate.c
diff --git a/tools/perf/util/annotate.h b/tools/perf/util/annotate.h
index db50eb66a9f3..dc63678d2c0f 100644
--- a/tools/perf/util/annotate.h
+++ b/tools/perf/util/annotate.h
@@ -137,7 +137,6 @@ struct annotation_line {
 	u64			 cycles;
 	u64			 cycles_max;
 	u64			 cycles_min;
-	size_t			 privsize;
 	char			*path;
 	u32			 idx;
 	int			 idx_asm;
