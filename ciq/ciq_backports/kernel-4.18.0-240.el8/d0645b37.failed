net/mlx5e: Fix rejecting all egress rules not on vlan

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Roi Dayan <roid@mellanox.com>
commit d0645b3780954b7133d9a908009d166ae686bd2a
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/d0645b37.failed

The original condition rejected all egress rules that
are not on tunnel device.
Also, the whole point of this egress reject was to disallow bad
rules because of egdev which doesn't exists today, so remove
this check entirely.

Fixes: 0a7fcb78cc21 ("net/mlx5e: Support inner header rewrite with goto action")
	Signed-off-by: Roi Dayan <roid@mellanox.com>
	Reviewed-by: Oz Shlomo <ozsh@mellanox.com>
	Reviewed-by: Vlad Buslov <vladbu@mellanox.com>
	Signed-off-by: Saeed Mahameed <saeedm@mellanox.com>
(cherry picked from commit d0645b3780954b7133d9a908009d166ae686bd2a)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlx5/core/en_tc.c
diff --cc drivers/net/ethernet/mellanox/mlx5/core/en_tc.c
index 2e22a8de6513,db1aee1d48e3..000000000000
--- a/drivers/net/ethernet/mellanox/mlx5/core/en_tc.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/en_tc.c
@@@ -2662,29 -3044,25 +2662,36 @@@ static bool actions_match_supported(str
  				    struct mlx5e_tc_flow *flow,
  				    struct netlink_ext_ack *extack)
  {
++<<<<<<< HEAD
 +	struct net_device *filter_dev = parse_attr->filter_dev;
 +	bool drop_action, decap_action, pop_action;
++=======
+ 	bool ct_flow;
++>>>>>>> d0645b378095 (net/mlx5e: Fix rejecting all egress rules not on vlan)
  	u32 actions;
  
 -	ct_flow = flow_flag_test(flow, CT);
 -	if (mlx5e_is_eswitch_flow(flow)) {
 +	if (mlx5e_is_eswitch_flow(flow))
  		actions = flow->esw_attr->action;
 -
 -		if (flow->esw_attr->split_count && ct_flow) {
 -			/* All registers used by ct are cleared when using
 -			 * split rules.
 -			 */
 -			NL_SET_ERR_MSG_MOD(extack,
 -					   "Can't offload mirroring with action ct");
 -			return -EOPNOTSUPP;
 -		}
 -	} else {
 +	else
  		actions = flow->nic_attr->action;
 +
++<<<<<<< HEAD
 +	drop_action = actions & MLX5_FLOW_CONTEXT_ACTION_DROP;
 +	decap_action = actions & MLX5_FLOW_CONTEXT_ACTION_DECAP;
 +	pop_action = actions & MLX5_FLOW_CONTEXT_ACTION_VLAN_POP;
 +
 +	if (flow_flag_test(flow, EGRESS) && !drop_action) {
 +		/* If no drop, we must decap (vxlan) or pop (vlan) */
 +		if (mlx5e_get_tc_tun(filter_dev) && !decap_action)
 +			return false;
 +		else if (is_vlan_dev(filter_dev) && !pop_action)
 +			return false;
 +		else
 +			return false; /* Sanity */
  	}
  
++=======
++>>>>>>> d0645b378095 (net/mlx5e: Fix rejecting all egress rules not on vlan)
  	if (actions & MLX5_FLOW_CONTEXT_ACTION_MOD_HDR)
  		return modify_header_match_supported(&parse_attr->spec,
  						     flow_action, actions,
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/en_tc.c
