timers: Expand clk forward logic beyond nohz

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Frederic Weisbecker <frederic@kernel.org>
commit 1f8a4212dc83f8353843fabf6465fd918372fbbf
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/1f8a4212.failed

As for next_expiry, the base->clk catch up logic will be expanded beyond
NOHZ in order to avoid triggering useless softirqs.

If softirqs should only fire to expire pending timers, periodic base->clk
increments must be skippable for random amounts of time.  Therefore prepare
to catch-up with missing updates whenever an up-to-date base clock is
needed.

	Signed-off-by: Frederic Weisbecker <frederic@kernel.org>
	Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
	Tested-by: Juri Lelli <juri.lelli@redhat.com>
Link: https://lkml.kernel.org/r/20200717140551.29076-10-frederic@kernel.org

(cherry picked from commit 1f8a4212dc83f8353843fabf6465fd918372fbbf)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	kernel/time/timer.c
diff --cc kernel/time/timer.c
index 3dc552b0a9f1,1be92b53b75f..000000000000
--- a/kernel/time/timer.c
+++ b/kernel/time/timer.c
@@@ -904,11 -901,13 +897,15 @@@ static inline void forward_timer_base(s
  	 * If the next expiry value is > jiffies, then we fast forward to
  	 * jiffies otherwise we forward to the next expiry value.
  	 */
 -	if (time_after(base->next_expiry, jnow)) {
 +	if (time_after(base->next_expiry, jnow))
  		base->clk = jnow;
 -	} else {
 -		if (WARN_ON_ONCE(time_before(base->next_expiry, base->clk)))
 -			return;
 +	else
  		base->clk = base->next_expiry;
++<<<<<<< HEAD
 +#endif
++=======
+ 	}
++>>>>>>> 1f8a4212dc83 (timers: Expand clk forward logic beyond nohz)
  }
  
  
@@@ -1703,8 -1772,9 +1689,12 @@@ static inline void __run_timers(struct 
  		while (levels--)
  			expire_timers(base, heads + levels);
  	}
++<<<<<<< HEAD
 +	base->running_timer = NULL;
++=======
+ 	base->must_forward_clk = true;
++>>>>>>> 1f8a4212dc83 (timers: Expand clk forward logic beyond nohz)
  	raw_spin_unlock_irq(&base->lock);
 -	timer_base_unlock_expiry(base);
  }
  
  /*
* Unmerged path kernel/time/timer.c
