x86/Hyper-V: Report crash register data when sysctl_record_panic_msg is not set

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Tianyu Lan <Tianyu.Lan@microsoft.com>
commit 040026df7088c56ccbad28f7042308f67bde63df
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/040026df.failed

When sysctl_record_panic_msg is not set, the panic will
not be reported to Hyper-V via hyperv_report_panic_msg().
So the crash should be reported via hyperv_report_panic().

Fixes: 81b18bce48af ("Drivers: HV: Send one page worth of kmsg dump over Hyper-V during panic")
	Reviewed-by: Michael Kelley <mikelley@microsoft.com>
	Signed-off-by: Tianyu Lan <Tianyu.Lan@microsoft.com>
Link: https://lore.kernel.org/r/20200406155331.2105-6-Tianyu.Lan@microsoft.com
	Signed-off-by: Wei Liu <wei.liu@kernel.org>
(cherry picked from commit 040026df7088c56ccbad28f7042308f67bde63df)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/hv/vmbus_drv.c
diff --cc drivers/hv/vmbus_drv.c
index 12bce1b87223,172ceae69abb..000000000000
--- a/drivers/hv/vmbus_drv.c
+++ b/drivers/hv/vmbus_drv.c
@@@ -63,9 -65,18 +75,22 @@@ static int hyperv_panic_event(struct no
  {
  	struct pt_regs *regs;
  
 -	vmbus_initiate_unload(true);
 +	regs = current_pt_regs();
  
++<<<<<<< HEAD
 +	hyperv_report_panic(regs, val);
++=======
+ 	/*
+ 	 * Hyper-V should be notified only once about a panic.  If we will be
+ 	 * doing hyperv_report_panic_msg() later with kmsg data, don't do
+ 	 * the notification here.
+ 	 */
+ 	if (ms_hyperv.misc_features & HV_FEATURE_GUEST_CRASH_MSR_AVAILABLE
+ 	    && hyperv_report_reg()) {
+ 		regs = current_pt_regs();
+ 		hyperv_report_panic(regs, val);
+ 	}
++>>>>>>> 040026df7088 (x86/Hyper-V: Report crash register data when sysctl_record_panic_msg is not set)
  	return NOTIFY_DONE;
  }
  
@@@ -75,7 -86,13 +100,17 @@@ static int hyperv_die_event(struct noti
  	struct die_args *die = (struct die_args *)args;
  	struct pt_regs *regs = die->regs;
  
++<<<<<<< HEAD
 +	hyperv_report_panic(regs, val);
++=======
+ 	/*
+ 	 * Hyper-V should be notified only once about a panic.  If we will be
+ 	 * doing hyperv_report_panic_msg() later with kmsg data, don't do
+ 	 * the notification here.
+ 	 */
+ 	if (hyperv_report_reg())
+ 		hyperv_report_panic(regs, val);
++>>>>>>> 040026df7088 (x86/Hyper-V: Report crash register data when sysctl_record_panic_msg is not set)
  	return NOTIFY_DONE;
  }
  
* Unmerged path drivers/hv/vmbus_drv.c
