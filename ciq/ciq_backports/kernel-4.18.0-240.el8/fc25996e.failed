mlxsw: spectrum_router: Increase scale of IPv6 nexthop groups

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Ido Schimmel <idosch@mellanox.com>
commit fc25996e6f46ac05378f45691d9c6ea08c2037b9
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/fc25996e.failed

Unlike IPv4, the kernel does not consolidate IPv6 nexthop groups. To
avoid exhausting the device's adjacency table - where nexthops are
stored - the driver does this consolidation instead.

Each nexthop group is hashed by XOR-ing the interface indexes of all the
member nexthop devices. However, the ifindex itself is not hashed, which
can result in identical keys used for different groups and finally an
-EBUSY error from rhashtable due to too long objects list.

Improve the situation by hashing the ifindex itself.

	Signed-off-by: Ido Schimmel <idosch@mellanox.com>
	Acked-by: Jiri Pirko <jiri@mellanox.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit fc25996e6f46ac05378f45691d9c6ea08c2037b9)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlxsw/spectrum_router.c
diff --cc drivers/net/ethernet/mellanox/mlxsw/spectrum_router.c
index 575ab41fc96b,a330b369e899..000000000000
--- a/drivers/net/ethernet/mellanox/mlxsw/spectrum_router.c
+++ b/drivers/net/ethernet/mellanox/mlxsw/spectrum_router.c
@@@ -2958,8 -2960,8 +2958,13 @@@ mlxsw_sp_nexthop6_group_hash(struct mlx
  	struct net_device *dev;
  
  	list_for_each_entry(mlxsw_sp_rt6, &fib6_entry->rt6_list, list) {
++<<<<<<< HEAD
 +		dev = mlxsw_sp_rt6->rt->fib6_nh.nh_dev;
 +		val ^= dev->ifindex;
++=======
+ 		dev = mlxsw_sp_rt6->rt->fib6_nh->fib_nh_dev;
+ 		val ^= jhash(&dev->ifindex, sizeof(dev->ifindex), seed);
++>>>>>>> fc25996e6f46 (mlxsw: spectrum_router: Increase scale of IPv6 nexthop groups)
  	}
  
  	return jhash(&val, sizeof(val), seed);
* Unmerged path drivers/net/ethernet/mellanox/mlxsw/spectrum_router.c
