gfs2: Fix use-after-free in gfs2_logd after withdraw

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Bob Peterson <rpeterso@redhat.com>
commit d22f69a08dcb0f469170cda1976d5938cb0e5dcf
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/d22f69a0.failed

When the gfs2_logd daemon withdrew, the withdraw sequence called
into make_fs_ro() to make the file system read-only. That caused the
journal descriptors to be freed. However, those journal descriptors
were used by gfs2_logd's call to gfs2_ail_flush_reqd(). This caused
a use-after free and NULL pointer dereference.

This patch changes function gfs2_logd() so that it stops all logd
work until the thread is told to stop. Once a withdraw is done,
it only does an interruptible sleep.

	Signed-off-by: Bob Peterson <rpeterso@redhat.com>
	Signed-off-by: Andreas Gruenbacher <agruenba@redhat.com>
(cherry picked from commit d22f69a08dcb0f469170cda1976d5938cb0e5dcf)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/gfs2/log.c
diff --cc fs/gfs2/log.c
index 5a2ff16daaae,cf0b80c78c82..000000000000
--- a/fs/gfs2/log.c
+++ b/fs/gfs2/log.c
@@@ -1004,13 -1131,19 +1004,27 @@@ int gfs2_logd(void *data
  
  	while (!kthread_should_stop()) {
  
+ 		if (gfs2_withdrawn(sdp)) {
+ 			msleep_interruptible(HZ);
+ 			continue;
+ 		}
  		/* Check for errors writing to the journal */
  		if (sdp->sd_log_error) {
++<<<<<<< HEAD
 +			gfs2_lm_withdraw(sdp,
 +					 "GFS2: fsid=%s: error %d: "
 +					 "withdrawing the file system to "
 +					 "prevent further damage.\n",
 +					 sdp->sd_fsname, sdp->sd_log_error);
++=======
+ 			gfs2_lm(sdp,
+ 				"GFS2: fsid=%s: error %d: "
+ 				"withdrawing the file system to "
+ 				"prevent further damage.\n",
+ 				sdp->sd_fsname, sdp->sd_log_error);
+ 			gfs2_withdraw(sdp);
+ 			continue;
++>>>>>>> d22f69a08dcb (gfs2: Fix use-after-free in gfs2_logd after withdraw)
  		}
  
  		did_flush = false;
* Unmerged path fs/gfs2/log.c
