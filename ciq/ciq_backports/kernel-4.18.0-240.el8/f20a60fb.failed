drm/i915: split i915_driver_modeset_remove() to pre/post irq uninstall

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Jani Nikula <jani.nikula@intel.com>
commit f20a60fb7aef3f5aecee4a9c30e36ee3e518fa16
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/f20a60fb.failed

Push irq uninstall further up, by splitting i915_driver_modeset_remove()
to two, the part with working irqs before irq uninstall, and the part
after irq uninstall. No functional changes.

	Cc: Ville Syrj채l채 <ville.syrjala@linux.intel.com>
	Reviewed-by: Ville Syrj채l채 <ville.syrjala@linux.intel.com>
	Signed-off-by: Jani Nikula <jani.nikula@intel.com>
Link: https://patchwork.freedesktop.org/patch/msgid/20200214135058.7580-2-jani.nikula@intel.com
(cherry picked from commit f20a60fb7aef3f5aecee4a9c30e36ee3e518fa16)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/gpu/drm/i915/i915_drv.c
diff --cc drivers/gpu/drm/i915/i915_drv.c
index 1aa474313525,4dd8294b68e1..000000000000
--- a/drivers/gpu/drm/i915/i915_drv.c
+++ b/drivers/gpu/drm/i915/i915_drv.c
@@@ -769,29 -285,22 +769,42 @@@ out
  	return ret;
  }
  
++<<<<<<< HEAD
 +static int i915_kick_out_firmware_fb(struct drm_i915_private *dev_priv)
 +{
 +	struct apertures_struct *ap;
 +	struct pci_dev *pdev = dev_priv->drm.pdev;
 +	struct i915_ggtt *ggtt = &dev_priv->ggtt;
 +	bool primary;
 +	int ret;
 +
 +	ap = alloc_apertures(1);
 +	if (!ap)
 +		return -ENOMEM;
 +
 +	ap->ranges[0].base = ggtt->gmadr.start;
 +	ap->ranges[0].size = ggtt->mappable_end;
++=======
+ /* part #1: call before irq uninstall */
+ static void i915_driver_modeset_remove(struct drm_i915_private *i915)
+ {
+ 	intel_modeset_driver_remove(i915);
+ }
+ 
+ /* part #2: call after irq uninstall */
+ static void i915_driver_modeset_remove_noirq(struct drm_i915_private *i915)
+ {
+ 	intel_modeset_driver_remove_noirq(i915);
++>>>>>>> f20a60fb7aef (drm/i915: split i915_driver_modeset_remove() to pre/post irq uninstall)
  
 -	intel_bios_driver_remove(i915);
 +	primary =
 +		pdev->resource[PCI_ROM_RESOURCE].flags & IORESOURCE_ROM_SHADOW;
  
 -	intel_vga_unregister(i915);
 +	ret = drm_fb_helper_remove_conflicting_framebuffers(ap, "inteldrmfb", primary);
  
 -	intel_csr_ucode_fini(i915);
 +	kfree(ap);
 +
 +	return ret;
  }
  
  static void intel_init_dpio(struct drm_i915_private *dev_priv)
@@@ -1962,32 -1504,26 +1975,41 @@@ void i915_driver_unload(struct drm_devi
  	/* Flush any external code that still may be under the RCU lock */
  	synchronize_rcu();
  
 -	i915_gem_suspend(i915);
 +	i915_gem_suspend(dev_priv);
  
 -	drm_atomic_helper_shutdown(&i915->drm);
 +	drm_atomic_helper_shutdown(dev);
  
 -	intel_gvt_driver_remove(i915);
 +	intel_gvt_cleanup(dev_priv);
  
 -	i915_driver_modeset_remove(i915);
 +	intel_modeset_cleanup(dev);
  
++<<<<<<< HEAD
 +	intel_bios_cleanup(dev_priv);
++=======
+ 	intel_irq_uninstall(i915);
+ 
+ 	i915_driver_modeset_remove_noirq(i915);
+ 
+ 	i915_reset_error_state(i915);
+ 	i915_gem_driver_remove(i915);
++>>>>>>> f20a60fb7aef (drm/i915: split i915_driver_modeset_remove() to pre/post irq uninstall)
  
 -	intel_power_domains_driver_remove(i915);
 +	vga_switcheroo_unregister_client(pdev);
 +	vga_client_register(pdev, NULL, NULL, NULL);
  
 -	i915_driver_hw_remove(i915);
 +	intel_csr_ucode_fini(dev_priv);
  
 -	enable_rpm_wakeref_asserts(&i915->runtime_pm);
 +	/* Free error state after interrupts are fully disabled. */
 +	cancel_delayed_work_sync(&dev_priv->gpu_error.hangcheck_work);
 +	i915_reset_error_state(dev_priv);
 +
 +	i915_gem_fini_hw(dev_priv);
 +
 +	intel_power_domains_fini_hw(dev_priv);
 +
 +	i915_driver_cleanup_hw(dev_priv);
 +
 +	enable_rpm_wakeref_asserts(&dev_priv->runtime_pm);
  }
  
  static void i915_driver_release(struct drm_device *dev)
* Unmerged path drivers/gpu/drm/i915/i915_drv.c
