net/tls: move tls_build_proto() on init path

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
Rebuild_CHGLOG: - [net] tls: move tls_build_proto() on init path (Sabrina Dubroca) [1819627]
Rebuild_FUZZ: 95.24%
commit-author Jakub Kicinski <jakub.kicinski@netronome.com>
commit 16bed0e6ac07b1a0b3e9c33ec5e892bc7074a627
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/16bed0e6.failed

Move tls_build_proto() so that TOE offload doesn't have to call it
mid way through its bypass enable path.

	Signed-off-by: Jakub Kicinski <jakub.kicinski@netronome.com>
	Reviewed-by: John Hurley <john.hurley@netronome.com>
	Reviewed-by: Simon Horman <simon.horman@netronome.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 16bed0e6ac07b1a0b3e9c33ec5e892bc7074a627)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/tls/tls_main.c
diff --cc net/tls/tls_main.c
index f7a147ae7fd3,7bc2ad26316f..000000000000
--- a/net/tls/tls_main.c
+++ b/net/tls/tls_main.c
@@@ -672,21 -668,11 +672,27 @@@ static int tls_hw_prot(struct sock *sk
  			if (!ctx)
  				goto out;
  
++<<<<<<< HEAD
 +#if 0
 +			spin_unlock_bh(&device_spinlock);
 +#endif
 +			tls_build_proto(sk);
 +			ctx->hash = sk->sk_prot->hash;
 +			ctx->unhash = sk->sk_prot->unhash;
 +			ctx->sk_proto_close = sk->sk_prot->close;
++=======
++>>>>>>> 16bed0e6ac07 (net/tls: move tls_build_proto() on init path)
  			ctx->sk_destruct = sk->sk_destruct;
  			sk->sk_destruct = tls_hw_sk_destruct;
  			ctx->rx_conf = TLS_HW_RECORD;
  			ctx->tx_conf = TLS_HW_RECORD;
  			update_sk_prot(sk, ctx);
++<<<<<<< HEAD
 +#if 0
 +			spin_lock_bh(&device_spinlock);
 +#endif
++=======
++>>>>>>> 16bed0e6ac07 (net/tls: move tls_build_proto() on init path)
  			rc = 1;
  			break;
  		}
@@@ -787,10 -785,8 +795,8 @@@ static int tls_init(struct sock *sk
  	 * share the ulp context.
  	 */
  	if (sk->sk_state != TCP_ESTABLISHED)
 -		return -ENOTSUPP;
 +		return -ENOTCONN;
  
- 	tls_build_proto(sk);
- 
  	/* allocate tls context */
  	write_lock_bh(&sk->sk_callback_lock);
  	ctx = create_ctx(sk);
* Unmerged path net/tls/tls_main.c
