s390/qeth: consolidate QDIO queue setup

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Julian Wiedmann <jwi@linux.ibm.com>
commit aa3ad3920301f2cf6d406209b14acde0c50f2323
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/aa3ad392.failed

Move some duplicated logic into a shared code path.

	Signed-off-by: Julian Wiedmann <jwi@linux.ibm.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit aa3ad3920301f2cf6d406209b14acde0c50f2323)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/s390/net/qeth_core_main.c
#	drivers/s390/net/qeth_l2_main.c
diff --cc drivers/s390/net/qeth_core_main.c
index 518e88e8e9bc,52e5f086444b..000000000000
--- a/drivers/s390/net/qeth_core_main.c
+++ b/drivers/s390/net/qeth_core_main.c
@@@ -5030,6 -5016,21 +5029,24 @@@ retriable
  		if (rc)
  			QETH_CARD_TEXT_(card, 2, "8err%d", rc);
  	}
++<<<<<<< HEAD
++=======
+ 
+ 	if (!qeth_is_diagass_supported(card, QETH_DIAGS_CMD_TRAP) ||
+ 	    (card->info.hwtrap && qeth_hw_trap(card, QETH_DIAGS_TRAP_ARM)))
+ 		card->info.hwtrap = 0;
+ 
+ 	rc = qeth_set_access_ctrl_online(card, 0);
+ 	if (rc)
+ 		goto out;
+ 
+ 	rc = qeth_init_qdio_queues(card);
+ 	if (rc) {
+ 		QETH_CARD_TEXT_(card, 2, "9err%d", rc);
+ 		goto out;
+ 	}
+ 
++>>>>>>> aa3ad3920301 (s390/qeth: consolidate QDIO queue setup)
  	return 0;
  out:
  	dev_warn(&card->gdev->dev, "The qeth device driver failed to recover "
diff --cc drivers/s390/net/qeth_l2_main.c
index 62b151e612ef,5d9bb0597465..000000000000
--- a/drivers/s390/net/qeth_l2_main.c
+++ b/drivers/s390/net/qeth_l2_main.c
@@@ -824,18 -787,6 +824,21 @@@ static int qeth_l2_set_online(struct cc
  	/* softsetup */
  	QETH_CARD_TEXT(card, 2, "softsetp");
  
++<<<<<<< HEAD
 +	if (IS_OSD(card) || IS_OSX(card)) {
 +		rc = qeth_l2_start_ipassists(card);
 +		if (rc)
 +			goto out_remove;
 +	}
 +
 +	rc = qeth_init_qdio_queues(card);
 +	if (rc) {
 +		QETH_CARD_TEXT_(card, 2, "6err%d", rc);
 +		rc = -ENODEV;
 +		goto out_remove;
 +	}
++=======
++>>>>>>> aa3ad3920301 (s390/qeth: consolidate QDIO queue setup)
  	card->state = CARD_STATE_SOFTSETUP;
  
  	qeth_set_allowed_threads(card, 0xffffffff, 0);
diff --git a/drivers/s390/net/qeth_core.h b/drivers/s390/net/qeth_core.h
index 871d44746f5c..666e7a7e119a 100644
--- a/drivers/s390/net/qeth_core.h
+++ b/drivers/s390/net/qeth_core.h
@@ -1042,7 +1042,6 @@ int qeth_core_hardsetup_card(struct qeth_card *card, bool *carrier_ok);
 int qeth_stop_channel(struct qeth_channel *channel);
 
 void qeth_print_status_message(struct qeth_card *);
-int qeth_init_qdio_queues(struct qeth_card *);
 int qeth_send_ipa_cmd(struct qeth_card *, struct qeth_cmd_buffer *,
 		  int (*reply_cb)
 		  (struct qeth_card *, struct qeth_reply *, unsigned long),
* Unmerged path drivers/s390/net/qeth_core_main.c
* Unmerged path drivers/s390/net/qeth_l2_main.c
diff --git a/drivers/s390/net/qeth_l3_main.c b/drivers/s390/net/qeth_l3_main.c
index 935fc014dd72..60b1fc2e393e 100644
--- a/drivers/s390/net/qeth_l3_main.c
+++ b/drivers/s390/net/qeth_l3_main.c
@@ -1310,11 +1310,11 @@ static void qeth_l3_stop_card(struct qeth_card *card)
 	}
 	if (card->state == CARD_STATE_HARDSETUP) {
 		qeth_drain_output_queues(card);
-		qeth_clear_working_pool_list(card);
 		card->state = CARD_STATE_DOWN;
 	}
 
 	qeth_qdio_clear_card(card, 0);
+	qeth_clear_working_pool_list(card);
 	flush_workqueue(card->event_wq);
 	card->info.promisc_mode = 0;
 }
@@ -2232,12 +2232,6 @@ static int qeth_l3_set_online(struct ccwgroup_device *gdev)
 			QETH_CARD_TEXT_(card, 2, "5err%04x", rc);
 	}
 
-	rc = qeth_init_qdio_queues(card);
-	if (rc) {
-		QETH_CARD_TEXT_(card, 2, "6err%d", rc);
-		rc = -ENODEV;
-		goto out_remove;
-	}
 	card->state = CARD_STATE_SOFTSETUP;
 
 	qeth_set_allowed_threads(card, 0xffffffff, 0);
