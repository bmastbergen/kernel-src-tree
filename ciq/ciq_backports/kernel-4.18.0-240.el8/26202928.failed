block: Limit zone array allocation size

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Damien Le Moal <damien.lemoal@wdc.com>
commit 26202928fafad8bda8b478edb7e62c885be623d7
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/26202928.failed

Limit the size of the struct blk_zone array used in
blk_revalidate_disk_zones() to avoid memory allocation failures leading
to disk revalidation failure. Also further reduce the likelyhood of
such failures by using kvcalloc() (that is vmalloc()) instead of
allocating contiguous pages with alloc_pages().

Fixes: 515ce6061312 ("scsi: sd_zbc: Fix sd_zbc_report_zones() buffer allocation")
Fixes: e76239a3748c ("block: add a report_zones method")
	Cc: stable@vger.kernel.org
	Reviewed-by: Christoph Hellwig <hch@lst.de>
	Reviewed-by: Martin K. Petersen <martin.petersen@oracle.com>
	Signed-off-by: Damien Le Moal <damien.lemoal@wdc.com>
	Signed-off-by: Jens Axboe <axboe@kernel.dk>
(cherry picked from commit 26202928fafad8bda8b478edb7e62c885be623d7)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	block/blk-zoned.c
diff --cc block/blk-zoned.c
index 6ea455b62cb4,6c503824ba3f..000000000000
--- a/block/blk-zoned.c
+++ b/block/blk-zoned.c
@@@ -13,6 -14,9 +13,12 @@@
  #include <linux/rbtree.h>
  #include <linux/blkdev.h>
  #include <linux/blk-mq.h>
++<<<<<<< HEAD
++=======
+ #include <linux/mm.h>
+ #include <linux/vmalloc.h>
+ #include <linux/sched/mm.h>
++>>>>>>> 26202928fafa (block: Limit zone array allocation size)
  
  #include "blk.h"
  
@@@ -479,8 -490,9 +488,14 @@@ update
  	blk_mq_unfreeze_queue(q);
  
  out:
++<<<<<<< HEAD
 +	free_pages((unsigned long)zones,
 +		   get_order(rep_nr_zones * sizeof(struct blk_zone)));
++=======
+ 	memalloc_noio_restore(noio_flag);
+ 
+ 	kvfree(zones);
++>>>>>>> 26202928fafa (block: Limit zone array allocation size)
  	kfree(seq_zones_wlock);
  	kfree(seq_zones_bitmap);
  
* Unmerged path block/blk-zoned.c
diff --git a/include/linux/blkdev.h b/include/linux/blkdev.h
index bd38adaa12b3..46094f369eb6 100644
--- a/include/linux/blkdev.h
+++ b/include/linux/blkdev.h
@@ -359,6 +359,11 @@ struct queue_limits {
 
 #ifdef CONFIG_BLK_DEV_ZONED
 
+/*
+ * Maximum number of zones to report with a single report zones command.
+ */
+#define BLK_ZONED_REPORT_MAX_ZONES	8192U
+
 extern unsigned int blkdev_nr_zones(struct block_device *bdev);
 extern int blkdev_report_zones(struct block_device *bdev,
 			       sector_t sector, struct blk_zone *zones,
