selftests: fix kvm relocatable native/cross builds and installs

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Shuah Khan <skhan@linuxfoundation.org>
commit 66d69e081b526b6a6031f0d3ca8ddff71e5707a5
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/66d69e08.failed

kvm test Makefile doesn't fully support cross-builds and installs.
UNAME_M = $(shell uname -m) variable is used to define the target
programs and libraries to be built from arch specific sources in
sub-directories.

For cross-builds to work, UNAME_M has to map to ARCH and arch specific
directories and targets in this Makefile.

UNAME_M variable to used to run the compiles pointing to the right arch
directories and build the right targets for these supported architectures.

TEST_GEN_PROGS and LIBKVM are set using UNAME_M variable.
LINUX_TOOL_ARCH_INCLUDE is set using ARCH variable.

x86_64 targets are named to include x86_64 as a suffix and directories
for includes are in x86_64 sub-directory. s390x and aarch64 follow the
same convention. "uname -m" doesn't result in the correct mapping for
s390x and aarch64. Fix it to set UNAME_M correctly for s390x and aarch64
cross-builds.

In addition, Makefile doesn't create arch sub-directories in the case of
relocatable builds and test programs under s390x and x86_64 directories
fail to build. This is a problem for native and cross-builds. Fix it to
create all necessary directories keying off of TEST_GEN_PROGS.

The following use-cases work with this change:

Native x86_64:
make O=/tmp/kselftest -C tools/testing/selftests TARGETS=kvm install \
 INSTALL_PATH=$HOME/x86_64

arm64 cross-build:
make O=$HOME/arm64_build/ ARCH=arm64 HOSTCC=gcc \
	CROSS_COMPILE=aarch64-linux-gnu- defconfig

make O=$HOME/arm64_build/ ARCH=arm64 HOSTCC=gcc \
	CROSS_COMPILE=aarch64-linux-gnu- all

make kselftest-install TARGETS=kvm O=$HOME/arm64_build ARCH=arm64 \
	HOSTCC=gcc CROSS_COMPILE=aarch64-linux-gnu-

s390x cross-build:
make O=$HOME/s390x_build/ ARCH=s390 HOSTCC=gcc \
	CROSS_COMPILE=s390x-linux-gnu- defconfig

make O=$HOME/s390x_build/ ARCH=s390 HOSTCC=gcc \
	CROSS_COMPILE=s390x-linux-gnu- all

make kselftest-install TARGETS=kvm O=$HOME/s390x_build/ ARCH=s390 \
	HOSTCC=gcc CROSS_COMPILE=s390x-linux-gnu- all

No regressions in the following use-cases:
make -C tools/testing/selftests TARGETS=kvm
make kselftest-all TARGETS=kvm

	Signed-off-by: Shuah Khan <skhan@linuxfoundation.org>
(cherry picked from commit 66d69e081b526b6a6031f0d3ca8ddff71e5707a5)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/testing/selftests/kvm/Makefile
diff --cc tools/testing/selftests/kvm/Makefile
index a193168fb0f3,b728c0a0f9b2..000000000000
--- a/tools/testing/selftests/kvm/Makefile
+++ b/tools/testing/selftests/kvm/Makefile
@@@ -4,9 -5,35 +4,39 @@@ all
  
  top_srcdir = ../../../..
  KSFT_KHDR_INSTALL := 1
+ 
+ # For cross-builds to work, UNAME_M has to map to ARCH and arch specific
+ # directories and targets in this Makefile. "uname -m" doesn't map to
+ # arch specific sub-directory names.
+ #
+ # UNAME_M variable to used to run the compiles pointing to the right arch
+ # directories and build the right targets for these supported architectures.
+ #
+ # TEST_GEN_PROGS and LIBKVM are set using UNAME_M variable.
+ # LINUX_TOOL_ARCH_INCLUDE is set using ARCH variable.
+ #
+ # x86_64 targets are named to include x86_64 as a suffix and directories
+ # for includes are in x86_64 sub-directory. s390x and aarch64 follow the
+ # same convention. "uname -m" doesn't result in the correct mapping for
+ # s390x and aarch64.
+ #
+ # No change necessary for x86_64
  UNAME_M := $(shell uname -m)
  
++<<<<<<< HEAD
 +LIBKVM = lib/assert.c lib/elf.c lib/io.c lib/kvm_util.c lib/sparsebit.c
++=======
+ # Set UNAME_M for arm64 compile/install to work
+ ifeq ($(ARCH),arm64)
+ 	UNAME_M := aarch64
+ endif
+ # Set UNAME_M s390x compile/install to work
+ ifeq ($(ARCH),s390)
+ 	UNAME_M := s390x
+ endif
+ 
+ LIBKVM = lib/assert.c lib/elf.c lib/io.c lib/kvm_util.c lib/sparsebit.c lib/test_util.c
++>>>>>>> 66d69e081b52 (selftests: fix kvm relocatable native/cross builds and installs)
  LIBKVM_x86_64 = lib/x86_64/processor.c lib/x86_64/vmx.c lib/x86_64/svm.c lib/x86_64/ucall.c
  LIBKVM_aarch64 = lib/aarch64/processor.c lib/aarch64/ucall.c
  LIBKVM_s390x = lib/s390x/processor.c lib/s390x/ucall.c
* Unmerged path tools/testing/selftests/kvm/Makefile
