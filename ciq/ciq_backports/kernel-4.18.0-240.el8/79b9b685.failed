netfilter: flowtable: fetch stats only if flow is still alive

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Pablo Neira Ayuso <pablo@netfilter.org>
commit 79b9b685dde1d1bf43cf84163c76953dc3781c85
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/79b9b685.failed

Do not fetch statistics if flow has expired since it might not in
hardware anymore. After this update, remove the FLOW_OFFLOAD_HW_DYING
check from nf_flow_offload_stats() since this flag is never set on.

Fixes: c29f74e0df7a ("netfilter: nf_flow_table: hardware offload support")
	Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
	Acked-by: wenxu <wenxu@ucloud.cn>
(cherry picked from commit 79b9b685dde1d1bf43cf84163c76953dc3781c85)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/netfilter/nf_flow_table_core.c
#	net/netfilter/nf_flow_table_offload.c
diff --cc net/netfilter/nf_flow_table_core.c
index 4ccaaabe1a6c,9e6de2bbeccb..000000000000
--- a/net/netfilter/nf_flow_table_core.c
+++ b/net/netfilter/nf_flow_table_core.c
@@@ -349,8 -349,18 +349,23 @@@ static void nf_flow_offload_gc_step(str
  	struct nf_flowtable *flow_table = data;
  
  	if (nf_flow_has_expired(flow) || nf_ct_is_dying(flow->ct) ||
++<<<<<<< HEAD
 +	    (flow->flags & (FLOW_OFFLOAD_DYING | FLOW_OFFLOAD_TEARDOWN)))
 +		flow_offload_del(flow_table, flow);
++=======
+ 	    (flow->flags & (FLOW_OFFLOAD_DYING | FLOW_OFFLOAD_TEARDOWN))) {
+ 		if (flow->flags & FLOW_OFFLOAD_HW) {
+ 			if (!(flow->flags & FLOW_OFFLOAD_HW_DYING))
+ 				nf_flow_offload_del(flow_table, flow);
+ 			else if (flow->flags & FLOW_OFFLOAD_HW_DEAD)
+ 				flow_offload_del(flow_table, flow);
+ 		} else {
+ 			flow_offload_del(flow_table, flow);
+ 		}
+ 	} else if (flow->flags & FLOW_OFFLOAD_HW) {
+ 		nf_flow_offload_stats(flow_table, flow);
+ 	}
++>>>>>>> 79b9b685dde1 (netfilter: flowtable: fetch stats only if flow is still alive)
  }
  
  static void nf_flow_offload_work_gc(struct work_struct *work)
* Unmerged path net/netfilter/nf_flow_table_offload.c
* Unmerged path net/netfilter/nf_flow_table_core.c
* Unmerged path net/netfilter/nf_flow_table_offload.c
