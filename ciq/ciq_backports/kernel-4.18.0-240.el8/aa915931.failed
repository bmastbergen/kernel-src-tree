libbpf: Fix readelf output parsing for Fedora

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Thadeu Lima de Souza Cascardo <cascardo@canonical.com>
commit aa915931ac3e53ccf371308e6750da510e3591dd
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/aa915931.failed

Fedora binutils has been patched to show "other info" for a symbol at the
end of the line. This was done in order to support unmaintained scripts
that would break with the extra info. [1]

[1] https://src.fedoraproject.org/rpms/binutils/c/b8265c46f7ddae23a792ee8306fbaaeacba83bf8

This in turn has been done to fix the build of ruby, because of checksec.
[2] Thanks Michael Ellerman for the pointer.

[2] https://bugzilla.redhat.com/show_bug.cgi?id=1479302

As libbpf Makefile is not unmaintained, we can simply deal with either
output format, by just removing the "other info" field, as it always comes
inside brackets.

Fixes: 3464afdf11f9 (libbpf: Fix readelf output parsing on powerpc with recent binutils)
	Reported-by: Justin Forbes <jmforbes@linuxtx.org>
	Signed-off-by: Thadeu Lima de Souza Cascardo <cascardo@canonical.com>
	Signed-off-by: Alexei Starovoitov <ast@kernel.org>
	Acked-by: Andrii Nakryiko <andriin@fb.com>
	Cc: Aurelien Jarno <aurelien@aurel32.net>
Link: https://lore.kernel.org/bpf/20191213101114.GA3986@calabresa
(cherry picked from commit aa915931ac3e53ccf371308e6750da510e3591dd)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/lib/bpf/Makefile
diff --cc tools/lib/bpf/Makefile
index e6fcbcad3199,23ae06c43d08..000000000000
--- a/tools/lib/bpf/Makefile
+++ b/tools/lib/bpf/Makefile
@@@ -137,8 -143,13 +137,18 @@@ LIB_TARGET	:= $(addprefix $(OUTPUT),$(L
  LIB_FILE	:= $(addprefix $(OUTPUT),$(LIB_FILE))
  PC_FILE		:= $(addprefix $(OUTPUT),$(PC_FILE))
  
++<<<<<<< HEAD
 +GLOBAL_SYM_COUNT = $(shell readelf -s --wide $(BPF_IN) | \
 +			   awk '/GLOBAL/ && /DEFAULT/ && !/UND/ {s++} END{print s}')
++=======
+ TAGS_PROG := $(if $(shell which etags 2>/dev/null),etags,ctags)
+ 
+ GLOBAL_SYM_COUNT = $(shell readelf -s --wide $(BPF_IN_SHARED) | \
+ 			   cut -d "@" -f1 | sed 's/_v[0-9]_[0-9]_[0-9].*//' | \
+ 			   sed 's/\[.*\]//' | \
+ 			   awk '/GLOBAL/ && /DEFAULT/ && !/UND/ {print $$NF}' | \
+ 			   sort -u | wc -l)
++>>>>>>> aa915931ac3e (libbpf: Fix readelf output parsing for Fedora)
  VERSIONED_SYM_COUNT = $(shell readelf -s --wide $(OUTPUT)libbpf.so | \
  			      grep -Eo '[^ ]+@LIBBPF_' | cut -d@ -f1 | sort -u | wc -l)
  
@@@ -201,8 -212,10 +211,15 @@@ check_abi: $(OUTPUT)libbpf.s
  		     "versioned symbols in $^ ($(VERSIONED_SYM_COUNT))." \
  		     "Please make sure all LIBBPF_API symbols are"	 \
  		     "versioned in $(VERSION_SCRIPT)." >&2;		 \
++<<<<<<< HEAD
 +		readelf -s --wide $(OUTPUT)libbpf-in.o |		 \
 +		    awk '/GLOBAL/ && /DEFAULT/ && !/UND/ {print $$8}'|   \
++=======
+ 		readelf -s --wide $(BPF_IN_SHARED) |			 \
+ 		    cut -d "@" -f1 | sed 's/_v[0-9]_[0-9]_[0-9].*//' |	 \
+ 		    sed 's/\[.*\]//' |					 \
+ 		    awk '/GLOBAL/ && /DEFAULT/ && !/UND/ {print $$NF}'|  \
++>>>>>>> aa915931ac3e (libbpf: Fix readelf output parsing for Fedora)
  		    sort -u > $(OUTPUT)libbpf_global_syms.tmp;		 \
  		readelf -s --wide $(OUTPUT)libbpf.so |			 \
  		    grep -Eo '[^ ]+@LIBBPF_' | cut -d@ -f1 |		 \
* Unmerged path tools/lib/bpf/Makefile
