ceph: make 'nocopyfrom' a default mount option

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Luis Henriques <lhenriques@suse.com>
commit 6f9718fe41c3a47e4362bddf145e2db6ad7d8e87
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/6f9718fe.failed

Since we found a problem with the 'copy-from' operation after objects have
been truncated, offloading object copies to OSDs should be discouraged
until the issue is fixed.

Thus, this patch adds the 'nocopyfrom' mount option to the default mount
options which effectily means that remote copies won't be done in
copy_file_range unless they are explicitly enabled at mount time.

[ Adjust ceph_show_options() accordingly. ]

Link: https://tracker.ceph.com/issues/37378
	Signed-off-by: Luis Henriques <lhenriques@suse.com>
	Reviewed-by: Ilya Dryomov <idryomov@gmail.com>
	Signed-off-by: Ilya Dryomov <idryomov@gmail.com>
(cherry picked from commit 6f9718fe41c3a47e4362bddf145e2db6ad7d8e87)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/ceph/super.c
diff --cc fs/ceph/super.c
index 655dabcff182,4e9a7cc488da..000000000000
--- a/fs/ceph/super.c
+++ b/fs/ceph/super.c
@@@ -582,12 -563,11 +582,18 @@@ static int ceph_show_options(struct seq
  		seq_puts(m, ",noacl");
  #endif
  
++<<<<<<< HEAD
++=======
+ 	if ((fsopt->flags & CEPH_MOUNT_OPT_NOCOPYFROM) == 0)
+ 		seq_puts(m, ",copyfrom");
+ 
++>>>>>>> 6f9718fe41c3 (ceph: make 'nocopyfrom' a default mount option)
  	if (fsopt->mds_namespace)
  		seq_show_option(m, "mds_namespace", fsopt->mds_namespace);
 +
 +	if (fsopt->flags & CEPH_MOUNT_OPT_CLEANRECOVER)
 +		seq_show_option(m, "recover_session", "clean");
 +
  	if (fsopt->wsize != CEPH_MAX_WRITE_SIZE)
  		seq_printf(m, ",wsize=%d", fsopt->wsize);
  	if (fsopt->rsize != CEPH_MAX_READ_SIZE)
* Unmerged path fs/ceph/super.c
diff --git a/fs/ceph/super.h b/fs/ceph/super.h
index 78a329c8e763..df75e29c835e 100644
--- a/fs/ceph/super.h
+++ b/fs/ceph/super.h
@@ -43,7 +43,9 @@
 #define CEPH_MOUNT_OPT_MOUNTWAIT       (1<<12) /* mount waits if no mds is up */
 #define CEPH_MOUNT_OPT_NOQUOTADF       (1<<13) /* no root dir quota in statfs */
 
-#define CEPH_MOUNT_OPT_DEFAULT    CEPH_MOUNT_OPT_DCACHE
+#define CEPH_MOUNT_OPT_DEFAULT			\
+	(CEPH_MOUNT_OPT_DCACHE |		\
+	 CEPH_MOUNT_OPT_NOCOPYFROM)
 
 #define ceph_set_mount_opt(fsc, opt) \
 	(fsc)->mount_options->flags |= CEPH_MOUNT_OPT_##opt;
