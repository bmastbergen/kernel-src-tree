powerpc/kernel/sysfs: Add new config option PMU_SYSFS to enable PMU SPRs sysfs file creation

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Kajol Jain <kjain@linux.ibm.com>
commit 22697da36d0cee57c2a5750ef7d84e4d88da17e7
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/22697da3.failed

Many of the performance monitoring unit (PMU) SPRs are
exposed in the sysfs. This may not be a desirable since
"perf" API is the primary interface to program PMU and
collect counter data in the system. But that said, we
cant remove these sysfs files since we dont whether
anyone/anything is using them.

So the patch adds a new CONFIG option 'CONFIG_PMU_SYSFS'
(user selectable) to be used in sysfs file creation for
PMU SPRs. New option by default is disabled, but can be
enabled if user needs it.

Tested this patch behaviour in powernv and pseries machines.
Patch is also tested for pmac32_defconfig.

	Signed-off-by: Kajol Jain <kjain@linux.ibm.com>
	Tested-by: Nageswara R Sastry <nasastry@in.ibm.com>
	Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: https://lore.kernel.org/r/20200214080606.26872-2-kjain@linux.ibm.com
(cherry picked from commit 22697da36d0cee57c2a5750ef7d84e4d88da17e7)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/powerpc/kernel/sysfs.c
diff --cc arch/powerpc/kernel/sysfs.c
index ca768395f4a2,479c70680b76..000000000000
--- a/arch/powerpc/kernel/sysfs.c
+++ b/arch/powerpc/kernel/sysfs.c
@@@ -454,16 -562,44 +454,22 @@@ static ssize_t __used 
   * that are implemented on the current processor
   */
  
++<<<<<<< HEAD
 +#if defined(CONFIG_PPC64)
++=======
+ #ifdef CONFIG_PMU_SYSFS
+ #if defined(CONFIG_PPC64) || defined(CONFIG_PPC_BOOK3S_32)
++>>>>>>> 22697da36d0c (powerpc/kernel/sysfs: Add new config option PMU_SYSFS to enable PMU SPRs sysfs file creation)
  #define HAS_PPC_PMC_CLASSIC	1
  #define HAS_PPC_PMC_IBM		1
 -#endif
 -
 -#ifdef CONFIG_PPC64
  #define HAS_PPC_PMC_PA6T	1
 -#define HAS_PPC_PMC56          1
 -#endif
 -
 -#ifdef CONFIG_PPC_BOOK3S_32
 +#elif defined(CONFIG_6xx)
 +#define HAS_PPC_PMC_CLASSIC	1
 +#define HAS_PPC_PMC_IBM		1
  #define HAS_PPC_PMC_G4		1
  #endif
+ #endif /* CONFIG_PMU_SYSFS */
  
 -#if defined(CONFIG_PPC64) && defined(CONFIG_DEBUG_MISC)
 -#define HAS_PPC_PA6T
 -#endif
 -/*
 - * SPRs which are not related to PMU.
 - */
 -#ifdef CONFIG_PPC64
 -SYSFS_SPRSETUP(purr, SPRN_PURR);
 -SYSFS_SPRSETUP(spurr, SPRN_SPURR);
 -SYSFS_SPRSETUP(pir, SPRN_PIR);
 -SYSFS_SPRSETUP(tscr, SPRN_TSCR);
 -
 -/*
 -  Lets only enable read for phyp resources and
 -  enable write when needed with a separate function.
 -  Lets be conservative and default to pseries.
 -*/
 -static DEVICE_ATTR(spurr, 0400, show_spurr, NULL);
 -static DEVICE_ATTR(purr, 0400, show_purr, store_purr);
 -static DEVICE_ATTR(pir, 0400, show_pir, NULL);
 -static DEVICE_ATTR(tscr, 0600, show_tscr, store_tscr);
 -#endif /* CONFIG_PPC64 */
  
  #ifdef HAS_PPC_PMC_CLASSIC
  SYSFS_PMCSETUP(mmcr0, SPRN_MMCR0);
* Unmerged path arch/powerpc/kernel/sysfs.c
diff --git a/arch/powerpc/platforms/Kconfig.cputype b/arch/powerpc/platforms/Kconfig.cputype
index 42fa065292ba..f7257fc444ef 100644
--- a/arch/powerpc/platforms/Kconfig.cputype
+++ b/arch/powerpc/platforms/Kconfig.cputype
@@ -342,6 +342,12 @@ config PPC_MM_SLICES
 config PPC_HAVE_PMU_SUPPORT
        bool
 
+config PMU_SYSFS
+	bool "Create PMU SPRs sysfs file"
+	default n
+	help
+	  This option enables sysfs file creation for PMU SPRs like MMCR* and PMC*.
+
 config PPC_PERF_CTRS
        def_bool y
        depends on PERF_EVENTS && PPC_HAVE_PMU_SUPPORT
