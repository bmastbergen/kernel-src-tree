perf evlist: Adopt backwards ring buffer state enum

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Arnaldo Carvalho de Melo <acme@redhat.com>
commit e0fcfb086fbbb6233de1062d4b2f05e9afedab3b
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/e0fcfb08.failed

As this isn't used at all in mmap.h but in evlist.h, so to cut down the
header dependency tree, move it to where it is used.

Also add mmap.h to the places using it but previously getting it
indirectly via evlist.h.

Add missing pthread.h to evlist.h, as it has a pthread_t struct member
and was getting the header via mmap.h.

Noticed while processing a Jiri's libperf batch touching mmap.h, where
almost everything gets rebuilt because evlist.h is so popular, so cut
down't this rebuild the world party.

	Cc: Adrian Hunter <adrian.hunter@intel.com>
	Cc: Jiri Olsa <jolsa@kernel.org>
	Cc: Namhyung Kim <namhyung@kernel.org>
	Cc: Song Liu <songliubraving@fb.com>
Link: https://lkml.kernel.org/n/tip-he0uljeftl0xfveh3d6vtode@git.kernel.org
	Signed-off-by: Arnaldo Carvalho de Melo <acme@redhat.com>
(cherry picked from commit e0fcfb086fbbb6233de1062d4b2f05e9afedab3b)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/perf/builtin-record.c
#	tools/perf/builtin-trace.c
#	tools/perf/tests/backward-ring-buffer.c
#	tools/perf/tests/bpf.c
#	tools/perf/tests/code-reading.c
#	tools/perf/util/auxtrace.c
#	tools/perf/util/evlist.h
diff --cc tools/perf/builtin-record.c
index de0619148499,1bb3d91c6599..000000000000
--- a/tools/perf/builtin-record.c
+++ b/tools/perf/builtin-record.c
@@@ -22,6 -20,8 +22,11 @@@
  #include "util/evlist.h"
  #include "util/evsel.h"
  #include "util/debug.h"
++<<<<<<< HEAD
++=======
+ #include "util/mmap.h"
+ #include "util/target.h"
++>>>>>>> e0fcfb086fbb (perf evlist: Adopt backwards ring buffer state enum)
  #include "util/session.h"
  #include "util/tool.h"
  #include "util/symbol.h"
diff --cc tools/perf/builtin-trace.c
index 4b81b4c2c4c2,c44280358e58..000000000000
--- a/tools/perf/builtin-trace.c
+++ b/tools/perf/builtin-trace.c
@@@ -26,10 -25,14 +26,15 @@@
  #include "util/color.h"
  #include "util/config.h"
  #include "util/debug.h"
 -#include "util/dso.h"
  #include "util/env.h"
  #include "util/event.h"
 -#include "util/synthetic-events.h"
  #include "util/evlist.h"
  #include "util/evswitch.h"
++<<<<<<< HEAD
++=======
+ #include "util/mmap.h"
+ #include <subcmd/pager.h>
++>>>>>>> e0fcfb086fbb (perf evlist: Adopt backwards ring buffer state enum)
  #include <subcmd/exec-cmd.h>
  #include "util/machine.h"
  #include "util/map.h"
diff --cc tools/perf/tests/backward-ring-buffer.c
index 1a9c3becf5ff,c59d3752d48d..000000000000
--- a/tools/perf/tests/backward-ring-buffer.c
+++ b/tools/perf/tests/backward-ring-buffer.c
@@@ -4,12 -4,15 +4,17 @@@
   * beginning
   */
  
 +#include <perf.h>
  #include <evlist.h>
  #include <sys/prctl.h>
 -#include "record.h"
  #include "tests.h"
  #include "debug.h"
++<<<<<<< HEAD
++=======
+ #include "parse-events.h"
+ #include "util/mmap.h"
++>>>>>>> e0fcfb086fbb (perf evlist: Adopt backwards ring buffer state enum)
  #include <errno.h>
 -#include <linux/string.h>
  
  #define NR_ITERS 111
  
diff --cc tools/perf/tests/bpf.c
index c9e4cdc4c9c8,3c8533fdbce5..000000000000
--- a/tools/perf/tests/bpf.c
+++ b/tools/perf/tests/bpf.c
@@@ -16,6 -18,8 +16,11 @@@
  #include "tests.h"
  #include "llvm.h"
  #include "debug.h"
++<<<<<<< HEAD
++=======
+ #include "parse-events.h"
+ #include "util/mmap.h"
++>>>>>>> e0fcfb086fbb (perf evlist: Adopt backwards ring buffer state enum)
  #define NR_ITERS       111
  #define PERF_TEST_BPF_PATH "/sys/fs/bpf/perf_test"
  
diff --cc tools/perf/tests/code-reading.c
index aa6df122b175,bc6db3e7a1c5..000000000000
--- a/tools/perf/tests/code-reading.c
+++ b/tools/perf/tests/code-reading.c
@@@ -18,6 -23,9 +18,12 @@@
  #include "map.h"
  #include "symbol.h"
  #include "event.h"
++<<<<<<< HEAD
++=======
+ #include "record.h"
+ #include "util/mmap.h"
+ #include "util/synthetic-events.h"
++>>>>>>> e0fcfb086fbb (perf evlist: Adopt backwards ring buffer state enum)
  #include "thread.h"
  
  #include "tests.h"
diff --cc tools/perf/util/auxtrace.c
index 2e60b09cfd97,4bd92f5bfb5f..000000000000
--- a/tools/perf/util/auxtrace.c
+++ b/tools/perf/util/auxtrace.c
@@@ -59,9 -50,13 +59,14 @@@
  #include "intel-bts.h"
  #include "arm-spe.h"
  #include "s390-cpumsf.h"
++<<<<<<< HEAD
++=======
+ #include "util.h" // page_size
+ #include "util/mmap.h"
++>>>>>>> e0fcfb086fbb (perf evlist: Adopt backwards ring buffer state enum)
  
  #include <linux/ctype.h>
 -#include <linux/kernel.h>
  #include "symbol/kallsyms.h"
 -#include <internal/lib.h>
  
  static bool auxtrace__dont_decode(struct perf_session *session)
  {
diff --cc tools/perf/util/evlist.h
index 49354fe24d5f,8b9c35efea67..000000000000
--- a/tools/perf/util/evlist.h
+++ b/tools/perf/util/evlist.h
@@@ -8,19 -8,46 +8,51 @@@
  #include <linux/list.h>
  #include <api/fd/array.h>
  #include <stdio.h>
 -#include <internal/evlist.h>
 -#include "events_stats.h"
 +#include "../perf.h"
 +#include "event.h"
  #include "evsel.h"
++<<<<<<< HEAD
 +#include "mmap.h"
 +#include "util.h"
++=======
+ #include <pthread.h>
++>>>>>>> e0fcfb086fbb (perf evlist: Adopt backwards ring buffer state enum)
  #include <signal.h>
  #include <unistd.h>
  
  struct pollfd;
  struct thread_map;
 -struct perf_cpu_map;
 +struct cpu_map;
  struct record_opts;
  
+ /*
+  * State machine of bkw_mmap_state:
+  *
+  *                     .________________(forbid)_____________.
+  *                     |                                     V
+  * NOTREADY --(0)--> RUNNING --(1)--> DATA_PENDING --(2)--> EMPTY
+  *                     ^  ^              |   ^               |
+  *                     |  |__(forbid)____/   |___(forbid)___/|
+  *                     |                                     |
+  *                      \_________________(3)_______________/
+  *
+  * NOTREADY     : Backward ring buffers are not ready
+  * RUNNING      : Backward ring buffers are recording
+  * DATA_PENDING : We are required to collect data from backward ring buffers
+  * EMPTY        : We have collected data from backward ring buffers.
+  *
+  * (0): Setup backward ring buffer
+  * (1): Pause ring buffers for reading
+  * (2): Read from ring buffers
+  * (3): Resume ring buffers for recording
+  */
+ enum bkw_mmap_state {
+ 	BKW_MMAP_NOTREADY,
+ 	BKW_MMAP_RUNNING,
+ 	BKW_MMAP_DATA_PENDING,
+ 	BKW_MMAP_EMPTY,
+ };
+ 
  #define PERF_EVLIST__HLIST_BITS 8
  #define PERF_EVLIST__HLIST_SIZE (1 << PERF_EVLIST__HLIST_BITS)
  
diff --git a/tools/perf/arch/s390/util/auxtrace.c b/tools/perf/arch/s390/util/auxtrace.c
index 0fe1be93f375..11494a73f532 100644
--- a/tools/perf/arch/s390/util/auxtrace.c
+++ b/tools/perf/arch/s390/util/auxtrace.c
@@ -1,4 +1,5 @@
 #include <stdbool.h>
+#include <stdlib.h>
 #include <linux/kernel.h>
 #include <linux/types.h>
 #include <linux/bitops.h>
diff --git a/tools/perf/arch/x86/tests/perf-time-to-tsc.c b/tools/perf/arch/x86/tests/perf-time-to-tsc.c
index 7a7721604b86..31c882977cd0 100644
--- a/tools/perf/arch/x86/tests/perf-time-to-tsc.c
+++ b/tools/perf/arch/x86/tests/perf-time-to-tsc.c
@@ -12,6 +12,7 @@
 #include "thread_map.h"
 #include "cpumap.h"
 #include "tsc.h"
+#include "util/mmap.h"
 #include "tests/tests.h"
 
 #include "arch-tests.h"
diff --git a/tools/perf/arch/x86/util/intel-bts.c b/tools/perf/arch/x86/util/intel-bts.c
index 4cbd3d775c19..4a321091e2d6 100644
--- a/tools/perf/arch/x86/util/intel-bts.c
+++ b/tools/perf/arch/x86/util/intel-bts.c
@@ -23,6 +23,7 @@
 #include "../../util/cpumap.h"
 #include "../../util/evsel.h"
 #include "../../util/evlist.h"
+#include "../../util/mmap.h"
 #include "../../util/session.h"
 #include "../../util/pmu.h"
 #include "../../util/debug.h"
diff --git a/tools/perf/arch/x86/util/intel-pt.c b/tools/perf/arch/x86/util/intel-pt.c
index 3a851647e6f4..ec905e84e705 100644
--- a/tools/perf/arch/x86/util/intel-pt.c
+++ b/tools/perf/arch/x86/util/intel-pt.c
@@ -28,6 +28,7 @@
 #include "../../util/evlist.h"
 #include "../../util/evsel.h"
 #include "../../util/cpumap.h"
+#include "../../util/mmap.h"
 #include <subcmd/parse-options.h>
 #include "../../util/parse-events.h"
 #include "../../util/pmu.h"
diff --git a/tools/perf/builtin-kvm.c b/tools/perf/builtin-kvm.c
index d30bd54b42ac..8851a6247856 100644
--- a/tools/perf/builtin-kvm.c
+++ b/tools/perf/builtin-kvm.c
@@ -4,6 +4,7 @@
 
 #include "util/evsel.h"
 #include "util/evlist.h"
+#include "util/mmap.h"
 #include "util/term.h"
 #include "util/cache.h"
 #include "util/symbol.h"
* Unmerged path tools/perf/builtin-record.c
diff --git a/tools/perf/builtin-top.c b/tools/perf/builtin-top.c
index 95aec2602043..f17a44f2b9db 100644
--- a/tools/perf/builtin-top.c
+++ b/tools/perf/builtin-top.c
@@ -30,6 +30,7 @@
 #include "util/event.h"
 #include "util/machine.h"
 #include "util/map.h"
+#include "util/mmap.h"
 #include "util/session.h"
 #include "util/symbol.h"
 #include "util/thread.h"
* Unmerged path tools/perf/builtin-trace.c
* Unmerged path tools/perf/tests/backward-ring-buffer.c
* Unmerged path tools/perf/tests/bpf.c
* Unmerged path tools/perf/tests/code-reading.c
diff --git a/tools/perf/tests/hists_link.c b/tools/perf/tests/hists_link.c
index 5a10bd43b3e7..bfd6dafee4a0 100644
--- a/tools/perf/tests/hists_link.c
+++ b/tools/perf/tests/hists_link.c
@@ -9,6 +9,7 @@
 #include "thread.h"
 #include "parse-events.h"
 #include "hists_common.h"
+#include "util/mmap.h"
 #include <errno.h>
 #include <linux/kernel.h>
 
diff --git a/tools/perf/tests/keep-tracking.c b/tools/perf/tests/keep-tracking.c
index 17c46f3e6f1e..0bbaf4088aaa 100644
--- a/tools/perf/tests/keep-tracking.c
+++ b/tools/perf/tests/keep-tracking.c
@@ -9,6 +9,7 @@
 #include "thread_map.h"
 #include "cpumap.h"
 #include "tests.h"
+#include "util/mmap.h"
 
 #define CHECK__(x) {				\
 	while ((x) < 0) {			\
diff --git a/tools/perf/tests/mmap-basic.c b/tools/perf/tests/mmap-basic.c
index 0919b0793e5b..f35295f5cc83 100644
--- a/tools/perf/tests/mmap-basic.c
+++ b/tools/perf/tests/mmap-basic.c
@@ -9,6 +9,7 @@
 #include "thread_map.h"
 #include "cpumap.h"
 #include "tests.h"
+#include "util/mmap.h"
 #include <linux/err.h>
 #include <linux/kernel.h>
 
diff --git a/tools/perf/tests/openat-syscall-tp-fields.c b/tools/perf/tests/openat-syscall-tp-fields.c
index 344dc3ac2469..e0b372b2aee7 100644
--- a/tools/perf/tests/openat-syscall-tp-fields.c
+++ b/tools/perf/tests/openat-syscall-tp-fields.c
@@ -9,6 +9,7 @@
 #include "thread_map.h"
 #include "tests.h"
 #include "debug.h"
+#include "util/mmap.h"
 #include <errno.h>
 
 #ifndef O_DIRECTORY
diff --git a/tools/perf/tests/perf-record.c b/tools/perf/tests/perf-record.c
index 07f6bd8ed719..b038897f6340 100644
--- a/tools/perf/tests/perf-record.c
+++ b/tools/perf/tests/perf-record.c
@@ -10,6 +10,7 @@
 #include "perf.h"
 #include "debug.h"
 #include "tests.h"
+#include "util/mmap.h"
 
 static int sched__get_first_possible_cpu(pid_t pid, cpu_set_t *maskp)
 {
diff --git a/tools/perf/tests/sw-clock.c b/tools/perf/tests/sw-clock.c
index f9490b237893..ff3a2b5225ef 100644
--- a/tools/perf/tests/sw-clock.c
+++ b/tools/perf/tests/sw-clock.c
@@ -10,6 +10,7 @@
 #include "util/evsel.h"
 #include "util/evlist.h"
 #include "util/cpumap.h"
+#include "util/mmap.h"
 #include "util/thread_map.h"
 
 #define NR_LOOPS  10000000
diff --git a/tools/perf/tests/switch-tracking.c b/tools/perf/tests/switch-tracking.c
index 6cdab5f4812a..7c0321cb78d0 100644
--- a/tools/perf/tests/switch-tracking.c
+++ b/tools/perf/tests/switch-tracking.c
@@ -12,6 +12,7 @@
 #include "thread_map.h"
 #include "cpumap.h"
 #include "tests.h"
+#include "util/mmap.h"
 
 static int spin_sleep(void)
 {
diff --git a/tools/perf/tests/task-exit.c b/tools/perf/tests/task-exit.c
index e92fa6029ac7..7cadc23da367 100644
--- a/tools/perf/tests/task-exit.c
+++ b/tools/perf/tests/task-exit.c
@@ -4,6 +4,7 @@
 #include "thread_map.h"
 #include "cpumap.h"
 #include "tests.h"
+#include "util/mmap.h"
 
 #include <errno.h>
 #include <signal.h>
diff --git a/tools/perf/ui/gtk/hists.c b/tools/perf/ui/gtk/hists.c
index 3955ed1d1bd9..7d09146171d2 100644
--- a/tools/perf/ui/gtk/hists.c
+++ b/tools/perf/ui/gtk/hists.c
@@ -9,6 +9,7 @@
 #include "../string2.h"
 #include "gtk.h"
 #include <signal.h>
+#include <stdlib.h>
 #include <linux/string.h>
 
 #define MAX_COLUMNS			32
diff --git a/tools/perf/util/annotate.c b/tools/perf/util/annotate.c
index a2ea6e023df0..36442baa9323 100644
--- a/tools/perf/util/annotate.c
+++ b/tools/perf/util/annotate.c
@@ -33,6 +33,7 @@
 #include "bpf-event.h"
 #include "block-range.h"
 #include "string2.h"
+#include "util/mmap.h"
 #include "arch/common.h"
 #include <regex.h>
 #include <pthread.h>
* Unmerged path tools/perf/util/auxtrace.c
diff --git a/tools/perf/util/evlist.c b/tools/perf/util/evlist.c
index 29a998d183ce..3a78d51505c4 100644
--- a/tools/perf/util/evlist.c
+++ b/tools/perf/util/evlist.c
@@ -11,6 +11,7 @@
 #include <inttypes.h>
 #include <poll.h>
 #include "cpumap.h"
+#include "util/mmap.h"
 #include "thread_map.h"
 #include "target.h"
 #include "evlist.h"
* Unmerged path tools/perf/util/evlist.h
diff --git a/tools/perf/util/mmap.h b/tools/perf/util/mmap.h
index 274ce389cd84..e23fa4210375 100644
--- a/tools/perf/util/mmap.h
+++ b/tools/perf/util/mmap.h
@@ -44,34 +44,6 @@ struct perf_mmap {
 	int		comp_level;
 };
 
-/*
- * State machine of bkw_mmap_state:
- *
- *                     .________________(forbid)_____________.
- *                     |                                     V
- * NOTREADY --(0)--> RUNNING --(1)--> DATA_PENDING --(2)--> EMPTY
- *                     ^  ^              |   ^               |
- *                     |  |__(forbid)____/   |___(forbid)___/|
- *                     |                                     |
- *                      \_________________(3)_______________/
- *
- * NOTREADY     : Backward ring buffers are not ready
- * RUNNING      : Backward ring buffers are recording
- * DATA_PENDING : We are required to collect data from backward ring buffers
- * EMPTY        : We have collected data from backward ring buffers.
- *
- * (0): Setup backward ring buffer
- * (1): Pause ring buffers for reading
- * (2): Read from ring buffers
- * (3): Resume ring buffers for recording
- */
-enum bkw_mmap_state {
-	BKW_MMAP_NOTREADY,
-	BKW_MMAP_RUNNING,
-	BKW_MMAP_DATA_PENDING,
-	BKW_MMAP_EMPTY,
-};
-
 struct mmap_params {
 	int prot, mask, nr_cblocks, affinity, flush, comp_level;
 	struct auxtrace_mmap_params auxtrace_mp;
diff --git a/tools/perf/util/parse-events.c b/tools/perf/util/parse-events.c
index 5941be0e92cc..92c8f47cbab3 100644
--- a/tools/perf/util/parse-events.c
+++ b/tools/perf/util/parse-events.c
@@ -33,6 +33,7 @@
 #include "asm/bug.h"
 #include "util/parse-branch-options.h"
 #include "metricgroup.h"
+#include "util/mmap.h"
 
 #define MAX_NAME_LEN 100
 
