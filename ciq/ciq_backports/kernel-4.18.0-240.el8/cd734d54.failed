ptp: Validate requests to enable time stamping of external signals.

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
Rebuild_CHGLOG: - [ptp] Validate requests to enable time stamping of external signals (Petr Oros) [1795192]
Rebuild_FUZZ: 95.31%
commit-author Richard Cochran <richardcochran@gmail.com>
commit cd734d54e67990eebfc3106dc39047c1141d4197
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/cd734d54.failed

Commit 415606588c61 ("PTP: introduce new versions of IOCTLs")
introduced a new external time stamp ioctl that validates the flags.
This patch extends the validation to ensure that at least one rising
or falling edge flag is set when enabling external time stamps.

	Signed-off-by: Richard Cochran <richardcochran@gmail.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit cd734d54e67990eebfc3106dc39047c1141d4197)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/ptp/ptp_chardev.c
diff --cc drivers/ptp/ptp_chardev.c
index 7cbea796652a,cbbe1237ff8d..000000000000
--- a/drivers/ptp/ptp_chardev.c
+++ b/drivers/ptp/ptp_chardev.c
@@@ -157,6 -149,24 +157,27 @@@ long ptp_ioctl(struct posix_clock *pc, 
  			err = -EFAULT;
  			break;
  		}
++<<<<<<< HEAD
++=======
+ 		if (cmd == PTP_EXTTS_REQUEST2) {
+ 			/* Make sure no reserved bit is set. */
+ 			if ((req.extts.flags & ~PTP_EXTTS_VALID_FLAGS) ||
+ 			    req.extts.rsv[0] || req.extts.rsv[1]) {
+ 				err = -EINVAL;
+ 				break;
+ 			}
+ 			/* Ensure one of the rising/falling edge bits is set. */
+ 			if ((req.extts.flags & PTP_ENABLE_FEATURE) &&
+ 			    (req.extts.flags & PTP_EXTTS_EDGES) == 0) {
+ 				err = -EINVAL;
+ 				break;
+ 			}
+ 		} else if (cmd == PTP_EXTTS_REQUEST) {
+ 			req.extts.flags &= PTP_EXTTS_V1_VALID_FLAGS;
+ 			req.extts.rsv[0] = 0;
+ 			req.extts.rsv[1] = 0;
+ 		}
++>>>>>>> cd734d54e679 (ptp: Validate requests to enable time stamping of external signals.)
  		if (req.extts.index >= ops->n_ext_ts) {
  			err = -EINVAL;
  			break;
* Unmerged path drivers/ptp/ptp_chardev.c
diff --git a/include/uapi/linux/ptp_clock.h b/include/uapi/linux/ptp_clock.h
index 1bc794ad957a..a581513e31ab 100644
--- a/include/uapi/linux/ptp_clock.h
+++ b/include/uapi/linux/ptp_clock.h
@@ -29,6 +29,7 @@
 #define PTP_ENABLE_FEATURE (1<<0)
 #define PTP_RISING_EDGE    (1<<1)
 #define PTP_FALLING_EDGE   (1<<2)
+#define PTP_EXTTS_EDGES    (PTP_RISING_EDGE | PTP_FALLING_EDGE)
 
 /*
  * struct ptp_clock_time - represents a time value
