drm/scheduler: fix drm_sched_get_cleanup_job

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Christian König <christian.koenig@amd.com>
commit 8623b5255ae7ccaf276aac3920787bf575fa6b37
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/8623b525.failed

We are racing to initialize sched->thread here, just always check the
current thread.

	Signed-off-by: Christian König <christian.koenig@amd.com>
	Reviewed-by: Andrey Grodzovsky <andrey.grodzovsky@amd.com>
	Reviewed-by: Kent Russell <kent.russell@amd.com>
Link: https://patchwork.freedesktop.org/patch/361303/
(cherry picked from commit 8623b5255ae7ccaf276aac3920787bf575fa6b37)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/gpu/drm/scheduler/sched_main.c
diff --cc drivers/gpu/drm/scheduler/sched_main.c
index ac7555aa5954,2f319102ae9f..000000000000
--- a/drivers/gpu/drm/scheduler/sched_main.c
+++ b/drivers/gpu/drm/scheduler/sched_main.c
@@@ -642,14 -669,17 +642,24 @@@ static struct drm_sched_job 
  drm_sched_get_cleanup_job(struct drm_gpu_scheduler *sched)
  {
  	struct drm_sched_job *job;
 +	unsigned long flags;
  
++<<<<<<< HEAD
 +	/* Don't destroy jobs while the timeout worker is running */
 +	if (sched->timeout != MAX_SCHEDULE_TIMEOUT &&
 +	    !cancel_delayed_work(&sched->work_tdr))
++=======
+ 	/*
+ 	 * Don't destroy jobs while the timeout worker is running  OR thread
+ 	 * is being parked and hence assumed to not touch ring_mirror_list
+ 	 */
+ 	if ((sched->timeout != MAX_SCHEDULE_TIMEOUT &&
+ 	    !cancel_delayed_work(&sched->work_tdr)) ||
+ 	    kthread_should_park())
++>>>>>>> 8623b5255ae7 (drm/scheduler: fix drm_sched_get_cleanup_job)
  		return NULL;
  
 -	spin_lock(&sched->job_list_lock);
 +	spin_lock_irqsave(&sched->job_list_lock, flags);
  
  	job = list_first_entry_or_null(&sched->ring_mirror_list,
  				       struct drm_sched_job, node);
* Unmerged path drivers/gpu/drm/scheduler/sched_main.c
