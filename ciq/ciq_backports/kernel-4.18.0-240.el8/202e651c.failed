netfilter: conntrack: gre: convert rwlock to rcu

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Florian Westphal <fw@strlen.de>
commit 202e651cd43c69a43f75b445e90f55b59f9af0ad
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/202e651c.failed

We can use gre.  Lock is only needed when a new expectation is added.

In case a single spinlock proves to be problematic we can either add one
per netns or use an array of locks combined with net_hash_mix() or similar
to pick the 'correct' one.

But given this is only needed for an expectation rather than per packet
a single one should be ok.

	Signed-off-by: Florian Westphal <fw@strlen.de>
	Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
(cherry picked from commit 202e651cd43c69a43f75b445e90f55b59f9af0ad)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/netfilter/nf_conntrack_proto_gre.c
diff --cc net/netfilter/nf_conntrack_proto_gre.c
index c9e1b1061af6,34dd89485be2..000000000000
--- a/net/netfilter/nf_conntrack_proto_gre.c
+++ b/net/netfilter/nf_conntrack_proto_gre.c
@@@ -54,12 -49,8 +54,17 @@@ static const unsigned int gre_timeouts[
  };
  
  static unsigned int proto_gre_net_id __read_mostly;
++<<<<<<< HEAD
 +struct netns_proto_gre {
 +	struct nf_proto_net	nf;
 +	rwlock_t		keymap_lock;
 +	struct list_head	keymap_list;
 +	unsigned int		gre_timeouts[GRE_CT_MAX];
 +};
++=======
+ /* used when expectation is added */
+ static DEFINE_SPINLOCK(keymap_lock);
++>>>>>>> 202e651cd43c (netfilter: conntrack: gre: convert rwlock to rcu)
  
  static inline struct netns_proto_gre *gre_pernet(struct net *net)
  {
@@@ -332,9 -317,48 +329,8 @@@ gre_timeout_nla_policy[CTA_TIMEOUT_GRE_
  static int gre_init_net(struct net *net)
  {
  	struct netns_proto_gre *net_gre = gre_pernet(net);
 -	struct nf_proto_net *nf = &net_gre->nf;
  	int i;
  
- 	rwlock_init(&net_gre->keymap_lock);
  	INIT_LIST_HEAD(&net_gre->keymap_list);
  	for (i = 0; i < GRE_CT_MAX; i++)
  		net_gre->gre_timeouts[i] = gre_timeouts[i];
diff --git a/include/linux/netfilter/nf_conntrack_proto_gre.h b/include/linux/netfilter/nf_conntrack_proto_gre.h
index b8d95564bd53..7e4be7211ff7 100644
--- a/include/linux/netfilter/nf_conntrack_proto_gre.h
+++ b/include/linux/netfilter/nf_conntrack_proto_gre.h
@@ -19,6 +19,7 @@ struct nf_conn;
 struct nf_ct_gre_keymap {
 	struct list_head list;
 	struct nf_conntrack_tuple tuple;
+	struct rcu_head rcu;
 };
 
 /* add new tuple->key_reply pair to keymap */
* Unmerged path net/netfilter/nf_conntrack_proto_gre.c
