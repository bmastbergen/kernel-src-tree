x86/mce: WARN once if IA32_FEAT_CTL MSR is left unlocked

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
Rebuild_CHGLOG: - [x86] mce: WARN once if IA32_FEAT_CTL MSR is left unlocked (Vitaly Kuznetsov) [1813987]
Rebuild_FUZZ: 96.30%
commit-author Sean Christopherson <sean.j.christopherson@intel.com>
commit 6d527cebfa04ba4792be9e79e0d7cab22ab6c377
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/6d527ceb.failed

WARN if the IA32_FEAT_CTL MSR is somehow left unlocked now that CPU
initialization unconditionally locks the MSR.

	Signed-off-by: Sean Christopherson <sean.j.christopherson@intel.com>
	Signed-off-by: Borislav Petkov <bp@suse.de>
Link: https://lkml.kernel.org/r/20191221044513.21680-6-sean.j.christopherson@intel.com
(cherry picked from commit 6d527cebfa04ba4792be9e79e0d7cab22ab6c377)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kernel/cpu/mce/intel.c
diff --cc arch/x86/kernel/cpu/mce/intel.c
index 88cd9598fa57,5627b1091b85..000000000000
--- a/arch/x86/kernel/cpu/mce/intel.c
+++ b/arch/x86/kernel/cpu/mce/intel.c
@@@ -113,15 -115,16 +113,26 @@@ static bool lmce_supported(void
  
  	/*
  	 * BIOS should indicate support for LMCE by setting bit 20 in
++<<<<<<< HEAD
 +	 * IA32_FEATURE_CONTROL without which touching MCG_EXT_CTL will
 +	 * generate a #GP fault.
 +	 */
 +	rdmsrl(MSR_IA32_FEATURE_CONTROL, tmp);
 +	if ((tmp & (FEATURE_CONTROL_LOCKED | FEATURE_CONTROL_LMCE)) ==
 +		   (FEATURE_CONTROL_LOCKED | FEATURE_CONTROL_LMCE))
 +		return true;
++=======
+ 	 * IA32_FEAT_CTL without which touching MCG_EXT_CTL will generate a #GP
+ 	 * fault.  The MSR must also be locked for LMCE_ENABLED to take effect.
+ 	 * WARN if the MSR isn't locked as init_ia32_feat_ctl() unconditionally
+ 	 * locks the MSR in the event that it wasn't already locked by BIOS.
+ 	 */
+ 	rdmsrl(MSR_IA32_FEAT_CTL, tmp);
+ 	if (WARN_ON_ONCE(!(tmp & FEAT_CTL_LOCKED)))
+ 		return false;
++>>>>>>> 6d527cebfa04 (x86/mce: WARN once if IA32_FEAT_CTL MSR is left unlocked)
  
- 	return false;
+ 	return tmp & FEAT_CTL_LMCE_ENABLED;
  }
  
  bool mce_intel_cmci_poll(void)
* Unmerged path arch/x86/kernel/cpu/mce/intel.c
