ALSA: usb-audio: Use managed buffer allocation

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Takashi Iwai <tiwai@suse.de>
commit 6dd9486ca9b8dde3a91e4c5231b8c83df27ba753
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/6dd9486c.failed

Clean up the driver with the new managed buffer allocation API.
The superfluous snd_pcm_lib_malloc_pages() and
snd_pcm_lib_free_pages() calls are dropped.

Link: https://lore.kernel.org/r/20191209094943.14984-71-tiwai@suse.de
	Signed-off-by: Takashi Iwai <tiwai@suse.de>
(cherry picked from commit 6dd9486ca9b8dde3a91e4c5231b8c83df27ba753)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	sound/usb/pcm.c
diff --cc sound/usb/pcm.c
index bccb2ff9cd72,7caaa04ae546..000000000000
--- a/sound/usb/pcm.c
+++ b/sound/usb/pcm.c
@@@ -780,13 -781,8 +780,18 @@@ static int snd_usb_hw_params(struct snd
  	struct audioformat *fmt;
  	int ret;
  
++<<<<<<< HEAD
 +	if (snd_usb_use_vmalloc)
 +		ret = snd_pcm_lib_alloc_vmalloc_buffer(substream,
 +						       params_buffer_bytes(hw_params));
 +	else
 +		ret = snd_pcm_lib_malloc_pages(substream,
 +					       params_buffer_bytes(hw_params));
 +	if (ret < 0)
++=======
+ 	ret = snd_media_start_pipeline(subs);
+ 	if (ret)
++>>>>>>> 6dd9486ca9b8 (ALSA: usb-audio: Use managed buffer allocation)
  		return ret;
  
  	subs->pcm_format = params_format(hw_params);
@@@ -844,10 -848,7 +849,14 @@@ static int snd_usb_hw_free(struct snd_p
  		snd_usb_unlock_shutdown(subs->stream->chip);
  	}
  
++<<<<<<< HEAD
 +	if (snd_usb_use_vmalloc)
 +		return snd_pcm_lib_free_vmalloc_buffer(substream);
 +	else
 +		return snd_pcm_lib_free_pages(substream);
++=======
+ 	return 0;
++>>>>>>> 6dd9486ca9b8 (ALSA: usb-audio: Use managed buffer allocation)
  }
  
  /*
@@@ -1818,7 -1797,10 +1827,16 @@@ void snd_usb_preallocate_buffer(struct 
  	struct snd_pcm_substream *s = pcm->streams[subs->direction].substream;
  	struct device *dev = subs->dev->bus->controller;
  
++<<<<<<< HEAD
 +	if (!snd_usb_use_vmalloc)
 +		snd_pcm_lib_preallocate_pages(s, SNDRV_DMA_TYPE_DEV_SG,
 +					      dev, 64*1024, 512*1024);
++=======
+ 	if (snd_usb_use_vmalloc)
+ 		snd_pcm_set_managed_buffer(s, SNDRV_DMA_TYPE_VMALLOC,
+ 					   NULL, 0, 0);
+ 	else
+ 		snd_pcm_set_managed_buffer(s, SNDRV_DMA_TYPE_DEV_SG,
+ 					   dev, 64*1024, 512*1024);
++>>>>>>> 6dd9486ca9b8 (ALSA: usb-audio: Use managed buffer allocation)
  }
* Unmerged path sound/usb/pcm.c
