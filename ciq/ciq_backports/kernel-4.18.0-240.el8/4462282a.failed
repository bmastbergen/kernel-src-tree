drm/amd/display: handle failed allocation during stream construction

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Josip Pavic <Josip.Pavic@amd.com>
commit 4462282a7253e3663790f8ab092a4107d905bd76
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/4462282a.failed

[Why]
Failing to allocate a transfer function during stream construction leads
to a null pointer dereference

[How]
Handle the failed allocation by failing the stream construction

	Cc: stable@vger.kernel.org
	Signed-off-by: Josip Pavic <Josip.Pavic@amd.com>
	Reviewed-by: Aric Cyr <Aric.Cyr@amd.com>
	Acked-by: Rodrigo Siqueira <Rodrigo.Siqueira@amd.com>
	Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
(cherry picked from commit 4462282a7253e3663790f8ab092a4107d905bd76)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/gpu/drm/amd/display/dc/core/dc_stream.c
diff --cc drivers/gpu/drm/amd/display/dc/core/dc_stream.c
index 6328ba4cefeb,d6989d115c5c..000000000000
--- a/drivers/gpu/drm/amd/display/dc/core/dc_stream.c
+++ b/drivers/gpu/drm/amd/display/dc/core/dc_stream.c
@@@ -58,7 -56,7 +58,11 @@@ void update_stream_signal(struct dc_str
  	}
  }
  
++<<<<<<< HEAD
 +static void construct(struct dc_stream_state *stream,
++=======
+ static bool dc_stream_construct(struct dc_stream_state *stream,
++>>>>>>> 4462282a7253 (drm/amd/display: handle failed allocation during stream construction)
  	struct dc_sink *dc_sink_data)
  {
  	uint32_t i = 0;
@@@ -127,9 -127,11 +135,11 @@@
  
  	stream->stream_id = stream->ctx->dc_stream_id_count;
  	stream->ctx->dc_stream_id_count++;
+ 
+ 	return true;
  }
  
 -static void dc_stream_destruct(struct dc_stream_state *stream)
 +static void destruct(struct dc_stream_state *stream)
  {
  	dc_sink_release(stream->sink);
  	if (stream->out_transfer_func != NULL) {
@@@ -168,9 -170,10 +178,14 @@@ struct dc_stream_state *dc_create_strea
  
  	stream = kzalloc(sizeof(struct dc_stream_state), GFP_KERNEL);
  	if (stream == NULL)
- 		return NULL;
+ 		goto alloc_fail;
  
++<<<<<<< HEAD
 +	construct(stream, sink);
++=======
+ 	if (dc_stream_construct(stream, sink) == false)
+ 		goto construct_fail;
++>>>>>>> 4462282a7253 (drm/amd/display: handle failed allocation during stream construction)
  
  	kref_init(&stream->refcount);
  
* Unmerged path drivers/gpu/drm/amd/display/dc/core/dc_stream.c
