intel_idle: Refactor intel_idle_cpuidle_driver_init()

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Rafael J. Wysocki <rafael.j.wysocki@intel.com>
commit 9f3d6daf61e5156139cd05643f7f1c2a9b7b49b0
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/9f3d6daf.failed

Move the C-state verification and checks from
intel_idle_cpuidle_driver_init() to a separate function,
intel_idle_verify_cstate(), and make the former call it after
checking the CPUIDLE_FLAG_UNUSABLE state flag.

Also combine the drv->states[] updates with the incrementation of
drv->state_count.

No intentional functional impact.

	Signed-off-by: Rafael J. Wysocki <rafael.j.wysocki@intel.com>
(cherry picked from commit 9f3d6daf61e5156139cd05643f7f1c2a9b7b49b0)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/idle/intel_idle.c
diff --cc drivers/idle/intel_idle.c
index 076189997131,47255d3cf51f..000000000000
--- a/drivers/idle/intel_idle.c
+++ b/drivers/idle/intel_idle.c
@@@ -1355,19 -1359,8 +1371,24 @@@ static void __init intel_idle_cpuidle_d
  			break;
  		}
  
++<<<<<<< HEAD
 +		mwait_hint = flg2MWAIT(cpuidle_state_table[cstate].flags);
 +		mwait_cstate = MWAIT_HINT2CSTATE(mwait_hint);
 +
 +		/* number of sub-states for this state in CPUID.MWAIT */
 +		num_substates = (mwait_substates >> ((mwait_cstate + 1) * 4))
 +					& MWAIT_SUBSTATE_MASK;
 +
 +		/* if NO sub-states for this state in CPUID, skip it */
 +		if (num_substates == 0)
 +			continue;
 +
 +		/* if state marked as disabled, skip it */
 +		if (cpuidle_state_table[cstate].disabled != 0) {
++=======
+ 		/* If marked as unusable, skip this state. */
+ 		if (cpuidle_state_table[cstate].flags & CPUIDLE_FLAG_UNUSABLE) {
++>>>>>>> 9f3d6daf61e5 (intel_idle: Refactor intel_idle_cpuidle_driver_init())
  			pr_debug("state %s is disabled\n",
  				 cpuidle_state_table[cstate].name);
  			continue;
* Unmerged path drivers/idle/intel_idle.c
