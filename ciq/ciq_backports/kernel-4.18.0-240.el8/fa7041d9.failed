drm/amd/display: Fix ineffective setting of max bpc property

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Stylon Wang <stylon.wang@amd.com>
commit fa7041d9d2fc7401cece43f305eb5b87b7017fc4
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/fa7041d9.failed

[Why]
Regression was introduced where setting max bpc property has no effect
on the atomic check and final commit. It has the same effect as max bpc
being stuck at 8.

[How]
Correctly propagate max bpc with the new connector state.

	Signed-off-by: Stylon Wang <stylon.wang@amd.com>
	Reviewed-by: Nicholas Kazlauskas <Nicholas.Kazlauskas@amd.com>
	Acked-by: Rodrigo Siqueira <Rodrigo.Siqueira@amd.com>
	Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
	Cc: stable@vger.kernel.org
(cherry picked from commit fa7041d9d2fc7401cece43f305eb5b87b7017fc4)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.c
diff --cc drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.c
index 3a8489bf308b,10ac8076d4f2..000000000000
--- a/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.c
+++ b/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.c
@@@ -4040,6 -5015,47 +4040,50 @@@ static void handle_edid_mgmt(struct amd
  	create_eml_sink(aconnector);
  }
  
++<<<<<<< HEAD
++=======
+ static struct dc_stream_state *
+ create_validate_stream_for_sink(struct amdgpu_dm_connector *aconnector,
+ 				const struct drm_display_mode *drm_mode,
+ 				const struct dm_connector_state *dm_state,
+ 				const struct dc_stream_state *old_stream)
+ {
+ 	struct drm_connector *connector = &aconnector->base;
+ 	struct amdgpu_device *adev = connector->dev->dev_private;
+ 	struct dc_stream_state *stream;
+ 	const struct drm_connector_state *drm_state = dm_state ? &dm_state->base : NULL;
+ 	int requested_bpc = drm_state ? drm_state->max_requested_bpc : 8;
+ 	enum dc_status dc_result = DC_OK;
+ 
+ 	do {
+ 		stream = create_stream_for_sink(aconnector, drm_mode,
+ 						dm_state, old_stream,
+ 						requested_bpc);
+ 		if (stream == NULL) {
+ 			DRM_ERROR("Failed to create stream for sink!\n");
+ 			break;
+ 		}
+ 
+ 		dc_result = dc_validate_stream(adev->dm.dc, stream);
+ 
+ 		if (dc_result != DC_OK) {
+ 			DRM_DEBUG_KMS("Mode %dx%d (clk %d) failed DC validation with error %d\n",
+ 				      drm_mode->hdisplay,
+ 				      drm_mode->vdisplay,
+ 				      drm_mode->clock,
+ 				      dc_result);
+ 
+ 			dc_stream_release(stream);
+ 			stream = NULL;
+ 			requested_bpc -= 2; /* lower bpc to retry validation */
+ 		}
+ 
+ 	} while (stream == NULL && requested_bpc >= 6);
+ 
+ 	return stream;
+ }
+ 
++>>>>>>> fa7041d9d2fc (drm/amd/display: Fix ineffective setting of max bpc property)
  enum drm_mode_status amdgpu_dm_connector_mode_valid(struct drm_connector *connector,
  				   struct drm_display_mode *mode)
  {
* Unmerged path drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.c
