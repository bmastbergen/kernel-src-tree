SUNRPC: Capture signalled RPC tasks

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Chuck Lever <chuck.lever@oracle.com>
commit abf8af78a61523c15d366228b4a598141208a264
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/abf8af78.failed

	Signed-off-by: Chuck Lever <chuck.lever@oracle.com>
	Signed-off-by: Anna Schumaker <Anna.Schumaker@Netapp.com>
(cherry picked from commit abf8af78a61523c15d366228b4a598141208a264)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/sunrpc/sched.c
diff --cc net/sunrpc/sched.c
index be8f07b36be1,55e900255b0c..000000000000
--- a/net/sunrpc/sched.c
+++ b/net/sunrpc/sched.c
@@@ -841,6 -840,21 +841,24 @@@ void rpc_exit_task(struct rpc_task *tas
  	}
  }
  
++<<<<<<< HEAD
++=======
+ void rpc_signal_task(struct rpc_task *task)
+ {
+ 	struct rpc_wait_queue *queue;
+ 
+ 	if (!RPC_IS_ACTIVATED(task))
+ 		return;
+ 
+ 	trace_rpc_task_signalled(task, task->tk_action);
+ 	set_bit(RPC_TASK_SIGNALLED, &task->tk_runstate);
+ 	smp_mb__after_atomic();
+ 	queue = READ_ONCE(task->tk_waitqueue);
+ 	if (queue)
+ 		rpc_wake_up_queued_task_set_status(queue, task, -ERESTARTSYS);
+ }
+ 
++>>>>>>> abf8af78a615 (SUNRPC: Capture signalled RPC tasks)
  void rpc_exit(struct rpc_task *task, int status)
  {
  	task->tk_status = status;
@@@ -928,8 -951,9 +946,14 @@@ static void __rpc_execute(struct rpc_ta
  			 * clean up after sleeping on some queue, we don't
  			 * break the loop here, but go around once more.
  			 */
++<<<<<<< HEAD
 +			dprintk("RPC: %5u got signal\n", task->tk_pid);
 +			task->tk_flags |= RPC_TASK_KILLED;
++=======
+ 			trace_rpc_task_signalled(task, task->tk_action);
+ 			set_bit(RPC_TASK_SIGNALLED, &task->tk_runstate);
+ 			task->tk_rpc_status = -ERESTARTSYS;
++>>>>>>> abf8af78a615 (SUNRPC: Capture signalled RPC tasks)
  			rpc_exit(task, -ERESTARTSYS);
  		}
  		dprintk("RPC: %5u sync task resuming\n", task->tk_pid);
diff --git a/include/trace/events/sunrpc.h b/include/trace/events/sunrpc.h
index 761f86c39a38..fb78acef7840 100644
--- a/include/trace/events/sunrpc.h
+++ b/include/trace/events/sunrpc.h
@@ -228,6 +228,7 @@ DECLARE_EVENT_CLASS(rpc_task_running,
 DEFINE_RPC_RUNNING_EVENT(begin);
 DEFINE_RPC_RUNNING_EVENT(run_action);
 DEFINE_RPC_RUNNING_EVENT(complete);
+DEFINE_RPC_RUNNING_EVENT(signalled);
 DEFINE_RPC_RUNNING_EVENT(end);
 
 DECLARE_EVENT_CLASS(rpc_task_queued,
* Unmerged path net/sunrpc/sched.c
