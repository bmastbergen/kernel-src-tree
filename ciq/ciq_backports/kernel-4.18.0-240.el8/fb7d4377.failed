KVM: x86: handle GBPAGE CPUID adjustment for EPT with generic code

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Paolo Bonzini <pbonzini@redhat.com>
commit fb7d4377d513145303c1d0a192cb4b33d72be2d9
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/fb7d4377.failed

The clearing of the GBPAGE CPUID bit for VMX is wrong; support for 1GB
pages in EPT has no relationship to whether 1GB pages should be marked as
supported in CPUID.  This has no ill effect because we're only clearing
the bit, but we're not marking 1GB pages as available when EPT is disabled
(even though they are actually supported thanks to shadowing).  Instead,
forcibly enable 1GB pages in the shadow paging case.

This also eliminates an instance of the undesirable "unsigned f_* =
*_supported ? F(*) : 0" pattern in the common CPUID handling code,
and paves the way toward eliminating ->get_lpage_level().

	Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
(cherry picked from commit fb7d4377d513145303c1d0a192cb4b33d72be2d9)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kvm/cpuid.c
diff --cc arch/x86/kvm/cpuid.c
index d4472786ed92,aeab6573fe0f..000000000000
--- a/arch/x86/kvm/cpuid.c
+++ b/arch/x86/kvm/cpuid.c
@@@ -733,9 -681,11 +732,15 @@@ static inline int __do_cpuid_func(struc
  		break;
  	case 0x80000001:
  		entry->edx &= kvm_cpuid_8000_0001_edx_x86_features;
++<<<<<<< HEAD
 +		cpuid_mask(&entry->edx, CPUID_8000_0001_EDX);
++=======
+ 		cpuid_entry_mask(entry, CPUID_8000_0001_EDX);
+ 		if (!tdp_enabled)
+ 			cpuid_entry_set(entry, X86_FEATURE_GBPAGES);
++>>>>>>> fb7d4377d513 (KVM: x86: handle GBPAGE CPUID adjustment for EPT with generic code)
  		entry->ecx &= kvm_cpuid_8000_0001_ecx_x86_features;
 -		cpuid_entry_mask(entry, CPUID_8000_0001_ECX);
 +		cpuid_mask(&entry->ecx, CPUID_8000_0001_ECX);
  		break;
  	case 0x80000007: /* Advanced power management */
  		/* invariant TSC is CPUID.80000007H:EDX[8] */
* Unmerged path arch/x86/kvm/cpuid.c
