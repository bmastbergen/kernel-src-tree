drm/ttm: Fix dma_fence refcnt leak in ttm_bo_vm_fault_reserved

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Xiyu Yang <xiyuyang19@fudan.edu.cn>
commit 37cc4b95d13f311c04aa8e9daacca3905ad45ca7
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/37cc4b95.failed

ttm_bo_vm_fault_reserved() invokes dma_fence_get(), which returns a
reference of the specified dma_fence object to "moving" with increased
refcnt.

When ttm_bo_vm_fault_reserved() returns, local variable "moving" becomes
invalid, so the refcount should be decreased to keep refcount balanced.

The reference counting issue happens in several exception handling paths
of ttm_bo_vm_fault_reserved(). When those error scenarios occur such as
"err" equals to -EBUSY, the function forgets to decrease the refcnt
increased by dma_fence_get(), causing a refcnt leak.

Fix this issue by calling dma_fence_put() when no_wait_gpu flag is
equals to true.

	Signed-off-by: Xiyu Yang <xiyuyang19@fudan.edu.cn>
	Signed-off-by: Xin Tan <tanxin.ctf@gmail.com>
	Reviewed-by: Christian König <christian.koenig@amd.com>
Link: https://patchwork.freedesktop.org/patch/370219/
	Signed-off-by: Christian König <christian.koenig@amd.com>
(cherry picked from commit 37cc4b95d13f311c04aa8e9daacca3905ad45ca7)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/gpu/drm/ttm/ttm_bo_vm.c
diff --cc drivers/gpu/drm/ttm/ttm_bo_vm.c
index a77cd0344d22,72100b84c7a9..000000000000
--- a/drivers/gpu/drm/ttm/ttm_bo_vm.c
+++ b/drivers/gpu/drm/ttm/ttm_bo_vm.c
@@@ -169,11 -300,11 +169,19 @@@ static vm_fault_t ttm_bo_vm_fault(struc
  			break;
  		case -EBUSY:
  		case -ERESTARTSYS:
++<<<<<<< HEAD
 +			ret = VM_FAULT_NOPAGE;
 +			goto out_unlock;
 +		default:
 +			ret = VM_FAULT_SIGBUS;
 +			goto out_unlock;
++=======
+ 			dma_fence_put(moving);
+ 			return VM_FAULT_NOPAGE;
+ 		default:
+ 			dma_fence_put(moving);
+ 			return VM_FAULT_SIGBUS;
++>>>>>>> 37cc4b95d13f (drm/ttm: Fix dma_fence refcnt leak in ttm_bo_vm_fault_reserved)
  		}
  
  		if (bo->moving != moving) {
* Unmerged path drivers/gpu/drm/ttm/ttm_bo_vm.c
