drm/i915/icl+: Don't enable DDI IO power on a TypeC port in TBT mode

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Imre Deak <imre.deak@intel.com>
commit f77a2db27f26c3ccba0681f7e89fef083718f07f
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/f77a2db2.failed

The DDI IO power well must not be enabled for a TypeC port in TBT mode,
ensure this during driver loading/system resume.

This gets rid of error messages like
[drm] *ERROR* power well DDI E TC2 IO state mismatch (refcount 1/enabled 0)

and avoids leaking the power ref when disabling the output.

	Cc: <stable@vger.kernel.org> # v5.4+
	Signed-off-by: Imre Deak <imre.deak@intel.com>
	Reviewed-by: Jos√© Roberto de Souza <jose.souza@intel.com>
Link: https://patchwork.freedesktop.org/patch/msgid/20200330152244.11316-1-imre.deak@intel.com
(cherry picked from commit f77a2db27f26c3ccba0681f7e89fef083718f07f)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/gpu/drm/i915/display/intel_ddi.c
diff --cc drivers/gpu/drm/i915/display/intel_ddi.c
index fd58aa20d02e,654151d9a6db..000000000000
--- a/drivers/gpu/drm/i915/display/intel_ddi.c
+++ b/drivers/gpu/drm/i915/display/intel_ddi.c
@@@ -2091,11 -1894,16 +2091,20 @@@ static void intel_ddi_get_power_domains
  	 * happen since fake-MST encoders don't set their get_power_domains()
  	 * hook.
  	 */
 -	if (drm_WARN_ON(&dev_priv->drm,
 -			intel_crtc_has_type(crtc_state, INTEL_OUTPUT_DP_MST)))
 +	if (WARN_ON(intel_crtc_has_type(crtc_state, INTEL_OUTPUT_DP_MST)))
  		return;
  
++<<<<<<< HEAD
 +	dig_port = enc_to_dig_port(&encoder->base);
 +	intel_display_power_get(dev_priv, dig_port->ddi_io_power_domain);
++=======
+ 	dig_port = enc_to_dig_port(encoder);
+ 
+ 	if (!intel_phy_is_tc(dev_priv, phy) ||
+ 	    dig_port->tc_mode != TC_PORT_TBT_ALT)
+ 		intel_display_power_get(dev_priv,
+ 					dig_port->ddi_io_power_domain);
++>>>>>>> f77a2db27f26 (drm/i915/icl+: Don't enable DDI IO power on a TypeC port in TBT mode)
  
  	/*
  	 * AUX power is only needed for (e)DP mode, and for HDMI mode on TC
* Unmerged path drivers/gpu/drm/i915/display/intel_ddi.c
