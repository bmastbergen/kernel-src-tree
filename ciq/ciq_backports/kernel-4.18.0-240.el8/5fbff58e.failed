selftests: netdevsim: Add test cases for devlink-trap policers

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Ido Schimmel <idosch@mellanox.com>
commit 5fbff58e27a16abd8213671ff73ec866629c5fdf
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/5fbff58e.failed

Add test cases for packet trap policer set / show commands as well as
for the binding of these policers to packet trap groups.

Both good and bad flows are tested for maximum coverage.

v2:
* Add test case with new 'fail_trap_policer_set' knob
* Add test case for partially modified trap group

	Signed-off-by: Ido Schimmel <idosch@mellanox.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 5fbff58e27a16abd8213671ff73ec866629c5fdf)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/testing/selftests/net/forwarding/devlink_lib.sh
diff --cc tools/testing/selftests/net/forwarding/devlink_lib.sh
index 13d03a6d85ba,c48645a344e2..000000000000
--- a/tools/testing/selftests/net/forwarding/devlink_lib.sh
+++ b/tools/testing/selftests/net/forwarding/devlink_lib.sh
@@@ -355,3 -361,114 +355,117 @@@ devlink_trap_group_stats_idle_test(
  		return 1
  	fi
  }
++<<<<<<< HEAD
++=======
+ 
+ devlink_trap_exception_test()
+ {
+ 	local trap_name=$1; shift
+ 	local group_name=$1; shift
+ 
+ 	devlink_trap_stats_idle_test $trap_name
+ 	check_fail $? "Trap stats idle when packets should have been trapped"
+ 
+ 	devlink_trap_group_stats_idle_test $group_name
+ 	check_fail $? "Trap group idle when packets should have been trapped"
+ }
+ 
+ devlink_trap_drop_test()
+ {
+ 	local trap_name=$1; shift
+ 	local group_name=$1; shift
+ 	local dev=$1; shift
+ 	local handle=$1; shift
+ 
+ 	# This is the common part of all the tests. It checks that stats are
+ 	# initially idle, then non-idle after changing the trap action and
+ 	# finally idle again. It also makes sure the packets are dropped and
+ 	# never forwarded.
+ 	devlink_trap_stats_idle_test $trap_name
+ 	check_err $? "Trap stats not idle with initial drop action"
+ 	devlink_trap_group_stats_idle_test $group_name
+ 	check_err $? "Trap group stats not idle with initial drop action"
+ 
+ 
+ 	devlink_trap_action_set $trap_name "trap"
+ 	devlink_trap_stats_idle_test $trap_name
+ 	check_fail $? "Trap stats idle after setting action to trap"
+ 	devlink_trap_group_stats_idle_test $group_name
+ 	check_fail $? "Trap group stats idle after setting action to trap"
+ 
+ 	devlink_trap_action_set $trap_name "drop"
+ 
+ 	devlink_trap_stats_idle_test $trap_name
+ 	check_err $? "Trap stats not idle after setting action to drop"
+ 	devlink_trap_group_stats_idle_test $group_name
+ 	check_err $? "Trap group stats not idle after setting action to drop"
+ 
+ 	tc_check_packets "dev $dev egress" $handle 0
+ 	check_err $? "Packets were not dropped"
+ }
+ 
+ devlink_trap_drop_cleanup()
+ {
+ 	local mz_pid=$1; shift
+ 	local dev=$1; shift
+ 	local proto=$1; shift
+ 	local pref=$1; shift
+ 	local handle=$1; shift
+ 
+ 	kill $mz_pid && wait $mz_pid &> /dev/null
+ 	tc filter del dev $dev egress protocol $proto pref $pref handle $handle flower
+ }
+ 
+ devlink_trap_policers_num_get()
+ {
+ 	devlink -j -p trap policer show | jq '.[]["'$DEVLINK_DEV'"] | length'
+ }
+ 
+ devlink_trap_policer_rate_get()
+ {
+ 	local policer_id=$1; shift
+ 
+ 	devlink -j -p trap policer show $DEVLINK_DEV policer $policer_id \
+ 		| jq '.[][][]["rate"]'
+ }
+ 
+ devlink_trap_policer_burst_get()
+ {
+ 	local policer_id=$1; shift
+ 
+ 	devlink -j -p trap policer show $DEVLINK_DEV policer $policer_id \
+ 		| jq '.[][][]["burst"]'
+ }
+ 
+ devlink_trap_policer_rx_dropped_get()
+ {
+ 	local policer_id=$1; shift
+ 
+ 	devlink -j -p -s trap policer show $DEVLINK_DEV policer $policer_id \
+ 		| jq '.[][][]["stats"]["rx"]["dropped"]'
+ }
+ 
+ devlink_trap_group_policer_get()
+ {
+ 	local group_name=$1; shift
+ 
+ 	devlink -j -p trap group show $DEVLINK_DEV group $group_name \
+ 		| jq '.[][][]["policer"]'
+ }
+ 
+ devlink_port_by_netdev()
+ {
+ 	local if_name=$1
+ 
+ 	devlink -j port show $if_name | jq -e '.[] | keys' | jq -r '.[]'
+ }
+ 
+ devlink_cpu_port_get()
+ {
+ 	local cpu_dl_port_num=$(devlink port list | grep "$DEVLINK_DEV" |
+ 				grep cpu | cut -d/ -f3 | cut -d: -f1 |
+ 				sed -n '1p')
+ 
+ 	echo "$DEVLINK_DEV/$cpu_dl_port_num"
+ }
++>>>>>>> 5fbff58e27a1 (selftests: netdevsim: Add test cases for devlink-trap policers)
diff --git a/tools/testing/selftests/drivers/net/netdevsim/devlink_trap.sh b/tools/testing/selftests/drivers/net/netdevsim/devlink_trap.sh
index 437d32bd4cfd..dbd1e014ba17 100755
--- a/tools/testing/selftests/drivers/net/netdevsim/devlink_trap.sh
+++ b/tools/testing/selftests/drivers/net/netdevsim/devlink_trap.sh
@@ -16,6 +16,8 @@ ALL_TESTS="
 	trap_group_action_test
 	bad_trap_group_test
 	trap_group_stats_test
+	trap_policer_test
+	trap_policer_bind_test
 	port_del_test
 	dev_del_test
 "
@@ -23,6 +25,7 @@ NETDEVSIM_PATH=/sys/bus/netdevsim/
 DEV_ADDR=1337
 DEV=netdevsim${DEV_ADDR}
 DEVLINK_DEV=netdevsim/${DEV}
+DEBUGFS_DIR=/sys/kernel/debug/netdevsim/$DEV/
 SLEEP_TIME=1
 NETDEV=""
 NUM_NETIFS=0
@@ -256,6 +259,119 @@ trap_group_stats_test()
 	log_test "Trap group statistics"
 }
 
+trap_policer_test()
+{
+	local packets_t0
+	local packets_t1
+
+	if [ $(devlink_trap_policers_num_get) -eq 0 ]; then
+		check_err 1 "Failed to dump policers"
+	fi
+
+	devlink trap policer set $DEVLINK_DEV policer 1337 &> /dev/null
+	check_fail $? "Did not get an error for setting a non-existing policer"
+	devlink trap policer show $DEVLINK_DEV policer 1337 &> /dev/null
+	check_fail $? "Did not get an error for getting a non-existing policer"
+
+	devlink trap policer set $DEVLINK_DEV policer 1 rate 2000 burst 16
+	check_err $? "Failed to set valid parameters for a valid policer"
+	if [ $(devlink_trap_policer_rate_get 1) -ne 2000 ]; then
+		check_err 1 "Policer rate was not changed"
+	fi
+	if [ $(devlink_trap_policer_burst_get 1) -ne 16 ]; then
+		check_err 1 "Policer burst size was not changed"
+	fi
+
+	devlink trap policer set $DEVLINK_DEV policer 1 rate 0 &> /dev/null
+	check_fail $? "Policer rate was changed to rate lower than limit"
+	devlink trap policer set $DEVLINK_DEV policer 1 rate 9000 &> /dev/null
+	check_fail $? "Policer rate was changed to rate higher than limit"
+	devlink trap policer set $DEVLINK_DEV policer 1 burst 2 &> /dev/null
+	check_fail $? "Policer burst size was changed to burst size lower than limit"
+	devlink trap policer set $DEVLINK_DEV policer 1 rate 65537 &> /dev/null
+	check_fail $? "Policer burst size was changed to burst size higher than limit"
+	echo "y" > $DEBUGFS_DIR/fail_trap_policer_set
+	devlink trap policer set $DEVLINK_DEV policer 1 rate 3000 &> /dev/null
+	check_fail $? "Managed to set policer rate when should not"
+	echo "n" > $DEBUGFS_DIR/fail_trap_policer_set
+	if [ $(devlink_trap_policer_rate_get 1) -ne 2000 ]; then
+		check_err 1 "Policer rate was changed to an invalid value"
+	fi
+	if [ $(devlink_trap_policer_burst_get 1) -ne 16 ]; then
+		check_err 1 "Policer burst size was changed to an invalid value"
+	fi
+
+	packets_t0=$(devlink_trap_policer_rx_dropped_get 1)
+	sleep .5
+	packets_t1=$(devlink_trap_policer_rx_dropped_get 1)
+	if [ ! $packets_t1 -gt $packets_t0 ]; then
+		check_err 1 "Policer drop counter was not incremented"
+	fi
+
+	echo "y"> $DEBUGFS_DIR/fail_trap_policer_counter_get
+	devlink -s trap policer show $DEVLINK_DEV policer 1 &> /dev/null
+	check_fail $? "Managed to read policer drop counter when should not"
+	echo "n"> $DEBUGFS_DIR/fail_trap_policer_counter_get
+	devlink -s trap policer show $DEVLINK_DEV policer 1 &> /dev/null
+	check_err $? "Did not manage to read policer drop counter when should"
+
+	log_test "Trap policer"
+}
+
+trap_group_check_policer()
+{
+	local group_name=$1; shift
+
+	devlink -j -p trap group show $DEVLINK_DEV group $group_name \
+		| jq -e '.[][][]["policer"]' &> /dev/null
+}
+
+trap_policer_bind_test()
+{
+	devlink trap group set $DEVLINK_DEV group l2_drops policer 1
+	check_err $? "Failed to bind a valid policer"
+	if [ $(devlink_trap_group_policer_get "l2_drops") -ne 1 ]; then
+		check_err 1 "Bound policer was not changed"
+	fi
+
+	devlink trap group set $DEVLINK_DEV group l2_drops policer 1337 \
+		&> /dev/null
+	check_fail $? "Did not get an error for binding a non-existing policer"
+	if [ $(devlink_trap_group_policer_get "l2_drops") -ne 1 ]; then
+		check_err 1 "Bound policer was changed when should not"
+	fi
+
+	devlink trap group set $DEVLINK_DEV group l2_drops policer 0
+	check_err $? "Failed to unbind a policer when using ID 0"
+	trap_group_check_policer "l2_drops"
+	check_fail $? "Trap group has a policer after unbinding with ID 0"
+
+	devlink trap group set $DEVLINK_DEV group l2_drops policer 1
+	check_err $? "Failed to bind a valid policer"
+
+	devlink trap group set $DEVLINK_DEV group l2_drops nopolicer
+	check_err $? "Failed to unbind a policer when using 'nopolicer' keyword"
+	trap_group_check_policer "l2_drops"
+	check_fail $? "Trap group has a policer after unbinding with 'nopolicer' keyword"
+
+	devlink trap group set $DEVLINK_DEV group l2_drops policer 1
+	check_err $? "Failed to bind a valid policer"
+
+	echo "y"> $DEBUGFS_DIR/fail_trap_group_set
+	devlink trap group set $DEVLINK_DEV group l2_drops policer 2 \
+		&> /dev/null
+	check_fail $? "Managed to bind a policer when should not"
+	echo "n"> $DEBUGFS_DIR/fail_trap_group_set
+	devlink trap group set $DEVLINK_DEV group l2_drops policer 2
+	check_err $? "Did not manage to bind a policer when should"
+
+	devlink trap group set $DEVLINK_DEV group l2_drops action drop \
+		policer 1337 &> /dev/null
+	check_fail $? "Did not get an error for partially modified trap group"
+
+	log_test "Trap policer binding"
+}
+
 port_del_test()
 {
 	local group_name
* Unmerged path tools/testing/selftests/net/forwarding/devlink_lib.sh
