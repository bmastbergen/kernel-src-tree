openvswitch: Add timeout support to ct action

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Yi-Hung Wei <yihung.wei@gmail.com>
commit 06bd2bdf19d2f3d22731625e1a47fa1dff5ac407
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/06bd2bdf.failed

Add support for fine-grain timeout support to conntrack action.
The new OVS_CT_ATTR_TIMEOUT attribute of the conntrack action
specifies a timeout to be associated with this connection.
If no timeout is specified, it acts as is, that is the default
timeout for the connection will be automatically applied.

Example usage:
$ nfct timeout add timeout_1 inet tcp syn_sent 100 established 200
$ ovs-ofctl add-flow br0 in_port=1,ip,tcp,action=ct(commit,timeout=timeout_1)

CC: Pravin Shelar <pshelar@ovn.org>
CC: Pablo Neira Ayuso <pablo@netfilter.org>
	Signed-off-by: Yi-Hung Wei <yihung.wei@gmail.com>
	Acked-by: Pravin B Shelar <pshelar@ovn.org>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 06bd2bdf19d2f3d22731625e1a47fa1dff5ac407)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/openvswitch/conntrack.c
diff --cc net/openvswitch/conntrack.c
index edb57c07c767,121b01d4a3c0..000000000000
--- a/net/openvswitch/conntrack.c
+++ b/net/openvswitch/conntrack.c
@@@ -1815,15 -1801,13 +1840,22 @@@ void ovs_ct_free_action(const struct nl
  
  static void __ovs_ct_free_action(struct ovs_conntrack_info *ct_info)
  {
 -	if (ct_info->helper)
 +	if (ct_info->helper) {
 +#ifdef CONFIG_NF_NAT_NEEDED
 +		if (ct_info->nat)
 +			nf_nat_helper_put(ct_info->helper);
 +#endif
  		nf_conntrack_helper_put(ct_info->helper);
++<<<<<<< HEAD
 +	}
 +	if (ct_info->ct)
++=======
+ 	if (ct_info->ct) {
++>>>>>>> 06bd2bdf19d2 (openvswitch: Add timeout support to ct action)
  		nf_ct_tmpl_free(ct_info->ct);
+ 		if (ct_info->timeout[0])
+ 			nf_ct_destroy_timeout(ct_info->ct);
+ 	}
  }
  
  #if	IS_ENABLED(CONFIG_NETFILTER_CONNCOUNT)
diff --git a/include/uapi/linux/openvswitch.h b/include/uapi/linux/openvswitch.h
index 292e821b9a11..a87b44cd5590 100644
--- a/include/uapi/linux/openvswitch.h
+++ b/include/uapi/linux/openvswitch.h
@@ -740,6 +740,7 @@ struct ovs_action_hash {
  * be received on NFNLGRP_CONNTRACK_NEW and NFNLGRP_CONNTRACK_DESTROY groups,
  * respectively.  Remaining bits control the changes for which an event is
  * delivered on the NFNLGRP_CONNTRACK_UPDATE group.
+ * @OVS_CT_ATTR_TIMEOUT: Variable length string defining conntrack timeout.
  */
 enum ovs_ct_attr {
 	OVS_CT_ATTR_UNSPEC,
@@ -752,6 +753,8 @@ enum ovs_ct_attr {
 	OVS_CT_ATTR_NAT,        /* Nested OVS_NAT_ATTR_* */
 	OVS_CT_ATTR_FORCE_COMMIT,  /* No argument */
 	OVS_CT_ATTR_EVENTMASK,  /* u32 mask of IPCT_* events. */
+	OVS_CT_ATTR_TIMEOUT,	/* Associate timeout with this connection for
+				 * fine-grain timeout tuning. */
 	__OVS_CT_ATTR_MAX
 };
 
* Unmerged path net/openvswitch/conntrack.c
