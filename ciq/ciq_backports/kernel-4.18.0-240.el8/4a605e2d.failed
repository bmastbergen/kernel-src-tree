powerpc/dma: trim the fat from <asm/dma-mapping.h>

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Christoph Hellwig <hch@lst.de>
commit 4a605e2d1a69f5aea06da10d81e22802a90812a3
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/4a605e2d.failed

There is no need to provide anything but get_arch_dma_ops to
<linux/dma-mapping.h>.  More the remaining declarations to <asm/iommu.h>
and drop all the includes.

	Signed-off-by: Christoph Hellwig <hch@lst.de>
	Tested-by: Christian Zigotzky <chzigotzky@xenosoft.de>
	Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
(cherry picked from commit 4a605e2d1a69f5aea06da10d81e22802a90812a3)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/powerpc/include/asm/dma-mapping.h
diff --cc arch/powerpc/include/asm/dma-mapping.h
index 64d2dd3eb138,565d6f74b189..000000000000
--- a/arch/powerpc/include/asm/dma-mapping.h
+++ b/arch/powerpc/include/asm/dma-mapping.h
@@@ -4,43 -4,6 +4,43 @@@
   */
  #ifndef _ASM_DMA_MAPPING_H
  #define _ASM_DMA_MAPPING_H
++<<<<<<< HEAD
 +#ifdef __KERNEL__
 +
 +#include <linux/types.h>
 +#include <linux/cache.h>
 +/* need struct page definitions */
 +#include <linux/mm.h>
 +#include <linux/scatterlist.h>
 +#include <linux/dma-debug.h>
 +#include <asm/io.h>
 +#include <asm/swiotlb.h>
 +
 +/* Some dma direct funcs must be visible for use in other dma_ops */
 +extern void *__dma_nommu_alloc_coherent(struct device *dev, size_t size,
 +					 dma_addr_t *dma_handle, gfp_t flag,
 +					 unsigned long attrs);
 +extern void __dma_nommu_free_coherent(struct device *dev, size_t size,
 +				       void *vaddr, dma_addr_t dma_handle,
 +				       unsigned long attrs);
 +
 +static inline unsigned long device_to_mask(struct device *dev)
 +{
 +	if (dev->dma_mask && *dev->dma_mask)
 +		return *dev->dma_mask;
 +	/* Assume devices without mask can take 32 bit addresses */
 +	return 0xfffffffful;
 +}
 +
 +/*
 + * Available generic sets of operations
 + */
 +#ifdef CONFIG_PPC64
 +extern const struct dma_map_ops dma_iommu_ops;
 +#endif
 +extern const struct dma_map_ops dma_nommu_ops;
++=======
++>>>>>>> 4a605e2d1a69 (powerpc/dma: trim the fat from <asm/dma-mapping.h>)
  
  static inline const struct dma_map_ops *get_arch_dma_ops(struct bus_type *bus)
  {
@@@ -52,11 -15,4 +52,14 @@@
  	return NULL;
  }
  
++<<<<<<< HEAD
 +static inline void set_dma_offset(struct device *dev, dma_addr_t off)
 +{
 +	if (dev)
 +		dev->archdata.dma_offset = off;
 +}
 +
 +#endif /* __KERNEL__ */
++=======
++>>>>>>> 4a605e2d1a69 (powerpc/dma: trim the fat from <asm/dma-mapping.h>)
  #endif	/* _ASM_DMA_MAPPING_H */
* Unmerged path arch/powerpc/include/asm/dma-mapping.h
diff --git a/arch/powerpc/include/asm/iommu.h b/arch/powerpc/include/asm/iommu.h
index ea8ecde929f4..50c3eddea767 100644
--- a/arch/powerpc/include/asm/iommu.h
+++ b/arch/powerpc/include/asm/iommu.h
@@ -324,5 +324,15 @@ extern bool iommu_fixed_is_weak;
 #define iommu_fixed_is_weak false
 #endif
 
+extern const struct dma_map_ops dma_iommu_ops;
+
+static inline unsigned long device_to_mask(struct device *dev)
+{
+	if (dev->dma_mask && *dev->dma_mask)
+		return *dev->dma_mask;
+	/* Assume devices without mask can take 32 bit addresses */
+	return 0xfffffffful;
+}
+
 #endif /* __KERNEL__ */
 #endif /* _ASM_IOMMU_H */
diff --git a/arch/powerpc/platforms/44x/ppc476.c b/arch/powerpc/platforms/44x/ppc476.c
index e55933f9cd55..a5e61e5c16e2 100644
--- a/arch/powerpc/platforms/44x/ppc476.c
+++ b/arch/powerpc/platforms/44x/ppc476.c
@@ -34,6 +34,7 @@
 #include <asm/ppc4xx.h>
 #include <asm/mpic.h>
 #include <asm/mmu.h>
+#include <asm/swiotlb.h>
 
 #include <linux/pci.h>
 #include <linux/i2c.h>
diff --git a/arch/powerpc/platforms/85xx/corenet_generic.c b/arch/powerpc/platforms/85xx/corenet_generic.c
index b0dac307bebf..0ea13697189e 100644
--- a/arch/powerpc/platforms/85xx/corenet_generic.c
+++ b/arch/powerpc/platforms/85xx/corenet_generic.c
@@ -27,6 +27,7 @@
 #include <asm/udbg.h>
 #include <asm/mpic.h>
 #include <asm/ehv_pic.h>
+#include <asm/swiotlb.h>
 #include <soc/fsl/qe/qe_ic.h>
 
 #include <linux/of_platform.h>
diff --git a/arch/powerpc/platforms/85xx/qemu_e500.c b/arch/powerpc/platforms/85xx/qemu_e500.c
index 27631c607f3d..c52c8f9e8385 100644
--- a/arch/powerpc/platforms/85xx/qemu_e500.c
+++ b/arch/powerpc/platforms/85xx/qemu_e500.c
@@ -22,6 +22,7 @@
 #include <asm/time.h>
 #include <asm/udbg.h>
 #include <asm/mpic.h>
+#include <asm/swiotlb.h>
 #include <sysdev/fsl_soc.h>
 #include <sysdev/fsl_pci.h>
 #include "smp.h"
diff --git a/arch/powerpc/sysdev/fsl_pci.c b/arch/powerpc/sysdev/fsl_pci.c
index 0c6510f340cb..ecc64c1f2eb4 100644
--- a/arch/powerpc/sysdev/fsl_pci.c
+++ b/arch/powerpc/sysdev/fsl_pci.c
@@ -40,6 +40,7 @@
 #include <asm/mpc85xx.h>
 #include <asm/disassemble.h>
 #include <asm/ppc-opcode.h>
+#include <asm/swiotlb.h>
 #include <sysdev/fsl_soc.h>
 #include <sysdev/fsl_pci.h>
 
