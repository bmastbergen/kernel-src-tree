mmc: core: don't override the CD GPIO level when "cd-inverted" is set

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Martin Blumenstingl <martin.blumenstingl@googlemail.com>
commit e3e4767bd550b3f19278e42bcce143e0d2316ba2
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/e3e4767b.failed

Since commit 89a5e15bcba87d ("gpio/mmc/of: Respect polarity in the device
tree") gpiolib-of parses the "cd-gpios" property and flips the polarity
if "cd-inverted" is also set. This results in the "cd-inverted" property
being evaluated twice, which effectively makes it a no-op:
- first in drivers/gpio/gpiolib-of.c (of_xlate_and_get_gpiod_flags) when
  setting up the CD GPIO
- then again in drivers/mmc/core/slot-gpio.c (mmc_gpio_get_cd) when
  reading the CD GPIO value at runtime

On boards which are using device-tree with the "cd-inverted" property
being set any inserted card are not detected anymore. This is due to the
MMC core treating the CD GPIO with the wrong polarity.

Disable "override_cd_active_level" for the card detection GPIO which is
parsed using mmc_of_parse. This fixes SD card detection on the boards
which are currently using the "cd-inverted" device-tree property (tested
on Meson8b Odroid-C1 and Meson8b EC-100).

This does not remove the CD GPIO inversion logic from the MMC core
because there's at least one driver (sdhci-pci-core for Intel BayTrail
based boards) which still passes "override_cd_active_level = true" to
mmc_gpiod_request_cd(). Due to lack of hardware for testing this is left
untouched.
In the future the GPIO inversion logic for both, card and read-only
detection can be removed once no driver is using it anymore.

Fixes: 89a5e15bcba87d ("gpio/mmc/of: Respect polarity in the device tree")
	Signed-off-by: Martin Blumenstingl <martin.blumenstingl@googlemail.com>
	Tested-by: Anand Moon <linux.amoon@gmail.com>
	Tested-by: Loys Ollivier <loys.ollivier@gmail.com>
	Acked-by: Ulf Hansson <ulf.hansson@linaro.org>
	Signed-off-by: Linus Walleij <linus.walleij@linaro.org>
(cherry picked from commit e3e4767bd550b3f19278e42bcce143e0d2316ba2)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/mmc/core/host.c
diff --cc drivers/mmc/core/host.c
index abf9e884386c,cf58ccaf22d5..000000000000
--- a/drivers/mmc/core/host.c
+++ b/drivers/mmc/core/host.c
@@@ -234,8 -234,8 +234,13 @@@ int mmc_of_parse(struct mmc_host *host
  		if (device_property_read_bool(dev, "broken-cd"))
  			host->caps |= MMC_CAP_NEEDS_POLL;
  
++<<<<<<< HEAD
 +		ret = mmc_gpiod_request_cd(host, "cd", 0, true,
 +					   cd_debounce_delay_ms,
++=======
+ 		ret = mmc_gpiod_request_cd(host, "cd", 0, false,
+ 					   cd_debounce_delay_ms * 1000,
++>>>>>>> e3e4767bd550 (mmc: core: don't override the CD GPIO level when "cd-inverted" is set)
  					   &cd_gpio_invert);
  		if (!ret)
  			dev_info(host->parent, "Got CD GPIO\n");
* Unmerged path drivers/mmc/core/host.c
