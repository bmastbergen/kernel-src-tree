Bluetooth: prefetch channel before killing sock

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Hillf Danton <hdanton@sina.com>
commit 2a154903cec20fb64ff4d7d617ca53c16f8fd53a
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/2a154903.failed

Prefetch channel before killing sock in order to fix UAF like

 BUG: KASAN: use-after-free in l2cap_sock_release+0x24c/0x290 net/bluetooth/l2cap_sock.c:1212
 Read of size 8 at addr ffff8880944904a0 by task syz-fuzzer/9751

	Reported-by: syzbot+c3c5bdea7863886115dc@syzkaller.appspotmail.com
Fixes: 6c08fc896b60 ("Bluetooth: Fix refcount use-after-free issue")
	Cc: Manish Mandlik <mmandlik@google.com>
	Signed-off-by: Hillf Danton <hdanton@sina.com>
	Signed-off-by: Marcel Holtmann <marcel@holtmann.org>
(cherry picked from commit 2a154903cec20fb64ff4d7d617ca53c16f8fd53a)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/bluetooth/l2cap_sock.c
diff --cc net/bluetooth/l2cap_sock.c
index 686bdc6b35b0,390a9afab647..000000000000
--- a/net/bluetooth/l2cap_sock.c
+++ b/net/bluetooth/l2cap_sock.c
@@@ -1199,9 -1203,17 +1200,22 @@@ static int l2cap_sock_release(struct so
  	bt_sock_unlink(&l2cap_sk_list, sk);
  
  	err = l2cap_sock_shutdown(sock, 2);
+ 	chan = l2cap_pi(sk)->chan;
  
++<<<<<<< HEAD
 +	sock_orphan(sk);
 +	l2cap_sock_kill(sk);
++=======
+ 	l2cap_chan_hold(chan);
+ 	l2cap_chan_lock(chan);
+ 
+ 	sock_orphan(sk);
+ 	l2cap_sock_kill(sk);
+ 
+ 	l2cap_chan_unlock(chan);
+ 	l2cap_chan_put(chan);
+ 
++>>>>>>> 2a154903cec2 (Bluetooth: prefetch channel before killing sock)
  	return err;
  }
  
* Unmerged path net/bluetooth/l2cap_sock.c
