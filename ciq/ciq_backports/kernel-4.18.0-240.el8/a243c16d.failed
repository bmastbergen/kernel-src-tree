KVM: arm64: Add capability to advertise ptrauth for guest

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Amit Daniel Kachhap <amit.kachhap@arm.com>
commit a243c16d18be130b17cf1064e9115de73bfdff5a
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/a243c16d.failed

This patch advertises the capability of two cpu feature called address
pointer authentication and generic pointer authentication. These
capabilities depend upon system support for pointer authentication and
VHE mode.

The current arm64 KVM partially implements pointer authentication and
support of address/generic authentication are tied together. However,
separate ABI requirements for both of them is added so that any future
isolated implementation will not require any ABI changes.

	Signed-off-by: Amit Daniel Kachhap <amit.kachhap@arm.com>
	Cc: Mark Rutland <mark.rutland@arm.com>
	Cc: Marc Zyngier <marc.zyngier@arm.com>
	Cc: Christoffer Dall <christoffer.dall@arm.com>
	Cc: kvmarm@lists.cs.columbia.edu
	Signed-off-by: Marc Zyngier <marc.zyngier@arm.com>
(cherry picked from commit a243c16d18be130b17cf1064e9115de73bfdff5a)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	include/uapi/linux/kvm.h
diff --cc include/uapi/linux/kvm.h
index f5430051438b,4dc34f8e29f6..000000000000
--- a/include/uapi/linux/kvm.h
+++ b/include/uapi/linux/kvm.h
@@@ -990,14 -986,11 +990,20 @@@ struct kvm_ppc_resize_hpt 
  #define KVM_CAP_HYPERV_ENLIGHTENED_VMCS 163
  #define KVM_CAP_EXCEPTION_PAYLOAD 164
  #define KVM_CAP_ARM_VM_IPA_SIZE 165
 -#define KVM_CAP_MANUAL_DIRTY_LOG_PROTECT 166
 +#define KVM_CAP_MANUAL_DIRTY_LOG_PROTECT 166 /* Obsolete */
  #define KVM_CAP_HYPERV_CPUID 167
++<<<<<<< HEAD
 +#define KVM_CAP_MANUAL_DIRTY_LOG_PROTECT2 168
 +#define KVM_CAP_PPC_IRQ_XIVE 169
 +#define KVM_CAP_ARM_SVE 170
 +#define KVM_CAP_PMU_EVENT_FILTER 173
 +#define KVM_CAP_ARM_IRQ_LINE_LAYOUT_2 174
 +#define KVM_CAP_HYPERV_DIRECT_TLBFLUSH 175
++=======
+ #define KVM_CAP_ARM_SVE 168
+ #define KVM_CAP_ARM_PTRAUTH_ADDRESS 169
+ #define KVM_CAP_ARM_PTRAUTH_GENERIC 170
++>>>>>>> a243c16d18be (KVM: arm64: Add capability to advertise ptrauth for guest)
  
  #ifdef KVM_CAP_IRQ_ROUTING
  
diff --git a/Documentation/virt/kvm/api.txt b/Documentation/virt/kvm/api.txt
index 03fd2278bc63..ce4c37cc4706 100644
--- a/Documentation/virt/kvm/api.txt
+++ b/Documentation/virt/kvm/api.txt
@@ -2789,13 +2789,19 @@ Possible features:
 
 	- KVM_ARM_VCPU_PTRAUTH_ADDRESS: Enables Address Pointer authentication
 	  for arm64 only.
-	  Both KVM_ARM_VCPU_PTRAUTH_ADDRESS and KVM_ARM_VCPU_PTRAUTH_GENERIC
-	  must be requested or neither must be requested.
+	  Depends on KVM_CAP_ARM_PTRAUTH_ADDRESS.
+	  If KVM_CAP_ARM_PTRAUTH_ADDRESS and KVM_CAP_ARM_PTRAUTH_GENERIC are
+	  both present, then both KVM_ARM_VCPU_PTRAUTH_ADDRESS and
+	  KVM_ARM_VCPU_PTRAUTH_GENERIC must be requested or neither must be
+	  requested.
 
 	- KVM_ARM_VCPU_PTRAUTH_GENERIC: Enables Generic Pointer authentication
 	  for arm64 only.
-	  Both KVM_ARM_VCPU_PTRAUTH_ADDRESS and KVM_ARM_VCPU_PTRAUTH_GENERIC
-	  must be requested or neither must be requested.
+	  Depends on KVM_CAP_ARM_PTRAUTH_GENERIC.
+	  If KVM_CAP_ARM_PTRAUTH_ADDRESS and KVM_CAP_ARM_PTRAUTH_GENERIC are
+	  both present, then both KVM_ARM_VCPU_PTRAUTH_ADDRESS and
+	  KVM_ARM_VCPU_PTRAUTH_GENERIC must be requested or neither must be
+	  requested.
 
 	- KVM_ARM_VCPU_SVE: Enables SVE for the CPU (arm64 only).
 	  Depends on KVM_CAP_ARM_SVE.
diff --git a/arch/arm64/kvm/reset.c b/arch/arm64/kvm/reset.c
index 52263c52cddb..1140b4485575 100644
--- a/arch/arm64/kvm/reset.c
+++ b/arch/arm64/kvm/reset.c
@@ -101,6 +101,11 @@ int kvm_arch_vm_ioctl_check_extension(struct kvm *kvm, long ext)
 	case KVM_CAP_ARM_SVE:
 		r = system_supports_sve();
 		break;
+	case KVM_CAP_ARM_PTRAUTH_ADDRESS:
+	case KVM_CAP_ARM_PTRAUTH_GENERIC:
+		r = has_vhe() && system_supports_address_auth() &&
+				 system_supports_generic_auth();
+		break;
 	default:
 		r = 0;
 	}
* Unmerged path include/uapi/linux/kvm.h
