drm/i915/tgl: Don't treat unslice registers as masked

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Matt Roper <matthew.d.roper@intel.com>
commit dbe748cd3af4a7c264a94e3e7c56a084dbd0164d
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/dbe748cd.failed

The UNSLICE_UNIT_LEVEL_CLKGATE and UNSLICE_UNIT_LEVEL_CLKGATE2 registers
that we update in a few engine workarounds are not masked registers
(i.e., we don't have to write a mask bit in the top 16 bits when
updating one of the lower 16 bits).  As such, these workarounds should
be applied via wa_write_or() rather than wa_masked_en()

v2:
 - Rebase

	Reported-by: Nick Desaulniers <ndesaulniers@google.com>
	Reported-by: kernelci.org bot <bot@kernelci.org>
References: https://github.com/ClangBuiltLinux/linux/issues/918
Fixes: 50148a25f841 ("drm/i915/tgl: Move and restrict Wa_1408615072")
Fixes: 3551ff928744 ("drm/i915/gen11: Moving WAs to rcs_engine_wa_init()")
	Cc: José Roberto de Souza <jose.souza@intel.com>
	Signed-off-by: Matt Roper <matthew.d.roper@intel.com>
	Tested-by: Nick Desaulniers <ndesaulniers@google.com>
	Reviewed-by: José Roberto de Souza <jose.souza@intel.com>
Link: https://patchwork.freedesktop.org/patch/msgid/20200306171139.1414649-1-matthew.d.roper@intel.com
(cherry picked from commit dbe748cd3af4a7c264a94e3e7c56a084dbd0164d)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/gpu/drm/i915/gt/intel_workarounds.c
diff --cc drivers/gpu/drm/i915/gt/intel_workarounds.c
index 8f75882ded3f,391f39b1fb26..000000000000
--- a/drivers/gpu/drm/i915/gt/intel_workarounds.c
+++ b/drivers/gpu/drm/i915/gt/intel_workarounds.c
@@@ -1231,6 -1341,65 +1231,68 @@@ rcs_engine_wa_init(struct intel_engine_
  {
  	struct drm_i915_private *i915 = engine->i915;
  
++<<<<<<< HEAD
++=======
+ 	if (IS_TGL_REVID(i915, TGL_REVID_A0, TGL_REVID_A0)) {
+ 		/*
+ 		 * Wa_1607138336:tgl
+ 		 * Wa_1607063988:tgl
+ 		 */
+ 		wa_write_or(wal,
+ 			    GEN9_CTX_PREEMPT_REG,
+ 			    GEN12_DISABLE_POSH_BUSY_FF_DOP_CG);
+ 
+ 		/*
+ 		 * Wa_1607030317:tgl
+ 		 * Wa_1607186500:tgl
+ 		 * Wa_1607297627:tgl there is 3 entries for this WA on BSpec, 2
+ 		 * of then says it is fixed on B0 the other one says it is
+ 		 * permanent
+ 		 */
+ 		wa_masked_en(wal,
+ 			     GEN6_RC_SLEEP_PSMI_CONTROL,
+ 			     GEN12_WAIT_FOR_EVENT_POWER_DOWN_DISABLE |
+ 			     GEN8_RC_SEMA_IDLE_MSG_DISABLE);
+ 
+ 		/*
+ 		 * Wa_1606679103:tgl
+ 		 * (see also Wa_1606682166:icl)
+ 		 */
+ 		wa_write_or(wal,
+ 			    GEN7_SARCHKMD,
+ 			    GEN7_DISABLE_SAMPLER_PREFETCH);
+ 
+ 		/* Wa_1407928979:tgl */
+ 		wa_write_or(wal,
+ 			    GEN7_FF_THREAD_MODE,
+ 			    GEN12_FF_TESSELATION_DOP_GATE_DISABLE);
+ 
+ 		/*
+ 		 * Wa_1409085225:tgl
+ 		 * Wa_14010229206:tgl
+ 		 */
+ 		wa_masked_en(wal, GEN9_ROW_CHICKEN4, GEN12_DISABLE_TDL_PUSH);
+ 
+ 		/* Wa_1408615072:tgl */
+ 		wa_write_or(wal, UNSLICE_UNIT_LEVEL_CLKGATE2,
+ 			    VSUNIT_CLKGATE_DIS_TGL);
+ 	}
+ 
+ 	if (IS_TIGERLAKE(i915)) {
+ 		/* Wa_1606931601:tgl */
+ 		wa_masked_en(wal, GEN7_ROW_CHICKEN2, GEN12_DISABLE_EARLY_READ);
+ 
+ 		/* Wa_1409804808:tgl */
+ 		wa_masked_en(wal, GEN7_ROW_CHICKEN2,
+ 			     GEN12_PUSH_CONST_DEREF_HOLD_DIS);
+ 
+ 		/* Wa_1606700617:tgl */
+ 		wa_masked_en(wal,
+ 			     GEN9_CS_DEBUG_MODE1,
+ 			     FF_DOP_CLOCK_GATE_DISABLE);
+ 	}
+ 
++>>>>>>> dbe748cd3af4 (drm/i915/tgl: Don't treat unslice registers as masked)
  	if (IS_GEN(i915, 11)) {
  		/* This is not an Wa. Enable for better image quality */
  		wa_masked_en(wal,
@@@ -1290,10 -1457,31 +1352,34 @@@
  		wa_write_or(wal,
  			    GEN7_SARCHKMD,
  			    GEN7_DISABLE_SAMPLER_PREFETCH);
++<<<<<<< HEAD
++=======
+ 
+ 		/* Wa_1409178092:icl */
+ 		wa_write_masked_or(wal,
+ 				   GEN11_SCRATCH2,
+ 				   GEN11_COHERENT_PARTIAL_WRITE_MERGE_ENABLE,
+ 				   0);
+ 
+ 		/* WaEnable32PlaneMode:icl */
+ 		wa_masked_en(wal, GEN9_CSFE_CHICKEN1_RCS,
+ 			     GEN11_ENABLE_32_PLANE_MODE);
+ 
+ 		/*
+ 		 * Wa_1408615072:icl,ehl  (vsunit)
+ 		 * Wa_1407596294:icl,ehl  (hsunit)
+ 		 */
+ 		wa_write_or(wal, UNSLICE_UNIT_LEVEL_CLKGATE,
+ 			    VSUNIT_CLKGATE_DIS | HSUNIT_CLKGATE_DIS);
+ 
+ 		/* Wa_1407352427:icl,ehl */
+ 		wa_write_or(wal, UNSLICE_UNIT_LEVEL_CLKGATE2,
+ 			    PSDUNIT_CLKGATE_DIS);
++>>>>>>> dbe748cd3af4 (drm/i915/tgl: Don't treat unslice registers as masked)
  	}
  
 -	if (IS_GEN_RANGE(i915, 9, 12)) {
 -		/* FtrPerCtxtPreemptionGranularityControl:skl,bxt,kbl,cfl,cnl,icl,tgl */
 +	if (IS_GEN_RANGE(i915, 9, 11)) {
 +		/* FtrPerCtxtPreemptionGranularityControl:skl,bxt,kbl,cfl,cnl,icl */
  		wa_masked_en(wal,
  			     GEN7_FF_SLICE_CS_CHICKEN1,
  			     GEN9_FFSC_PERCTX_PREEMPT_CTRL);
* Unmerged path drivers/gpu/drm/i915/gt/intel_workarounds.c
