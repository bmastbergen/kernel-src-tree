KVM: PPC: Book3S HV: Migrate hot plugged memory

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Laurent Dufour <ldufour@linux.ibm.com>
commit a2ce72003863d0dcf680f0c49de4678ab2c6812b
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/a2ce7200.failed

When a memory slot is hot plugged to a SVM, PFNs associated with the
GFNs in that slot must be migrated to the secure-PFNs, aka device-PFNs.

Call kvmppc_uv_migrate_mem_slot() to accomplish this.
Disable page-merge for all pages in the memory slot.

	Reviewed-by: Bharata B Rao <bharata@linux.ibm.com>
	Signed-off-by: Ram Pai <linuxram@us.ibm.com>
[rearranged the code, and modified the commit log]
	Signed-off-by: Laurent Dufour <ldufour@linux.ibm.com>
	Signed-off-by: Paul Mackerras <paulus@ozlabs.org>
(cherry picked from commit a2ce72003863d0dcf680f0c49de4678ab2c6812b)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/powerpc/include/asm/kvm_book3s_uvmem.h
#	arch/powerpc/kvm/book3s_hv.c
#	arch/powerpc/kvm/book3s_hv_uvmem.c
diff --cc arch/powerpc/kvm/book3s_hv.c
index 8227db8cf4b7,d9a9dd743b8f..000000000000
--- a/arch/powerpc/kvm/book3s_hv.c
+++ b/arch/powerpc/kvm/book3s_hv.c
@@@ -4479,6 -4515,27 +4479,30 @@@ static void kvmppc_core_commit_memory_r
  	if (change == KVM_MR_FLAGS_ONLY && kvm_is_radix(kvm) &&
  	    ((new->flags ^ old->flags) & KVM_MEM_LOG_DIRTY_PAGES))
  		kvmppc_radix_flush_memslot(kvm, old);
++<<<<<<< HEAD
++=======
+ 	/*
+ 	 * If UV hasn't yet called H_SVM_INIT_START, don't register memslots.
+ 	 */
+ 	if (!kvm->arch.secure_guest)
+ 		return;
+ 
+ 	switch (change) {
+ 	case KVM_MR_CREATE:
+ 		/*
+ 		 * @TODO kvmppc_uvmem_memslot_create() can fail and
+ 		 * return error. Fix this.
+ 		 */
+ 		kvmppc_uvmem_memslot_create(kvm, new);
+ 		break;
+ 	case KVM_MR_DELETE:
+ 		kvmppc_uvmem_memslot_delete(kvm, old);
+ 		break;
+ 	default:
+ 		/* TODO: Handle KVM_MR_MOVE */
+ 		break;
+ 	}
++>>>>>>> a2ce72003863 (KVM: PPC: Book3S HV: Migrate hot plugged memory)
  }
  
  /*
* Unmerged path arch/powerpc/include/asm/kvm_book3s_uvmem.h
* Unmerged path arch/powerpc/kvm/book3s_hv_uvmem.c
* Unmerged path arch/powerpc/include/asm/kvm_book3s_uvmem.h
* Unmerged path arch/powerpc/kvm/book3s_hv.c
* Unmerged path arch/powerpc/kvm/book3s_hv_uvmem.c
