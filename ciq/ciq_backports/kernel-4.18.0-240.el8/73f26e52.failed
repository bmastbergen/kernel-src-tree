x86/Hyper-V: Trigger crash enlightenment only once during system crash.

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
Rebuild_CHGLOG: - [hv] x86/hyper-v: Trigger crash enlightenment only once during system crash (Mohammed Gamal) [1828451 1815498]
Rebuild_FUZZ: 99.29%
commit-author Tianyu Lan <Tianyu.Lan@microsoft.com>
commit 73f26e526f19afb3a06b76b970a76bcac2cafd05
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/73f26e52.failed

When a guest VM panics, Hyper-V should be notified only once via the
crash synthetic MSRs.  Current Linux code might write these crash MSRs
twice during a system panic:
1) hyperv_panic/die_event() calling hyperv_report_panic()
2) hv_kmsg_dump() calling hyperv_report_panic_msg()

Fix this by not calling hyperv_report_panic() if a kmsg dump has been
successfully registered.  The notification will happen later via
hyperv_report_panic_msg().

Fixes: 7ed4325a44ea ("Drivers: hv: vmbus: Make panic reporting to be more useful")
	Reviewed-by: Michael Kelley <mikelley@microsoft.com>
	Signed-off-by: Tianyu Lan <Tianyu.Lan@microsoft.com>
Link: https://lore.kernel.org/r/20200406155331.2105-4-Tianyu.Lan@microsoft.com
	Signed-off-by: Wei Liu <wei.liu@kernel.org>
(cherry picked from commit 73f26e526f19afb3a06b76b970a76bcac2cafd05)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/hv/vmbus_drv.c
diff --cc drivers/hv/vmbus_drv.c
index 12bce1b87223,333dad39b1c1..000000000000
--- a/drivers/hv/vmbus_drv.c
+++ b/drivers/hv/vmbus_drv.c
@@@ -63,9 -53,18 +63,22 @@@ static int hyperv_panic_event(struct no
  {
  	struct pt_regs *regs;
  
 -	vmbus_initiate_unload(true);
 +	regs = current_pt_regs();
  
++<<<<<<< HEAD
 +	hyperv_report_panic(regs, val);
++=======
+ 	/*
+ 	 * Hyper-V should be notified only once about a panic.  If we will be
+ 	 * doing hyperv_report_panic_msg() later with kmsg data, don't do
+ 	 * the notification here.
+ 	 */
+ 	if (ms_hyperv.misc_features & HV_FEATURE_GUEST_CRASH_MSR_AVAILABLE
+ 	    && !hv_panic_page) {
+ 		regs = current_pt_regs();
+ 		hyperv_report_panic(regs, val);
+ 	}
++>>>>>>> 73f26e526f19 (x86/Hyper-V: Trigger crash enlightenment only once during system crash.)
  	return NOTIFY_DONE;
  }
  
* Unmerged path drivers/hv/vmbus_drv.c
