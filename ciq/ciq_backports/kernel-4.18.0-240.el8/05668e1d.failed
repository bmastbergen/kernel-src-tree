s390/cio: fix virtio-ccw DMA without PV

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Halil Pasic <pasic@linux.ibm.com>
commit 05668e1d74b84c53fbe0f28565e4c9502a6b8a67
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/05668e1d.failed

Commit 37db8985b211 ("s390/cio: add basic protected virtualization
support") breaks virtio-ccw devices with VIRTIO_F_IOMMU_PLATFORM for non
Protected Virtualization (PV) guests. The problem is that the dma_mask
of the ccw device, which is used by virtio core, gets changed from 64 to
31 bit, because some of the DMA allocations do require 31 bit
addressable memory. For PV the only drawback is that some of the virtio
structures must end up in ZONE_DMA because we have the bounce the
buffers mapped via DMA API anyway.

But for non PV guests we have a problem: because of the 31 bit mask
guests bigger than 2G are likely to try bouncing buffers. The swiotlb
however is only initialized for PV guests, because we don't want to
bounce anything for non PV guests. The first such map kills the guest.

Since the DMA API won't allow us to specify for each allocation whether
we need memory from ZONE_DMA (31 bit addressable) or any DMA capable
memory will do, let us use coherent_dma_mask (which is used for
allocations) to force allocating form ZONE_DMA while changing dma_mask
to DMA_BIT_MASK(64) so that at least the streaming API will regard
the whole memory DMA capable.

	Signed-off-by: Halil Pasic <pasic@linux.ibm.com>
	Reported-by: Marc Hartmayer <mhartmay@linux.ibm.com>
	Suggested-by: Robin Murphy <robin.murphy@arm.com>
Fixes: 37db8985b211 ("s390/cio: add basic protected virtualization support")
Link: https://lore.kernel.org/lkml/20190930153803.7958-1-pasic@linux.ibm.com
	Reviewed-by: Christoph Hellwig <hch@lst.de>
	Reviewed-by: Cornelia Huck <cohuck@redhat.com>
	Signed-off-by: Christian Borntraeger <borntraeger@de.ibm.com>
	Signed-off-by: Vasily Gorbik <gor@linux.ibm.com>
(cherry picked from commit 05668e1d74b84c53fbe0f28565e4c9502a6b8a67)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/s390/cio/cio.h
diff --cc drivers/s390/cio/cio.h
index cd6aa9e95c73,dcdaba689b20..000000000000
--- a/drivers/s390/cio/cio.h
+++ b/drivers/s390/cio/cio.h
@@@ -113,9 -113,11 +113,14 @@@ struct subchannel 
  	enum sch_todo todo;
  	struct work_struct todo_work;
  	struct schib_config config;
++<<<<<<< HEAD
++=======
+ 	u64 dma_mask;
+ 	char *driver_override; /* Driver name to force a match */
++>>>>>>> 05668e1d74b8 (s390/cio: fix virtio-ccw DMA without PV)
  } __attribute__ ((aligned(8)));
  
 -DECLARE_PER_CPU_ALIGNED(struct irb, cio_irb);
 +DECLARE_PER_CPU(struct irb, cio_irb);
  
  #define to_subchannel(n) container_of(n, struct subchannel, dev)
  
* Unmerged path drivers/s390/cio/cio.h
diff --git a/drivers/s390/cio/css.c b/drivers/s390/cio/css.c
index 410a5d385aee..59bf41e1231f 100644
--- a/drivers/s390/cio/css.c
+++ b/drivers/s390/cio/css.c
@@ -195,7 +195,12 @@ struct subchannel *css_alloc_subchannel(struct subchannel_id schid)
 	 * belong to a subchannel need to fit 31 bit width (e.g. ccw).
 	 */
 	sch->dev.coherent_dma_mask = DMA_BIT_MASK(31);
-	sch->dev.dma_mask = &sch->dev.coherent_dma_mask;
+	/*
+	 * But we don't have such restrictions imposed on the stuff that
+	 * is handled by the streaming API.
+	 */
+	sch->dma_mask = DMA_BIT_MASK(64);
+	sch->dev.dma_mask = &sch->dma_mask;
 	return sch;
 
 err:
diff --git a/drivers/s390/cio/device.c b/drivers/s390/cio/device.c
index 03bd18279c0a..a9dc041405ef 100644
--- a/drivers/s390/cio/device.c
+++ b/drivers/s390/cio/device.c
@@ -710,7 +710,7 @@ static struct ccw_device * io_subchannel_allocate_dev(struct subchannel *sch)
 	if (!cdev->private)
 		goto err_priv;
 	cdev->dev.coherent_dma_mask = sch->dev.coherent_dma_mask;
-	cdev->dev.dma_mask = &cdev->dev.coherent_dma_mask;
+	cdev->dev.dma_mask = sch->dev.dma_mask;
 	dma_pool = cio_gp_dma_create(&cdev->dev, 1);
 	if (!dma_pool)
 		goto err_dma_pool;
