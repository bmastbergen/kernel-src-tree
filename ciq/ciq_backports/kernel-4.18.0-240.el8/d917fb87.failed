selftests: build and run gpio when output directory is the src dir

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Shuah Khan <skhan@linuxfoundation.org>
commit d917fb876f6eaeeea8a2b620d2a266ce26372f4d
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/d917fb87.failed

Build and run gpio when output directory is the src dir.  gpio has
dependency on tools/gpio and builds tools/gpio objects in the src
directory in all cases making the src repo dirty even when object
relocation is specified.

This fixes the following commands from generating gpio objects in
the source repository:

make O=dir kselftest
export KBUILD_OUTPUT=dir; make kselftest
make O=dir -C tools/testing/selftests
expoert KBUILD_OUTPUT=dir; make -C tools/testing/selftests

The following commands still build gpio objects in the source repo
(gpio Makefile needs to fixed):
make O=dir kselftest TARGETS="gpio"
export KBUILD_OUTPUT=dir; make kselftest TARGETS="gpio"
make O=dir -C tools/testing/selftests TARGETS="gpio"
expoert KBUILD_OUTPUT=dir; make -C tools/testing/selftests TARGETS="gpio"

	Signed-off-by: Shuah Khan <skhan@linuxfoundation.org>
(cherry picked from commit d917fb876f6eaeeea8a2b620d2a266ce26372f4d)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/testing/selftests/Makefile
diff --cc tools/testing/selftests/Makefile
index 2142c52cecc0,f2ebf8cf4686..000000000000
--- a/tools/testing/selftests/Makefile
+++ b/tools/testing/selftests/Makefile
@@@ -71,16 -75,67 +71,57 @@@ ifneq ($(KBUILD_SRC),
  override LDFLAGS =
  endif
  
 -ifneq ($(O),)
 -	BUILD := $(O)
 -else
 -	ifneq ($(KBUILD_OUTPUT),)
 -		BUILD := $(KBUILD_OUTPUT)
 -	else
 -		BUILD := $(shell pwd)
 -		DEFAULT_INSTALL_HDR_PATH := 1
 -	endif
 +BUILD := $(O)
 +ifndef BUILD
 +  BUILD := $(KBUILD_OUTPUT)
 +endif
 +ifndef BUILD
 +  BUILD := $(shell pwd)
  endif
  
 -# KSFT_TAP_LEVEL is used from KSFT framework to prevent nested TAP header
 -# printing from tests. Applicable to run_tests case where run_tests adds
 -# TAP header prior running tests and when a test program invokes another
 -# with system() call. Export it here to cover override RUN_TESTS defines.
 -export KSFT_TAP_LEVEL=`echo 1`
 -
 -# Prepare for headers install
 -top_srcdir ?= ../../..
 -include $(top_srcdir)/scripts/subarch.include
 -ARCH           ?= $(SUBARCH)
 -export KSFT_KHDR_INSTALL_DONE := 1
  export BUILD
++<<<<<<< HEAD
 +all:
++=======
+ 
+ # build and run gpio when output directory is the src dir.
+ # gpio has dependency on tools/gpio and builds tools/gpio
+ # objects in the src directory in all cases making the src
+ # repo dirty even when objects are relocated.
+ ifneq (1,$(DEFAULT_INSTALL_HDR_PATH))
+ 	TMP := $(filter-out gpio, $(TARGETS))
+ 	TARGETS := $(TMP)
+ endif
+ 
+ # set default goal to all, so make without a target runs all, even when
+ # all isn't the first target in the file.
+ .DEFAULT_GOAL := all
+ 
+ # Install headers here once for all tests. KSFT_KHDR_INSTALL_DONE
+ # is used to avoid running headers_install from lib.mk.
+ # Invoke headers install with --no-builtin-rules to avoid circular
+ # dependency in "make kselftest" case. In this case, second level
+ # make inherits builtin-rules which will use the rule generate
+ # Makefile.o and runs into
+ # "Circular Makefile.o <- prepare dependency dropped."
+ # and headers_install fails and test compile fails.
+ #
+ # O= KBUILD_OUTPUT cases don't run into this error, since main Makefile
+ # invokes them as sub-makes and --no-builtin-rules is not necessary,
+ # but doesn't cause any failures. Keep it simple and use the same
+ # flags in both cases.
+ # Local build cases: "make kselftest", "make -C" - headers are installed
+ # in the default INSTALL_HDR_PATH usr/include.
+ khdr:
+ ifeq (1,$(DEFAULT_INSTALL_HDR_PATH))
+ 	make --no-builtin-rules ARCH=$(ARCH) -C $(top_srcdir) headers_install
+ else
+ 	make --no-builtin-rules INSTALL_HDR_PATH=$$BUILD/usr \
+ 		ARCH=$(ARCH) -C $(top_srcdir) headers_install
+ endif
+ 
+ all: khdr
++>>>>>>> d917fb876f6e (selftests: build and run gpio when output directory is the src dir)
  	@for TARGET in $(TARGETS); do		\
  		BUILD_TARGET=$$BUILD/$$TARGET;	\
  		mkdir $$BUILD_TARGET  -p;	\
* Unmerged path tools/testing/selftests/Makefile
