drm/amdgpu: Sync with VM root BO when switching VM to CPU update mode

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Felix Kuehling <Felix.Kuehling@amd.com>
commit 90ca78deb004abe75b5024968a199acb96bb70f9
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/90ca78de.failed

This fixes an intermittent bug where a root PD clear operation still in
progress could overwrite a PDE update done by the CPU, resulting in a
VM fault.

Fixes: 108b4d928c03 ("drm/amd/amdgpu: Update VM function pointer")
	Reported-by: Jay Cornwall <Jay.Cornwall@amd.com>
	Tested-by: Jay Cornwall <Jay.Cornwall@amd.com>
	Signed-off-by: Felix Kuehling <Felix.Kuehling@amd.com>
	Reviewed-by: Christian KÃ¶nig <christian.koenig@amd.com>
	Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
(cherry picked from commit 90ca78deb004abe75b5024968a199acb96bb70f9)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/gpu/drm/amd/amdgpu/amdgpu_vm.c
diff --cc drivers/gpu/drm/amd/amdgpu/amdgpu_vm.c
index ebbebb75150b,7417754e9141..000000000000
--- a/drivers/gpu/drm/amd/amdgpu/amdgpu_vm.c
+++ b/drivers/gpu/drm/amd/amdgpu/amdgpu_vm.c
@@@ -2865,9 -2996,25 +2865,27 @@@ int amdgpu_vm_make_compute(struct amdgp
  				    AMDGPU_VM_USE_CPU_FOR_COMPUTE);
  	DRM_DEBUG_DRIVER("VM update mode is %s\n",
  			 vm->use_cpu_for_update ? "CPU" : "SDMA");
 -	WARN_ONCE((vm->use_cpu_for_update &&
 -		   !amdgpu_gmc_vram_full_visible(&adev->gmc)),
 +	WARN_ONCE((vm->use_cpu_for_update && !amdgpu_gmc_vram_full_visible(&adev->gmc)),
  		  "CPU update of VM recommended only for large BAR system\n");
  
++<<<<<<< HEAD
++=======
+ 	if (vm->use_cpu_for_update) {
+ 		/* Sync with last SDMA update/clear before switching to CPU */
+ 		r = amdgpu_bo_sync_wait(vm->root.base.bo,
+ 					AMDGPU_FENCE_OWNER_UNDEFINED, true);
+ 		if (r)
+ 			goto free_idr;
+ 
+ 		vm->update_funcs = &amdgpu_vm_cpu_funcs;
+ 	} else {
+ 		vm->update_funcs = &amdgpu_vm_sdma_funcs;
+ 	}
+ 	dma_fence_put(vm->last_update);
+ 	vm->last_update = NULL;
+ 	vm->is_compute_context = true;
+ 
++>>>>>>> 90ca78deb004 (drm/amdgpu: Sync with VM root BO when switching VM to CPU update mode)
  	if (vm->pasid) {
  		unsigned long flags;
  
* Unmerged path drivers/gpu/drm/amd/amdgpu/amdgpu_vm.c
