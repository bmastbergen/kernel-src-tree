vhost: refine vhost and vringh kconfig

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Jason Wang <jasowang@redhat.com>
commit 20c384f1ea1a0bc7320bc445c72dd02d2970d594
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/20c384f1.failed

Currently, CONFIG_VHOST depends on CONFIG_VIRTUALIZATION. But vhost is
not necessarily for VM since it's a generic userspace and kernel
communication protocol. Such dependency may prevent archs without
virtualization support from using vhost.

To solve this, a dedicated vhost menu is created under drivers so
CONIFG_VHOST can be decoupled out of CONFIG_VIRTUALIZATION.

While at it, also squash Kconfig.vringh into vhost Kconfig file. This
avoids the trick of conditional inclusion from VOP or CAIF. Then it
will be easier to introduce new vringh users and common dependency for
both vringh and vhost.

	Signed-off-by: Jason Wang <jasowang@redhat.com>
Link: https://lore.kernel.org/r/20200326140125.19794-2-jasowang@redhat.com
	Signed-off-by: Michael S. Tsirkin <mst@redhat.com>
(cherry picked from commit 20c384f1ea1a0bc7320bc445c72dd02d2970d594)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/arm/kvm/Kconfig
#	arch/arm64/kvm/Kconfig
#	arch/mips/kvm/Kconfig
#	arch/powerpc/kvm/Kconfig
#	arch/s390/kvm/Kconfig
#	arch/x86/kvm/Kconfig
#	drivers/net/caif/Kconfig
#	drivers/vhost/Kconfig
#	drivers/vhost/Kconfig.vringh
diff --cc arch/arm/kvm/Kconfig
index e2bd35b6780c,be97393761bf..000000000000
--- a/arch/arm/kvm/Kconfig
+++ b/arch/arm/kvm/Kconfig
@@@ -55,6 -54,4 +55,9 @@@ config KVM_ARM_HOS
  	---help---
  	  Provides host support for ARM processors.
  
++<<<<<<< HEAD
 +source drivers/vhost/Kconfig
 +
++=======
++>>>>>>> 20c384f1ea1a (vhost: refine vhost and vringh kconfig)
  endif # VIRTUALIZATION
diff --cc arch/arm64/kvm/Kconfig
index 47b23bf617c7,449386d76441..000000000000
--- a/arch/arm64/kvm/Kconfig
+++ b/arch/arm64/kvm/Kconfig
@@@ -61,6 -64,4 +61,9 @@@ config KVM_ARM_PM
  config KVM_INDIRECT_VECTORS
         def_bool KVM && (HARDEN_BRANCH_PREDICTOR || HARDEN_EL2_VECTORS)
  
++<<<<<<< HEAD
 +source drivers/vhost/Kconfig
 +
++=======
++>>>>>>> 20c384f1ea1a (vhost: refine vhost and vringh kconfig)
  endif # VIRTUALIZATION
diff --cc arch/mips/kvm/Kconfig
index 76b93a9c8c9b,b91d145aa2d5..000000000000
--- a/arch/mips/kvm/Kconfig
+++ b/arch/mips/kvm/Kconfig
@@@ -72,6 -72,4 +72,9 @@@ config KVM_MIPS_DEBUG_COP0_COUNTER
  
  	  If unsure, say N.
  
++<<<<<<< HEAD
 +source drivers/vhost/Kconfig
 +
++=======
++>>>>>>> 20c384f1ea1a (vhost: refine vhost and vringh kconfig)
  endif # VIRTUALIZATION
diff --cc arch/powerpc/kvm/Kconfig
index 68a0e9d5b440,12885eda324e..000000000000
--- a/arch/powerpc/kvm/Kconfig
+++ b/arch/powerpc/kvm/Kconfig
@@@ -204,6 -204,4 +204,9 @@@ config KVM_XIV
  	default y
  	depends on KVM_XICS && PPC_XIVE_NATIVE && KVM_BOOK3S_HV_POSSIBLE
  
++<<<<<<< HEAD
 +source drivers/vhost/Kconfig
 +
++=======
++>>>>>>> 20c384f1ea1a (vhost: refine vhost and vringh kconfig)
  endif # VIRTUALIZATION
diff --cc arch/s390/kvm/Kconfig
index d7b8d80976f1,def3b60f1fe8..000000000000
--- a/arch/s390/kvm/Kconfig
+++ b/arch/s390/kvm/Kconfig
@@@ -56,8 -55,4 +56,11 @@@ config KVM_S390_UCONTRO
  
  	  If unsure, say N.
  
++<<<<<<< HEAD
 +# OK, it's a little counter-intuitive to do this, but it puts it neatly under
 +# the virtualization menu.
 +source drivers/vhost/Kconfig
 +
++=======
++>>>>>>> 20c384f1ea1a (vhost: refine vhost and vringh kconfig)
  endif # VIRTUALIZATION
diff --cc arch/x86/kvm/Kconfig
index 38f5011f98fd,d8154e0684b6..000000000000
--- a/arch/x86/kvm/Kconfig
+++ b/arch/x86/kvm/Kconfig
@@@ -108,8 -107,4 +108,11 @@@ config KVM_MMU_AUDI
  	 This option adds a R/W kVM module parameter 'mmu_audit', which allows
  	 auditing of KVM MMU events at runtime.
  
++<<<<<<< HEAD
 +# OK, it's a little counter-intuitive to do this, but it puts it neatly under
 +# the virtualization menu.
 +source drivers/vhost/Kconfig
 +
++=======
++>>>>>>> 20c384f1ea1a (vhost: refine vhost and vringh kconfig)
  endif # VIRTUALIZATION
diff --cc drivers/net/caif/Kconfig
index f81df91a9ce1,9db0570c5beb..000000000000
--- a/drivers/net/caif/Kconfig
+++ b/drivers/net/caif/Kconfig
@@@ -49,8 -56,6 +49,12 @@@ config CAIF_VIRTI
  	select GENERIC_ALLOCATOR
  	default n
  	---help---
 -	  The CAIF driver for CAIF over Virtio.
 +	The caif driver for CAIF over Virtio.
  
++<<<<<<< HEAD
 +if CAIF_VIRTIO
 +source "drivers/vhost/Kconfig.vringh"
 +endif
++=======
+ endif # CAIF_DRIVERS
++>>>>>>> 20c384f1ea1a (vhost: refine vhost and vringh kconfig)
diff --cc drivers/vhost/Kconfig
index b580885243f7,e775beddc36a..000000000000
--- a/drivers/vhost/Kconfig
+++ b/drivers/vhost/Kconfig
@@@ -1,3 -1,23 +1,26 @@@
++<<<<<<< HEAD
++=======
+ # SPDX-License-Identifier: GPL-2.0-only
+ config VHOST_RING
+ 	tristate
+ 	help
+ 	  This option is selected by any driver which needs to access
+ 	  the host side of a virtio ring.
+ 
+ config VHOST
+ 	tristate
+ 	select VHOST_IOTLB
+ 	help
+ 	  This option is selected by any driver which needs to access
+ 	  the core of vhost.
+ 
+ menuconfig VHOST_MENU
+ 	bool "VHOST drivers"
+ 	default y
+ 
+ if VHOST_MENU
+ 
++>>>>>>> 20c384f1ea1a (vhost: refine vhost and vringh kconfig)
  config VHOST_NET
  	tristate "Host kernel accelerator for virtio net"
  	depends on NET && EVENTFD && (TUN || !TUN) && (TAP || !TAP)
* Unmerged path drivers/vhost/Kconfig.vringh
* Unmerged path arch/arm/kvm/Kconfig
* Unmerged path arch/arm64/kvm/Kconfig
* Unmerged path arch/mips/kvm/Kconfig
* Unmerged path arch/powerpc/kvm/Kconfig
* Unmerged path arch/s390/kvm/Kconfig
* Unmerged path arch/x86/kvm/Kconfig
diff --git a/drivers/Kconfig b/drivers/Kconfig
index 95b9ccc08165..729bd760cc77 100644
--- a/drivers/Kconfig
+++ b/drivers/Kconfig
@@ -131,6 +131,8 @@ source "drivers/virt/Kconfig"
 
 source "drivers/virtio/Kconfig"
 
+source "drivers/vhost/Kconfig"
+
 source "drivers/hv/Kconfig"
 
 source "drivers/xen/Kconfig"
diff --git a/drivers/misc/mic/Kconfig b/drivers/misc/mic/Kconfig
index 242dcee14689..ec27c83ad2ca 100644
--- a/drivers/misc/mic/Kconfig
+++ b/drivers/misc/mic/Kconfig
@@ -148,8 +148,4 @@ config VOP
 	  OS and tools for MIC to use with this driver are available from
 	  <http://software.intel.com/en-us/mic-developer>.
 
-if VOP
-source "drivers/vhost/Kconfig.vringh"
-endif
-
 endmenu
* Unmerged path drivers/net/caif/Kconfig
* Unmerged path drivers/vhost/Kconfig
* Unmerged path drivers/vhost/Kconfig.vringh
