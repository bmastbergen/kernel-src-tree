net/mlx5e: Fix ethtool hfunc configuration change

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Aya Levin <ayal@mellanox.com>
commit 5f1572e6178e47c3ace55ced187d93240952c9cd
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/5f1572e6.failed

Changing RX hash function requires rearranging of RQT internal indexes,
the user isn't exposed to such changes and these changes do not affect
the user configured indirection table. Rebuild RQ table on hfunc change.

Fixes: bdfc028de1b3 ("net/mlx5e: Fix ethtool RX hash func configuration change")
	Signed-off-by: Aya Levin <ayal@mellanox.com>
	Reviewed-by: Tariq Toukan <tariqt@mellanox.com>
	Signed-off-by: Saeed Mahameed <saeedm@mellanox.com>
(cherry picked from commit 5f1572e6178e47c3ace55ced187d93240952c9cd)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlx5/core/en_ethtool.c
diff --cc drivers/net/ethernet/mellanox/mlx5/core/en_ethtool.c
index ebc175c3c42a,ec5658bbe3c5..000000000000
--- a/drivers/net/ethernet/mellanox/mlx5/core/en_ethtool.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/en_ethtool.c
@@@ -1194,11 -1203,26 +1182,31 @@@ int mlx5e_set_rxfh(struct net_device *d
  	if (key) {
  		memcpy(rss->toeplitz_hash_key, key,
  		       sizeof(rss->toeplitz_hash_key));
- 		hash_changed = hash_changed || rss->hfunc == ETH_RSS_HASH_TOP;
+ 		refresh_tirs = refresh_tirs || rss->hfunc == ETH_RSS_HASH_TOP;
  	}
  
++<<<<<<< HEAD
 +	if (hash_changed)
 +		mlx5e_modify_tirs_hash(priv, in, inlen);
++=======
+ 	if (refresh_rqt && test_bit(MLX5E_STATE_OPENED, &priv->state)) {
+ 		struct mlx5e_redirect_rqt_param rrp = {
+ 			.is_rss = true,
+ 			{
+ 				.rss = {
+ 					.hfunc = rss->hfunc,
+ 					.channels  = &priv->channels,
+ 				},
+ 			},
+ 		};
+ 		u32 rqtn = priv->indir_rqt.rqtn;
+ 
+ 		mlx5e_redirect_rqt(priv, rqtn, MLX5E_INDIR_RQT_SIZE, rrp);
+ 	}
+ 
+ 	if (refresh_tirs)
+ 		mlx5e_modify_tirs_hash(priv, in);
++>>>>>>> 5f1572e6178e (net/mlx5e: Fix ethtool hfunc configuration change)
  
  	mutex_unlock(&priv->state_lock);
  
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/en_ethtool.c
