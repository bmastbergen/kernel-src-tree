powerpc/prom_init: Pass the "os-term" message to hypervisor

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
Rebuild_CHGLOG: - [powerpc] prom_init: Pass the "os-term" message to hypervisor (Michael Roth) [1730194]
Rebuild_FUZZ: 92.73%
commit-author Alexey Kardashevskiy <aik@ozlabs.ru>
commit 74bb84e5117146fa73eb9d01305975c53022b3c3
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/74bb84e5.failed

The "os-term" RTAS calls has one argument with a message address of OS
termination cause. rtas_os_term() already passes it but the recently
added prom_init's version of that missed it; it also does not fill
args correctly.

This passes the message address and initializes the number of arguments.

Fixes: 6a9c930bd775 ("powerpc/prom_init: Add the ESM call to prom_init")
	Signed-off-by: Alexey Kardashevskiy <aik@ozlabs.ru>
	Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: https://lore.kernel.org/r/20200312074404.87293-1-aik@ozlabs.ru
(cherry picked from commit 74bb84e5117146fa73eb9d01305975c53022b3c3)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/powerpc/kernel/prom_init.c
diff --cc arch/powerpc/kernel/prom_init.c
index 8eb1d8e418de,673f13b87db1..000000000000
--- a/arch/powerpc/kernel/prom_init.c
+++ b/arch/powerpc/kernel/prom_init.c
@@@ -1709,6 -1740,46 +1709,49 @@@ static void __init prom_close_stdin(voi
  	}
  }
  
++<<<<<<< HEAD
++=======
+ #ifdef CONFIG_PPC_SVM
+ static int prom_rtas_hcall(uint64_t args)
+ {
+ 	register uint64_t arg1 asm("r3") = H_RTAS;
+ 	register uint64_t arg2 asm("r4") = args;
+ 
+ 	asm volatile("sc 1\n" : "=r" (arg1) :
+ 			"r" (arg1),
+ 			"r" (arg2) :);
+ 	return arg1;
+ }
+ 
+ static struct rtas_args __prombss os_term_args;
+ 
+ static void __init prom_rtas_os_term(char *str)
+ {
+ 	phandle rtas_node;
+ 	__be32 val;
+ 	u32 token;
+ 
+ 	prom_debug("%s: start...\n", __func__);
+ 	rtas_node = call_prom("finddevice", 1, 1, ADDR("/rtas"));
+ 	prom_debug("rtas_node: %x\n", rtas_node);
+ 	if (!PHANDLE_VALID(rtas_node))
+ 		return;
+ 
+ 	val = 0;
+ 	prom_getprop(rtas_node, "ibm,os-term", &val, sizeof(val));
+ 	token = be32_to_cpu(val);
+ 	prom_debug("ibm,os-term: %x\n", token);
+ 	if (token == 0)
+ 		prom_panic("Could not get token for ibm,os-term\n");
+ 	os_term_args.token = cpu_to_be32(token);
+ 	os_term_args.nargs = cpu_to_be32(1);
+ 	os_term_args.nret = cpu_to_be32(1);
+ 	os_term_args.args[0] = cpu_to_be32(__pa(str));
+ 	prom_rtas_hcall((uint64_t)&os_term_args);
+ }
+ #endif /* CONFIG_PPC_SVM */
+ 
++>>>>>>> 74bb84e51171 (powerpc/prom_init: Pass the "os-term" message to hypervisor)
  /*
   * Allocate room for and instantiate RTAS
   */
* Unmerged path arch/powerpc/kernel/prom_init.c
