drm/amd/display: Fix green screen issue after suspend

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Rodrigo Siqueira <Rodrigo.Siqueira@amd.com>
commit af031f078aeae3c6179a4618ce1aa8eda861ee10
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/af031f07.failed

[why]
We have seen a green screen after resume from suspend in a Raven system
connected with two displays (HDMI and DP) on X based system. We noticed
that this issue is related to bad DCC metadata from user space which may
generate hangs and consequently an underflow on HUBP. After taking a
deep look at the code path we realized that after resume we try to
restore the commit with the DCC enabled framebuffer but the framebuffer
is no longer valid.

[how]
This problem was only reported on Raven based system and after suspend,
for this reason, this commit adds a new parameter on
fill_plane_dcc_attributes() to give the option of disabling DCC
programmatically. In summary, for disabling DCC we first verify if is a
Raven system and if it is in suspend; if both conditions are true we
disable DCC temporarily, otherwise, it is enabled.

Co-developed-by: Nicholas Kazlauskas <nicholas.kazlauskas@amd.com>
	Signed-off-by: Nicholas Kazlauskas <nicholas.kazlauskas@amd.com>
	Signed-off-by: Rodrigo Siqueira <Rodrigo.Siqueira@amd.com>
	Reviewed-by: Nicholas Kazlauskas <Nicholas.Kazlauskas@amd.com>
	Acked-by: Rodrigo Siqueira <Rodrigo.Siqueira@amd.com>
	Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
(cherry picked from commit af031f078aeae3c6179a4618ce1aa8eda861ee10)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.c
diff --cc drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.c
index e305cbef0705,6cd661545f35..000000000000
--- a/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.c
+++ b/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.c
@@@ -2734,9 -3408,10 +2738,10 @@@ fill_plane_buffer_attributes(struct amd
  			     const enum dc_rotation_angle rotation,
  			     const uint64_t tiling_flags,
  			     union dc_tiling_info *tiling_info,
 -			     struct plane_size *plane_size,
 +			     union plane_size *plane_size,
  			     struct dc_plane_dcc_param *dcc,
- 			     struct dc_plane_address *address)
+ 			     struct dc_plane_address *address,
+ 			     bool force_disable_dcc)
  {
  	const struct drm_framebuffer *fb = &afb->base;
  	int ret;
@@@ -7082,7 -8109,24 +7101,28 @@@ dm_determine_update_type_for_commit(str
  			if (ret)
  				goto cleanup;
  
++<<<<<<< HEAD
 +			updates[num_plane].scaling_info = &scaling_info;
++=======
+ 			bundle->surface_updates[num_plane].scaling_info = scaling_info;
+ 
+ 			if (amdgpu_fb) {
+ 				ret = get_fb_info(amdgpu_fb, &tiling_flags);
+ 				if (ret)
+ 					goto cleanup;
+ 
+ 				ret = fill_dc_plane_info_and_addr(
+ 					dm->adev, new_plane_state, tiling_flags,
+ 					plane_info,
+ 					&flip_addr->address,
+ 					false);
+ 				if (ret)
+ 					goto cleanup;
+ 
+ 				bundle->surface_updates[num_plane].plane_info = plane_info;
+ 				bundle->surface_updates[num_plane].flip_addr = flip_addr;
+ 			}
++>>>>>>> af031f078aea (drm/amd/display: Fix green screen issue after suspend)
  
  			num_plane++;
  		}
* Unmerged path drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.c
