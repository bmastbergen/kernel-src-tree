netfilter: nft_set_rbtree: Add missing expired checks

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Phil Sutter <phil@nwl.cc>
commit 340eaff651160234bdbce07ef34b92a8e45cd540
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/340eaff6.failed

Expired intervals would still match and be dumped to user space until
garbage collection wiped them out. Make sure they stop matching and
disappear (from users' perspective) as soon as they expire.

Fixes: 8d8540c4f5e03 ("netfilter: nft_set_rbtree: add timeout support")
	Signed-off-by: Phil Sutter <phil@nwl.cc>
	Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
(cherry picked from commit 340eaff651160234bdbce07ef34b92a8e45cd540)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/netfilter/nft_set_rbtree.c
diff --cc net/netfilter/nft_set_rbtree.c
index 18a5e2aa7e34,62f416bc0579..000000000000
--- a/net/netfilter/nft_set_rbtree.c
+++ b/net/netfilter/nft_set_rbtree.c
@@@ -77,8 -79,17 +77,22 @@@ static bool __nft_rbtree_lookup(const s
  				parent = rcu_dereference_raw(parent->rb_left);
  				continue;
  			}
++<<<<<<< HEAD
 +			if (nft_rbtree_interval_end(rbe))
 +				goto out;
++=======
+ 
+ 			if (nft_set_elem_expired(&rbe->ext))
+ 				return false;
+ 
+ 			if (nft_rbtree_interval_end(rbe)) {
+ 				if (nft_set_is_anonymous(set))
+ 					return false;
+ 				parent = rcu_dereference_raw(parent->rb_left);
+ 				interval = NULL;
+ 				continue;
+ 			}
++>>>>>>> 340eaff65116 (netfilter: nft_set_rbtree: Add missing expired checks)
  
  			*ext = &rbe->ext;
  			return true;
@@@ -87,7 -98,8 +101,12 @@@
  
  	if (set->flags & NFT_SET_INTERVAL && interval != NULL &&
  	    nft_set_elem_active(&interval->ext, genmask) &&
++<<<<<<< HEAD
 +	    !nft_rbtree_interval_end(interval)) {
++=======
+ 	    !nft_set_elem_expired(&interval->ext) &&
+ 	    nft_rbtree_interval_start(interval)) {
++>>>>>>> 340eaff65116 (netfilter: nft_set_rbtree: Add missing expired checks)
  		*ext = &interval->ext;
  		return true;
  	}
@@@ -142,9 -154,14 +161,12 @@@ static bool __nft_rbtree_get(const stru
  			if (flags & NFT_SET_ELEM_INTERVAL_END)
  				interval = rbe;
  		} else {
 -			if (!nft_set_elem_active(&rbe->ext, genmask)) {
 +			if (!nft_set_elem_active(&rbe->ext, genmask))
  				parent = rcu_dereference_raw(parent->rb_left);
 -				continue;
 -			}
  
+ 			if (nft_set_elem_expired(&rbe->ext))
+ 				return false;
+ 
  			if (!nft_set_ext_exists(&rbe->ext, NFT_SET_EXT_FLAGS) ||
  			    (*nft_set_ext_flags(&rbe->ext) & NFT_SET_ELEM_INTERVAL_END) ==
  			    (flags & NFT_SET_ELEM_INTERVAL_END)) {
* Unmerged path net/netfilter/nft_set_rbtree.c
