scsi: storvsc: Correctly set number of hardware queues for IDE disk

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Long Li <longli@microsoft.com>
commit 7b571c19d4c0b78d27dd3bf1f3c42e4032390af6
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/7b571c19.failed

Commit 0ed881027690 ("scsi: storvsc: setup 1:1 mapping between hardware
queue and CPU queue") introduced a regression for disks attached to
IDE. For these disks the host VSP only offers one VMBUS channel. Setting
multiple queues can overload the VMBUS channel and result in performance
drop for high queue depth workload on system with large number of CPUs.

Fix it by leaving the number of hardware queues to 1 (default value) for
IDE disks.

Fixes: 0ed881027690 ("scsi: storvsc: setup 1:1 mapping between hardware queue and CPU queue")
Link: https://lore.kernel.org/r/1578960516-108228-1-git-send-email-longli@linuxonhyperv.com
	Reviewed-by: Ming Lei <ming.lei@redhat.com>
	Signed-off-by: Long Li <longli@microsoft.com>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit 7b571c19d4c0b78d27dd3bf1f3c42e4032390af6)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/storvsc_drv.c
diff --cc drivers/scsi/storvsc_drv.c
index 4f24ca8255d8,fb41636519ee..000000000000
--- a/drivers/scsi/storvsc_drv.c
+++ b/drivers/scsi/storvsc_drv.c
@@@ -1837,10 -1842,11 +1837,16 @@@ static int storvsc_probe(struct hv_devi
  	 */
  	host->sg_tablesize = (stor_device->max_transfer_bytes >> PAGE_SHIFT);
  	/*
+ 	 * For non-IDE disks, the host supports multiple channels.
  	 * Set the number of HW queues we are supporting.
  	 */
++<<<<<<< HEAD
 +	if (stor_device->num_sc != 0)
 +		host->nr_hw_queues = stor_device->num_sc + 1;
++=======
+ 	if (!dev_is_ide)
+ 		host->nr_hw_queues = num_present_cpus();
++>>>>>>> 7b571c19d4c0 (scsi: storvsc: Correctly set number of hardware queues for IDE disk)
  
  	/*
  	 * Set the error handler work queue.
* Unmerged path drivers/scsi/storvsc_drv.c
