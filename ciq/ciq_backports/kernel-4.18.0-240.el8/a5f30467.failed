selftests: introduce gen_tar Makefile target

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Veronika Kabatova <vkabatov@redhat.com>
commit a5f304670b80973dfce5bc86cacff20244926cf6
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/a5f30467.failed

The gen_kselftest_tar.sh always packages *all* selftests and doesn't
pass along any variables to `make install` to influence what should be
built. This can result in an early error on the command line ("Unknown
tarball format TARGETS=XXX"), or unexpected test failures as the
tarball contains tests people wanted to skip on purpose.

Since the makefile already contains all the logic, we can add a target
for packaging. Keep the default .gz target the script uses, and actually
extend the supported formats by using tar's autodetection.

To not break current workflows, keep the gen_kselftest_tar.sh script as
it is, with an added suggestion to use the makefile target instead.

	Signed-off-by: Veronika Kabatova <vkabatov@redhat.com>
	Reviewed-by: Stefano Brivio <sbrivio@redhat.com>
	Signed-off-by: Shuah Khan <skhan@linuxfoundation.org>
(cherry picked from commit a5f304670b80973dfce5bc86cacff20244926cf6)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/testing/selftests/Makefile
#	tools/testing/selftests/gen_kselftest_tar.sh
diff --cc tools/testing/selftests/Makefile
index a94dc15ec364,1195bd85af38..000000000000
--- a/tools/testing/selftests/Makefile
+++ b/tools/testing/selftests/Makefile
@@@ -175,7 -259,7 +182,11 @@@ gen_tar: instal
  clean:
  	@for TARGET in $(TARGETS); do \
  		BUILD_TARGET=$$BUILD/$$TARGET;	\
 -		$(MAKE) OUTPUT=$$BUILD_TARGET -C $$TARGET clean;\
 +		make OUTPUT=$$BUILD_TARGET -C $$TARGET clean;\
  	done;
  
++<<<<<<< HEAD
 +.PHONY: all run_tests hotplug run_hotplug clean_hotplug run_pstore_crash install clean
++=======
+ .PHONY: khdr all run_tests hotplug run_hotplug clean_hotplug run_pstore_crash install clean gen_tar
++>>>>>>> a5f304670b80 (selftests: introduce gen_tar Makefile target)
diff --cc tools/testing/selftests/gen_kselftest_tar.sh
index a27e2eec3586,4a974bc03385..000000000000
--- a/tools/testing/selftests/gen_kselftest_tar.sh
+++ b/tools/testing/selftests/gen_kselftest_tar.sh
@@@ -38,16 -38,26 +38,29 @@@ main(
  	esac
  	fi
  
 -	# Create working directory.
 -	dest=`pwd`
 -	install_work="$dest"/kselftest_install
 -	install_name=kselftest
 -	install_dir="$install_work"/"$install_name"
 -	mkdir -p "$install_dir"
 +	install_dir=./kselftest
  
++<<<<<<< HEAD
 +# Run install using INSTALL_KSFT_PATH override to generate install
 +# directory
 +./kselftest_install.sh
 +tar $copts kselftest${ext} $install_dir
 +echo "Kselftest archive kselftest${ext} created!"
++=======
+ 	# Run install using INSTALL_KSFT_PATH override to generate install
+ 	# directory
+ 	./kselftest_install.sh "$install_dir"
+ 	(cd "$install_work"; tar $copts "$dest"/kselftest${ext} $install_name)
+ 
+ 	# Don't put the message at the actual end as people may be parsing the
+ 	# "archive created" line in their scripts.
+ 	echo -e "\nConsider using 'make gen_tar' instead of this script\n"
+ 
+ 	echo "Kselftest archive kselftest${ext} created!"
++>>>>>>> a5f304670b80 (selftests: introduce gen_tar Makefile target)
  
 -	# clean up top-level install work directory
 -	rm -rf "$install_work"
 +# clean up install directory
 +rm -rf kselftest
  }
  
  main "$@"
diff --git a/Documentation/dev-tools/kselftest.rst b/Documentation/dev-tools/kselftest.rst
index 5d1f56fcd2e7..469d115a95f1 100644
--- a/Documentation/dev-tools/kselftest.rst
+++ b/Documentation/dev-tools/kselftest.rst
@@ -151,6 +151,29 @@ note some tests will require root privileges::
    $ cd kselftest
    $ ./run_kselftest.sh
 
+Packaging selftests
+===================
+
+In some cases packaging is desired, such as when tests need to run on a
+different system. To package selftests, run::
+
+   $ make -C tools/testing/selftests gen_tar
+
+This generates a tarball in the `INSTALL_PATH/kselftest-packages` directory. By
+default, `.gz` format is used. The tar format can be overridden by specifying
+a `FORMAT` make variable. Any value recognized by `tar's auto-compress`_ option
+is supported, such as::
+
+    $ make -C tools/testing/selftests gen_tar FORMAT=.xz
+
+`make gen_tar` invokes `make install` so you can use it to package a subset of
+tests by using variables specified in `Running a subset of selftests`_
+section::
+
+    $ make -C tools/testing/selftests gen_tar TARGETS="bpf" FORMAT=.xz
+
+.. _tar's auto-compress: https://www.gnu.org/software/tar/manual/html_node/gzip.html#auto_002dcompress
+
 Contributing new tests
 ======================
 
* Unmerged path tools/testing/selftests/Makefile
* Unmerged path tools/testing/selftests/gen_kselftest_tar.sh
