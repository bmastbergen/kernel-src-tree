drm/ttm: flush the fence on the bo after we individualize the reservation object

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author xinhui pan <xinhui.pan@amd.com>
commit 1bbcf69e42fe7fd49b6f4339c970729d0e343753
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/1bbcf69e.failed

As we move the ttm_bo_individualize_resv() upwards, we need flush the
copied fence too. Otherwise the driver keeps waiting for fence.

run&Kill kfdtest, then perf top.

  25.53%  [ttm]                     [k] ttm_bo_delayed_delete
  24.29%  [kernel]                  [k] dma_resv_test_signaled_rcu
  19.72%  [kernel]                  [k] ww_mutex_lock

Fix: 378e2d5b("drm/ttm: fix ttm_bo_cleanup_refs_or_queue once more")
	Signed-off-by: xinhui pan <xinhui.pan@amd.com>
	Reviewed-by: Christian König <christian.koenig@amd.com>
Link: https://patchwork.freedesktop.org/series/72339/
	Signed-off-by: Christian König <christian.koenig@amd.com>
(cherry picked from commit 1bbcf69e42fe7fd49b6f4339c970729d0e343753)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/gpu/drm/ttm/ttm_bo.c
diff --cc drivers/gpu/drm/ttm/ttm_bo.c
index d9c05acf549f,1fbc36f05d89..000000000000
--- a/drivers/gpu/drm/ttm/ttm_bo.c
+++ b/drivers/gpu/drm/ttm/ttm_bo.c
@@@ -510,13 -486,15 +510,20 @@@ static void ttm_bo_cleanup_refs_or_queu
  		 */
  		if (bo->mem.placement & TTM_PL_FLAG_NO_EVICT) {
  			bo->mem.placement &= ~TTM_PL_FLAG_NO_EVICT;
 -			ttm_bo_move_to_lru_tail(bo, NULL);
 +			ttm_bo_add_to_lru(bo);
  		}
  
 -		dma_resv_unlock(bo->base.resv);
 +		reservation_object_unlock(bo->resv);
  	}
++<<<<<<< HEAD
 +	if (bo->resv != &bo->ttm_resv)
 +		reservation_object_unlock(&bo->ttm_resv);
++=======
+ 	if (bo->base.resv != &bo->base._resv) {
+ 		ttm_bo_flush_all_fences(bo);
+ 		dma_resv_unlock(&bo->base._resv);
+ 	}
++>>>>>>> 1bbcf69e42fe (drm/ttm: flush the fence on the bo after we individualize the reservation object)
  
  error:
  	kref_get(&bo->list_kref);
* Unmerged path drivers/gpu/drm/ttm/ttm_bo.c
