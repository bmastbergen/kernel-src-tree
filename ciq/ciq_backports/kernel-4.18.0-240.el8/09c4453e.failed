KVM: x86/mmu: Remove obsolete gfn restoration in FNAME(fetch)

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Sean Christopherson <sean.j.christopherson@intel.com>
commit 09c4453ee8e63a710774ae10da7909289aa6a58e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/09c4453e.failed

Remove logic to retrieve the original gfn now that HugeTLB mappings are
are identified in FNAME(fetch), i.e. FNAME(page_fault) no longer adjusts
the level or gfn.

	Signed-off-by: Sean Christopherson <sean.j.christopherson@intel.com>
	Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
(cherry picked from commit 09c4453ee8e63a710774ae10da7909289aa6a58e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kvm/mmu/paging_tmpl.h
diff --cc arch/x86/kvm/mmu/paging_tmpl.h
index 64abb6a4320c,885da924827c..000000000000
--- a/arch/x86/kvm/mmu/paging_tmpl.h
+++ b/arch/x86/kvm/mmu/paging_tmpl.h
@@@ -638,8 -635,8 +638,13 @@@ static int FNAME(fetch)(struct kvm_vcp
  	struct kvm_mmu_page *sp = NULL;
  	struct kvm_shadow_walk_iterator it;
  	unsigned direct_access, access = gw->pt_access;
++<<<<<<< HEAD
 +	int top_level, ret;
 +	gfn_t gfn, base_gfn;
++=======
+ 	int top_level, hlevel, ret;
+ 	gfn_t base_gfn = gw->gfn;
++>>>>>>> 09c4453ee8e6 (KVM: x86/mmu: Remove obsolete gfn restoration in FNAME(fetch))
  
  	direct_access = gw->pte_access;
  
@@@ -684,15 -681,7 +689,19 @@@
  			link_shadow_page(vcpu, it.sptep, sp);
  	}
  
++<<<<<<< HEAD
 +	/*
 +	 * FNAME(page_fault) might have clobbered the bottom bits of
 +	 * gw->gfn, restore them from the virtual address.
 +	 */
 +	gfn = gw->gfn | ((addr & PT_LVL_OFFSET_MASK(gw->level)) >> PAGE_SHIFT);
 +	base_gfn = gfn;
 +
 +	if (max_level > PT_PAGE_TABLE_LEVEL)
 +		transparent_hugepage_adjust(vcpu, gw->gfn, &pfn, &hlevel);
++=======
+ 	hlevel = kvm_mmu_hugepage_adjust(vcpu, gw->gfn, max_level, &pfn);
++>>>>>>> 09c4453ee8e6 (KVM: x86/mmu: Remove obsolete gfn restoration in FNAME(fetch))
  
  	trace_kvm_mmu_spte_requested(addr, gw->level, pfn);
  
* Unmerged path arch/x86/kvm/mmu/paging_tmpl.h
