KVM: PPC: Book3S HV: Don't do ultravisor calls on systems without ultravisor

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Paul Mackerras <paulus@ozlabs.org>
commit d89c69f42bf0fe42d1f52ea9b3dca15b1ade7601
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/d89c69f4.failed

Commit 22945688acd4 ("KVM: PPC: Book3S HV: Support reset of secure
guest") added a call to uv_svm_terminate, which is an ultravisor
call, without any check that the guest is a secure guest or even that
the system has an ultravisor.  On a system without an ultravisor,
the ultracall will degenerate to a hypercall, but since we are not
in KVM guest context, the hypercall will get treated as a system
call, which could have random effects depending on what happens to
be in r0, and could also corrupt the current task's kernel stack.
Hence this adds a test for the guest being a secure guest before
doing uv_svm_terminate().

Fixes: 22945688acd4 ("KVM: PPC: Book3S HV: Support reset of secure guest")
	Signed-off-by: Paul Mackerras <paulus@ozlabs.org>
(cherry picked from commit d89c69f42bf0fe42d1f52ea9b3dca15b1ade7601)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/powerpc/kvm/book3s_hv.c
diff --cc arch/powerpc/kvm/book3s_hv.c
index 46a62698fcb1,6ff3f896d908..000000000000
--- a/arch/powerpc/kvm/book3s_hv.c
+++ b/arch/powerpc/kvm/book3s_hv.c
@@@ -4921,8 -4983,11 +4921,13 @@@ static void kvmppc_core_destroy_vm_hv(s
  		if (nesting_enabled(kvm))
  			kvmhv_release_all_nested(kvm);
  		kvm->arch.process_table = 0;
++<<<<<<< HEAD
++=======
+ 		if (kvm->arch.secure_guest)
+ 			uv_svm_terminate(kvm->arch.lpid);
++>>>>>>> d89c69f42bf0 (KVM: PPC: Book3S HV: Don't do ultravisor calls on systems without ultravisor)
  		kvmhv_set_ptbl_entry(kvm->arch.lpid, 0, 0);
  	}
 -
  	kvmppc_free_lpid(kvm->arch.lpid);
  
  	kvmppc_free_pimap(kvm);
* Unmerged path arch/powerpc/kvm/book3s_hv.c
