KVM: nVMX: fixes for preemption timer migration

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Paolo Bonzini <pbonzini@redhat.com>
commit 83d31e5271ac74aad14b5a1a2ed26923e1446329
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/83d31e52.failed

Commit 850448f35aaf ("KVM: nVMX: Fix VMX preemption timer migration",
2020-06-01) accidentally broke nVMX live migration from older version
by changing the userspace ABI.  Restore it and, while at it, ensure
that vmx->nested.has_preemption_timer_deadline is always initialized
according to the KVM_STATE_VMX_PREEMPTION_TIMER_DEADLINE flag.

	Cc: Makarand Sonare <makarandsonare@google.com>
Fixes: 850448f35aaf ("KVM: nVMX: Fix VMX preemption timer migration")
	Reviewed-by: Jim Mattson <jmattson@google.com>
	Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
(cherry picked from commit 83d31e5271ac74aad14b5a1a2ed26923e1446329)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	Documentation/virt/kvm/api.txt
#	arch/x86/kvm/vmx/nested.c
diff --cc Documentation/virt/kvm/api.txt
index 0d675152fd35,320788f81a05..000000000000
--- a/Documentation/virt/kvm/api.txt
+++ b/Documentation/virt/kvm/api.txt
@@@ -3915,33 -4322,38 +3915,46 @@@ struct kvm_nested_state 
  		struct kvm_vmx_nested_state_data vmx[0];
  		struct kvm_svm_nested_state_data svm[0];
  	} data;
 -  };
 +};
  
 -  #define KVM_STATE_NESTED_GUEST_MODE		0x00000001
 -  #define KVM_STATE_NESTED_RUN_PENDING		0x00000002
 -  #define KVM_STATE_NESTED_EVMCS		0x00000004
 +#define KVM_STATE_NESTED_GUEST_MODE	0x00000001
 +#define KVM_STATE_NESTED_RUN_PENDING	0x00000002
 +#define KVM_STATE_NESTED_EVMCS		0x00000004
  
 -  #define KVM_STATE_NESTED_FORMAT_VMX		0
 -  #define KVM_STATE_NESTED_FORMAT_SVM		1
 +#define KVM_STATE_NESTED_FORMAT_VMX		0
 +#define KVM_STATE_NESTED_FORMAT_SVM		1
  
 -  #define KVM_STATE_NESTED_VMX_VMCS_SIZE	0x1000
 +#define KVM_STATE_NESTED_VMX_VMCS_SIZE		0x1000
  
 -  #define KVM_STATE_NESTED_VMX_SMM_GUEST_MODE	0x00000001
 -  #define KVM_STATE_NESTED_VMX_SMM_VMXON	0x00000002
 +#define KVM_STATE_NESTED_VMX_SMM_GUEST_MODE	0x00000001
 +#define KVM_STATE_NESTED_VMX_SMM_VMXON		0x00000002
  
++<<<<<<< HEAD:Documentation/virt/kvm/api.txt
 +struct kvm_vmx_nested_state_hdr {
++=======
+ #define KVM_STATE_VMX_PREEMPTION_TIMER_DEADLINE 0x00000001
+ 
+   struct kvm_vmx_nested_state_hdr {
++>>>>>>> 83d31e5271ac (KVM: nVMX: fixes for preemption timer migration):Documentation/virt/kvm/api.rst
  	__u64 vmxon_pa;
  	__u64 vmcs12_pa;
  
  	struct {
  		__u16 flags;
  	} smm;
++<<<<<<< HEAD:Documentation/virt/kvm/api.txt
 +};
++=======
+ 
+ 	__u32 flags;
+ 	__u64 preemption_timer_deadline;
+   };
++>>>>>>> 83d31e5271ac (KVM: nVMX: fixes for preemption timer migration):Documentation/virt/kvm/api.rst
  
 -  struct kvm_vmx_nested_state_data {
 +struct kvm_vmx_nested_state_data {
  	__u8 vmcs12[KVM_STATE_NESTED_VMX_VMCS_SIZE];
  	__u8 shadow_vmcs12[KVM_STATE_NESTED_VMX_VMCS_SIZE];
 -  };
 +};
  
  This ioctl copies the vcpu's nested virtualization state from the kernel to
  userspace.
diff --cc arch/x86/kvm/vmx/nested.c
index 555c188eb2d4,d4a4cec034d0..000000000000
--- a/arch/x86/kvm/vmx/nested.c
+++ b/arch/x86/kvm/vmx/nested.c
@@@ -6025,6 -6176,13 +6025,16 @@@ static int vmx_set_nested_state(struct 
  			goto error_guest_mode;
  	}
  
++<<<<<<< HEAD
++=======
+ 	vmx->nested.has_preemption_timer_deadline = false;
+ 	if (kvm_state->hdr.vmx.flags & KVM_STATE_VMX_PREEMPTION_TIMER_DEADLINE) {
+ 		vmx->nested.has_preemption_timer_deadline = true;
+ 		vmx->nested.preemption_timer_deadline =
+ 			kvm_state->hdr.vmx.preemption_timer_deadline;
+ 	}
+ 
++>>>>>>> 83d31e5271ac (KVM: nVMX: fixes for preemption timer migration)
  	if (nested_vmx_check_controls(vcpu, vmcs12) ||
  	    nested_vmx_check_host_state(vcpu, vmcs12) ||
  	    nested_vmx_check_guest_state(vcpu, vmcs12, &ignored))
* Unmerged path Documentation/virt/kvm/api.txt
diff --git a/arch/x86/include/uapi/asm/kvm.h b/arch/x86/include/uapi/asm/kvm.h
index 3f3f780c8c65..50c7e0009da8 100644
--- a/arch/x86/include/uapi/asm/kvm.h
+++ b/arch/x86/include/uapi/asm/kvm.h
@@ -409,6 +409,9 @@ struct kvm_vmx_nested_state_hdr {
 	struct {
 		__u16 flags;
 	} smm;
+
+	__u32 flags;
+	__u64 preemption_timer_deadline;
 };
 
 /* for KVM_CAP_NESTED_STATE */
* Unmerged path arch/x86/kvm/vmx/nested.c
