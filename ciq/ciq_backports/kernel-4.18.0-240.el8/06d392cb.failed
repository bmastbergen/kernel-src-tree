netfilter: nf_tables_offload: remove rules when the device unregisters

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author wenxu <wenxu@ucloud.cn>
commit 06d392cbe3db52c2ce01a2f486afd03eda75743b
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/06d392cb.failed

If the net_device unregisters, clean up the offload rules before the
chain is destroy.

	Signed-off-by: wenxu <wenxu@ucloud.cn>
	Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
(cherry picked from commit 06d392cbe3db52c2ce01a2f486afd03eda75743b)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	include/net/netfilter/nf_tables_offload.h
#	net/netfilter/nf_tables_api.c
#	net/netfilter/nf_tables_offload.c
diff --cc net/netfilter/nf_tables_api.c
index b6b54e6a024b,e4a68dc42694..000000000000
--- a/net/netfilter/nf_tables_api.c
+++ b/net/netfilter/nf_tables_api.c
@@@ -7606,26 -7688,32 +7606,44 @@@ static int __init nf_tables_module_init
  
  	err = register_netdevice_notifier(&nf_tables_flowtable_notifier);
  	if (err < 0)
 -		goto err3;
 +		goto err4;
  
++<<<<<<< HEAD
  	err = rhltable_init(&nft_objname_ht, &nft_objname_ht_params);
  	if (err < 0)
 -		goto err4;
 +		goto err5;
  
 +	/* must be last */
 +	err = nfnetlink_subsys_register(&nf_tables_subsys);
 +	if (err < 0)
 +		goto err6;
 +
 +	return err;
 +err6:
++=======
+ 	err = nft_offload_init();
+ 	if (err < 0)
+ 		goto err5;
+ 
+ 	/* must be last */
+ 	err = nfnetlink_subsys_register(&nf_tables_subsys);
+ 	if (err < 0)
+ 		goto err6;
+ 
+ 	nft_chain_route_init();
+ 
+ 	return err;
+ err6:
+ 	nft_offload_exit();
+ err5:
++>>>>>>> 06d392cbe3db (netfilter: nf_tables_offload: remove rules when the device unregisters)
  	rhltable_destroy(&nft_objname_ht);
 -err4:
 +err5:
  	unregister_netdevice_notifier(&nf_tables_flowtable_notifier);
 -err3:
 +err4:
  	nf_tables_core_module_exit();
 +err3:
 +	kfree(info);
  err2:
  	nft_chain_filter_fini();
  err1:
@@@ -7636,9 -7724,12 +7654,10 @@@
  static void __exit nf_tables_module_exit(void)
  {
  	nfnetlink_subsys_unregister(&nf_tables_subsys);
+ 	nft_offload_exit();
  	unregister_netdevice_notifier(&nf_tables_flowtable_notifier);
  	nft_chain_filter_fini();
 -	nft_chain_route_fini();
  	unregister_pernet_subsys(&nf_tables_net_ops);
 -	cancel_work_sync(&trans_destroy_work);
  	rcu_barrier();
  	rhltable_destroy(&nft_objname_ht);
  	nf_tables_core_module_exit();
* Unmerged path include/net/netfilter/nf_tables_offload.h
* Unmerged path net/netfilter/nf_tables_offload.c
* Unmerged path include/net/netfilter/nf_tables_offload.h
* Unmerged path net/netfilter/nf_tables_api.c
* Unmerged path net/netfilter/nf_tables_offload.c
