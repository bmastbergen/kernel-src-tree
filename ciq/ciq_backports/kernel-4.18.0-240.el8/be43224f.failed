netdevsim: Ensure policer drop counter always increases

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Ido Schimmel <idosch@mellanox.com>
commit be43224fc0e4697ad0d03107cbaf1ecf26e7ee72
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/be43224f.failed

In case the policer drop counter is retrieved when the jiffies value is
a multiple of 64, the counter will not be incremented.

This randomly breaks a selftest [1] the reads the counter twice and
checks that it was incremented:

```
TEST: Trap policer                                                  [FAIL]
	Policer drop counter was not incremented
```

Fix by always incrementing the counter by 1.

[1] tools/testing/selftests/drivers/net/netdevsim/devlink_trap.sh

Fixes: ad188458d012 ("netdevsim: Add devlink-trap policer support")
	Signed-off-by: Ido Schimmel <idosch@mellanox.com>
	Reviewed-by: Jiri Pirko <jiri@mellanox.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit be43224fc0e4697ad0d03107cbaf1ecf26e7ee72)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/netdevsim/dev.c
diff --cc drivers/net/netdevsim/dev.c
index 4d23a9753629,dc3ff0e20944..000000000000
--- a/drivers/net/netdevsim/dev.c
+++ b/drivers/net/netdevsim/dev.c
@@@ -677,6 -817,52 +677,55 @@@ nsim_dev_devlink_trap_action_set(struc
  	return 0;
  }
  
++<<<<<<< HEAD
++=======
+ static int
+ nsim_dev_devlink_trap_group_set(struct devlink *devlink,
+ 				const struct devlink_trap_group *group,
+ 				const struct devlink_trap_policer *policer)
+ {
+ 	struct nsim_dev *nsim_dev = devlink_priv(devlink);
+ 
+ 	if (nsim_dev->fail_trap_group_set)
+ 		return -EINVAL;
+ 
+ 	return 0;
+ }
+ 
+ static int
+ nsim_dev_devlink_trap_policer_set(struct devlink *devlink,
+ 				  const struct devlink_trap_policer *policer,
+ 				  u64 rate, u64 burst,
+ 				  struct netlink_ext_ack *extack)
+ {
+ 	struct nsim_dev *nsim_dev = devlink_priv(devlink);
+ 
+ 	if (nsim_dev->fail_trap_policer_set) {
+ 		NL_SET_ERR_MSG_MOD(extack, "User setup the operation to fail for testing purposes");
+ 		return -EINVAL;
+ 	}
+ 
+ 	return 0;
+ }
+ 
+ static int
+ nsim_dev_devlink_trap_policer_counter_get(struct devlink *devlink,
+ 					  const struct devlink_trap_policer *policer,
+ 					  u64 *p_drops)
+ {
+ 	struct nsim_dev *nsim_dev = devlink_priv(devlink);
+ 	u64 *cnt;
+ 
+ 	if (nsim_dev->fail_trap_policer_counter_get)
+ 		return -EINVAL;
+ 
+ 	cnt = &nsim_dev->trap_data->trap_policers_cnt_arr[policer->id - 1];
+ 	*p_drops = (*cnt)++;
+ 
+ 	return 0;
+ }
+ 
++>>>>>>> be43224fc0e4 (netdevsim: Ensure policer drop counter always increases)
  static const struct devlink_ops nsim_dev_devlink_ops = {
  	.reload_down = nsim_dev_reload_down,
  	.reload_up = nsim_dev_reload_up,
* Unmerged path drivers/net/netdevsim/dev.c
