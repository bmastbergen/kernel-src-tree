ASoC: SOF: fix PCM playback through ALSA OSS emulation

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
Rebuild_CHGLOG: - [sound] ALSA: ASoC: SOF: fix PCM playback through ALSA OSS emulation (Jaroslav Kysela) [1797509]
Rebuild_FUZZ: 94.74%
commit-author Kai Vehmanen <kai.vehmanen@linux.intel.com>
commit cfe8191b1bbf2b41581b63eb97e56cd6bc3c34a1
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/cfe8191b.failed

Any app using ALSA OSS emulation on top of SOF will fail
to error from OSS SNDCTL_DSP_SETFMT ioctl. Reported initially
as an issue with xournalpp (application using PortAudio with
an OSS backend), but applies more generally to other apps
using OSS as well.

Problem is caused by SOF PCM not supporting repeated calls
to hw_params(), without matching calls to pcm_free(). This
is however exactly what the ALSA OSS PCM code is doing when
it is handling the OSS ioctls.

The problem will lead to leaking of DSP resources and eventual
failure of DSP PCM_PARAMS IPC.

BugLink: https://github.com/thesofproject/linux/issues/1510
	Signed-off-by: Kai Vehmanen <kai.vehmanen@linux.intel.com>
	Signed-off-by: Pierre-Louis Bossart <pierre-louis.bossart@linux.intel.com>
Link: https://lore.kernel.org/r/20200110235751.3404-7-pierre-louis.bossart@linux.intel.com
	Signed-off-by: Mark Brown <broonie@kernel.org>
(cherry picked from commit cfe8191b1bbf2b41581b63eb97e56cd6bc3c34a1)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	sound/soc/sof/pcm.c
diff --cc sound/soc/sof/pcm.c
index dd0bf75d160e,314f3095c12f..000000000000
--- a/sound/soc/sof/pcm.c
+++ b/sound/soc/sof/pcm.c
@@@ -114,7 -133,17 +134,21 @@@ static int sof_pcm_hw_params(struct snd
  	if (!spcm)
  		return -EINVAL;
  
++<<<<<<< HEAD
 +	dev_dbg(sdev->dev, "pcm: hw params stream %d dir %d\n",
++=======
+ 	/*
+ 	 * Handle repeated calls to hw_params() without free_pcm() in
+ 	 * between. At least ALSA OSS emulation depends on this.
+ 	 */
+ 	if (spcm->prepared[substream->stream]) {
+ 		ret = sof_pcm_dsp_pcm_free(substream, sdev, spcm);
+ 		if (ret < 0)
+ 			return ret;
+ 	}
+ 
+ 	dev_dbg(component->dev, "pcm: hw params stream %d dir %d\n",
++>>>>>>> cfe8191b1bbf (ASoC: SOF: fix PCM playback through ALSA OSS emulation)
  		spcm->pcm.pcm_id, substream->stream);
  
  	memset(&pcm, 0, sizeof(pcm));
* Unmerged path sound/soc/sof/pcm.c
