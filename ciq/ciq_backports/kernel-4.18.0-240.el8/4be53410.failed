KVM: VMX: Initialize vmx->guest_msrs[] right after allocation

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
Rebuild_CHGLOG: - [x86] kvm: vmx: Initialize vmx->guest_msrs[] right after allocation (Vitaly Kuznetsov) [1813987]
Rebuild_FUZZ: 97.48%
commit-author Xiaoyao Li <xiaoyao.li@intel.com>
commit 4be5341026246870818e28b53202b001426a5aec
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/4be53410.failed

Move the initialization of vmx->guest_msrs[] from vmx_vcpu_setup() to
vmx_create_vcpu(), and put it right after its allocation.

This also is the preperation for next patch.

	Signed-off-by: Xiaoyao Li <xiaoyao.li@intel.com>
	Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
(cherry picked from commit 4be5341026246870818e28b53202b001426a5aec)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kvm/vmx/vmx.c
diff --cc arch/x86/kvm/vmx/vmx.c
index a337f6f1d082,84c32395d887..000000000000
--- a/arch/x86/kvm/vmx/vmx.c
+++ b/arch/x86/kvm/vmx/vmx.c
@@@ -4259,34 -4224,6 +4257,37 @@@ static void vmx_vcpu_setup(struct vcpu_
  	if (vmcs_config.vmentry_ctrl & VM_ENTRY_LOAD_IA32_PAT)
  		vmcs_write64(GUEST_IA32_PAT, vmx->vcpu.arch.pat);
  
++<<<<<<< HEAD
 +	for (i = 0; i < ARRAY_SIZE(vmx_msr_index); ++i) {
 +		u32 index = vmx_msr_index[i];
 +		u32 data_low, data_high;
 +		int j = vmx->nmsrs;
 +
 +		if (rdmsr_safe(index, &data_low, &data_high) < 0)
 +			continue;
 +		if (wrmsr_safe(index, data_low, data_high) < 0)
 +			continue;
 +		vmx->guest_msrs[j].index = i;
 +		vmx->guest_msrs[j].data = 0;
 +
 +		switch (index) {
 +		case MSR_IA32_TSX_CTRL:
 +			/*
 +			 * No need to pass TSX_CTRL_CPUID_CLEAR through, so
 +			 * let's avoid changing CPUID bits under the host
 +			 * kernel's feet.
 +			 */
 +			vmx->guest_msrs[j].mask = ~(u64)TSX_CTRL_CPUID_CLEAR;
 +			break;
 +		default:
 +			vmx->guest_msrs[j].mask = -1ull;
 +			break;
 +		}
 +		++vmx->nmsrs;
 +	}
 +
++=======
++>>>>>>> 4be534102624 (KVM: VMX: Initialize vmx->guest_msrs[] right after allocation)
  	vm_exit_controls_set(vmx, vmx_vmexit_ctrl());
  
  	/* 22.2.1, 20.8.1 */
* Unmerged path arch/x86/kvm/vmx/vmx.c
