irqchip/gic-v3: Add quirks for HIP06/07 invalid GICD_TYPER erratum 161010803

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Marc Zyngier <maz@kernel.org>
commit 7f2481b39b4c776fb9c03081ffcfe81f4961601c
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/7f2481b3.failed

It looks like the HIP06/07 SoCs have extra bits in their GICD_TYPER
registers, which confuse the GICv3.1 code (these systems appear to
expose ESPIs while they actually don't).

Detect these systems as early as possible and wipe the fields that
should be RES0 in the register.

	Tested-by: John Garry <john.garry@huawei.com>
	Signed-off-by: Marc Zyngier <maz@kernel.org>
(cherry picked from commit 7f2481b39b4c776fb9c03081ffcfe81f4961601c)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	Documentation/arm64/silicon-errata.txt
diff --cc Documentation/arm64/silicon-errata.txt
index cb28aba3d2a4,17ea3fecddaa..000000000000
--- a/Documentation/arm64/silicon-errata.txt
+++ b/Documentation/arm64/silicon-errata.txt
@@@ -42,48 -46,90 +42,54 @@@ file acts as a registry of software wor
  will be updated when new workarounds are committed and backported to
  stable kernels.
  
 -+----------------+-----------------+-----------------+-----------------------------+
  | Implementor    | Component       | Erratum ID      | Kconfig                     |
 -+================+=================+=================+=============================+
 -| Allwinner      | A64/R18         | UNKNOWN1        | SUN50I_ERRATUM_UNKNOWN1     |
 -+----------------+-----------------+-----------------+-----------------------------+
  +----------------+-----------------+-----------------+-----------------------------+
  | ARM            | Cortex-A53      | #826319         | ARM64_ERRATUM_826319        |
 -+----------------+-----------------+-----------------+-----------------------------+
  | ARM            | Cortex-A53      | #827319         | ARM64_ERRATUM_827319        |
 -+----------------+-----------------+-----------------+-----------------------------+
  | ARM            | Cortex-A53      | #824069         | ARM64_ERRATUM_824069        |
 -+----------------+-----------------+-----------------+-----------------------------+
  | ARM            | Cortex-A53      | #819472         | ARM64_ERRATUM_819472        |
 -+----------------+-----------------+-----------------+-----------------------------+
  | ARM            | Cortex-A53      | #845719         | ARM64_ERRATUM_845719        |
 -+----------------+-----------------+-----------------+-----------------------------+
  | ARM            | Cortex-A53      | #843419         | ARM64_ERRATUM_843419        |
 -+----------------+-----------------+-----------------+-----------------------------+
  | ARM            | Cortex-A57      | #832075         | ARM64_ERRATUM_832075        |
 -+----------------+-----------------+-----------------+-----------------------------+
  | ARM            | Cortex-A57      | #852523         | N/A                         |
 -+----------------+-----------------+-----------------+-----------------------------+
  | ARM            | Cortex-A57      | #834220         | ARM64_ERRATUM_834220        |
 -+----------------+-----------------+-----------------+-----------------------------+
  | ARM            | Cortex-A72      | #853709         | N/A                         |
 -+----------------+-----------------+-----------------+-----------------------------+
  | ARM            | Cortex-A73      | #858921         | ARM64_ERRATUM_858921        |
 -+----------------+-----------------+-----------------+-----------------------------+
  | ARM            | Cortex-A55      | #1024718        | ARM64_ERRATUM_1024718       |
 -+----------------+-----------------+-----------------+-----------------------------+
  | ARM            | Cortex-A76      | #1188873,1418040| ARM64_ERRATUM_1418040       |
 -+----------------+-----------------+-----------------+-----------------------------+
  | ARM            | Cortex-A76      | #1165522        | ARM64_ERRATUM_1165522       |
 -+----------------+-----------------+-----------------+-----------------------------+
  | ARM            | Cortex-A76      | #1286807        | ARM64_ERRATUM_1286807       |
 -+----------------+-----------------+-----------------+-----------------------------+
  | ARM            | Cortex-A76      | #1463225        | ARM64_ERRATUM_1463225       |
 -+----------------+-----------------+-----------------+-----------------------------+
 +| ARM            | Neoverse-N1     | #1349291        | N/A                         |
  | ARM            | Neoverse-N1     | #1188873,1418040| ARM64_ERRATUM_1418040       |
 -+----------------+-----------------+-----------------+-----------------------------+
  | ARM            | Neoverse-N1     | #1349291        | N/A                         |
 -+----------------+-----------------+-----------------+-----------------------------+
 +| ARM            | Neoverse-N1     | #1542419        | ARM64_ERRATUM_1542419       |
  | ARM            | MMU-500         | #841119,826419  | N/A                         |
 -+----------------+-----------------+-----------------+-----------------------------+
 -+----------------+-----------------+-----------------+-----------------------------+
 +|                |                 |                 |                             |
  | Cavium         | ThunderX ITS    | #22375,24313    | CAVIUM_ERRATUM_22375        |
 -+----------------+-----------------+-----------------+-----------------------------+
  | Cavium         | ThunderX ITS    | #23144          | CAVIUM_ERRATUM_23144        |
 -+----------------+-----------------+-----------------+-----------------------------+
  | Cavium         | ThunderX GICv3  | #23154          | CAVIUM_ERRATUM_23154        |
 -+----------------+-----------------+-----------------+-----------------------------+
  | Cavium         | ThunderX Core   | #27456          | CAVIUM_ERRATUM_27456        |
 -+----------------+-----------------+-----------------+-----------------------------+
  | Cavium         | ThunderX Core   | #30115          | CAVIUM_ERRATUM_30115        |
 -+----------------+-----------------+-----------------+-----------------------------+
  | Cavium         | ThunderX SMMUv2 | #27704          | N/A                         |
 -+----------------+-----------------+-----------------+-----------------------------+
  | Cavium         | ThunderX2 SMMUv3| #74             | N/A                         |
 -+----------------+-----------------+-----------------+-----------------------------+
  | Cavium         | ThunderX2 SMMUv3| #126            | N/A                         |
 -+----------------+-----------------+-----------------+-----------------------------+
 -+----------------+-----------------+-----------------+-----------------------------+
 +| Cavium         | ThunderX2 Core  | #219            | CAVIUM_TX2_ERRATUM_219      |
 +|                |                 |                 |                             |
  | Freescale/NXP  | LS2080A/LS1043A | A-008585        | FSL_ERRATUM_A008585         |
 -+----------------+-----------------+-----------------+-----------------------------+
 -+----------------+-----------------+-----------------+-----------------------------+
 +|                |                 |                 |                             |
  | Hisilicon      | Hip0{5,6,7}     | #161010101      | HISILICON_ERRATUM_161010101 |
 -+----------------+-----------------+-----------------+-----------------------------+
  | Hisilicon      | Hip0{6,7}       | #161010701      | N/A                         |
++<<<<<<< HEAD:Documentation/arm64/silicon-errata.txt
++=======
+ +----------------+-----------------+-----------------+-----------------------------+
+ | Hisilicon      | Hip0{6,7}       | #161010803      | N/A                         |
+ +----------------+-----------------+-----------------+-----------------------------+
++>>>>>>> 7f2481b39b4c (irqchip/gic-v3: Add quirks for HIP06/07 invalid GICD_TYPER erratum 161010803):Documentation/arm64/silicon-errata.rst
  | Hisilicon      | Hip07           | #161600802      | HISILICON_ERRATUM_161600802 |
 -+----------------+-----------------+-----------------+-----------------------------+
 -| Hisilicon      | Hip08 SMMU PMCG | #162001800      | N/A                         |
 -+----------------+-----------------+-----------------+-----------------------------+
 -+----------------+-----------------+-----------------+-----------------------------+
 +|                |                 |                 |                             |
  | Qualcomm Tech. | Kryo/Falkor v1  | E1003           | QCOM_FALKOR_ERRATUM_1003    |
 -+----------------+-----------------+-----------------+-----------------------------+
  | Qualcomm Tech. | Falkor v1       | E1009           | QCOM_FALKOR_ERRATUM_1009    |
 -+----------------+-----------------+-----------------+-----------------------------+
  | Qualcomm Tech. | QDF2400 ITS     | E0065           | QCOM_QDF2400_ERRATUM_0065   |
 -+----------------+-----------------+-----------------+-----------------------------+
  | Qualcomm Tech. | Falkor v{1,2}   | E1041           | QCOM_FALKOR_ERRATUM_1041    |
 -+----------------+-----------------+-----------------+-----------------------------+
 -+----------------+-----------------+-----------------+-----------------------------+
  | Fujitsu        | A64FX           | E#010001        | FUJITSU_ERRATUM_010001      |
 -+----------------+-----------------+-----------------+-----------------------------+
* Unmerged path Documentation/arm64/silicon-errata.txt
diff --git a/drivers/irqchip/irq-gic-v3.c b/drivers/irqchip/irq-gic-v3.c
index d5a3622c5bfa..56ea0d5cfd1d 100644
--- a/drivers/irqchip/irq-gic-v3.c
+++ b/drivers/irqchip/irq-gic-v3.c
@@ -1452,6 +1452,48 @@ static bool gic_enable_quirk_msm8996(void *data)
 	return true;
 }
 
+static bool gic_enable_quirk_hip06_07(void *data)
+{
+	struct gic_chip_data *d = data;
+
+	/*
+	 * HIP06 GICD_IIDR clashes with GIC-600 product number (despite
+	 * not being an actual ARM implementation). The saving grace is
+	 * that GIC-600 doesn't have ESPI, so nothing to do in that case.
+	 * HIP07 doesn't even have a proper IIDR, and still pretends to
+	 * have ESPI. In both cases, put them right.
+	 */
+	if (d->rdists.gicd_typer & GICD_TYPER_ESPI) {
+		/* Zero both ESPI and the RES0 field next to it... */
+		d->rdists.gicd_typer &= ~GENMASK(9, 8);
+		return true;
+	}
+
+	return false;
+}
+
+static const struct gic_quirk gic_quirks[] = {
+	{
+		.desc	= "GICv3: Qualcomm MSM8996 broken firmware",
+		.compatible = "qcom,msm8996-gic-v3",
+		.init	= gic_enable_quirk_msm8996,
+	},
+	{
+		.desc	= "GICv3: HIP06 erratum 161010803",
+		.iidr	= 0x0204043b,
+		.mask	= 0xffffffff,
+		.init	= gic_enable_quirk_hip06_07,
+	},
+	{
+		.desc	= "GICv3: HIP07 erratum 161010803",
+		.iidr	= 0x00000000,
+		.mask	= 0xffffffff,
+		.init	= gic_enable_quirk_hip06_07,
+	},
+	{
+	}
+};
+
 static void gic_enable_nmi_support(void)
 {
 	int i;
@@ -1505,6 +1547,10 @@ static int __init gic_init_bases(void __iomem *dist_base,
 	 */
 	typer = readl_relaxed(gic_data.dist_base + GICD_TYPER);
 	gic_data.rdists.gicd_typer = typer;
+
+	gic_enable_quirks(readl_relaxed(gic_data.dist_base + GICD_IIDR),
+			  gic_quirks, &gic_data);
+
 	pr_info("%d SPIs implemented\n", GIC_LINE_NR - 32);
 	pr_info("%d Extended SPIs implemented\n", GIC_ESPI_NR);
 	gic_data.domain = irq_domain_create_tree(handle, &gic_irq_domain_ops,
@@ -1687,16 +1733,6 @@ static void __init gic_of_setup_kvm_info(struct device_node *node)
 	gic_set_kvm_info(&gic_v3_kvm_info);
 }
 
-static const struct gic_quirk gic_quirks[] = {
-	{
-		.desc	= "GICv3: Qualcomm MSM8996 broken firmware",
-		.compatible = "qcom,msm8996-gic-v3",
-		.init	= gic_enable_quirk_msm8996,
-	},
-	{
-	}
-};
-
 static int __init gic_of_init(struct device_node *node, struct device_node *parent)
 {
 	void __iomem *dist_base;
