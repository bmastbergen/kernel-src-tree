KVM: s390: protvirt: disallow one_reg

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Janosch Frank <frankja@linux.ibm.com>
commit 68cf7b1f137e61cea71925e48bc0c6d7bcfc637c
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/68cf7b1f.failed

A lot of the registers are controlled by the Ultravisor and never
visible to KVM. Some fields in the sie control block are overlayed, like
gbea. As no known userspace uses the ONE_REG interface on s390 if sync
regs are available, no functionality is lost if it is disabled for
protected guests.

	Signed-off-by: Janosch Frank <frankja@linux.ibm.com>
	Reviewed-by: Thomas Huth <thuth@redhat.com>
	Reviewed-by: Cornelia Huck <cohuck@redhat.com>
	Reviewed-by: David Hildenbrand <david@redhat.com>
[borntraeger@de.ibm.com: patch merging, splitting, fixing]
	Signed-off-by: Christian Borntraeger <borntraeger@de.ibm.com>
(cherry picked from commit 68cf7b1f137e61cea71925e48bc0c6d7bcfc637c)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	Documentation/virt/kvm/api.txt
diff --cc Documentation/virt/kvm/api.txt
index 0fa33ec7673f,7505d7a6c0d8..000000000000
--- a/Documentation/virt/kvm/api.txt
+++ b/Documentation/virt/kvm/api.txt
@@@ -1910,16 -2105,23 +1910,27 @@@ prior to calling the KVM_RUN ioctl
  
  
  4.68 KVM_SET_ONE_REG
 ---------------------
 -
 -:Capability: KVM_CAP_ONE_REG
 -:Architectures: all
 -:Type: vcpu ioctl
 -:Parameters: struct kvm_one_reg (in)
 -:Returns: 0 on success, negative value on failure
  
 +Capability: KVM_CAP_ONE_REG
 +Architectures: all
 +Type: vcpu ioctl
 +Parameters: struct kvm_one_reg (in)
 +Returns: 0 on success, negative value on failure
  Errors:
++<<<<<<< HEAD:Documentation/virt/kvm/api.txt
 +  ENOENT:   no such register
 +  EINVAL:   invalid register ID, or no such register
 +  EPERM:    (arm64) register access not allowed before vcpu finalization
++=======
+ 
+   ======   ============================================================
+   ENOENT   no such register
+   EINVAL   invalid register ID, or no such register or used with VMs in
+            protected virtualization mode on s390
+   EPERM    (arm64) register access not allowed before vcpu finalization
+   ======   ============================================================
+ 
++>>>>>>> 68cf7b1f137e (KVM: s390: protvirt: disallow one_reg):Documentation/virt/kvm/api.rst
  (These error codes are indicative only: do not rely on a specific error
  code being returned in a specific situation.)
  
@@@ -2312,16 -2541,23 +2323,27 @@@ following id bit patterns
  
  
  4.69 KVM_GET_ONE_REG
 ---------------------
 -
 -:Capability: KVM_CAP_ONE_REG
 -:Architectures: all
 -:Type: vcpu ioctl
 -:Parameters: struct kvm_one_reg (in and out)
 -:Returns: 0 on success, negative value on failure
  
 +Capability: KVM_CAP_ONE_REG
 +Architectures: all
 +Type: vcpu ioctl
 +Parameters: struct kvm_one_reg (in and out)
 +Returns: 0 on success, negative value on failure
  Errors include:
++<<<<<<< HEAD:Documentation/virt/kvm/api.txt
 +  ENOENT:   no such register
 +  EINVAL:   invalid register ID, or no such register
 +  EPERM:    (arm64) register access not allowed before vcpu finalization
++=======
+ 
+   ======== ============================================================
+   ENOENT   no such register
+   EINVAL   invalid register ID, or no such register or used with VMs in
+            protected virtualization mode on s390
+   EPERM    (arm64) register access not allowed before vcpu finalization
+   ======== ============================================================
+ 
++>>>>>>> 68cf7b1f137e (KVM: s390: protvirt: disallow one_reg):Documentation/virt/kvm/api.rst
  (These error codes are indicative only: do not rely on a specific error
  code being returned in a specific situation.)
  
* Unmerged path Documentation/virt/kvm/api.txt
diff --git a/arch/s390/kvm/kvm-s390.c b/arch/s390/kvm/kvm-s390.c
index 4c71e931da45..44007978467c 100644
--- a/arch/s390/kvm/kvm-s390.c
+++ b/arch/s390/kvm/kvm-s390.c
@@ -4383,6 +4383,9 @@ long kvm_arch_vcpu_ioctl(struct file *filp,
 	case KVM_SET_ONE_REG:
 	case KVM_GET_ONE_REG: {
 		struct kvm_one_reg reg;
+		r = -EINVAL;
+		if (kvm_s390_pv_cpu_is_protected(vcpu))
+			break;
 		r = -EFAULT;
 		if (copy_from_user(&reg, argp, sizeof(reg)))
 			break;
