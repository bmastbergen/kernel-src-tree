selftests/bpf: Validate frozen map contents stays frozen

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Andrii Nakryiko <andriin@fb.com>
commit 642c1654702731ab42a3be771bebbd6ef938f0dc
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/642c1654.failed

Test that frozen and mmap()'ed BPF map can't be mprotect()'ed as writable or
executable memory. Also validate that "downgrading" from writable to read-only
doesn't screw up internal writable count accounting for the purposes of map
freezing.

	Signed-off-by: Andrii Nakryiko <andriin@fb.com>
	Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
Link: https://lore.kernel.org/bpf/20200410202613.3679837-2-andriin@fb.com
(cherry picked from commit 642c1654702731ab42a3be771bebbd6ef938f0dc)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/testing/selftests/bpf/prog_tests/mmap.c
diff --cc tools/testing/selftests/bpf/prog_tests/mmap.c
index 051a6d48762c,56d80adcf4bd..000000000000
--- a/tools/testing/selftests/bpf/prog_tests/mmap.c
+++ b/tools/testing/selftests/bpf/prog_tests/mmap.c
@@@ -26,36 -19,32 +26,59 @@@ void test_mmap(void
  	const size_t map_sz = roundup_page(sizeof(struct map_data));
  	const int zero = 0, one = 1, two = 2, far = 1500;
  	const long page_size = sysconf(_SC_PAGE_SIZE);
++<<<<<<< HEAD
 +	int err, duration = 0, i, data_map_fd;
 +	struct bpf_program *prog;
 +	struct bpf_object *obj;
 +	struct bpf_link *link = NULL;
 +	struct bpf_map *data_map, *bss_map;
 +	void *bss_mmaped = NULL, *map_mmaped = NULL, *tmp1, *tmp2;
 +	volatile struct bss_data *bss_data;
 +	volatile struct map_data *map_data;
 +	__u64 val = 0;
 +
 +	obj = bpf_object__open_file("test_mmap.o", NULL);
 +	if (CHECK(IS_ERR(obj), "obj_open", "failed to open '%s': %ld\n",
 +		  file, PTR_ERR(obj)))
++=======
+ 	int err, duration = 0, i, data_map_fd, data_map_id, tmp_fd;
+ 	struct bpf_map *data_map, *bss_map;
+ 	void *bss_mmaped = NULL, *map_mmaped = NULL, *tmp1, *tmp2;
+ 	struct test_mmap__bss *bss_data;
+ 	struct bpf_map_info map_info;
+ 	__u32 map_info_sz = sizeof(map_info);
+ 	struct map_data *map_data;
+ 	struct test_mmap *skel;
+ 	__u64 val = 0;
+ 
+ 	skel = test_mmap__open_and_load();
+ 	if (CHECK(!skel, "skel_open_and_load", "skeleton open/load failed\n"))
++>>>>>>> 642c16547027 (selftests/bpf: Validate frozen map contents stays frozen)
  		return;
 +	prog = bpf_object__find_program_by_title(obj, probe_name);
 +	if (CHECK(!prog, "find_probe", "prog '%s' not found\n", probe_name))
 +		goto cleanup;
 +	err = bpf_object__load(obj);
 +	if (CHECK(err, "obj_load", "failed to load prog '%s': %d\n",
 +		  probe_name, err))
 +		goto cleanup;
  
 -	bss_map = skel->maps.bss;
 -	data_map = skel->maps.data_map;
 +	bss_map = bpf_object__find_map_by_name(obj, "test_mma.bss");
 +	if (CHECK(!bss_map, "find_bss_map", ".bss map not found\n"))
 +		goto cleanup;
 +	data_map = bpf_object__find_map_by_name(obj, "data_map");
 +	if (CHECK(!data_map, "find_data_map", "data_map map not found\n"))
 +		goto cleanup;
  	data_map_fd = bpf_map__fd(data_map);
  
+ 	/* get map's ID */
+ 	memset(&map_info, 0, map_info_sz);
+ 	err = bpf_obj_get_info_by_fd(data_map_fd, &map_info, &map_info_sz);
+ 	if (CHECK(err, "map_get_info", "failed %d\n", errno))
+ 		goto cleanup;
+ 	data_map_id = map_info.id;
+ 
+ 	/* mmap BSS map */
  	bss_mmaped = mmap(NULL, bss_sz, PROT_READ | PROT_WRITE, MAP_SHARED,
  			  bpf_map__fd(bss_map), 0);
  	if (CHECK(bss_mmaped == MAP_FAILED, "bss_mmap",
* Unmerged path tools/testing/selftests/bpf/prog_tests/mmap.c
