selftests: gen_kselftest_tar.sh: Do not clobber kselftest/

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Kees Cook <keescook@chromium.org>
commit ea1bf0bb18c0bd627d7b551196453ff2fff44225
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/ea1bf0bb.failed

The default installation location for gen_kselftest_tar.sh was still
"kselftest/" which collides with the existing directory. Instead, this
moves the installation target into "kselftest_install/kselftest/" and
adjusts the tar creation accordingly. This also adjusts indentation and
logic to be consistent.

Fixes: 42d46e57ec97 ("selftests: Extract single-test shell logic from lib.mk")
	Signed-off-by: Kees Cook <keescook@chromium.org>
	Signed-off-by: Shuah Khan <skhan@linuxfoundation.org>
(cherry picked from commit ea1bf0bb18c0bd627d7b551196453ff2fff44225)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/testing/selftests/kselftest_install.sh
diff --cc tools/testing/selftests/kselftest_install.sh
index ec304463883c,407af7da7037..000000000000
--- a/tools/testing/selftests/kselftest_install.sh
+++ b/tools/testing/selftests/kselftest_install.sh
@@@ -20,16 -24,12 +24,21 @@@ main(
  		echo "$0: $1 doesn't exist!!"
  		exit 1;
  	else
- 		install_loc=$1
- 		echo "$0: Installing in specified location - $install_loc ..."
+ 		install_dir="$1"
+ 		echo "$0: Installing in specified location - $install_dir ..."
  	fi
  
++<<<<<<< HEAD
 +	install_dir=$install_loc/kselftest
 +
 +# Create install directory
 +	mkdir -p $install_dir
 +# Build tests
 +	INSTALL_PATH=$install_dir make install
++=======
+ 	# Build tests
+ 	KSFT_INSTALL_PATH="$install_dir" make install
++>>>>>>> ea1bf0bb18c0 (selftests: gen_kselftest_tar.sh: Do not clobber kselftest/)
  }
  
  main "$@"
diff --git a/tools/testing/selftests/gen_kselftest_tar.sh b/tools/testing/selftests/gen_kselftest_tar.sh
index a27e2eec3586..8b2b6088540d 100755
--- a/tools/testing/selftests/gen_kselftest_tar.sh
+++ b/tools/testing/selftests/gen_kselftest_tar.sh
@@ -38,16 +38,21 @@ main()
 	esac
 	fi
 
-	install_dir=./kselftest
+	# Create working directory.
+	dest=`pwd`
+	install_work="$dest"/kselftest_install
+	install_name=kselftest
+	install_dir="$install_work"/"$install_name"
+	mkdir -p "$install_dir"
 
-# Run install using INSTALL_KSFT_PATH override to generate install
-# directory
-./kselftest_install.sh
-tar $copts kselftest${ext} $install_dir
-echo "Kselftest archive kselftest${ext} created!"
+	# Run install using INSTALL_KSFT_PATH override to generate install
+	# directory
+	./kselftest_install.sh "$install_dir"
+	(cd "$install_work"; tar $copts "$dest"/kselftest${ext} $install_name)
+	echo "Kselftest archive kselftest${ext} created!"
 
-# clean up install directory
-rm -rf kselftest
+	# clean up top-level install work directory
+	rm -rf "$install_work"
 }
 
 main "$@"
* Unmerged path tools/testing/selftests/kselftest_install.sh
