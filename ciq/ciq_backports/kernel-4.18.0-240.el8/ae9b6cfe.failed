drm/i915: Fix AUX power domain toggling across TypeC mode resets

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Imre Deak <imre.deak@intel.com>
commit ae9b6cfe1352da25931bce3ea4acfd4dc1ac8a85
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/ae9b6cfe.failed

Make sure to select the port's AUX power domain while holding the TC
port lock. The domain depends on the port's current TC mode, which may
get changed under us if we're not holding the lock.

This was left out from
commit 8c10e2262663 ("drm/i915: Keep the TypeC port mode fixed for detect/AUX transfers")

	Cc: <stable@vger.kernel.org> # v5.4+
	Signed-off-by: Imre Deak <imre.deak@intel.com>
	Reviewed-by: Jos√© Roberto de Souza <jose.souza@intel.com>
Link: https://patchwork.freedesktop.org/patch/msgid/20200514204553.27193-1-imre.deak@intel.com
(cherry picked from commit ae9b6cfe1352da25931bce3ea4acfd4dc1ac8a85)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/gpu/drm/i915/display/intel_dp.c
diff --cc drivers/gpu/drm/i915/display/intel_dp.c
index 9ec0808f141e,40d42dcff0b7..000000000000
--- a/drivers/gpu/drm/i915/display/intel_dp.c
+++ b/drivers/gpu/drm/i915/display/intel_dp.c
@@@ -1316,10 -1355,11 +1316,9 @@@ intel_dp_aux_xfer(struct intel_dp *inte
  	struct drm_i915_private *i915 =
  			to_i915(intel_dig_port->base.base.dev);
  	struct intel_uncore *uncore = &i915->uncore;
 -	enum phy phy = intel_port_to_phy(i915, intel_dig_port->base.port);
 -	bool is_tc_port = intel_phy_is_tc(i915, phy);
  	i915_reg_t ch_ctl, ch_data[5];
  	u32 aux_clock_divider;
- 	enum intel_display_power_domain aux_domain =
- 		intel_aux_power_domain(intel_dig_port);
+ 	enum intel_display_power_domain aux_domain;
  	intel_wakeref_t aux_wakeref;
  	intel_wakeref_t pps_wakeref;
  	int i, ret, recv_bytes;
@@@ -1331,6 -1371,11 +1330,14 @@@
  	for (i = 0; i < ARRAY_SIZE(ch_data); i++)
  		ch_data[i] = intel_dp->aux_ch_data_reg(intel_dp, i);
  
++<<<<<<< HEAD
++=======
+ 	if (is_tc_port)
+ 		intel_tc_port_lock(intel_dig_port);
+ 
+ 	aux_domain = intel_aux_power_domain(intel_dig_port);
+ 
++>>>>>>> ae9b6cfe1352 (drm/i915: Fix AUX power domain toggling across TypeC mode resets)
  	aux_wakeref = intel_display_power_get(i915, aux_domain);
  	pps_wakeref = pps_lock(intel_dp);
  
* Unmerged path drivers/gpu/drm/i915/display/intel_dp.c
