selftests/net: skip psock_tpacket test if KALLSYMS was not enabled

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Po-Hsu Lin <po-hsu.lin@canonical.com>
commit ff95bf28c23490584b9d75913a520bb7bb1f2ecb
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/ff95bf28.failed

The psock_tpacket test will need to access /proc/kallsyms, this would
require the kernel config CONFIG_KALLSYMS to be enabled first.

Apart from adding CONFIG_KALLSYMS to the net/config file here, check the
file existence to determine if we can run this test will be helpful to
avoid a false-positive test result when testing it directly with the
following commad against a kernel that have CONFIG_KALLSYMS disabled:
    make -C tools/testing/selftests TARGETS=net run_tests

	Signed-off-by: Po-Hsu Lin <po-hsu.lin@canonical.com>
	Acked-by: Shuah Khan <skhan@linuxfoundation.org>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit ff95bf28c23490584b9d75913a520bb7bb1f2ecb)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/testing/selftests/net/config
#	tools/testing/selftests/net/run_afpackettests
diff --cc tools/testing/selftests/net/config
index cd3a2f1545b5,3dea2cba2325..000000000000
--- a/tools/testing/selftests/net/config
+++ b/tools/testing/selftests/net/config
@@@ -14,3 -12,17 +14,20 @@@ CONFIG_IPV6_VTI=
  CONFIG_DUMMY=y
  CONFIG_BRIDGE=y
  CONFIG_VLAN_8021Q=y
++<<<<<<< HEAD
++=======
+ CONFIG_NETFILTER=y
+ CONFIG_NETFILTER_ADVANCED=y
+ CONFIG_NF_CONNTRACK=m
+ CONFIG_NF_NAT=m
+ CONFIG_IP6_NF_IPTABLES=m
+ CONFIG_IP_NF_IPTABLES=m
+ CONFIG_IP6_NF_NAT=m
+ CONFIG_IP_NF_NAT=m
+ CONFIG_NF_TABLES=m
+ CONFIG_NF_TABLES_IPV6=y
+ CONFIG_NF_TABLES_IPV4=y
+ CONFIG_NFT_CHAIN_NAT_IPV6=m
+ CONFIG_NFT_CHAIN_NAT_IPV4=m
+ CONFIG_KALLSYMS=y
++>>>>>>> ff95bf28c234 (selftests/net: skip psock_tpacket test if KALLSYMS was not enabled)
diff --cc tools/testing/selftests/net/run_afpackettests
index bea079edc278,8b42e8b04e0f..000000000000
--- a/tools/testing/selftests/net/run_afpackettests
+++ b/tools/testing/selftests/net/run_afpackettests
@@@ -19,9 -21,26 +19,20 @@@ f
  echo "--------------------"
  echo "running psock_tpacket test"
  echo "--------------------"
++<<<<<<< HEAD
 +./in_netns.sh ./psock_tpacket
 +if [ $? -ne 0 ]; then
 +	echo "[FAIL]"
++=======
+ if [ -f /proc/kallsyms ]; then
+ 	./in_netns.sh ./psock_tpacket
+ 	if [ $? -ne 0 ]; then
+ 		echo "[FAIL]"
+ 		ret=1
+ 	else
+ 		echo "[PASS]"
+ 	fi
++>>>>>>> ff95bf28c234 (selftests/net: skip psock_tpacket test if KALLSYMS was not enabled)
  else
- 	echo "[PASS]"
+ 	echo "[SKIP] CONFIG_KALLSYMS not enabled"
  fi
 -
 -echo "--------------------"
 -echo "running txring_overwrite test"
 -echo "--------------------"
 -./in_netns.sh ./txring_overwrite
 -if [ $? -ne 0 ]; then
 -	echo "[FAIL]"
 -	ret=1
 -else
 -	echo "[PASS]"
 -fi
 -exit $ret
* Unmerged path tools/testing/selftests/net/config
* Unmerged path tools/testing/selftests/net/run_afpackettests
