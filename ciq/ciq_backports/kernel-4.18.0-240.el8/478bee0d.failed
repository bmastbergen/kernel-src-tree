selftests/bpf: Preserve errno in test_progs CHECK macros

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Andrey Ignatov <rdna@fb.com>
commit 478bee0df0ec9067c12e7d058d78721a7e7a1b29
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/478bee0d.failed

It's follow-up for discussion [1]

CHECK and CHECK_FAIL macros in test_progs.h can affect errno in some
circumstances, e.g. if some code accidentally closes stdout. It makes
checking errno in patterns like this unreliable:

	if (CHECK(!bpf_prog_attach_xattr(...), "tag", "msg"))
		goto err;
	CHECK_FAIL(errno != ENOENT);

, since by CHECK_FAIL time errno could be affected not only by
bpf_prog_attach_xattr but by CHECK as well.

Fix it by saving and restoring errno in the macros. There is no "Fixes"
tag since no problems were discovered yet and it's rather precaution.

test_progs was run with this change and no difference was identified.

[1] https://lore.kernel.org/bpf/20191219210907.GD16266@rdna-mbp.dhcp.thefacebook.com/

	Signed-off-by: Andrey Ignatov <rdna@fb.com>
	Signed-off-by: Alexei Starovoitov <ast@kernel.org>
	Acked-by: Andrii Nakryiko <andriin@fb.com>
Link: https://lore.kernel.org/bpf/20191220000511.1684853-1-rdna@fb.com
(cherry picked from commit 478bee0df0ec9067c12e7d058d78721a7e7a1b29)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/testing/selftests/bpf/test_progs.h
diff --cc tools/testing/selftests/bpf/test_progs.h
index 9defd35cb6c0,de1fdaa4e7b4..000000000000
--- a/tools/testing/selftests/bpf/test_progs.h
+++ b/tools/testing/selftests/bpf/test_progs.h
@@@ -95,8 -100,9 +95,9 @@@ extern struct ipv6_packet pkt_v6
  
  #define _CHECK(condition, tag, duration, format...) ({			\
  	int __ret = !!(condition);					\
+ 	int __save_errno = errno;					\
  	if (__ret) {							\
 -		test__fail();						\
 +		error_cnt++;						\
  		printf("%s:FAIL:%s ", __func__, tag);			\
  		printf(format);						\
  	} else {							\
@@@ -107,6 -113,17 +109,20 @@@
  	__ret;								\
  })
  
++<<<<<<< HEAD
++=======
+ #define CHECK_FAIL(condition) ({					\
+ 	int __ret = !!(condition);					\
+ 	int __save_errno = errno;					\
+ 	if (__ret) {							\
+ 		test__fail();						\
+ 		printf("%s:FAIL:%d\n", __func__, __LINE__);		\
+ 	}								\
+ 	errno = __save_errno;						\
+ 	__ret;								\
+ })
+ 
++>>>>>>> 478bee0df0ec (selftests/bpf: Preserve errno in test_progs CHECK macros)
  #define CHECK(condition, tag, format...) \
  	_CHECK(condition, tag, duration, format)
  #define CHECK_ATTR(condition, tag, format...) \
* Unmerged path tools/testing/selftests/bpf/test_progs.h
