perf tools: Remove util.h from where it is not needed

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Arnaldo Carvalho de Melo <acme@redhat.com>
commit fb71c86cc804b8f490fce1b9140014043ec41858
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/fb71c86c.failed

Check that it is not needed and remove, fixing up some fallout for
places where it was only serving to get something else.

	Cc: Adrian Hunter <adrian.hunter@intel.com>
	Cc: Jiri Olsa <jolsa@kernel.org>
	Cc: Namhyung Kim <namhyung@kernel.org>
Link: https://lkml.kernel.org/n/tip-9h6dg6lsqe2usyqjh5rrues4@git.kernel.org
	Signed-off-by: Arnaldo Carvalho de Melo <acme@redhat.com>
(cherry picked from commit fb71c86cc804b8f490fce1b9140014043ec41858)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/perf/arch/arm/util/cs-etm.c
#	tools/perf/arch/x86/tests/rdpmc.c
#	tools/perf/arch/x86/util/intel-bts.c
#	tools/perf/arch/x86/util/intel-pt.c
#	tools/perf/builtin-report.c
#	tools/perf/perf.c
#	tools/perf/tests/clang.c
#	tools/perf/tests/dso-data.c
#	tools/perf/tests/parse-events.c
#	tools/perf/ui/browsers/res_sample.c
#	tools/perf/ui/browsers/scripts.c
#	tools/perf/ui/setup.c
#	tools/perf/ui/tui/setup.c
#	tools/perf/util/auxtrace.c
#	tools/perf/util/branch.c
#	tools/perf/util/cloexec.c
#	tools/perf/util/evlist.c
#	tools/perf/util/evsel.c
#	tools/perf/util/header.c
#	tools/perf/util/jitdump.c
#	tools/perf/util/record.c
#	tools/perf/util/s390-sample-raw.c
#	tools/perf/util/session.c
#	tools/perf/util/target.c
#	tools/perf/util/vdso.c
#	tools/perf/util/zlib.c
diff --cc tools/perf/arch/arm/util/cs-etm.c
index 4208974c24f8,5d120b1e35ed..000000000000
--- a/tools/perf/arch/arm/util/cs-etm.c
+++ b/tools/perf/arch/arm/util/cs-etm.c
@@@ -21,9 -23,10 +21,14 @@@
  #include "../../util/evlist.h"
  #include "../../util/evsel.h"
  #include "../../util/pmu.h"
 +#include "../../util/thread_map.h"
  #include "../../util/cs-etm.h"
++<<<<<<< HEAD
 +#include "../../util/util.h"
++=======
+ #include "../../util/util.h" // page_size
+ #include "../../util/session.h"
++>>>>>>> fb71c86cc804 (perf tools: Remove util.h from where it is not needed)
  
  #include <errno.h>
  #include <stdlib.h>
diff --cc tools/perf/arch/x86/tests/rdpmc.c
index 7a11f02d6c6c,e7640fb047de..000000000000
--- a/tools/perf/arch/x86/tests/rdpmc.c
+++ b/tools/perf/arch/x86/tests/rdpmc.c
@@@ -11,7 -12,8 +11,12 @@@
  #include "debug.h"
  #include "tests/tests.h"
  #include "cloexec.h"
++<<<<<<< HEAD
 +#include "util.h"
++=======
+ #include "event.h"
+ #include "util.h" // page_size
++>>>>>>> fb71c86cc804 (perf tools: Remove util.h from where it is not needed)
  #include "arch-tests.h"
  
  static u64 rdpmc(unsigned int counter)
diff --cc tools/perf/arch/x86/util/intel-bts.c
index 4cbd3d775c19,090d90e093df..000000000000
--- a/tools/perf/arch/x86/util/intel-bts.c
+++ b/tools/perf/arch/x86/util/intel-bts.c
@@@ -29,6 -21,8 +29,10 @@@
  #include "../../util/tsc.h"
  #include "../../util/auxtrace.h"
  #include "../../util/intel-bts.h"
++<<<<<<< HEAD
++=======
+ #include "../../util/util.h" // page_size
++>>>>>>> fb71c86cc804 (perf tools: Remove util.h from where it is not needed)
  
  #define KiB(x) ((x) * 1024)
  #define MiB(x) ((x) * 1024 * 1024)
diff --cc tools/perf/arch/x86/util/intel-pt.c
index 3a851647e6f4,3d041b89f018..000000000000
--- a/tools/perf/arch/x86/util/intel-pt.c
+++ b/tools/perf/arch/x86/util/intel-pt.c
@@@ -33,7 -23,10 +33,11 @@@
  #include "../../util/pmu.h"
  #include "../../util/debug.h"
  #include "../../util/auxtrace.h"
 -#include "../../util/record.h"
 -#include "../../util/target.h"
  #include "../../util/tsc.h"
++<<<<<<< HEAD
++=======
+ #include "../../util/util.h" // page_size
++>>>>>>> fb71c86cc804 (perf tools: Remove util.h from where it is not needed)
  #include "../../util/intel-pt.h"
  
  #define KiB(x) ((x) * 1024)
diff --cc tools/perf/builtin-report.c
index 56db4ac46d26,3047e5169d9d..000000000000
--- a/tools/perf/builtin-report.c
+++ b/tools/perf/builtin-report.c
@@@ -44,6 -48,9 +44,12 @@@
  #include "util/auxtrace.h"
  #include "util/units.h"
  #include "util/branch.h"
++<<<<<<< HEAD
++=======
+ #include "util/util.h" // perf_tip()
+ #include "ui/ui.h"
+ #include "ui/progress.h"
++>>>>>>> fb71c86cc804 (perf tools: Remove util.h from where it is not needed)
  
  #include <dlfcn.h>
  #include <errno.h>
diff --cc tools/perf/perf.c
index 34763a9b873d,bb40a108b8f7..000000000000
--- a/tools/perf/perf.c
+++ b/tools/perf/perf.c
@@@ -18,7 -20,9 +18,13 @@@
  #include "util/bpf-loader.h"
  #include "util/debug.h"
  #include "util/event.h"
++<<<<<<< HEAD
 +#include "util/util.h"
++=======
+ #include "util/util.h" // page_size, usage()
+ #include "ui/ui.h"
+ #include "perf-sys.h"
++>>>>>>> fb71c86cc804 (perf tools: Remove util.h from where it is not needed)
  #include <api/fs/fs.h>
  #include <api/fs/tracing_path.h>
  #include <errno.h>
diff --cc tools/perf/tests/clang.c
index f45fe11dcf50,2577d3ed1531..000000000000
--- a/tools/perf/tests/clang.c
+++ b/tools/perf/tests/clang.c
@@@ -1,7 -1,5 +1,10 @@@
  // SPDX-License-Identifier: GPL-2.0
  #include "tests.h"
++<<<<<<< HEAD
 +#include "debug.h"
 +#include "util.h"
++=======
++>>>>>>> fb71c86cc804 (perf tools: Remove util.h from where it is not needed)
  #include "c++/clang-c.h"
  #include <linux/kernel.h>
  
diff --cc tools/perf/tests/dso-data.c
index 946ab4b63acd,627c1aaf1c9e..000000000000
--- a/tools/perf/tests/dso-data.c
+++ b/tools/perf/tests/dso-data.c
@@@ -9,7 -9,7 +9,11 @@@
  #include <sys/time.h>
  #include <sys/resource.h>
  #include <api/fs/fs.h>
++<<<<<<< HEAD
 +#include "util.h"
++=======
+ #include "dso.h"
++>>>>>>> fb71c86cc804 (perf tools: Remove util.h from where it is not needed)
  #include "machine.h"
  #include "symbol.h"
  #include "tests.h"
diff --cc tools/perf/tests/parse-events.c
index 8f3c80e13584,c25c8e7b41e5..000000000000
--- a/tools/perf/tests/parse-events.c
+++ b/tools/perf/tests/parse-events.c
@@@ -5,7 -5,7 +5,11 @@@
  #include <api/fs/fs.h>
  #include "tests.h"
  #include "debug.h"
++<<<<<<< HEAD
 +#include "util.h"
++=======
+ #include "pmu.h"
++>>>>>>> fb71c86cc804 (perf tools: Remove util.h from where it is not needed)
  #include <dirent.h>
  #include <errno.h>
  #include <sys/types.h>
diff --cc tools/perf/ui/browsers/res_sample.c
index 50288209a3b8,76d356a18790..000000000000
--- a/tools/perf/ui/browsers/res_sample.c
+++ b/tools/perf/ui/browsers/res_sample.c
@@@ -7,7 -7,10 +7,14 @@@
  #include "config.h"
  #include "time-utils.h"
  #include "../util.h"
++<<<<<<< HEAD
 +#include "../../util/util.h"
++=======
+ #include "../../util/util.h" // perf_exe()
+ #include "../../perf.h"
+ #include <stdlib.h>
+ #include <string.h>
++>>>>>>> fb71c86cc804 (perf tools: Remove util.h from where it is not needed)
  #include <linux/time64.h>
  #include <linux/zalloc.h>
  
diff --cc tools/perf/ui/browsers/scripts.c
index b2271b3e1877,fc733a6354d4..000000000000
--- a/tools/perf/ui/browsers/scripts.c
+++ b/tools/perf/ui/browsers/scripts.c
@@@ -1,7 -1,8 +1,13 @@@
  // SPDX-License-Identifier: GPL-2.0
  #include "../../builtin.h"
++<<<<<<< HEAD
 +#include "../../util/sort.h"
 +#include "../../util/util.h"
++=======
+ #include "../../perf.h"
+ #include "../../util/util.h" // perf_exe()
+ #include "../util.h"
++>>>>>>> fb71c86cc804 (perf tools: Remove util.h from where it is not needed)
  #include "../../util/hist.h"
  #include "../../util/debug.h"
  #include "../../util/symbol.h"
diff --cc tools/perf/ui/setup.c
index 3bc7c9a6fae9,700335cde618..000000000000
--- a/tools/perf/ui/setup.c
+++ b/tools/perf/ui/setup.c
@@@ -1,11 -1,12 +1,16 @@@
  // SPDX-License-Identifier: GPL-2.0
  #include <pthread.h>
  #include <dlfcn.h>
+ #include <unistd.h>
  
 -#include <subcmd/pager.h>
 +#include "../util/cache.h"
  #include "../util/debug.h"
  #include "../util/hist.h"
++<<<<<<< HEAD
 +#include "../util/util.h"
++=======
+ #include "ui.h"
++>>>>>>> fb71c86cc804 (perf tools: Remove util.h from where it is not needed)
  
  pthread_mutex_t ui__lock = PTHREAD_MUTEX_INITIALIZER;
  void *perf_gtk_handle;
diff --cc tools/perf/ui/tui/setup.c
index 3ad0d3363ac6,e9bfe856a5de..000000000000
--- a/tools/perf/ui/tui/setup.c
+++ b/tools/perf/ui/tui/setup.c
@@@ -8,9 -8,8 +9,13 @@@
  #include <execinfo.h>
  #endif
  
 +#include "../../util/cache.h"
  #include "../../util/debug.h"
++<<<<<<< HEAD
 +#include "../../util/util.h"
++=======
+ #include "../../perf.h"
++>>>>>>> fb71c86cc804 (perf tools: Remove util.h from where it is not needed)
  #include "../browser.h"
  #include "../helpline.h"
  #include "../ui.h"
diff --cc tools/perf/util/auxtrace.c
index 2e60b09cfd97,7ec0a6caa6cd..000000000000
--- a/tools/perf/util/auxtrace.c
+++ b/tools/perf/util/auxtrace.c
@@@ -59,9 -50,12 +59,15 @@@
  #include "intel-bts.h"
  #include "arm-spe.h"
  #include "s390-cpumsf.h"
++<<<<<<< HEAD
++=======
+ #include "util.h" // page_size
++>>>>>>> fb71c86cc804 (perf tools: Remove util.h from where it is not needed)
  
  #include <linux/ctype.h>
+ #include <linux/kernel.h>
  #include "symbol/kallsyms.h"
+ #include <internal/lib.h>
  
  static bool auxtrace__dont_decode(struct perf_session *session)
  {
diff --cc tools/perf/util/branch.c
index 02d6d839ff24,2285b1eb3128..000000000000
--- a/tools/perf/util/branch.c
+++ b/tools/perf/util/branch.c
@@@ -1,6 -1,6 +1,10 @@@
++<<<<<<< HEAD
 +#include "util/util.h"
 +#include "util/debug.h"
++=======
+ #include "util/map_symbol.h"
++>>>>>>> fb71c86cc804 (perf tools: Remove util.h from where it is not needed)
  #include "util/branch.h"
 -#include <linux/kernel.h>
  
  static bool cross_area(u64 addr1, u64 addr2, int size)
  {
diff --cc tools/perf/util/cloexec.c
index 06f48312c5ed,a12872f2856a..000000000000
--- a/tools/perf/util/cloexec.c
+++ b/tools/perf/util/cloexec.c
@@@ -1,9 -1,10 +1,14 @@@
  // SPDX-License-Identifier: GPL-2.0
  #include <errno.h>
  #include <sched.h>
++<<<<<<< HEAD
 +#include "util.h"
 +#include "../perf.h"
++=======
+ #include "util.h" // for sched_getcpu()
+ #include "../perf-sys.h"
++>>>>>>> fb71c86cc804 (perf tools: Remove util.h from where it is not needed)
  #include "cloexec.h"
 -#include "event.h"
  #include "asm/bug.h"
  #include "debug.h"
  #include <unistd.h>
diff --cc tools/perf/util/evlist.c
index 29a998d183ce,ea9517d506d8..000000000000
--- a/tools/perf/util/evlist.c
+++ b/tools/perf/util/evlist.c
@@@ -17,6 -16,8 +17,11 @@@
  #include "evsel.h"
  #include "debug.h"
  #include "units.h"
++<<<<<<< HEAD
++=======
+ #include "util.h" // page_size
+ #include "../perf.h"
++>>>>>>> fb71c86cc804 (perf tools: Remove util.h from where it is not needed)
  #include "asm/bug.h"
  #include "bpf-event.h"
  #include <signal.h>
diff --cc tools/perf/util/evsel.c
index 90bfc2303a40,c194ec787f96..000000000000
--- a/tools/perf/util/evsel.c
+++ b/tools/perf/util/evsel.c
@@@ -38,7 -41,11 +38,12 @@@
  #include "stat.h"
  #include "string2.h"
  #include "memswap.h"
 -#include "util.h"
 -#include "../perf-sys.h"
  #include "util/parse-branch-options.h"
++<<<<<<< HEAD
++=======
+ #include <internal/xyarray.h>
+ #include <internal/lib.h>
++>>>>>>> fb71c86cc804 (perf tools: Remove util.h from where it is not needed)
  
  #include <linux/ctype.h>
  
diff --cc tools/perf/util/header.c
index 13489971ed57,d85827de1b60..000000000000
--- a/tools/perf/util/header.c
+++ b/tools/perf/util/header.c
@@@ -40,6 -42,7 +40,10 @@@
  #include "tool.h"
  #include "time-utils.h"
  #include "units.h"
++<<<<<<< HEAD
++=======
+ #include "util.h" // page_size, perf_exe()
++>>>>>>> fb71c86cc804 (perf tools: Remove util.h from where it is not needed)
  #include "cputopo.h"
  #include "bpf-event.h"
  
diff --cc tools/perf/util/jitdump.c
index 0cfa6b39a08f,9f9c6c6a2fd3..000000000000
--- a/tools/perf/util/jitdump.c
+++ b/tools/perf/util/jitdump.c
@@@ -14,7 -14,7 +14,11 @@@
  #include <sys/mman.h>
  #include <linux/stringify.h>
  
++<<<<<<< HEAD
 +#include "util.h"
++=======
+ #include "build-id.h"
++>>>>>>> fb71c86cc804 (perf tools: Remove util.h from where it is not needed)
  #include "event.h"
  #include "debug.h"
  #include "evlist.h"
diff --cc tools/perf/util/record.c
index 9cfc7bf16531,860c48895ab6..000000000000
--- a/tools/perf/util/record.c
+++ b/tools/perf/util/record.c
@@@ -4,12 -5,16 +4,16 @@@
  #include "cpumap.h"
  #include "parse-events.h"
  #include <errno.h>
 -#include <limits.h>
 -#include <stdlib.h>
  #include <api/fs/fs.h>
  #include <subcmd/parse-options.h>
++<<<<<<< HEAD
 +#include "util.h"
++=======
+ #include <perf/cpumap.h>
++>>>>>>> fb71c86cc804 (perf tools: Remove util.h from where it is not needed)
  #include "cloexec.h"
 -#include "record.h"
 -#include "../perf-sys.h"
  
 -typedef void (*setup_probe_fn_t)(struct evsel *evsel);
 +typedef void (*setup_probe_fn_t)(struct perf_evsel *evsel);
  
  static int perf_do_probe_api(setup_probe_fn_t fn, int cpu, const char *str)
  {
diff --cc tools/perf/util/s390-sample-raw.c
index 6650f599ed9c,05b43ab4eeef..000000000000
--- a/tools/perf/util/s390-sample-raw.c
+++ b/tools/perf/util/s390-sample-raw.c
@@@ -22,11 -22,8 +22,14 @@@
  #include <asm/byteorder.h>
  
  #include "debug.h"
++<<<<<<< HEAD
 +#include "util.h"
 +#include "auxtrace.h"
++=======
++>>>>>>> fb71c86cc804 (perf tools: Remove util.h from where it is not needed)
  #include "session.h"
  #include "evlist.h"
 +#include "config.h"
  #include "color.h"
  #include "sample-raw.h"
  #include "s390-cpumcf-kernel.h"
diff --cc tools/perf/util/session.c
index 82adeb8dfbcf,2b133bc22caa..000000000000
--- a/tools/perf/util/session.c
+++ b/tools/perf/util/session.c
@@@ -27,8 -30,11 +27,12 @@@
  #include "thread-stack.h"
  #include "sample-raw.h"
  #include "stat.h"
 -#include "util.h"
 -#include "ui/progress.h"
 -#include "../perf.h"
  #include "arch/common.h"
++<<<<<<< HEAD
 +#include <linux/err.h>
++=======
+ #include <internal/lib.h>
++>>>>>>> fb71c86cc804 (perf tools: Remove util.h from where it is not needed)
  
  #ifdef HAVE_ZSTD_SUPPORT
  static int perf_session__process_compressed_event(struct perf_session *session,
diff --cc tools/perf/util/target.c
index 6713da4e23d5,a3db13dea937..000000000000
--- a/tools/perf/util/target.c
+++ b/tools/perf/util/target.c
@@@ -7,12 -6,13 +7,15 @@@
   */
  
  #include "target.h"
++<<<<<<< HEAD
 +#include "util.h"
 +#include "debug.h"
++=======
++>>>>>>> fb71c86cc804 (perf tools: Remove util.h from where it is not needed)
  
  #include <pwd.h>
 -#include <stdio.h>
  #include <stdlib.h>
  #include <string.h>
 -#include <linux/kernel.h>
 -#include <linux/string.h>
  
  enum target_errno target__validate(struct target *target)
  {
diff --cc tools/perf/util/vdso.c
index 7f427bab6c12,ba4b4395f35d..000000000000
--- a/tools/perf/util/vdso.c
+++ b/tools/perf/util/vdso.c
@@@ -10,7 -10,8 +10,12 @@@
  #include <linux/kernel.h>
  
  #include "vdso.h"
++<<<<<<< HEAD
 +#include "util.h"
++=======
+ #include "dso.h"
+ #include <internal/lib.h>
++>>>>>>> fb71c86cc804 (perf tools: Remove util.h from where it is not needed)
  #include "map.h"
  #include "symbol.h"
  #include "machine.h"
diff --cc tools/perf/util/zlib.c
index 512ad7c09b13,78d2297c1b67..000000000000
--- a/tools/perf/util/zlib.c
+++ b/tools/perf/util/zlib.c
@@@ -6,11 -7,9 +6,15 @@@
  #include <sys/mman.h>
  #include <zlib.h>
  #include <linux/compiler.h>
+ #include <internal/lib.h>
  
  #include "util/compress.h"
++<<<<<<< HEAD
 +#include "util/util.h"
 +#include "util/debug.h"
 +
++=======
++>>>>>>> fb71c86cc804 (perf tools: Remove util.h from where it is not needed)
  
  #define CHUNK_SIZE  16384
  
* Unmerged path tools/perf/arch/arm/util/cs-etm.c
diff --git a/tools/perf/arch/arm64/util/arm-spe.c b/tools/perf/arch/arm64/util/arm-spe.c
index 2c009aa74633..50805a67917f 100644
--- a/tools/perf/arch/arm64/util/arm-spe.c
+++ b/tools/perf/arch/arm64/util/arm-spe.c
@@ -15,7 +15,7 @@
 #include "../../util/evsel.h"
 #include "../../util/evlist.h"
 #include "../../util/session.h"
-#include "../../util/util.h"
+#include "../../util/util.h" // page_size
 #include "../../util/pmu.h"
 #include "../../util/debug.h"
 #include "../../util/auxtrace.h"
diff --git a/tools/perf/arch/arm64/util/dwarf-regs.c b/tools/perf/arch/arm64/util/dwarf-regs.c
index cd764a9fd098..8393f1b6006f 100644
--- a/tools/perf/arch/arm64/util/dwarf-regs.c
+++ b/tools/perf/arch/arm64/util/dwarf-regs.c
@@ -14,7 +14,6 @@
 #include <dwarf-regs.h>
 #include <linux/ptrace.h> /* for struct user_pt_regs */
 #include <linux/stringify.h>
-#include "util.h"
 
 struct pt_regs_dwarfnum {
 	const char *name;
diff --git a/tools/perf/arch/powerpc/util/dwarf-regs.c b/tools/perf/arch/powerpc/util/dwarf-regs.c
index 98ac87052a74..cec9353a6d3a 100644
--- a/tools/perf/arch/powerpc/util/dwarf-regs.c
+++ b/tools/perf/arch/powerpc/util/dwarf-regs.c
@@ -16,7 +16,6 @@
 #include <linux/ptrace.h>
 #include <linux/kernel.h>
 #include <linux/stringify.h>
-#include "util.h"
 
 struct pt_regs_dwarfnum {
 	const char *name;
diff --git a/tools/perf/arch/powerpc/util/header.c b/tools/perf/arch/powerpc/util/header.c
index 0b242664f5ea..b6b7bc7e31a1 100644
--- a/tools/perf/arch/powerpc/util/header.c
+++ b/tools/perf/arch/powerpc/util/header.c
@@ -6,7 +6,6 @@
 #include <string.h>
 #include <linux/stringify.h>
 #include "header.h"
-#include "util.h"
 
 #define mfspr(rn)       ({unsigned long rval; \
 			 asm volatile("mfspr %0," __stringify(rn) \
diff --git a/tools/perf/arch/s390/util/machine.c b/tools/perf/arch/s390/util/machine.c
index c8c86a0c9b79..df099d6cc3f5 100644
--- a/tools/perf/arch/s390/util/machine.c
+++ b/tools/perf/arch/s390/util/machine.c
@@ -2,7 +2,7 @@
 #include <unistd.h>
 #include <stdio.h>
 #include <string.h>
-#include "util.h"
+#include "util.h" // page_size
 #include "machine.h"
 #include "api/fs/fs.h"
 #include "debug.h"
diff --git a/tools/perf/arch/x86/tests/intel-cqm.c b/tools/perf/arch/x86/tests/intel-cqm.c
index 77e59b7364cf..5a5df5a373a5 100644
--- a/tools/perf/arch/x86/tests/intel-cqm.c
+++ b/tools/perf/arch/x86/tests/intel-cqm.c
@@ -5,7 +5,6 @@
 #include "evlist.h"
 #include "evsel.h"
 #include "arch-tests.h"
-#include "util.h"
 
 #include <signal.h>
 #include <sys/mman.h>
* Unmerged path tools/perf/arch/x86/tests/rdpmc.c
* Unmerged path tools/perf/arch/x86/util/intel-bts.c
* Unmerged path tools/perf/arch/x86/util/intel-pt.c
diff --git a/tools/perf/arch/x86/util/machine.c b/tools/perf/arch/x86/util/machine.c
index 1e9ec783b9a1..42418040bc07 100644
--- a/tools/perf/arch/x86/util/machine.c
+++ b/tools/perf/arch/x86/util/machine.c
@@ -3,7 +3,7 @@
 #include <linux/string.h>
 #include <stdlib.h>
 
-#include "../../util/util.h"
+#include "../../util/util.h" // page_size
 #include "../../util/machine.h"
 #include "../../util/map.h"
 #include "../../util/symbol.h"
diff --git a/tools/perf/bench/sched-messaging.c b/tools/perf/bench/sched-messaging.c
index 6e499b32bf00..97e4a4fb3362 100644
--- a/tools/perf/bench/sched-messaging.c
+++ b/tools/perf/bench/sched-messaging.c
@@ -10,7 +10,6 @@
  *
  */
 
-#include "../util/util.h"
 #include <subcmd/parse-options.h>
 #include "bench.h"
 
diff --git a/tools/perf/bench/sched-pipe.c b/tools/perf/bench/sched-pipe.c
index edd40aafa318..3c88d1f201f1 100644
--- a/tools/perf/bench/sched-pipe.c
+++ b/tools/perf/bench/sched-pipe.c
@@ -9,7 +9,6 @@
  *  http://people.redhat.com/mingo/cfs-scheduler/tools/pipe-test-1m.c
  * Ported to perf by Hitoshi Mitake <mitake@dcl.info.waseda.ac.jp>
  */
-#include "../util/util.h"
 #include <subcmd/parse-options.h>
 #include "bench.h"
 
diff --git a/tools/perf/builtin-config.c b/tools/perf/builtin-config.c
index edfc8f76f1bd..6be60e28cfc6 100644
--- a/tools/perf/builtin-config.c
+++ b/tools/perf/builtin-config.c
@@ -9,7 +9,6 @@
 
 #include "util/cache.h"
 #include <subcmd/parse-options.h>
-#include "util/util.h"
 #include "util/debug.h"
 #include "util/config.h"
 #include <linux/string.h>
diff --git a/tools/perf/builtin-evlist.c b/tools/perf/builtin-evlist.c
index 36069acf5df2..1fda3bd3fd47 100644
--- a/tools/perf/builtin-evlist.c
+++ b/tools/perf/builtin-evlist.c
@@ -5,8 +5,6 @@
  */
 #include "builtin.h"
 
-#include "util/util.h"
-
 #include <linux/list.h>
 
 #include "perf.h"
* Unmerged path tools/perf/builtin-report.c
* Unmerged path tools/perf/perf.c
* Unmerged path tools/perf/tests/clang.c
* Unmerged path tools/perf/tests/dso-data.c
diff --git a/tools/perf/tests/event-times.c b/tools/perf/tests/event-times.c
index 1a2686f1fcf0..38a99ecc81b5 100644
--- a/tools/perf/tests/event-times.c
+++ b/tools/perf/tests/event-times.c
@@ -7,7 +7,6 @@
 #include "tests.h"
 #include "evlist.h"
 #include "evsel.h"
-#include "util.h"
 #include "debug.h"
 #include "thread_map.h"
 #include "target.h"
diff --git a/tools/perf/tests/llvm.c b/tools/perf/tests/llvm.c
index ca5a5f94ce79..6b8f870844e3 100644
--- a/tools/perf/tests/llvm.c
+++ b/tools/perf/tests/llvm.c
@@ -7,7 +7,6 @@
 #include "llvm.h"
 #include "tests.h"
 #include "debug.h"
-#include "util.h"
 
 #ifdef HAVE_LIBBPF_SUPPORT
 static int test__bpf_parsing(void *obj_buf, size_t obj_buf_sz)
diff --git a/tools/perf/tests/mmap-thread-lookup.c b/tools/perf/tests/mmap-thread-lookup.c
index 0a4301a5155c..5e1f7ae97ce3 100644
--- a/tools/perf/tests/mmap-thread-lookup.c
+++ b/tools/perf/tests/mmap-thread-lookup.c
@@ -14,7 +14,7 @@
 #include "map.h"
 #include "symbol.h"
 #include "thread.h"
-#include "util.h"
+#include "util.h" // page_size
 
 #define THREADS 4
 
* Unmerged path tools/perf/tests/parse-events.c
diff --git a/tools/perf/tests/parse-no-sample-id-all.c b/tools/perf/tests/parse-no-sample-id-all.c
index 2196d1497c0c..43e16fc2dcd6 100644
--- a/tools/perf/tests/parse-no-sample-id-all.c
+++ b/tools/perf/tests/parse-no-sample-id-all.c
@@ -1,4 +1,3 @@
-// SPDX-License-Identifier: GPL-2.0
 #include <linux/kernel.h>
 #include <linux/types.h>
 #include <stddef.h>
@@ -8,7 +7,6 @@
 #include "event.h"
 #include "evlist.h"
 #include "header.h"
-#include "util.h"
 #include "debug.h"
 
 static int process_event(struct perf_evlist **pevlist, union perf_event *event)
diff --git a/tools/perf/tests/perf-hooks.c b/tools/perf/tests/perf-hooks.c
index a693bcf017ea..dbc27199c65e 100644
--- a/tools/perf/tests/perf-hooks.c
+++ b/tools/perf/tests/perf-hooks.c
@@ -4,7 +4,6 @@
 
 #include "tests.h"
 #include "debug.h"
-#include "util.h"
 #include "perf-hooks.h"
 
 static void sigsegv_handler(int sig __maybe_unused)
diff --git a/tools/perf/tests/pmu.c b/tools/perf/tests/pmu.c
index 14a78898d79e..74379ff1f7fa 100644
--- a/tools/perf/tests/pmu.c
+++ b/tools/perf/tests/pmu.c
@@ -1,7 +1,6 @@
 // SPDX-License-Identifier: GPL-2.0
 #include "parse-events.h"
 #include "pmu.h"
-#include "util.h"
 #include "tests.h"
 #include <errno.h>
 #include <stdio.h>
diff --git a/tools/perf/tests/sample-parsing.c b/tools/perf/tests/sample-parsing.c
index 361714e2583c..3eb50e70e927 100644
--- a/tools/perf/tests/sample-parsing.c
+++ b/tools/perf/tests/sample-parsing.c
@@ -7,7 +7,6 @@
 #include <linux/types.h>
 
 #include "branch.h"
-#include "util.h"
 #include "event.h"
 #include "evsel.h"
 #include "debug.h"
diff --git a/tools/perf/tests/topology.c b/tools/perf/tests/topology.c
index c22c9d8190e8..1f06f8de340b 100644
--- a/tools/perf/tests/topology.c
+++ b/tools/perf/tests/topology.c
@@ -3,7 +3,6 @@
 #include <stdlib.h>
 #include <stdio.h>
 #include "tests.h"
-#include "util.h"
 #include "session.h"
 #include "evlist.h"
 #include "debug.h"
diff --git a/tools/perf/tests/vmlinux-kallsyms.c b/tools/perf/tests/vmlinux-kallsyms.c
index 5e8834fc7dec..e9325a08bf89 100644
--- a/tools/perf/tests/vmlinux-kallsyms.c
+++ b/tools/perf/tests/vmlinux-kallsyms.c
@@ -6,7 +6,7 @@
 #include <stdlib.h>
 #include "map.h"
 #include "symbol.h"
-#include "util.h"
+#include "util.h" // page_size
 #include "tests.h"
 #include "debug.h"
 #include "machine.h"
diff --git a/tools/perf/ui/browser.c b/tools/perf/ui/browser.c
index f93d40b1c203..781afe42e90e 100644
--- a/tools/perf/ui/browser.c
+++ b/tools/perf/ui/browser.c
@@ -1,5 +1,4 @@
 // SPDX-License-Identifier: GPL-2.0
-#include "../util/util.h"
 #include "../util/string2.h"
 #include "../util/config.h"
 #include "libslang.h"
diff --git a/tools/perf/ui/browsers/annotate.c b/tools/perf/ui/browsers/annotate.c
index e67880bf1efe..ba306327501f 100644
--- a/tools/perf/ui/browsers/annotate.c
+++ b/tools/perf/ui/browsers/annotate.c
@@ -2,7 +2,6 @@
 #include "../browser.h"
 #include "../helpline.h"
 #include "../ui.h"
-#include "../util.h"
 #include "../../util/annotate.h"
 #include "../../util/hist.h"
 #include "../../util/sort.h"
diff --git a/tools/perf/ui/browsers/map.c b/tools/perf/ui/browsers/map.c
index 893b065971f6..3d49b916c9e4 100644
--- a/tools/perf/ui/browsers/map.c
+++ b/tools/perf/ui/browsers/map.c
@@ -5,7 +5,6 @@
 #include <stdlib.h>
 #include <string.h>
 #include <linux/bitops.h>
-#include "../../util/util.h"
 #include "../../util/debug.h"
 #include "../../util/map.h"
 #include "../../util/dso.h"
* Unmerged path tools/perf/ui/browsers/res_sample.c
* Unmerged path tools/perf/ui/browsers/scripts.c
diff --git a/tools/perf/ui/gtk/progress.c b/tools/perf/ui/gtk/progress.c
index b6ad8857da78..eea6fcde518a 100644
--- a/tools/perf/ui/gtk/progress.c
+++ b/tools/perf/ui/gtk/progress.c
@@ -3,7 +3,6 @@
 
 #include "gtk.h"
 #include "../progress.h"
-#include "util.h"
 
 static GtkWidget *dialog;
 static GtkWidget *progress;
diff --git a/tools/perf/ui/helpline.c b/tools/perf/ui/helpline.c
index 54bcd08df87e..8cd643bcc791 100644
--- a/tools/perf/ui/helpline.c
+++ b/tools/perf/ui/helpline.c
@@ -6,7 +6,6 @@
 #include "../util/debug.h"
 #include "helpline.h"
 #include "ui.h"
-#include "../util/util.h"
 
 char ui_helpline__current[512];
 
diff --git a/tools/perf/ui/hist.c b/tools/perf/ui/hist.c
index 412d6f1626e3..3b00d786514e 100644
--- a/tools/perf/ui/hist.c
+++ b/tools/perf/ui/hist.c
@@ -5,7 +5,6 @@
 
 #include "../util/callchain.h"
 #include "../util/hist.h"
-#include "../util/util.h"
 #include "../util/sort.h"
 #include "../util/evsel.h"
 #include "../util/evlist.h"
* Unmerged path tools/perf/ui/setup.c
* Unmerged path tools/perf/ui/tui/setup.c
diff --git a/tools/perf/util/annotate.c b/tools/perf/util/annotate.c
index a2ea6e023df0..e84d2426e95f 100644
--- a/tools/perf/util/annotate.c
+++ b/tools/perf/util/annotate.c
@@ -14,7 +14,7 @@
 #include <bpf/btf.h>
 #include <bpf/libbpf.h>
 #include <linux/btf.h>
-#include "util.h"
+#include "util.h" // hex_width()
 #include "ui/ui.h"
 #include "sort.h"
 #include "build-id.h"
* Unmerged path tools/perf/util/auxtrace.c
* Unmerged path tools/perf/util/branch.c
diff --git a/tools/perf/util/branch.h b/tools/perf/util/branch.h
index 64f96b79f1d7..5e6d9b0dc1c1 100644
--- a/tools/perf/util/branch.h
+++ b/tools/perf/util/branch.h
@@ -1,8 +1,15 @@
 #ifndef _PERF_BRANCH_H
 #define _PERF_BRANCH_H 1
-
+/*
+ * The linux/stddef.h isn't need here, but is needed for __always_inline used
+ * in files included from uapi/linux/perf_event.h such as
+ * /usr/include/linux/swab.h and /usr/include/linux/byteorder/little_endian.h,
+ * detected in at least musl libc, used in Alpine Linux. -acme
+ */
 #include <stdio.h>
 #include <stdint.h>
+#include <linux/compiler.h>
+#include <linux/stddef.h>
 #include <linux/perf_event.h>
 #include <linux/types.h>
 
diff --git a/tools/perf/util/build-id.c b/tools/perf/util/build-id.c
index 5943d897533c..2b8c483993eb 100644
--- a/tools/perf/util/build-id.c
+++ b/tools/perf/util/build-id.c
@@ -7,7 +7,7 @@
  * Copyright (C) 2009, 2010 Red Hat Inc.
  * Copyright (C) 2009, 2010 Arnaldo Carvalho de Melo <acme@redhat.com>
  */
-#include "util.h"
+#include "util.h" // copyfile_ns(), lsdir(), mkdir_p(), rm_rf()
 #include <dirent.h>
 #include <errno.h>
 #include <stdio.h>
* Unmerged path tools/perf/util/cloexec.c
diff --git a/tools/perf/util/cs-etm-decoder/cs-etm-decoder.c b/tools/perf/util/cs-etm-decoder/cs-etm-decoder.c
index 37d7c492b155..cd92a99eb89d 100644
--- a/tools/perf/util/cs-etm-decoder/cs-etm-decoder.c
+++ b/tools/perf/util/cs-etm-decoder/cs-etm-decoder.c
@@ -17,7 +17,6 @@
 #include "cs-etm.h"
 #include "cs-etm-decoder.h"
 #include "intlist.h"
-#include "util.h"
 
 /* use raw logging */
 #ifdef CS_DEBUG_RAW
diff --git a/tools/perf/util/cs-etm.c b/tools/perf/util/cs-etm.c
index d7ad43911473..d102b68c51a2 100644
--- a/tools/perf/util/cs-etm.c
+++ b/tools/perf/util/cs-etm.c
@@ -31,7 +31,6 @@
 #include "thread_map.h"
 #include "thread-stack.h"
 #include <tools/libc_compat.h>
-#include "util.h"
 
 #define MAX_TIMESTAMP (~0ULL)
 
diff --git a/tools/perf/util/data.c b/tools/perf/util/data.c
index 1d1b97a92c3f..b52aa97fef5e 100644
--- a/tools/perf/util/data.c
+++ b/tools/perf/util/data.c
@@ -13,9 +13,10 @@
 #include <dirent.h>
 
 #include "data.h"
-#include "util.h"
+#include "util.h" // rm_rf_perf_data()
 #include "debug.h"
 #include "header.h"
+#include <internal/lib.h>
 
 static void close_dir(struct perf_data_file *files, int nr)
 {
diff --git a/tools/perf/util/debug.c b/tools/perf/util/debug.c
index c822c5943340..fd68c3fb7763 100644
--- a/tools/perf/util/debug.c
+++ b/tools/perf/util/debug.c
@@ -17,7 +17,6 @@
 #include "event.h"
 #include "debug.h"
 #include "print_binary.h"
-#include "util.h"
 #include "target.h"
 
 #include <linux/ctype.h>
diff --git a/tools/perf/util/demangle-rust.c b/tools/perf/util/demangle-rust.c
index 423afbbd386b..a659fc69f73a 100644
--- a/tools/perf/util/demangle-rust.c
+++ b/tools/perf/util/demangle-rust.c
@@ -1,6 +1,5 @@
 // SPDX-License-Identifier: GPL-2.0
 #include <string.h>
-#include "util.h"
 #include "debug.h"
 
 #include "demangle-rust.h"
diff --git a/tools/perf/util/dwarf-regs.c b/tools/perf/util/dwarf-regs.c
index db55eddce8cd..1b49ecee5aff 100644
--- a/tools/perf/util/dwarf-regs.c
+++ b/tools/perf/util/dwarf-regs.c
@@ -5,7 +5,6 @@
  * Written by: Masami Hiramatsu <mhiramat@kernel.org>
  */
 
-#include <util.h>
 #include <debug.h>
 #include <dwarf-regs.h>
 #include <elf.h>
* Unmerged path tools/perf/util/evlist.c
* Unmerged path tools/perf/util/evsel.c
* Unmerged path tools/perf/util/header.c
* Unmerged path tools/perf/util/jitdump.c
diff --git a/tools/perf/util/llvm-utils.c b/tools/perf/util/llvm-utils.c
index 9f0470ecbca9..db327c427ea2 100644
--- a/tools/perf/util/llvm-utils.c
+++ b/tools/perf/util/llvm-utils.c
@@ -8,6 +8,7 @@
 #include <limits.h>
 #include <stdio.h>
 #include <stdlib.h>
+#include <unistd.h>
 #include <linux/err.h>
 #include <linux/zalloc.h>
 #include "debug.h"
diff --git a/tools/perf/util/lzma.c b/tools/perf/util/lzma.c
index b1dd29a9d915..0956ab706552 100644
--- a/tools/perf/util/lzma.c
+++ b/tools/perf/util/lzma.c
@@ -7,9 +7,9 @@
 #include <sys/stat.h>
 #include <fcntl.h>
 #include "compress.h"
-#include "util.h"
 #include "debug.h"
 #include <unistd.h>
+#include <internal/lib.h>
 
 #define BUFSIZE 8192
 
diff --git a/tools/perf/util/perf-hooks.c b/tools/perf/util/perf-hooks.c
index 4f3aa8d99ef4..34766fb403b9 100644
--- a/tools/perf/util/perf-hooks.c
+++ b/tools/perf/util/perf-hooks.c
@@ -11,7 +11,6 @@
 #include <setjmp.h>
 #include <linux/err.h>
 #include <linux/kernel.h>
-#include "util/util.h"
 #include "util/debug.h"
 #include "util/perf-hooks.h"
 
* Unmerged path tools/perf/util/record.c
diff --git a/tools/perf/util/rwsem.c b/tools/perf/util/rwsem.c
index 5e52e7baa7b6..f3d29d8ddc99 100644
--- a/tools/perf/util/rwsem.c
+++ b/tools/perf/util/rwsem.c
@@ -1,3 +1,4 @@
+// SPDX-License-Identifier: GPL-2.0
 #include "util.h"
 #include "rwsem.h"
 
* Unmerged path tools/perf/util/s390-sample-raw.c
diff --git a/tools/perf/util/scripting-engines/trace-event-python.c b/tools/perf/util/scripting-engines/trace-event-python.c
index a8189337ec3a..bdb35ceccb6b 100644
--- a/tools/perf/util/scripting-engines/trace-event-python.c
+++ b/tools/perf/util/scripting-engines/trace-event-python.c
@@ -35,7 +35,6 @@
 #include "../debug.h"
 #include "../callchain.h"
 #include "../evsel.h"
-#include "../util.h"
 #include "../event.h"
 #include "../thread.h"
 #include "../comm.h"
* Unmerged path tools/perf/util/session.c
diff --git a/tools/perf/util/srccode.c b/tools/perf/util/srccode.c
index f733e609da28..5ba55410d2e1 100644
--- a/tools/perf/util/srccode.c
+++ b/tools/perf/util/srccode.c
@@ -23,7 +23,7 @@
 #include <string.h>
 #include "srccode.h"
 #include "debug.h"
-#include "util.h"
+#include "util.h" // page_size
 
 #define MAXSRCCACHE (32*1024*1024)
 #define MAXSRCFILES     64
diff --git a/tools/perf/util/symbol-elf.c b/tools/perf/util/symbol-elf.c
index 9428639872a6..8b9199c343dd 100644
--- a/tools/perf/util/symbol-elf.c
+++ b/tools/perf/util/symbol-elf.c
@@ -18,8 +18,10 @@
 #include "debug.h"
 #include "util.h"
 #include <linux/ctype.h>
+#include <linux/kernel.h>
 #include <linux/zalloc.h>
 #include <symbol/kallsyms.h>
+#include <internal/lib.h>
 
 #ifndef EM_AARCH64
 #define EM_AARCH64	183  /* ARM 64 bit */
diff --git a/tools/perf/util/symbol-minimal.c b/tools/perf/util/symbol-minimal.c
index 7e2813ec9498..d6e99af263ec 100644
--- a/tools/perf/util/symbol-minimal.c
+++ b/tools/perf/util/symbol-minimal.c
@@ -1,8 +1,6 @@
-// SPDX-License-Identifier: GPL-2.0
 #include "dso.h"
 #include "symbol.h"
 #include "symsrc.h"
-#include "util.h"
 
 #include <errno.h>
 #include <unistd.h>
@@ -13,6 +11,7 @@
 #include <byteswap.h>
 #include <sys/stat.h>
 #include <linux/zalloc.h>
+#include <internal/lib.h>
 
 static bool check_need_swap(int file_endian)
 {
diff --git a/tools/perf/util/symbol.c b/tools/perf/util/symbol.c
index a26c6d0457e1..a9e639aaf9c0 100644
--- a/tools/perf/util/symbol.c
+++ b/tools/perf/util/symbol.c
@@ -18,7 +18,7 @@
 #include "build-id.h"
 #include "cap.h"
 #include "dso.h"
-#include "util.h"
+#include "util.h" // lsdir()
 #include "debug.h"
 #include "event.h"
 #include "machine.h"
* Unmerged path tools/perf/util/target.c
diff --git a/tools/perf/util/trace-event-info.c b/tools/perf/util/trace-event-info.c
index 20bc1e972293..53962cdcbff0 100644
--- a/tools/perf/util/trace-event-info.c
+++ b/tools/perf/util/trace-event-info.c
@@ -18,7 +18,7 @@
  *
  * ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  */
-#include "util.h"
+#include "util.h" // page_size
 #include <dirent.h>
 #include <mntent.h>
 #include <stdio.h>
diff --git a/tools/perf/util/trace-event-read.c b/tools/perf/util/trace-event-read.c
index 7728940e5c3e..22b780b673f7 100644
--- a/tools/perf/util/trace-event-read.c
+++ b/tools/perf/util/trace-event-read.c
@@ -31,7 +31,6 @@
 #include <unistd.h>
 #include <errno.h>
 
-#include "util.h"
 #include "trace-event.h"
 #include "debug.h"
 
diff --git a/tools/perf/util/trace-event.c b/tools/perf/util/trace-event.c
index 01b9d89bf5bf..b3ee651e3d91 100644
--- a/tools/perf/util/trace-event.c
+++ b/tools/perf/util/trace-event.c
@@ -14,7 +14,6 @@
 #include <api/fs/fs.h>
 #include "trace-event.h"
 #include "machine.h"
-#include "util.h"
 
 /*
  * global trace_event object used by trace_event__tp_format
diff --git a/tools/perf/util/unwind-libdw.c b/tools/perf/util/unwind-libdw.c
index 28f71ca6ce1c..11f153a7c326 100644
--- a/tools/perf/util/unwind-libdw.c
+++ b/tools/perf/util/unwind-libdw.c
@@ -16,7 +16,6 @@
 #include "event.h"
 #include "perf_regs.h"
 #include "callchain.h"
-#include "util.h"
 
 static char *debuginfo_path;
 
diff --git a/tools/perf/util/unwind-libunwind-local.c b/tools/perf/util/unwind-libunwind-local.c
index ebdbb056510c..1800887b2255 100644
--- a/tools/perf/util/unwind-libunwind-local.c
+++ b/tools/perf/util/unwind-libunwind-local.c
@@ -37,7 +37,6 @@
 #include "unwind.h"
 #include "map.h"
 #include "symbol.h"
-#include "util.h"
 #include "debug.h"
 #include "asm/bug.h"
 #include "dso.h"
* Unmerged path tools/perf/util/vdso.c
* Unmerged path tools/perf/util/zlib.c
