KVM: arm64: Move __load_guest_stage2 to kvm_mmu.h

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Marc Zyngier <maz@kernel.org>
commit fe677be989146b8a8c0f26fe626c6567c4cd3837
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/fe677be9.failed

Having __load_guest_stage2 in kvm_hyp.h is quickly going to trigger
a circular include problem. In order to avoid this, let's move
it to kvm_mmu.h, where it will be a better fit anyway.

In the process, drop the __hyp_text annotation, which doesn't help
as the function is marked as __always_inline.

	Reviewed-by: Suzuki K Poulose <suzuki.poulose@arm.com>
	Signed-off-by: Marc Zyngier <maz@kernel.org>
	Signed-off-by: Will Deacon <will@kernel.org>
(cherry picked from commit fe677be989146b8a8c0f26fe626c6567c4cd3837)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/arm64/include/asm/kvm_hyp.h
diff --cc arch/arm64/include/asm/kvm_hyp.h
index e72f0aac6b25,dcb63bf94105..000000000000
--- a/arch/arm64/include/asm/kvm_hyp.h
+++ b/arch/arm64/include/asm/kvm_hyp.h
@@@ -99,22 -87,5 +98,25 @@@ void deactivate_traps_vhe_put(void)
  u64 __guest_enter(struct kvm_vcpu *vcpu, struct kvm_cpu_context *host_ctxt);
  void __noreturn __hyp_do_panic(unsigned long, ...);
  
++<<<<<<< HEAD
 +/*
 + * Must be called from hyp code running at EL2 with an updated VTTBR
 + * and interrupts disabled.
 + */
 +static __always_inline void __hyp_text __load_guest_stage2(struct kvm *kvm)
 +{
 +	write_sysreg(kvm->arch.vtcr, vtcr_el2);
 +	write_sysreg(kvm_get_vttbr(kvm), vttbr_el2);
 +
 +	/*
 +	 * ARM erratum 1165522 requires the actual execution of the above
 +	 * before we can switch to the EL1/EL0 translation regime used by
 +	 * the guest.
 +	 */
 +	asm(ALTERNATIVE("nop", "isb", ARM64_WORKAROUND_1165522));
 +}
 +
++=======
++>>>>>>> fe677be98914 (KVM: arm64: Move __load_guest_stage2 to kvm_mmu.h)
  #endif /* __ARM64_KVM_HYP_H__ */
  
* Unmerged path arch/arm64/include/asm/kvm_hyp.h
diff --git a/arch/arm64/include/asm/kvm_mmu.h b/arch/arm64/include/asm/kvm_mmu.h
index bf7998d0451d..9032ff308364 100644
--- a/arch/arm64/include/asm/kvm_mmu.h
+++ b/arch/arm64/include/asm/kvm_mmu.h
@@ -613,5 +613,22 @@ static __always_inline u64 kvm_get_vttbr(struct kvm *kvm)
 	return kvm_phys_to_vttbr(baddr) | vmid_field | cnp;
 }
 
+/*
+ * Must be called from hyp code running at EL2 with an updated VTTBR
+ * and interrupts disabled.
+ */
+static __always_inline void __load_guest_stage2(struct kvm *kvm)
+{
+	write_sysreg(kvm->arch.vtcr, vtcr_el2);
+	write_sysreg(kvm_get_vttbr(kvm), vttbr_el2);
+
+	/*
+	 * ARM errata 1165522 and 1530923 require the actual execution of the
+	 * above before we can switch to the EL1/EL0 translation regime used by
+	 * the guest.
+	 */
+	asm(ALTERNATIVE("nop", "isb", ARM64_WORKAROUND_SPECULATIVE_AT));
+}
+
 #endif /* __ASSEMBLY__ */
 #endif /* __ARM64_KVM_MMU_H__ */
