xfs: Use iomap_dio_rw to wait for unaligned direct IO

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Jan Kara <jack@suse.cz>
commit 906753befc4d2610194cd4d3d2ed15dff1ed1ca0
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/906753be.failed

Use iomap_dio_rw() to wait for unaligned direct IO instead of opencoding
the wait.

	Signed-off-by: Jan Kara <jack@suse.cz>
	Reviewed-by: Darrick J. Wong <darrick.wong@oracle.com>
	Signed-off-by: Darrick J. Wong <darrick.wong@oracle.com>
(cherry picked from commit 906753befc4d2610194cd4d3d2ed15dff1ed1ca0)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/xfs/xfs_file.c
diff --cc fs/xfs/xfs_file.c
index c9c7bcb69ae3,c0620135a279..000000000000
--- a/fs/xfs/xfs_file.c
+++ b/fs/xfs/xfs_file.c
@@@ -536,15 -547,12 +536,17 @@@ xfs_file_dio_aio_write
  	}
  
  	trace_xfs_file_direct_write(ip, count, iocb->ki_pos);
++<<<<<<< HEAD
 +	ret = iomap_dio_rw(iocb, from, &xfs_iomap_ops, xfs_dio_write_end_io);
 +
++=======
++>>>>>>> 906753befc4d (xfs: Use iomap_dio_rw to wait for unaligned direct IO)
  	/*
- 	 * If unaligned, this is the only IO in-flight. If it has not yet
- 	 * completed, wait on it before we release the iolock to prevent
- 	 * subsequent overlapping IO.
+ 	 * If unaligned, this is the only IO in-flight. Wait on it before we
+ 	 * release the iolock to prevent subsequent overlapping IO.
  	 */
- 	if (ret == -EIOCBQUEUED && unaligned_io)
- 		inode_dio_wait(inode);
+ 	ret = iomap_dio_rw(iocb, from, &xfs_iomap_ops, &xfs_dio_write_ops,
+ 			   is_sync_kiocb(iocb) || unaligned_io);
  out:
  	xfs_iunlock(ip, iolock);
  
* Unmerged path fs/xfs/xfs_file.c
