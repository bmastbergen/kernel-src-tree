KVM: x86: Shrink the usercopy region of the emulation context

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Sean Christopherson <sean.j.christopherson@intel.com>
commit 06add254c7f3b7f6fdfe04eb028aaabe5b27a734
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/06add254.failed

Shuffle a few operand structs to the end of struct x86_emulate_ctxt and
update the cache creation to whitelist only the region of the emulation
context that is expected to be copied to/from user memory, e.g. the
instruction operands, registers, and fetch/io/mem caches.

	Signed-off-by: Sean Christopherson <sean.j.christopherson@intel.com>
	Reviewed-by: Vitaly Kuznetsov <vkuznets@redhat.com>
	Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
(cherry picked from commit 06add254c7f3b7f6fdfe04eb028aaabe5b27a734)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kvm/x86.c
diff --cc arch/x86/kvm/x86.c
index 4ad9e50bf3f6,a69f7bf020d9..000000000000
--- a/arch/x86/kvm/x86.c
+++ b/arch/x86/kvm/x86.c
@@@ -231,6 -231,19 +231,22 @@@ u64 __read_mostly host_xcr0
  struct kmem_cache *x86_fpu_cache;
  EXPORT_SYMBOL_GPL(x86_fpu_cache);
  
++<<<<<<< HEAD
++=======
+ static struct kmem_cache *x86_emulator_cache;
+ 
+ static struct kmem_cache *kvm_alloc_emulator_cache(void)
+ {
+ 	unsigned int useroffset = offsetof(struct x86_emulate_ctxt, src);
+ 	unsigned int size = sizeof(struct x86_emulate_ctxt);
+ 
+ 	return kmem_cache_create_usercopy("x86_emulator", size,
+ 					  __alignof__(struct x86_emulate_ctxt),
+ 					  SLAB_ACCOUNT, useroffset,
+ 					  size - useroffset, NULL);
+ }
+ 
++>>>>>>> 06add254c7f3 (KVM: x86: Shrink the usercopy region of the emulation context)
  static int emulator_fix_hypercall(struct x86_emulate_ctxt *ctxt);
  
  static inline void kvm_async_pf_hash_reset(struct kvm_vcpu *vcpu)
diff --git a/arch/x86/kvm/kvm_emulate.h b/arch/x86/kvm/kvm_emulate.h
index dcdb44a5fb11..ba19b7b548e0 100644
--- a/arch/x86/kvm/kvm_emulate.h
+++ b/arch/x86/kvm/kvm_emulate.h
@@ -333,9 +333,6 @@ struct x86_emulate_ctxt {
 	u8 intercept;
 	u8 op_bytes;
 	u8 ad_bytes;
-	struct operand src;
-	struct operand src2;
-	struct operand dst;
 	union {
 		int (*execute)(struct x86_emulate_ctxt *ctxt);
 		fastop_t fop;
@@ -363,6 +360,11 @@ struct x86_emulate_ctxt {
 	u8 seg_override;
 	u64 d;
 	unsigned long _eip;
+
+	/* Here begins the usercopy section. */
+	struct operand src;
+	struct operand src2;
+	struct operand dst;
 	struct operand memop;
 	unsigned long _regs[NR_VCPU_REGS];
 	struct operand *memopp;
* Unmerged path arch/x86/kvm/x86.c
