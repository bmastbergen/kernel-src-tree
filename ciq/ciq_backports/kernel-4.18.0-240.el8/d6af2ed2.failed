PCI: hv: Fix a timing issue which causes kdump to fail occasionally

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
Rebuild_CHGLOG: - [pci] hv: Fix a timing issue which causes kdump to fail occasionally (Mohammed Gamal) [1861960]
Rebuild_FUZZ: 96.12%
commit-author Wei Hu <weh@microsoft.com>
commit d6af2ed29c7c1c311b96dac989dcb991e90ee195
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/d6af2ed2.failed

Kdump could fail sometime on Hyper-V guest because the retry in
hv_pci_enter_d0() releases child device structures in hv_pci_bus_exit().

Although there is a second asynchronous device relations message sending
from the host, if this message arrives to the guest after
hv_send_resource_allocated() is called, the retry would fail.

Fix the problem by moving retry to hv_pci_probe() and start the retry
from hv_pci_query_relations() call.  This will cause a device relations
message to arrive to the guest synchronously; the guest would then be
able to rebuild the child device structures before calling
hv_send_resource_allocated().

Link: https://lore.kernel.org/r/20200727071731.18516-1-weh@microsoft.com
Fixes: c81992e7f4aa ("PCI: hv: Retry PCI bus D0 entry on invalid device state")
	Signed-off-by: Wei Hu <weh@microsoft.com>
[lorenzo.pieralisi@arm.com: fixed a comment and commit log]
	Signed-off-by: Lorenzo Pieralisi <lorenzo.pieralisi@arm.com>
	Reviewed-by: Michael Kelley <mikelley@microsoft.com>
(cherry picked from commit d6af2ed29c7c1c311b96dac989dcb991e90ee195)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/pci/controller/pci-hyperv.c
diff --cc drivers/pci/controller/pci-hyperv.c
index 68756b40812e,d0033ff6c143..000000000000
--- a/drivers/pci/controller/pci-hyperv.c
+++ b/drivers/pci/controller/pci-hyperv.c
@@@ -3054,6 -3023,8 +3020,11 @@@ static int hv_pci_probe(struct hv_devic
  {
  	struct hv_pcibus_device *hbus;
  	u16 dom_req, dom;
++<<<<<<< HEAD
++=======
+ 	char *name;
+ 	bool enter_d0_retry = true;
++>>>>>>> d6af2ed29c7c (PCI: hv: Fix a timing issue which causes kdump to fail occasionally)
  	int ret;
  
  	/*
* Unmerged path drivers/pci/controller/pci-hyperv.c
