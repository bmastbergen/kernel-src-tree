selftests/bpf: Improve bpftool changes detection

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Andrii Nakryiko <andriin@fb.com>
commit 03506297d205e5fa25b5ead0f6338b5a4a996a93
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/03506297.failed

Detect when bpftool source code changes and trigger rebuild within
selftests/bpf Makefile. Also fix few small formatting problems.

	Signed-off-by: Andrii Nakryiko <andriin@fb.com>
	Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
	Acked-by: Martin KaFai Lau <kafai@fb.com>
	Acked-by: Toke Høiland-Jørgensen <toke@redhat.com>
Link: https://lore.kernel.org/bpf/20200124054148.2455060-1-andriin@fb.com
(cherry picked from commit 03506297d205e5fa25b5ead0f6338b5a4a996a93)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/testing/selftests/bpf/Makefile
diff --cc tools/testing/selftests/bpf/Makefile
index 1739bffedc44,257a1aaaa37d..000000000000
--- a/tools/testing/selftests/bpf/Makefile
+++ b/tools/testing/selftests/bpf/Makefile
@@@ -124,19 -152,24 +124,35 @@@ $(OUTPUT)/test_cgroup_storage: cgroup_h
  $(OUTPUT)/test_netcnt: cgroup_helpers.c
  $(OUTPUT)/test_sock_fields: cgroup_helpers.c
  $(OUTPUT)/test_sysctl: cgroup_helpers.c
 -
 +$(OUTPUT)/test_cgroup_attach: cgroup_helpers.c
 +$(OUTPUT)/test_sockopt: cgroup_helpers.c
 +$(OUTPUT)/test_sockopt_sk: cgroup_helpers.c
 +$(OUTPUT)/test_sockopt_multi: cgroup_helpers.c
 +$(OUTPUT)/test_tcp_rtt: cgroup_helpers.c
 +
++<<<<<<< HEAD
 +.PHONY: force
 +
 +# force a rebuild of BPFOBJ when its dependencies are updated
 +force:
++=======
+ DEFAULT_BPFTOOL := $(SCRATCH_DIR)/sbin/bpftool
+ BPFTOOL ?= $(DEFAULT_BPFTOOL)
+ $(DEFAULT_BPFTOOL): $(wildcard $(BPFTOOLDIR)/*.[ch] $(BPFTOOLDIR)/Makefile)    \
+ 		    $(BPFOBJ) | $(BUILD_DIR)/bpftool
+ 	$(Q)$(MAKE) $(submake_extras)  -C $(BPFTOOLDIR)			       \
+ 		    OUTPUT=$(BUILD_DIR)/bpftool/			       \
+ 		    prefix= DESTDIR=$(SCRATCH_DIR)/ install
+ 
+ $(BPFOBJ): $(wildcard $(BPFDIR)/*.[ch] $(BPFDIR)/Makefile)		       \
+ 	   ../../../include/uapi/linux/bpf.h                                   \
+ 	   | $(INCLUDE_DIR) $(BUILD_DIR)/libbpf
+ 	$(Q)$(MAKE) $(submake_extras) -C $(BPFDIR) OUTPUT=$(BUILD_DIR)/libbpf/ \
+ 		    DESTDIR=$(SCRATCH_DIR) prefix= all install_headers
++>>>>>>> 03506297d205 (selftests/bpf: Improve bpftool changes detection)
  
 -$(BUILD_DIR)/libbpf $(BUILD_DIR)/bpftool $(INCLUDE_DIR):
 -	$(call msg,MKDIR,,$@)
 -	mkdir -p $@
 +$(BPFOBJ): force
 +	$(MAKE) -C $(BPFDIR) OUTPUT=$(OUTPUT)/
  
  # Get Clang's default includes on this system, as opposed to those seen by
  # '-target bpf'. This fixes "missing" files on some architectures/distros,
* Unmerged path tools/testing/selftests/bpf/Makefile
