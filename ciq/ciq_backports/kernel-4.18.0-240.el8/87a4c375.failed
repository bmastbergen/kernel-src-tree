kconfig: include kernel/Kconfig.preempt from init/Kconfig

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Christoph Hellwig <hch@lst.de>
commit 87a4c375995ed8eaa721b08825cf73d0b02b3145
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/87a4c375.failed

Almost all architectures include it.  Add a ARCH_NO_PREEMPT symbol to
disable preempt support for alpha, hexagon, non-coldfire m68k and
user mode Linux.

	Signed-off-by: Christoph Hellwig <hch@lst.de>
	Signed-off-by: Masahiro Yamada <yamada.masahiro@socionext.com>
(cherry picked from commit 87a4c375995ed8eaa721b08825cf73d0b02b3145)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/arc/Kconfig
#	arch/c6x/Kconfig
#	arch/h8300/Kconfig
#	arch/ia64/Kconfig
#	arch/m68k/Kconfig
#	arch/nds32/Kconfig
#	arch/nios2/Kconfig
#	arch/openrisc/Kconfig
#	arch/powerpc/Kconfig
#	arch/riscv/Kconfig
#	arch/um/Kconfig.um
diff --cc arch/arc/Kconfig
index 753b0cdde165,639ab1bed835..000000000000
--- a/arch/arc/Kconfig
+++ b/arch/arc/Kconfig
@@@ -548,16 -545,8 +548,19 @@@ config ARC_BUILTIN_DTB_NAM
  	  Set the name of the DTB to embed in the vmlinux binary
  	  Leaving it blank selects the minimal "skeleton" dtb
  
++<<<<<<< HEAD
 +source "kernel/Kconfig.preempt"
 +
 +menu "Executable file formats"
 +source "fs/Kconfig.binfmt"
 +endmenu
 +
++=======
++>>>>>>> 87a4c375995e (kconfig: include kernel/Kconfig.preempt from init/Kconfig)
  endmenu	 # "ARC Architecture Configuration"
  
 +source "mm/Kconfig"
 +
  config FORCE_MAX_ZONEORDER
  	int "Maximum zone order"
  	default "12" if ARC_HUGEPAGE_16M
diff --cc arch/c6x/Kconfig
index ad53996d0bd1,a641b0bf1611..000000000000
--- a/arch/c6x/Kconfig
+++ b/arch/c6x/Kconfig
@@@ -111,10 -110,6 +111,13 @@@ config KERNEL_RAM_BASE_ADDRES
  	default 0xe0000000 if SOC_TMS320C6472
  	default 0x80000000
  
++<<<<<<< HEAD
 +source "mm/Kconfig"
 +
 +source "kernel/Kconfig.preempt"
 +
++=======
++>>>>>>> 87a4c375995e (kconfig: include kernel/Kconfig.preempt from init/Kconfig)
  source "kernel/Kconfig.hz"
  
  endmenu
diff --cc arch/h8300/Kconfig
index eccc8ce8a119,5e89d40be8cd..000000000000
--- a/arch/h8300/Kconfig
+++ b/arch/h8300/Kconfig
@@@ -45,40 -48,4 +45,43 @@@ config NR_CPU
  	int
  	default 1
  
 +source "init/Kconfig"
 +
 +source "kernel/Kconfig.freezer"
 +
  source "arch/h8300/Kconfig.cpu"
++<<<<<<< HEAD
 +
 +menu "Kernel Features"
 +
 +source "kernel/Kconfig.preempt"
 +
 +source "mm/Kconfig"
 +
 +endmenu
 +
 +menu "Executable file formats"
 +
 +source "fs/Kconfig.binfmt"
 +
 +endmenu
 +
 +source "net/Kconfig"
 +
 +source "drivers/Kconfig"
 +
 +source "fs/Kconfig"
 +
 +menu "Kernel hacking"
 +
 +source "lib/Kconfig.debug"
 +
 +endmenu
 +
 +source "security/Kconfig"
 +
 +source "crypto/Kconfig"
 +
 +source "lib/Kconfig"
++=======
++>>>>>>> 87a4c375995e (kconfig: include kernel/Kconfig.preempt from init/Kconfig)
diff --cc arch/ia64/Kconfig
index d45b2b4bf85b,86bd377bc7c0..000000000000
--- a/arch/ia64/Kconfig
+++ b/arch/ia64/Kconfig
@@@ -365,10 -364,6 +365,13 @@@ config FORCE_CPEI_RETARGE
  	This option it useful to enable this feature on older BIOS's as well.
  	You can also enable this by using boot command line option force_cpei=1.
  
++<<<<<<< HEAD
 +source "kernel/Kconfig.preempt"
 +
 +source "mm/Kconfig"
 +
++=======
++>>>>>>> 87a4c375995e (kconfig: include kernel/Kconfig.preempt from init/Kconfig)
  config ARCH_SELECT_MEMORY_MODEL
  	def_bool y
  
diff --cc arch/m68k/Kconfig
index afadda00401e,3e47f8df6504..000000000000
--- a/arch/m68k/Kconfig
+++ b/arch/m68k/Kconfig
@@@ -126,18 -130,6 +127,21 @@@ endmen
  
  menu "Kernel Features"
  
++<<<<<<< HEAD
 +if COLDFIRE
 +source "kernel/Kconfig.preempt"
 +endif
 +
 +source "mm/Kconfig"
 +
 +endmenu
 +
 +menu "Executable file formats"
 +
 +source "fs/Kconfig.binfmt"
 +
++=======
++>>>>>>> 87a4c375995e (kconfig: include kernel/Kconfig.preempt from init/Kconfig)
  endmenu
  
  if !MMU
diff --cc arch/nds32/Kconfig
index 222265db21bc,541f16adfb06..000000000000
--- a/arch/nds32/Kconfig
+++ b/arch/nds32/Kconfig
@@@ -87,24 -88,5 +87,27 @@@ config NDS32_BUILTIN_DT
  endmenu
  
  menu "Kernel Features"
++<<<<<<< HEAD
 +source "kernel/Kconfig.preempt"
 +source "kernel/Kconfig.freezer"
 +source "mm/Kconfig"
++=======
++>>>>>>> 87a4c375995e (kconfig: include kernel/Kconfig.preempt from init/Kconfig)
  source "kernel/Kconfig.hz"
  endmenu
 +
 +menu "Executable file formats"
 +source "fs/Kconfig.binfmt"
 +endmenu
 +
 +source "net/Kconfig"
 +source "drivers/Kconfig"
 +source "fs/Kconfig"
 +
 +menu "Kernel hacking"
 +source "lib/Kconfig.debug"
 +endmenu
 +
 +source "security/Kconfig"
 +source "crypto/Kconfig"
 +source "lib/Kconfig"
diff --cc arch/nios2/Kconfig
index c6ff28b77c86,cbe1844b0657..000000000000
--- a/arch/nios2/Kconfig
+++ b/arch/nios2/Kconfig
@@@ -44,18 -45,10 +44,21 @@@ config SWA
  config TRACE_IRQFLAGS_SUPPORT
  	def_bool n
  
 +source "init/Kconfig"
 +
  menu "Kernel features"
  
++<<<<<<< HEAD
 +source "kernel/Kconfig.preempt"
 +
 +source "kernel/Kconfig.freezer"
 +
++=======
++>>>>>>> 87a4c375995e (kconfig: include kernel/Kconfig.preempt from init/Kconfig)
  source "kernel/Kconfig.hz"
  
 +source "mm/Kconfig"
 +
  config FORCE_MAX_ZONEORDER
  	int "Maximum zone order"
  	range 9 20
diff --cc arch/openrisc/Kconfig
index 7eeff90f2a0d,42e3a0f2afab..000000000000
--- a/arch/openrisc/Kconfig
+++ b/arch/openrisc/Kconfig
@@@ -141,8 -143,6 +141,11 @@@ config SM
  	  If you don't know what to do here, say N.
  
  source kernel/Kconfig.hz
++<<<<<<< HEAD
 +source kernel/Kconfig.preempt
 +source "mm/Kconfig"
++=======
++>>>>>>> 87a4c375995e (kconfig: include kernel/Kconfig.preempt from init/Kconfig)
  
  config OPENRISC_NO_SPR_SR_DSX
  	bool "use SPR_SR_DSX software emulation" if OR1K_1200
diff --cc arch/powerpc/Kconfig
index e53a4f79ab92,1c10ff0406f2..000000000000
--- a/arch/powerpc/Kconfig
+++ b/arch/powerpc/Kconfig
@@@ -410,8 -393,6 +410,11 @@@ config HIGHME
  	depends on PPC32
  
  source kernel/Kconfig.hz
++<<<<<<< HEAD
 +source kernel/Kconfig.preempt
 +source "fs/Kconfig.binfmt"
++=======
++>>>>>>> 87a4c375995e (kconfig: include kernel/Kconfig.preempt from init/Kconfig)
  
  config HUGETLB_PAGE_SIZE_VARIABLE
  	bool
diff --cc arch/riscv/Kconfig
index b87622866158,a344980287a5..000000000000
--- a/arch/riscv/Kconfig
+++ b/arch/riscv/Kconfig
@@@ -210,10 -212,6 +210,13 @@@ endmen
  
  menu "Kernel type"
  
++<<<<<<< HEAD
 +source "mm/Kconfig"
 +
 +source "kernel/Kconfig.preempt"
 +
++=======
++>>>>>>> 87a4c375995e (kconfig: include kernel/Kconfig.preempt from init/Kconfig)
  source "kernel/Kconfig.hz"
  
  endmenu
diff --cc arch/um/Kconfig.um
index 20da5a8ca949,6b9938919f0b..000000000000
--- a/arch/um/Kconfig.um
+++ b/arch/um/Kconfig.um
@@@ -1,4 -1,70 +1,73 @@@
  # SPDX-License-Identifier: GPL-2.0
++<<<<<<< HEAD:arch/um/Kconfig.um
++=======
+ 
+ menu "UML-specific options"
+ 
+ config UML
+ 	bool
+ 	default y
+ 	select ARCH_HAS_KCOV
+ 	select ARCH_NO_PREEMPT
+ 	select HAVE_ARCH_AUDITSYSCALL
+ 	select HAVE_ARCH_SECCOMP_FILTER
+ 	select HAVE_UID16
+ 	select HAVE_FUTEX_CMPXCHG if FUTEX
+ 	select HAVE_DEBUG_KMEMLEAK
+ 	select GENERIC_IRQ_SHOW
+ 	select GENERIC_CPU_DEVICES
+ 	select GENERIC_CLOCKEVENTS
+ 	select HAVE_GCC_PLUGINS
+ 	select TTY # Needed for line.c
+ 
+ config MMU
+ 	bool
+ 	default y
+ 
+ config NO_IOMEM
+ 	def_bool y
+ 
+ config ISA
+ 	bool
+ 
+ config SBUS
+ 	bool
+ 
+ config PCI
+ 	bool
+ 
+ config PCMCIA
+ 	bool
+ 
+ config TRACE_IRQFLAGS_SUPPORT
+ 	bool
+ 	default y
+ 
+ config LOCKDEP_SUPPORT
+ 	bool
+ 	default y
+ 
+ config STACKTRACE_SUPPORT
+ 	bool
+ 	default y
+ 	select STACKTRACE
+ 
+ config GENERIC_CALIBRATE_DELAY
+ 	bool
+ 	default y
+ 
+ config HZ
+ 	int
+ 	default 100
+ 
+ config NR_CPUS
+ 	int
+ 	range 1 1
+ 	default 1
+ 
+ source "arch/$(HEADER_ARCH)/um/Kconfig"
+ 
++>>>>>>> 87a4c375995e (kconfig: include kernel/Kconfig.preempt from init/Kconfig):arch/um/Kconfig
  config STATIC_LINK
  	bool "Force a static link"
  	default n
diff --git a/arch/Kconfig b/arch/Kconfig
index ed2a96a672b4..218eea2807c0 100644
--- a/arch/Kconfig
+++ b/arch/Kconfig
@@ -896,6 +896,9 @@ config COMPAT_32BIT_TIME
 config ARCH_NO_COHERENT_DMA_MMAP
 	bool
 
+config ARCH_NO_PREEMPT
+	bool
+
 config CPU_NO_EFFICIENT_FFS
 	def_bool n
 
diff --git a/arch/alpha/Kconfig b/arch/alpha/Kconfig
index 31a34079088d..fb562740a040 100644
--- a/arch/alpha/Kconfig
+++ b/arch/alpha/Kconfig
@@ -4,6 +4,7 @@ config ALPHA
 	default y
 	select ARCH_MIGHT_HAVE_PC_PARPORT
 	select ARCH_MIGHT_HAVE_PC_SERIO
+	select ARCH_NO_PREEMPT
 	select ARCH_USE_CMPXCHG_LOCKREF
 	select HAVE_AOUT
 	select HAVE_IDE
* Unmerged path arch/arc/Kconfig
diff --git a/arch/arm/Kconfig b/arch/arm/Kconfig
index c23576a9a9d8..4a6b62da9eba 100644
--- a/arch/arm/Kconfig
+++ b/arch/arm/Kconfig
@@ -1481,8 +1481,6 @@ config ARCH_NR_GPIO
 
 	  If unsure, leave the default value.
 
-source kernel/Kconfig.preempt
-
 config HZ_FIXED
 	int
 	default 200 if ARCH_EBSA110
diff --git a/arch/arm64/Kconfig b/arch/arm64/Kconfig
index 073cc7eed904..953ad6988c6b 100644
--- a/arch/arm64/Kconfig
+++ b/arch/arm64/Kconfig
@@ -932,7 +932,6 @@ config HOLES_IN_ZONE
 	def_bool y
 	depends on NUMA
 
-source kernel/Kconfig.preempt
 source kernel/Kconfig.hz
 
 config ARCH_SUPPORTS_DEBUG_PAGEALLOC
* Unmerged path arch/c6x/Kconfig
* Unmerged path arch/h8300/Kconfig
diff --git a/arch/hexagon/Kconfig b/arch/hexagon/Kconfig
index 7b25f4fe4f92..c4bb228ae250 100644
--- a/arch/hexagon/Kconfig
+++ b/arch/hexagon/Kconfig
@@ -4,6 +4,7 @@ comment "Linux Kernel Configuration for Hexagon"
 
 config HEXAGON
 	def_bool y
+	select ARCH_NO_PREEMPT
 	select HAVE_OPROFILE
 	# Other pending projects/to-do items.
 	# select HAVE_REGS_AND_STACK_ACCESS_API
* Unmerged path arch/ia64/Kconfig
* Unmerged path arch/m68k/Kconfig
diff --git a/arch/microblaze/Kconfig b/arch/microblaze/Kconfig
index 3218a8b35f9c..cde9e8ff9757 100644
--- a/arch/microblaze/Kconfig
+++ b/arch/microblaze/Kconfig
@@ -87,8 +87,6 @@ source "arch/microblaze/Kconfig.platform"
 
 menu "Processor type and features"
 
-source "kernel/Kconfig.preempt"
-
 source "kernel/Kconfig.hz"
 
 config MMU
diff --git a/arch/mips/Kconfig b/arch/mips/Kconfig
index 29f3ec40278f..990df7001980 100644
--- a/arch/mips/Kconfig
+++ b/arch/mips/Kconfig
@@ -2813,8 +2813,6 @@ config HZ
 config SCHED_HRTICK
 	def_bool HIGH_RES_TIMERS
 
-source "kernel/Kconfig.preempt"
-
 config KEXEC
 	bool "Kexec system call"
 	select KEXEC_CORE
* Unmerged path arch/nds32/Kconfig
* Unmerged path arch/nios2/Kconfig
* Unmerged path arch/openrisc/Kconfig
diff --git a/arch/parisc/Kconfig b/arch/parisc/Kconfig
index e212ceceacc5..9fd37c2ccb14 100644
--- a/arch/parisc/Kconfig
+++ b/arch/parisc/Kconfig
@@ -320,7 +320,6 @@ config NODES_SHIFT
 	default "3"
 	depends on NEED_MULTIPLE_NODES
 
-source "kernel/Kconfig.preempt"
 source "kernel/Kconfig.hz"
 source "mm/Kconfig"
 
* Unmerged path arch/powerpc/Kconfig
* Unmerged path arch/riscv/Kconfig
diff --git a/arch/s390/Kconfig b/arch/s390/Kconfig
index 03371828326b..6315b6cb3f93 100644
--- a/arch/s390/Kconfig
+++ b/arch/s390/Kconfig
@@ -540,8 +540,6 @@ config SCHED_TOPOLOGY
 	  making when dealing with machines that have multi-threading,
 	  multiple cores or multiple books.
 
-source kernel/Kconfig.preempt
-
 source kernel/Kconfig.hz
 
 config KEXEC
diff --git a/arch/sh/Kconfig b/arch/sh/Kconfig
index b58249fed0f7..6fbf2695465a 100644
--- a/arch/sh/Kconfig
+++ b/arch/sh/Kconfig
@@ -707,8 +707,6 @@ config HOTPLUG_CPU
 	  Say Y here to experiment with turning CPUs off and on.  CPUs
 	  can be controlled through /sys/devices/system/cpu.
 
-source "kernel/Kconfig.preempt"
-
 config GUSA
 	def_bool y
 	depends on !SMP && SUPERH32
diff --git a/arch/sparc/Kconfig b/arch/sparc/Kconfig
index 4fe7ee737238..3e0251df1882 100644
--- a/arch/sparc/Kconfig
+++ b/arch/sparc/Kconfig
@@ -347,8 +347,6 @@ config SCHED_MC
 	  making when dealing with multi-core CPU chips at a cost of slightly
 	  increased overhead in some places. If unsure say N here.
 
-source "kernel/Kconfig.preempt"
-
 config CMDLINE_BOOL
 	bool "Default bootloader kernel arguments"
 	depends on SPARC64
* Unmerged path arch/um/Kconfig.um
diff --git a/arch/unicore32/Kconfig b/arch/unicore32/Kconfig
index 4dd7d14574cb..5060038c9f2b 100644
--- a/arch/unicore32/Kconfig
+++ b/arch/unicore32/Kconfig
@@ -133,8 +133,6 @@ endmenu
 
 menu "Kernel Features"
 
-source "kernel/Kconfig.preempt"
-
 source "kernel/Kconfig.hz"
 
 source "mm/Kconfig"
diff --git a/arch/x86/Kconfig b/arch/x86/Kconfig
index 70c5effebd49..2d14bc6c2b41 100644
--- a/arch/x86/Kconfig
+++ b/arch/x86/Kconfig
@@ -1040,8 +1040,6 @@ config SCHED_MC_PRIO
 
 	  If unsure say Y here.
 
-source "kernel/Kconfig.preempt"
-
 config UP_LATE_INIT
        def_bool y
        depends on !SMP && X86_LOCAL_APIC
diff --git a/arch/xtensa/Kconfig b/arch/xtensa/Kconfig
index bc963501b763..121cd9729190 100644
--- a/arch/xtensa/Kconfig
+++ b/arch/xtensa/Kconfig
@@ -173,8 +173,6 @@ config XTENSA_UNALIGNED_USER
 
 	  Say Y here to enable unaligned memory access in user space.
 
-source "kernel/Kconfig.preempt"
-
 config HAVE_SMP
 	bool "System Supports SMP (MX)"
 	depends on XTENSA_VARIANT_CUSTOM
diff --git a/init/Kconfig b/init/Kconfig
index 328364ce0b85..4f9ea1bcf3a9 100644
--- a/init/Kconfig
+++ b/init/Kconfig
@@ -326,6 +326,7 @@ config AUDITSYSCALL
 
 source "kernel/irq/Kconfig"
 source "kernel/time/Kconfig"
+source "kernel/Kconfig.preempt"
 
 menu "CPU/Task time and stats accounting"
 
diff --git a/kernel/Kconfig.preempt b/kernel/Kconfig.preempt
index 3f9c97419f02..cd1655122ec0 100644
--- a/kernel/Kconfig.preempt
+++ b/kernel/Kconfig.preempt
@@ -18,6 +18,7 @@ config PREEMPT_NONE
 
 config PREEMPT_VOLUNTARY
 	bool "Voluntary Kernel Preemption (Desktop)"
+	depends on !ARCH_NO_PREEMPT
 	help
 	  This option reduces the latency of the kernel by adding more
 	  "explicit preemption points" to the kernel code. These new
@@ -35,6 +36,7 @@ config PREEMPT_VOLUNTARY
 
 config PREEMPT
 	bool "Preemptible Kernel (Low-Latency Desktop)"
+	depends on !ARCH_NO_PREEMPT
 	select PREEMPT_COUNT
 	select UNINLINE_SPIN_UNLOCK if !ARCH_INLINE_SPIN_UNLOCK
 	help
diff --git a/lib/Kconfig.debug b/lib/Kconfig.debug
index bdfb152416e9..60e5c110a3fc 100644
--- a/lib/Kconfig.debug
+++ b/lib/Kconfig.debug
@@ -1230,6 +1230,7 @@ config DEBUG_ATOMIC_SLEEP
 	bool "Sleep inside atomic section checking"
 	select PREEMPT_COUNT
 	depends on DEBUG_KERNEL
+	depends on !ARCH_NO_PREEMPT
 	help
 	  If you say Y here, various routines which may sleep will become very
 	  noisy if they are called inside atomic sections: when a spinlock is
