KVM: VMX: Clean cr3/pgd handling in vmx_load_mmu_pgd()

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Sean Christopherson <sean.j.christopherson@intel.com>
commit be100ef136254ab4a3ff223e2288aae6c5809ac6
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/be100ef1.failed

Rename @cr3 to @pgd in vmx_load_mmu_pgd() to reflect that it will be
loaded into vmcs.EPT_POINTER and not vmcs.GUEST_CR3 when EPT is enabled.
Similarly, load guest_cr3 with @pgd if and only if EPT is disabled.

This fixes one of the last, if not _the_ last, cases in KVM where a
variable that is not strictly a cr3 value uses "cr3" instead of "pgd".

	Signed-off-by: Sean Christopherson <sean.j.christopherson@intel.com>
Message-Id: <20200320212833.3507-38-sean.j.christopherson@intel.com>
	Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
(cherry picked from commit be100ef136254ab4a3ff223e2288aae6c5809ac6)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kvm/vmx/vmx.c
diff --cc arch/x86/kvm/vmx/vmx.c
index dbadf7ce3b2f,aa1b8cf7c915..000000000000
--- a/arch/x86/kvm/vmx/vmx.c
+++ b/arch/x86/kvm/vmx/vmx.c
@@@ -3084,19 -3034,18 +3084,22 @@@ u64 construct_eptp(struct kvm_vcpu *vcp
  	return eptp;
  }
  
++<<<<<<< HEAD
 +void vmx_set_cr3(struct kvm_vcpu *vcpu, unsigned long cr3)
++=======
+ void vmx_load_mmu_pgd(struct kvm_vcpu *vcpu, unsigned long pgd)
++>>>>>>> be100ef13625 (KVM: VMX: Clean cr3/pgd handling in vmx_load_mmu_pgd())
  {
  	struct kvm *kvm = vcpu->kvm;
  	bool update_guest_cr3 = true;
  	unsigned long guest_cr3;
  	u64 eptp;
  
- 	guest_cr3 = cr3;
  	if (enable_ept) {
- 		eptp = construct_eptp(vcpu, cr3);
+ 		eptp = construct_eptp(vcpu, pgd);
  		vmcs_write64(EPT_POINTER, eptp);
  
 -		if (kvm_x86_ops.tlb_remote_flush) {
 +		if (kvm_x86_ops->tlb_remote_flush) {
  			spin_lock(&to_kvm_vmx(kvm)->ept_pointer_lock);
  			to_vmx(vcpu)->ept_pointer = eptp;
  			to_kvm_vmx(kvm)->ept_pointers_match
* Unmerged path arch/x86/kvm/vmx/vmx.c
