writeback, cgroup: inode_switch_wbs() shouldn't give up on wb_switch_rwsem trylock fail

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Tejun Heo <tj@kernel.org>
commit 6444f47eb8678a43d5260c67b89c18b1ea09e79e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/6444f47e.failed

As inode wb switching may make sync(2) miss some inodes, they're
synchronized using wb_switch_rwsem so that no wb switching happens
while sync(2) is in progress.  In addition to synchronizing the actual
switching, the rwsem is also used to prevent queueing new switch
attempts while sync(2) is in progress.  This is to avoid queueing too
many instances while the rwsem is held by sync(2).  Unfortunately,
this is too agressive and can block wb switching for a long time if
sync(2) is frequent.

The goal is avoiding expolding the number of scheduled switches, not
avoiding scheduling anything.  Let's use wb_switch_rwsem only for
synchronizing the actual switching and sync(2) and use
isw_nr_in_flight instead for limiting the maximum number of scheduled
switches.  The limit is set to 1024 which should be more than enough
while still avoiding extreme situations.

	Reviewed-by: Jan Kara <jack@suse.cz>
	Signed-off-by: Tejun Heo <tj@kernel.org>
	Signed-off-by: Jens Axboe <axboe@kernel.dk>
(cherry picked from commit 6444f47eb8678a43d5260c67b89c18b1ea09e79e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/fs-writeback.c
diff --cc fs/fs-writeback.c
index 72e5e615710d,fddd8abd839a..000000000000
--- a/fs/fs-writeback.c
+++ b/fs/fs-writeback.c
@@@ -558,7 -546,9 +554,13 @@@ static void inode_switch_wbs(struct ino
  	 * Let's continue after I_WB_SWITCH is guaranteed to be visible.
  	 */
  	call_rcu(&isw->rcu_head, inode_switch_wbs_rcu_fn);
++<<<<<<< HEAD
 +	goto out_unlock;
++=======
+ 
+ 	atomic_inc(&isw_nr_in_flight);
+ 	return;
++>>>>>>> 6444f47eb867 (writeback, cgroup: inode_switch_wbs() shouldn't give up on wb_switch_rwsem trylock fail)
  
  out_free:
  	if (isw->new_wb)
* Unmerged path fs/fs-writeback.c
