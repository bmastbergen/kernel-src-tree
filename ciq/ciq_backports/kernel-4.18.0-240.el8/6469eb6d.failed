perf script: Allow showing the --switch-on event

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Arnaldo Carvalho de Melo <acme@redhat.com>
commit 6469eb6dffeb44edfa3d4ca496b044b4a9c643b9
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/6469eb6d.failed

One may want to see the --switch-on event as well, allow for that, using
the previous cset example:

  # perf script --switch-on syscalls:sys_enter_nanosleep --show-on-off
        sleep 13638 [001] 108237.582286: syscalls:sys_enter_nanosleep: rqtp: 0x7fff1948ac40, rmtp: 0x00000000
        sleep 13638 [001] 108237.582289:     sched:sched_stat_runtime: comm=sleep pid=13638 runtime=578104 [ns] vruntime=202889459556 [ns]
        sleep 13638 [001] 108237.582291:           sched:sched_switch: sleep:13638 [120] S ==> swapper/1:0 [120]
      swapper     0 [001] 108238.582428:           sched:sched_waking: comm=sleep pid=13638 prio=120 target_cpu=001
      swapper     0 [001] 108238.582458:           sched:sched_wakeup: sleep:13638 [120] success=1 CPU:001
        sleep 13638 [001] 108238.582698:     sched:sched_stat_runtime: comm=sleep pid=13638 runtime=173915 [ns] vruntime=202889633471 [ns]
        sleep 13638 [001] 108238.582782:     sched:sched_process_exit: comm=sleep pid=13638 prio=120
  #
  # perf script --switch-on syscalls:sys_enter_nanosleep
        sleep 13638 [001] 108237.582289:     sched:sched_stat_runtime: comm=sleep pid=13638 runtime=578104 [ns] vruntime=202889459556 [ns]
        sleep 13638 [001] 108237.582291:           sched:sched_switch: sleep:13638 [120] S ==> swapper/1:0 [120]
      swapper     0 [001] 108238.582428:           sched:sched_waking: comm=sleep pid=13638 prio=120 target_cpu=001
      swapper     0 [001] 108238.582458:           sched:sched_wakeup: sleep:13638 [120] success=1 CPU:001
        sleep 13638 [001] 108238.582698:     sched:sched_stat_runtime: comm=sleep pid=13638 runtime=173915 [ns] vruntime=202889633471 [ns]
        sleep 13638 [001] 108238.582782:     sched:sched_process_exit: comm=sleep pid=13638 prio=120
  #

	Signed-off-by: Arnaldo Carvalho de Melo <acme@redhat.com>
	Cc: Adrian Hunter <adrian.hunter@intel.com>
	Cc: Jiri Olsa <jolsa@kernel.org>
	Cc: Namhyung Kim <namhyung@kernel.org>
	Cc: William Cohen <wcohen@redhat.com>
	Cc: Florian Weimer <fweimer@redhat.com>
Link: https://lkml.kernel.org/n/tip-0omwwoywj1v63gu8cz0tr0cy@git.kernel.org
	Signed-off-by: Arnaldo Carvalho de Melo <acme@redhat.com>
(cherry picked from commit 6469eb6dffeb44edfa3d4ca496b044b4a9c643b9)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/perf/Documentation/perf-script.txt
#	tools/perf/builtin-script.c
diff --cc tools/perf/Documentation/perf-script.txt
index caaab28f8400,24eea68ee829..000000000000
--- a/tools/perf/Documentation/perf-script.txt
+++ b/tools/perf/Documentation/perf-script.txt
@@@ -417,6 -417,12 +417,15 @@@ include::itrace.txt[
  	For itrace only show specified functions and their callees for
  	itrace. Multiple functions can be separated by comma.
  
++<<<<<<< HEAD
++=======
+ --switch-on EVENT_NAME::
+ 	Only consider events after this event is found.
+ 
+ --show-on-off-events::
+ 	Show the --switch-on event too.
+ 
++>>>>>>> 6469eb6dffeb (perf script: Allow showing the --switch-on event)
  SEE ALSO
  --------
  linkperf:perf-record[1], linkperf:perf-script-perl[1],
diff --cc tools/perf/builtin-script.c
index 381a10d3337c,fa0cc8b0eccc..000000000000
--- a/tools/perf/builtin-script.c
+++ b/tools/perf/builtin-script.c
@@@ -1616,6 -1616,12 +1616,15 @@@ static int perf_sample__fprintf_synth(s
  	return 0;
  }
  
++<<<<<<< HEAD
++=======
+ struct evswitch {
+ 	struct evsel *on;
+ 	bool	     discarding;
+ 	bool	     show_on_off_events;
+ };
+ 
++>>>>>>> 6469eb6dffeb (perf script: Allow showing the --switch-on event)
  struct perf_script {
  	struct perf_tool	tool;
  	struct perf_session	*session;
@@@ -1805,6 -1812,16 +1814,19 @@@ static void process_event(struct perf_s
  	if (!show_event(sample, evsel, thread, al))
  		return;
  
++<<<<<<< HEAD
++=======
+ 	if (script->evswitch.on && script->evswitch.discarding) {
+ 		if (script->evswitch.on != evsel)
+ 			return;
+ 
+ 		script->evswitch.discarding = false;
+ 
+ 		if (!script->evswitch.show_on_off_events)
+ 			return;
+ 	}
+ 
++>>>>>>> 6469eb6dffeb (perf script: Allow showing the --switch-on event)
  	++es->samples;
  
  	perf_sample__fprintf_start(sample, thread, evsel,
@@@ -3538,6 -3556,10 +3560,13 @@@ int cmd_script(int argc, const char **a
  		   "file", "file saving guest os /proc/kallsyms"),
  	OPT_STRING(0, "guestmodules", &symbol_conf.default_guest_modules,
  		   "file", "file saving guest os /proc/modules"),
++<<<<<<< HEAD
++=======
+ 	OPT_STRING(0, "switch-on", &event_switch_on,
+ 		   "event", "Consider events from the first ocurrence of this event"),
+ 	OPT_BOOLEAN(0, "show-on-off-events", &script.evswitch.show_on_off_events,
+ 		    "Show the on/off switch events, used with --switch-on"),
++>>>>>>> 6469eb6dffeb (perf script: Allow showing the --switch-on event)
  	OPT_END()
  	};
  	const char * const script_subcommands[] = { "record", "report", NULL };
* Unmerged path tools/perf/Documentation/perf-script.txt
* Unmerged path tools/perf/builtin-script.c
