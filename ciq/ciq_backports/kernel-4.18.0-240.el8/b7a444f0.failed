bnxt_en: Add fw.mgmt.api version to devlink info_get cb.

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
Rebuild_CHGLOG: - [netdrv] bnxt_en: Add fw.mgmt.api version to devlink info_get cb (Jonathan Toppins) [1790621]
Rebuild_FUZZ: 99.10%
commit-author Vasundhara Volam <vasundhara-v.volam@broadcom.com>
commit b7a444f078592921fa6f83f44b42dd88c08955ee
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/b7a444f0.failed

Display the minimum version of firmware interface spec supported
between driver and firmware. Also update bnxt.rst documentation file.

	Signed-off-by: Vasundhara Volam <vasundhara-v.volam@broadcom.com>
	Signed-off-by: Michael Chan <michael.chan@broadcom.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit b7a444f078592921fa6f83f44b42dd88c08955ee)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	Documentation/networking/devlink/bnxt.rst
#	drivers/net/ethernet/broadcom/bnxt/bnxt_devlink.c
diff --cc drivers/net/ethernet/broadcom/bnxt/bnxt_devlink.c
index 36b0c371f46c,39c2ac4ecc4e..000000000000
--- a/drivers/net/ethernet/broadcom/bnxt/bnxt_devlink.c
+++ b/drivers/net/ethernet/broadcom/bnxt/bnxt_devlink.c
@@@ -321,6 -359,142 +321,145 @@@ static void bnxt_copy_from_nvm_data(uni
  		dst->vu8 = (u8)val32;
  }
  
++<<<<<<< HEAD
++=======
+ static int bnxt_hwrm_get_nvm_cfg_ver(struct bnxt *bp,
+ 				     union devlink_param_value *nvm_cfg_ver)
+ {
+ 	struct hwrm_nvm_get_variable_input req = {0};
+ 	union bnxt_nvm_data *data;
+ 	dma_addr_t data_dma_addr;
+ 	int rc;
+ 
+ 	bnxt_hwrm_cmd_hdr_init(bp, &req, HWRM_NVM_GET_VARIABLE, -1, -1);
+ 	data = dma_alloc_coherent(&bp->pdev->dev, sizeof(*data),
+ 				  &data_dma_addr, GFP_KERNEL);
+ 	if (!data)
+ 		return -ENOMEM;
+ 
+ 	req.dest_data_addr = cpu_to_le64(data_dma_addr);
+ 	req.data_len = cpu_to_le16(BNXT_NVM_CFG_VER_BITS);
+ 	req.option_num = cpu_to_le16(NVM_OFF_NVM_CFG_VER);
+ 
+ 	rc = hwrm_send_message_silent(bp, &req, sizeof(req), HWRM_CMD_TIMEOUT);
+ 	if (!rc)
+ 		bnxt_copy_from_nvm_data(nvm_cfg_ver, data,
+ 					BNXT_NVM_CFG_VER_BITS,
+ 					BNXT_NVM_CFG_VER_BYTES);
+ 
+ 	dma_free_coherent(&bp->pdev->dev, sizeof(*data), data, data_dma_addr);
+ 	return rc;
+ }
+ 
+ static int bnxt_dl_info_get(struct devlink *dl, struct devlink_info_req *req,
+ 			    struct netlink_ext_ack *extack)
+ {
+ 	struct bnxt *bp = bnxt_get_bp_from_dl(dl);
+ 	union devlink_param_value nvm_cfg_ver;
+ 	struct hwrm_ver_get_output *ver_resp;
+ 	char mgmt_ver[FW_VER_STR_LEN];
+ 	char roce_ver[FW_VER_STR_LEN];
+ 	char fw_ver[FW_VER_STR_LEN];
+ 	char buf[32];
+ 	int rc;
+ 
+ 	rc = devlink_info_driver_name_put(req, DRV_MODULE_NAME);
+ 	if (rc)
+ 		return rc;
+ 
+ 	sprintf(buf, "%X", bp->chip_num);
+ 	rc = devlink_info_version_fixed_put(req,
+ 			DEVLINK_INFO_VERSION_GENERIC_ASIC_ID, buf);
+ 	if (rc)
+ 		return rc;
+ 
+ 	ver_resp = &bp->ver_resp;
+ 	sprintf(buf, "%X", ver_resp->chip_rev);
+ 	rc = devlink_info_version_fixed_put(req,
+ 			DEVLINK_INFO_VERSION_GENERIC_ASIC_REV, buf);
+ 	if (rc)
+ 		return rc;
+ 
+ 	if (BNXT_PF(bp)) {
+ 		sprintf(buf, "%02X-%02X-%02X-%02X-%02X-%02X-%02X-%02X",
+ 			bp->dsn[7], bp->dsn[6], bp->dsn[5], bp->dsn[4],
+ 			bp->dsn[3], bp->dsn[2], bp->dsn[1], bp->dsn[0]);
+ 		rc = devlink_info_serial_number_put(req, buf);
+ 		if (rc)
+ 			return rc;
+ 	}
+ 
+ 	if (strlen(ver_resp->active_pkg_name)) {
+ 		rc =
+ 		    devlink_info_version_running_put(req,
+ 					DEVLINK_INFO_VERSION_GENERIC_FW,
+ 					ver_resp->active_pkg_name);
+ 		if (rc)
+ 			return rc;
+ 	}
+ 
+ 	if (BNXT_PF(bp) && !bnxt_hwrm_get_nvm_cfg_ver(bp, &nvm_cfg_ver)) {
+ 		u32 ver = nvm_cfg_ver.vu32;
+ 
+ 		sprintf(buf, "%X.%X.%X", (ver >> 16) & 0xF, (ver >> 8) & 0xF,
+ 			ver & 0xF);
+ 		rc = devlink_info_version_running_put(req,
+ 				DEVLINK_INFO_VERSION_GENERIC_FW_PSID, buf);
+ 		if (rc)
+ 			return rc;
+ 	}
+ 
+ 	if (ver_resp->flags & VER_GET_RESP_FLAGS_EXT_VER_AVAIL) {
+ 		snprintf(fw_ver, FW_VER_STR_LEN, "%d.%d.%d.%d",
+ 			 ver_resp->hwrm_fw_major, ver_resp->hwrm_fw_minor,
+ 			 ver_resp->hwrm_fw_build, ver_resp->hwrm_fw_patch);
+ 
+ 		snprintf(mgmt_ver, FW_VER_STR_LEN, "%d.%d.%d.%d",
+ 			 ver_resp->mgmt_fw_major, ver_resp->mgmt_fw_minor,
+ 			 ver_resp->mgmt_fw_build, ver_resp->mgmt_fw_patch);
+ 
+ 		snprintf(roce_ver, FW_VER_STR_LEN, "%d.%d.%d.%d",
+ 			 ver_resp->roce_fw_major, ver_resp->roce_fw_minor,
+ 			 ver_resp->roce_fw_build, ver_resp->roce_fw_patch);
+ 	} else {
+ 		snprintf(fw_ver, FW_VER_STR_LEN, "%d.%d.%d.%d",
+ 			 ver_resp->hwrm_fw_maj_8b, ver_resp->hwrm_fw_min_8b,
+ 			 ver_resp->hwrm_fw_bld_8b, ver_resp->hwrm_fw_rsvd_8b);
+ 
+ 		snprintf(mgmt_ver, FW_VER_STR_LEN, "%d.%d.%d.%d",
+ 			 ver_resp->mgmt_fw_maj_8b, ver_resp->mgmt_fw_min_8b,
+ 			 ver_resp->mgmt_fw_bld_8b, ver_resp->mgmt_fw_rsvd_8b);
+ 
+ 		snprintf(roce_ver, FW_VER_STR_LEN, "%d.%d.%d.%d",
+ 			 ver_resp->roce_fw_maj_8b, ver_resp->roce_fw_min_8b,
+ 			 ver_resp->roce_fw_bld_8b, ver_resp->roce_fw_rsvd_8b);
+ 	}
+ 	rc = devlink_info_version_running_put(req,
+ 			DEVLINK_INFO_VERSION_GENERIC_FW_APP, fw_ver);
+ 	if (rc)
+ 		return rc;
+ 
+ 	rc = devlink_info_version_running_put(req,
+ 				DEVLINK_INFO_VERSION_GENERIC_FW_MGMT_API,
+ 				bp->hwrm_ver_supp);
+ 	if (rc)
+ 		return rc;
+ 
+ 	if (!(bp->flags & BNXT_FLAG_CHIP_P5)) {
+ 		rc = devlink_info_version_running_put(req,
+ 			DEVLINK_INFO_VERSION_GENERIC_FW_MGMT, mgmt_ver);
+ 		if (rc)
+ 			return rc;
+ 
+ 		rc = devlink_info_version_running_put(req,
+ 			DEVLINK_INFO_VERSION_GENERIC_FW_ROCE, roce_ver);
+ 		if (rc)
+ 			return rc;
+ 	}
+ 	return 0;
+ }
+ 
++>>>>>>> b7a444f07859 (bnxt_en: Add fw.mgmt.api version to devlink info_get cb.)
  static int bnxt_hwrm_nvm_req(struct bnxt *bp, u32 param_id, void *msg,
  			     int msg_len, union devlink_param_value *val)
  {
* Unmerged path Documentation/networking/devlink/bnxt.rst
* Unmerged path Documentation/networking/devlink/bnxt.rst
diff --git a/drivers/net/ethernet/broadcom/bnxt/bnxt.c b/drivers/net/ethernet/broadcom/bnxt/bnxt.c
index f42f618256bb..deeaee884e0f 100644
--- a/drivers/net/ethernet/broadcom/bnxt/bnxt.c
+++ b/drivers/net/ethernet/broadcom/bnxt/bnxt.c
@@ -7235,7 +7235,7 @@ static int __bnxt_hwrm_ver_get(struct bnxt *bp, bool silent)
 static int bnxt_hwrm_ver_get(struct bnxt *bp)
 {
 	struct hwrm_ver_get_output *resp = bp->hwrm_cmd_resp_addr;
-	u32 dev_caps_cfg;
+	u32 dev_caps_cfg, hwrm_ver;
 	int rc;
 
 	bp->hwrm_max_req_len = HWRM_MAX_REQ_LEN;
@@ -7255,6 +7255,19 @@ static int bnxt_hwrm_ver_get(struct bnxt *bp)
 			    resp->hwrm_intf_upd_8b);
 		netdev_warn(bp->dev, "Please update firmware with HWRM interface 1.0.0 or newer.\n");
 	}
+
+	hwrm_ver = HWRM_VERSION_MAJOR << 16 | HWRM_VERSION_MINOR << 8 |
+			HWRM_VERSION_UPDATE;
+
+	if (bp->hwrm_spec_code > hwrm_ver)
+		snprintf(bp->hwrm_ver_supp, FW_VER_STR_LEN, "%d.%d.%d",
+			 HWRM_VERSION_MAJOR, HWRM_VERSION_MINOR,
+			 HWRM_VERSION_UPDATE);
+	else
+		snprintf(bp->hwrm_ver_supp, FW_VER_STR_LEN, "%d.%d.%d",
+			 resp->hwrm_intf_maj_8b, resp->hwrm_intf_min_8b,
+			 resp->hwrm_intf_upd_8b);
+
 	snprintf(bp->fw_ver_str, BC_HWRM_STR_LEN, "%d.%d.%d.%d",
 		 resp->hwrm_fw_maj_8b, resp->hwrm_fw_min_8b,
 		 resp->hwrm_fw_bld_8b, resp->hwrm_fw_rsvd_8b);
diff --git a/drivers/net/ethernet/broadcom/bnxt/bnxt.h b/drivers/net/ethernet/broadcom/bnxt/bnxt.h
index c311c637d559..50037a8abba4 100644
--- a/drivers/net/ethernet/broadcom/bnxt/bnxt.h
+++ b/drivers/net/ethernet/broadcom/bnxt/bnxt.h
@@ -1727,6 +1727,7 @@ struct bnxt {
 #define BC_HWRM_STR_LEN		21
 #define PHY_VER_STR_LEN         (FW_VER_STR_LEN - BC_HWRM_STR_LEN)
 	char			fw_ver_str[FW_VER_STR_LEN];
+	char			hwrm_ver_supp[FW_VER_STR_LEN];
 	__be16			vxlan_port;
 	u8			vxlan_port_cnt;
 	__le16			vxlan_fw_dst_port_id;
* Unmerged path drivers/net/ethernet/broadcom/bnxt/bnxt_devlink.c
