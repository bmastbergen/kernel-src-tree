x86/entry/64: Fix unwind hints in kernel exit path

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Josh Poimboeuf <jpoimboe@redhat.com>
commit 1fb143634a38095b641a3a21220774799772dc4c
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/1fb14363.failed

In swapgs_restore_regs_and_return_to_usermode, after the stack is
switched to the trampoline stack, the existing UNWIND_HINT_REGS hint is
no longer valid, which can result in the following ORC unwinder warning:

  WARNING: can't dereference registers at 000000003aeb0cdd for ip swapgs_restore_regs_and_return_to_usermode+0x93/0xa0

For full correctness, we could try to add complicated unwind hints so
the unwinder could continue to find the registers, but when when it's
this close to kernel exit, unwind hints aren't really needed anymore and
it's fine to just use an empty hint which tells the unwinder to stop.

For consistency, also move the UNWIND_HINT_EMPTY in
entry_SYSCALL_64_after_hwframe to a similar location.

Fixes: 3e3b9293d392 ("x86/entry/64: Return to userspace from the trampoline stack")
	Reported-by: Vince Weaver <vincent.weaver@maine.edu>
	Reported-by: Dave Jones <dsj@fb.com>
	Reported-by: Dr. David Alan Gilbert <dgilbert@redhat.com>
	Reported-by: Joe Mario <jmario@redhat.com>
	Reported-by: Jann Horn <jannh@google.com>
	Reported-by: Linus Torvalds <torvalds@linux-foundation.org>
	Reviewed-by: Miroslav Benes <mbenes@suse.cz>
	Signed-off-by: Josh Poimboeuf <jpoimboe@redhat.com>
	Signed-off-by: Ingo Molnar <mingo@kernel.org>
	Cc: Andy Lutomirski <luto@kernel.org>
	Cc: Peter Zijlstra <peterz@infradead.org>
	Cc: Thomas Gleixner <tglx@linutronix.de>
Link: https://lore.kernel.org/r/60ea8f562987ed2d9ace2977502fe481c0d7c9a0.1587808742.git.jpoimboe@redhat.com
(cherry picked from commit 1fb143634a38095b641a3a21220774799772dc4c)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/entry/entry_64.S
diff --cc arch/x86/entry/entry_64.S
index 630adb2c6a1a,6b0d679efd6b..000000000000
--- a/arch/x86/entry/entry_64.S
+++ b/arch/x86/entry/entry_64.S
@@@ -251,8 -249,6 +251,11 @@@ GLOBAL(entry_SYSCALL_64_after_hwframe
  	 */
  syscall_return_via_sysret:
  	/* rcx and r11 are already restored (see code above) */
++<<<<<<< HEAD
 +	UNWIND_HINT_EMPTY
 +	IBRS_EXIT
++=======
++>>>>>>> 1fb143634a38 (x86/entry/64: Fix unwind hints in kernel exit path)
  	POP_REGS pop_rdi=0 skip_r11rcx=1
  
  	/*
* Unmerged path arch/x86/entry/entry_64.S
