openvswitch: Fix conntrack cache with timeout

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Yi-Hung Wei <yihung.wei@gmail.com>
commit 7177895154e6a35179d332f4a584d396c50d0612
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/71778951.failed

This patch addresses a conntrack cache issue with timeout policy.
Currently, we do not check if the timeout extension is set properly in the
cached conntrack entry.  Thus, after packet recirculate from conntrack
action, the timeout policy is not applied properly.  This patch fixes the
aforementioned issue.

Fixes: 06bd2bdf19d2 ("openvswitch: Add timeout support to ct action")
	Reported-by: kbuild test robot <lkp@intel.com>
	Signed-off-by: Yi-Hung Wei <yihung.wei@gmail.com>
	Acked-by: Pravin B Shelar <pshelar@ovn.org>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 7177895154e6a35179d332f4a584d396c50d0612)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/openvswitch/conntrack.c
diff --cc net/openvswitch/conntrack.c
index edb57c07c767,d8da6477d6be..000000000000
--- a/net/openvswitch/conntrack.c
+++ b/net/openvswitch/conntrack.c
@@@ -75,7 -66,9 +75,13 @@@ struct ovs_conntrack_info 
  	u32 eventmask;              /* Mask of 1 << IPCT_*. */
  	struct md_mark mark;
  	struct md_labels labels;
++<<<<<<< HEAD
 +#ifdef CONFIG_NF_NAT_NEEDED
++=======
+ 	char timeout[CTNL_TIMEOUT_NAME_MAX];
+ 	struct nf_ct_timeout *nf_ct_timeout;
+ #if IS_ENABLED(CONFIG_NF_NAT)
++>>>>>>> 7177895154e6 (openvswitch: Fix conntrack cache with timeout)
  	struct nf_nat_range2 range;  /* Only present for SRC NAT and DST NAT. */
  #endif
  };
@@@ -1676,6 -1660,18 +1690,21 @@@ int ovs_ct_copy_action(struct net *net
  		OVS_NLERR(log, "Failed to allocate conntrack template");
  		return -ENOMEM;
  	}
++<<<<<<< HEAD
++=======
+ 
+ 	if (ct_info.timeout[0]) {
+ 		if (nf_ct_set_timeout(net, ct_info.ct, family, key->ip.proto,
+ 				      ct_info.timeout))
+ 			pr_info_ratelimited("Failed to associated timeout "
+ 					    "policy `%s'\n", ct_info.timeout);
+ 		else
+ 			ct_info.nf_ct_timeout = rcu_dereference(
+ 				nf_ct_timeout_find(ct_info.ct)->timeout);
+ 
+ 	}
+ 
++>>>>>>> 7177895154e6 (openvswitch: Fix conntrack cache with timeout)
  	if (helper) {
  		err = ovs_ct_add_helper(&ct_info, helper, key, log);
  		if (err)
* Unmerged path net/openvswitch/conntrack.c
