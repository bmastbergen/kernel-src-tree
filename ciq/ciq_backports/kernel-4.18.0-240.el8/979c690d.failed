block: move clearing bd_invalidated into check_disk_size_change

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Christoph Hellwig <hch@lst.de>
commit 979c690d9a017db14b7759a099478e3faad991ac
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/979c690d.failed

Both callers of check_disk_size_change clear bd_invalidate directly
after the call, so move the clearing into check_disk_size_change
itself.

	Signed-off-by: Christoph Hellwig <hch@lst.de>
	Signed-off-by: Jens Axboe <axboe@kernel.dk>
(cherry picked from commit 979c690d9a017db14b7759a099478e3faad991ac)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/block_dev.c
diff --cc fs/block_dev.c
index 445bfb04306f,ee63c2732fa2..000000000000
--- a/fs/block_dev.c
+++ b/fs/block_dev.c
@@@ -1529,18 -1508,44 +1529,42 @@@ EXPORT_SYMBOL(bd_set_size)
  
  static void __blkdev_put(struct block_device *bdev, fmode_t mode, int for_part);
  
 -int bdev_disk_changed(struct block_device *bdev, bool invalidate)
 +static void bdev_disk_changed(struct block_device *bdev, bool invalidate)
  {
++<<<<<<< HEAD
 +	if (disk_part_scan_enabled(bdev->bd_disk)) {
 +		if (invalidate)
 +			invalidate_partitions(bdev->bd_disk, bdev);
 +		else
 +			rescan_partitions(bdev->bd_disk, bdev);
++=======
+ 	struct gendisk *disk = bdev->bd_disk;
+ 	int ret;
+ 
+ 	lockdep_assert_held(&bdev->bd_mutex);
+ 
+ rescan:
+ 	ret = blk_drop_partitions(disk, bdev);
+ 	if (ret)
+ 		return ret;
+ 
+ 	if (invalidate)
+ 		set_capacity(disk, 0);
+ 	else if (disk->fops->revalidate_disk)
+ 		disk->fops->revalidate_disk(disk);
+ 
+ 	check_disk_size_change(disk, bdev, !invalidate);
+ 
+ 	if (get_capacity(disk)) {
+ 		ret = blk_add_partitions(disk, bdev);
+ 		if (ret == -EAGAIN)
+ 			goto rescan;
++>>>>>>> 979c690d9a01 (block: move clearing bd_invalidated into check_disk_size_change)
  	} else {
 -		/*
 -		 * Tell userspace that the media / partition table may have
 -		 * changed.
 -		 */
 -		kobject_uevent(&disk_to_dev(disk)->kobj, KOBJ_CHANGE);
 +		check_disk_size_change(bdev->bd_disk, bdev, !invalidate);
 +		bdev->bd_invalidated = 0;
  	}
 -
 -	return ret;
  }
 -/*
 - * Only exported for for loop and dasd for historic reasons.  Don't use in new
 - * code!
 - */
 -EXPORT_SYMBOL_GPL(bdev_disk_changed);
  
  /*
   * bd_mutex locking:
* Unmerged path fs/block_dev.c
