KVM: PPC: Book3S HV: Handle memory plug/unplug to secure VM

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Bharata B Rao <bharata@linux.ibm.com>
commit c32622575dd0ecb6fd0b41e3a451bd58152971ba
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/c3262257.failed

Register the new memslot with UV during plug and unregister
the memslot during unplug. In addition, release all the
device pages during unplug.

	Signed-off-by: Bharata B Rao <bharata@linux.ibm.com>
	Signed-off-by: Paul Mackerras <paulus@ozlabs.org>
(cherry picked from commit c32622575dd0ecb6fd0b41e3a451bd58152971ba)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/powerpc/include/asm/kvm_book3s_uvmem.h
#	arch/powerpc/include/asm/ultravisor-api.h
#	arch/powerpc/include/asm/ultravisor.h
#	arch/powerpc/kvm/book3s_64_mmu_radix.c
#	arch/powerpc/kvm/book3s_hv.c
#	arch/powerpc/kvm/book3s_hv_uvmem.c
diff --cc arch/powerpc/kvm/book3s_64_mmu_radix.c
index 739cefd2ed03,da857c8ba6e4..000000000000
--- a/arch/powerpc/kvm/book3s_64_mmu_radix.c
+++ b/arch/powerpc/kvm/book3s_64_mmu_radix.c
@@@ -1091,6 -1101,12 +1091,15 @@@ void kvmppc_radix_flush_memslot(struct 
  	unsigned long gpa;
  	unsigned int shift;
  
++<<<<<<< HEAD
++=======
+ 	if (kvm->arch.secure_guest & KVMPPC_SECURE_INIT_START)
+ 		kvmppc_uvmem_drop_pages(memslot, kvm);
+ 
+ 	if (kvm->arch.secure_guest & KVMPPC_SECURE_INIT_DONE)
+ 		return;
+ 
++>>>>>>> c32622575dd0 (KVM: PPC: Book3S HV: Handle memory plug/unplug to secure VM)
  	gpa = memslot->base_gfn << PAGE_SHIFT;
  	spin_lock(&kvm->mmu_lock);
  	for (n = memslot->npages; n; --n) {
diff --cc arch/powerpc/kvm/book3s_hv.c
index 46a62698fcb1,a8e815648b0a..000000000000
--- a/arch/powerpc/kvm/book3s_hv.c
+++ b/arch/powerpc/kvm/book3s_hv.c
@@@ -75,6 -71,10 +75,13 @@@
  #include <asm/opal.h>
  #include <asm/xics.h>
  #include <asm/xive.h>
++<<<<<<< HEAD
++=======
+ #include <asm/hw_breakpoint.h>
+ #include <asm/kvm_host.h>
+ #include <asm/kvm_book3s_uvmem.h>
+ #include <asm/ultravisor.h>
++>>>>>>> c32622575dd0 (KVM: PPC: Book3S HV: Handle memory plug/unplug to secure VM)
  
  #include "book3s.h"
  
* Unmerged path arch/powerpc/include/asm/kvm_book3s_uvmem.h
* Unmerged path arch/powerpc/include/asm/ultravisor-api.h
* Unmerged path arch/powerpc/include/asm/ultravisor.h
* Unmerged path arch/powerpc/kvm/book3s_hv_uvmem.c
* Unmerged path arch/powerpc/include/asm/kvm_book3s_uvmem.h
* Unmerged path arch/powerpc/include/asm/ultravisor-api.h
* Unmerged path arch/powerpc/include/asm/ultravisor.h
* Unmerged path arch/powerpc/kvm/book3s_64_mmu_radix.c
* Unmerged path arch/powerpc/kvm/book3s_hv.c
* Unmerged path arch/powerpc/kvm/book3s_hv_uvmem.c
