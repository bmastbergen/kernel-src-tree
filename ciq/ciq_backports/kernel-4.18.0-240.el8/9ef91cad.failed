ASoC: SOF: fix uninitialised "work" with VirtIO

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
Rebuild_CHGLOG: - [sound] ALSA: ASoC: SOF: fix uninitialised "work" with VirtIO (Jaroslav Kysela) [1797509]
Rebuild_FUZZ: 94.00%
commit-author Guennadi Liakhovetski <guennadi.liakhovetski@linux.intel.com>
commit 9ef91cad92ba75d17d5a5203230746c9d9009705
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/9ef91cad.failed

In the VirtIO case the sof_pcm_open() function isn't called on the
host during guest streaming, which then leaves "work" structures
uninitialised. However it is then used to handle position update
messages from the DSP. Move their initialisation to immediately after
allocation of the containing structure.

	Signed-off-by: Guennadi Liakhovetski <guennadi.liakhovetski@linux.intel.com>
	Signed-off-by: Pierre-Louis Bossart <pierre-louis.bossart@linux.intel.com>
	Reviewed-by: Kai Vehmanen <kai.vehmanen@linux.intel.com>
	Reviewed-by: Ranjani Sridharan <ranjani.sridharan@linux.intel.com>
Link: https://lore.kernel.org/r/20200325211233.27394-4-pierre-louis.bossart@linux.intel.com
	Signed-off-by: Mark Brown <broonie@kernel.org>
(cherry picked from commit 9ef91cad92ba75d17d5a5203230746c9d9009705)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	sound/soc/sof/sof-audio.h
#	sound/soc/sof/topology.c
diff --cc sound/soc/sof/topology.c
index 2d18c9e96d0f,fe8ba3e05e08..000000000000
--- a/sound/soc/sof/topology.c
+++ b/sound/soc/sof/topology.c
@@@ -2429,12 -2460,16 +2430,22 @@@ static int sof_dai_load(struct snd_soc_
  	if (!spcm)
  		return -ENOMEM;
  
++<<<<<<< HEAD
 +	spcm->sdev = sdev;
 +	spcm->stream[SNDRV_PCM_STREAM_PLAYBACK].comp_id = COMP_ID_UNASSIGNED;
 +	spcm->stream[SNDRV_PCM_STREAM_CAPTURE].comp_id = COMP_ID_UNASSIGNED;
++=======
+ 	spcm->scomp = scomp;
+ 
+ 	for_each_pcm_streams(stream) {
+ 		spcm->stream[stream].comp_id = COMP_ID_UNASSIGNED;
+ 		INIT_WORK(&spcm->stream[stream].period_elapsed_work,
+ 			  snd_sof_pcm_period_elapsed_work);
+ 	}
++>>>>>>> 9ef91cad92ba (ASoC: SOF: fix uninitialised "work" with VirtIO)
  
  	spcm->pcm = *pcm;
 -	dev_dbg(scomp->dev, "tplg: load pcm %s\n", pcm->dai_name);
 +	dev_dbg(sdev->dev, "tplg: load pcm %s\n", pcm->dai_name);
  
  	dai_drv->dobj.private = spcm;
  	list_add(&spcm->list, &sdev->pcm_list);
* Unmerged path sound/soc/sof/sof-audio.h
diff --git a/sound/soc/sof/pcm.c b/sound/soc/sof/pcm.c
index af195e499df8..471a0a040b56 100644
--- a/sound/soc/sof/pcm.c
+++ b/sound/soc/sof/pcm.c
@@ -54,7 +54,7 @@ static int sof_pcm_dsp_params(struct snd_sof_pcm *spcm, struct snd_pcm_substream
 /*
  * sof pcm period elapse work
  */
-static void sof_pcm_period_elapsed_work(struct work_struct *work)
+void snd_sof_pcm_period_elapsed_work(struct work_struct *work)
 {
 	struct snd_sof_pcm_stream *sps =
 		container_of(work, struct snd_sof_pcm_stream,
@@ -476,8 +476,6 @@ static int sof_pcm_open(struct snd_soc_component *component,
 	dev_dbg(sdev->dev, "pcm: open stream %d dir %d\n", spcm->pcm.pcm_id,
 		substream->stream);
 
-	INIT_WORK(&spcm->stream[substream->stream].period_elapsed_work,
-		  sof_pcm_period_elapsed_work);
 
 	caps = &spcm->pcm.caps[substream->stream];
 
* Unmerged path sound/soc/sof/sof-audio.h
* Unmerged path sound/soc/sof/topology.c
