net/mlx5: E-Switch, Hold mutex when querying drop counter in legacy mode

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Bodong Wang <bodong@mellanox.com>
commit 14c844cbf3503076de6e2e48d575216f1600b19f
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/14c844cb.failed

Consider scenario below, CPU 1 is at risk to query already destroyed
drop counters. Need to apply the same state mutex when disabling vport.

+-------------------------------+-------------------------------------+
| CPU 0                         | CPU 1                               |
+-------------------------------+-------------------------------------+
| mlx5_device_disable_sriov     | mlx5e_get_vf_stats                  |
| mlx5_eswitch_disable          | mlx5_eswitch_get_vport_stats        |
| esw_disable_vport             | mlx5_eswitch_query_vport_drop_stats |
| mlx5_fc_destroy(drop_counter) | mlx5_fc_query(drop_counter)         |
+-------------------------------+-------------------------------------+

Fixes: b8a0dbe3a90b ("net/mlx5e: E-switch, Add steering drop counters")
	Signed-off-by: Bodong Wang <bodong@mellanox.com>
	Reviewed-by: Parav Pandit <parav@mellanox.com>
	Signed-off-by: Saeed Mahameed <saeedm@mellanox.com>
(cherry picked from commit 14c844cbf3503076de6e2e48d575216f1600b19f)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlx5/core/eswitch.c
diff --cc drivers/net/ethernet/mellanox/mlx5/core/eswitch.c
index 1a31e7e828c2,b4b93d2322a9..000000000000
--- a/drivers/net/ethernet/mellanox/mlx5/core/eswitch.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/eswitch.c
@@@ -2490,15 -2620,19 +2490,24 @@@ static int mlx5_eswitch_query_vport_dro
  	u64 bytes = 0;
  	int err = 0;
  
- 	if (!vport->enabled || esw->mode != MLX5_ESWITCH_LEGACY)
+ 	if (esw->mode != MLX5_ESWITCH_LEGACY)
  		return 0;
  
++<<<<<<< HEAD
 +	if (vport->egress.drop_counter)
 +		mlx5_fc_query(dev, vport->egress.drop_counter,
++=======
+ 	mutex_lock(&esw->state_lock);
+ 	if (!vport->enabled)
+ 		goto unlock;
+ 
+ 	if (vport->egress.legacy.drop_counter)
+ 		mlx5_fc_query(dev, vport->egress.legacy.drop_counter,
++>>>>>>> 14c844cbf350 (net/mlx5: E-Switch, Hold mutex when querying drop counter in legacy mode)
  			      &stats->rx_dropped, &bytes);
  
 -	if (vport->ingress.legacy.drop_counter)
 -		mlx5_fc_query(dev, vport->ingress.legacy.drop_counter,
 +	if (vport->ingress.drop_counter)
 +		mlx5_fc_query(dev, vport->ingress.drop_counter,
  			      &stats->tx_dropped, &bytes);
  
  	if (!MLX5_CAP_GEN(dev, receive_discard_vport_down) &&
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/eswitch.c
