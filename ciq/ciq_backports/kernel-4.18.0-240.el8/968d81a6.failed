drm/connector: notify userspace on hotplug after register complete

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Jeykumar Sankaran <jsanka@codeaurora.org>
commit 968d81a64a883af2d16dd3f8a6ad6b67db2fde58
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/968d81a6.failed

drm connector notifies userspace on hotplug event prematurely before
late_register and mode_object register completes. This leads to a race
between userspace and kernel on updating the IDR list. So, move the
notification to end of connector register.

	Signed-off-by: Jeykumar Sankaran <jsanka@codeaurora.org>
	Signed-off-by: Steve Cohen <cohens@codeaurora.org>
	Cc: stable@vger.kernel.org
	Signed-off-by: Daniel Vetter <daniel.vetter@ffwll.ch>
Link: https://patchwork.freedesktop.org/patch/msgid/1591155451-10393-1-git-send-email-jsanka@codeaurora.org
(cherry picked from commit 968d81a64a883af2d16dd3f8a6ad6b67db2fde58)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/gpu/drm/drm_sysfs.c
diff --cc drivers/gpu/drm/drm_sysfs.c
index ad10810bc972,f0336c804639..000000000000
--- a/drivers/gpu/drm/drm_sysfs.c
+++ b/drivers/gpu/drm/drm_sysfs.c
@@@ -291,9 -291,9 +291,15 @@@ int drm_sysfs_connector_add(struct drm_
  		return PTR_ERR(connector->kdev);
  	}
  
++<<<<<<< HEAD
 +	/* Let userspace know we have a new connector */
 +	drm_sysfs_hotplug_event(dev);
 +
++=======
+ 	if (connector->ddc)
+ 		return sysfs_create_link(&connector->kdev->kobj,
+ 				 &connector->ddc->dev.kobj, "ddc");
++>>>>>>> 968d81a64a88 (drm/connector: notify userspace on hotplug after register complete)
  	return 0;
  }
  
diff --git a/drivers/gpu/drm/drm_connector.c b/drivers/gpu/drm/drm_connector.c
index a7e4e9287cae..a3c563ea18b5 100644
--- a/drivers/gpu/drm/drm_connector.c
+++ b/drivers/gpu/drm/drm_connector.c
@@ -27,6 +27,7 @@
 #include <drm/drm_print.h>
 #include <drm/drm_drv.h>
 #include <drm/drm_file.h>
+#include <drm/drm_sysfs.h>
 
 #include <linux/uaccess.h>
 
@@ -476,6 +477,10 @@ int drm_connector_register(struct drm_connector *connector)
 	drm_mode_object_register(connector->dev, &connector->base);
 
 	connector->registration_state = DRM_CONNECTOR_REGISTERED;
+
+	/* Let userspace know we have a new connector */
+	drm_sysfs_hotplug_event(connector->dev);
+
 	goto unlock;
 
 err_debugfs:
* Unmerged path drivers/gpu/drm/drm_sysfs.c
