ASoC: topology: Prevent use-after-free in snd_soc_get_pcm_runtime()

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
Rebuild_CHGLOG: - [sound] ALSA: ASoC: topology: Prevent use-after-free in snd_soc_get_pcm_runtime() (Jaroslav Kysela) [1797509]
Rebuild_FUZZ: 95.71%
commit-author Dragos Tarcatu <dragos_tarcatu@mentor.com>
commit 72b46612d06b83851e2e4f7b538a0bbeb69c10de
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/72b46612.failed

remove_link() is currently calling snd_soc_remove_pcm_runtime() after
it has already freed the memory for the link name. But this is later
read from snd_soc_get_pcm_runtime() causing a KASAN use-after-free
warning. Reorder the cleanups to fix this issue.

	Reviewed-by: Ranjani Sridharan <ranjani.sridharan@linux.intel.com>
	Signed-off-by: Dragos Tarcatu <dragos_tarcatu@mentor.com>
	Signed-off-by: Pierre-Louis Bossart <pierre-louis.bossart@linux.intel.com>
	Acked-by: Kuninori Morimoto <kuninori.morimoto.gx@renesas.com>
Link: https://lore.kernel.org/r/20191218000518.5830-4-pierre-louis.bossart@linux.intel.com
	Signed-off-by: Mark Brown <broonie@kernel.org>
(cherry picked from commit 72b46612d06b83851e2e4f7b538a0bbeb69c10de)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	sound/soc/soc-topology.c
diff --cc sound/soc/soc-topology.c
index 98037bb4ee1f,2b3c74a0b126..000000000000
--- a/sound/soc/soc-topology.c
+++ b/sound/soc/soc-topology.c
@@@ -548,12 -548,14 +548,18 @@@ static void remove_link(struct snd_soc_
  	if (dobj->ops && dobj->ops->link_unload)
  		dobj->ops->link_unload(comp, dobj);
  
+ 	list_del(&dobj->list);
++<<<<<<< HEAD
++	snd_soc_remove_dai_link(comp->card, link);
++=======
+ 
+ 	snd_soc_remove_pcm_runtime(comp->card,
+ 			snd_soc_get_pcm_runtime(comp->card, link));
+ 
  	kfree(link->name);
  	kfree(link->stream_name);
  	kfree(link->cpus->dai_name);
- 
- 	list_del(&dobj->list);
- 	snd_soc_remove_dai_link(comp->card, link);
++>>>>>>> 72b46612d06b (ASoC: topology: Prevent use-after-free in snd_soc_get_pcm_runtime())
  	kfree(link);
  }
  
* Unmerged path sound/soc/soc-topology.c
