mptcp: fix NULL ptr dereference in MP_JOIN error path

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Paolo Abeni <pabeni@redhat.com>
commit 39884604b11692158ce0c559fc603510b96f8c2e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/39884604.failed

When token lookup on MP_JOIN 3rd ack fails, the server
socket closes with a reset the incoming child. Such socket
has the 'is_mptcp' flag set, but no msk socket associated
- due to the failed lookup.

While crafting the reset packet mptcp_established_options_mp()
will try to dereference the child's master socket, causing
a NULL ptr dereference.

This change addresses the issue with explicit fallback to
TCP in such error path.

Fixes: 729cd6436f35 ("mptcp: cope better with MP_JOIN failure")
	Signed-off-by: Paolo Abeni <pabeni@redhat.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 39884604b11692158ce0c559fc603510b96f8c2e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/mptcp/subflow.c
diff --cc net/mptcp/subflow.c
index c928ab97b1e2,493b98a0825c..000000000000
--- a/net/mptcp/subflow.c
+++ b/net/mptcp/subflow.c
@@@ -436,12 -497,9 +450,9 @@@ create_child
  		 */
  		if (!ctx || fallback) {
  			if (fallback_is_fatal)
 -				goto dispose_child;
 +				goto close_child;
  
- 			if (ctx) {
- 				subflow_ulp_fallback(child, ctx);
- 				kfree_rcu(ctx, rcu);
- 			}
+ 			subflow_drop_ctx(child);
  			goto out;
  		}
  
@@@ -486,11 -547,15 +497,17 @@@ out
  		      !mptcp_subflow_ctx(child)->conn));
  	return child;
  
++<<<<<<< HEAD
 +close_child:
++=======
+ dispose_child:
+ 	subflow_drop_ctx(child);
+ 	tcp_rsk(req)->drop_req = true;
++>>>>>>> 39884604b116 (mptcp: fix NULL ptr dereference in MP_JOIN error path)
  	tcp_send_active_reset(child, GFP_ATOMIC);
 -	inet_csk_prepare_for_destroy_sock(child);
 +	inet_csk_prepare_forced_close(child);
  	tcp_done(child);
 -
 -	/* The last child reference will be released by the caller */
 -	return child;
 +	return NULL;
  }
  
  static struct inet_connection_sock_af_ops subflow_specific;
* Unmerged path net/mptcp/subflow.c
