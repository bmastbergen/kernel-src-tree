net/mlx5e: CT: Allow header rewrite of 5-tuple and ct clear action

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Paul Blakey <paulb@mellanox.com>
commit a7c119bd82a1d937db5b86fcfe1d5f991469c52d
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/a7c119bd.failed

With ct clear we don't jump to the ct tables, so header rewrite
of 5-tuple can be done in place (and not moved to after the CT action).

Check for ct clear action, and if so, allow 5-tuple header
rewrite.

	Signed-off-by: Paul Blakey <paulb@mellanox.com>
	Reviewed-by: Oz Shlomo <ozsh@mellanox.com>
	Signed-off-by: Saeed Mahameed <saeedm@mellanox.com>
(cherry picked from commit a7c119bd82a1d937db5b86fcfe1d5f991469c52d)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlx5/core/en_tc.c
diff --cc drivers/net/ethernet/mellanox/mlx5/core/en_tc.c
index d358fdb49b84,5674dbb682de..000000000000
--- a/drivers/net/ethernet/mellanox/mlx5/core/en_tc.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/en_tc.c
@@@ -2663,27 -3191,24 +2663,47 @@@ static bool actions_match_supported(str
  				    struct mlx5e_tc_flow *flow,
  				    struct netlink_ext_ack *extack)
  {
++<<<<<<< HEAD
 +	struct net_device *filter_dev = parse_attr->filter_dev;
 +	bool drop_action, decap_action, pop_action;
 +	u32 actions;
 +
 +	if (mlx5e_is_eswitch_flow(flow))
 +		actions = flow->esw_attr->action;
 +	else
++=======
+ 	bool ct_flow = false, ct_clear = false;
+ 	u32 actions;
+ 
+ 	if (mlx5e_is_eswitch_flow(flow)) {
+ 		actions = flow->esw_attr->action;
+ 		ct_clear = flow->esw_attr->ct_attr.ct_action &
+ 			   TCA_CT_ACT_CLEAR;
+ 		ct_flow = flow_flag_test(flow, CT) && !ct_clear;
+ 		if (flow->esw_attr->split_count && ct_flow) {
+ 			/* All registers used by ct are cleared when using
+ 			 * split rules.
+ 			 */
+ 			NL_SET_ERR_MSG_MOD(extack,
+ 					   "Can't offload mirroring with action ct");
+ 			return false;
+ 		}
+ 	} else {
++>>>>>>> a7c119bd82a1 (net/mlx5e: CT: Allow header rewrite of 5-tuple and ct clear action)
  		actions = flow->nic_attr->action;
 +
 +	drop_action = actions & MLX5_FLOW_CONTEXT_ACTION_DROP;
 +	decap_action = actions & MLX5_FLOW_CONTEXT_ACTION_DECAP;
 +	pop_action = actions & MLX5_FLOW_CONTEXT_ACTION_VLAN_POP;
 +
 +	if (flow_flag_test(flow, EGRESS) && !drop_action) {
 +		/* If no drop, we must decap (vxlan) or pop (vlan) */
 +		if (mlx5e_get_tc_tun(filter_dev) && !decap_action)
 +			return false;
 +		else if (is_vlan_dev(filter_dev) && !pop_action)
 +			return false;
 +		else
 +			return false; /* Sanity */
  	}
  
  	if (actions & MLX5_FLOW_CONTEXT_ACTION_MOD_HDR)
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/en_tc.c
