KVM: x86/mmu: Use KVM_REQ_TLB_FLUSH_CURRENT for MMU specific flushes

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Sean Christopherson <sean.j.christopherson@intel.com>
commit 8c8560b833909cbf2e3a73d4dc8e65a60ba66f07
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/8c8560b8.failed

Flush only the current ASID/context when requesting a TLB flush due to a
change in the current vCPU's MMU to avoid blasting away TLB entries
associated with other ASIDs/contexts, e.g. entries cached for L1 when
a change in L2's MMU requires a flush.

	Signed-off-by: Sean Christopherson <sean.j.christopherson@intel.com>
Message-Id: <20200320212833.3507-26-sean.j.christopherson@intel.com>
	Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
(cherry picked from commit 8c8560b833909cbf2e3a73d4dc8e65a60ba66f07)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kvm/mmu/mmu.c
diff --cc arch/x86/kvm/mmu/mmu.c
index dbd97923dc2c,575bd5de2118..000000000000
--- a/arch/x86/kvm/mmu/mmu.c
+++ b/arch/x86/kvm/mmu/mmu.c
@@@ -4369,10 -4307,10 +4369,10 @@@ static bool fast_cr3_switch(struct kvm_
  			 * accompanied by KVM_REQ_MMU_RELOAD, which will free
  			 * the root set here and allocate a new one.
  			 */
 -			kvm_make_request(KVM_REQ_LOAD_MMU_PGD, vcpu);
 +			kvm_make_request(KVM_REQ_LOAD_CR3, vcpu);
  			if (!skip_tlb_flush) {
  				kvm_make_request(KVM_REQ_MMU_SYNC, vcpu);
- 				kvm_make_request(KVM_REQ_TLB_FLUSH, vcpu);
+ 				kvm_make_request(KVM_REQ_TLB_FLUSH_CURRENT, vcpu);
  			}
  
  			/*
@@@ -5235,8 -5178,8 +5235,13 @@@ int kvm_mmu_load(struct kvm_vcpu *vcpu
  	kvm_mmu_sync_roots(vcpu);
  	if (r)
  		goto out;
++<<<<<<< HEAD
 +	kvm_mmu_load_cr3(vcpu);
 +	kvm_x86_ops->tlb_flush(vcpu, true);
++=======
+ 	kvm_mmu_load_pgd(vcpu);
+ 	kvm_x86_ops.tlb_flush_current(vcpu);
++>>>>>>> 8c8560b83390 (KVM: x86/mmu: Use KVM_REQ_TLB_FLUSH_CURRENT for MMU specific flushes)
  out:
  	return r;
  }
* Unmerged path arch/x86/kvm/mmu/mmu.c
