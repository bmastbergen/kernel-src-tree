vhost: disable for OABI

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Michael S. Tsirkin <mst@redhat.com>
commit d085eb8ce727e581abf8145244eaa3339021be2f
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/d085eb8c.failed

vhost is currently broken on the some ARM configs.

The reason is that the ring element addresses are passed between
components with different alignments assumptions. Thus, if
guest selects a pointer and host then gets and dereferences
it, then alignment assumed by the host's compiler might be
greater than the actual alignment of the pointer.
compiler on the host from assuming pointer is aligned.

This actually triggers on ARM with -mabi=apcs-gnu - which is a
deprecated configuration. With this OABI, compiler assumes that
all structures are 4 byte aligned - which is stronger than
virtio guarantees for available and used rings, which are
merely 2 bytes. Thus a guest without -mabi=apcs-gnu running
on top of host with -mabi=apcs-gnu will be broken.

The correct fix is to force alignment of structures - however
that is an intrusive fix that's best deferred until the next release.

We didn't previously support such ancient systems at all - this surfaced
after vdpa support prompted removing dependency of vhost on
VIRTULIZATION. So for now, let's just add something along the lines of

	depends on !ARM || AEABI

to the virtio Kconfig declaration, and add a comment that it has to do
with struct member alignment.

Note: we can't make VHOST and VHOST_RING themselves have
a dependency since these are selected. Add a new symbol for that.

We should be able to drop this dependency down the road.

Fixes: 20c384f1ea1a0bc7 ("vhost: refine vhost and vringh kconfig")
	Suggested-by: Ard Biesheuvel <ardb@kernel.org>
	Suggested-by: Richard Earnshaw <Richard.Earnshaw@arm.com>
	Signed-off-by: Michael S. Tsirkin <mst@redhat.com>
(cherry picked from commit d085eb8ce727e581abf8145244eaa3339021be2f)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/vhost/Kconfig
#	drivers/virtio/vdpa/Kconfig
diff --cc drivers/vhost/Kconfig
index b580885243f7,c4f273793595..000000000000
--- a/drivers/vhost/Kconfig
+++ b/drivers/vhost/Kconfig
@@@ -1,6 -1,43 +1,46 @@@
++<<<<<<< HEAD
++=======
+ # SPDX-License-Identifier: GPL-2.0-only
+ config VHOST_IOTLB
+ 	tristate
+ 	help
+ 	  Generic IOTLB implementation for vhost and vringh.
+ 	  This option is selected by any driver which needs to support
+ 	  an IOMMU in software.
+ 
+ config VHOST_RING
+ 	tristate
+ 	select VHOST_IOTLB
+ 	help
+ 	  This option is selected by any driver which needs to access
+ 	  the host side of a virtio ring.
+ 
+ config VHOST_DPN
+ 	bool
+ 	depends on !ARM || AEABI
+ 	default y
+ 	help
+ 	  Anything selecting VHOST or VHOST_RING must depend on VHOST_DPN.
+ 	  This excludes the deprecated ARM ABI since that forces a 4 byte
+ 	  alignment on all structs - incompatible with virtio spec requirements.
+ 
+ config VHOST
+ 	tristate
+ 	select VHOST_IOTLB
+ 	help
+ 	  This option is selected by any driver which needs to access
+ 	  the core of vhost.
+ 
+ menuconfig VHOST_MENU
+ 	bool "VHOST drivers"
+ 	default y
+ 
+ if VHOST_MENU
+ 
++>>>>>>> d085eb8ce727 (vhost: disable for OABI)
  config VHOST_NET
  	tristate "Host kernel accelerator for virtio net"
- 	depends on NET && EVENTFD && (TUN || !TUN) && (TAP || !TAP)
+ 	depends on NET && EVENTFD && (TUN || !TUN) && (TAP || !TAP) && VHOST_DPN
  	select VHOST
  	---help---
  	  This kernel module can be loaded in host kernel to accelerate
@@@ -21,9 -58,9 +61,14 @@@ config VHOST_SCS
  
  config VHOST_VSOCK
  	tristate "vhost virtio-vsock driver"
++<<<<<<< HEAD
 +	depends on VSOCKETS && EVENTFD
++=======
+ 	depends on VSOCKETS && EVENTFD && VHOST_DPN
+ 	select VHOST
++>>>>>>> d085eb8ce727 (vhost: disable for OABI)
  	select VIRTIO_VSOCKETS_COMMON
 +	select VHOST
  	default n
  	---help---
  	This kernel module can be loaded in the host kernel to provide AF_VSOCK
@@@ -33,11 -70,17 +78,25 @@@
  	To compile this driver as a module, choose M here: the module will be called
  	vhost_vsock.
  
++<<<<<<< HEAD
 +config VHOST
 +	tristate
 +	---help---
 +	  This option is selected by any driver which needs to access
 +	  the core of vhost.
++=======
+ config VHOST_VDPA
+ 	tristate "Vhost driver for vDPA-based backend"
+ 	depends on EVENTFD && VHOST_DPN
+ 	select VHOST
+ 	depends on VDPA
+ 	help
+ 	  This kernel module can be loaded in host kernel to accelerate
+ 	  guest virtio devices with the vDPA-based backends.
+ 
+ 	  To compile this driver as a module, choose M here: the module
+ 	  will be called vhost_vdpa.
++>>>>>>> d085eb8ce727 (vhost: disable for OABI)
  
  config VHOST_CROSS_ENDIAN_LEGACY
  	bool "Cross-endian support for vhost"
diff --cc drivers/virtio/vdpa/Kconfig
index 42c32b789b97,e8140065c8a5..000000000000
--- a/drivers/virtio/vdpa/Kconfig
+++ b/drivers/virtio/vdpa/Kconfig
@@@ -14,8 -10,7 +14,12 @@@ if VDPA_MEN
  
  config VDPA_SIM
  	tristate "vDPA device simulator"
++<<<<<<< HEAD:drivers/virtio/vdpa/Kconfig
 +	depends on RUNTIME_TESTING_MENU && HAS_DMA
 +	select VDPA
++=======
+ 	depends on RUNTIME_TESTING_MENU && HAS_DMA && VHOST_DPN
++>>>>>>> d085eb8ce727 (vhost: disable for OABI):drivers/vdpa/Kconfig
  	select VHOST_RING
  	default n
  	help
diff --git a/drivers/misc/mic/Kconfig b/drivers/misc/mic/Kconfig
index 242dcee14689..47210765c3c9 100644
--- a/drivers/misc/mic/Kconfig
+++ b/drivers/misc/mic/Kconfig
@@ -131,7 +131,7 @@ comment "VOP Driver"
 
 config VOP
 	tristate "VOP Driver"
-	depends on VOP_BUS
+	depends on VOP_BUS && VHOST_DPN
 	select VHOST_RING
 	select VIRTIO
 	help
diff --git a/drivers/net/caif/Kconfig b/drivers/net/caif/Kconfig
index f81df91a9ce1..1b6c30aa11e8 100644
--- a/drivers/net/caif/Kconfig
+++ b/drivers/net/caif/Kconfig
@@ -43,7 +43,7 @@ config CAIF_HSI
 
 config CAIF_VIRTIO
 	tristate "CAIF virtio transport driver"
-	depends on CAIF && HAS_DMA
+	depends on CAIF && HAS_DMA && VHOST_DPN
 	select VHOST_RING
 	select VIRTIO
 	select GENERIC_ALLOCATOR
* Unmerged path drivers/vhost/Kconfig
* Unmerged path drivers/virtio/vdpa/Kconfig
