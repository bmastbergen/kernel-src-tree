libperf: Move 'page_size' global variable to libperf

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-240.el8
commit-author Jiri Olsa <jolsa@kernel.org>
commit 20f2be1d48ec293b5a935595bd0c2e2915ffa77c
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-240.el8/20f2be1d.failed

We need the 'page_size' variable in libperf, so move it there.

Add a libperf_init() as a global libperf init function to obtain this
value via sysconf() at tool start.

Committer notes:

Add internal/lib.h to tools/perf/ files using 'page_size', sometimes
replacing util.h with it if that was the only reason for having util.h
included.

	Signed-off-by: Jiri Olsa <jolsa@kernel.org>
	Cc: Alexander Shishkin <alexander.shishkin@linux.intel.com>
	Cc: Michael Petlan <mpetlan@redhat.com>
	Cc: Namhyung Kim <namhyung@kernel.org>
	Cc: Peter Zijlstra <a.p.zijlstra@chello.nl>
Link: http://lore.kernel.org/lkml/20190913132355.21634-33-jolsa@kernel.org
	Signed-off-by: Arnaldo Carvalho de Melo <acme@redhat.com>
(cherry picked from commit 20f2be1d48ec293b5a935595bd0c2e2915ffa77c)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/perf/arch/arm/util/cs-etm.c
#	tools/perf/arch/arm64/util/arm-spe.c
#	tools/perf/arch/s390/util/machine.c
#	tools/perf/arch/x86/tests/intel-cqm.c
#	tools/perf/arch/x86/tests/rdpmc.c
#	tools/perf/arch/x86/util/intel-bts.c
#	tools/perf/arch/x86/util/intel-pt.c
#	tools/perf/arch/x86/util/machine.c
#	tools/perf/lib/include/internal/lib.h
#	tools/perf/lib/lib.c
#	tools/perf/perf.c
#	tools/perf/tests/mmap-thread-lookup.c
#	tools/perf/tests/vmlinux-kallsyms.c
#	tools/perf/util/auxtrace.c
#	tools/perf/util/evlist.c
#	tools/perf/util/header.c
#	tools/perf/util/mmap.c
#	tools/perf/util/python.c
#	tools/perf/util/session.c
#	tools/perf/util/srccode.c
#	tools/perf/util/synthetic-events.c
#	tools/perf/util/trace-event-info.c
diff --cc tools/perf/arch/arm/util/cs-etm.c
index 4208974c24f8,2e4de211d881..000000000000
--- a/tools/perf/arch/arm/util/cs-etm.c
+++ b/tools/perf/arch/arm/util/cs-etm.c
@@@ -21,9 -23,10 +21,14 @@@
  #include "../../util/evlist.h"
  #include "../../util/evsel.h"
  #include "../../util/pmu.h"
 +#include "../../util/thread_map.h"
  #include "../../util/cs-etm.h"
++<<<<<<< HEAD
 +#include "../../util/util.h"
++=======
+ #include <internal/lib.h> // page_size
+ #include "../../util/session.h"
++>>>>>>> 20f2be1d48ec (libperf: Move 'page_size' global variable to libperf)
  
  #include <errno.h>
  #include <stdlib.h>
diff --cc tools/perf/arch/arm64/util/arm-spe.c
index 2c009aa74633,eba6541ec0f1..000000000000
--- a/tools/perf/arch/arm64/util/arm-spe.c
+++ b/tools/perf/arch/arm64/util/arm-spe.c
@@@ -15,7 -15,8 +15,11 @@@
  #include "../../util/evsel.h"
  #include "../../util/evlist.h"
  #include "../../util/session.h"
++<<<<<<< HEAD
 +#include "../../util/util.h"
++=======
+ #include <internal/lib.h> // page_size
++>>>>>>> 20f2be1d48ec (libperf: Move 'page_size' global variable to libperf)
  #include "../../util/pmu.h"
  #include "../../util/debug.h"
  #include "../../util/auxtrace.h"
diff --cc tools/perf/arch/s390/util/machine.c
index c8c86a0c9b79,724efb2d842d..000000000000
--- a/tools/perf/arch/s390/util/machine.c
+++ b/tools/perf/arch/s390/util/machine.c
@@@ -2,7 -2,7 +2,11 @@@
  #include <unistd.h>
  #include <stdio.h>
  #include <string.h>
++<<<<<<< HEAD
 +#include "util.h"
++=======
+ #include <internal/lib.h> // page_size
++>>>>>>> 20f2be1d48ec (libperf: Move 'page_size' global variable to libperf)
  #include "machine.h"
  #include "api/fs/fs.h"
  #include "debug.h"
diff --cc tools/perf/arch/x86/tests/intel-cqm.c
index 77e59b7364cf,3ec562a2aaba..000000000000
--- a/tools/perf/arch/x86/tests/intel-cqm.c
+++ b/tools/perf/arch/x86/tests/intel-cqm.c
@@@ -5,7 -5,7 +5,11 @@@
  #include "evlist.h"
  #include "evsel.h"
  #include "arch-tests.h"
++<<<<<<< HEAD
 +#include "util.h"
++=======
+ #include <internal/lib.h> // page_size
++>>>>>>> 20f2be1d48ec (libperf: Move 'page_size' global variable to libperf)
  
  #include <signal.h>
  #include <sys/mman.h>
diff --cc tools/perf/arch/x86/tests/rdpmc.c
index 7a11f02d6c6c,1ea916656a2d..000000000000
--- a/tools/perf/arch/x86/tests/rdpmc.c
+++ b/tools/perf/arch/x86/tests/rdpmc.c
@@@ -11,7 -12,8 +11,12 @@@
  #include "debug.h"
  #include "tests/tests.h"
  #include "cloexec.h"
++<<<<<<< HEAD
 +#include "util.h"
++=======
+ #include "event.h"
+ #include <internal/lib.h> // page_size
++>>>>>>> 20f2be1d48ec (libperf: Move 'page_size' global variable to libperf)
  #include "arch-tests.h"
  
  static u64 rdpmc(unsigned int counter)
diff --cc tools/perf/arch/x86/util/intel-bts.c
index 4cbd3d775c19,f7f68a50a5cd..000000000000
--- a/tools/perf/arch/x86/util/intel-bts.c
+++ b/tools/perf/arch/x86/util/intel-bts.c
@@@ -29,6 -22,8 +29,10 @@@
  #include "../../util/tsc.h"
  #include "../../util/auxtrace.h"
  #include "../../util/intel-bts.h"
++<<<<<<< HEAD
++=======
+ #include <internal/lib.h> // page_size
++>>>>>>> 20f2be1d48ec (libperf: Move 'page_size' global variable to libperf)
  
  #define KiB(x) ((x) * 1024)
  #define MiB(x) ((x) * 1024 * 1024)
diff --cc tools/perf/arch/x86/util/intel-pt.c
index 3a851647e6f4,d6d26256915f..000000000000
--- a/tools/perf/arch/x86/util/intel-pt.c
+++ b/tools/perf/arch/x86/util/intel-pt.c
@@@ -33,7 -24,10 +33,11 @@@
  #include "../../util/pmu.h"
  #include "../../util/debug.h"
  #include "../../util/auxtrace.h"
 -#include "../../util/record.h"
 -#include "../../util/target.h"
  #include "../../util/tsc.h"
++<<<<<<< HEAD
++=======
+ #include <internal/lib.h> // page_size
++>>>>>>> 20f2be1d48ec (libperf: Move 'page_size' global variable to libperf)
  #include "../../util/intel-pt.h"
  
  #define KiB(x) ((x) * 1024)
diff --cc tools/perf/arch/x86/util/machine.c
index 1e9ec783b9a1,e17e080e76f4..000000000000
--- a/tools/perf/arch/x86/util/machine.c
+++ b/tools/perf/arch/x86/util/machine.c
@@@ -1,9 -1,10 +1,13 @@@
  // SPDX-License-Identifier: GPL-2.0
  #include <linux/types.h>
  #include <linux/string.h>
 -#include <limits.h>
  #include <stdlib.h>
  
++<<<<<<< HEAD
 +#include "../../util/util.h"
++=======
+ #include <internal/lib.h> // page_size
++>>>>>>> 20f2be1d48ec (libperf: Move 'page_size' global variable to libperf)
  #include "../../util/machine.h"
  #include "../../util/map.h"
  #include "../../util/symbol.h"
diff --cc tools/perf/perf.c
index 34763a9b873d,c012ceb64ff9..000000000000
--- a/tools/perf/perf.c
+++ b/tools/perf/perf.c
@@@ -8,8 -7,12 +8,9 @@@
   * perf top, perf record, perf report, etc.) are started.
   */
  #include "builtin.h"
 -#include "perf.h"
  
 -#include "util/build-id.h"
 -#include "util/cache.h"
  #include "util/env.h"
+ #include <internal/lib.h> // page_size
  #include <subcmd/exec-cmd.h>
  #include "util/config.h"
  #include <subcmd/run-command.h>
@@@ -18,9 -21,12 +19,16 @@@
  #include "util/bpf-loader.h"
  #include "util/debug.h"
  #include "util/event.h"
++<<<<<<< HEAD
 +#include "util/util.h"
++=======
+ #include "util/util.h" // usage()
+ #include "ui/ui.h"
+ #include "perf-sys.h"
++>>>>>>> 20f2be1d48ec (libperf: Move 'page_size' global variable to libperf)
  #include <api/fs/fs.h>
  #include <api/fs/tracing_path.h>
+ #include <perf/core.h>
  #include <errno.h>
  #include <pthread.h>
  #include <signal.h>
diff --cc tools/perf/tests/mmap-thread-lookup.c
index 0a4301a5155c,8d9d4cbff76d..000000000000
--- a/tools/perf/tests/mmap-thread-lookup.c
+++ b/tools/perf/tests/mmap-thread-lookup.c
@@@ -13,8 -14,9 +13,12 @@@
  #include "thread_map.h"
  #include "map.h"
  #include "symbol.h"
 -#include "util/synthetic-events.h"
  #include "thread.h"
++<<<<<<< HEAD
 +#include "util.h"
++=======
+ #include <internal/lib.h> // page_size
++>>>>>>> 20f2be1d48ec (libperf: Move 'page_size' global variable to libperf)
  
  #define THREADS 4
  
diff --cc tools/perf/tests/vmlinux-kallsyms.c
index 5e8834fc7dec,aa296ffea6d1..000000000000
--- a/tools/perf/tests/vmlinux-kallsyms.c
+++ b/tools/perf/tests/vmlinux-kallsyms.c
@@@ -4,9 -4,10 +4,13 @@@
  #include <inttypes.h>
  #include <string.h>
  #include <stdlib.h>
 -#include "dso.h"
  #include "map.h"
  #include "symbol.h"
++<<<<<<< HEAD
 +#include "util.h"
++=======
+ #include <internal/lib.h> // page_size
++>>>>>>> 20f2be1d48ec (libperf: Move 'page_size' global variable to libperf)
  #include "tests.h"
  #include "debug.h"
  #include "machine.h"
diff --cc tools/perf/util/auxtrace.c
index 2e60b09cfd97,8470dfe9fe97..000000000000
--- a/tools/perf/util/auxtrace.c
+++ b/tools/perf/util/auxtrace.c
@@@ -59,9 -50,12 +59,13 @@@
  #include "intel-bts.h"
  #include "arm-spe.h"
  #include "s390-cpumsf.h"
++<<<<<<< HEAD
++=======
+ #include "util/mmap.h"
++>>>>>>> 20f2be1d48ec (libperf: Move 'page_size' global variable to libperf)
  
  #include <linux/ctype.h>
 -#include <linux/kernel.h>
  #include "symbol/kallsyms.h"
 -#include <internal/lib.h>
  
  static bool auxtrace__dont_decode(struct perf_session *session)
  {
diff --cc tools/perf/util/evlist.c
index 29a998d183ce,6069fb52661f..000000000000
--- a/tools/perf/util/evlist.c
+++ b/tools/perf/util/evlist.c
@@@ -17,6 -17,8 +17,11 @@@
  #include "evsel.h"
  #include "debug.h"
  #include "units.h"
++<<<<<<< HEAD
++=======
+ #include <internal/lib.h> // page_size
+ #include "../perf.h"
++>>>>>>> 20f2be1d48ec (libperf: Move 'page_size' global variable to libperf)
  #include "asm/bug.h"
  #include "bpf-event.h"
  #include <signal.h>
diff --cc tools/perf/util/header.c
index 13489971ed57,3b24b4974c5f..000000000000
--- a/tools/perf/util/header.c
+++ b/tools/perf/util/header.c
@@@ -40,6 -42,7 +40,10 @@@
  #include "tool.h"
  #include "time-utils.h"
  #include "units.h"
++<<<<<<< HEAD
++=======
+ #include "util/util.h" // perf_exe()
++>>>>>>> 20f2be1d48ec (libperf: Move 'page_size' global variable to libperf)
  #include "cputopo.h"
  #include "bpf-event.h"
  
diff --cc tools/perf/util/mmap.c
index 850493205040,12671d089748..000000000000
--- a/tools/perf/util/mmap.c
+++ b/tools/perf/util/mmap.c
@@@ -17,11 -18,13 +17,16 @@@
  #include "debug.h"
  #include "event.h"
  #include "mmap.h"
++<<<<<<< HEAD
 +#include "util.h" /* page_size */
++=======
+ #include "../perf.h"
+ #include <internal/lib.h> /* page_size */
++>>>>>>> 20f2be1d48ec (libperf: Move 'page_size' global variable to libperf)
  
 -size_t perf_mmap__mmap_len(struct mmap *map)
 +size_t perf_mmap__mmap_len(struct perf_mmap *map)
  {
 -	return map->core.mask + 1 + page_size;
 +	return map->mask + 1 + page_size;
  }
  
  /* When check_messup is true, 'end' must points to a good entry */
diff --cc tools/perf/util/python.c
index 9c3b43665909,6c46d7dbd263..000000000000
--- a/tools/perf/util/python.c
+++ b/tools/perf/util/python.c
@@@ -8,11 -10,12 +8,16 @@@
  #include "callchain.h"
  #include "evsel.h"
  #include "event.h"
 +#include "cpumap.h"
  #include "print_binary.h"
  #include "thread_map.h"
 -#include "trace-event.h"
  #include "mmap.h"
++<<<<<<< HEAD
 +#include "util.h"
++=======
+ #include <internal/lib.h>
+ #include "../perf-sys.h"
++>>>>>>> 20f2be1d48ec (libperf: Move 'page_size' global variable to libperf)
  
  #if PY_MAJOR_VERSION < 3
  #define _PyUnicode_FromString(arg) \
diff --cc tools/perf/util/session.c
index 82adeb8dfbcf,061bb4d6a3f5..000000000000
--- a/tools/perf/util/session.c
+++ b/tools/perf/util/session.c
@@@ -27,7 -29,10 +27,12 @@@
  #include "thread-stack.h"
  #include "sample-raw.h"
  #include "stat.h"
++<<<<<<< HEAD
++=======
+ #include "ui/progress.h"
+ #include "../perf.h"
++>>>>>>> 20f2be1d48ec (libperf: Move 'page_size' global variable to libperf)
  #include "arch/common.h"
 -#include <internal/lib.h>
  #include <linux/err.h>
  
  #ifdef HAVE_ZSTD_SUPPORT
diff --cc tools/perf/util/srccode.c
index f733e609da28,d84ed8b6caaa..000000000000
--- a/tools/perf/util/srccode.c
+++ b/tools/perf/util/srccode.c
@@@ -23,7 -15,7 +23,11 @@@
  #include <string.h>
  #include "srccode.h"
  #include "debug.h"
++<<<<<<< HEAD
 +#include "util.h"
++=======
+ #include <internal/lib.h> // page_size
++>>>>>>> 20f2be1d48ec (libperf: Move 'page_size' global variable to libperf)
  
  #define MAXSRCCACHE (32*1024*1024)
  #define MAXSRCFILES     64
diff --cc tools/perf/util/trace-event-info.c
index 20bc1e972293,086e98ff42a3..000000000000
--- a/tools/perf/util/trace-event-info.c
+++ b/tools/perf/util/trace-event-info.c
@@@ -1,24 -1,7 +1,27 @@@
 -// SPDX-License-Identifier: GPL-2.0-only
  /*
   * Copyright (C) 2008,2009, Steven Rostedt <srostedt@redhat.com>
 + *
 + * ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
 + *
 + * This program is free software; you can redistribute it and/or modify
 + * it under the terms of the GNU General Public License as published by
 + * the Free Software Foundation; version 2 of the License (not later!)
 + *
 + * This program is distributed in the hope that it will be useful,
 + * but WITHOUT ANY WARRANTY; without even the implied warranty of
 + * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 + * GNU General Public License for more details.
 + *
 + * You should have received a copy of the GNU General Public License
 + * along with this program; if not, write to the Free Software
 + * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
 + *
 + * ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
   */
++<<<<<<< HEAD
 +#include "util.h"
++=======
++>>>>>>> 20f2be1d48ec (libperf: Move 'page_size' global variable to libperf)
  #include <dirent.h>
  #include <mntent.h>
  #include <stdio.h>
* Unmerged path tools/perf/lib/include/internal/lib.h
* Unmerged path tools/perf/lib/lib.c
* Unmerged path tools/perf/util/synthetic-events.c
* Unmerged path tools/perf/arch/arm/util/cs-etm.c
* Unmerged path tools/perf/arch/arm64/util/arm-spe.c
* Unmerged path tools/perf/arch/s390/util/machine.c
* Unmerged path tools/perf/arch/x86/tests/intel-cqm.c
* Unmerged path tools/perf/arch/x86/tests/rdpmc.c
* Unmerged path tools/perf/arch/x86/util/intel-bts.c
* Unmerged path tools/perf/arch/x86/util/intel-pt.c
* Unmerged path tools/perf/arch/x86/util/machine.c
diff --git a/tools/perf/lib/core.c b/tools/perf/lib/core.c
index 29d5e3348718..6689d593c2d1 100644
--- a/tools/perf/lib/core.c
+++ b/tools/perf/lib/core.c
@@ -4,7 +4,9 @@
 
 #include <stdio.h>
 #include <stdarg.h>
+#include <unistd.h>
 #include <perf/core.h>
+#include <internal/lib.h>
 #include "internal.h"
 
 static int __base_pr(enum libperf_print_level level, const char *format,
@@ -32,3 +34,8 @@ void libperf_print(enum libperf_print_level level, const char *format, ...)
 	__libperf_pr(level, format, args);
 	va_end(args);
 }
+
+void libperf_init(void)
+{
+	page_size = sysconf(_SC_PAGE_SIZE);
+}
* Unmerged path tools/perf/lib/include/internal/lib.h
diff --git a/tools/perf/lib/include/perf/core.h b/tools/perf/lib/include/perf/core.h
index c341a7b2c874..ba2f4e76a3e2 100644
--- a/tools/perf/lib/include/perf/core.h
+++ b/tools/perf/lib/include/perf/core.h
@@ -18,5 +18,6 @@ typedef int (*libperf_print_fn_t)(enum libperf_print_level level,
 				  const char *, va_list ap);
 
 LIBPERF_API void libperf_set_print(libperf_print_fn_t fn);
+LIBPERF_API void libperf_init(void);
 
 #endif /* __LIBPERF_CORE_H */
* Unmerged path tools/perf/lib/lib.c
diff --git a/tools/perf/lib/libperf.map b/tools/perf/lib/libperf.map
index 3536242c545c..90fb16716e33 100644
--- a/tools/perf/lib/libperf.map
+++ b/tools/perf/lib/libperf.map
@@ -1,5 +1,6 @@
 LIBPERF_0.0.1 {
 	global:
+		libperf_init;
 		libperf_set_print;
 	local:
 		*;
* Unmerged path tools/perf/perf.c
* Unmerged path tools/perf/tests/mmap-thread-lookup.c
* Unmerged path tools/perf/tests/vmlinux-kallsyms.c
* Unmerged path tools/perf/util/auxtrace.c
* Unmerged path tools/perf/util/evlist.c
* Unmerged path tools/perf/util/header.c
diff --git a/tools/perf/util/machine.c b/tools/perf/util/machine.c
index d0790082f28d..08b636f1e9c7 100644
--- a/tools/perf/util/machine.c
+++ b/tools/perf/util/machine.c
@@ -25,6 +25,7 @@
 #include "linux/hash.h"
 #include "asm/bug.h"
 #include "bpf-event.h"
+#include <internal/lib.h> // page_size
 
 #include <linux/ctype.h>
 #include <symbol/kallsyms.h>
* Unmerged path tools/perf/util/mmap.c
* Unmerged path tools/perf/util/python.c
* Unmerged path tools/perf/util/session.c
* Unmerged path tools/perf/util/srccode.c
* Unmerged path tools/perf/util/synthetic-events.c
* Unmerged path tools/perf/util/trace-event-info.c
diff --git a/tools/perf/util/util.c b/tools/perf/util/util.c
index b5fc44f33c1b..02abf0b1d36f 100644
--- a/tools/perf/util/util.c
+++ b/tools/perf/util/util.c
@@ -2,6 +2,7 @@
 #include "util.h"
 #include "debug.h"
 #include "namespaces.h"
+#include <internal/lib.h>
 #include <api/fs/fs.h>
 #include <sys/mman.h>
 #include <sys/stat.h>
@@ -40,8 +41,6 @@ void perf_set_multithreaded(void)
 	perf_singlethreaded = false;
 }
 
-unsigned int page_size;
-
 int sysctl_perf_event_max_stack = PERF_MAX_STACK_DEPTH;
 int sysctl_perf_event_max_contexts_per_stack = PERF_MAX_CONTEXTS_PER_STACK;
 
diff --git a/tools/perf/util/util.h b/tools/perf/util/util.h
index d0d96eb3a962..abe74b2755ea 100644
--- a/tools/perf/util/util.h
+++ b/tools/perf/util/util.h
@@ -35,8 +35,6 @@ ssize_t writen(int fd, const void *buf, size_t n);
 
 size_t hex_width(u64 v);
 
-extern unsigned int page_size;
-
 int sysctl__max_stack(void);
 
 int fetch_kernel_version(unsigned int *puint,
