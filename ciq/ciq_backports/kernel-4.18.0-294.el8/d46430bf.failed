block: remove the disk argument from blk_drop_partitions

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-294.el8
commit-author Christoph Hellwig <hch@lst.de>
commit d46430bf5a2298f55e20f59a90ebe3545d273b2f
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-294.el8/d46430bf.failed

The gendisk can be trivially deducted from the block_device.

	Signed-off-by: Christoph Hellwig <hch@lst.de>
	Reviewed-by: Johannes Thumshirn <johannes.thumshirn@wdc.com>
	Signed-off-by: Jens Axboe <axboe@kernel.dk>
(cherry picked from commit d46430bf5a2298f55e20f59a90ebe3545d273b2f)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	block/partition-generic.c
#	include/linux/genhd.h
diff --cc block/partition-generic.c
index 459e9684cfbb,deccc3fbcd37..000000000000
--- a/block/partition-generic.c
+++ b/block/partition-generic.c
@@@ -459,17 -609,17 +459,21 @@@ int blk_drop_partitions(struct block_de
  	struct hd_struct *part;
  	int res;
  
- 	if (!disk_part_scan_enabled(disk))
+ 	if (!disk_part_scan_enabled(bdev->bd_disk))
  		return 0;
 -	if (bdev->bd_part_count || bdev->bd_openers > 1)
 +	if (bdev->bd_part_count)
  		return -EBUSY;
- 	res = invalidate_partition(disk, 0);
+ 	res = invalidate_partition(bdev->bd_disk, 0);
  	if (res)
  		return res;
  
- 	disk_part_iter_init(&piter, disk, DISK_PITER_INCL_EMPTY);
+ 	disk_part_iter_init(&piter, bdev->bd_disk, DISK_PITER_INCL_EMPTY);
  	while ((part = disk_part_iter_next(&piter)))
++<<<<<<< HEAD:block/partition-generic.c
 +		delete_partition(disk, part->partno);
++=======
+ 		delete_partition(bdev->bd_disk, part);
++>>>>>>> d46430bf5a22 (block: remove the disk argument from blk_drop_partitions):block/partitions/core.c
  	disk_part_iter_exit(&piter);
  
  	return 0;
diff --cc include/linux/genhd.h
index 17a430524bd8,058d895544c7..000000000000
--- a/include/linux/genhd.h
+++ b/include/linux/genhd.h
@@@ -485,15 -339,7 +485,19 @@@ extern char *disk_name (struct gendisk 
  
  int bdev_disk_changed(struct block_device *bdev, bool invalidate);
  int blk_add_partitions(struct gendisk *disk, struct block_device *bdev);
++<<<<<<< HEAD
 +int blk_drop_partitions(struct gendisk *disk, struct block_device *bdev);
 +extern int disk_expand_part_tbl(struct gendisk *disk, int target);
 +extern struct hd_struct * __must_check add_partition(struct gendisk *disk,
 +						     int partno, sector_t start,
 +						     sector_t len, int flags,
 +						     struct partition_meta_info
 +						       *info);
 +extern void __delete_partition(struct percpu_ref *);
 +extern void delete_partition(struct gendisk *, int);
++=======
+ int blk_drop_partitions(struct block_device *bdev);
++>>>>>>> d46430bf5a22 (block: remove the disk argument from blk_drop_partitions)
  extern void printk_all_partitions(void);
  
  extern struct gendisk *__alloc_disk_node(int minors, int node_id);
* Unmerged path block/partition-generic.c
diff --git a/fs/block_dev.c b/fs/block_dev.c
index ff580a010566..77eaa46f56b4 100644
--- a/fs/block_dev.c
+++ b/fs/block_dev.c
@@ -1536,7 +1536,7 @@ int bdev_disk_changed(struct block_device *bdev, bool invalidate)
 	lockdep_assert_held(&bdev->bd_mutex);
 
 rescan:
-	ret = blk_drop_partitions(disk, bdev);
+	ret = blk_drop_partitions(bdev);
 	if (ret)
 		return ret;
 
* Unmerged path include/linux/genhd.h
