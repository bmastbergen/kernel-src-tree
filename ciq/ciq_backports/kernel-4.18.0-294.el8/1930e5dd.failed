kvm: x86: reads of restricted pv msrs should also result in #GP

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-294.el8
commit-author Oliver Upton <oupton@google.com>
commit 1930e5ddcead2c23567131e62c86b15efce054be
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-294.el8/1930e5dd.failed

commit 66570e966dd9 ("kvm: x86: only provide PV features if enabled in
guest's CPUID") only protects against disallowed guest writes to KVM
paravirtual msrs, leaving msr reads unchecked. Fix this by enforcing
KVM_CPUID_FEATURES for msr reads as well.

Fixes: 66570e966dd9 ("kvm: x86: only provide PV features if enabled in guest's CPUID")
	Signed-off-by: Oliver Upton <oupton@google.com>
	Reviewed-by: Peter Shier <pshier@google.com>
Message-Id: <20201027231044.655110-4-oupton@google.com>
	Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
(cherry picked from commit 1930e5ddcead2c23567131e62c86b15efce054be)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kvm/x86.c
diff --cc arch/x86/kvm/x86.c
index c2403e53a8de,d12820acc548..000000000000
--- a/arch/x86/kvm/x86.c
+++ b/arch/x86/kvm/x86.c
@@@ -3261,9 -3489,27 +3277,31 @@@ int kvm_get_msr_common(struct kvm_vcpu 
  		msr_info->data = vcpu->arch.time;
  		break;
  	case MSR_KVM_ASYNC_PF_EN:
++<<<<<<< HEAD
 +		msr_info->data = vcpu->arch.apf.msr_val;
++=======
+ 		if (!guest_pv_has(vcpu, KVM_FEATURE_ASYNC_PF))
+ 			return 1;
+ 
+ 		msr_info->data = vcpu->arch.apf.msr_en_val;
+ 		break;
+ 	case MSR_KVM_ASYNC_PF_INT:
+ 		if (!guest_pv_has(vcpu, KVM_FEATURE_ASYNC_PF_INT))
+ 			return 1;
+ 
+ 		msr_info->data = vcpu->arch.apf.msr_int_val;
+ 		break;
+ 	case MSR_KVM_ASYNC_PF_ACK:
+ 		if (!guest_pv_has(vcpu, KVM_FEATURE_ASYNC_PF))
+ 			return 1;
+ 
+ 		msr_info->data = 0;
++>>>>>>> 1930e5ddcead (kvm: x86: reads of restricted pv msrs should also result in #GP)
  		break;
  	case MSR_KVM_STEAL_TIME:
+ 		if (!guest_pv_has(vcpu, KVM_FEATURE_STEAL_TIME))
+ 			return 1;
+ 
  		msr_info->data = vcpu->arch.st.msr_val;
  		break;
  	case MSR_KVM_PV_EOI_EN:
* Unmerged path arch/x86/kvm/x86.c
