ethtool: add LINKMODES_NTF notification

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-294.el8
commit-author Michal Kubecek <mkubecek@suse.cz>
commit 1b1b1847c8505df2e1dd8804838526bed22a8bd4
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-294.el8/1b1b1847.failed

Send ETHTOOL_MSG_LINKMODES_NTF notification message whenever device link
settings or advertised modes are modified using ETHTOOL_MSG_LINKMODES_SET
netlink message or ETHTOOL_SLINKSETTINGS or ETHTOOL_SSET ioctl commands.

The notification message has the same format as reply to LINKMODES_GET
request. ETHTOOL_MSG_LINKMODES_SET netlink request only triggers the
notification if there is a change but the ioctl command handlers do not
check if there is an actual change and trigger the notification whenever
the commands are executed.

As all work is done by ethnl_default_notify() handler and callback
functions introduced to handle LINKMODES_GET requests, all that remains is
adding entries for ETHTOOL_MSG_LINKMODES_NTF into ethnl_notify_handlers and
ethnl_default_notify_ops lookup tables and calls to ethtool_notify() where
needed.

	Signed-off-by: Michal Kubecek <mkubecek@suse.cz>
	Reviewed-by: Florian Fainelli <f.fainelli@gmail.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 1b1b1847c8505df2e1dd8804838526bed22a8bd4)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	Documentation/networking/ethtool-netlink.rst
#	include/uapi/linux/ethtool_netlink.h
#	net/ethtool/ioctl.c
#	net/ethtool/linkmodes.c
#	net/ethtool/netlink.c
diff --cc net/ethtool/ioctl.c
index e6221e091f3d,36e2ef2d900d..000000000000
--- a/net/ethtool/ioctl.c
+++ b/net/ethtool/ioctl.c
@@@ -802,7 -572,12 +802,16 @@@ static int ethtool_set_link_ksettings(s
  	    != link_ksettings.base.link_mode_masks_nwords)
  		return -EINVAL;
  
++<<<<<<< HEAD
 +	return __rh_call_set_link_ksettings(dev, &link_ksettings);
++=======
+ 	err = dev->ethtool_ops->set_link_ksettings(dev, &link_ksettings);
+ 	if (err >= 0) {
+ 		ethtool_notify(dev, ETHTOOL_MSG_LINKINFO_NTF, NULL);
+ 		ethtool_notify(dev, ETHTOOL_MSG_LINKMODES_NTF, NULL);
+ 	}
+ 	return err;
++>>>>>>> 1b1b1847c850 (ethtool: add LINKMODES_NTF notification)
  }
  
  /* Query device for its ethtool_cmd settings.
@@@ -876,31 -632,19 +885,44 @@@ static int ethtool_set_settings(struct 
  
  	if (copy_from_user(&cmd, useraddr, sizeof(cmd)))
  		return -EFAULT;
 -	if (!dev->ethtool_ops->set_link_ksettings)
 +
 +	/* first, try new %ethtool_link_ksettings API. */
 +	if (__rh_has_set_link_ksettings(dev)) {
 +		struct ethtool_link_ksettings link_ksettings;
 +
 +		if (!convert_legacy_settings_to_link_ksettings(&link_ksettings,
 +							       &cmd))
 +			return -EINVAL;
 +
 +		link_ksettings.base.cmd = ETHTOOL_SLINKSETTINGS;
 +		link_ksettings.base.link_mode_masks_nwords
 +			= __ETHTOOL_LINK_MODE_MASK_NU32;
 +		return __rh_call_set_link_ksettings(dev, &link_ksettings);
 +	}
 +
 +	/* legacy %ethtool_cmd API */
 +
 +	/* TODO: return -EOPNOTSUPP when ethtool_ops::get_settings
 +	 * disappears internally
 +	 */
 +
 +	if (!dev->ethtool_ops->set_settings)
  		return -EOPNOTSUPP;
  
++<<<<<<< HEAD
 +	return dev->ethtool_ops->set_settings(dev, &cmd);
++=======
+ 	if (!convert_legacy_settings_to_link_ksettings(&link_ksettings, &cmd))
+ 		return -EINVAL;
+ 	link_ksettings.base.link_mode_masks_nwords =
+ 		__ETHTOOL_LINK_MODE_MASK_NU32;
+ 	ret = dev->ethtool_ops->set_link_ksettings(dev, &link_ksettings);
+ 	if (ret >= 0) {
+ 		ethtool_notify(dev, ETHTOOL_MSG_LINKINFO_NTF, NULL);
+ 		ethtool_notify(dev, ETHTOOL_MSG_LINKMODES_NTF, NULL);
+ 	}
+ 	return ret;
++>>>>>>> 1b1b1847c850 (ethtool: add LINKMODES_NTF notification)
  }
  
  static noinline_for_stack int ethtool_get_drvinfo(struct net_device *dev,
* Unmerged path Documentation/networking/ethtool-netlink.rst
* Unmerged path include/uapi/linux/ethtool_netlink.h
* Unmerged path net/ethtool/linkmodes.c
* Unmerged path net/ethtool/netlink.c
* Unmerged path Documentation/networking/ethtool-netlink.rst
* Unmerged path include/uapi/linux/ethtool_netlink.h
* Unmerged path net/ethtool/ioctl.c
* Unmerged path net/ethtool/linkmodes.c
* Unmerged path net/ethtool/netlink.c
