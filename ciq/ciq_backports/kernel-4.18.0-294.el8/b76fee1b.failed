s390/pci: ignore stale configuration request event

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-294.el8
commit-author Niklas Schnelle <schnelle@linux.ibm.com>
commit b76fee1bc56c31a9d2a49592810eba30cc06d61a
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-294.el8/b76fee1b.failed

A configuration request event may be stale, that is the event
may reference a zdev which was already configured.
This can happen when a hotplug happens during boot such that
the device is discovered and configured in the initial clp_list_pci(),
then after initialization we enable events and process
the original configuration request which additionally still contains
the old disabled function handle leading to a failure during device
enablement and subsequent I/O lockout.

Fix this by restoring the check that the device to be configured is in
standby which was removed in commit f606b3ef47c9 ("s390/pci: adapt events
for zbus").

This check does not need serialization as we only enable the events after
zPCI has fully initialized, which includes the initial clp_list_pci(),
rescan only does updates and events are serialized with respect to each
other.

Fixes: f606b3ef47c9 ("s390/pci: adapt events for zbus")
	Cc: <stable@vger.kernel.org> # 5.8
	Reported-by: Shalini Chellathurai Saroja <shalini@linux.ibm.com>
	Tested-by: Shalini Chellathurai Saroja <shalini@linux.ibm.com>
	Acked-by: Pierre Morel <pmorel@linux.ibm.com>
	Signed-off-by: Niklas Schnelle <schnelle@linux.ibm.com>
	Signed-off-by: Heiko Carstens <hca@linux.ibm.com>
(cherry picked from commit b76fee1bc56c31a9d2a49592810eba30cc06d61a)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/s390/pci/pci_event.c
diff --cc arch/s390/pci/pci_event.c
index 8d6ee4af4230,4602068c7548..000000000000
--- a/arch/s390/pci/pci_event.c
+++ b/arch/s390/pci/pci_event.c
@@@ -89,15 -89,14 +89,22 @@@ static void __zpci_event_availability(s
  	switch (ccdf->pec) {
  	case 0x0301: /* Reserved|Standby -> Configured */
  		if (!zdev) {
 -			ret = clp_add_pci_device(ccdf->fid, ccdf->fh, 1);
 -			break;
 +			ret = clp_add_pci_device(ccdf->fid, ccdf->fh, 0);
 +			if (ret)
 +				break;
 +			zdev = get_zdev_by_fid(ccdf->fid);
  		}
++<<<<<<< HEAD
 +		if (!zdev || zdev->state != ZPCI_FN_STATE_STANDBY)
 +			break;
++=======
+ 		/* the configuration request may be stale */
+ 		if (zdev->state != ZPCI_FN_STATE_STANDBY)
+ 			break;
+ 		zdev->fh = ccdf->fh;
++>>>>>>> b76fee1bc56c (s390/pci: ignore stale configuration request event)
  		zdev->state = ZPCI_FN_STATE_CONFIGURED;
 +		zdev->fh = ccdf->fh;
  		ret = zpci_enable_device(zdev);
  		if (ret)
  			break;
* Unmerged path arch/s390/pci/pci_event.c
