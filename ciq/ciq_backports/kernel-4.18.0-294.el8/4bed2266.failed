x86/idt: Split idt_data setup out of set_intr_gate()

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-294.el8
Rebuild_CHGLOG: - [x86] idt: Split idt_data setup out of set_intr_gate() (Vitaly Kuznetsov) [1868080]
Rebuild_FUZZ: 96.00%
commit-author Joerg Roedel <jroedel@suse.de>
commit 4bed2266cc6f9c3f6cd91378ea4fc76edde674cf
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-294.el8/4bed2266.failed

The code to setup idt_data is needed for early exception handling, but
set_intr_gate() can't be used that early because it has pv-ops in its
code path which don't work that early.

Split out the idt_data initialization part from set_intr_gate() so
that it can be used separately.

	Signed-off-by: Joerg Roedel <jroedel@suse.de>
	Signed-off-by: Borislav Petkov <bp@suse.de>
	Reviewed-by: Kees Cook <keescook@chromium.org>
Link: https://lkml.kernel.org/r/20200907131613.12703-29-joro@8bytes.org
(cherry picked from commit 4bed2266cc6f9c3f6cd91378ea4fc76edde674cf)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kernel/idt.c
diff --cc arch/x86/kernel/idt.c
index cdf4700ac5e2,53946c104fa0..000000000000
--- a/arch/x86/kernel/idt.c
+++ b/arch/x86/kernel/idt.c
@@@ -225,18 -205,24 +225,28 @@@ idt_setup_from_table(gate_desc *idt, co
  	}
  }
  
++<<<<<<< HEAD
 +static void set_intr_gate(unsigned int n, const void *addr)
++=======
+ static void init_idt_data(struct idt_data *data, unsigned int n,
+ 			  const void *addr)
  {
- 	struct idt_data data;
- 
  	BUG_ON(n > 0xFF);
  
- 	memset(&data, 0, sizeof(data));
- 	data.vector	= n;
- 	data.addr	= addr;
- 	data.segment	= __KERNEL_CS;
- 	data.bits.type	= GATE_INTERRUPT;
- 	data.bits.p	= 1;
+ 	memset(data, 0, sizeof(*data));
+ 	data->vector	= n;
+ 	data->addr	= addr;
+ 	data->segment	= __KERNEL_CS;
+ 	data->bits.type	= GATE_INTERRUPT;
+ 	data->bits.p	= 1;
+ }
+ 
+ static __init void set_intr_gate(unsigned int n, const void *addr)
++>>>>>>> 4bed2266cc6f (x86/idt: Split idt_data setup out of set_intr_gate())
+ {
+ 	struct idt_data data;
+ 
+ 	init_idt_data(&data, n, addr);
  
  	idt_setup_from_table(idt_table, &data, 1, false);
  }
* Unmerged path arch/x86/kernel/idt.c
