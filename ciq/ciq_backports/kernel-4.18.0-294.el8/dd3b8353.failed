mm/vmalloc: do not keep unpurged areas in the busy tree

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-294.el8
commit-author Uladzislau Rezki (Sony) <urezki@gmail.com>
commit dd3b8353bae79395b12a178de057b183ff0122eb
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-294.el8/dd3b8353.failed

The busy tree can be quite big, even though the area is freed or unmapped
it still stays there until "purge" logic removes it.

1) Optimize and reduce the size of "busy" tree by removing a node from
   it right away as soon as user triggers free paths.  It is possible to
   do so, because the allocation is done using another augmented tree.

The vmalloc test driver shows the difference, for example the
"fix_size_alloc_test" is ~11% better comparing with default configuration:

sudo ./test_vmalloc.sh performance

<default>
Summary: fix_size_alloc_test loops: 1000000 avg: 993985 usec
Summary: full_fit_alloc_test loops: 1000000 avg: 973554 usec
Summary: long_busy_list_alloc_test loops: 1000000 avg: 12617652 usec
<default>

<this patch>
Summary: fix_size_alloc_test loops: 1000000 avg: 882263 usec
Summary: full_fit_alloc_test loops: 1000000 avg: 973407 usec
Summary: long_busy_list_alloc_test loops: 1000000 avg: 12593929 usec
<this patch>

2) Since the busy tree now contains allocated areas only and does not
   interfere with lazily free nodes, introduce the new function
   show_purge_info() that dumps "unpurged" areas that is propagated
   through "/proc/vmallocinfo".

3) Eliminate VM_LAZY_FREE flag.

Link: http://lkml.kernel.org/r/20190716152656.12255-2-lpf.vector@gmail.com
	Signed-off-by: Uladzislau Rezki (Sony) <urezki@gmail.com>
	Signed-off-by: Pengfei Li <lpf.vector@gmail.com>
	Cc: Roman Gushchin <guro@fb.com>
	Cc: Uladzislau Rezki <urezki@gmail.com>
	Cc: Hillf Danton <hdanton@sina.com>
	Cc: Michal Hocko <mhocko@suse.com>
	Cc: Matthew Wilcox <willy@infradead.org>
	Cc: Oleksiy Avramchenko <oleksiy.avramchenko@sonymobile.com>
	Cc: Steven Rostedt <rostedt@goodmis.org>
	Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
	Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
(cherry picked from commit dd3b8353bae79395b12a178de057b183ff0122eb)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	mm/vmalloc.c
diff --cc mm/vmalloc.c
index c82a0db1aefc,d535ef125bda..000000000000
--- a/mm/vmalloc.c
+++ b/mm/vmalloc.c
@@@ -327,7 -326,9 +327,13 @@@ EXPORT_SYMBOL(vmalloc_to_pfn)
  
  /*** Global kva allocator ***/
  
++<<<<<<< HEAD
 +#define VM_LAZY_FREE	0x02
++=======
+ #define DEBUG_AUGMENT_PROPAGATE_CHECK 0
+ #define DEBUG_AUGMENT_LOWEST_MATCH_CHECK 0
+ 
++>>>>>>> dd3b8353bae7 (mm/vmalloc: do not keep unpurged areas in the busy tree)
  #define VM_VM_AREA	0x04
  
  static DEFINE_SPINLOCK(vmap_area_lock);
* Unmerged path mm/vmalloc.c
