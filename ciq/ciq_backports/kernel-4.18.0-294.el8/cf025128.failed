ixgbe: Add XDP frame size to driver

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-294.el8
commit-author Jesper Dangaard Brouer <brouer@redhat.com>
commit cf02512899805d6f3d48c0cf1825148f5d24fe71
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-294.el8/cf025128.failed

This driver uses different memory models depending on PAGE_SIZE at
compile time. For PAGE_SIZE 4K it uses page splitting, meaning for
normal MTU frame size is 2048 bytes (and headroom 192 bytes). For
larger MTUs the driver still use page splitting, by allocating
order-1 pages (8192 bytes) for RX frames. For PAGE_SIZE larger than
4K, driver instead advance its rx_buffer->page_offset with the frame
size "truesize".

For XDP frame size calculations, this mean that in PAGE_SIZE larger
than 4K mode the frame_sz change on a per packet basis. For the page
split 4K PAGE_SIZE mode, xdp.frame_sz is more constant and can be
updated once outside the main NAPI loop.

The default setting in the driver uses build_skb(), which provides
the necessary headroom and tailroom for XDP-redirect in RX-frame
(in both modes).

There is one complication, which is legacy-rx mode (configurable via
ethtool priv-flags). There are zero headroom in this mode, which is a
requirement for XDP-redirect to work. The conversion to xdp_frame
(convert_to_xdp_frame) will detect this insufficient space, and
xdp_do_redirect() call will fail. This is deemed acceptable, as it
allows other XDP actions to still work in legacy-mode. In
legacy-mode + larger PAGE_SIZE due to lacking tailroom, we also
accept that xdp_adjust_tail shrink doesn't work.

	Signed-off-by: Jesper Dangaard Brouer <brouer@redhat.com>
	Signed-off-by: Alexei Starovoitov <ast@kernel.org>
	Cc: intel-wired-lan@lists.osuosl.org
	Cc: Jeff Kirsher <jeffrey.t.kirsher@intel.com>
	Cc: Alexander Duyck <alexander.duyck@gmail.com>
Link: https://lore.kernel.org/bpf/158945345455.97035.14334355929030628741.stgit@firesoul
(cherry picked from commit cf02512899805d6f3d48c0cf1825148f5d24fe71)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/intel/ixgbe/ixgbe_main.c
diff --cc drivers/net/ethernet/intel/ixgbe/ixgbe_main.c
index 7d2437de6e6b,eab5934b04f5..000000000000
--- a/drivers/net/ethernet/intel/ixgbe/ixgbe_main.c
+++ b/drivers/net/ethernet/intel/ixgbe/ixgbe_main.c
@@@ -2247,15 -2264,10 +2263,17 @@@ static void ixgbe_rx_buffer_flip(struc
  				 struct ixgbe_rx_buffer *rx_buffer,
  				 unsigned int size)
  {
+ 	unsigned int truesize = ixgbe_rx_frame_truesize(rx_ring, size);
  #if (PAGE_SIZE < 8192)
- 	unsigned int truesize = ixgbe_rx_pg_size(rx_ring) / 2;
- 
  	rx_buffer->page_offset ^= truesize;
  #else
++<<<<<<< HEAD
 +	unsigned int truesize = ring_uses_build_skb(rx_ring) ?
 +				SKB_DATA_ALIGN(IXGBE_SKB_PAD + size) :
 +				SKB_DATA_ALIGN(size);
 +
++=======
++>>>>>>> cf0251289980 (ixgbe: Add XDP frame size to driver)
  	rx_buffer->page_offset += truesize;
  #endif
  }
* Unmerged path drivers/net/ethernet/intel/ixgbe/ixgbe_main.c
