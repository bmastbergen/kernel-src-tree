virtio-net: correctly update XDP_TX counters

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-294.el8
commit-author Jason Wang <jasowang@redhat.com>
commit ca9e83b4a55bfa1cc1395b48c3bf70381833526b
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-294.el8/ca9e83b4.failed

Commit 5b8f3c8d30a6 ("virtio_net: Add XDP related stats") tries to
count TX XDP stats in virtnet_receive(). This will cause several
issues:

- virtnet_xdp_sq() was called without checking whether or not XDP is
  set. This may cause out of bound access when there's no enough txq
  for XDP.
- Stats were updated even if there's no XDP/XDP_TX.

Fixing this by reusing virtnet_xdp_xmit() for XDP_TX which can counts
TX XDP counter itself and remove the unnecessary tx stats embedded in
rx stats.

	Reported-by: syzbot+604f8271211546f5b3c7@syzkaller.appspotmail.com
Fixes: 5b8f3c8d30a6 ("virtio_net: Add XDP related stats")
	Cc: Toshiaki Makita <makita.toshiaki@lab.ntt.co.jp>
	Signed-off-by: Jason Wang <jasowang@redhat.com>
	Acked-by: Michael S. Tsirkin <mst@redhat.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit ca9e83b4a55bfa1cc1395b48c3bf70381833526b)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/virtio_net.c
diff --cc drivers/net/virtio_net.c
index bb87a9822737,72d3f6888561..000000000000
--- a/drivers/net/virtio_net.c
+++ b/drivers/net/virtio_net.c
@@@ -692,8 -686,9 +676,13 @@@ static struct sk_buff *receive_small(st
  			xdpf = convert_to_xdp_frame(&xdp);
  			if (unlikely(!xdpf))
  				goto err_xdp;
++<<<<<<< HEAD
 +			err = __virtnet_xdp_tx_xmit(vi, xdpf);
 +			if (unlikely(err)) {
++=======
+ 			err = virtnet_xdp_xmit(dev, 1, &xdpf, 0);
+ 			if (unlikely(err < 0)) {
++>>>>>>> ca9e83b4a55b (virtio-net: correctly update XDP_TX counters)
  				trace_xdp_exception(vi->dev, xdp_prog, act);
  				goto err_xdp;
  			}
@@@ -858,8 -856,9 +847,13 @@@ static struct sk_buff *receive_mergeabl
  			xdpf = convert_to_xdp_frame(&xdp);
  			if (unlikely(!xdpf))
  				goto err_xdp;
++<<<<<<< HEAD
 +			err = __virtnet_xdp_tx_xmit(vi, xdpf);
 +			if (unlikely(err)) {
++=======
+ 			err = virtnet_xdp_xmit(dev, 1, &xdpf, 0);
+ 			if (unlikely(err < 0)) {
++>>>>>>> ca9e83b4a55b (virtio-net: correctly update XDP_TX counters)
  				trace_xdp_exception(vi->dev, xdp_prog, act);
  				if (unlikely(xdp_page != page))
  					put_page(xdp_page);
* Unmerged path drivers/net/virtio_net.c
