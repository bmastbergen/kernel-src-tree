net: introduce helper sendpage_ok() in include/linux/net.h

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-294.el8
commit-author Coly Li <colyli@suse.de>
commit c381b07941adc2274ce552daf86c94701c5e265a
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-294.el8/c381b079.failed

The original problem was from nvme-over-tcp code, who mistakenly uses
kernel_sendpage() to send pages allocated by __get_free_pages() without
__GFP_COMP flag. Such pages don't have refcount (page_count is 0) on
tail pages, sending them by kernel_sendpage() may trigger a kernel panic
from a corrupted kernel heap, because these pages are incorrectly freed
in network stack as page_count 0 pages.

This patch introduces a helper sendpage_ok(), it returns true if the
checking page,
- is not slab page: PageSlab(page) is false.
- has page refcount: page_count(page) is not zero

All drivers who want to send page to remote end by kernel_sendpage()
may use this helper to check whether the page is OK. If the helper does
not return true, the driver should try other non sendpage method (e.g.
sock_no_sendpage()) to handle the page.

	Signed-off-by: Coly Li <colyli@suse.de>
	Cc: Chaitanya Kulkarni <chaitanya.kulkarni@wdc.com>
	Cc: Christoph Hellwig <hch@lst.de>
	Cc: Hannes Reinecke <hare@suse.de>
	Cc: Jan Kara <jack@suse.com>
	Cc: Jens Axboe <axboe@kernel.dk>
	Cc: Mikhail Skorzhinskii <mskorzhinskiy@solarflare.com>
	Cc: Philipp Reisner <philipp.reisner@linbit.com>
	Cc: Sagi Grimberg <sagi@grimberg.me>
	Cc: Vlastimil Babka <vbabka@suse.com>
	Cc: stable@vger.kernel.org
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit c381b07941adc2274ce552daf86c94701c5e265a)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	include/linux/net.h
diff --cc include/linux/net.h
index 801728e8063b,ae713c851342..000000000000
--- a/include/linux/net.h
+++ b/include/linux/net.h
@@@ -25,6 -21,8 +25,11 @@@
  #include <linux/rcupdate.h>
  #include <linux/once.h>
  #include <linux/fs.h>
++<<<<<<< HEAD
++=======
+ #include <linux/mm.h>
+ #include <linux/sockptr.h>
++>>>>>>> c381b07941ad (net: introduce helper sendpage_ok() in include/linux/net.h)
  
  #include <uapi/linux/net.h>
  
* Unmerged path include/linux/net.h
