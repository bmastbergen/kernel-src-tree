mptcp: don't skip needed ack

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-294.el8
commit-author Paolo Abeni <pabeni@redhat.com>
commit 717f20341686245fdde9000ee09fdab5dc722477
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-294.el8/717f2034.failed

Currently we skip calling tcp_cleanup_rbuf() when packets
are moved into the OoO queue or simply dropped. In both
cases we still increment tp->copied_seq, and we should
ask the TCP stack to check for ack.

Fixes: c76c6956566f ("mptcp: call tcp_cleanup_rbuf on subflows")
	Signed-off-by: Paolo Abeni <pabeni@redhat.com>
	Reviewed-by: Mat Martineau <mathew.j.martineau@linux.intel.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 717f20341686245fdde9000ee09fdab5dc722477)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/mptcp/protocol.c
diff --cc net/mptcp/protocol.c
index 691a71ca323f,f893985f37d3..000000000000
--- a/net/mptcp/protocol.c
+++ b/net/mptcp/protocol.c
@@@ -338,14 -454,12 +338,16 @@@ static bool __mptcp_move_skbs_from_subf
  	unsigned int moved = 0;
  	bool more_data_avail;
  	struct tcp_sock *tp;
+ 	u32 old_copied_seq;
  	bool done = false;
  
 -	pr_debug("msk=%p ssk=%p", msk, ssk);
 +	if (!mptcp_subflow_dsn_valid(msk, ssk)) {
 +		*bytes = 0;
 +		return false;
 +	}
 +
  	tp = tcp_sk(ssk);
+ 	old_copied_seq = tp->copied_seq;
  	do {
  		u32 map_remaining, offset;
  		u32 seq = tp->copied_seq;
@@@ -403,16 -517,9 +405,22 @@@
  		}
  	} while (more_data_avail);
  
++<<<<<<< HEAD
 +	*bytes = moved;
 +
 +	/* If the moves have caught up with the DATA_FIN sequence number
 +	 * it's time to ack the DATA_FIN and change socket state, but
 +	 * this is not a good place to change state. Let the workqueue
 +	 * do it.
 +	 */
 +	if (mptcp_pending_data_fin(sk, NULL) &&
 +	    schedule_work(&msk->work))
 +		sock_hold(sk);
++=======
+ 	*bytes += moved;
+ 	if (tp->copied_seq != old_copied_seq)
+ 		tcp_cleanup_rbuf(ssk, 1);
++>>>>>>> 717f20341686 (mptcp: don't skip needed ack)
  
  	return done;
  }
* Unmerged path net/mptcp/protocol.c
