x86/head/64: Disable stack protection for head$(BITS).o

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-294.el8
Rebuild_CHGLOG: - [x86] head/64: Disable stack protection for head$(BITS).o (Vitaly Kuznetsov) [1868080]
Rebuild_FUZZ: 96.23%
commit-author Arvind Sankar <nivedita@alum.mit.edu>
commit 103a4908ad4da9decdf9bc7216ec5a4861edf703
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-294.el8/103a4908.failed

On 64-bit, the startup_64_setup_env() function added in

  866b556efa12 ("x86/head/64: Install startup GDT")

has stack protection enabled because of set_bringup_idt_handler().
This happens when CONFIG_STACKPROTECTOR_STRONG is enabled. It
also currently needs CONFIG_AMD_MEM_ENCRYPT enabled because then
set_bringup_idt_handler() is not an empty stub but that might change in
the future, when the other vendor adds their similar technology.

At this point, %gs is not yet initialized, and this doesn't cause a
crash only because the #PF handler from the decompressor stub is still
installed and handles the page fault.

Disable stack protection for the whole file, and do it on 32-bit as
well to avoid surprises.

 [ bp: Extend commit message with the exact explanation how it happens. ]

	Signed-off-by: Arvind Sankar <nivedita@alum.mit.edu>
	Signed-off-by: Borislav Petkov <bp@suse.de>
	Reviewed-by: Joerg Roedel <jroedel@suse.de>
Link: https://lkml.kernel.org/r/20201008191623.2881677-6-nivedita@alum.mit.edu
(cherry picked from commit 103a4908ad4da9decdf9bc7216ec5a4861edf703)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kernel/Makefile
diff --cc arch/x86/kernel/Makefile
index bddda128283a,68608bd892c0..000000000000
--- a/arch/x86/kernel/Makefile
+++ b/arch/x86/kernel/Makefile
@@@ -42,7 -47,9 +42,13 @@@ endi
  # non-deterministic coverage.
  KCOV_INSTRUMENT		:= n
  
++<<<<<<< HEAD
 +CFLAGS_irq.o := -I$(src)/../include/asm/trace
++=======
+ CFLAGS_head$(BITS).o	+= -fno-stack-protector
+ 
+ CFLAGS_irq.o := -I $(srctree)/$(src)/../include/asm/trace
++>>>>>>> 103a4908ad4d (x86/head/64: Disable stack protection for head$(BITS).o)
  
  obj-y			:= process_$(BITS).o signal.o
  obj-$(CONFIG_COMPAT)	+= signal_compat.o
* Unmerged path arch/x86/kernel/Makefile
