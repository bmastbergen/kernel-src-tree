bpf: handle the compat string in bpf_trace_copy_string better

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-294.el8
commit-author Christoph Hellwig <hch@lst.de>
commit aec6ce59133edc4ac04f7d4e2556fdf047becb62
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-294.el8/aec6ce59.failed

User the proper helper for kernel or userspace addresses based on
TASK_SIZE instead of the dangerous strncpy_from_unsafe function.

	Signed-off-by: Christoph Hellwig <hch@lst.de>
	Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
	Cc: Alexei Starovoitov <ast@kernel.org>
	Cc: Daniel Borkmann <daniel@iogearbox.net>
	Cc: "H. Peter Anvin" <hpa@zytor.com>
	Cc: Ingo Molnar <mingo@elte.hu>
	Cc: Masami Hiramatsu <mhiramat@kernel.org>
	Cc: Thomas Gleixner <tglx@linutronix.de>
Link: http://lkml.kernel.org/r/20200521152301.2587579-13-hch@lst.de
	Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
(cherry picked from commit aec6ce59133edc4ac04f7d4e2556fdf047becb62)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	kernel/trace/bpf_trace.c
diff --cc kernel/trace/bpf_trace.c
index 5481c35d2b9d,a2efbdad434b..000000000000
--- a/kernel/trace/bpf_trace.c
+++ b/kernel/trace/bpf_trace.c
@@@ -318,6 -324,31 +318,34 @@@ static const struct bpf_func_proto *bpf
  	return &bpf_probe_write_user_proto;
  }
  
++<<<<<<< HEAD
++=======
+ static void bpf_trace_copy_string(char *buf, void *unsafe_ptr, char fmt_ptype,
+ 		size_t bufsz)
+ {
+ 	void __user *user_ptr = (__force void __user *)unsafe_ptr;
+ 
+ 	buf[0] = 0;
+ 
+ 	switch (fmt_ptype) {
+ 	case 's':
+ #ifdef CONFIG_ARCH_HAS_NON_OVERLAPPING_ADDRESS_SPACE
+ 		if ((unsigned long)unsafe_ptr < TASK_SIZE) {
+ 			strncpy_from_user_nofault(buf, user_ptr, bufsz);
+ 			break;
+ 		}
+ 		fallthrough;
+ #endif
+ 	case 'k':
+ 		strncpy_from_kernel_nofault(buf, unsafe_ptr, bufsz);
+ 		break;
+ 	case 'u':
+ 		strncpy_from_user_nofault(buf, user_ptr, bufsz);
+ 		break;
+ 	}
+ }
+ 
++>>>>>>> aec6ce59133e (bpf: handle the compat string in bpf_trace_copy_string better)
  /*
   * Only limited trace_printk() conversion specifiers allowed:
   * %d %i %u %x %ld %li %lu %lx %lld %lli %llu %llx %p %pks %pus %s
* Unmerged path kernel/trace/bpf_trace.c
