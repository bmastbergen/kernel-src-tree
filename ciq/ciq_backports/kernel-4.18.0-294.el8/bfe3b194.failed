powerpc/perf: Ignore the BHRB kernel address filtering for P10

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-294.el8
commit-author Athira Rajeev <atrajeev@linux.vnet.ibm.com>
commit bfe3b1945d5e0531103b3d4ab3a367a1a156d99a
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-294.el8/bfe3b194.failed

Commit bb19af816025 ("powerpc/perf: Prevent kernel address leak to
userspace via BHRB buffer") added a check in bhrb_read() to filter
the kernel address from BHRB buffer. This patch modified it to avoid
that check for PowerISA v3.1 based processors, since PowerISA v3.1
allows only MSR[PR]=1 address to be written to BHRB buffer.

	Signed-off-by: Athira Rajeev <atrajeev@linux.vnet.ibm.com>
	Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: https://lore.kernel.org/r/1594996707-3727-10-git-send-email-atrajeev@linux.vnet.ibm.com
(cherry picked from commit bfe3b1945d5e0531103b3d4ab3a367a1a156d99a)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/powerpc/perf/core-book3s.c
diff --cc arch/powerpc/perf/core-book3s.c
index 0ee276196818,e31629fb6e7e..000000000000
--- a/arch/powerpc/perf/core-book3s.c
+++ b/arch/powerpc/perf/core-book3s.c
@@@ -465,9 -470,11 +465,16 @@@ static void power_pmu_bhrb_read(struct 
  			 * addresses at this point. Check the privileges before
  			 * exporting it to userspace (avoid exposure of regions
  			 * where we could have speculative execution)
+ 			 * Incase of ISA v3.1, BHRB will capture only user-space
+ 			 * addresses, hence include a check before filtering code
  			 */
++<<<<<<< HEAD
 +			if (perf_paranoid_kernel() && !capable(CAP_SYS_ADMIN) &&
 +				is_kernel_addr(addr))
++=======
+ 			if (!(ppmu->flags & PPMU_ARCH_31) &&
+ 				is_kernel_addr(addr) && perf_allow_kernel(&event->attr) != 0)
++>>>>>>> bfe3b1945d5e (powerpc/perf: Ignore the BHRB kernel address filtering for P10)
  				continue;
  
  			/* Branches are read most recent first (ie. mfbhrb 0 is
* Unmerged path arch/powerpc/perf/core-book3s.c
