xfs: don't catch dax+reflink inodes as corruption in verifier

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-294.el8
commit-author Eric Sandeen <sandeen@redhat.com>
commit 207ddc0ef4f413ab1f4e0c1fcab2226425dec293
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-294.el8/207ddc0e.failed

We don't yet support dax on reflinked files, but that is in the works.

Further, having the flag set does not automatically mean that the inode
is actually "in the CPU direct access state," which depends on several
other conditions in addition to the flag being set.

As such, we should not catch this as corruption in the verifier - simply
not actually enabling S_DAX on reflinked files is enough for now.

Fixes: 4f435ebe7d04 ("xfs: don't mix reflink and DAX mode for now")
	Signed-off-by: Eric Sandeen <sandeen@redhat.com>
	Reviewed-by: Christoph Hellwig <hch@lst.de>
[darrick: fix the scrubber too]
	Reviewed-by: Darrick J. Wong <darrick.wong@oracle.com>
	Signed-off-by: Darrick J. Wong <darrick.wong@oracle.com>
(cherry picked from commit 207ddc0ef4f413ab1f4e0c1fcab2226425dec293)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/xfs/scrub/inode.c
diff --cc fs/xfs/scrub/inode.c
index 6d483ab29e63,faf65eb5bd31..000000000000
--- a/fs/xfs/scrub/inode.c
+++ b/fs/xfs/scrub/inode.c
@@@ -186,8 -185,9 +186,14 @@@ xchk_inode_flags2
  	if ((flags & XFS_DIFLAG_REALTIME) && (flags2 & XFS_DIFLAG2_REFLINK))
  		goto bad;
  
++<<<<<<< HEAD
 +	/* dax and reflink make no sense, currently */
 +	if ((flags2 & XFS_DIFLAG2_DAX) && (flags2 & XFS_DIFLAG2_REFLINK))
++=======
+ 	/* no bigtime iflag without the bigtime feature */
+ 	if (xfs_dinode_has_bigtime(dip) &&
+ 	    !xfs_sb_version_hasbigtime(&mp->m_sb))
++>>>>>>> 207ddc0ef4f4 (xfs: don't catch dax+reflink inodes as corruption in verifier)
  		goto bad;
  
  	return;
diff --git a/fs/xfs/libxfs/xfs_inode_buf.c b/fs/xfs/libxfs/xfs_inode_buf.c
index d1af089d146f..6f59e4632904 100644
--- a/fs/xfs/libxfs/xfs_inode_buf.c
+++ b/fs/xfs/libxfs/xfs_inode_buf.c
@@ -568,10 +568,6 @@ xfs_dinode_verify(
 	if ((flags2 & XFS_DIFLAG2_REFLINK) && (flags & XFS_DIFLAG_REALTIME))
 		return __this_address;
 
-	/* don't let reflink and dax mix */
-	if ((flags2 & XFS_DIFLAG2_REFLINK) && (flags2 & XFS_DIFLAG2_DAX))
-		return __this_address;
-
 	/* COW extent size hint validation */
 	fa = xfs_inode_validate_cowextsize(mp, be32_to_cpu(dip->di_cowextsize),
 			mode, flags, flags2);
* Unmerged path fs/xfs/scrub/inode.c
