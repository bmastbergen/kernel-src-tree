net: stmmac: Only the last buffer has the FCS field

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-294.el8
commit-author Jose Abreu <Jose.Abreu@synopsys.com>
commit 93b5dce401ccd4a688fe1f0d0bf0d97e63cdf921
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-294.el8/93b5dce4.failed

Only the last received buffer contains the FCS field. Check for end of
packet before trying to strip the FCS field.

Fixes: 88ebe2cf7f3f ("net: stmmac: Rework stmmac_rx()")
	Signed-off-by: Jose Abreu <Jose.Abreu@synopsys.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 93b5dce401ccd4a688fe1f0d0bf0d97e63cdf921)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/stmicro/stmmac/stmmac_main.c
diff --cc drivers/net/ethernet/stmicro/stmmac/stmmac_main.c
index b85b4758ad31,acb14a96243e..000000000000
--- a/drivers/net/ethernet/stmicro/stmmac/stmmac_main.c
+++ b/drivers/net/ethernet/stmicro/stmmac/stmmac_main.c
@@@ -3601,22 -3628,31 +3601,46 @@@ read_again
  
  		/* Buffer is good. Go on. */
  
 -		prefetch(page_address(buf->page));
 -		if (buf->sec_page)
 -			prefetch(page_address(buf->sec_page));
 -
 +		if (likely(status & rx_not_ls)) {
 +			len += priv->dma_buf_sz;
 +		} else {
 +			prev_len = len;
 +			len = stmmac_get_rx_frame_len(priv, p, coe);
 +
++<<<<<<< HEAD
 +			/* ACS is set; GMAC core strips PAD/FCS for IEEE 802.3
 +			 * Type frames (LLC/LLC-SNAP)
 +			 *
 +			 * llc_snap is never checked in GMAC >= 4, so this ACS
 +			 * feature is always disabled and packets need to be
 +			 * stripped manually.
 +			 */
 +			if (unlikely(priv->synopsys_id >= DWMAC_CORE_4_00) ||
 +			    unlikely(status != llc_snap))
 +				len -= ETH_FCS_LEN;
++=======
+ 		buf1_len = stmmac_rx_buf1_len(priv, p, status, len);
+ 		len += buf1_len;
+ 		buf2_len = stmmac_rx_buf2_len(priv, p, status, len);
+ 		len += buf2_len;
+ 
+ 		/* ACS is set; GMAC core strips PAD/FCS for IEEE 802.3
+ 		 * Type frames (LLC/LLC-SNAP)
+ 		 *
+ 		 * llc_snap is never checked in GMAC >= 4, so this ACS
+ 		 * feature is always disabled and packets need to be
+ 		 * stripped manually.
+ 		 */
+ 		if (likely(!(status & rx_not_ls)) &&
+ 		    (likely(priv->synopsys_id >= DWMAC_CORE_4_00) ||
+ 		     unlikely(status != llc_snap))) {
+ 			if (buf2_len)
+ 				buf2_len -= ETH_FCS_LEN;
+ 			else
+ 				buf1_len -= ETH_FCS_LEN;
+ 
+ 			len -= ETH_FCS_LEN;
++>>>>>>> 93b5dce401cc (net: stmmac: Only the last buffer has the FCS field)
  		}
  
  		if (!skb) {
* Unmerged path drivers/net/ethernet/stmicro/stmmac/stmmac_main.c
