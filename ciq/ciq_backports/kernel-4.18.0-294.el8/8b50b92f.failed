KVM: VMX: Add a helper and macros to reduce boilerplate for sec exec ctls

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-294.el8
commit-author Sean Christopherson <sean.j.christopherson@intel.com>
commit 8b50b92f9f1a819cba290e24064337004c00ee36
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-294.el8/8b50b92f.failed

Add a helper function and several wrapping macros to consolidate the
copy-paste code in vmx_compute_secondary_exec_control() for adjusting
controls that are dependent on guest CPUID bits.

No functional change intended.

	Signed-off-by: Sean Christopherson <sean.j.christopherson@intel.com>
Message-Id: <20200925003011.21016-1-sean.j.christopherson@intel.com>
	Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
(cherry picked from commit 8b50b92f9f1a819cba290e24064337004c00ee36)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kvm/vmx/vmx.c
diff --cc arch/x86/kvm/vmx/vmx.c
index 1e7494d03611,b0ba1cc79e6a..000000000000
--- a/arch/x86/kvm/vmx/vmx.c
+++ b/arch/x86/kvm/vmx/vmx.c
@@@ -4136,33 -4185,12 +4191,29 @@@ static void vmx_compute_secondary_exec_
  
  		vcpu->arch.xsaves_enabled = xsaves_enabled;
  
- 		if (!xsaves_enabled)
- 			exec_control &= ~SECONDARY_EXEC_XSAVES;
- 
- 		if (nested) {
- 			if (xsaves_enabled)
- 				vmx->nested.msrs.secondary_ctls_high |=
- 					SECONDARY_EXEC_XSAVES;
- 			else
- 				vmx->nested.msrs.secondary_ctls_high &=
- 					~SECONDARY_EXEC_XSAVES;
- 		}
+ 		vmx_adjust_secondary_exec_control(vmx, &exec_control,
+ 						  SECONDARY_EXEC_XSAVES,
+ 						  xsaves_enabled, false);
  	}
  
++<<<<<<< HEAD
 +	if (cpu_has_vmx_rdtscp()) {
 +		bool rdtscp_enabled = guest_cpuid_has(vcpu, X86_FEATURE_RDTSCP);
 +		if (!rdtscp_enabled)
 +			exec_control &= ~SECONDARY_EXEC_RDTSCP;
 +
 +		if (nested) {
 +			if (rdtscp_enabled)
 +				vmx->nested.msrs.secondary_ctls_high |=
 +					SECONDARY_EXEC_RDTSCP;
 +			else
 +				vmx->nested.msrs.secondary_ctls_high &=
 +					~SECONDARY_EXEC_RDTSCP;
 +		}
 +	}
++=======
+ 	vmx_adjust_sec_exec_feature(vmx, &exec_control, rdtscp, RDTSCP);
++>>>>>>> 8b50b92f9f1a (KVM: VMX: Add a helper and macros to reduce boilerplate for sec exec ctls)
  
  	/*
  	 * Expose INVPCID if and only if PCID is also exposed to the guest.
* Unmerged path arch/x86/kvm/vmx/vmx.c
