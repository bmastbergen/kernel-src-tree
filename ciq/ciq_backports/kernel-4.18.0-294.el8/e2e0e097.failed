selinux: fix a missing-check bug in selinux_add_mnt_opt( )

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-294.el8
commit-author Gen Zhang <blackgod016574@gmail.com>
commit e2e0e09758a6f7597de0f9b819647addfb71b6bd
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-294.el8/e2e0e097.failed

In selinux_add_mnt_opt(), 'val' is allocated by kmemdup_nul(). It returns
NULL when fails. So 'val' should be checked. And 'mnt_opts' should be
freed when error.

	Signed-off-by: Gen Zhang <blackgod016574@gmail.com>
Fixes: 757cbe597fe8 ("LSM: new method: ->sb_add_mnt_opt()")
	Cc: <stable@vger.kernel.org>
[PM: fixed some indenting problems]
	Signed-off-by: Paul Moore <paul@paul-moore.com>
(cherry picked from commit e2e0e09758a6f7597de0f9b819647addfb71b6bd)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	security/selinux/hooks.c
diff --cc security/selinux/hooks.c
index 42145010da10,b7db84c97882..000000000000
--- a/security/selinux/hooks.c
+++ b/security/selinux/hooks.c
@@@ -1095,42 -1049,28 +1095,63 @@@ static int selinux_parse_opts_str(char 
  		}
  	}
  
 -	if (token == Opt_error)
 -		return -EINVAL;
 +	rc = -ENOMEM;
 +	opts->mnt_opts = kcalloc(NUM_SEL_MNT_OPTS, sizeof(char *), GFP_KERNEL);
 +	if (!opts->mnt_opts)
 +		goto out_err;
  
++<<<<<<< HEAD
 +	opts->mnt_opts_flags = kcalloc(NUM_SEL_MNT_OPTS, sizeof(int),
 +				       GFP_KERNEL);
 +	if (!opts->mnt_opts_flags)
 +		goto out_err;
 +
 +	if (fscontext) {
 +		opts->mnt_opts[num_mnt_opts] = fscontext;
 +		opts->mnt_opts_flags[num_mnt_opts++] = FSCONTEXT_MNT;
++=======
+ 	if (token != Opt_seclabel) {
+ 		val = kmemdup_nul(val, len, GFP_KERNEL);
+ 		if (!val) {
+ 			rc = -ENOMEM;
+ 			goto free_opt;
+ 		}
+ 	}
+ 	rc = selinux_add_opt(token, val, mnt_opts);
+ 	if (unlikely(rc)) {
+ 		kfree(val);
+ 		goto free_opt;
+ 	}
+ 	return rc;
+ 
+ free_opt:
+ 	if (*mnt_opts) {
+ 		selinux_free_mnt_opts(*mnt_opts);
+ 		*mnt_opts = NULL;
++>>>>>>> e2e0e09758a6 (selinux: fix a missing-check bug in selinux_add_mnt_opt( ))
 +	}
 +	if (context) {
 +		opts->mnt_opts[num_mnt_opts] = context;
 +		opts->mnt_opts_flags[num_mnt_opts++] = CONTEXT_MNT;
 +	}
 +	if (rootcontext) {
 +		opts->mnt_opts[num_mnt_opts] = rootcontext;
 +		opts->mnt_opts_flags[num_mnt_opts++] = ROOTCONTEXT_MNT;
 +	}
 +	if (defcontext) {
 +		opts->mnt_opts[num_mnt_opts] = defcontext;
 +		opts->mnt_opts_flags[num_mnt_opts++] = DEFCONTEXT_MNT;
  	}
 +
 +	opts->num_mnt_opts = num_mnt_opts;
 +	return 0;
 +
 +out_err:
 +	security_free_mnt_opts(opts);
 +	kfree(context);
 +	kfree(defcontext);
 +	kfree(fscontext);
 +	kfree(rootcontext);
  	return rc;
  }
  
* Unmerged path security/selinux/hooks.c
