net: phy: Put interface into oper testing during cable test

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-294.el8
commit-author Andrew Lunn <andrew@lunn.ch>
commit 4a459bdc7472b0e6bea6d0dd8df66253ac4f3fe2
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-294.el8/4a459bdc.failed

Since running a cable test is disruptive, put the interface into
operative state testing while the test is running.

	Signed-off-by: Andrew Lunn <andrew@lunn.ch>
	Reviewed-by: Florian Fainelli <f.fainelli@gmail.com>
	Reviewed-by: Michal Kubecek <mkubecek@suse.cz>
	Signed-off-by: Jakub Kicinski <kuba@kernel.org>
(cherry picked from commit 4a459bdc7472b0e6bea6d0dd8df66253ac4f3fe2)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/phy/phy.c
diff --cc drivers/net/phy/phy.c
index ae8e63279b97,9bdc924eea83..000000000000
--- a/drivers/net/phy/phy.c
+++ b/drivers/net/phy/phy.c
@@@ -484,7 -492,8 +484,12 @@@ static void phy_abort_cable_test(struc
  int phy_start_cable_test(struct phy_device *phydev,
  			 struct netlink_ext_ack *extack)
  {
++<<<<<<< HEAD
 +	int err;
++=======
+ 	struct net_device *dev = phydev->attached_dev;
+ 	int err = -ENOMEM;
++>>>>>>> 4a459bdc7472 (net: phy: Put interface into oper testing during cable test)
  
  	if (!(phydev->drv &&
  	      phydev->drv->cable_test_start &&
@@@ -513,10 -522,16 +518,12 @@@
  	/* Mark the carrier down until the test is complete */
  	phy_link_down(phydev, true);
  
+ 	netif_testing_on(dev);
  	err = phydev->drv->cable_test_start(phydev);
  	if (err) {
+ 		netif_testing_off(dev);
  		phy_link_up(phydev);
 -		goto out_free;
 +		goto out;
  	}
  
  	phydev->state = PHY_CABLETEST;
@@@ -964,6 -990,8 +977,11 @@@ void phy_state_machine(struct work_stru
  		}
  
  		if (finished) {
++<<<<<<< HEAD
++=======
+ 			ethnl_cable_test_finished(phydev);
+ 			netif_testing_off(dev);
++>>>>>>> 4a459bdc7472 (net: phy: Put interface into oper testing during cable test)
  			needs_aneg = true;
  			phydev->state = PHY_UP;
  		}
* Unmerged path drivers/net/phy/phy.c
