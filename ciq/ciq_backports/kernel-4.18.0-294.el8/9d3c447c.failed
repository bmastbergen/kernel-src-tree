KVM: X86: Fix async pf caused null-ptr-deref

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-294.el8
commit-author Wanpeng Li <wanpengli@tencent.com>
commit 9d3c447c72fb2337ca39f245c6ae89f2369de216
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-294.el8/9d3c447c.failed

Syzbot reported that:

  CPU: 1 PID: 6780 Comm: syz-executor153 Not tainted 5.7.0-syzkaller #0
  Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
  RIP: 0010:__apic_accept_irq+0x46/0xb80
  Call Trace:
   kvm_arch_async_page_present+0x7de/0x9e0
   kvm_check_async_pf_completion+0x18d/0x400
   kvm_arch_vcpu_ioctl_run+0x18bf/0x69f0
   kvm_vcpu_ioctl+0x46a/0xe20
   ksys_ioctl+0x11a/0x180
   __x64_sys_ioctl+0x6f/0xb0
   do_syscall_64+0xf6/0x7d0
   entry_SYSCALL_64_after_hwframe+0x49/0xb3

The testcase enables APF mechanism in MSR_KVM_ASYNC_PF_EN with ASYNC_PF_INT
enabled w/o setting MSR_KVM_ASYNC_PF_INT before, what's worse, interrupt
based APF 'page ready' event delivery depends on in kernel lapic, however,
we didn't bail out when lapic is not in kernel during guest setting
MSR_KVM_ASYNC_PF_EN which causes the null-ptr-deref in host later.
This patch fixes it.

	Reported-by: syzbot+1bf777dfdde86d64b89b@syzkaller.appspotmail.com
Fixes: 2635b5c4a0 (KVM: x86: interrupt based APF 'page ready' event delivery)
	Signed-off-by: Wanpeng Li <wanpengli@tencent.com>
Message-Id: <1593426391-8231-1-git-send-email-wanpengli@tencent.com>
	Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
(cherry picked from commit 9d3c447c72fb2337ca39f245c6ae89f2369de216)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kvm/x86.c
diff --cc arch/x86/kvm/x86.c
index 4b0574db7356,a026d926072c..000000000000
--- a/arch/x86/kvm/x86.c
+++ b/arch/x86/kvm/x86.c
@@@ -2679,13 -2689,16 +2679,20 @@@ static int kvm_pv_enable_async_pf(struc
  {
  	gpa_t gpa = data & ~0x3f;
  
 -	/* Bits 4:5 are reserved, Should be zero */
 -	if (data & 0x30)
 +	/* Bits 3:5 are reserved, Should be zero */
 +	if (data & 0x38)
  		return 1;
  
++<<<<<<< HEAD
 +	vcpu->arch.apf.msr_val = data;
++=======
+ 	if (!lapic_in_kernel(vcpu))
+ 		return 1;
+ 
+ 	vcpu->arch.apf.msr_en_val = data;
++>>>>>>> 9d3c447c72fb (KVM: X86: Fix async pf caused null-ptr-deref)
  
 -	if (!kvm_pv_async_pf_enabled(vcpu)) {
 +	if (!(data & KVM_ASYNC_PF_ENABLED)) {
  		kvm_clear_async_pf_completion_queue(vcpu);
  		kvm_async_pf_hash_reset(vcpu);
  		return 0;
* Unmerged path arch/x86/kvm/x86.c
