powerpc/papr_scm: Fix warning triggered by perf_stats_show()

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-294.el8
commit-author Vaibhav Jain <vaibhav@linux.ibm.com>
commit ca78ef2f08ccfa29b711d644964cdf9d7ace15e5
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-294.el8/ca78ef2f.failed

A warning is reported by the kernel in case perf_stats_show() returns
an error code. The warning is of the form below:

 papr_scm ibm,persistent-memory:ibm,pmemory@44100001:
 	  Failed to query performance stats, Err:-10
 dev_attr_show: perf_stats_show+0x0/0x1c0 [papr_scm] returned bad count
 fill_read_buffer: dev_attr_show+0x0/0xb0 returned bad count

On investigation it looks like that the compiler is silently
truncating the return value of drc_pmem_query_stats() from 'long' to
'int', since the variable used to store the return code 'rc' is an
'int'. This truncated value is then returned back as a 'ssize_t' back
from perf_stats_show() to 'dev_attr_show()' which thinks of it as a
large unsigned number and triggers this warning..

To fix this we update the type of variable 'rc' from 'int' to
'ssize_t' that prevents the compiler from truncating the return value
of drc_pmem_query_stats() and returning correct signed value back from
perf_stats_show().

Fixes: 2d02bf835e57 ("powerpc/papr_scm: Fetch nvdimm performance stats from PHYP")
	Signed-off-by: Vaibhav Jain <vaibhav@linux.ibm.com>
	Reviewed-by: Ira Weiny <ira.weiny@intel.com>
	Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: https://lore.kernel.org/r/20200912081451.66225-1-vaibhav@linux.ibm.com
(cherry picked from commit ca78ef2f08ccfa29b711d644964cdf9d7ace15e5)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/powerpc/platforms/pseries/papr_scm.c
diff --cc arch/powerpc/platforms/pseries/papr_scm.c
index 319e67e3932f,5493bc847bd0..000000000000
--- a/arch/powerpc/platforms/pseries/papr_scm.c
+++ b/arch/powerpc/platforms/pseries/papr_scm.c
@@@ -678,24 -782,48 +678,41 @@@ int papr_scm_ndctl(struct nvdimm_bus_de
  	return 0;
  }
  
 -static ssize_t perf_stats_show(struct device *dev,
 -			       struct device_attribute *attr, char *buf)
 +static inline int papr_scm_node(int node)
  {
++<<<<<<< HEAD
 +	int min_dist = INT_MAX, dist;
 +	int nid, min_node;
++=======
+ 	int index;
+ 	ssize_t rc;
+ 	struct seq_buf s;
+ 	struct papr_scm_perf_stat *stat;
+ 	struct papr_scm_perf_stats *stats;
+ 	struct nvdimm *dimm = to_nvdimm(dev);
+ 	struct papr_scm_priv *p = nvdimm_provider_data(dimm);
++>>>>>>> ca78ef2f08cc (powerpc/papr_scm: Fix warning triggered by perf_stats_show())
  
 -	if (!p->stat_buffer_len)
 -		return -ENOENT;
 +	if ((node == NUMA_NO_NODE) || node_online(node))
 +		return node;
  
 -	/* Allocate the buffer for phyp where stats are written */
 -	stats = kzalloc(p->stat_buffer_len, GFP_KERNEL);
 -	if (!stats)
 -		return -ENOMEM;
 -
 -	/* Ask phyp to return all dimm perf stats */
 -	rc = drc_pmem_query_stats(p, stats, 0);
 -	if (rc)
 -		goto free_stats;
 -	/*
 -	 * Go through the returned output buffer and print stats and
 -	 * values. Since stat_id is essentially a char string of
 -	 * 8 bytes, simply use the string format specifier to print it.
 -	 */
 -	seq_buf_init(&s, buf, PAGE_SIZE);
 -	for (index = 0, stat = stats->scm_statistic;
 -	     index < be32_to_cpu(stats->num_statistics);
 -	     ++index, ++stat) {
 -		seq_buf_printf(&s, "%.8s = 0x%016llX\n",
 -			       stat->stat_id,
 -			       be64_to_cpu(stat->stat_val));
 +	min_node = first_online_node;
 +	for_each_online_node(nid) {
 +		dist = node_distance(node, nid);
 +		if (dist < min_dist) {
 +			min_dist = dist;
 +			min_node = nid;
 +		}
  	}
++<<<<<<< HEAD
 +	return min_node;
++=======
+ 
+ free_stats:
+ 	kfree(stats);
+ 	return rc ? rc : (ssize_t)seq_buf_used(&s);
++>>>>>>> ca78ef2f08cc (powerpc/papr_scm: Fix warning triggered by perf_stats_show())
  }
 -DEVICE_ATTR_ADMIN_RO(perf_stats);
  
  static ssize_t flags_show(struct device *dev,
  			  struct device_attribute *attr, char *buf)
* Unmerged path arch/powerpc/platforms/pseries/papr_scm.c
