powerpc/64s/pseries: Fix hash tlbiel_all_isa300 for guest kernels

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-294.el8
commit-author Nicholas Piggin <npiggin@gmail.com>
commit c0b27c517acf8a2b359dd373a7e7e88b01a8308e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-294.el8/c0b27c51.failed

tlbiel_all() can not be usable in !HVMODE when running hash presently,
remove HV privileged flushes when running in guest to make it usable.

	Signed-off-by: Nicholas Piggin <npiggin@gmail.com>
	Reviewed-by: Aneesh Kumar K.V <aneesh.kumar@linux.ibm.com>
	Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: https://lore.kernel.org/r/20201126102530.691335-3-npiggin@gmail.com
(cherry picked from commit c0b27c517acf8a2b359dd373a7e7e88b01a8308e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/powerpc/mm/book3s64/hash_native.c
diff --cc arch/powerpc/mm/book3s64/hash_native.c
index 8a84a5ec3b47,52e170bd95ae..000000000000
--- a/arch/powerpc/mm/book3s64/hash_native.c
+++ b/arch/powerpc/mm/book3s64/hash_native.c
@@@ -114,7 -109,17 +113,21 @@@ static void tlbiel_all_isa300(unsigned 
  	 */
  	tlbiel_hash_set_isa300(0, is, 0, 2, 1);
  
++<<<<<<< HEAD
 +	asm volatile("ptesync": : :"memory");
++=======
+ 	/*
+ 	 * Then flush the sets of the TLB proper. Hash mode uses
+ 	 * partition scoped TLB translations, which may be flushed
+ 	 * in !HV mode.
+ 	 */
+ 	for (set = 0; set < num_sets; set++)
+ 		tlbiel_hash_set_isa300(set, is, 0, 0, 0);
+ 
+ 	ppc_after_tlbiel_barrier();
+ 
+ 	asm volatile(PPC_ISA_3_0_INVALIDATE_ERAT "; isync" : : :"memory");
++>>>>>>> c0b27c517acf (powerpc/64s/pseries: Fix hash tlbiel_all_isa300 for guest kernels)
  }
  
  void hash__tlbiel_all(unsigned int action)
* Unmerged path arch/powerpc/mm/book3s64/hash_native.c
