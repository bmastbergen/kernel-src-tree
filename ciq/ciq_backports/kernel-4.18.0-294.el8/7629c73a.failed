udp: Extract helper for selecting socket from reuseport group

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-294.el8
commit-author Jakub Sitnicki <jakub@cloudflare.com>
commit 7629c73a1466ec2348e9f64c874c19bf13f35f4c
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-294.el8/7629c73a.failed

Prepare for calling into reuseport from __udp4_lib_lookup as well.

	Signed-off-by: Jakub Sitnicki <jakub@cloudflare.com>
	Signed-off-by: Alexei Starovoitov <ast@kernel.org>
	Acked-by: Andrii Nakryiko <andriin@fb.com>
Link: https://lore.kernel.org/bpf/20200717103536.397595-8-jakub@cloudflare.com
(cherry picked from commit 7629c73a1466ec2348e9f64c874c19bf13f35f4c)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/ipv4/udp.c
diff --cc net/ipv4/udp.c
index cfc98bf6ef18,9296faea3acf..000000000000
--- a/net/ipv4/udp.c
+++ b/net/ipv4/udp.c
@@@ -420,9 -435,8 +439,8 @@@ static struct sock *udp4_lib_lookup2(st
  				     struct udp_hslot *hslot2,
  				     struct sk_buff *skb)
  {
 -	struct sock *sk, *result;
 +	struct sock *sk, *result, *reuseport_result;
  	int score, badness;
- 	u32 hash = 0;
  
  	result = NULL;
  	badness = 0;
@@@ -430,20 -444,13 +448,28 @@@
  		score = compute_score(sk, net, saddr, sport,
  				      daddr, hnum, dif, sdif);
  		if (score > badness) {
++<<<<<<< HEAD
 +			reuseport_result = NULL;
 +
 +			if (sk->sk_reuseport &&
 +			    sk->sk_state != TCP_ESTABLISHED) {
 +				hash = udp_ehashfn(net, daddr, hnum,
 +						   saddr, sport);
 +				reuseport_result = reuseport_select_sock(sk, hash, skb,
 +									 sizeof(struct udphdr));
 +				if (reuseport_result && !reuseport_has_conns(sk, false))
 +					return reuseport_result;
 +			}
 +
 +			result = reuseport_result ? : sk;
++=======
+ 			result = lookup_reuseport(net, sk, skb,
+ 						  saddr, sport, daddr, hnum);
+ 			if (result)
+ 				return result;
+ 
++>>>>>>> 7629c73a1466 (udp: Extract helper for selecting socket from reuseport group)
  			badness = score;
 -			result = sk;
  		}
  	}
  	return result;
* Unmerged path net/ipv4/udp.c
