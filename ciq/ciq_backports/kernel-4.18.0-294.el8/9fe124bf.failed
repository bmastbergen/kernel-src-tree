kunit: allow kunit to be loaded as a module

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-294.el8
commit-author Alan Maguire <alan.maguire@oracle.com>
commit 9fe124bf1b7788058ecfe5778fea1660b01e3e9c
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-294.el8/9fe124bf.failed

Making kunit itself buildable as a module allows for "always-on"
kunit configuration; specifying CONFIG_KUNIT=m means the module
is built but only used when loaded.  Kunit test modules will load
kunit.ko as an implicit dependency, so simply running
"modprobe my-kunit-tests" will load the tests along with the kunit
module and run them.

Co-developed-by: Knut Omang <knut.omang@oracle.com>
	Signed-off-by: Knut Omang <knut.omang@oracle.com>
	Signed-off-by: Alan Maguire <alan.maguire@oracle.com>
	Reviewed-by: Brendan Higgins <brendanhiggins@google.com>
	Signed-off-by: Shuah Khan <skhan@linuxfoundation.org>
(cherry picked from commit 9fe124bf1b7788058ecfe5778fea1660b01e3e9c)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	lib/kunit/test.c
diff --cc lib/kunit/test.c
index 58a6227bb12c,9242f932896c..000000000000
--- a/lib/kunit/test.c
+++ b/lib/kunit/test.c
@@@ -478,3 -485,17 +478,20 @@@ void kunit_cleanup(struct kunit *test
  		kunit_resource_free(test, resource);
  	}
  }
++<<<<<<< HEAD
++=======
+ EXPORT_SYMBOL_GPL(kunit_cleanup);
+ 
+ static int __init kunit_init(void)
+ {
+ 	return 0;
+ }
+ late_initcall(kunit_init);
+ 
+ static void __exit kunit_exit(void)
+ {
+ }
+ module_exit(kunit_exit);
+ 
+ MODULE_LICENSE("GPL v2");
++>>>>>>> 9fe124bf1b77 (kunit: allow kunit to be loaded as a module)
diff --git a/lib/kunit/Kconfig b/lib/kunit/Kconfig
index af37016bfdd4..ec94c6ed0c1a 100644
--- a/lib/kunit/Kconfig
+++ b/lib/kunit/Kconfig
@@ -3,7 +3,7 @@
 #
 
 menuconfig KUNIT
-	bool "KUnit - Enable support for unit tests"
+	tristate "KUnit - Enable support for unit tests"
 	help
 	  Enables support for kernel unit tests (KUnit), a lightweight unit
 	  testing and mocking framework for the Linux kernel. These tests are
diff --git a/lib/kunit/Makefile b/lib/kunit/Makefile
index 769d9402b5d3..8e2635a26e04 100644
--- a/lib/kunit/Makefile
+++ b/lib/kunit/Makefile
@@ -1,4 +1,6 @@
-obj-$(CONFIG_KUNIT) +=			test.o \
+obj-$(CONFIG_KUNIT) +=			kunit.o
+
+kunit-objs +=				test.o \
 					string-stream.o \
 					assert.o \
 					try-catch.o
* Unmerged path lib/kunit/test.c
