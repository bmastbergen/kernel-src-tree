NFS: Fix an ABBA spinlock issue in pnfs_update_layout()

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-294.el8
commit-author Trond Myklebust <trond.myklebust@hammerspace.com>
commit fbf4bcc9a8373122881909331f2f9566a128126e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-294.el8/fbf4bcc9.failed

We need to drop the inode spinlock while calling nfs4_select_rw_stateid(),
since nfs4_copy_delegation_stateid() could take the delegation lock.
Note that it is safe to do this, since all other calls to
pnfs_update_layout() for that inode will find themselves blocked by
the lock we hold on NFS_LAYOUT_FIRST_LAYOUTGET.

Fixes: fc51b1cf391d ("NFS: Beware when dereferencing the delegation cred")
	Signed-off-by: Trond Myklebust <trond.myklebust@hammerspace.com>
(cherry picked from commit fbf4bcc9a8373122881909331f2f9566a128126e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/nfs/pnfs.c
diff --cc fs/nfs/pnfs.c
index 1a5ea8d618d5,b8d78f393365..000000000000
--- a/fs/nfs/pnfs.c
+++ b/fs/nfs/pnfs.c
@@@ -2032,9 -2033,6 +2033,12 @@@ lookup_again
  			trace_pnfs_update_layout(ino, pos, count,
  					iomode, lo, lseg,
  					PNFS_UPDATE_LAYOUT_INVALID_OPEN);
++<<<<<<< HEAD
 +			if (status != -EAGAIN)
 +				goto out_unlock;
 +			spin_unlock(&ino->i_lock);
++=======
++>>>>>>> fbf4bcc9a837 (NFS: Fix an ABBA spinlock issue in pnfs_update_layout())
  			nfs4_schedule_stateid_recovery(server, ctx->state);
  			pnfs_clear_first_layoutget(lo);
  			pnfs_put_layout_hdr(lo);
* Unmerged path fs/nfs/pnfs.c
