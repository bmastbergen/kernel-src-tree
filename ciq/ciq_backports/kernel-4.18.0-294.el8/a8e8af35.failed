dma-iommu: use static-key to minimize the impact in the fast-path

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-294.el8
commit-author Lianbo Jiang <lijiang@redhat.com>
commit a8e8af35c9f4f75f981a95488c7066d31bac4bef
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-294.el8/a8e8af35.failed

Let's move out the is_kdump_kernel() check from iommu_dma_deferred_attach()
to iommu_dma_init(), and use the static-key in the fast-path to minimize
the impact in the normal case.

Co-developed-by: Robin Murphy <robin.murphy@arm.com>
	Signed-off-by: Lianbo Jiang <lijiang@redhat.com>
	Signed-off-by: Robin Murphy <robin.murphy@arm.com>
Link: https://lore.kernel.org/r/20210126115337.20068-2-lijiang@redhat.com
	Signed-off-by: Joerg Roedel <jroedel@suse.de>
(cherry picked from commit a8e8af35c9f4f75f981a95488c7066d31bac4bef)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/iommu/dma-iommu.c
diff --cc drivers/iommu/dma-iommu.c
index b4d011969bbf,c80056f6c9f9..000000000000
--- a/drivers/iommu/dma-iommu.c
+++ b/drivers/iommu/dma-iommu.c
@@@ -61,6 -51,29 +61,32 @@@ struct iommu_dma_cookie 
  	struct iommu_domain		*fq_domain;
  };
  
++<<<<<<< HEAD
++=======
+ static DEFINE_STATIC_KEY_FALSE(iommu_deferred_attach_enabled);
+ 
+ void iommu_dma_free_cpu_cached_iovas(unsigned int cpu,
+ 		struct iommu_domain *domain)
+ {
+ 	struct iommu_dma_cookie *cookie = domain->iova_cookie;
+ 	struct iova_domain *iovad = &cookie->iovad;
+ 
+ 	free_cpu_cached_iovas(cpu, iovad);
+ }
+ 
+ static void iommu_dma_entry_dtor(unsigned long data)
+ {
+ 	struct page *freelist = (struct page *)data;
+ 
+ 	while (freelist) {
+ 		unsigned long p = (unsigned long)page_address(freelist);
+ 
+ 		freelist = freelist->freelist;
+ 		free_page(p);
+ 	}
+ }
+ 
++>>>>>>> a8e8af35c9f4 (dma-iommu: use static-key to minimize the impact in the fast-path)
  static inline size_t cookie_msi_granule(struct iommu_dma_cookie *cookie)
  {
  	if (cookie->type == IOMMU_DMA_IOVA_COOKIE)
* Unmerged path drivers/iommu/dma-iommu.c
