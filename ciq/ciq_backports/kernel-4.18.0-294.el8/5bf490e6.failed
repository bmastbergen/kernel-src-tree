s390/qeth: delay draining the TX buffers

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-294.el8
commit-author Julian Wiedmann <jwi@linux.ibm.com>
commit 5bf490e6807bf56f49b5991b4be817407dd32656
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-294.el8/5bf490e6.failed

Wait until the QDIO data connection is severed. Otherwise the device
might still be processing the buffers, and end up accessing skb data
that we already freed.

Fixes: 8b5026bc1693 ("s390/qeth: fix qdio teardown after early init error")
	Signed-off-by: Julian Wiedmann <jwi@linux.ibm.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 5bf490e6807bf56f49b5991b4be817407dd32656)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/s390/net/qeth_l2_main.c
#	drivers/s390/net/qeth_l3_main.c
diff --cc drivers/s390/net/qeth_l2_main.c
index 88261c8e41f6,6384f7adba66..000000000000
--- a/drivers/s390/net/qeth_l2_main.c
+++ b/drivers/s390/net/qeth_l2_main.c
@@@ -284,11 -284,6 +284,14 @@@ static void qeth_l2_stop_card(struct qe
  
  	if (card->state == CARD_STATE_SOFTSETUP) {
  		qeth_clear_ipacmd_list(card);
++<<<<<<< HEAD
 +		card->state = CARD_STATE_HARDSETUP;
 +	}
 +	if (card->state == CARD_STATE_HARDSETUP) {
 +		qeth_drain_output_queues(card);
 +		cancel_delayed_work_sync(&card->buffer_reclaim_work);
++=======
++>>>>>>> 5bf490e6807b (s390/qeth: delay draining the TX buffers)
  		card->state = CARD_STATE_DOWN;
  	}
  
diff --cc drivers/s390/net/qeth_l3_main.c
index fe24844e0953,09ef518ca1ea..000000000000
--- a/drivers/s390/net/qeth_l3_main.c
+++ b/drivers/s390/net/qeth_l3_main.c
@@@ -1262,11 -1168,6 +1262,14 @@@ static void qeth_l3_stop_card(struct qe
  	if (card->state == CARD_STATE_SOFTSETUP) {
  		qeth_l3_clear_ip_htable(card, 1);
  		qeth_clear_ipacmd_list(card);
++<<<<<<< HEAD
 +		card->state = CARD_STATE_HARDSETUP;
 +	}
 +	if (card->state == CARD_STATE_HARDSETUP) {
 +		qeth_drain_output_queues(card);
 +		cancel_delayed_work_sync(&card->buffer_reclaim_work);
++=======
++>>>>>>> 5bf490e6807b (s390/qeth: delay draining the TX buffers)
  		card->state = CARD_STATE_DOWN;
  	}
  
* Unmerged path drivers/s390/net/qeth_l2_main.c
* Unmerged path drivers/s390/net/qeth_l3_main.c
