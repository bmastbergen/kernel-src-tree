net/mlx5: E-Switch, Check and enable metadata support flag before using

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-294.el8
commit-author Vu Pham <vuhuong@mellanox.com>
commit 4e9a9ef7d8a977596e8de8d917bac973d34a9171
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-294.el8/4e9a9ef7.failed

Check E-Switch capabilities and enable metadata support flag
before using it to setup other features that need metadata.

	Signed-off-by: Vu Pham <vuhuong@mellanox.com>
	Reviewed-by: Mark Bloch <mbloch@nvidia.com>
	Signed-off-by: Saeed Mahameed <saeedm@nvidia.com>
(cherry picked from commit 4e9a9ef7d8a977596e8de8d917bac973d34a9171)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlx5/core/eswitch_offloads.c
diff --cc drivers/net/ethernet/mellanox/mlx5/core/eswitch_offloads.c
index afb4bff4a4e1,4cbadb15297c..000000000000
--- a/drivers/net/ethernet/mellanox/mlx5/core/eswitch_offloads.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/eswitch_offloads.c
@@@ -2146,6 -2134,13 +2138,16 @@@ int esw_offloads_enable(struct mlx5_esw
  	mutex_init(&esw->offloads.termtbl_mutex);
  	mlx5_rdma_enable_roce(esw->dev);
  
++<<<<<<< HEAD
++=======
+ 	err = mlx5_esw_host_number_init(esw);
+ 	if (err)
+ 		goto err_vport_metadata;
+ 
+ 	if (esw_use_vport_metadata(esw))
+ 		esw->flags |= MLX5_ESWITCH_VPORT_MATCH_METADATA;
+ 
++>>>>>>> 4e9a9ef7d8a9 (net/mlx5: E-Switch, Check and enable metadata support flag before using)
  	err = esw_set_passing_vport_metadata(esw, true);
  	if (err)
  		goto err_vport_metadata;
@@@ -2206,10 -2203,11 +2209,11 @@@ static int esw_offloads_stop(struct mlx
  void esw_offloads_disable(struct mlx5_eswitch *esw)
  {
  	esw_offloads_devcom_cleanup(esw);
 +	esw_offloads_unload_all_reps(esw);
  	mlx5_eswitch_disable_pf_vf_vports(esw);
 -	esw_offloads_unload_rep(esw, MLX5_VPORT_UPLINK);
  	esw_set_passing_vport_metadata(esw, false);
  	esw_offloads_steering_cleanup(esw);
+ 	esw->flags &= ~MLX5_ESWITCH_VPORT_MATCH_METADATA;
  	mlx5_rdma_disable_roce(esw->dev);
  	mutex_destroy(&esw->offloads.termtbl_mutex);
  	esw->offloads.encap = DEVLINK_ESWITCH_ENCAP_MODE_NONE;
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/eswitch_offloads.c
