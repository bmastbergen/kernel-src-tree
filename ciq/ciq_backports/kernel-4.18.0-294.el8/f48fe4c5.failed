rcu/nocb: Don't wake no-CBs GP kthread if timer posted under overload

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-294.el8
commit-author Paul E. McKenney <paulmck@linux.ibm.com>
commit f48fe4c586604c3a09938c6a6e9fd3356dfe8f3c
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-294.el8/f48fe4c5.failed

When under overload conditions, __call_rcu_nocb_wake() will wake the
no-CBs GP kthread any time the no-CBs CB kthread is asleep or there
are no ready-to-invoke callbacks, but only after a timer delay.  If the
no-CBs GP kthread has a ->nocb_bypass_timer pending, the deferred wakeup
from __call_rcu_nocb_wake() is redundant.  This commit therefore makes
__call_rcu_nocb_wake() avoid posting the redundant deferred wakeup if
->nocb_bypass_timer is pending.  This requires adding a bit of ordering
of timer actions.

	Signed-off-by: Paul E. McKenney <paulmck@linux.ibm.com>
(cherry picked from commit f48fe4c586604c3a09938c6a6e9fd3356dfe8f3c)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	kernel/rcu/tree_plugin.h
diff --cc kernel/rcu/tree_plugin.h
index c7952848f1c8,2defc7fe74c3..000000000000
--- a/kernel/rcu/tree_plugin.h
+++ b/kernel/rcu/tree_plugin.h
@@@ -1692,6 -1923,18 +1694,21 @@@ static void __call_rcu_nocb_wake(struc
  	return;
  }
  
++<<<<<<< HEAD
++=======
+ /* Wake up the no-CBs GP kthread to flush ->nocb_bypass. */
+ static void do_nocb_bypass_wakeup_timer(struct timer_list *t)
+ {
+ 	unsigned long flags;
+ 	struct rcu_data *rdp = from_timer(rdp, t, nocb_bypass_timer);
+ 
+ 	trace_rcu_nocb_wake(rcu_state.name, rdp->cpu, TPS("Timer"));
+ 	rcu_nocb_lock_irqsave(rdp, flags);
+ 	smp_mb__after_spinlock(); /* Timer expire before wakeup. */
+ 	__call_rcu_nocb_wake(rdp, true, flags);
+ }
+ 
++>>>>>>> f48fe4c58660 (rcu/nocb: Don't wake no-CBs GP kthread if timer posted under overload)
  /*
   * No-CBs GP kthreads come here to wait for additional callbacks to show up
   * or for grace periods to end.
* Unmerged path kernel/rcu/tree_plugin.h
