ima: add a new CONFIG for loading arch-specific policies

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-294.el8
commit-author Nayna Jain <nayna@linux.ibm.com>
commit 9e2b4be377f0d715d9d910507890f9620cc22a9d
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-294.el8/9e2b4be3.failed

Every time a new architecture defines the IMA architecture specific
functions - arch_ima_get_secureboot() and arch_ima_get_policy(), the IMA
include file needs to be updated. To avoid this "noise", this patch
defines a new IMA Kconfig IMA_SECURE_AND_OR_TRUSTED_BOOT option, allowing
the different architectures to select it.

	Suggested-by: Linus Torvalds <torvalds@linux-foundation.org>
	Signed-off-by: Nayna Jain <nayna@linux.ibm.com>
	Acked-by: Ard Biesheuvel <ardb@kernel.org>
	Acked-by: Philipp Rudo <prudo@linux.ibm.com> (s390)
	Acked-by: Michael Ellerman <mpe@ellerman.id.au> (powerpc)
	Signed-off-by: Mimi Zohar <zohar@linux.ibm.com>
(cherry picked from commit 9e2b4be377f0d715d9d910507890f9620cc22a9d)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/s390/kernel/Makefile
#	arch/x86/Kconfig
#	include/linux/ima.h
#	security/integrity/ima/Kconfig
diff --cc arch/s390/kernel/Makefile
index 53dd459525db,578a6fa82ea4..000000000000
--- a/arch/s390/kernel/Makefile
+++ b/arch/s390/kernel/Makefile
@@@ -76,6 -70,8 +76,11 @@@ obj-$(CONFIG_UPROBES)		+= uprobes.
  obj-$(CONFIG_KEXEC_FILE)	+= machine_kexec_file.o kexec_image.o
  obj-$(CONFIG_KEXEC_FILE)	+= kexec_elf.o
  
++<<<<<<< HEAD
++=======
+ obj-$(CONFIG_IMA_SECURE_AND_OR_TRUSTED_BOOT)	+= ima_arch.o
+ 
++>>>>>>> 9e2b4be377f0 (ima: add a new CONFIG for loading arch-specific policies)
  obj-$(CONFIG_PERF_EVENTS)	+= perf_event.o perf_cpum_cf_common.o
  obj-$(CONFIG_PERF_EVENTS)	+= perf_cpum_cf.o perf_cpum_sf.o
  obj-$(CONFIG_PERF_EVENTS)	+= perf_cpum_cf_events.o perf_regs.o
diff --cc arch/x86/Kconfig
index 3fc0a4c91af5,dcf5b1729f7c..000000000000
--- a/arch/x86/Kconfig
+++ b/arch/x86/Kconfig
@@@ -219,6 -229,8 +219,11 @@@ config X8
  	select USER_STACKTRACE_SUPPORT
  	select VIRT_TO_BUS
  	select X86_FEATURE_NAMES		if PROC_FS
++<<<<<<< HEAD
++=======
+ 	select PROC_PID_ARCH_STATUS		if PROC_FS
+ 	imply IMA_SECURE_AND_OR_TRUSTED_BOOT    if EFI
++>>>>>>> 9e2b4be377f0 (ima: add a new CONFIG for loading arch-specific policies)
  
  config INSTRUCTION_DECODER
  	def_bool y
diff --cc include/linux/ima.h
index 6d70c35a6cc3,aefe758f4466..000000000000
--- a/include/linux/ima.h
+++ b/include/linux/ima.h
@@@ -31,8 -30,7 +31,12 @@@ extern void ima_kexec_cmdline(const voi
  extern void ima_add_kexec_buffer(struct kimage *image);
  #endif
  
++<<<<<<< HEAD
 +#if ((defined(CONFIG_X86) && defined(CONFIG_EFI)) \
 +	|| defined(CONFIG_PPC_SECURE_BOOT))
++=======
+ #ifdef CONFIG_IMA_SECURE_AND_OR_TRUSTED_BOOT
++>>>>>>> 9e2b4be377f0 (ima: add a new CONFIG for loading arch-specific policies)
  extern bool arch_ima_get_secureboot(void);
  extern const char * const *arch_get_ima_policy(void);
  #else
diff --cc security/integrity/ima/Kconfig
index cf08f2c73f84,edde88dbe576..000000000000
--- a/security/integrity/ima/Kconfig
+++ b/security/integrity/ima/Kconfig
@@@ -309,3 -315,22 +309,25 @@@ config IMA_APPRAISE_SIGNED_INI
  	default n
  	help
  	   This option requires user-space init to be signed.
++<<<<<<< HEAD
++=======
+ 
+ config IMA_MEASURE_ASYMMETRIC_KEYS
+ 	bool
+ 	depends on IMA
+ 	depends on ASYMMETRIC_PUBLIC_KEY_SUBTYPE=y
+ 	default y
+ 
+ config IMA_QUEUE_EARLY_BOOT_KEYS
+ 	bool
+ 	depends on IMA_MEASURE_ASYMMETRIC_KEYS
+ 	depends on SYSTEM_TRUSTED_KEYRING
+ 	default y
+ 
+ config IMA_SECURE_AND_OR_TRUSTED_BOOT
+        bool
+        depends on IMA_ARCH_POLICY
+        help
+           This option is selected by architectures to enable secure and/or
+           trusted boot based on IMA runtime policies.
++>>>>>>> 9e2b4be377f0 (ima: add a new CONFIG for loading arch-specific policies)
diff --git a/arch/powerpc/Kconfig b/arch/powerpc/Kconfig
index f95f7924e00e..39ffa8cfcdc6 100644
--- a/arch/powerpc/Kconfig
+++ b/arch/powerpc/Kconfig
@@ -909,6 +909,7 @@ config PPC_SECURE_BOOT
 	bool
 	depends on PPC_POWERNV
 	depends on IMA_ARCH_POLICY
+	imply IMA_SECURE_AND_OR_TRUSTED_BOOT
 	help
 	  Systems with firmware secure boot enabled need to define security
 	  policies to extend secure boot to the OS. This config allows a user
diff --git a/arch/s390/Kconfig b/arch/s390/Kconfig
index 247a8ecc8c7b..e26f718facb5 100644
--- a/arch/s390/Kconfig
+++ b/arch/s390/Kconfig
@@ -180,6 +180,7 @@ config S390
 	select ARCH_HAS_FORCE_DMA_UNENCRYPTED
 	select SWIOTLB
 	select GENERIC_ALLOCATOR
+	imply IMA_SECURE_AND_OR_TRUSTED_BOOT
 
 
 config SCHED_OMIT_FRAME_POINTER
* Unmerged path arch/s390/kernel/Makefile
* Unmerged path arch/x86/Kconfig
diff --git a/arch/x86/kernel/Makefile b/arch/x86/kernel/Makefile
index bddda128283a..2307dae00c30 100644
--- a/arch/x86/kernel/Makefile
+++ b/arch/x86/kernel/Makefile
@@ -152,6 +152,4 @@ ifeq ($(CONFIG_X86_64),y)
 	obj-y				+= vsmp_64.o
 endif
 
-ifdef CONFIG_EFI
-obj-$(CONFIG_IMA)			+= ima_arch.o
-endif
+obj-$(CONFIG_IMA_SECURE_AND_OR_TRUSTED_BOOT)	+= ima_arch.o
* Unmerged path include/linux/ima.h
* Unmerged path security/integrity/ima/Kconfig
