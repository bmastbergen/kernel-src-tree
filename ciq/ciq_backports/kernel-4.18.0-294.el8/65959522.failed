RDMA: Add support to dump resource tracker in RAW format

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-294.el8
commit-author Maor Gottlieb <maorg@mellanox.com>
commit 65959522f8060659e308977f09f3eb7b7af5e43f
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-294.el8/65959522.failed

Add support to get resource dump in raw format. It enable drivers to
return the entire device specific QP/CQ/MR context without a need from the
driver to set each field separately.

The raw query returns only the device specific data, general data is still
returned by using the existing queries.

Example:

$ rdma res show mr dev mlx5_1 mrn 2 -r -j
[{"ifindex":7,"ifname":"mlx5_1",
"data":[0,4,255,254,0,0,0,0,0,0,0,0,16,28,0,216,...]}]

Link: https://lore.kernel.org/r/20200623113043.1228482-9-leon@kernel.org
	Signed-off-by: Maor Gottlieb <maorg@mellanox.com>
	Signed-off-by: Leon Romanovsky <leonro@mellanox.com>
	Signed-off-by: Jason Gunthorpe <jgg@nvidia.com>
(cherry picked from commit 65959522f8060659e308977f09f3eb7b7af5e43f)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/core/device.c
#	drivers/infiniband/core/nldev.c
#	include/rdma/ib_verbs.h
diff --cc drivers/infiniband/core/device.c
index a0fc4c9c3c66,1335ed1f1e4a..000000000000
--- a/drivers/infiniband/core/device.c
+++ b/drivers/infiniband/core/device.c
@@@ -2605,8 -2617,13 +2605,18 @@@ void ib_set_device_ops(struct ib_devic
  	SET_DEVICE_OP(dev_ops, drain_rq);
  	SET_DEVICE_OP(dev_ops, drain_sq);
  	SET_DEVICE_OP(dev_ops, enable_driver);
++<<<<<<< HEAD
 +	SET_DEVICE_OP(dev_ops, fill_res_entry);
 +	SET_DEVICE_OP(dev_ops, fill_res_mr_entry);
++=======
+ 	SET_DEVICE_OP(dev_ops, fill_res_cm_id_entry);
+ 	SET_DEVICE_OP(dev_ops, fill_res_cq_entry);
+ 	SET_DEVICE_OP(dev_ops, fill_res_cq_entry_raw);
+ 	SET_DEVICE_OP(dev_ops, fill_res_mr_entry);
+ 	SET_DEVICE_OP(dev_ops, fill_res_mr_entry_raw);
+ 	SET_DEVICE_OP(dev_ops, fill_res_qp_entry);
+ 	SET_DEVICE_OP(dev_ops, fill_res_qp_entry_raw);
++>>>>>>> 65959522f806 (RDMA: Add support to dump resource tracker in RAW format)
  	SET_DEVICE_OP(dev_ops, fill_stat_mr_entry);
  	SET_DEVICE_OP(dev_ops, get_dev_fw_str);
  	SET_DEVICE_OP(dev_ops, get_dma_mr);
diff --cc drivers/infiniband/core/nldev.c
index a4f3f838d6fe,1051b5622b62..000000000000
--- a/drivers/infiniband/core/nldev.c
+++ b/drivers/infiniband/core/nldev.c
@@@ -446,19 -447,11 +447,24 @@@ static int fill_res_name_pid(struct sk_
  	return err ? -EMSGSIZE : 0;
  }
  
++<<<<<<< HEAD
 +static bool fill_res_entry(struct ib_device *dev, struct sk_buff *msg,
 +			   struct rdma_restrack_entry *res)
 +{
 +	if (!dev->ops.fill_res_entry)
 +		return false;
 +	return dev->ops.fill_res_entry(msg, res);
 +}
 +
 +static int fill_res_qp_entry(struct sk_buff *msg, bool has_cap_net_admin,
 +			     struct rdma_restrack_entry *res, uint32_t port)
++=======
+ static int fill_res_qp_entry_query(struct sk_buff *msg,
+ 				   struct rdma_restrack_entry *res,
+ 				   struct ib_device *dev,
+ 				   struct ib_qp *qp)
++>>>>>>> 65959522f806 (RDMA: Add support to dump resource tracker in RAW format)
  {
- 	struct ib_qp *qp = container_of(res, struct ib_qp, res);
- 	struct ib_device *dev = qp->device;
  	struct ib_qp_init_attr qp_init_attr;
  	struct ib_qp_attr qp_attr;
  	int ret;
@@@ -500,16 -483,8 +496,21 @@@
  	if (nla_put_u8(msg, RDMA_NLDEV_ATTR_RES_STATE, qp_attr.qp_state))
  		goto err;
  
++<<<<<<< HEAD
 +	if (!rdma_is_kernel_res(res) &&
 +	    nla_put_u32(msg, RDMA_NLDEV_ATTR_RES_PDN, qp->pd->res.id))
 +		goto err;
 +
 +	if (fill_res_name_pid(msg, res))
 +		goto err;
 +
 +	if (fill_res_entry(dev, msg, res))
 +		goto err;
 +
++=======
+ 	if (dev->ops.fill_res_qp_entry)
+ 		return dev->ops.fill_res_qp_entry(msg, qp);
++>>>>>>> 65959522f806 (RDMA: Add support to dump resource tracker in RAW format)
  	return 0;
  
  err:	return -EMSGSIZE;
@@@ -593,17 -609,24 +636,31 @@@ static int fill_res_cq_entry(struct sk_
  	if (!rdma_is_kernel_res(res) &&
  	    nla_put_u32(msg, RDMA_NLDEV_ATTR_RES_CTXN,
  			cq->uobject->uevent.uobject.context->res.id))
- 		goto err;
+ 		return -EMSGSIZE;
  
  	if (fill_res_name_pid(msg, res))
- 		goto err;
+ 		return -EMSGSIZE;
  
++<<<<<<< HEAD
 +	if (fill_res_entry(dev, msg, res))
 +		goto err;
 +
 +	return 0;
++=======
+ 	return (dev->ops.fill_res_cq_entry) ?
+ 		dev->ops.fill_res_cq_entry(msg, cq) : 0;
+ }
++>>>>>>> 65959522f806 (RDMA: Add support to dump resource tracker in RAW format)
  
- err:	return -EMSGSIZE;
+ static int fill_res_cq_raw_entry(struct sk_buff *msg, bool has_cap_net_admin,
+ 				 struct rdma_restrack_entry *res, uint32_t port)
+ {
+ 	struct ib_cq *cq = container_of(res, struct ib_cq, res);
+ 	struct ib_device *dev = cq->device;
+ 
+ 	if (!dev->ops.fill_res_cq_entry_raw)
+ 		return -EINVAL;
+ 	return dev->ops.fill_res_cq_entry_raw(msg, cq);
  }
  
  static int fill_res_mr_entry(struct sk_buff *msg, bool has_cap_net_admin,
diff --cc include/rdma/ib_verbs.h
index f21dc2571341,77106ff3cd26..000000000000
--- a/include/rdma/ib_verbs.h
+++ b/include/rdma/ib_verbs.h
@@@ -2589,9 -2582,13 +2589,18 @@@ struct ib_device_ops 
  	/**
  	 * Allows rdma drivers to add their own restrack attributes.
  	 */
 +	int (*fill_res_entry)(struct sk_buff *msg,
 +			      struct rdma_restrack_entry *entry);
  	int (*fill_res_mr_entry)(struct sk_buff *msg, struct ib_mr *ibmr);
++<<<<<<< HEAD
++=======
+ 	int (*fill_res_mr_entry_raw)(struct sk_buff *msg, struct ib_mr *ibmr);
+ 	int (*fill_res_cq_entry)(struct sk_buff *msg, struct ib_cq *ibcq);
+ 	int (*fill_res_cq_entry_raw)(struct sk_buff *msg, struct ib_cq *ibcq);
+ 	int (*fill_res_qp_entry)(struct sk_buff *msg, struct ib_qp *ibqp);
+ 	int (*fill_res_qp_entry_raw)(struct sk_buff *msg, struct ib_qp *ibqp);
+ 	int (*fill_res_cm_id_entry)(struct sk_buff *msg, struct rdma_cm_id *id);
++>>>>>>> 65959522f806 (RDMA: Add support to dump resource tracker in RAW format)
  
  	/* Device lifecycle callbacks */
  	/*
* Unmerged path drivers/infiniband/core/device.c
* Unmerged path drivers/infiniband/core/nldev.c
* Unmerged path include/rdma/ib_verbs.h
diff --git a/include/uapi/rdma/rdma_netlink.h b/include/uapi/rdma/rdma_netlink.h
index 8e277783fa96..3826143d420d 100644
--- a/include/uapi/rdma/rdma_netlink.h
+++ b/include/uapi/rdma/rdma_netlink.h
@@ -287,6 +287,12 @@ enum rdma_nldev_command {
 
 	RDMA_NLDEV_CMD_STAT_DEL,
 
+	RDMA_NLDEV_CMD_RES_QP_GET_RAW,
+
+	RDMA_NLDEV_CMD_RES_CQ_GET_RAW,
+
+	RDMA_NLDEV_CMD_RES_MR_GET_RAW,
+
 	RDMA_NLDEV_NUM_OPS
 };
 
@@ -525,6 +531,8 @@ enum rdma_nldev_attr {
 	 */
 	RDMA_NLDEV_ATTR_DEV_DIM,                /* u8 */
 
+	RDMA_NLDEV_ATTR_RES_RAW,	/* binary */
+
 	/*
 	 * Always the end
 	 */
