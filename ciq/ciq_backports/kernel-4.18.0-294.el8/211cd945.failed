RDMA: Add dedicated CM_ID resource tracker function

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-294.el8
commit-author Maor Gottlieb <maorg@mellanox.com>
commit 211cd9459fdabe9f556e539966f50825853bf262
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-294.el8/211cd945.failed

In order to avoid double multiplexing of the resource when it is a cm id,
add a dedicated callback function. In addition remove fill_res_entry which
is not used anymore.

Link: https://lore.kernel.org/r/20200623113043.1228482-8-leon@kernel.org
	Signed-off-by: Maor Gottlieb <maorg@mellanox.com>
	Signed-off-by: Leon Romanovsky <leonro@mellanox.com>
	Signed-off-by: Jason Gunthorpe <jgg@nvidia.com>
(cherry picked from commit 211cd9459fdabe9f556e539966f50825853bf262)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/core/device.c
#	drivers/infiniband/hw/cxgb4/iw_cxgb4.h
#	drivers/infiniband/hw/cxgb4/provider.c
#	drivers/infiniband/hw/cxgb4/restrack.c
#	include/rdma/ib_verbs.h
diff --cc drivers/infiniband/core/device.c
index a0fc4c9c3c66,cbe95e729cf1..000000000000
--- a/drivers/infiniband/core/device.c
+++ b/drivers/infiniband/core/device.c
@@@ -2605,8 -2617,10 +2605,13 @@@ void ib_set_device_ops(struct ib_devic
  	SET_DEVICE_OP(dev_ops, drain_rq);
  	SET_DEVICE_OP(dev_ops, drain_sq);
  	SET_DEVICE_OP(dev_ops, enable_driver);
++<<<<<<< HEAD
 +	SET_DEVICE_OP(dev_ops, fill_res_entry);
++=======
+ 	SET_DEVICE_OP(dev_ops, fill_res_cm_id_entry);
+ 	SET_DEVICE_OP(dev_ops, fill_res_cq_entry);
++>>>>>>> 211cd9459fda (RDMA: Add dedicated CM_ID resource tracker function)
  	SET_DEVICE_OP(dev_ops, fill_res_mr_entry);
 -	SET_DEVICE_OP(dev_ops, fill_res_qp_entry);
  	SET_DEVICE_OP(dev_ops, fill_stat_mr_entry);
  	SET_DEVICE_OP(dev_ops, get_dev_fw_str);
  	SET_DEVICE_OP(dev_ops, get_dma_mr);
diff --cc drivers/infiniband/hw/cxgb4/iw_cxgb4.h
index ab603a2f475e,27da0705c88a..000000000000
--- a/drivers/infiniband/hw/cxgb4/iw_cxgb4.h
+++ b/drivers/infiniband/hw/cxgb4/iw_cxgb4.h
@@@ -1108,9 -1053,9 +1108,13 @@@ int c4iw_post_srq_recv(struct ib_srq *i
  		       const struct ib_recv_wr **bad_wr);
  struct c4iw_wr_wait *c4iw_alloc_wr_wait(gfp_t gfp);
  
- typedef int c4iw_restrack_func(struct sk_buff *msg,
- 			       struct rdma_restrack_entry *res);
  int c4iw_fill_res_mr_entry(struct sk_buff *msg, struct ib_mr *ibmr);
++<<<<<<< HEAD
 +extern c4iw_restrack_func *c4iw_restrack_funcs[RDMA_RESTRACK_MAX];
++=======
+ int c4iw_fill_res_cq_entry(struct sk_buff *msg, struct ib_cq *ibcq);
+ int c4iw_fill_res_qp_entry(struct sk_buff *msg, struct ib_qp *ibqp);
+ int c4iw_fill_res_cm_id_entry(struct sk_buff *msg, struct rdma_cm_id *cm_id);
++>>>>>>> 211cd9459fda (RDMA: Add dedicated CM_ID resource tracker function)
  
  #endif
diff --cc drivers/infiniband/hw/cxgb4/provider.c
index c6e52f487ae5,1d3ff59e4060..000000000000
--- a/drivers/infiniband/hw/cxgb4/provider.c
+++ b/drivers/infiniband/hw/cxgb4/provider.c
@@@ -485,7 -478,8 +478,12 @@@ static const struct ib_device_ops c4iw_
  	.destroy_cq = c4iw_destroy_cq,
  	.destroy_qp = c4iw_destroy_qp,
  	.destroy_srq = c4iw_destroy_srq,
++<<<<<<< HEAD
 +	.fill_res_entry = fill_res_entry,
++=======
+ 	.fill_res_cq_entry = c4iw_fill_res_cq_entry,
+ 	.fill_res_cm_id_entry = c4iw_fill_res_cm_id_entry,
++>>>>>>> 211cd9459fda (RDMA: Add dedicated CM_ID resource tracker function)
  	.fill_res_mr_entry = c4iw_fill_res_mr_entry,
  	.get_dev_fw_str = get_dev_fw_str,
  	.get_dma_mr = c4iw_get_dma_mr,
diff --cc drivers/infiniband/hw/cxgb4/restrack.c
index 9a5ca9192c1c,b32e6516d65f..000000000000
--- a/drivers/infiniband/hw/cxgb4/restrack.c
+++ b/drivers/infiniband/hw/cxgb4/restrack.c
@@@ -490,9 -485,3 +489,12 @@@ err_cancel_table
  err:
  	return -EMSGSIZE;
  }
++<<<<<<< HEAD
 +
 +c4iw_restrack_func *c4iw_restrack_funcs[RDMA_RESTRACK_MAX] = {
 +	[RDMA_RESTRACK_QP]	= fill_res_qp_entry,
 +	[RDMA_RESTRACK_CM_ID]	= fill_res_ep_entry,
 +	[RDMA_RESTRACK_CQ]	= fill_res_cq_entry,
 +};
++=======
++>>>>>>> 211cd9459fda (RDMA: Add dedicated CM_ID resource tracker function)
diff --cc include/rdma/ib_verbs.h
index f21dc2571341,9127cffafccd..000000000000
--- a/include/rdma/ib_verbs.h
+++ b/include/rdma/ib_verbs.h
@@@ -2589,9 -2582,10 +2590,13 @@@ struct ib_device_ops 
  	/**
  	 * Allows rdma drivers to add their own restrack attributes.
  	 */
- 	int (*fill_res_entry)(struct sk_buff *msg,
- 			      struct rdma_restrack_entry *entry);
  	int (*fill_res_mr_entry)(struct sk_buff *msg, struct ib_mr *ibmr);
++<<<<<<< HEAD
++=======
+ 	int (*fill_res_cq_entry)(struct sk_buff *msg, struct ib_cq *ibcq);
+ 	int (*fill_res_qp_entry)(struct sk_buff *msg, struct ib_qp *ibqp);
+ 	int (*fill_res_cm_id_entry)(struct sk_buff *msg, struct rdma_cm_id *id);
++>>>>>>> 211cd9459fda (RDMA: Add dedicated CM_ID resource tracker function)
  
  	/* Device lifecycle callbacks */
  	/*
* Unmerged path drivers/infiniband/core/device.c
diff --git a/drivers/infiniband/core/nldev.c b/drivers/infiniband/core/nldev.c
index a4f3f838d6fe..5df5f3032600 100644
--- a/drivers/infiniband/core/nldev.c
+++ b/drivers/infiniband/core/nldev.c
@@ -446,14 +446,6 @@ static int fill_res_name_pid(struct sk_buff *msg,
 	return err ? -EMSGSIZE : 0;
 }
 
-static bool fill_res_entry(struct ib_device *dev, struct sk_buff *msg,
-			   struct rdma_restrack_entry *res)
-{
-	if (!dev->ops.fill_res_entry)
-		return false;
-	return dev->ops.fill_res_entry(msg, res);
-}
-
 static int fill_res_qp_entry(struct sk_buff *msg, bool has_cap_net_admin,
 			     struct rdma_restrack_entry *res, uint32_t port)
 {
@@ -560,9 +552,8 @@ static int fill_res_cm_id_entry(struct sk_buff *msg, bool has_cap_net_admin,
 	if (fill_res_name_pid(msg, res))
 		goto err;
 
-	if (fill_res_entry(dev, msg, res))
-		goto err;
-
+	if (dev->ops.fill_res_cm_id_entry)
+		return dev->ops.fill_res_cm_id_entry(msg, cm_id);
 	return 0;
 
 err: return -EMSGSIZE;
* Unmerged path drivers/infiniband/hw/cxgb4/iw_cxgb4.h
* Unmerged path drivers/infiniband/hw/cxgb4/provider.c
* Unmerged path drivers/infiniband/hw/cxgb4/restrack.c
* Unmerged path include/rdma/ib_verbs.h
