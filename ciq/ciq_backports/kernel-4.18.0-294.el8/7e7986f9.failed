block: use gcd() to fix chunk_sectors limit stacking

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-294.el8
commit-author Mike Snitzer <snitzer@redhat.com>
commit 7e7986f9d3ba69a7375a41080a1f8c8012cb0923
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-294.el8/7e7986f9.failed

commit 22ada802ede8 ("block: use lcm_not_zero() when stacking
chunk_sectors") broke chunk_sectors limit stacking. chunk_sectors must
reflect the most limited of all devices in the IO stack.

Otherwise malformed IO may result. E.g.: prior to this fix,
->chunk_sectors = lcm_not_zero(8, 128) would result in
blk_max_size_offset() splitting IO at 128 sectors rather than the
required more restrictive 8 sectors.

And since commit 07d098e6bbad ("block: allow 'chunk_sectors' to be
non-power-of-2") care must be taken to properly stack chunk_sectors to
be compatible with the possibility that a non-power-of-2 chunk_sectors
may be stacked. This is why gcd() is used instead of reverting back
to using min_not_zero().

Fixes: 22ada802ede8 ("block: use lcm_not_zero() when stacking chunk_sectors")
Fixes: 07d098e6bbad ("block: allow 'chunk_sectors' to be non-power-of-2")
	Reported-by: John Dorminy <jdorminy@redhat.com>
	Reported-by: Bruce Johnston <bjohnsto@redhat.com>
	Signed-off-by: Mike Snitzer <snitzer@redhat.com>
	Reviewed-by: John Dorminy <jdorminy@redhat.com>
	Cc: stable@vger.kernel.org
	Reviewed-by: Martin K. Petersen <martin.petersen@oracle.com>
	Signed-off-by: Jens Axboe <axboe@kernel.dk>
(cherry picked from commit 7e7986f9d3ba69a7375a41080a1f8c8012cb0923)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	block/blk-settings.c
diff --cc block/blk-settings.c
index a365f3bd6d1f,659cdb8a07fe..000000000000
--- a/block/blk-settings.c
+++ b/block/blk-settings.c
@@@ -545,7 -548,9 +545,13 @@@ int blk_stack_limits(struct queue_limit
  	t->io_min = max(t->io_min, b->io_min);
  	t->io_opt = lcm_not_zero(t->io_opt, b->io_opt);
  
++<<<<<<< HEAD
 +	t->cluster &= b->cluster;
++=======
+ 	/* Set non-power-of-2 compatible chunk_sectors boundary */
+ 	if (b->chunk_sectors)
+ 		t->chunk_sectors = gcd(t->chunk_sectors, b->chunk_sectors);
++>>>>>>> 7e7986f9d3ba (block: use gcd() to fix chunk_sectors limit stacking)
  
  	/* Physical block size a multiple of the logical block size? */
  	if (t->physical_block_size & (t->logical_block_size - 1)) {
* Unmerged path block/blk-settings.c
