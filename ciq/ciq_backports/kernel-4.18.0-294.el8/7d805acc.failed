powerpc/64s: remove unnecessary translation cache flushes at boot

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-294.el8
commit-author Nicholas Piggin <npiggin@gmail.com>
commit 7d805accbec57a151bd0dd305a1109feebdfd4a4
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-294.el8/7d805acc.failed

The various translation structure invalidations performed in early boot
when the MMU is off are not required, because everything is invalidated
immediately before a CPU first enables its MMU (see early_init_mmu
and early_init_mmu_secondary).

	Signed-off-by: Nicholas Piggin <npiggin@gmail.com>
	Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: https://lore.kernel.org/r/20190902152931.17840-6-npiggin@gmail.com
(cherry picked from commit 7d805accbec57a151bd0dd305a1109feebdfd4a4)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/powerpc/mm/book3s64/hash_utils.c
#	arch/powerpc/mm/book3s64/pgtable.c
#	arch/powerpc/mm/book3s64/radix_pgtable.c
#	arch/powerpc/platforms/pseries/lpar.c
diff --cc arch/powerpc/mm/book3s64/hash_utils.c
index c7f37e28c477,7684a596158b..000000000000
--- a/arch/powerpc/mm/book3s64/hash_utils.c
+++ b/arch/powerpc/mm/book3s64/hash_utils.c
@@@ -837,7 -825,7 +837,11 @@@ static void __init hash_init_partition_
  	 * For now, UPRT is 0 and we have no segment table.
  	 */
  	htab_size =  __ilog2(htab_size) - 18;
++<<<<<<< HEAD
 +	mmu_partition_table_set_entry(0, hash_table | htab_size, 0);
++=======
+ 	mmu_partition_table_set_entry(0, hash_table | htab_size, 0, false);
++>>>>>>> 7d805accbec5 (powerpc/64s: remove unnecessary translation cache flushes at boot)
  	pr_info("Partition table %p\n", partition_tb);
  }
  
diff --cc arch/powerpc/mm/book3s64/pgtable.c
index e3da07e289f2,351eb78eed55..000000000000
--- a/arch/powerpc/mm/book3s64/pgtable.c
+++ b/arch/powerpc/mm/book3s64/pgtable.c
@@@ -266,7 -251,12 +266,16 @@@ void mmu_partition_table_set_entry(unsi
  		uv_register_pate(lpid, dw0, dw1);
  		pr_info("PATE registered by ultravisor: dw0 = 0x%lx, dw1 = 0x%lx\n",
  			dw0, dw1);
++<<<<<<< HEAD
 +	} else {
++=======
+ 	} else if (flush) {
+ 		/*
+ 		 * Boot does not need to flush, because MMU is off and each
+ 		 * CPU does a tlbiel_all() before switching them on, which
+ 		 * flushes everything.
+ 		 */
++>>>>>>> 7d805accbec5 (powerpc/64s: remove unnecessary translation cache flushes at boot)
  		flush_partition(lpid, (old & PATB_HR));
  	}
  }
diff --cc arch/powerpc/mm/book3s64/radix_pgtable.c
index dfe103ed7f93,0d1107fb34c1..000000000000
--- a/arch/powerpc/mm/book3s64/radix_pgtable.c
+++ b/arch/powerpc/mm/book3s64/radix_pgtable.c
@@@ -418,7 -395,8 +418,12 @@@ static void __init radix_init_partition
  	mmu_partition_table_init();
  	rts_field = radix__get_tree_size();
  	dw0 = rts_field | __pa(init_mm.pgd) | RADIX_PGD_INDEX_SIZE | PATB_HR;
++<<<<<<< HEAD
 +	mmu_partition_table_set_entry(0, dw0, 0);
++=======
+ 	dw1 = __pa(process_tb) | (PRTB_SIZE_SHIFT - 12) | PATB_GR;
+ 	mmu_partition_table_set_entry(0, dw0, dw1, false);
++>>>>>>> 7d805accbec5 (powerpc/64s: remove unnecessary translation cache flushes at boot)
  
  	pr_info("Initializing Radix MMU\n");
  	pr_info("Partition table %p\n", partition_tb);
diff --cc arch/powerpc/platforms/pseries/lpar.c
index eb48a724ea78,36b846f6e74e..000000000000
--- a/arch/powerpc/platforms/pseries/lpar.c
+++ b/arch/powerpc/platforms/pseries/lpar.c
@@@ -1554,7 -1546,9 +1554,13 @@@ void __init hpte_init_pseries(void
  void radix_init_pseries(void)
  {
  	pr_info("Using radix MMU under hypervisor\n");
++<<<<<<< HEAD
 +	register_process_table = pseries_lpar_register_process_table;
++=======
+ 
+ 	pseries_lpar_register_process_table(__pa(process_tb),
+ 						0, PRTB_SIZE_SHIFT - 12);
++>>>>>>> 7d805accbec5 (powerpc/64s: remove unnecessary translation cache flushes at boot)
  }
  
  #ifdef CONFIG_PPC_SMLPAR
* Unmerged path arch/powerpc/mm/book3s64/hash_utils.c
* Unmerged path arch/powerpc/mm/book3s64/pgtable.c
* Unmerged path arch/powerpc/mm/book3s64/radix_pgtable.c
* Unmerged path arch/powerpc/platforms/pseries/lpar.c
