kbuild: Parameterize kallsyms generation and correct reporting

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-294.el8
commit-author Kees Cook <keescook@chromium.org>
commit 8959e39272d6e625da1cd62f2e7622d79e04447d
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-294.el8/8959e392.failed

When kallsyms generation happens, temporary vmlinux outputs are linked
but the quiet make output didn't report it, giving the impression that
the prior command is taking longer than expected.

Instead, report the linking step explicitly. While at it, this
consolidates the repeated "kallsyms generation step" into a single
function and removes the existing copy/pasting.

	Signed-off-by: Kees Cook <keescook@chromium.org>
	Signed-off-by: Masahiro Yamada <yamada.masahiro@socionext.com>
(cherry picked from commit 8959e39272d6e625da1cd62f2e7622d79e04447d)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	scripts/link-vmlinux.sh
diff --cc scripts/link-vmlinux.sh
index bbfffccf5206,2438a9faf3f1..000000000000
--- a/scripts/link-vmlinux.sh
+++ b/scripts/link-vmlinux.sh
@@@ -79,20 -56,17 +79,21 @@@ modpost_link(
  }
  
  # Link of vmlinux
 -# ${1} - optional extra .o files
 -# ${2} - output file
 +# ${1} - output file
 +# ${2}, ${3}, ... - optional extra .o files
  vmlinux_link()
  {
+ 	info LD ${2}
  	local lds="${objtree}/${KBUILD_LDS}"
 +	local output=${1}
  	local objects
  
 +	# skip output file argument
 +	shift
 +
  	if [ "${SRCARCH}" != "um" ]; then
  		objects="--whole-archive			\
 -			${KBUILD_VMLINUX_OBJS}			\
 +			built-in.a				\
  			--no-whole-archive			\
  			--start-group				\
  			${KBUILD_VMLINUX_LIBS}			\
@@@ -265,20 -223,13 +278,21 @@@ info LD vmlinux.
  modpost_link vmlinux.o
  
  # modpost vmlinux.o to check for section mismatches
 -${MAKE} -f "${srctree}/scripts/Makefile.modpost" MODPOST_VMLINUX=1
 +${MAKE} -f "${srctree}/scripts/Makefile.modpost" vmlinux.o
  
 -info MODINFO modules.builtin.modinfo
 -${OBJCOPY} -j .modinfo -O binary vmlinux.o modules.builtin.modinfo
 +btf_vmlinux_bin_o=""
 +if [ -n "${CONFIG_DEBUG_INFO_BTF}" ]; then
 +	if gen_btf .tmp_vmlinux.btf .btf.vmlinux.bin.o ; then
 +		btf_vmlinux_bin_o=.btf.vmlinux.bin.o
 +	else
 +		echo >&2 "Failed to generate BTF for vmlinux"
 +		echo >&2 "Try to disable CONFIG_DEBUG_INFO_BTF"
 +		exit 1
 +	fi
 +fi
  
  kallsymso=""
+ kallsymso_prev=""
  kallsyms_vmlinux=""
  if [ -n "${CONFIG_KALLSYMS}" ]; then
  
@@@ -305,32 -256,23 +319,49 @@@
  	# a)  Verify that the System.map from vmlinux matches the map from
  	#     ${kallsymso}.
  
++<<<<<<< HEAD
 +	kallsymso=.tmp_kallsyms2.o
 +	kallsyms_vmlinux=.tmp_vmlinux2
 +
 +	# step 1
 +	vmlinux_link .tmp_vmlinux1 ${btf_vmlinux_bin_o}
 +	kallsyms .tmp_vmlinux1 .tmp_kallsyms1.o
 +
 +	# step 2
 +	vmlinux_link .tmp_vmlinux2 .tmp_kallsyms1.o ${btf_vmlinux_bin_o}
 +	kallsyms .tmp_vmlinux2 .tmp_kallsyms2.o
++=======
+ 	kallsyms_step 1
+ 	kallsyms_step 2
++>>>>>>> 8959e39272d6 (kbuild: Parameterize kallsyms generation and correct reporting)
  
  	# step 3
- 	size1=$(${CONFIG_SHELL} "${srctree}/scripts/file-size.sh" .tmp_kallsyms1.o)
- 	size2=$(${CONFIG_SHELL} "${srctree}/scripts/file-size.sh" .tmp_kallsyms2.o)
+ 	size1=$(${CONFIG_SHELL} "${srctree}/scripts/file-size.sh" ${kallsymso_prev})
+ 	size2=$(${CONFIG_SHELL} "${srctree}/scripts/file-size.sh" ${kallsymso})
  
  	if [ $size1 -ne $size2 ] || [ -n "${KALLSYMS_EXTRA_PASS}" ]; then
++<<<<<<< HEAD
 +		kallsymso=.tmp_kallsyms3.o
 +		kallsyms_vmlinux=.tmp_vmlinux3
 +
 +		vmlinux_link .tmp_vmlinux3 .tmp_kallsyms2.o ${btf_vmlinux_bin_o}
 +		kallsyms .tmp_vmlinux3 .tmp_kallsyms3.o
 +	fi
 +fi
 +
 +info LD vmlinux
 +vmlinux_link vmlinux "${kallsymso}" "${btf_vmlinux_bin_o}"
++=======
+ 		kallsyms_step 3
+ 	fi
+ fi
+ 
+ vmlinux_link "${kallsymso}" vmlinux
+ 
+ if [ -n "${CONFIG_DEBUG_INFO_BTF}" ]; then
+ 	gen_btf vmlinux
+ fi
++>>>>>>> 8959e39272d6 (kbuild: Parameterize kallsyms generation and correct reporting)
  
  if [ -n "${CONFIG_BUILDTIME_EXTABLE_SORT}" ]; then
  	info SORTEX vmlinux
* Unmerged path scripts/link-vmlinux.sh
