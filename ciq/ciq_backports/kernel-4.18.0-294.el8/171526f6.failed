flow_dissector: Pull locking up from prog attach callback

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-294.el8
commit-author Jakub Sitnicki <jakub@cloudflare.com>
commit 171526f6fee84de0c39e2b7aa7e666ba0bbfd173
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-294.el8/171526f6.failed

Split out the part of attach callback that happens with attach/detach lock
acquired. This structures the prog attach callback in a way that opens up
doors for moving the locking out of flow_dissector and into generic
callbacks for attaching/detaching progs to netns in subsequent patches.

	Signed-off-by: Jakub Sitnicki <jakub@cloudflare.com>
	Signed-off-by: Alexei Starovoitov <ast@kernel.org>
	Reviewed-by: Stanislav Fomichev <sdf@google.com>
Link: https://lore.kernel.org/bpf/20200531082846.2117903-2-jakub@cloudflare.com
(cherry picked from commit 171526f6fee84de0c39e2b7aa7e666ba0bbfd173)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/core/flow_dissector.c
diff --cc net/core/flow_dissector.c
index 4f65dd7a24e0,b64a44a083fd..000000000000
--- a/net/core/flow_dissector.c
+++ b/net/core/flow_dissector.c
@@@ -110,17 -109,10 +110,20 @@@ int skb_flow_dissector_prog_query(cons
  	return 0;
  }
  
- int skb_flow_dissector_bpf_prog_attach(const union bpf_attr *attr,
- 				       struct bpf_prog *prog)
+ static int flow_dissector_bpf_prog_attach(struct net *net,
+ 					  struct bpf_prog *prog)
  {
  	struct bpf_prog *attached;
++<<<<<<< HEAD
 +	struct net *net;
 +	int ret = 0;
 +
 +	rh_mark_used_feature("eBPF/flowdissector");
 +
 +	net = current->nsproxy->net_ns;
 +	mutex_lock(&flow_dissector_mutex);
++=======
++>>>>>>> 171526f6fee8 (flow_dissector: Pull locking up from prog attach callback)
  
  	if (net == &init_net) {
  		/* BPF flow dissector in the root namespace overrides
* Unmerged path net/core/flow_dissector.c
