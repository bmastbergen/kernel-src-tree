arm64: vdso: fix flip/flop vdso build bug

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-294.el8
commit-author Naohiro Aota <naohiro.aota@wdc.com>
commit 2e2f3c9b864d9f21fb82aa8da5ac9adc1e020f60
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-294.el8/2e2f3c9b.failed

Running "make" on an already compiled kernel tree will rebuild the kernel
even without any modifications:

$ make ARCH=arm64 CROSS_COMPILE=/usr/bin/aarch64-unknown-linux-gnu-
arch/arm64/Makefile:58: CROSS_COMPILE_COMPAT not defined or empty, the compat vDSO will not be built
  CALL    scripts/checksyscalls.sh
  CALL    scripts/atomic/check-atomics.sh
  VDSOCHK arch/arm64/kernel/vdso/vdso.so.dbg
  VDSOSYM include/generated/vdso-offsets.h
  CHK     include/generated/compile.h
  CC      arch/arm64/kernel/signal.o
  CC      arch/arm64/kernel/vdso.o
  CC      arch/arm64/kernel/signal32.o
  LD      arch/arm64/kernel/vdso/vdso.so.dbg
  OBJCOPY arch/arm64/kernel/vdso/vdso.so
  AS      arch/arm64/kernel/vdso/vdso.o
  AR      arch/arm64/kernel/vdso/built-in.a
  AR      arch/arm64/kernel/built-in.a
  GEN     .version
  CHK     include/generated/compile.h
  UPD     include/generated/compile.h
  CC      init/version.o
  AR      init/built-in.a
  LD      vmlinux.o

This is the same bug fixed in commit 92a4728608a8 ("x86/boot: Fix
if_changed build flip/flop bug"). We cannot use two "if_changed" in one
target. Fix this build bug by merging two commands into one function.

Fixes: a7f71a2c8903 ("arm64: compat: Add vDSO")
Fixes: 28b1a824a4f4 ("arm64: vdso: Substitute gettimeofday() with C implementation")
	Reviewed-by: Masahiro Yamada <yamada.masahiro@socionext.com>
	Reviewed-by: Vincenzo Frascino <vincenzo.frascino@arm.com>
	Tested-by: Vincenzo Frascino <vincenzo.frascino@arm.com>
Co-developed-by: Vincenzo Frascino <vincenzo.frascino@arm.com>
	Signed-off-by: Vincenzo Frascino <vincenzo.frascino@arm.com>
	Signed-off-by: Naohiro Aota <naohiro.aota@wdc.com>
[will: merged in compat fix from Vincenzo and made rule names consistent]
	Signed-off-by: Will Deacon <will@kernel.org>
(cherry picked from commit 2e2f3c9b864d9f21fb82aa8da5ac9adc1e020f60)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/arm64/kernel/vdso/Makefile
diff --cc arch/arm64/kernel/vdso/Makefile
index fa230ff09aa1,75d25679d879..000000000000
--- a/arch/arm64/kernel/vdso/Makefile
+++ b/arch/arm64/kernel/vdso/Makefile
@@@ -27,7 -57,7 +27,11 @@@ $(obj)/vdso.o : $(obj)/vdso.s
  
  # Link rule for the .so file, .lds has to be first
  $(obj)/vdso.so.dbg: $(obj)/vdso.lds $(obj-vdso) FORCE
++<<<<<<< HEAD
 +	$(call if_changed,ld)
++=======
+ 	$(call if_changed,vdsold_and_vdso_check)
++>>>>>>> 2e2f3c9b864d (arm64: vdso: fix flip/flop vdso build bug)
  
  # Strip rule for the .so file
  $(obj)/%.so: OBJCOPYFLAGS := -S
@@@ -42,14 -72,13 +46,17 @@@ quiet_cmd_vdsosym = VDSOSYM $
  include/generated/vdso-offsets.h: $(obj)/vdso.so.dbg FORCE
  	$(call if_changed,vdsosym)
  
 +# Assembly rules for the .S files
 +$(obj-vdso): %.o: %.S FORCE
 +	$(call if_changed_dep,vdsoas)
 +
  # Actual build commands
 -quiet_cmd_vdsocc = VDSOCC   $@
 -      cmd_vdsocc = $(CC) $(a_flags) $(c_flags) -c -o $@ $<
 +quiet_cmd_vdsoas = VDSOA   $@
 +      cmd_vdsoas = $(CC) $(a_flags) -c -o $@ $<
  
+ quiet_cmd_vdsold_and_vdso_check = LD      $@
+       cmd_vdsold_and_vdso_check = $(cmd_ld); $(cmd_vdso_check)
+ 
  # Install commands for the unstripped file
  quiet_cmd_vdso_install = INSTALL $@
        cmd_vdso_install = cp $(obj)/$@.dbg $(MODLIB)/vdso/$@
* Unmerged path arch/arm64/kernel/vdso/Makefile
diff --git a/arch/arm64/kernel/vdso32/Makefile b/arch/arm64/kernel/vdso32/Makefile
index 288c14d30b45..21009ed5a755 100644
--- a/arch/arm64/kernel/vdso32/Makefile
+++ b/arch/arm64/kernel/vdso32/Makefile
@@ -144,8 +144,7 @@ $(obj)/vdso.so.dbg: $(obj)/vdso.so.raw $(obj)/$(munge) FORCE
 
 # Link rule for the .so file, .lds has to be first
 $(obj)/vdso.so.raw: $(src)/vdso.lds $(obj-vdso) FORCE
-	$(call if_changed,vdsold)
-	$(call if_changed,vdso_check)
+	$(call if_changed,vdsold_and_vdso_check)
 
 # Compilation rules for the vDSO sources
 $(c-obj-vdso): %.o: %.c FORCE
@@ -156,6 +155,9 @@ $(asm-obj-vdso): %.o: %.S FORCE
 	$(call if_changed_dep,vdsoas)
 
 # Actual build commands
+quiet_cmd_vdsold_and_vdso_check = LD      $@
+      cmd_vdsold_and_vdso_check = $(cmd_vdsold); $(cmd_vdso_check)
+
 quiet_cmd_vdsold = VDSOL   $@
       cmd_vdsold = $(COMPATCC) -Wp,-MD,$(depfile) $(VDSO_LDFLAGS) \
                    -Wl,-T $(filter %.lds,$^) $(filter %.o,$^) -o $@
