KVM: arm64: Add kvm_vcpu_has_pmu() helper

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-294.el8
commit-author Marc Zyngier <maz@kernel.org>
commit 14bda7a927336055d7c0deb1483f9cdb687c2080
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-294.el8/14bda7a9.failed

There are a number of places where we check for the KVM_ARM_VCPU_PMU_V3
feature. Wrap this check into a new kvm_vcpu_has_pmu(), and use
it at the existing locations.

No functional change.

	Reviewed-by: Alexandru Elisei <alexandru.elisei@arm.com>
	Signed-off-by: Marc Zyngier <maz@kernel.org>
(cherry picked from commit 14bda7a927336055d7c0deb1483f9cdb687c2080)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/arm64/kvm/pmu-emul.c
diff --cc arch/arm64/kvm/pmu-emul.c
index b874960bba3d,e7e3b4629864..000000000000
--- a/arch/arm64/kvm/pmu-emul.c
+++ b/arch/arm64/kvm/pmu-emul.c
@@@ -890,8 -1033,8 +889,13 @@@ int kvm_arm_pmu_v3_has_attr(struct kvm_
  	switch (attr->attr) {
  	case KVM_ARM_VCPU_PMU_V3_IRQ:
  	case KVM_ARM_VCPU_PMU_V3_INIT:
++<<<<<<< HEAD
 +		if (kvm_arm_support_pmu_v3() &&
 +		    test_bit(KVM_ARM_VCPU_PMU_V3, vcpu->arch.features))
++=======
+ 	case KVM_ARM_VCPU_PMU_V3_FILTER:
+ 		if (kvm_arm_support_pmu_v3() && kvm_vcpu_has_pmu(vcpu))
++>>>>>>> 14bda7a92733 (KVM: arm64: Add kvm_vcpu_has_pmu() helper)
  			return 0;
  	}
  
diff --git a/arch/arm64/include/asm/kvm_host.h b/arch/arm64/include/asm/kvm_host.h
index 79e9d838c86a..a48e6aa020dc 100644
--- a/arch/arm64/include/asm/kvm_host.h
+++ b/arch/arm64/include/asm/kvm_host.h
@@ -665,4 +665,7 @@ bool kvm_arm_vcpu_is_finalized(struct kvm_vcpu *vcpu);
 #define kvm_arm_vcpu_sve_finalized(vcpu) \
 	((vcpu)->arch.flags & KVM_ARM64_VCPU_SVE_FINALIZED)
 
+#define kvm_vcpu_has_pmu(vcpu)					\
+	(test_bit(KVM_ARM_VCPU_PMU_V3, (vcpu)->arch.features))
+
 #endif /* __ARM64_KVM_HOST_H__ */
* Unmerged path arch/arm64/kvm/pmu-emul.c
