x86/cpufeatures: Enumerate ENQCMD and ENQCMDS instructions

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-294.el8
commit-author Fenghua Yu <fenghua.yu@intel.com>
commit ff4f82816dff28ffaaff96d1409bb3811d345514
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-294.el8/ff4f8281.failed

Work submission instruction comes in two flavors. ENQCMD can be called
both in ring 3 and ring 0 and always uses the contents of a PASID MSR
when shipping the command to the device. ENQCMDS allows a kernel driver
to submit commands on behalf of a user process. The driver supplies the
PASID value in ENQCMDS. There isn't any usage of ENQCMD in the kernel as
of now.

The CPU feature flag is shown as "enqcmd" in /proc/cpuinfo.

	Signed-off-by: Fenghua Yu <fenghua.yu@intel.com>
	Signed-off-by: Borislav Petkov <bp@suse.de>
	Reviewed-by: Tony Luck <tony.luck@intel.com>
Link: https://lkml.kernel.org/r/1600187413-163670-5-git-send-email-fenghua.yu@intel.com
(cherry picked from commit ff4f82816dff28ffaaff96d1409bb3811d345514)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kernel/cpu/cpuid-deps.c
diff --cc arch/x86/kernel/cpu/cpuid-deps.c
index 9a7fc7b5272f,3a02707c1f4d..000000000000
--- a/arch/x86/kernel/cpu/cpuid-deps.c
+++ b/arch/x86/kernel/cpu/cpuid-deps.c
@@@ -64,7 -69,7 +64,11 @@@ static const struct cpuid_dep cpuid_dep
  	{ X86_FEATURE_CQM_MBM_TOTAL,		X86_FEATURE_CQM_LLC   },
  	{ X86_FEATURE_CQM_MBM_LOCAL,		X86_FEATURE_CQM_LLC   },
  	{ X86_FEATURE_AVX512_BF16,		X86_FEATURE_AVX512VL  },
++<<<<<<< HEAD
 +	{ X86_FEATURE_PER_THREAD_MBA,		X86_FEATURE_MBA       },
++=======
+ 	{ X86_FEATURE_ENQCMD,			X86_FEATURE_XSAVES    },
++>>>>>>> ff4f82816dff (x86/cpufeatures: Enumerate ENQCMD and ENQCMDS instructions)
  	{}
  };
  
diff --git a/arch/x86/include/asm/cpufeatures.h b/arch/x86/include/asm/cpufeatures.h
index a9ad60c4f34e..7461ffd51593 100644
--- a/arch/x86/include/asm/cpufeatures.h
+++ b/arch/x86/include/asm/cpufeatures.h
@@ -350,6 +350,7 @@
 #define X86_FEATURE_CLDEMOTE		(16*32+25) /* CLDEMOTE instruction */
 #define X86_FEATURE_MOVDIRI		(16*32+27) /* MOVDIRI instruction */
 #define X86_FEATURE_MOVDIR64B		(16*32+28) /* MOVDIR64B instruction */
+#define X86_FEATURE_ENQCMD		(16*32+29) /* ENQCMD and ENQCMDS instructions */
 
 /* AMD-defined CPU features, CPUID level 0x80000007 (EBX), word 17 */
 #define X86_FEATURE_OVERFLOW_RECOV	(17*32+ 0) /* MCA overflow recovery support */
* Unmerged path arch/x86/kernel/cpu/cpuid-deps.c
