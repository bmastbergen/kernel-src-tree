s390/pci: adapt events for zbus

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-294.el8
commit-author Pierre Morel <pmorel@linux.ibm.com>
commit f606b3ef47c9f874af605323099663a10f691b24
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-294.el8/f606b3ef.failed

Simplify the event handling.
Set the zpci state explicitly.

	Signed-off-by: Pierre Morel <pmorel@linux.ibm.com>
	Reviewed-by: Niklas Schnelle <schnelle@linux.ibm.com>
	Signed-off-by: Vasily Gorbik <gor@linux.ibm.com>
(cherry picked from commit f606b3ef47c9f874af605323099663a10f691b24)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/s390/pci/pci_event.c
diff --cc arch/s390/pci/pci_event.c
index 8d6ee4af4230,c296214f0a19..000000000000
--- a/arch/s390/pci/pci_event.c
+++ b/arch/s390/pci/pci_event.c
@@@ -89,25 -89,19 +89,28 @@@ static void __zpci_event_availability(s
  	switch (ccdf->pec) {
  	case 0x0301: /* Reserved|Standby -> Configured */
  		if (!zdev) {
- 			ret = clp_add_pci_device(ccdf->fid, ccdf->fh, 0);
- 			if (ret)
- 				break;
- 			zdev = get_zdev_by_fid(ccdf->fid);
- 		}
- 		if (!zdev || zdev->state != ZPCI_FN_STATE_STANDBY)
+ 			ret = clp_add_pci_device(ccdf->fid, ccdf->fh, 1);
  			break;
- 		zdev->state = ZPCI_FN_STATE_CONFIGURED;
+ 		}
  		zdev->fh = ccdf->fh;
++<<<<<<< HEAD
 +		ret = zpci_enable_device(zdev);
 +		if (ret)
 +			break;
 +		pci_lock_rescan_remove();
 +		pci_rescan_bus(zdev->bus);
 +		pci_unlock_rescan_remove();
++=======
+ 		zdev->state = ZPCI_FN_STATE_CONFIGURED;
+ 		zpci_create_device(zdev);
++>>>>>>> f606b3ef47c9 (s390/pci: adapt events for zbus)
  		break;
  	case 0x0302: /* Reserved -> Standby */
- 		if (!zdev)
+ 		if (!zdev) {
  			clp_add_pci_device(ccdf->fid, ccdf->fh, 0);
+ 			break;
+ 		}
+ 		zdev->fh = ccdf->fh;
  		break;
  	case 0x0303: /* Deconfiguration requested */
  		if (!zdev)
* Unmerged path arch/s390/pci/pci_event.c
