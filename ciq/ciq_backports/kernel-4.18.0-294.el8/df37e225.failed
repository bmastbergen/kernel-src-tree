fbcon: Do not takeover the console from atomic context

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-294.el8
commit-author Hans de Goede <hdegoede@redhat.com>
commit df37e225f25933732c17e43cbe7d21eec31b24be
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-294.el8/df37e225.failed

Taking over the console involves allocating mem with GFP_KERNEL, talking
to drm drivers, etc. So this should not be done from an atomic context.

But the console-output trigger deferred console takeover may happen from an
atomic context, which leads to "BUG: sleeping function called from invalid
context" errors.

This commit fixes these errors by doing the deferred takeover from a
workqueue.

	Signed-off-by: Hans de Goede <hdegoede@redhat.com>
[b.zolnierkie: remove unused variable]
	Signed-off-by: Bartlomiej Zolnierkiewicz <b.zolnierkie@samsung.com>
(cherry picked from commit df37e225f25933732c17e43cbe7d21eec31b24be)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/video/fbdev/core/fbcon.c
diff --cc drivers/video/fbdev/core/fbcon.c
index d22b1f1246e3,75ebbbf0a1fb..000000000000
--- a/drivers/video/fbdev/core/fbcon.c
+++ b/drivers/video/fbdev/core/fbcon.c
@@@ -3539,8 -3591,55 +3539,45 @@@ static int fbcon_init_device(void
  	return 0;
  }
  
++<<<<<<< HEAD
++=======
+ #ifdef CONFIG_FRAMEBUFFER_CONSOLE_DEFERRED_TAKEOVER
+ static void fbcon_register_existing_fbs(struct work_struct *work)
+ {
+ 	int i;
+ 
+ 	console_lock();
+ 
+ 	for_each_registered_fb(i)
+ 		fbcon_fb_registered(registered_fb[i]);
+ 
+ 	console_unlock();
+ }
+ 
+ static struct notifier_block fbcon_output_nb;
+ static DECLARE_WORK(fbcon_deferred_takeover_work, fbcon_register_existing_fbs);
+ 
+ static int fbcon_output_notifier(struct notifier_block *nb,
+ 				 unsigned long action, void *data)
+ {
+ 	WARN_CONSOLE_UNLOCKED();
+ 
+ 	pr_info("fbcon: Taking over console\n");
+ 
+ 	dummycon_unregister_output_notifier(&fbcon_output_nb);
+ 	deferred_takeover = false;
+ 	logo_shown = FBCON_LOGO_DONTSHOW;
+ 
+ 	/* We may get called in atomic context */
+ 	schedule_work(&fbcon_deferred_takeover_work);
+ 
+ 	return NOTIFY_OK;
+ }
+ #endif
+ 
++>>>>>>> df37e225f259 (fbcon: Do not takeover the console from atomic context)
  static void fbcon_start(void)
  {
 -	WARN_CONSOLE_UNLOCKED();
 -
 -#ifdef CONFIG_FRAMEBUFFER_CONSOLE_DEFERRED_TAKEOVER
 -	if (conswitchp != &dummy_con)
 -		deferred_takeover = false;
 -
 -	if (deferred_takeover) {
 -		fbcon_output_nb.notifier_call = fbcon_output_notifier;
 -		dummycon_register_output_notifier(&fbcon_output_nb);
 -		return;
 -	}
 -#endif
 -
  	if (num_registered_fb) {
  		int i;
  
* Unmerged path drivers/video/fbdev/core/fbcon.c
