mlxsw: spectrum_router: Re-increase scale of IPv6 nexthop groups

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-294.el8
commit-author Ido Schimmel <idosch@mellanox.com>
commit cec2500d44751a7782d16ce99fca104e77e324a5
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-294.el8/cec2500d.failed

As explained in commit fc25996e6f46 ("mlxsw: spectrum_router: Increase
scale of IPv6 nexthop groups"), each nexthop group is hashed by XOR-ing
the interface indexes of all the member nexthop devices.

To avoid many different nexthop groups ending up using the same key, the
above commit started hashing the interface indexes themselves before
they are XOR-ed.

However, in cases in which there are many nexthop groups that all use
the same nexthop device and only differ in the gateway IP, we can still
end up in a situation in which all the groups are using the same key.
This eventually leads to -EBUSY error from rhashtable during insertion.

Improve the situation by also making the gateway IP part of the key.

	Signed-off-by: Ido Schimmel <idosch@mellanox.com>
	Reported-by: Alex Veber <alexve@mellanox.com>
	Reviewed-by: Jiri Pirko <jiri@mellanox.com>
	Tested-by: Alex Veber <alexve@mellanox.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit cec2500d44751a7782d16ce99fca104e77e324a5)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlxsw/spectrum_router.c
diff --cc drivers/net/ethernet/mellanox/mlxsw/spectrum_router.c
index 25b90620a1bd,71aee4914619..000000000000
--- a/drivers/net/ethernet/mellanox/mlxsw/spectrum_router.c
+++ b/drivers/net/ethernet/mellanox/mlxsw/spectrum_router.c
@@@ -3010,11 -3013,14 +3011,18 @@@ mlxsw_sp_nexthop6_group_hash(struct mlx
  {
  	unsigned int val = fib6_entry->nrt6;
  	struct mlxsw_sp_rt6 *mlxsw_sp_rt6;
- 	struct net_device *dev;
  
  	list_for_each_entry(mlxsw_sp_rt6, &fib6_entry->rt6_list, list) {
++<<<<<<< HEAD
 +		dev = mlxsw_sp_rt6->rt->fib6_nh.nh_dev;
++=======
+ 		struct fib6_nh *fib6_nh = mlxsw_sp_rt6->rt->fib6_nh;
+ 		struct net_device *dev = fib6_nh->fib_nh_dev;
+ 		struct in6_addr *gw = &fib6_nh->fib_nh_gw6;
+ 
++>>>>>>> cec2500d4475 (mlxsw: spectrum_router: Re-increase scale of IPv6 nexthop groups)
  		val ^= jhash(&dev->ifindex, sizeof(dev->ifindex), seed);
+ 		val ^= jhash(gw, sizeof(*gw), seed);
  	}
  
  	return jhash(&val, sizeof(val), seed);
* Unmerged path drivers/net/ethernet/mellanox/mlxsw/spectrum_router.c
