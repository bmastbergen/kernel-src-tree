mm, memory_hotplug: __offline_pages fix wrong locking

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-294.el8
commit-author Michal Hocko <mhocko@suse.com>
commit e3df4c6e4836ce93cd5cf92d9cbdeaf4439a0241
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-294.el8/e3df4c6e.failed

Jan has noticed that we do double unlock on some failure paths when
offlining a page range.  This is indeed the case when
test_pages_in_a_zone respp.  start_isolate_page_range fail.  This was an
omission when forward porting the debugging patch from an older kernel.

Fix the issue by dropping mem_hotplug_done from the failure condition
and keeping the single unlock in the catch all failure path.

Link: http://lkml.kernel.org/r/20190115120307.22768-1-mhocko@kernel.org
Fixes: 7960509329c2 ("mm, memory_hotplug: print reason for the offlining failure")
	Signed-off-by: Michal Hocko <mhocko@suse.com>
	Reported-by: Jan Kara <jack@suse.cz>
	Reviewed-by: Jan Kara <jack@suse.cz>
	Tested-by: Jan Kara <jack@suse.cz>
	Reviewed-by: Oscar Salvador <osalvador@suse.de>
	Reviewed-by: Andrew Morton <akpm@linux-foundation.org>
	Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
	Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
(cherry picked from commit e3df4c6e4836ce93cd5cf92d9cbdeaf4439a0241)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	mm/memory_hotplug.c
diff --cc mm/memory_hotplug.c
index b4c5c96697b6,124e794867c5..000000000000
--- a/mm/memory_hotplug.c
+++ b/mm/memory_hotplug.c
@@@ -1533,9 -1581,9 +1532,15 @@@ static int __ref __offline_pages(unsign
  
  	/* set above range as isolated */
  	ret = start_isolate_page_range(start_pfn, end_pfn,
++<<<<<<< HEAD
 +				       MIGRATE_MOVABLE, true);
 +	if (ret < 0) {
 +		mem_hotplug_done();
++=======
+ 				       MIGRATE_MOVABLE,
+ 				       SKIP_HWPOISON | REPORT_FAILURE);
+ 	if (ret) {
++>>>>>>> e3df4c6e4836 (mm, memory_hotplug: __offline_pages fix wrong locking)
  		reason = "failure to isolate range";
  		goto failed_removal;
  	}
* Unmerged path mm/memory_hotplug.c
