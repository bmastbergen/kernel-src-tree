vfs: Convert zsmalloc to use the new mount API

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-294.el8
commit-author David Howells <dhowells@redhat.com>
commit 8e9231f819e32d8efb53b0f17f293bab74bed8ce
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-294.el8/8e9231f8.failed

Convert the zsmalloc filesystem to the new internal mount API as the old
one will be obsoleted and removed.  This allows greater flexibility in
communication of mount parameters between userspace, the VFS and the
filesystem.

See Documentation/filesystems/mount_api.txt for more information.

	Signed-off-by: David Howells <dhowells@redhat.com>
cc: Minchan Kim <minchan@kernel.org>
cc: Nitin Gupta <ngupta@vflare.org>
cc: Sergey Senozhatsky <sergey.senozhatsky.work@gmail.com>
cc: linux-mm@kvack.org
	Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
(cherry picked from commit 8e9231f819e32d8efb53b0f17f293bab74bed8ce)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	mm/zsmalloc.c
diff --cc mm/zsmalloc.c
index 6cfcb2b0c5da,910d0407f8f1..000000000000
--- a/mm/zsmalloc.c
+++ b/mm/zsmalloc.c
@@@ -52,8 -52,8 +52,9 @@@
  #include <linux/zsmalloc.h>
  #include <linux/zpool.h>
  #include <linux/mount.h>
+ #include <linux/pseudo_fs.h>
  #include <linux/migrate.h>
 +#include <linux/wait.h>
  #include <linux/pagemap.h>
  #include <linux/fs.h>
  
@@@ -1819,10 -1802,22 +1820,29 @@@ static enum fullness_group putback_zspa
  }
  
  #ifdef CONFIG_COMPACTION
++<<<<<<< HEAD
 +static struct dentry *zs_mount(struct file_system_type *fs_type,
 +				int flags, const char *dev_name, void *data)
 +{
 +	return mount_pseudo(fs_type, "zsmalloc:", NULL, NULL, ZSMALLOC_MAGIC);
++=======
+ /*
+  * To prevent zspage destroy during migration, zspage freeing should
+  * hold locks of all pages in the zspage.
+  */
+ static void lock_zspage(struct zspage *zspage)
+ {
+ 	struct page *page = get_first_page(zspage);
+ 
+ 	do {
+ 		lock_page(page);
+ 	} while ((page = get_next_page(page)) != NULL);
+ }
+ 
+ static int zs_init_fs_context(struct fs_context *fc)
+ {
+ 	return init_pseudo(fc, ZSMALLOC_MAGIC) ? 0 : -ENOMEM;
++>>>>>>> 8e9231f819e3 (vfs: Convert zsmalloc to use the new mount API)
  }
  
  static struct file_system_type zsmalloc_fs = {
* Unmerged path mm/zsmalloc.c
