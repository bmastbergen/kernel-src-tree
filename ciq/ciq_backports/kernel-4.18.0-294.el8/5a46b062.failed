devlink: refactor end checks in devlink_nl_cmd_region_read_dumpit

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-294.el8
commit-author Jakub Kicinski <kuba@kernel.org>
commit 5a46b062e28f57bffde767437fad3ab1d0cee2c7
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-294.el8/5a46b062.failed

Clean up after recent fixes, move address calculations
around and change the variable init, so that we can have
just one start_offset == end_offset check.

Make the check a little stricter to preserve the -EINVAL
error if requested start offset is larger than the region
itself.

	Signed-off-by: Jakub Kicinski <kuba@kernel.org>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 5a46b062e28f57bffde767437fad3ab1d0cee2c7)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/core/devlink.c
diff --cc net/core/devlink.c
index 412a3ecd99d9,7b76e5fffc10..000000000000
--- a/net/core/devlink.c
+++ b/net/core/devlink.c
@@@ -4412,13 -4255,13 +4408,22 @@@ static int devlink_nl_region_read_snaps
  static int devlink_nl_cmd_region_read_dumpit(struct sk_buff *skb,
  					     struct netlink_callback *cb)
  {
++<<<<<<< HEAD
 +	u64 ret_offset, start_offset, end_offset = 0;
++=======
+ 	const struct genl_dumpit_info *info = genl_dumpit_info(cb);
+ 	u64 ret_offset, start_offset, end_offset = U64_MAX;
+ 	struct nlattr **attrs = info->attrs;
++>>>>>>> 5a46b062e28f (devlink: refactor end checks in devlink_nl_cmd_region_read_dumpit)
  	struct devlink_region *region;
  	struct nlattr *chunks_attr;
  	const char *region_name;
  	struct devlink *devlink;
++<<<<<<< HEAD
 +	struct nlattr **attrs;
 +	bool dump = true;
++=======
++>>>>>>> 5a46b062e28f (devlink: refactor end checks in devlink_nl_cmd_region_read_dumpit)
  	void *hdr;
  	int err;
  
* Unmerged path net/core/devlink.c
diff --git a/tools/testing/selftests/drivers/net/netdevsim/devlink.sh b/tools/testing/selftests/drivers/net/netdevsim/devlink.sh
index ad539eccddcb..de4b32fc4223 100755
--- a/tools/testing/selftests/drivers/net/netdevsim/devlink.sh
+++ b/tools/testing/selftests/drivers/net/netdevsim/devlink.sh
@@ -146,6 +146,21 @@ regions_test()
 
 	check_region_snapshot_count dummy post-first-request 3
 
+	devlink region dump $DL_HANDLE/dummy snapshot 25 >> /dev/null
+	check_err $? "Failed to dump snapshot with id 25"
+
+	devlink region read $DL_HANDLE/dummy snapshot 25 addr 0 len 1 >> /dev/null
+	check_err $? "Failed to read snapshot with id 25 (1 byte)"
+
+	devlink region read $DL_HANDLE/dummy snapshot 25 addr 128 len 128 >> /dev/null
+	check_err $? "Failed to read snapshot with id 25 (128 bytes)"
+
+	devlink region read $DL_HANDLE/dummy snapshot 25 addr 128 len $((1<<32)) >> /dev/null
+	check_err $? "Failed to read snapshot with id 25 (oversized)"
+
+	devlink region read $DL_HANDLE/dummy snapshot 25 addr $((1<<32)) len 128 >> /dev/null 2>&1
+	check_fail $? "Bad read of snapshot with id 25 did not fail"
+
 	devlink region del $DL_HANDLE/dummy snapshot 25
 	check_err $? "Failed to delete snapshot with id 25"
 
