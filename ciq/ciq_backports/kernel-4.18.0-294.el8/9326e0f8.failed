bpfilter: Allow to build bpfilter_umh as a module without static library

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-294.el8
commit-author Masahiro Yamada <masahiroy@kernel.org>
commit 9326e0f85bfaf0578d40f5357f8143ec857469f5
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-294.el8/9326e0f8.failed

Originally, bpfilter_umh was linked with -static only when
CONFIG_BPFILTER_UMH=y.

Commit 8a2cc0505cc4 ("bpfilter: use 'userprogs' syntax to build
bpfilter_umh") silently, accidentally dropped the CONFIG_BPFILTER_UMH=y
test in the Makefile. Revive it in order to link it dynamically when
CONFIG_BPFILTER_UMH=m.

Since commit b1183b6dca3e ("bpfilter: check if $(CC) can link static
libc in Kconfig"), the compiler must be capable of static linking to
enable CONFIG_BPFILTER_UMH, but it requires more than needed.

To loosen the compiler requirement, I changed the dependency as follows:

    depends on CC_CAN_LINK
    depends on m || CC_CAN_LINK_STATIC

If CONFIG_CC_CAN_LINK_STATIC in unset, CONFIG_BPFILTER_UMH is restricted
to 'm' or 'n'.

In theory, CONFIG_CC_CAN_LINK is not required for CONFIG_BPFILTER_UMH=y,
but I did not come up with a good way to describe it.

Fixes: 8a2cc0505cc4 ("bpfilter: use 'userprogs' syntax to build bpfilter_umh")
	Reported-by: Michal Kubecek <mkubecek@suse.cz>
	Signed-off-by: Masahiro Yamada <masahiroy@kernel.org>
	Signed-off-by: Alexei Starovoitov <ast@kernel.org>
	Tested-by: Michal Kubecek <mkubecek@suse.cz>
Link: https://lore.kernel.org/bpf/20200701092644.762234-1-masahiroy@kernel.org
(cherry picked from commit 9326e0f85bfaf0578d40f5357f8143ec857469f5)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/bpfilter/Kconfig
#	net/bpfilter/Makefile
diff --cc net/bpfilter/Kconfig
index 3e34131d4a2e,73d0b12789f1..000000000000
--- a/net/bpfilter/Kconfig
+++ b/net/bpfilter/Kconfig
@@@ -9,6 -10,7 +9,10 @@@ if BPFILTE
  config BPFILTER_UMH
  	tristate "bpfilter kernel module with user mode helper"
  	depends on CC_CAN_LINK
++<<<<<<< HEAD
++=======
+ 	depends on m || CC_CAN_LINK_STATIC
++>>>>>>> 9326e0f85bfa (bpfilter: Allow to build bpfilter_umh as a module without static library)
  	default m
  	help
  	  This builds bpfilter kernel module with embedded user mode helper
diff --cc net/bpfilter/Makefile
index 854395fb98cd,cdac82b8c53a..000000000000
--- a/net/bpfilter/Makefile
+++ b/net/bpfilter/Makefile
@@@ -3,16 -3,15 +3,23 @@@
  # Makefile for the Linux BPFILTER layer.
  #
  
 -userprogs := bpfilter_umh
 +hostprogs-y := bpfilter_umh
  bpfilter_umh-objs := main.o
 -userccflags += -I $(srctree)/tools/include/ -I $(srctree)/tools/include/uapi
 +KBUILD_HOSTCFLAGS += -Itools/include/ -Itools/include/uapi
 +HOSTCC := $(CC)
  
  ifeq ($(CONFIG_BPFILTER_UMH), y)
++<<<<<<< HEAD
 +# builtin bpfilter_umh should be compiled with -static
 +# since rootfs isn't mounted at the time of __init
 +# function is called and do_execv won't find elf interpreter
 +KBUILD_HOSTLDFLAGS += -static
++=======
+ # builtin bpfilter_umh should be linked with -static
+ # since rootfs isn't mounted at the time of __init
+ # function is called and do_execv won't find elf interpreter
+ userldflags += -static
++>>>>>>> 9326e0f85bfa (bpfilter: Allow to build bpfilter_umh as a module without static library)
  endif
  
  $(obj)/bpfilter_umh_blob.o: $(obj)/bpfilter_umh
* Unmerged path net/bpfilter/Kconfig
* Unmerged path net/bpfilter/Makefile
