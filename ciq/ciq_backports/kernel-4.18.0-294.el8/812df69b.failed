net: liquidio: reject unsupported coalescing params

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-294.el8
commit-author Jakub Kicinski <kuba@kernel.org>
commit 812df69beb86b0e6decbb109ee3fa408dcb7fa5d
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-294.el8/812df69b.failed

Set ethtool_ops->supported_coalesce_params to let
the core reject unsupported coalescing parameters.

This driver did not previously reject unsupported parameters.

	Signed-off-by: Jakub Kicinski <kuba@kernel.org>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 812df69beb86b0e6decbb109ee3fa408dcb7fa5d)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/cavium/liquidio/lio_ethtool.c
#	include/linux/ethtool.h
diff --cc drivers/net/ethernet/cavium/liquidio/lio_ethtool.c
index 06f7449c569d,16eebfc52109..000000000000
--- a/drivers/net/ethernet/cavium/liquidio/lio_ethtool.c
+++ b/drivers/net/ethernet/cavium/liquidio/lio_ethtool.c
@@@ -3110,9 -3048,70 +3110,71 @@@ static int lio_set_priv_flags(struct ne
  	return 0;
  }
  
++<<<<<<< HEAD
++=======
+ static int lio_get_fecparam(struct net_device *netdev,
+ 			    struct ethtool_fecparam *fec)
+ {
+ 	struct lio *lio = GET_LIO(netdev);
+ 	struct octeon_device *oct = lio->oct_dev;
+ 
+ 	fec->active_fec = ETHTOOL_FEC_NONE;
+ 	fec->fec = ETHTOOL_FEC_NONE;
+ 
+ 	if (oct->subsystem_id == OCTEON_CN2350_25GB_SUBSYS_ID ||
+ 	    oct->subsystem_id == OCTEON_CN2360_25GB_SUBSYS_ID) {
+ 		if (oct->no_speed_setting == 1)
+ 			return 0;
+ 
+ 		liquidio_get_fec(lio);
+ 		fec->fec = (ETHTOOL_FEC_RS | ETHTOOL_FEC_OFF);
+ 		if (oct->props[lio->ifidx].fec == 1)
+ 			fec->active_fec = ETHTOOL_FEC_RS;
+ 		else
+ 			fec->active_fec = ETHTOOL_FEC_OFF;
+ 	}
+ 
+ 	return 0;
+ }
+ 
+ static int lio_set_fecparam(struct net_device *netdev,
+ 			    struct ethtool_fecparam *fec)
+ {
+ 	struct lio *lio = GET_LIO(netdev);
+ 	struct octeon_device *oct = lio->oct_dev;
+ 
+ 	if (oct->subsystem_id == OCTEON_CN2350_25GB_SUBSYS_ID ||
+ 	    oct->subsystem_id == OCTEON_CN2360_25GB_SUBSYS_ID) {
+ 		if (oct->no_speed_setting == 1)
+ 			return -EOPNOTSUPP;
+ 
+ 		if (fec->fec & ETHTOOL_FEC_OFF)
+ 			liquidio_set_fec(lio, 0);
+ 		else if (fec->fec & ETHTOOL_FEC_RS)
+ 			liquidio_set_fec(lio, 1);
+ 		else
+ 			return -EOPNOTSUPP;
+ 	} else {
+ 		return -EOPNOTSUPP;
+ 	}
+ 
+ 	return 0;
+ }
+ 
+ #define LIO_ETHTOOL_COALESCE	(ETHTOOL_COALESCE_RX_USECS |		\
+ 				 ETHTOOL_COALESCE_MAX_FRAMES |		\
+ 				 ETHTOOL_COALESCE_USE_ADAPTIVE |	\
+ 				 ETHTOOL_COALESCE_RX_MAX_FRAMES_LOW |	\
+ 				 ETHTOOL_COALESCE_TX_MAX_FRAMES_LOW |	\
+ 				 ETHTOOL_COALESCE_RX_MAX_FRAMES_HIGH |	\
+ 				 ETHTOOL_COALESCE_TX_MAX_FRAMES_HIGH |	\
+ 				 ETHTOOL_COALESCE_PKT_RATE_RX_USECS)
+ 
++>>>>>>> 812df69beb86 (net: liquidio: reject unsupported coalescing params)
  static const struct ethtool_ops lio_ethtool_ops = {
+ 	.supported_coalesce_params = LIO_ETHTOOL_COALESCE,
  	.get_link_ksettings	= lio_get_link_ksettings,
  	.set_link_ksettings	= lio_set_link_ksettings,
 -	.get_fecparam		= lio_get_fecparam,
 -	.set_fecparam		= lio_set_fecparam,
  	.get_link		= ethtool_op_get_link,
  	.get_drvinfo		= lio_get_drvinfo,
  	.get_ringparam		= lio_ethtool_get_ringparam,
diff --cc include/linux/ethtool.h
index 313c3a09aa91,9efeebde3514..000000000000
--- a/include/linux/ethtool.h
+++ b/include/linux/ethtool.h
@@@ -213,12 -211,11 +213,20 @@@ bool ethtool_convert_link_mode_to_legac
  	 ETHTOOL_COALESCE_TX_MAX_FRAMES_IRQ)
  #define ETHTOOL_COALESCE_USE_ADAPTIVE					\
  	(ETHTOOL_COALESCE_USE_ADAPTIVE_RX | ETHTOOL_COALESCE_USE_ADAPTIVE_TX)
++<<<<<<< HEAD
 +#define ETHTOOL_COALESCE_USECS_LOW_HIGH					\
 +	(ETHTOOL_COALESCE_RX_USECS_LOW | ETHTOOL_COALESCE_TX_USECS_LOW | \
 +	 ETHTOOL_COALESCE_RX_USECS_HIGH | ETHTOOL_COALESCE_TX_USECS_HIGH)
 +
 +struct ethtool_ops_extended_rh {
 +};
++=======
+ #define ETHTOOL_COALESCE_PKT_RATE_RX_USECS				\
+ 	(ETHTOOL_COALESCE_USE_ADAPTIVE_RX |				\
+ 	 ETHTOOL_COALESCE_RX_USECS_LOW | ETHTOOL_COALESCE_RX_USECS_HIGH | \
+ 	 ETHTOOL_COALESCE_PKT_RATE_LOW | ETHTOOL_COALESCE_PKT_RATE_HIGH | \
+ 	 ETHTOOL_COALESCE_RATE_SAMPLE_INTERVAL)
++>>>>>>> 812df69beb86 (net: liquidio: reject unsupported coalescing params)
  
  /**
   * struct ethtool_ops - optional netdev operations
* Unmerged path drivers/net/ethernet/cavium/liquidio/lio_ethtool.c
* Unmerged path include/linux/ethtool.h
