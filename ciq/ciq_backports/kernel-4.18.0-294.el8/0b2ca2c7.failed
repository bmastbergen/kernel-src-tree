s390/pci: fix hot-plug of PCI function missing bus

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-294.el8
commit-author Niklas Schnelle <schnelle@linux.ibm.com>
commit 0b2ca2c7d0c9e2731d01b6c862375d44a7e13923
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-294.el8/0b2ca2c7.failed

Under some circumstances in particular with "Reconfigure I/O Path"
a zPCI function may first appear in Standby through a PCI event with
PEC 0x0302 which initially makes it visible to the zPCI subsystem,
Only after that is it configured with a zPCI event  with PEC 0x0301.
If the zbus is still missing a PCI function zero (devfn == 0) when the
PCI event 0x0301 is handled zdev->zbus->bus is still NULL and gets
dereferenced in common code.
Check for this case and enable but don't scan the zPCI function.
This matches what would happen if we immediately got the 0x0301
configuration request or the function was included in CLP List PCI.
In all cases the PCI functions with devfn != 0 will be scanned once
function 0 appears.

Fixes: 3047766bc6ec ("s390/pci: fix enabling a reserved PCI function")
	Cc: <stable@vger.kernel.org> # 5.8
	Signed-off-by: Niklas Schnelle <schnelle@linux.ibm.com>
	Acked-by: Pierre Morel <pmorel@linux.ibm.com>
	Signed-off-by: Heiko Carstens <hca@linux.ibm.com>
(cherry picked from commit 0b2ca2c7d0c9e2731d01b6c862375d44a7e13923)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/s390/pci/pci_event.c
diff --cc arch/s390/pci/pci_event.c
index 8d6ee4af4230,9a6bae503fe6..000000000000
--- a/arch/s390/pci/pci_event.c
+++ b/arch/s390/pci/pci_event.c
@@@ -101,8 -100,18 +101,21 @@@ static void __zpci_event_availability(s
  		ret = zpci_enable_device(zdev);
  		if (ret)
  			break;
++<<<<<<< HEAD
++=======
+ 
+ 		/* the PCI function will be scanned once function 0 appears */
+ 		if (!zdev->zbus->bus)
+ 			break;
+ 
+ 		pdev = pci_scan_single_device(zdev->zbus->bus, zdev->devfn);
+ 		if (!pdev)
+ 			break;
+ 
+ 		pci_bus_add_device(pdev);
++>>>>>>> 0b2ca2c7d0c9 (s390/pci: fix hot-plug of PCI function missing bus)
  		pci_lock_rescan_remove();
 -		pci_bus_add_devices(zdev->zbus->bus);
 +		pci_rescan_bus(zdev->bus);
  		pci_unlock_rescan_remove();
  		break;
  	case 0x0302: /* Reserved -> Standby */
* Unmerged path arch/s390/pci/pci_event.c
