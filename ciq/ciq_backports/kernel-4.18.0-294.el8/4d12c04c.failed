RDMA: Remove 'max_map_per_fmr'

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-294.el8
commit-author Jason Gunthorpe <jgg@ziepe.ca>
commit 4d12c04caa88cd3115f25acd832a7cddb698981b
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-294.el8/4d12c04c.failed

Now that FMR support is gone, this attribute can be deleted from all
places.

Link: https://lore.kernel.org/r/13-v3-f58e6669d5d3+2cf-fmr_removal_jgg@mellanox.com
	Reviewed-by: Max Gurtovoy <maxg@mellanox.com>
	Signed-off-by: Jason Gunthorpe <jgg@mellanox.com>
(cherry picked from commit 4d12c04caa88cd3115f25acd832a7cddb698981b)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/core/uverbs_cmd.c
#	drivers/infiniband/hw/ocrdma/ocrdma_verbs.c
#	drivers/infiniband/hw/qedr/verbs.c
#	include/rdma/ib_verbs.h
diff --cc drivers/infiniband/core/uverbs_cmd.c
index 88b3060df417,b48b3f6e632d..000000000000
--- a/drivers/infiniband/core/uverbs_cmd.c
+++ b/drivers/infiniband/core/uverbs_cmd.c
@@@ -344,8 -356,6 +344,11 @@@ static void copy_query_dev_fields(struc
  	resp->max_mcast_qp_attach	= attr->max_mcast_qp_attach;
  	resp->max_total_mcast_qp_attach	= attr->max_total_mcast_qp_attach;
  	resp->max_ah			= attr->max_ah;
++<<<<<<< HEAD
 +	resp->max_fmr			= attr->max_fmr;
 +	resp->max_map_per_fmr		= attr->max_map_per_fmr;
++=======
++>>>>>>> 4d12c04caa88 (RDMA: Remove 'max_map_per_fmr')
  	resp->max_srq			= attr->max_srq;
  	resp->max_srq_wr		= attr->max_srq_wr;
  	resp->max_srq_sge		= attr->max_srq_sge;
diff --cc drivers/infiniband/hw/ocrdma/ocrdma_verbs.c
index 81119ba280d9,d11c74390a12..000000000000
--- a/drivers/infiniband/hw/ocrdma/ocrdma_verbs.c
+++ b/drivers/infiniband/hw/ocrdma/ocrdma_verbs.c
@@@ -99,8 -99,6 +99,11 @@@ int ocrdma_query_device(struct ib_devic
  	attr->max_mw = dev->attr.max_mw;
  	attr->max_pd = dev->attr.max_pd;
  	attr->atomic_cap = 0;
++<<<<<<< HEAD
 +	attr->max_fmr = 0;
 +	attr->max_map_per_fmr = 0;
++=======
++>>>>>>> 4d12c04caa88 (RDMA: Remove 'max_map_per_fmr')
  	attr->max_qp_rd_atom =
  	    min(dev->attr.max_ord_per_qp, dev->attr.max_ird_per_qp);
  	attr->max_qp_init_rd_atom = dev->attr.max_ord_per_qp;
diff --cc drivers/infiniband/hw/qedr/verbs.c
index 3769f258df53,9b9e80266367..000000000000
--- a/drivers/infiniband/hw/qedr/verbs.c
+++ b/drivers/infiniband/hw/qedr/verbs.c
@@@ -145,8 -145,6 +145,11 @@@ int qedr_query_device(struct ib_device 
  	attr->max_mw = qattr->max_mw;
  	attr->max_pd = qattr->max_pd;
  	attr->atomic_cap = dev->atomic_cap;
++<<<<<<< HEAD
 +	attr->max_fmr = qattr->max_fmr;
 +	attr->max_map_per_fmr = 16;
++=======
++>>>>>>> 4d12c04caa88 (RDMA: Remove 'max_map_per_fmr')
  	attr->max_qp_init_rd_atom =
  	    1 << (fls(qattr->max_qp_req_rd_atomic_resc) - 1);
  	attr->max_qp_rd_atom =
diff --cc include/rdma/ib_verbs.h
index a9fefe1eb81a,033e7044f29c..000000000000
--- a/include/rdma/ib_verbs.h
+++ b/include/rdma/ib_verbs.h
@@@ -430,8 -430,6 +430,11 @@@ struct ib_device_attr 
  	int			max_mcast_qp_attach;
  	int			max_total_mcast_qp_attach;
  	int			max_ah;
++<<<<<<< HEAD
 +	int			max_fmr;
 +	int			max_map_per_fmr;
++=======
++>>>>>>> 4d12c04caa88 (RDMA: Remove 'max_map_per_fmr')
  	int			max_srq;
  	int			max_srq_wr;
  	int			max_srq_sge;
* Unmerged path drivers/infiniband/core/uverbs_cmd.c
diff --git a/drivers/infiniband/hw/hfi1/verbs.c b/drivers/infiniband/hw/hfi1/verbs.c
index 43ddced15951..30865635b449 100644
--- a/drivers/infiniband/hw/hfi1/verbs.c
+++ b/drivers/infiniband/hw/hfi1/verbs.c
@@ -1361,7 +1361,6 @@ static void hfi1_fill_device_attr(struct hfi1_devdata *dd)
 	rdi->dparms.props.max_cq = hfi1_max_cqs;
 	rdi->dparms.props.max_ah = hfi1_max_ahs;
 	rdi->dparms.props.max_cqe = hfi1_max_cqes;
-	rdi->dparms.props.max_map_per_fmr = 32767;
 	rdi->dparms.props.max_pd = hfi1_max_pds;
 	rdi->dparms.props.max_qp_rd_atom = HFI1_MAX_RDMA_ATOMIC;
 	rdi->dparms.props.max_qp_init_rd_atom = 255;
diff --git a/drivers/infiniband/hw/i40iw/i40iw_verbs.c b/drivers/infiniband/hw/i40iw/i40iw_verbs.c
index 3f2024d7f075..d7f544e45ca1 100644
--- a/drivers/infiniband/hw/i40iw/i40iw_verbs.c
+++ b/drivers/infiniband/hw/i40iw/i40iw_verbs.c
@@ -83,7 +83,6 @@ static int i40iw_query_device(struct ib_device *ibdev,
 	props->max_qp_rd_atom = I40IW_MAX_IRD_SIZE;
 	props->max_qp_init_rd_atom = props->max_qp_rd_atom;
 	props->atomic_cap = IB_ATOMIC_NONE;
-	props->max_map_per_fmr = 1;
 	props->max_fast_reg_page_list_len = I40IW_MAX_PAGES_PER_FMR;
 	return 0;
 }
diff --git a/drivers/infiniband/hw/mlx5/main.c b/drivers/infiniband/hw/mlx5/main.c
index 6e1057e32e9d..325cc8e87931 100644
--- a/drivers/infiniband/hw/mlx5/main.c
+++ b/drivers/infiniband/hw/mlx5/main.c
@@ -1006,7 +1006,6 @@ static int mlx5_ib_query_device(struct ib_device *ibdev,
 	props->max_mcast_qp_attach = MLX5_CAP_GEN(mdev, max_qp_mcg);
 	props->max_total_mcast_qp_attach = props->max_mcast_qp_attach *
 					   props->max_mcast_grp;
-	props->max_map_per_fmr = INT_MAX; /* no limit in ConnectIB */
 	props->max_ah = INT_MAX;
 	props->hca_core_clock = MLX5_CAP_GEN(mdev, device_frequency_khz);
 	props->timestamp_mask = 0x7FFFFFFFFFFFFFFFULL;
diff --git a/drivers/infiniband/hw/mthca/mthca_provider.c b/drivers/infiniband/hw/mthca/mthca_provider.c
index c25d45f7ecb7..5f25fb0b9d6e 100644
--- a/drivers/infiniband/hw/mthca/mthca_provider.c
+++ b/drivers/infiniband/hw/mthca/mthca_provider.c
@@ -118,16 +118,6 @@ static int mthca_query_device(struct ib_device *ibdev, struct ib_device_attr *pr
 	props->max_mcast_qp_attach = MTHCA_QP_PER_MGM;
 	props->max_total_mcast_qp_attach = props->max_mcast_qp_attach *
 					   props->max_mcast_grp;
-	/*
-	 * If Sinai memory key optimization is being used, then only
-	 * the 8-bit key portion will change.  For other HCAs, the
-	 * unused index bits will also be used for FMR remapping.
-	 */
-	if (mdev->mthca_flags & MTHCA_FLAG_SINAI_OPT)
-		props->max_map_per_fmr = 255;
-	else
-		props->max_map_per_fmr =
-			(1 << (32 - ilog2(mdev->limits.num_mpts))) - 1;
 
 	err = 0;
  out:
* Unmerged path drivers/infiniband/hw/ocrdma/ocrdma_verbs.c
* Unmerged path drivers/infiniband/hw/qedr/verbs.c
diff --git a/drivers/infiniband/hw/qib/qib_verbs.c b/drivers/infiniband/hw/qib/qib_verbs.c
index 5ef93f8f17a1..e388c8ace92c 100644
--- a/drivers/infiniband/hw/qib/qib_verbs.c
+++ b/drivers/infiniband/hw/qib/qib_verbs.c
@@ -1461,7 +1461,6 @@ static void qib_fill_device_attr(struct qib_devdata *dd)
 	rdi->dparms.props.max_cq = ib_qib_max_cqs;
 	rdi->dparms.props.max_cqe = ib_qib_max_cqes;
 	rdi->dparms.props.max_ah = ib_qib_max_ahs;
-	rdi->dparms.props.max_map_per_fmr = 32767;
 	rdi->dparms.props.max_qp_rd_atom = QIB_MAX_RDMA_ATOMIC;
 	rdi->dparms.props.max_qp_init_rd_atom = 255;
 	rdi->dparms.props.max_srq = ib_qib_max_srqs;
diff --git a/drivers/infiniband/hw/usnic/usnic_ib_verbs.c b/drivers/infiniband/hw/usnic/usnic_ib_verbs.c
index 61f8a37e115f..387818131fce 100644
--- a/drivers/infiniband/hw/usnic/usnic_ib_verbs.c
+++ b/drivers/infiniband/hw/usnic/usnic_ib_verbs.c
@@ -322,7 +322,6 @@ int usnic_ib_query_device(struct ib_device *ibdev,
 	props->max_mcast_grp = 0;
 	props->max_mcast_qp_attach = 0;
 	props->max_total_mcast_qp_attach = 0;
-	props->max_map_per_fmr = 0;
 	/* Owned by Userspace
 	 * max_qp_wr, max_sge, max_sge_rd, max_cqe */
 	mutex_unlock(&us_ibdev->usdev_lock);
* Unmerged path include/rdma/ib_verbs.h
