selftests: extend zerocopy tests to udp

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-294.el8
commit-author Willem de Bruijn <willemb@google.com>
commit db63e489c7aa03bab86960d6bcb6bf1fad8eea4e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-294.el8/db63e489.failed

Both msg_zerocopy and udpgso_bench have udp zerocopy variants.
Exercise these as part of the standard kselftest run.

With udp, msg_zerocopy has no control channel. Ensure that the
receiver exits after the sender by accounting for the initial
delay in starting them (in msg_zerocopy.sh).

	Signed-off-by: Willem de Bruijn <willemb@google.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit db63e489c7aa03bab86960d6bcb6bf1fad8eea4e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/testing/selftests/net/udpgso_bench.sh
diff --cc tools/testing/selftests/net/udpgso_bench.sh
index 99e537ab5ad9,5670a9ffd8eb..000000000000
--- a/tools/testing/selftests/net/udpgso_bench.sh
+++ b/tools/testing/selftests/net/udpgso_bench.sh
@@@ -34,7 -34,10 +34,14 @@@ run_udp() 
  	run_in_netns ${args}
  
  	echo "udp gso"
++<<<<<<< HEAD
 +	run_in_netns ${args} -S
++=======
+ 	run_in_netns ${args} -S 0
+ 
+ 	echo "udp gso zerocopy"
+ 	run_in_netns ${args} -S 0 -z
++>>>>>>> db63e489c7aa (selftests: extend zerocopy tests to udp)
  }
  
  run_tcp() {
diff --git a/tools/testing/selftests/net/msg_zerocopy.c b/tools/testing/selftests/net/msg_zerocopy.c
index c539591937a1..bdc03a2097e8 100644
--- a/tools/testing/selftests/net/msg_zerocopy.c
+++ b/tools/testing/selftests/net/msg_zerocopy.c
@@ -650,12 +650,13 @@ static void do_flush_datagram(int fd, int type)
 
 static void do_rx(int domain, int type, int protocol)
 {
+	const int cfg_receiver_wait_ms = 400;
 	uint64_t tstop;
 	int fd;
 
 	fd = do_setup_rx(domain, type, protocol);
 
-	tstop = gettimeofday_ms() + cfg_runtime_ms;
+	tstop = gettimeofday_ms() + cfg_runtime_ms + cfg_receiver_wait_ms;
 	do {
 		if (type == SOCK_STREAM)
 			do_flush_tcp(fd);
diff --git a/tools/testing/selftests/net/msg_zerocopy.sh b/tools/testing/selftests/net/msg_zerocopy.sh
index c43c6debda06..825ffec85cea 100755
--- a/tools/testing/selftests/net/msg_zerocopy.sh
+++ b/tools/testing/selftests/net/msg_zerocopy.sh
@@ -25,6 +25,8 @@ readonly path_sysctl_mem="net.core.optmem_max"
 if [[ "$#" -eq "0" ]]; then
 	$0 4 tcp -t 1
 	$0 6 tcp -t 1
+	$0 4 udp -t 1
+	$0 6 udp -t 1
 	echo "OK. All tests passed"
 	exit 0
 fi
* Unmerged path tools/testing/selftests/net/udpgso_bench.sh
