udp6: Extract helper for selecting socket from reuseport group

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-294.el8
commit-author Jakub Sitnicki <jakub@cloudflare.com>
commit 2a08748cd384cdfb8e1222bd3645a8d1d36e6a5d
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-294.el8/2a08748c.failed

Prepare for calling into reuseport from __udp6_lib_lookup as well.

	Signed-off-by: Jakub Sitnicki <jakub@cloudflare.com>
	Signed-off-by: Alexei Starovoitov <ast@kernel.org>
	Acked-by: Andrii Nakryiko <andriin@fb.com>
Link: https://lore.kernel.org/bpf/20200717103536.397595-10-jakub@cloudflare.com
(cherry picked from commit 2a08748cd384cdfb8e1222bd3645a8d1d36e6a5d)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/ipv6/udp.c
diff --cc net/ipv6/udp.c
index 13a23a10591c,084205c18a33..000000000000
--- a/net/ipv6/udp.c
+++ b/net/ipv6/udp.c
@@@ -151,9 -169,8 +172,8 @@@ static struct sock *udp6_lib_lookup2(st
  		int dif, int sdif, struct udp_hslot *hslot2,
  		struct sk_buff *skb)
  {
 -	struct sock *sk, *result;
 +	struct sock *sk, *result, *reuseport_result;
  	int score, badness;
- 	u32 hash = 0;
  
  	result = NULL;
  	badness = -1;
@@@ -161,20 -178,12 +181,29 @@@
  		score = compute_score(sk, net, saddr, sport,
  				      daddr, hnum, dif, sdif);
  		if (score > badness) {
++<<<<<<< HEAD
 +			reuseport_result = NULL;
 +
 +			if (sk->sk_reuseport &&
 +			    sk->sk_state != TCP_ESTABLISHED) {
 +				hash = udp6_ehashfn(net, daddr, hnum,
 +						    saddr, sport);
 +
 +				reuseport_result = reuseport_select_sock(sk, hash, skb,
 +									 sizeof(struct udphdr));
 +				if (reuseport_result && !reuseport_has_conns(sk, false))
 +					return reuseport_result;
 +			}
 +
 +			result = reuseport_result ? : sk;
++=======
+ 			result = lookup_reuseport(net, sk, skb,
+ 						  saddr, sport, daddr, hnum);
+ 			if (result)
+ 				return result;
+ 
+ 			result = sk;
++>>>>>>> 2a08748cd384 (udp6: Extract helper for selecting socket from reuseport group)
  			badness = score;
  		}
  	}
* Unmerged path net/ipv6/udp.c
