s390/pci: adaptation of iommu to multifunction

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-294.el8
commit-author Pierre Morel <pmorel@linux.ibm.com>
commit d08d6f5d75242ceb410efbdf650efecc40d68c2d
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-294.el8/d08d6f5d.failed

In the future the bus sysdata may not directly point to the
zpci_dev.

In preparation of upcoming patches let us abstract the
access to the zpci_dev from the device inside the pci device.

	Signed-off-by: Pierre Morel <pmorel@linux.ibm.com>
	Reviewed-by: Niklas Schnelle <schnelle@linux.ibm.com>
	Signed-off-by: Vasily Gorbik <gor@linux.ibm.com>
(cherry picked from commit d08d6f5d75242ceb410efbdf650efecc40d68c2d)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/iommu/s390-iommu.c
diff --cc drivers/iommu/s390-iommu.c
index 610f0828f22d,c60d5c776fc6..000000000000
--- a/drivers/iommu/s390-iommu.c
+++ b/drivers/iommu/s390-iommu.c
@@@ -166,16 -166,23 +166,21 @@@ static void s390_iommu_detach_device(st
  	}
  }
  
 -static int s390_iommu_add_device(struct device *dev)
 +static struct iommu_device *s390_iommu_probe_device(struct device *dev)
  {
++<<<<<<< HEAD
 +	struct zpci_dev *zdev = to_pci_dev(dev)->sysdata;
++=======
+ 	struct iommu_group *group = iommu_group_get_for_dev(dev);
+ 	struct zpci_dev *zdev = to_zpci_dev(dev);
++>>>>>>> d08d6f5d7524 (s390/pci: adaptation of iommu to multifunction)
  
 -	if (IS_ERR(group))
 -		return PTR_ERR(group);
 -
 -	iommu_group_put(group);
 -	iommu_device_link(&zdev->iommu_dev, dev);
 -
 -	return 0;
 +	return &zdev->iommu_dev;
  }
  
 -static void s390_iommu_remove_device(struct device *dev)
 +static void s390_iommu_release_device(struct device *dev)
  {
- 	struct zpci_dev *zdev = to_pci_dev(dev)->sysdata;
+ 	struct zpci_dev *zdev = to_zpci_dev(dev);
  	struct iommu_domain *domain;
  
  	/*
diff --git a/arch/s390/include/asm/pci.h b/arch/s390/include/asm/pci.h
index 2d7a8ea6c42b..605776469eb3 100644
--- a/arch/s390/include/asm/pci.h
+++ b/arch/s390/include/asm/pci.h
@@ -227,6 +227,11 @@ static inline struct zpci_dev *to_zpci(struct pci_dev *pdev)
 	return pdev->sysdata;
 }
 
+static inline struct zpci_dev *to_zpci_dev(struct device *dev)
+{
+	return to_zpci(to_pci_dev(dev));
+}
+
 struct zpci_dev *get_zdev_by_fid(u32);
 
 /* DMA */
* Unmerged path drivers/iommu/s390-iommu.c
