powerpc/perf: Add new power PMU flag "PPMU_P10_DD1" for power10 DD1

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-294.el8
commit-author Athira Rajeev <atrajeev@linux.vnet.ibm.com>
commit 9e8d13697c38a86e0fcf1bb20d419e3d6103e085
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-294.el8/9e8d1369.failed

Add a new power PMU flag "PPMU_P10_DD1" which can be used to
conditionally add any code path for power10 DD1 processor version.
Also modify power10 PMU driver code to set this flag only for DD1,
based on the Processor Version Register (PVR) value.

	Signed-off-by: Athira Rajeev <atrajeev@linux.vnet.ibm.com>
	Signed-off-by: Madhavan Srinivasan <maddy@linux.ibm.com>
	Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: https://lore.kernel.org/r/20201021085329.384535-1-maddy@linux.ibm.com
(cherry picked from commit 9e8d13697c38a86e0fcf1bb20d419e3d6103e085)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/powerpc/include/asm/perf_event_server.h
diff --cc arch/powerpc/include/asm/perf_event_server.h
index 4029fd28fae6,3b7baba01c92..000000000000
--- a/arch/powerpc/include/asm/perf_event_server.h
+++ b/arch/powerpc/include/asm/perf_event_server.h
@@@ -84,6 -81,8 +84,11 @@@ struct power_pmu 
  #define PPMU_HAS_SIER		0x00000040 /* Has SIER */
  #define PPMU_ARCH_207S		0x00000080 /* PMC is architecture v2.07S */
  #define PPMU_NO_SIAR		0x00000100 /* Do not use SIAR */
++<<<<<<< HEAD
++=======
+ #define PPMU_ARCH_31		0x00000200 /* Has MMCR3, SIER2 and SIER3 */
+ #define PPMU_P10_DD1		0x00000400 /* Is power10 DD1 processor version */
++>>>>>>> 9e8d13697c38 (powerpc/perf: Add new power PMU flag "PPMU_P10_DD1" for power10 DD1)
  
  /*
   * Values for flags to get_alternatives()
* Unmerged path arch/powerpc/include/asm/perf_event_server.h
diff --git a/arch/powerpc/perf/power10-pmu.c b/arch/powerpc/perf/power10-pmu.c
index 83148656b524..47d930a851f2 100644
--- a/arch/powerpc/perf/power10-pmu.c
+++ b/arch/powerpc/perf/power10-pmu.c
@@ -404,6 +404,7 @@ static struct power_pmu power10_pmu = {
 
 int init_power10_pmu(void)
 {
+	unsigned int pvr;
 	int rc;
 
 	/* Comes from cpu_specs[] */
@@ -411,6 +412,11 @@ int init_power10_pmu(void)
 	    strcmp(cur_cpu_spec->oprofile_cpu_type, "ppc64/power10"))
 		return -ENODEV;
 
+	pvr = mfspr(SPRN_PVR);
+	/* Add the ppmu flag for power10 DD1 */
+	if ((PVR_CFG(pvr) == 1))
+		power10_pmu.flags |= PPMU_P10_DD1;
+
 	/* Set the PERF_REG_EXTENDED_MASK here */
 	PERF_REG_EXTENDED_MASK = PERF_REG_PMU_MASK_31;
 
