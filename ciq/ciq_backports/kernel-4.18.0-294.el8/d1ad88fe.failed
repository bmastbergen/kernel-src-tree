net: atlantic: move IS_CHIP_FEATURE to aq_hw.h

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-294.el8
commit-author Mark Starovoytov <mstarovoitov@marvell.com>
commit d1ad88fe9fa9f5c3e4ecf509efb579852b44cc79
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-294.el8/d1ad88fe.failed

IS_CHIP feature will be used to differentiate between A1 and A2,
where necessary. Thus, move it to aq_hw.h, rename it and make
it accept the 'hw' pointer.

	Signed-off-by: Mark Starovoytov <mstarovoitov@marvell.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit d1ad88fe9fa9f5c3e4ecf509efb579852b44cc79)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/aquantia/atlantic/hw_atl/hw_atl_utils.c
diff --cc drivers/net/ethernet/aquantia/atlantic/hw_atl/hw_atl_utils.c
index 38915aa0fd19,20655a2170cc..000000000000
--- a/drivers/net/ethernet/aquantia/atlantic/hw_atl/hw_atl_utils.c
+++ b/drivers/net/ethernet/aquantia/atlantic/hw_atl/hw_atl_utils.c
@@@ -338,36 -405,10 +338,43 @@@ static int hw_atl_utils_fw_upload_dword
  	if (err < 0)
  		goto err_exit;
  
++<<<<<<< HEAD
 +	if (IS_CHIP_FEATURE(REVISION_B1)) {
 +		u32 offset = 0;
 +
 +		for (; offset < cnt; ++offset) {
 +			aq_hw_write_reg(self, 0x328, p[offset]);
 +			aq_hw_write_reg(self, 0x32C,
 +					(0x80000000 | (0xFFFF & (offset * 4))));
 +			hw_atl_mcp_up_force_intr_set(self, 1);
 +			/* 1000 times by 10us = 10ms */
 +			err = readx_poll_timeout_atomic(hw_atl_scrpad12_get,
 +							self, val,
 +							(val & 0xF0000000) !=
 +							0x80000000,
 +							10U, 10000U);
 +		}
 +	} else {
 +		u32 offset = 0;
 +
 +		aq_hw_write_reg(self, 0x208, a);
 +
 +		for (; offset < cnt; ++offset) {
 +			aq_hw_write_reg(self, 0x20C, p[offset]);
 +			aq_hw_write_reg(self, 0x200, 0xC000);
 +
 +			err = readx_poll_timeout_atomic(hw_atl_utils_mif_cmd_get,
 +							self, val,
 +							(val & 0x100) == 0,
 +							1000U, 10000U);
 +		}
 +	}
++=======
+ 	if (ATL_HW_IS_CHIP_FEATURE(self, REVISION_B1))
+ 		err = hw_atl_utils_write_b1_mbox(self, addr, p, cnt, area);
+ 	else
+ 		err = hw_atl_utils_write_b0_mbox(self, addr, p, cnt);
++>>>>>>> d1ad88fe9fa9 (net: atlantic: move IS_CHIP_FEATURE to aq_hw.h)
  
  	hw_atl_reg_glb_cpu_sem_set(self, 1U, HW_ATL_FW_SM_RAM);
  
@@@ -434,10 -494,10 +441,10 @@@ struct aq_hw_atl_utils_fw_rpc_tid_s 
  
  int hw_atl_utils_fw_rpc_call(struct aq_hw_s *self, unsigned int rpc_size)
  {
 -	struct aq_hw_atl_utils_fw_rpc_tid_s sw;
  	int err = 0;
 +	struct aq_hw_atl_utils_fw_rpc_tid_s sw;
  
- 	if (!IS_CHIP_FEATURE(MIPS)) {
+ 	if (!ATL_HW_IS_CHIP_FEATURE(self, MIPS)) {
  		err = -1;
  		goto err_exit;
  	}
@@@ -734,26 -798,28 +741,28 @@@ unsigned int hw_atl_utils_mbps_2_speed_
  
  void hw_atl_utils_hw_chip_features_init(struct aq_hw_s *self, u32 *p)
  {
 +	u32 chip_features = 0U;
  	u32 val = hw_atl_reg_glb_mif_id_get(self);
  	u32 mif_rev = val & 0xFFU;
 -	u32 chip_features = 0U;
  
+ 	chip_features |= ATL_HW_CHIP_ATLANTIC;
+ 
  	if ((0xFU & mif_rev) == 1U) {
- 		chip_features |= HAL_ATLANTIC_UTILS_CHIP_REVISION_A0 |
- 			HAL_ATLANTIC_UTILS_CHIP_MPI_AQ |
- 			HAL_ATLANTIC_UTILS_CHIP_MIPS;
+ 		chip_features |= ATL_HW_CHIP_REVISION_A0 |
+ 			ATL_HW_CHIP_MPI_AQ |
+ 			ATL_HW_CHIP_MIPS;
  	} else if ((0xFU & mif_rev) == 2U) {
- 		chip_features |= HAL_ATLANTIC_UTILS_CHIP_REVISION_B0 |
- 			HAL_ATLANTIC_UTILS_CHIP_MPI_AQ |
- 			HAL_ATLANTIC_UTILS_CHIP_MIPS |
- 			HAL_ATLANTIC_UTILS_CHIP_TPO2 |
- 			HAL_ATLANTIC_UTILS_CHIP_RPF2;
+ 		chip_features |= ATL_HW_CHIP_REVISION_B0 |
+ 			ATL_HW_CHIP_MPI_AQ |
+ 			ATL_HW_CHIP_MIPS |
+ 			ATL_HW_CHIP_TPO2 |
+ 			ATL_HW_CHIP_RPF2;
  	} else if ((0xFU & mif_rev) == 0xAU) {
- 		chip_features |= HAL_ATLANTIC_UTILS_CHIP_REVISION_B1 |
- 			HAL_ATLANTIC_UTILS_CHIP_MPI_AQ |
- 			HAL_ATLANTIC_UTILS_CHIP_MIPS |
- 			HAL_ATLANTIC_UTILS_CHIP_TPO2 |
- 			HAL_ATLANTIC_UTILS_CHIP_RPF2;
+ 		chip_features |= ATL_HW_CHIP_REVISION_B1 |
+ 			ATL_HW_CHIP_MPI_AQ |
+ 			ATL_HW_CHIP_MIPS |
+ 			ATL_HW_CHIP_TPO2 |
+ 			ATL_HW_CHIP_RPF2;
  	}
  
  	*p = chip_features;
diff --git a/drivers/net/ethernet/aquantia/atlantic/aq_hw.h b/drivers/net/ethernet/aquantia/atlantic/aq_hw.h
index 46eaf70c5ccb..8742670d9b06 100644
--- a/drivers/net/ethernet/aquantia/atlantic/aq_hw.h
+++ b/drivers/net/ethernet/aquantia/atlantic/aq_hw.h
@@ -118,6 +118,19 @@ struct aq_stats_s {
 #define AQ_HW_TXD_MULTIPLE 8U
 #define AQ_HW_RXD_MULTIPLE 8U
 
+#define ATL_HW_CHIP_MIPS         0x00000001U
+#define ATL_HW_CHIP_TPO2         0x00000002U
+#define ATL_HW_CHIP_RPF2         0x00000004U
+#define ATL_HW_CHIP_MPI_AQ       0x00000010U
+#define ATL_HW_CHIP_ATLANTIC     0x00800000U
+#define ATL_HW_CHIP_REVISION_A0  0x01000000U
+#define ATL_HW_CHIP_REVISION_B0  0x02000000U
+#define ATL_HW_CHIP_REVISION_B1  0x04000000U
+#define ATL_HW_CHIP_ANTIGUA      0x08000000U
+
+#define ATL_HW_IS_CHIP_FEATURE(_HW_, _F_) (!!(ATL_HW_CHIP_##_F_ & \
+	(_HW_)->chip_features))
+
 struct aq_hw_s {
 	atomic_t flags;
 	u8 rbl_enabled:1;
diff --git a/drivers/net/ethernet/aquantia/atlantic/hw_atl/hw_atl_a0.c b/drivers/net/ethernet/aquantia/atlantic/hw_atl/hw_atl_a0.c
index ec4ee92db31b..b47ce2d11f73 100644
--- a/drivers/net/ethernet/aquantia/atlantic/hw_atl/hw_atl_a0.c
+++ b/drivers/net/ethernet/aquantia/atlantic/hw_atl/hw_atl_a0.c
@@ -270,7 +270,7 @@ static int hw_atl_a0_hw_init_tx_path(struct aq_hw_s *self)
 	hw_atl_tdm_tx_desc_wr_wb_irq_en_set(self, 1U);
 
 	/* misc */
-	aq_hw_write_reg(self, 0x00007040U, IS_CHIP_FEATURE(TPO2) ?
+	aq_hw_write_reg(self, 0x00007040U, ATL_HW_IS_CHIP_FEATURE(self, TPO2) ?
 			0x00010000U : 0x00000000U);
 	hw_atl_tdm_tx_dca_en_set(self, 0U);
 	hw_atl_tdm_tx_dca_mode_set(self, 0U);
diff --git a/drivers/net/ethernet/aquantia/atlantic/hw_atl/hw_atl_b0.c b/drivers/net/ethernet/aquantia/atlantic/hw_atl/hw_atl_b0.c
index b7e5ce0d7af5..2c46c9f56fee 100644
--- a/drivers/net/ethernet/aquantia/atlantic/hw_atl/hw_atl_b0.c
+++ b/drivers/net/ethernet/aquantia/atlantic/hw_atl/hw_atl_b0.c
@@ -299,7 +299,7 @@ static int hw_atl_b0_hw_init_tx_path(struct aq_hw_s *self)
 	hw_atl_tdm_tx_desc_wr_wb_irq_en_set(self, 1U);
 
 	/* misc */
-	aq_hw_write_reg(self, 0x00007040U, IS_CHIP_FEATURE(TPO2) ?
+	aq_hw_write_reg(self, 0x00007040U, ATL_HW_IS_CHIP_FEATURE(self, TPO2) ?
 			0x00010000U : 0x00000000U);
 	hw_atl_tdm_tx_dca_en_set(self, 0U);
 	hw_atl_tdm_tx_dca_mode_set(self, 0U);
@@ -347,8 +347,8 @@ static int hw_atl_b0_hw_init_rx_path(struct aq_hw_s *self)
 	hw_atl_rdm_rx_desc_wr_wb_irq_en_set(self, 1U);
 
 	/* misc */
-	aq_hw_write_reg(self, 0x00005040U,
-			IS_CHIP_FEATURE(RPF2) ? 0x000F0000U : 0x00000000U);
+	aq_hw_write_reg(self, 0x00005040U, ATL_HW_IS_CHIP_FEATURE(self, RPF2) ?
+			0x000F0000U : 0x00000000U);
 
 	hw_atl_rpfl2broadcast_flr_act_set(self, 1U);
 	hw_atl_rpfl2broadcast_count_threshold_set(self, 0xFFFFU & (~0U / 256U));
* Unmerged path drivers/net/ethernet/aquantia/atlantic/hw_atl/hw_atl_utils.c
diff --git a/drivers/net/ethernet/aquantia/atlantic/hw_atl/hw_atl_utils.h b/drivers/net/ethernet/aquantia/atlantic/hw_atl/hw_atl_utils.h
index 7b58f16ebe72..9a7a3bb53ebd 100644
--- a/drivers/net/ethernet/aquantia/atlantic/hw_atl/hw_atl_utils.h
+++ b/drivers/net/ethernet/aquantia/atlantic/hw_atl/hw_atl_utils.h
@@ -298,17 +298,6 @@ enum hw_atl_rx_ctrl_registers_l3l4 {
 #define HW_ATL_GET_REG_LOCATION_FL3L4(location) \
 	((location) - AQ_RX_FIRST_LOC_FL3L4)
 
-#define HAL_ATLANTIC_UTILS_CHIP_MIPS         0x00000001U
-#define HAL_ATLANTIC_UTILS_CHIP_TPO2         0x00000002U
-#define HAL_ATLANTIC_UTILS_CHIP_RPF2         0x00000004U
-#define HAL_ATLANTIC_UTILS_CHIP_MPI_AQ       0x00000010U
-#define HAL_ATLANTIC_UTILS_CHIP_REVISION_A0  0x01000000U
-#define HAL_ATLANTIC_UTILS_CHIP_REVISION_B0  0x02000000U
-#define HAL_ATLANTIC_UTILS_CHIP_REVISION_B1  0x04000000U
-
-#define IS_CHIP_FEATURE(_F_) (HAL_ATLANTIC_UTILS_CHIP_##_F_ & \
-	self->chip_features)
-
 enum hal_atl_utils_fw_state_e {
 	MPI_DEINIT = 0,
 	MPI_RESET = 1,
