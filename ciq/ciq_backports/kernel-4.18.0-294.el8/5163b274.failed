RDMA/mlx5: Refactor affinity related code

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-294.el8
commit-author Maor Gottlieb <maorg@mellanox.com>
commit 5163b2743ae00bf428a8a7e06839943b2f3965ed
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-294.el8/5163b274.failed

Move affinity related code in modify qp to function.  It's a preparation
for next patch the extend the affinity calculation to consider the xmit
slave.

Link: https://lore.kernel.org/r/20200430192146.12863-16-maorg@mellanox.com
	Signed-off-by: Maor Gottlieb <maorg@mellanox.com>
	Reviewed-by: Leon Romanovsky <leonro@mellanox.com>
	Signed-off-by: Jason Gunthorpe <jgg@mellanox.com>
(cherry picked from commit 5163b2743ae00bf428a8a7e06839943b2f3965ed)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/hw/mlx5/qp.c
diff --cc drivers/infiniband/hw/mlx5/qp.c
index 08f1eef60c1f,14bfdfc8ab96..000000000000
--- a/drivers/infiniband/hw/mlx5/qp.c
+++ b/drivers/infiniband/hw/mlx5/qp.c
@@@ -3518,22 -3746,10 +3546,29 @@@ static int __mlx5_ib_modify_qp(struct i
  		}
  	}
  
++<<<<<<< HEAD
 +	if ((cur_state == IB_QPS_RESET) && (new_state == IB_QPS_INIT)) {
 +		if ((ibqp->qp_type == IB_QPT_RC) ||
 +		    (ibqp->qp_type == IB_QPT_UD &&
 +		     !(qp->flags & MLX5_IB_QP_SQPN_QP1)) ||
 +		    (ibqp->qp_type == IB_QPT_UC) ||
 +		    (ibqp->qp_type == IB_QPT_RAW_PACKET) ||
 +		    (ibqp->qp_type == IB_QPT_XRC_INI) ||
 +		    (ibqp->qp_type == IB_QPT_XRC_TGT)) {
 +			if (dev->lag_active) {
 +				u8 p = mlx5_core_native_port_num(dev->mdev) - 1;
 +				tx_affinity = get_tx_affinity(dev, pd, base, p,
 +							      udata);
 +				context->flags |= cpu_to_be32(tx_affinity << 24);
 +			}
 +		}
 +	}
++=======
+ 	tx_affinity = get_tx_affinity(ibqp,
+ 				      cur_state == IB_QPS_RESET &&
+ 				      new_state == IB_QPS_INIT, udata);
+ 	context->flags |= cpu_to_be32(tx_affinity << 24);
++>>>>>>> 5163b2743ae0 (RDMA/mlx5: Refactor affinity related code)
  
  	if (is_sqp(ibqp->qp_type)) {
  		context->mtu_msgmax = (IB_MTU_256 << 5) | 8;
* Unmerged path drivers/infiniband/hw/mlx5/qp.c
