scsi: qla2xxx: Fix gnl.l memory leak on adapter init failure

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-294.el8
commit-author Bill Kuzeja <William.Kuzeja@stratus.com>
commit 26fa656e9a0cbccddf7db132ea020d2169dbe46e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-294.el8/26fa656e.failed

If HBA initialization fails unexpectedly (exiting via probe_failed:), we
may fail to free vha->gnl.l. So that we don't attempt to double free, set
this pointer to NULL after a free and check for NULL at probe_failed: so we
know whether or not to call dma_free_coherent.

	Signed-off-by: Bill Kuzeja <william.kuzeja@stratus.com>
	Acked-by: Himanshu Madhani <hmadhani@marvell.com>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit 26fa656e9a0cbccddf7db132ea020d2169dbe46e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/qla2xxx/qla_os.c
diff --cc drivers/scsi/qla2xxx/qla_os.c
index 1a9e3bf1112f,98e60a34afd9..000000000000
--- a/drivers/scsi/qla2xxx/qla_os.c
+++ b/drivers/scsi/qla2xxx/qla_os.c
@@@ -4721,7 -4824,8 +4729,12 @@@ struct scsi_qla_host *qla2x00_create_ho
  		    "Alloc failed for scan database.\n");
  		dma_free_coherent(&ha->pdev->dev, vha->gnl.size,
  		    vha->gnl.l, vha->gnl.ldma);
++<<<<<<< HEAD
 +		scsi_host_put(vha->host);
++=======
+ 		vha->gnl.l = NULL;
+ 		scsi_remove_host(vha->host);
++>>>>>>> 26fa656e9a0c (scsi: qla2xxx: Fix gnl.l memory leak on adapter init failure)
  		return NULL;
  	}
  	INIT_DELAYED_WORK(&vha->scan.scan_work, qla_scan_work_fn);
diff --git a/drivers/scsi/qla2xxx/qla_attr.c b/drivers/scsi/qla2xxx/qla_attr.c
index ecaa77cb74d9..853b7db9221d 100644
--- a/drivers/scsi/qla2xxx/qla_attr.c
+++ b/drivers/scsi/qla2xxx/qla_attr.c
@@ -2987,6 +2987,8 @@ qla24xx_vport_delete(struct fc_vport *fc_vport)
 	dma_free_coherent(&ha->pdev->dev, vha->gnl.size, vha->gnl.l,
 	    vha->gnl.ldma);
 
+	vha->gnl.l = NULL;
+
 	vfree(vha->scan.l);
 
 	if (vha->qpair && vha->qpair->vp_idx == vha->vp_idx) {
* Unmerged path drivers/scsi/qla2xxx/qla_os.c
