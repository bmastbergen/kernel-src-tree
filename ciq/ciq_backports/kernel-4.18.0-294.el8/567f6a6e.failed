dma-direct: provide function to check physical memory area validity

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-294.el8
commit-author Nicolas Saenz Julienne <nsaenzjulienne@suse.de>
commit 567f6a6eba0c09e5f502e0290e57651befa8aacb
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-294.el8/567f6a6e.failed

dma_coherent_ok() checks if a physical memory area fits a device's DMA
constraints.

	Signed-off-by: Nicolas Saenz Julienne <nsaenzjulienne@suse.de>
	Signed-off-by: Christoph Hellwig <hch@lst.de>
(cherry picked from commit 567f6a6eba0c09e5f502e0290e57651befa8aacb)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	include/linux/dma-direct.h
diff --cc include/linux/dma-direct.h
index 1628fb6087ec,ab2e20cba951..000000000000
--- a/include/linux/dma-direct.h
+++ b/include/linux/dma-direct.h
@@@ -68,7 -51,25 +68,13 @@@ static inline phys_addr_t dma_to_phys(s
  	return __sme_clr(__dma_to_phys(dev, daddr));
  }
  
 -static inline bool dma_capable(struct device *dev, dma_addr_t addr, size_t size,
 -		bool is_ram)
 -{
 -	dma_addr_t end = addr + size - 1;
 -
 -	if (!dev->dma_mask)
 -		return false;
 -
 -	if (is_ram && !IS_ENABLED(CONFIG_ARCH_DMA_ADDR_T_64BIT) &&
 -	    min(addr, end) < phys_to_dma(dev, PFN_PHYS(min_low_pfn)))
 -		return false;
 -
 -	return end <= min_not_zero(*dev->dma_mask, dev->bus_dma_limit);
 -}
 -
  u64 dma_direct_get_required_mask(struct device *dev);
++<<<<<<< HEAD
++=======
+ gfp_t dma_direct_optimal_gfp_mask(struct device *dev, u64 dma_mask,
+ 				  u64 *phys_mask);
+ bool dma_coherent_ok(struct device *dev, phys_addr_t phys, size_t size);
++>>>>>>> 567f6a6eba0c (dma-direct: provide function to check physical memory area validity)
  void *dma_direct_alloc(struct device *dev, size_t size, dma_addr_t *dma_handle,
  		gfp_t gfp, unsigned long attrs);
  void dma_direct_free(struct device *dev, size_t size, void *cpu_addr,
* Unmerged path include/linux/dma-direct.h
diff --git a/kernel/dma/direct.c b/kernel/dma/direct.c
index 525872f7fe09..24f7ca8197ab 100644
--- a/kernel/dma/direct.c
+++ b/kernel/dma/direct.c
@@ -70,7 +70,7 @@ static gfp_t __dma_direct_optimal_gfp_mask(struct device *dev, u64 dma_mask,
 	return 0;
 }
 
-static bool dma_coherent_ok(struct device *dev, phys_addr_t phys, size_t size)
+bool dma_coherent_ok(struct device *dev, phys_addr_t phys, size_t size)
 {
 	return phys_to_dma_direct(dev, phys) + size - 1 <=
 			min_not_zero(dev->coherent_dma_mask, dev->bus_dma_limit);
