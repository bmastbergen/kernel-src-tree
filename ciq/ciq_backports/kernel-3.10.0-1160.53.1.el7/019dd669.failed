gfs2: don't allow releasepage to free bd still used for revokes

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1160.53.1.el7
commit-author Bob Peterson <rpeterso@redhat.com>
commit 019dd669bde14bc0748bc43af2f96e2c5e37d3f8
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1160.53.1.el7/019dd669.failed

Before this patch, function gfs2_releasepage would free any bd
elements that had been used for the page being released. However,
those bd elements may still be queued to the sd_log_revokes list,
in which case we cannot free them until the revoke has been issued.

This patch adds additional checks for bds that are still being
used for revokes.

	Signed-off-by: Bob Peterson <rpeterso@redhat.com>
(cherry picked from commit 019dd669bde14bc0748bc43af2f96e2c5e37d3f8)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/gfs2/aops.c
diff --cc fs/gfs2/aops.c
index 0b7cbf658c05,786c1ce8f030..000000000000
--- a/fs/gfs2/aops.c
+++ b/fs/gfs2/aops.c
@@@ -1188,19 -805,17 +1188,32 @@@ int gfs2_releasepage(struct page *page
  		bd = bh->b_private;
  		if (bd) {
  			gfs2_assert_warn(sdp, bd->bd_bh == bh);
++<<<<<<< HEAD
 +			if (!list_empty(&bd->bd_list)) {
 +				if (!buffer_pinned(bh))
 +					list_del_init(&bd->bd_list);
 +				else
 +					bd = NULL;
 +			}
 +			if (bd)
 +				bd->bd_bh = NULL;
 +			bh->b_private = NULL;
++=======
+ 			bd->bd_bh = NULL;
+ 			bh->b_private = NULL;
+ 			/*
+ 			 * The bd may still be queued as a revoke, in which
+ 			 * case we must not dequeue nor free it.
+ 			 */
+ 			if (!bd->bd_blkno && !list_empty(&bd->bd_list))
+ 				list_del_init(&bd->bd_list);
+ 			if (list_empty(&bd->bd_list))
+ 				kmem_cache_free(gfs2_bufdata_cachep, bd);
++>>>>>>> 019dd669bde1 (gfs2: don't allow releasepage to free bd still used for revokes)
  		}
 +		gfs2_log_unlock(sdp);
 +		if (bd)
 +			kmem_cache_free(gfs2_bufdata_cachep, bd);
  
  		bh = bh->b_this_page;
  	} while (bh != head);
* Unmerged path fs/gfs2/aops.c
