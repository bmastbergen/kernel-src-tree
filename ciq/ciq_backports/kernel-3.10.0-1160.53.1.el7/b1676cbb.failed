gfs2: Withdraw in gfs2_ail1_flush if write_cache_pages fails

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-1160.53.1.el7
commit-author Bob Peterson <rpeterso@redhat.com>
commit b1676cbb11153b5bf4dd9e6c99869b284fb8160e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1160.53.1.el7/b1676cbb.failed

Before this patch, function gfs2_ail1_start_one would return any
errors it received from write_cache_pages (except -EBUSY) but it did
not withdraw. Since function gfs2_ail1_flush just checks for the bad
return code and loops, the loop might potentially never end.
This patch adds some logic to allow it to exit the loop and withdraw
properly when errors are received from write_cache_pages.

	Signed-off-by: Bob Peterson <rpeterso@redhat.com>
	Reviewed-by: Andreas Gruenbacher <agruenba@redhat.com>
(cherry picked from commit b1676cbb11153b5bf4dd9e6c99869b284fb8160e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/gfs2/log.c
diff --cc fs/gfs2/log.c
index 78f81ccc8357,ed80ef8e5c33..000000000000
--- a/fs/gfs2/log.c
+++ b/fs/gfs2/log.c
@@@ -145,17 -153,27 +146,36 @@@ void gfs2_ail1_flush(struct gfs2_sbd *s
  {
  	struct list_head *head = &sdp->sd_ail1_list;
  	struct gfs2_trans *tr;
++<<<<<<< HEAD
++=======
+ 	struct blk_plug plug;
+ 	int ret = 0;
++>>>>>>> b1676cbb1115 (gfs2: Withdraw in gfs2_ail1_flush if write_cache_pages fails)
  
  	trace_gfs2_ail_flush(sdp, wbc, 1);
 -	blk_start_plug(&plug);
  	spin_lock(&sdp->sd_ail_lock);
  restart:
  	list_for_each_entry_reverse(tr, head, tr_list) {
  		if (wbc->nr_to_write <= 0)
  			break;
++<<<<<<< HEAD
 +		if (gfs2_ail1_start_one(sdp, wbc, tr))
 +			goto restart;
 +	}
 +	spin_unlock(&sdp->sd_ail_lock);
++=======
+ 		ret = gfs2_ail1_start_one(sdp, wbc, tr);
+ 		if (ret) {
+ 			if (ret == -EBUSY)
+ 				goto restart;
+ 			break;
+ 		}
+ 	}
+ 	spin_unlock(&sdp->sd_ail_lock);
+ 	blk_finish_plug(&plug);
+ 	if (ret)
+ 		gfs2_withdraw(sdp);
++>>>>>>> b1676cbb1115 (gfs2: Withdraw in gfs2_ail1_flush if write_cache_pages fails)
  	trace_gfs2_ail_flush(sdp, wbc, 0);
  }
  
* Unmerged path fs/gfs2/log.c
