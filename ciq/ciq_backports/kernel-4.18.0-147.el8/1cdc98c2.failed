vxlan: changelink: Delete remote after update

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-147.el8
commit-author Petr Machata <petrm@mellanox.com>
commit 1cdc98c2711e42d956c4a5ce525d3f8e90c58f9e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-147.el8/1cdc98c2.failed

If a change in remote address prompts a change in a default FDB entry,
that change might be vetoed. If that happens, it would then be necessary
to reinstate the already-removed default FDB entry corresponding to the
previous remote address.

Instead, arrange to have the previous address removed only after the
FDB is successfully vetted.

	Signed-off-by: Petr Machata <petrm@mellanox.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 1cdc98c2711e42d956c4a5ce525d3f8e90c58f9e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/vxlan.c
diff --cc drivers/net/vxlan.c
index e5a81fc3b94d,83f65eb3085f..000000000000
--- a/drivers/net/vxlan.c
+++ b/drivers/net/vxlan.c
@@@ -3633,25 -3806,12 +3633,32 @@@ static int vxlan_changelink(struct net_
  	if (err)
  		return err;
  
++<<<<<<< HEAD
 +	vxlan_config_apply(dev, &conf, lowerdev, vxlan->net, true);
 +
 +	if (old_age_interval != vxlan->cfg.age_interval)
 +		mod_timer(&vxlan->age_timer, jiffies);
 +
 +	/* handle default dst entry */
 +	if (!vxlan_addr_equal(&dst->remote_ip, &old_dst.remote_ip)) {
 +		spin_lock_bh(&vxlan->hash_lock);
 +		if (!vxlan_addr_any(&old_dst.remote_ip))
 +			__vxlan_fdb_delete(vxlan, all_zeros_mac,
 +					   old_dst.remote_ip,
 +					   vxlan->cfg.dst_port,
 +					   old_dst.remote_vni,
 +					   old_dst.remote_vni,
 +					   old_dst.remote_ifindex);
 +
 +		if (!vxlan_addr_any(&dst->remote_ip)) {
++=======
+ 	/* handle default dst entry */
+ 	if (!vxlan_addr_equal(&conf.remote_ip, &dst->remote_ip)) {
+ 		spin_lock_bh(&vxlan->hash_lock);
+ 		if (!vxlan_addr_any(&conf.remote_ip)) {
++>>>>>>> 1cdc98c2711e (vxlan: changelink: Delete remote after update)
  			err = vxlan_fdb_update(vxlan, all_zeros_mac,
 -					       &conf.remote_ip,
 +					       &dst->remote_ip,
  					       NUD_REACHABLE | NUD_PERMANENT,
  					       NLM_F_APPEND | NLM_F_CREATE,
  					       vxlan->cfg.dst_port,
* Unmerged path drivers/net/vxlan.c
