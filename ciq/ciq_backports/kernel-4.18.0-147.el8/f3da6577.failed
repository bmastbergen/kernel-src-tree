RDMA/mlx5: Initialize SRQ tables on mlx5_ib

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-147.el8
commit-author Leon Romanovsky <leon@kernel.org>
commit f3da6577da67a3cd44610ca54e308c6838c92157
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-147.el8/f3da6577.failed

Transfer initialization and cleanup from mlx5_priv struct of
mlx5_core_dev to be part of mlx5_ib_dev. This completes removal
of SRQ from mlx5_core.

	Reviewed-by: Mark Bloch <markb@mellanox.com>
	Signed-off-by: Leon Romanovsky <leonro@mellanox.com>
(cherry picked from commit f3da6577da67a3cd44610ca54e308c6838c92157)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/hw/mlx5/mlx5_ib.h
#	drivers/infiniband/hw/mlx5/srq.h
#	drivers/infiniband/hw/mlx5/srq_cmd.c
#	drivers/net/ethernet/mellanox/mlx5/core/srq.c
#	include/linux/mlx5/driver.h
#	include/linux/mlx5/srq.h
diff --cc drivers/infiniband/hw/mlx5/mlx5_ib.h
index ceae1f16ebc9,861b68f2e330..000000000000
--- a/drivers/infiniband/hw/mlx5/mlx5_ib.h
+++ b/drivers/infiniband/hw/mlx5/mlx5_ib.h
@@@ -39,15 -39,18 +39,16 @@@
  #include <rdma/ib_smi.h>
  #include <linux/mlx5/driver.h>
  #include <linux/mlx5/cq.h>
 -#include <linux/mlx5/fs.h>
  #include <linux/mlx5/qp.h>
- #include <linux/mlx5/srq.h>
  #include <linux/mlx5/fs.h>
  #include <linux/types.h>
  #include <linux/mlx5/transobj.h>
  #include <rdma/ib_user_verbs.h>
  #include <rdma/mlx5-abi.h>
  #include <rdma/uverbs_ioctl.h>
 -#include <rdma/mlx5_user_ioctl_cmds.h>
  
+ #include "srq.h"
+ 
  #define mlx5_ib_dbg(_dev, format, arg...)                                      \
  	dev_dbg(&(_dev)->ib_dev.dev, "%s:%d:(pid %d): " format, __func__,      \
  		__LINE__, current->pid, ##arg)
@@@ -754,7 -775,9 +755,8 @@@ enum mlx5_ib_stages 
  	MLX5_IB_STAGE_CAPS,
  	MLX5_IB_STAGE_NON_DEFAULT_CB,
  	MLX5_IB_STAGE_ROCE,
+ 	MLX5_IB_STAGE_SRQ,
  	MLX5_IB_STAGE_DEVICE_RESOURCES,
 -	MLX5_IB_STAGE_DEVICE_NOTIFIER,
  	MLX5_IB_STAGE_ODP,
  	MLX5_IB_STAGE_COUNTERS,
  	MLX5_IB_STAGE_CONG_DEBUGFS,
@@@ -894,6 -943,8 +896,11 @@@ struct mlx5_ib_dev 
  	struct list_head	ib_dev_list;
  	u64			sys_image_guid;
  	struct mlx5_memic	memic;
++<<<<<<< HEAD
++=======
+ 	u16			devx_whitelist_uid;
+ 	struct mlx5_srq_table   srq_table;
++>>>>>>> f3da6577da67 (RDMA/mlx5: Initialize SRQ tables on mlx5_ib)
  };
  
  static inline struct mlx5_ib_cq *to_mibcq(struct mlx5_core_cq *mcq)
diff --cc include/linux/mlx5/driver.h
index 17a4bd81b40d,584d8a5df7eb..000000000000
--- a/include/linux/mlx5/driver.h
+++ b/include/linux/mlx5/driver.h
@@@ -457,31 -392,6 +456,34 @@@ struct mlx5_core_rsc_common 
  	struct completion	free;
  };
  
++<<<<<<< HEAD
 +struct mlx5_core_srq {
 +	struct mlx5_core_rsc_common	common; /* must be first */
 +	u32		srqn;
 +	int		max;
 +	size_t		max_gs;
 +	size_t		max_avail_gather;
 +	int		wqe_shift;
 +	void (*event)	(struct mlx5_core_srq *, enum mlx5_event);
 +
 +	atomic_t		refcount;
 +	struct completion	free;
 +	u16		uid;
 +};
 +
 +struct mlx5_eq_table {
 +	struct list_head	comp_eqs_list;
 +	struct mlx5_eq		pages_eq;
 +	struct mlx5_eq		async_eq;
 +	struct mlx5_eq		cmd_eq;
 +#ifdef CONFIG_INFINIBAND_ON_DEMAND_PAGING
 +	struct mlx5_eq		pfault_eq;
 +#endif
 +	int			num_comp_vectors;
 +};
 +
++=======
++>>>>>>> f3da6577da67 (RDMA/mlx5: Initialize SRQ tables on mlx5_ib)
  struct mlx5_uars_page {
  	void __iomem	       *map;
  	bool			wc;
@@@ -531,19 -441,14 +533,22 @@@ struct mlx5_core_health 
  };
  
  struct mlx5_qp_table {
 -	struct notifier_block   nb;
 +	/* protect radix tree
 +	 */
 +	spinlock_t		lock;
 +	struct radix_tree_root	tree;
 +};
  
++<<<<<<< HEAD
 +struct mlx5_srq_table {
  	/* protect radix tree
  	 */
  	spinlock_t		lock;
  	struct radix_tree_root	tree;
  };
  
++=======
++>>>>>>> f3da6577da67 (RDMA/mlx5: Initialize SRQ tables on mlx5_ib)
  struct mlx5_mkey_table {
  	/* protect radix tree
  	 */
* Unmerged path drivers/infiniband/hw/mlx5/srq.h
* Unmerged path drivers/infiniband/hw/mlx5/srq_cmd.c
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/srq.c
* Unmerged path include/linux/mlx5/srq.h
diff --git a/drivers/infiniband/hw/mlx5/ib_rep.c b/drivers/infiniband/hw/mlx5/ib_rep.c
index cd36662145c2..13bb23e60775 100644
--- a/drivers/infiniband/hw/mlx5/ib_rep.c
+++ b/drivers/infiniband/hw/mlx5/ib_rep.c
@@ -4,6 +4,7 @@
  */
 
 #include "ib_rep.h"
+#include "srq.h"
 
 static const struct mlx5_ib_profile rep_profile = {
 	STAGE_CREATE(MLX5_IB_STAGE_INIT,
@@ -21,6 +22,9 @@ static const struct mlx5_ib_profile rep_profile = {
 	STAGE_CREATE(MLX5_IB_STAGE_ROCE,
 		     mlx5_ib_stage_rep_roce_init,
 		     mlx5_ib_stage_rep_roce_cleanup),
+	STAGE_CREATE(MLX5_IB_STAGE_SRQ,
+		     mlx5_init_srq_table,
+		     mlx5_cleanup_srq_table),
 	STAGE_CREATE(MLX5_IB_STAGE_DEVICE_RESOURCES,
 		     mlx5_ib_stage_dev_res_init,
 		     mlx5_ib_stage_dev_res_cleanup),
diff --git a/drivers/infiniband/hw/mlx5/main.c b/drivers/infiniband/hw/mlx5/main.c
index 72ce00f38f1d..9c763bd140dc 100644
--- a/drivers/infiniband/hw/mlx5/main.c
+++ b/drivers/infiniband/hw/mlx5/main.c
@@ -60,6 +60,7 @@
 #include "mlx5_ib.h"
 #include "ib_rep.h"
 #include "cmd.h"
+#include "srq.h"
 #include <linux/mlx5/fs_helpers.h>
 #include <linux/mlx5/accel.h>
 #include <rdma/uverbs_std_types.h>
@@ -5952,6 +5953,9 @@ static const struct mlx5_ib_profile pf_profile = {
 	STAGE_CREATE(MLX5_IB_STAGE_ROCE,
 		     mlx5_ib_stage_roce_init,
 		     mlx5_ib_stage_roce_cleanup),
+	STAGE_CREATE(MLX5_IB_STAGE_SRQ,
+		     mlx5_init_srq_table,
+		     mlx5_cleanup_srq_table),
 	STAGE_CREATE(MLX5_IB_STAGE_DEVICE_RESOURCES,
 		     mlx5_ib_stage_dev_res_init,
 		     mlx5_ib_stage_dev_res_cleanup),
@@ -6006,6 +6010,9 @@ static const struct mlx5_ib_profile nic_rep_profile = {
 	STAGE_CREATE(MLX5_IB_STAGE_ROCE,
 		     mlx5_ib_stage_rep_roce_init,
 		     mlx5_ib_stage_rep_roce_cleanup),
+	STAGE_CREATE(MLX5_IB_STAGE_SRQ,
+		     mlx5_init_srq_table,
+		     mlx5_cleanup_srq_table),
 	STAGE_CREATE(MLX5_IB_STAGE_DEVICE_RESOURCES,
 		     mlx5_ib_stage_dev_res_init,
 		     mlx5_ib_stage_dev_res_cleanup),
* Unmerged path drivers/infiniband/hw/mlx5/mlx5_ib.h
diff --git a/drivers/infiniband/hw/mlx5/srq.c b/drivers/infiniband/hw/mlx5/srq.c
index 1794bcd84df5..43e4fec27f1d 100644
--- a/drivers/infiniband/hw/mlx5/srq.c
+++ b/drivers/infiniband/hw/mlx5/srq.c
@@ -5,7 +5,6 @@
 
 #include <linux/module.h>
 #include <linux/mlx5/qp.h>
-#include <linux/mlx5/srq.h>
 #include <linux/slab.h>
 #include <rdma/ib_umem.h>
 #include <rdma/ib_user_verbs.h>
* Unmerged path drivers/infiniband/hw/mlx5/srq.h
* Unmerged path drivers/infiniband/hw/mlx5/srq_cmd.c
diff --git a/drivers/net/ethernet/mellanox/mlx5/core/Makefile b/drivers/net/ethernet/mellanox/mlx5/core/Makefile
index a094c09dfaa9..1c199152ea21 100644
--- a/drivers/net/ethernet/mellanox/mlx5/core/Makefile
+++ b/drivers/net/ethernet/mellanox/mlx5/core/Makefile
@@ -12,7 +12,7 @@ obj-$(CONFIG_MLX5_CORE) += mlx5_core.o
 # mlx5 core basic
 #
 mlx5_core-y :=	main.o cmd.o debugfs.o fw.o eq.o uar.o pagealloc.o \
-		health.o mcg.o cq.o srq.o alloc.o qp.o port.o mr.o pd.o \
+		health.o mcg.o cq.o alloc.o qp.o port.o mr.o pd.o \
 		mad.o transobj.o vport.o sriov.o fs_cmd.o fs_core.o \
 		fs_counters.o rl.o lag.o dev.o wq.o lib/gid.o  \
 		diag/fs_tracepoint.o
diff --git a/drivers/net/ethernet/mellanox/mlx5/core/main.c b/drivers/net/ethernet/mellanox/mlx5/core/main.c
index cfdc2f0b35a2..decf1302fcf2 100644
--- a/drivers/net/ethernet/mellanox/mlx5/core/main.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/main.c
@@ -43,7 +43,6 @@
 #include <linux/mlx5/driver.h>
 #include <linux/mlx5/cq.h>
 #include <linux/mlx5/qp.h>
-#include <linux/mlx5/srq.h>
 #include <linux/debugfs.h>
 #include <linux/kmod.h>
 #include <linux/mlx5/mlx5_ifc.h>
@@ -948,8 +947,6 @@ static int mlx5_init_once(struct mlx5_core_dev *dev, struct mlx5_priv *priv)
 
 	mlx5_init_qp_table(dev);
 
-	mlx5_init_srq_table(dev);
-
 	mlx5_init_mkey_table(dev);
 
 	mlx5_init_reserved_gids(dev);
@@ -1001,7 +998,6 @@ static int mlx5_init_once(struct mlx5_core_dev *dev, struct mlx5_priv *priv)
 err_tables_cleanup:
 	mlx5_vxlan_destroy(dev->vxlan);
 	mlx5_cleanup_mkey_table(dev);
-	mlx5_cleanup_srq_table(dev);
 	mlx5_cleanup_qp_table(dev);
 	mlx5_cq_debugfs_cleanup(dev);
 
@@ -1023,7 +1019,6 @@ static void mlx5_cleanup_once(struct mlx5_core_dev *dev)
 	mlx5_cleanup_clock(dev);
 	mlx5_cleanup_reserved_gids(dev);
 	mlx5_cleanup_mkey_table(dev);
-	mlx5_cleanup_srq_table(dev);
 	mlx5_cleanup_qp_table(dev);
 	mlx5_cq_debugfs_cleanup(dev);
 	mlx5_eq_cleanup(dev);
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/srq.c
* Unmerged path include/linux/mlx5/driver.h
* Unmerged path include/linux/mlx5/srq.h
