crypto: ux500 - Forbid 2-key 3DES in FIPS mode

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-147.el8
commit-author Herbert Xu <herbert@gondor.apana.org.au>
commit 3c2bc636219fc0c2ea82c8f0d3fb0c9936cf5146
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-147.el8/3c2bc636.failed

This patch forbids the use of 2-key 3DES (K1 == K3) in FIPS mode.

It also removes the registration of the non-standard des/des3
ablkcipher algorithms.

	Signed-off-by: Herbert Xu <herbert@gondor.apana.org.au>
(cherry picked from commit 3c2bc636219fc0c2ea82c8f0d3fb0c9936cf5146)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/crypto/ux500/cryp/cryp_core.c
diff --cc drivers/crypto/ux500/cryp/cryp_core.c
index cb31b59c9d53,7a93cba0877f..000000000000
--- a/drivers/crypto/ux500/cryp/cryp_core.c
+++ b/drivers/crypto/ux500/cryp/cryp_core.c
@@@ -1011,36 -1019,16 +1011,36 @@@ static int des3_ablkcipher_setkey(struc
  				  const u8 *key, unsigned int keylen)
  {
  	struct cryp_ctx *ctx = crypto_ablkcipher_ctx(cipher);
- 	u32 *flags = &cipher->base.crt_flags;
- 	const u32 *K = (const u32 *)key;
- 	u32 tmp[DES3_EDE_EXPKEY_WORDS];
- 	int i, ret;
+ 	u32 flags;
+ 	int err;
  
  	pr_debug(DEV_DBG_NAME " [%s]", __func__);
- 	if (keylen != DES3_EDE_KEY_SIZE) {
- 		*flags |= CRYPTO_TFM_RES_BAD_KEY_LEN;
- 		pr_debug(DEV_DBG_NAME " [%s]: CRYPTO_TFM_RES_BAD_KEY_LEN",
- 				__func__);
- 		return -EINVAL;
- 	}
  
++<<<<<<< HEAD
 +	/* Checking key interdependency for weak key detection. */
 +	if (unlikely(!((K[0] ^ K[2]) | (K[1] ^ K[3])) ||
 +				!((K[2] ^ K[4]) | (K[3] ^ K[5]))) &&
 +			(*flags & CRYPTO_TFM_REQ_WEAK_KEY)) {
 +		*flags |= CRYPTO_TFM_RES_WEAK_KEY;
 +		pr_debug(DEV_DBG_NAME " [%s]: CRYPTO_TFM_REQ_WEAK_KEY",
 +				__func__);
 +		return -EINVAL;
 +	}
 +	for (i = 0; i < 3; i++) {
 +		ret = des_ekey(tmp, key + i*DES_KEY_SIZE);
 +		if (unlikely(ret == 0) && (*flags & CRYPTO_TFM_REQ_WEAK_KEY)) {
 +			*flags |= CRYPTO_TFM_RES_WEAK_KEY;
 +			pr_debug(DEV_DBG_NAME " [%s]: "
 +					"CRYPTO_TFM_REQ_WEAK_KEY", __func__);
 +			return -EINVAL;
 +		}
++=======
+ 	flags = crypto_ablkcipher_get_flags(cipher);
+ 	err = __des3_verify_key(&flags, key);
+ 	if (unlikely(err)) {
+ 		crypto_ablkcipher_set_flags(cipher, flags);
+ 		return err;
++>>>>>>> 3c2bc636219f (crypto: ux500 - Forbid 2-key 3DES in FIPS mode)
  	}
  
  	memcpy(ctx->key, key, keylen);
* Unmerged path drivers/crypto/ux500/cryp/cryp_core.c
