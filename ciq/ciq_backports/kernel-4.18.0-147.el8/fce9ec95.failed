ASoC: sta32x: Add support for XTI clock

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-147.el8
Rebuild_CHGLOG: - [sound] ALSA: ASoC: sta32x: Add support for XTI clock (Jaroslav Kysela) [1683051]
Rebuild_FUZZ: 92.86%
commit-author Daniel Mack <daniel@zonque.org>
commit fce9ec954a8af7e04cbf5b9daa8bec9c1df5cfe6
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-147.el8/fce9ec95.failed

The STA32x chips feature an XTI clock input that needs to be stable before
the reset signal is released. Therefore, the chip driver needs to get a
handle to the clock. Instead of relying on other parts of the system to
enable the clock, let the codec driver grab a handle itself.

In order to keep existing boards working, clock support is made optional.

	Signed-off-by: Daniel Mack <daniel@zonque.org>
	Signed-off-by: Mark Brown <broonie@kernel.org>
(cherry picked from commit fce9ec954a8af7e04cbf5b9daa8bec9c1df5cfe6)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	sound/soc/codecs/sta32x.c
diff --cc sound/soc/codecs/sta32x.c
index a878c8d92e68,f753d2db0a5a..000000000000
--- a/sound/soc/codecs/sta32x.c
+++ b/sound/soc/codecs/sta32x.c
@@@ -882,6 -884,15 +884,18 @@@ static int sta32x_probe(struct snd_soc_
  
  	sta32x->component = component;
  
++<<<<<<< HEAD
++=======
+ 	if (sta32x->xti_clk) {
+ 		ret = clk_prepare_enable(sta32x->xti_clk);
+ 		if (ret != 0) {
+ 			dev_err(component->dev,
+ 				"Failed to enable clock: %d\n", ret);
+ 			return ret;
+ 		}
+ 	}
+ 
++>>>>>>> fce9ec954a8a (ASoC: sta32x: Add support for XTI clock)
  	ret = regulator_bulk_enable(ARRAY_SIZE(sta32x->supplies),
  				    sta32x->supplies);
  	if (ret != 0) {
diff --git a/Documentation/devicetree/bindings/sound/st,sta32x.txt b/Documentation/devicetree/bindings/sound/st,sta32x.txt
index ff4a685a4303..52265fb757c5 100644
--- a/Documentation/devicetree/bindings/sound/st,sta32x.txt
+++ b/Documentation/devicetree/bindings/sound/st,sta32x.txt
@@ -19,6 +19,10 @@ Required properties:
 
 Optional properties:
 
+  - clocks, clock-names: Clock specifier for XTI input clock.
+	If specified, the clock will be enabled when the codec is probed,
+	and disabled when it is removed. The 'clock-names' must be set to 'xti'.
+
   -  st,output-conf: number, Selects the output configuration:
 	0: 2-channel (full-bridge) power, 2-channel data-out
 	1: 2 (half-bridge). 1 (full-bridge) on-board power
@@ -79,6 +83,8 @@ Example:
 codec: sta32x@38 {
 	compatible = "st,sta32x";
 	reg = <0x1c>;
+	clocks = <&clock>;
+	clock-names = "xti";
 	reset-gpios = <&gpio1 19 0>;
 	power-down-gpios = <&gpio1 16 0>;
 	st,output-conf = /bits/ 8  <0x3>;	// set output to 2-channel
* Unmerged path sound/soc/codecs/sta32x.c
