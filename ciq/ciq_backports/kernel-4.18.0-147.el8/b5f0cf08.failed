nfp: flower: prevent offload if rhashtable insert fails

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-147.el8
commit-author John Hurley <john.hurley@netronome.com>
commit b5f0cf08340090d1503dbdbfd797e32264974100
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-147.el8/b5f0cf08.failed

For flow offload adds, if the rhash insert code fails, the flow will still
have been offloaded but the reference to it in the driver freed.

Re-order the offload setup calls to ensure that a flow will only be written
to FW if a kernel reference is held and stored in the rhashtable. Remove
this hashtable entry if the offload fails.

Fixes: c01d0efa5136 ("nfp: flower: use rhashtable for flow caching")
	Signed-off-by: John Hurley <john.hurley@netronome.com>
	Reviewed-by: Pieter Jansen van Vuuren <pieter.jansenvanvuuren@netronome.com>
	Reviewed-by: Jakub Kicinski <jakub.kicinski@netronome.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit b5f0cf08340090d1503dbdbfd797e32264974100)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/netronome/nfp/flower/offload.c
diff --cc drivers/net/ethernet/netronome/nfp/flower/offload.c
index 78aee98a96a1,2f49eb75f3cc..000000000000
--- a/drivers/net/ethernet/netronome/nfp/flower/offload.c
+++ b/drivers/net/ethernet/netronome/nfp/flower/offload.c
@@@ -458,19 -476,18 +458,31 @@@ nfp_flower_add_offload(struct nfp_app *
  	if (err)
  		goto err_destroy_flow;
  
++<<<<<<< HEAD
 +	err = nfp_flower_xmit_flow(app, flow_pay,
 +				   NFP_FLOWER_CMSG_TYPE_FLOW_ADD);
 +	if (err)
 +		goto err_release_metadata;
 +
++=======
++>>>>>>> b5f0cf083400 (nfp: flower: prevent offload if rhashtable insert fails)
  	flow_pay->tc_flower_cookie = flow->cookie;
  	err = rhashtable_insert_fast(&priv->flow_table, &flow_pay->fl_node,
  				     nfp_flower_table_params);
  	if (err)
  		goto err_release_metadata;
  
++<<<<<<< HEAD
 +	if (port)
 +		port->tc_offload_cnt++;
++=======
+ 	err = nfp_flower_xmit_flow(netdev, flow_pay,
+ 				   NFP_FLOWER_CMSG_TYPE_FLOW_ADD);
+ 	if (err)
+ 		goto err_remove_rhash;
+ 
+ 	port->tc_offload_cnt++;
++>>>>>>> b5f0cf083400 (nfp: flower: prevent offload if rhashtable insert fails)
  
  	/* Deallocate flow payload when flower rule has been destroyed. */
  	kfree(key_layer);
* Unmerged path drivers/net/ethernet/netronome/nfp/flower/offload.c
