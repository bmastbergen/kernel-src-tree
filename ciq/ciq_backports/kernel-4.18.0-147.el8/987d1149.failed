KVM: fix unregistering coalesced mmio zone from wrong bus

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-147.el8
commit-author Eric Biggers <ebiggers@google.com>
commit 987d1149be7ddcc1380ff946cf236874421a7e1b
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-147.el8/987d1149.failed

If you register a kvm_coalesced_mmio_zone with '.pio = 0' but then
unregister it with '.pio = 1', KVM_UNREGISTER_COALESCED_MMIO will try to
unregister it from KVM_PIO_BUS rather than KVM_MMIO_BUS, which is a
no-op.  But it frees the kvm_coalesced_mmio_dev anyway, causing a
use-after-free.

Fix it by only unregistering and freeing the zone if the correct value
of 'pio' is provided.

	Reported-by: syzbot+f87f60bb6f13f39b54e3@syzkaller.appspotmail.com
Fixes: 0804c849f1df ("kvm/x86 : add coalesced pio support")
	Signed-off-by: Eric Biggers <ebiggers@google.com>
	Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
(cherry picked from commit 987d1149be7ddcc1380ff946cf236874421a7e1b)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	virt/kvm/coalesced_mmio.c
diff --cc virt/kvm/coalesced_mmio.c
index 9e65feb6fa58,6855cce3e528..000000000000
--- a/virt/kvm/coalesced_mmio.c
+++ b/virt/kvm/coalesced_mmio.c
@@@ -173,8 -181,10 +176,15 @@@ int kvm_vm_ioctl_unregister_coalesced_m
  	mutex_lock(&kvm->slots_lock);
  
  	list_for_each_entry_safe(dev, tmp, &kvm->coalesced_zones, list)
++<<<<<<< HEAD
 +		if (coalesced_mmio_in_range(dev, zone->addr, zone->size)) {
 +			kvm_io_bus_unregister_dev(kvm, KVM_MMIO_BUS, &dev->dev);
++=======
+ 		if (zone->pio == dev->zone.pio &&
+ 		    coalesced_mmio_in_range(dev, zone->addr, zone->size)) {
+ 			kvm_io_bus_unregister_dev(kvm,
+ 				zone->pio ? KVM_PIO_BUS : KVM_MMIO_BUS, &dev->dev);
++>>>>>>> 987d1149be7d (KVM: fix unregistering coalesced mmio zone from wrong bus)
  			kvm_iodevice_destructor(&dev->dev);
  		}
  
* Unmerged path virt/kvm/coalesced_mmio.c
