ipv6: Consider sk_bound_dev_if when binding a socket to a v4 mapped address

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-147.el8
commit-author David Ahern <dsahern@gmail.com>
commit ec90ad334986fa5856d11dd272f7f22fa86c55c4
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-147.el8/ec90ad33.failed

Similar to c5ee066333eb ("ipv6: Consider sk_bound_dev_if when binding a
socket to an address"), binding a socket to v4 mapped addresses needs to
consider if the socket is bound to a device.

This problem also exists from the beginning of git history.

	Signed-off-by: David Ahern <dsahern@gmail.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit ec90ad334986fa5856d11dd272f7f22fa86c55c4)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/ipv6/af_inet6.c
diff --cc net/ipv6/af_inet6.c
index 86a951f826be,93288b9f1697..000000000000
--- a/net/ipv6/af_inet6.c
+++ b/net/ipv6/af_inet6.c
@@@ -319,11 -321,18 +320,24 @@@ static int __inet6_bind(struct sock *sk
  			goto out;
  		}
  
+ 		if (sk->sk_bound_dev_if) {
+ 			dev = dev_get_by_index_rcu(net, sk->sk_bound_dev_if);
+ 			if (!dev) {
+ 				err = -ENODEV;
+ 				goto out;
+ 			}
+ 		}
+ 
  		/* Reproduce AF_INET checks to make the bindings consistent */
  		v4addr = addr->sin6_addr.s6_addr32[3];
++<<<<<<< HEAD
 +		chk_addr_ret = inet_addr_type(net, v4addr);
 +		if (!net->ipv4.sysctl_ip_nonlocal_bind &&
 +		    !(inet->freebind || inet->transparent) &&
++=======
+ 		chk_addr_ret = inet_addr_type_dev_table(net, dev, v4addr);
+ 		if (!inet_can_nonlocal_bind(net, inet) &&
++>>>>>>> ec90ad334986 (ipv6: Consider sk_bound_dev_if when binding a socket to a v4 mapped address)
  		    v4addr != htonl(INADDR_ANY) &&
  		    chk_addr_ret != RTN_LOCAL &&
  		    chk_addr_ret != RTN_MULTICAST &&
* Unmerged path net/ipv6/af_inet6.c
