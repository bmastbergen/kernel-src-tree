rtnetlink: Move input checking for rtnl_fdb_dump to helper

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-147.el8
commit-author David Ahern <dsahern@gmail.com>
commit 8dfbda19a21b30475b7e6dcf2141a98ed2a19af5
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-147.el8/8dfbda19.failed

Move the existing input checking for rtnl_fdb_dump into a helper,
valid_fdb_dump_legacy. This function will retain the current
logic that works around the 2 headers that userspace has been
allowed to send up to this point.

	Signed-off-by: David Ahern <dsahern@gmail.com>
	Acked-by: Christian Brauner <christian@brauner.io>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 8dfbda19a21b30475b7e6dcf2141a98ed2a19af5)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/core/rtnetlink.c
diff --cc net/core/rtnetlink.c
index 931f7d02b264,c7509c789fb6..000000000000
--- a/net/core/rtnetlink.c
+++ b/net/core/rtnetlink.c
@@@ -3783,27 -3846,10 +3813,34 @@@ static int rtnl_fdb_dump(struct sk_buf
  	int err = 0;
  	int fidx = 0;
  
++<<<<<<< HEAD
 +	/* A hack to preserve kernel<->userspace interface.
 +	 * Before Linux v4.12 this code accepted ndmsg since iproute2 v3.3.0.
 +	 * However, ndmsg is shorter than ifinfomsg thus nlmsg_parse() bails.
 +	 * So, check for ndmsg with an optional u32 attribute (not used here).
 +	 * Fortunately these sizes don't conflict with the size of ifinfomsg
 +	 * with an optional attribute.
 +	 */
 +	if (nlmsg_len(cb->nlh) != sizeof(struct ndmsg) &&
 +	    (nlmsg_len(cb->nlh) != sizeof(struct ndmsg) +
 +	     nla_attr_size(sizeof(u32)))) {
 +		err = nlmsg_parse(cb->nlh, sizeof(struct ifinfomsg), tb,
 +				  IFLA_MAX, ifla_policy, NULL);
 +		if (err < 0) {
 +			return -EINVAL;
 +		} else if (err == 0) {
 +			if (tb[IFLA_MASTER])
 +				br_idx = nla_get_u32(tb[IFLA_MASTER]);
 +		}
 +
 +		brport_idx = ifm->ifi_index;
 +	}
++=======
+ 	err = valid_fdb_dump_legacy(cb->nlh, &br_idx, &brport_idx,
+ 				    cb->extack);
+ 	if (err < 0)
+ 		return err;
++>>>>>>> 8dfbda19a21b (rtnetlink: Move input checking for rtnl_fdb_dump to helper)
  
  	if (br_idx) {
  		br_dev = __dev_get_by_index(net, br_idx);
* Unmerged path net/core/rtnetlink.c
