libbpf: introduce bpf_map_lookup_elem_flags()

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-147.el8
commit-author Alexei Starovoitov <ast@kernel.org>
commit df5d22facd78e475da2e0d506f239e32cdffaf99
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-147.el8/df5d22fa.failed

Introduce
int bpf_map_lookup_elem_flags(int fd, const void *key, void *value, __u64 flags)
helper to lookup array/hash/cgroup_local_storage elements with BPF_F_LOCK flag.

	Signed-off-by: Alexei Starovoitov <ast@kernel.org>
	Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
(cherry picked from commit df5d22facd78e475da2e0d506f239e32cdffaf99)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/lib/bpf/bpf.c
#	tools/lib/bpf/bpf.h
#	tools/lib/bpf/libbpf.map
diff --cc tools/lib/bpf/bpf.c
index 2accecf0ac8f,3defad77dc7a..000000000000
--- a/tools/lib/bpf/bpf.c
+++ b/tools/lib/bpf/bpf.c
@@@ -290,6 -368,31 +290,34 @@@ int bpf_map_lookup_elem(int fd, const v
  	return sys_bpf(BPF_MAP_LOOKUP_ELEM, &attr, sizeof(attr));
  }
  
++<<<<<<< HEAD
++=======
+ int bpf_map_lookup_elem_flags(int fd, const void *key, void *value, __u64 flags)
+ {
+ 	union bpf_attr attr;
+ 
+ 	bzero(&attr, sizeof(attr));
+ 	attr.map_fd = fd;
+ 	attr.key = ptr_to_u64(key);
+ 	attr.value = ptr_to_u64(value);
+ 	attr.flags = flags;
+ 
+ 	return sys_bpf(BPF_MAP_LOOKUP_ELEM, &attr, sizeof(attr));
+ }
+ 
+ int bpf_map_lookup_and_delete_elem(int fd, const void *key, void *value)
+ {
+ 	union bpf_attr attr;
+ 
+ 	bzero(&attr, sizeof(attr));
+ 	attr.map_fd = fd;
+ 	attr.key = ptr_to_u64(key);
+ 	attr.value = ptr_to_u64(value);
+ 
+ 	return sys_bpf(BPF_MAP_LOOKUP_AND_DELETE_ELEM, &attr, sizeof(attr));
+ }
+ 
++>>>>>>> df5d22facd78 (libbpf: introduce bpf_map_lookup_elem_flags())
  int bpf_map_delete_elem(int fd, const void *key)
  {
  	union bpf_attr attr;
diff --cc tools/lib/bpf/bpf.h
index c0ddff373cbd,ed09eed2dc3b..000000000000
--- a/tools/lib/bpf/bpf.h
+++ b/tools/lib/bpf/bpf.h
@@@ -78,44 -92,77 +78,101 @@@ struct bpf_load_program_attr 
  
  /* Recommend log buffer size */
  #define BPF_LOG_BUF_SIZE (256 * 1024)
 -LIBBPF_API int
 -bpf_load_program_xattr(const struct bpf_load_program_attr *load_attr,
 -		       char *log_buf, size_t log_buf_sz);
 -LIBBPF_API int bpf_load_program(enum bpf_prog_type type,
 -				const struct bpf_insn *insns, size_t insns_cnt,
 -				const char *license, __u32 kern_version,
 -				char *log_buf, size_t log_buf_sz);
 -LIBBPF_API int bpf_verify_program(enum bpf_prog_type type,
 -				  const struct bpf_insn *insns,
 -				  size_t insns_cnt, __u32 prog_flags,
 -				  const char *license, __u32 kern_version,
 -				  char *log_buf, size_t log_buf_sz,
 -				  int log_level);
 -
 -LIBBPF_API int bpf_map_update_elem(int fd, const void *key, const void *value,
 -				   __u64 flags);
 -
 +int bpf_load_program_xattr(const struct bpf_load_program_attr *load_attr,
 +			   char *log_buf, size_t log_buf_sz);
 +int bpf_load_program(enum bpf_prog_type type, const struct bpf_insn *insns,
 +		     size_t insns_cnt, const char *license,
 +		     __u32 kern_version, char *log_buf,
 +		     size_t log_buf_sz);
 +int bpf_verify_program(enum bpf_prog_type type, const struct bpf_insn *insns,
 +		       size_t insns_cnt, int strict_alignment,
 +		       const char *license, __u32 kern_version,
 +		       char *log_buf, size_t log_buf_sz, int log_level);
 +
 +int bpf_map_update_elem(int fd, const void *key, const void *value,
 +			__u64 flags);
 +
++<<<<<<< HEAD
 +int bpf_map_lookup_elem(int fd, const void *key, void *value);
 +int bpf_map_delete_elem(int fd, const void *key);
 +int bpf_map_get_next_key(int fd, const void *key, void *next_key);
 +int bpf_obj_pin(int fd, const char *pathname);
 +int bpf_obj_get(const char *pathname);
 +int bpf_prog_attach(int prog_fd, int attachable_fd, enum bpf_attach_type type,
 +		    unsigned int flags);
 +int bpf_prog_detach(int attachable_fd, enum bpf_attach_type type);
 +int bpf_prog_detach2(int prog_fd, int attachable_fd, enum bpf_attach_type type);
 +int bpf_prog_test_run(int prog_fd, int repeat, void *data, __u32 size,
 +		      void *data_out, __u32 *size_out, __u32 *retval,
 +		      __u32 *duration);
 +int bpf_prog_get_next_id(__u32 start_id, __u32 *next_id);
 +int bpf_map_get_next_id(__u32 start_id, __u32 *next_id);
 +int bpf_prog_get_fd_by_id(__u32 id);
 +int bpf_map_get_fd_by_id(__u32 id);
 +int bpf_btf_get_fd_by_id(__u32 id);
 +int bpf_obj_get_info_by_fd(int prog_fd, void *info, __u32 *info_len);
 +int bpf_prog_query(int target_fd, enum bpf_attach_type type, __u32 query_flags,
 +		   __u32 *attach_flags, __u32 *prog_ids, __u32 *prog_cnt);
 +int bpf_raw_tracepoint_open(const char *name, int prog_fd);
 +int bpf_load_btf(void *btf, __u32 btf_size, char *log_buf, __u32 log_buf_size,
 +		 bool do_log);
 +int bpf_task_fd_query(int pid, int fd, __u32 flags, char *buf, __u32 *buf_len,
 +		      __u32 *prog_id, __u32 *fd_type, __u64 *probe_offset,
 +		      __u64 *probe_addr);
++=======
+ LIBBPF_API int bpf_map_lookup_elem(int fd, const void *key, void *value);
+ LIBBPF_API int bpf_map_lookup_elem_flags(int fd, const void *key, void *value,
+ 					 __u64 flags);
+ LIBBPF_API int bpf_map_lookup_and_delete_elem(int fd, const void *key,
+ 					      void *value);
+ LIBBPF_API int bpf_map_delete_elem(int fd, const void *key);
+ LIBBPF_API int bpf_map_get_next_key(int fd, const void *key, void *next_key);
+ LIBBPF_API int bpf_obj_pin(int fd, const char *pathname);
+ LIBBPF_API int bpf_obj_get(const char *pathname);
+ LIBBPF_API int bpf_prog_attach(int prog_fd, int attachable_fd,
+ 			       enum bpf_attach_type type, unsigned int flags);
+ LIBBPF_API int bpf_prog_detach(int attachable_fd, enum bpf_attach_type type);
+ LIBBPF_API int bpf_prog_detach2(int prog_fd, int attachable_fd,
+ 				enum bpf_attach_type type);
+ 
+ struct bpf_prog_test_run_attr {
+ 	int prog_fd;
+ 	int repeat;
+ 	const void *data_in;
+ 	__u32 data_size_in;
+ 	void *data_out;      /* optional */
+ 	__u32 data_size_out; /* in: max length of data_out
+ 			      * out: length of data_out */
+ 	__u32 retval;        /* out: return code of the BPF program */
+ 	__u32 duration;      /* out: average per repetition in ns */
+ };
+ 
+ LIBBPF_API int bpf_prog_test_run_xattr(struct bpf_prog_test_run_attr *test_attr);
+ 
+ /*
+  * bpf_prog_test_run does not check that data_out is large enough. Consider
+  * using bpf_prog_test_run_xattr instead.
+  */
+ LIBBPF_API int bpf_prog_test_run(int prog_fd, int repeat, void *data,
+ 				 __u32 size, void *data_out, __u32 *size_out,
+ 				 __u32 *retval, __u32 *duration);
+ LIBBPF_API int bpf_prog_get_next_id(__u32 start_id, __u32 *next_id);
+ LIBBPF_API int bpf_map_get_next_id(__u32 start_id, __u32 *next_id);
+ LIBBPF_API int bpf_prog_get_fd_by_id(__u32 id);
+ LIBBPF_API int bpf_map_get_fd_by_id(__u32 id);
+ LIBBPF_API int bpf_btf_get_fd_by_id(__u32 id);
+ LIBBPF_API int bpf_obj_get_info_by_fd(int prog_fd, void *info, __u32 *info_len);
+ LIBBPF_API int bpf_prog_query(int target_fd, enum bpf_attach_type type,
+ 			      __u32 query_flags, __u32 *attach_flags,
+ 			      __u32 *prog_ids, __u32 *prog_cnt);
+ LIBBPF_API int bpf_raw_tracepoint_open(const char *name, int prog_fd);
+ LIBBPF_API int bpf_load_btf(void *btf, __u32 btf_size, char *log_buf,
+ 			    __u32 log_buf_size, bool do_log);
+ LIBBPF_API int bpf_task_fd_query(int pid, int fd, __u32 flags, char *buf,
+ 				 __u32 *buf_len, __u32 *prog_id, __u32 *fd_type,
+ 				 __u64 *probe_offset, __u64 *probe_addr);
+ 
+ #ifdef __cplusplus
+ } /* extern "C" */
++>>>>>>> df5d22facd78 (libbpf: introduce bpf_map_lookup_elem_flags())
  #endif
 -
 -#endif /* __LIBBPF_BPF_H */
diff --cc tools/lib/bpf/libbpf.map
index 4fb29f6d7a80,f6f96fc38c50..000000000000
--- a/tools/lib/bpf/libbpf.map
+++ b/tools/lib/bpf/libbpf.map
@@@ -119,3 -124,11 +119,14 @@@ LIBBPF_0.0.1 
  	local:
  		*;
  };
++<<<<<<< HEAD
++=======
+ 
+ LIBBPF_0.0.2 {
+ 	global:
+ 		bpf_probe_helper;
+ 		bpf_probe_map_type;
+ 		bpf_probe_prog_type;
+ 		bpf_map_lookup_elem_flags;
+ } LIBBPF_0.0.1;
++>>>>>>> df5d22facd78 (libbpf: introduce bpf_map_lookup_elem_flags())
* Unmerged path tools/lib/bpf/bpf.c
* Unmerged path tools/lib/bpf/bpf.h
* Unmerged path tools/lib/bpf/libbpf.map
