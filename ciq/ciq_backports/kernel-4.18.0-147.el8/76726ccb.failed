devlink: add flash update command

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-147.el8
commit-author Jakub Kicinski <jakub.kicinski@netronome.com>
commit 76726ccb7f461c83040e7082cf95fe1dea2afd1f
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-147.el8/76726ccb.failed

Add devlink flash update command. Advanced NICs have firmware
stored in flash and often cryptographically secured. Updating
that flash is handled by management firmware. Ethtool has a
flash update command which served us well, however, it has two
shortcomings:
 - it takes rtnl_lock unnecessarily - really flash update has
   nothing to do with networking, so using a networking device
   as a handle is suboptimal, which leads us to the second one:
 - it requires a functioning netdev - in case device enters an
   error state and can't spawn a netdev (e.g. communication
   with the device fails) there is no netdev to use as a handle
   for flashing.

Devlink already has the ability to report the firmware versions,
now with the ability to update the firmware/flash we will be
able to recover devices in bad state.

To enable updates of sub-components of the FW allow passing
component name.  This name should correspond to one of the
versions reported in devlink info.

v1: - replace target id with component name (Jiri).

	Signed-off-by: Jakub Kicinski <jakub.kicinski@netronome.com>
	Acked-by: Jiri Pirko <jiri@mellanox.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 76726ccb7f461c83040e7082cf95fe1dea2afd1f)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	include/uapi/linux/devlink.h
#	net/core/devlink.c
diff --cc include/uapi/linux/devlink.h
index 076692209a9b,53de8802a000..000000000000
--- a/include/uapi/linux/devlink.h
+++ b/include/uapi/linux/devlink.h
@@@ -96,6 -96,15 +96,18 @@@ enum devlink_command 
  
  	DEVLINK_CMD_INFO_GET,		/* can dump */
  
++<<<<<<< HEAD
++=======
+ 	DEVLINK_CMD_HEALTH_REPORTER_GET,
+ 	DEVLINK_CMD_HEALTH_REPORTER_SET,
+ 	DEVLINK_CMD_HEALTH_REPORTER_RECOVER,
+ 	DEVLINK_CMD_HEALTH_REPORTER_DIAGNOSE,
+ 	DEVLINK_CMD_HEALTH_REPORTER_DUMP_GET,
+ 	DEVLINK_CMD_HEALTH_REPORTER_DUMP_CLEAR,
+ 
+ 	DEVLINK_CMD_FLASH_UPDATE,
+ 
++>>>>>>> 76726ccb7f46 (devlink: add flash update command)
  	/* add new commands above here */
  	__DEVLINK_CMD_MAX,
  	DEVLINK_CMD_MAX = __DEVLINK_CMD_MAX - 1
@@@ -310,6 -319,19 +322,22 @@@ enum devlink_attr 
  	DEVLINK_ATTR_FMSG_OBJ_NAME,		/* string */
  	DEVLINK_ATTR_FMSG_OBJ_VALUE_TYPE,	/* u8 */
  	DEVLINK_ATTR_FMSG_OBJ_VALUE_DATA,	/* dynamic */
++<<<<<<< HEAD
++=======
+ 
+ 	DEVLINK_ATTR_HEALTH_REPORTER,			/* nested */
+ 	DEVLINK_ATTR_HEALTH_REPORTER_NAME,		/* string */
+ 	DEVLINK_ATTR_HEALTH_REPORTER_STATE,		/* u8 */
+ 	DEVLINK_ATTR_HEALTH_REPORTER_ERR,		/* u64 */
+ 	DEVLINK_ATTR_HEALTH_REPORTER_RECOVER,		/* u64 */
+ 	DEVLINK_ATTR_HEALTH_REPORTER_DUMP_TS,		/* u64 */
+ 	DEVLINK_ATTR_HEALTH_REPORTER_GRACEFUL_PERIOD,	/* u64 */
+ 	DEVLINK_ATTR_HEALTH_REPORTER_AUTO_RECOVER,	/* u8 */
+ 
+ 	DEVLINK_ATTR_FLASH_UPDATE_FILE_NAME,	/* string */
+ 	DEVLINK_ATTR_FLASH_UPDATE_COMPONENT,	/* string */
+ 
++>>>>>>> 76726ccb7f46 (devlink: add flash update command)
  	/* add new attributes above here, update the policy in devlink.c */
  
  	__DEVLINK_ATTR_MAX,
diff --cc net/core/devlink.c
index 7f269b4436cb,4a1ad0b13e52..000000000000
--- a/net/core/devlink.c
+++ b/net/core/devlink.c
@@@ -4405,6 -4901,11 +4426,14 @@@ static const struct nla_policy devlink_
  	[DEVLINK_ATTR_PARAM_VALUE_CMODE] = { .type = NLA_U8 },
  	[DEVLINK_ATTR_REGION_NAME] = { .type = NLA_NUL_STRING },
  	[DEVLINK_ATTR_REGION_SNAPSHOT_ID] = { .type = NLA_U32 },
++<<<<<<< HEAD
++=======
+ 	[DEVLINK_ATTR_HEALTH_REPORTER_NAME] = { .type = NLA_NUL_STRING },
+ 	[DEVLINK_ATTR_HEALTH_REPORTER_GRACEFUL_PERIOD] = { .type = NLA_U64 },
+ 	[DEVLINK_ATTR_HEALTH_REPORTER_AUTO_RECOVER] = { .type = NLA_U8 },
+ 	[DEVLINK_ATTR_FLASH_UPDATE_FILE_NAME] = { .type = NLA_NUL_STRING },
+ 	[DEVLINK_ATTR_FLASH_UPDATE_COMPONENT] = { .type = NLA_NUL_STRING },
++>>>>>>> 76726ccb7f46 (devlink: add flash update command)
  };
  
  static const struct genl_ops devlink_nl_ops[] = {
@@@ -4648,6 -5149,58 +4677,61 @@@
  		.internal_flags = DEVLINK_NL_FLAG_NEED_DEVLINK,
  		/* can be retrieved by unprivileged users */
  	},
++<<<<<<< HEAD
++=======
+ 	{
+ 		.cmd = DEVLINK_CMD_HEALTH_REPORTER_GET,
+ 		.doit = devlink_nl_cmd_health_reporter_get_doit,
+ 		.dumpit = devlink_nl_cmd_health_reporter_get_dumpit,
+ 		.policy = devlink_nl_policy,
+ 		.internal_flags = DEVLINK_NL_FLAG_NEED_DEVLINK,
+ 		/* can be retrieved by unprivileged users */
+ 	},
+ 	{
+ 		.cmd = DEVLINK_CMD_HEALTH_REPORTER_SET,
+ 		.doit = devlink_nl_cmd_health_reporter_set_doit,
+ 		.policy = devlink_nl_policy,
+ 		.flags = GENL_ADMIN_PERM,
+ 		.internal_flags = DEVLINK_NL_FLAG_NEED_DEVLINK,
+ 	},
+ 	{
+ 		.cmd = DEVLINK_CMD_HEALTH_REPORTER_RECOVER,
+ 		.doit = devlink_nl_cmd_health_reporter_recover_doit,
+ 		.policy = devlink_nl_policy,
+ 		.flags = GENL_ADMIN_PERM,
+ 		.internal_flags = DEVLINK_NL_FLAG_NEED_DEVLINK,
+ 	},
+ 	{
+ 		.cmd = DEVLINK_CMD_HEALTH_REPORTER_DIAGNOSE,
+ 		.doit = devlink_nl_cmd_health_reporter_diagnose_doit,
+ 		.policy = devlink_nl_policy,
+ 		.flags = GENL_ADMIN_PERM,
+ 		.internal_flags = DEVLINK_NL_FLAG_NEED_DEVLINK,
+ 	},
+ 	{
+ 		.cmd = DEVLINK_CMD_HEALTH_REPORTER_DUMP_GET,
+ 		.doit = devlink_nl_cmd_health_reporter_dump_get_doit,
+ 		.policy = devlink_nl_policy,
+ 		.flags = GENL_ADMIN_PERM,
+ 		.internal_flags = DEVLINK_NL_FLAG_NEED_DEVLINK |
+ 				  DEVLINK_NL_FLAG_NO_LOCK,
+ 	},
+ 	{
+ 		.cmd = DEVLINK_CMD_HEALTH_REPORTER_DUMP_CLEAR,
+ 		.doit = devlink_nl_cmd_health_reporter_dump_clear_doit,
+ 		.policy = devlink_nl_policy,
+ 		.flags = GENL_ADMIN_PERM,
+ 		.internal_flags = DEVLINK_NL_FLAG_NEED_DEVLINK |
+ 				  DEVLINK_NL_FLAG_NO_LOCK,
+ 	},
+ 	{
+ 		.cmd = DEVLINK_CMD_FLASH_UPDATE,
+ 		.doit = devlink_nl_cmd_flash_update,
+ 		.policy = devlink_nl_policy,
+ 		.flags = GENL_ADMIN_PERM,
+ 		.internal_flags = DEVLINK_NL_FLAG_NEED_DEVLINK,
+ 	},
++>>>>>>> 76726ccb7f46 (devlink: add flash update command)
  };
  
  static struct genl_family devlink_nl_family __ro_after_init = {
diff --git a/include/net/devlink.h b/include/net/devlink.h
index 4d183c766687..55e09ccd246a 100644
--- a/include/net/devlink.h
+++ b/include/net/devlink.h
@@ -482,6 +482,9 @@ struct devlink_ops {
 				      struct netlink_ext_ack *extack);
 	int (*info_get)(struct devlink *devlink, struct devlink_info_req *req,
 			struct netlink_ext_ack *extack);
+	int (*flash_update)(struct devlink *devlink, const char *file_name,
+			    const char *component,
+			    struct netlink_ext_ack *extack);
 };
 
 static inline void *devlink_priv(struct devlink *devlink)
* Unmerged path include/uapi/linux/devlink.h
* Unmerged path net/core/devlink.c
