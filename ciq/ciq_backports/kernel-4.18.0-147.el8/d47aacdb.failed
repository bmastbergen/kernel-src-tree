KVM: PPC: Book3S HV: XIVE: Clear file mapping when device is released

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-147.el8
commit-author Cédric Le Goater <clg@kaod.org>
commit d47aacdb8e0bc03dcaa1a5630a3c633cdcd4cfa7
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-147.el8/d47aacdb.failed

Improve the release of the XIVE KVM device by clearing the file
address_space, which is used to unmap the interrupt ESB pages when a
device is passed-through.

	Suggested-by: Paul Mackerras <paulus@ozlabs.org>
	Signed-off-by: Cédric Le Goater <clg@kaod.org>
	Signed-off-by: Paul Mackerras <paulus@ozlabs.org>
(cherry picked from commit d47aacdb8e0bc03dcaa1a5630a3c633cdcd4cfa7)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/powerpc/kvm/book3s_xive_native.c
diff --cc arch/powerpc/kvm/book3s_xive_native.c
index 751259394150,9cedd04e7a44..000000000000
--- a/arch/powerpc/kvm/book3s_xive_native.c
+++ b/arch/powerpc/kvm/book3s_xive_native.c
@@@ -56,6 -971,28 +56,31 @@@ static void kvmppc_xive_native_free(str
  {
  	struct kvmppc_xive *xive = dev->private;
  	struct kvm *kvm = xive->kvm;
++<<<<<<< HEAD
++=======
+ 	struct kvm_vcpu *vcpu;
+ 	int i;
+ 
+ 	pr_devel("Releasing xive native device\n");
+ 
+ 	/*
+ 	 * Clear the KVM device file address_space which is used to
+ 	 * unmap the ESB pages when a device is passed-through.
+ 	 */
+ 	mutex_lock(&xive->mapping_lock);
+ 	xive->mapping = NULL;
+ 	mutex_unlock(&xive->mapping_lock);
+ 
+ 	/*
+ 	 * Since this is the device release function, we know that
+ 	 * userspace does not have any open fd or mmap referring to
+ 	 * the device.  Therefore there can not be any of the
+ 	 * device attribute set/get, mmap, or page fault functions
+ 	 * being executed concurrently, and similarly, the
+ 	 * connect_vcpu and set/clr_mapped functions also cannot
+ 	 * be being executed.
+ 	 */
++>>>>>>> d47aacdb8e0b (KVM: PPC: Book3S HV: XIVE: Clear file mapping when device is released)
  
  	debugfs_remove(xive->dentry);
  
* Unmerged path arch/powerpc/kvm/book3s_xive_native.c
