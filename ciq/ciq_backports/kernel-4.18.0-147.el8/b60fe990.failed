KVM: coalesced_mmio: add bounds checking

jira LE-1907
cve CVE-2019-14821
Rebuild_History Non-Buildable kernel-4.18.0-147.el8
commit-author Matt Delco <delco@chromium.org>
commit b60fe990c6b07ef6d4df67bc0530c7c90a62623a
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-147.el8/b60fe990.failed

The first/last indexes are typically shared with a user app.
The app can change the 'last' index that the kernel uses
to store the next result.  This change sanity checks the index
before using it for writing to a potentially arbitrary address.

This fixes CVE-2019-14821.

	Cc: stable@vger.kernel.org
Fixes: 5f94c1741bdc ("KVM: Add coalesced MMIO support (common part)")
	Signed-off-by: Matt Delco <delco@chromium.org>
	Signed-off-by: Jim Mattson <jmattson@google.com>
	Reported-by: syzbot+983c866c3dd6efa3662a@syzkaller.appspotmail.com
[Use READ_ONCE. - Paolo]
	Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
(cherry picked from commit b60fe990c6b07ef6d4df67bc0530c7c90a62623a)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	virt/kvm/coalesced_mmio.c
diff --cc virt/kvm/coalesced_mmio.c
index 9e65feb6fa58,8ffd07e2a160..000000000000
--- a/virt/kvm/coalesced_mmio.c
+++ b/virt/kvm/coalesced_mmio.c
@@@ -80,11 -83,12 +83,18 @@@ static int coalesced_mmio_write(struct 
  
  	/* copy data in first free entry of the ring */
  
++<<<<<<< HEAD
 +	ring->coalesced_mmio[ring->last].phys_addr = addr;
 +	ring->coalesced_mmio[ring->last].len = len;
 +	memcpy(ring->coalesced_mmio[ring->last].data, val, len);
++=======
+ 	ring->coalesced_mmio[insert].phys_addr = addr;
+ 	ring->coalesced_mmio[insert].len = len;
+ 	memcpy(ring->coalesced_mmio[insert].data, val, len);
+ 	ring->coalesced_mmio[insert].pio = dev->zone.pio;
++>>>>>>> b60fe990c6b0 (KVM: coalesced_mmio: add bounds checking)
  	smp_wmb();
- 	ring->last = (ring->last + 1) % KVM_COALESCED_MMIO_MAX;
+ 	ring->last = (insert + 1) % KVM_COALESCED_MMIO_MAX;
  	spin_unlock(&dev->kvm->ring_lock);
  	return 0;
  }
* Unmerged path virt/kvm/coalesced_mmio.c
