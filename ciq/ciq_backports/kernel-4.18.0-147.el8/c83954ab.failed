net/mlx5e: Change return type of tc add flow functions

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-147.el8
commit-author Rabie Loulou <rabiel@mellanox.com>
commit c83954abb221718e961802136078ba04d563cf3a
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-147.el8/c83954ab.failed

Refactor the flow add utility functions to return err code instead of rule
pointers. This will allow for simpler logic when one tc rule is
duplicated to two HW rules in downstream patches.

	Signed-off-by: Rabie Loulou <rabiel@mellanox.com>
	Signed-off-by: Shahar Klein <shahark@mellanox.com>
	Reviewed-by: Roi Dayan <roid@mellanox.com>
	Reviewed-by: Or Gerlitz <ogerlitz@mellanox.com>
	Signed-off-by: Saeed Mahameed <saeedm@mellanox.com>
(cherry picked from commit c83954abb221718e961802136078ba04d563cf3a)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlx5/core/en_tc.c
diff --cc drivers/net/ethernet/mellanox/mlx5/core/en_tc.c
index 1b23c0bb18f5,861986f82844..000000000000
--- a/drivers/net/ethernet/mellanox/mlx5/core/en_tc.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/en_tc.c
@@@ -670,10 -673,11 +670,10 @@@ static void mlx5e_hairpin_flow_del(stru
  	}
  }
  
- static struct mlx5_flow_handle *
+ static int
  mlx5e_tc_add_nic_flow(struct mlx5e_priv *priv,
  		      struct mlx5e_tc_flow_parse_attr *parse_attr,
 -		      struct mlx5e_tc_flow *flow,
 -		      struct netlink_ext_ack *extack)
 +		      struct mlx5e_tc_flow *flow)
  {
  	struct mlx5_nic_flow_attr *attr = flow->nic_attr;
  	struct mlx5_core_dev *dev = priv->mdev;
@@@ -690,9 -693,8 +689,8 @@@
  	int err, dest_ix = 0;
  
  	if (flow->flags & MLX5E_TC_FLOW_HAIRPIN) {
 -		err = mlx5e_hairpin_flow_add(priv, flow, parse_attr, extack);
 +		err = mlx5e_hairpin_flow_add(priv, flow, parse_attr);
  		if (err) {
- 			rule = ERR_PTR(err);
  			goto err_add_hairpin_flow;
  		}
  		if (flow->flags & MLX5E_TC_FLOW_HAIRPIN_RSS) {
@@@ -750,9 -750,11 +746,9 @@@
  							    MLX5E_TC_TABLE_NUM_GROUPS,
  							    MLX5E_TC_FT_LEVEL, 0);
  		if (IS_ERR(priv->fs.tc.t)) {
 -			NL_SET_ERR_MSG_MOD(extack,
 -					   "Failed to create tc offload table\n");
  			netdev_err(priv->netdev,
  				   "Failed to create tc offload table\n");
- 			rule = ERR_CAST(priv->fs.tc.t);
+ 			err = PTR_ERR(priv->fs.tc.t);
  			goto err_create_ft;
  		}
  
@@@ -816,12 -820,14 +814,12 @@@ static int mlx5e_attach_encap(struct ml
  			      struct ip_tunnel_info *tun_info,
  			      struct net_device *mirred_dev,
  			      struct net_device **encap_dev,
 -			      struct mlx5e_tc_flow *flow,
 -			      struct netlink_ext_ack *extack);
 +			      struct mlx5e_tc_flow *flow);
  
- static struct mlx5_flow_handle *
+ static int
  mlx5e_tc_add_fdb_flow(struct mlx5e_priv *priv,
  		      struct mlx5e_tc_flow_parse_attr *parse_attr,
 -		      struct mlx5e_tc_flow *flow,
 -		      struct netlink_ext_ack *extack)
 +		      struct mlx5e_tc_flow *flow)
  {
  	struct mlx5_eswitch *esw = priv->mdev->priv.eswitch;
  	struct mlx5_esw_flow_attr *attr = flow->esw_attr;
@@@ -835,12 -840,12 +832,21 @@@
  	if (attr->action & MLX5_FLOW_CONTEXT_ACTION_PACKET_REFORMAT) {
  		out_dev = __dev_get_by_index(dev_net(priv->netdev),
  					     attr->parse_attr->mirred_ifindex);
++<<<<<<< HEAD
 +		err = mlx5e_attach_encap(priv, &parse_attr->tun_info,
 +					 out_dev, &encap_dev, flow);
 +		if (err) {
 +			rule = ERR_PTR(err);
 +			if (err != -EAGAIN)
 +				goto err_attach_encap;
++=======
+ 		encap_err = mlx5e_attach_encap(priv, &parse_attr->tun_info,
+ 					       out_dev, &encap_dev, flow,
+ 					       extack);
+ 		if (encap_err && encap_err != -EAGAIN) {
+ 			err = encap_err;
+ 			goto err_attach_encap;
++>>>>>>> c83954abb221 (net/mlx5e: Change return type of tc add flow functions)
  		}
  		out_priv = netdev_priv(encap_dev);
  		rpriv = out_priv->ppriv;
@@@ -2795,22 -2952,21 +2801,27 @@@ int mlx5e_configure_flower(struct mlx5e
  		goto err_free;
  
  	if (flow->flags & MLX5E_TC_FLOW_ESWITCH) {
 -		err = parse_tc_fdb_actions(priv, f->exts, parse_attr, flow,
 -					   extack);
 +		err = parse_tc_fdb_actions(priv, f->exts, parse_attr, flow);
  		if (err < 0)
  			goto err_free;
++<<<<<<< HEAD
 +		flow->rule[0] = mlx5e_tc_add_fdb_flow(priv, parse_attr, flow);
++=======
+ 		err = mlx5e_tc_add_fdb_flow(priv, parse_attr, flow, extack);
++>>>>>>> c83954abb221 (net/mlx5e: Change return type of tc add flow functions)
  	} else {
 -		err = parse_tc_nic_actions(priv, f->exts, parse_attr, flow,
 -					   extack);
 +		err = parse_tc_nic_actions(priv, f->exts, parse_attr, flow);
  		if (err < 0)
  			goto err_free;
++<<<<<<< HEAD
 +		flow->rule[0] = mlx5e_tc_add_nic_flow(priv, parse_attr, flow);
++=======
+ 		err = mlx5e_tc_add_nic_flow(priv, parse_attr, flow, extack);
++>>>>>>> c83954abb221 (net/mlx5e: Change return type of tc add flow functions)
  	}
  
- 	if (IS_ERR(flow->rule[0])) {
- 		err = PTR_ERR(flow->rule[0]);
- 		if (err != -EAGAIN)
- 			goto err_free;
- 	}
+ 	if (err && err != -EAGAIN)
+ 		goto err_free;
  
  	if (err != -EAGAIN)
  		flow->flags |= MLX5E_TC_FLOW_OFFLOADED;
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/en_tc.c
