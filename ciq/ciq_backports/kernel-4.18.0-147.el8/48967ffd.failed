net/mlx5: FW tracer, create trace buffer and copy strings database

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-147.el8
commit-author Feras Daoud <ferasda@mellanox.com>
commit 48967ffdeb210266423be11f395c5dc26d3e4eda
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-147.el8/48967ffd.failed

For each PF do the following:
1- Allocate memory for the tracer strings database and read the
strings from the FW to the SW. These strings will be used later for
parsing traces.
2- Allocate and dma map tracer buffers.

Traces that will be written into the buffer will be parsed as a group
of one or more traces, referred to as trace message. The trace message
represents a C-like printf string.
First trace of a message holds the pointer to the correct string in
strings database. The following traces holds the variables of the
message.

	Signed-off-by: Feras Daoud <ferasda@mellanox.com>
	Signed-off-by: Saeed Mahameed <saeedm@mellanox.com>
(cherry picked from commit 48967ffdeb210266423be11f395c5dc26d3e4eda)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlx5/core/diag/fw_tracer.c
#	drivers/net/ethernet/mellanox/mlx5/core/en/xdp.h
diff --cc drivers/net/ethernet/mellanox/mlx5/core/en/xdp.h
index a8a856a82c63,66cb7e7ada28..000000000000
--- a/drivers/net/ethernet/mellanox/mlx5/core/en/xdp.h
+++ b/drivers/net/ethernet/mellanox/mlx5/core/en/xdp.h
@@@ -29,34 -29,56 +29,73 @@@
   * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
   * SOFTWARE.
   */
 +#ifndef __MLX5_EN_XDP_H__
 +#define __MLX5_EN_XDP_H__
  
 -#ifndef __LIB_TRACER_H__
 -#define __LIB_TRACER_H__
 +#include "en.h"
  
 -#include <linux/mlx5/driver.h>
 -#include "mlx5_core.h"
 +#define MLX5E_XDP_MAX_MTU ((int)(PAGE_SIZE - \
 +				 MLX5_SKB_FRAG_SZ(XDP_PACKET_HEADROOM)))
 +#define MLX5E_XDP_MIN_INLINE (ETH_HLEN + VLAN_HLEN)
 +#define MLX5E_XDP_TX_DS_COUNT \
 +	((sizeof(struct mlx5e_tx_wqe) / MLX5_SEND_WQE_DS) + 1 /* SG DS */)
  
++<<<<<<< HEAD:drivers/net/ethernet/mellanox/mlx5/core/en/xdp.h
 +bool mlx5e_xdp_handle(struct mlx5e_rq *rq, struct mlx5e_dma_info *di,
 +		      void *va, u16 *rx_headroom, u32 *len);
 +bool mlx5e_poll_xdpsq_cq(struct mlx5e_cq *cq);
 +void mlx5e_free_xdpsq_descs(struct mlx5e_xdpsq *sq);
 +
 +bool mlx5e_xmit_xdp_frame(struct mlx5e_rq *rq, struct mlx5e_dma_info *di,
 +			  const struct xdp_buff *xdp);
 +
 +static inline void mlx5e_xmit_xdp_doorbell(struct mlx5e_xdpsq *sq)
 +{
 +	struct mlx5_wq_cyc *wq = &sq->wq;
 +	struct mlx5e_tx_wqe *wqe;
 +	u16 pi = mlx5_wq_cyc_ctr2ix(wq, sq->pc - 1); /* last pi */
++=======
+ #define STRINGS_DB_SECTIONS_NUM 8
+ #define STRINGS_DB_READ_SIZE_BYTES 256
+ #define STRINGS_DB_LEFTOVER_SIZE_BYTES 64
+ #define TRACER_BUFFER_PAGE_NUM 64
+ #define TRACER_BUFFER_CHUNK 4096
+ #define TRACE_BUFFER_SIZE_BYTE (TRACER_BUFFER_PAGE_NUM * TRACER_BUFFER_CHUNK)
+ 
+ struct mlx5_fw_tracer {
+ 	struct mlx5_core_dev *dev;
+ 	bool owner;
+ 	u8   trc_ver;
+ 	struct workqueue_struct *work_queue;
+ 	struct work_struct ownership_change_work;
+ 	struct work_struct read_fw_strings_work;
+ 
+ 	/* Strings DB */
+ 	struct {
+ 		u8 first_string_trace;
+ 		u8 num_string_trace;
+ 		u32 num_string_db;
+ 		u32 base_address_out[STRINGS_DB_SECTIONS_NUM];
+ 		u32 size_out[STRINGS_DB_SECTIONS_NUM];
+ 		void *buffer[STRINGS_DB_SECTIONS_NUM];
+ 		bool loaded;
+ 	} str_db;
+ 
+ 	/* Log Buffer */
+ 	struct {
+ 		u32 pdn;
+ 		void *log_buf;
+ 		dma_addr_t dma;
+ 		u32 size;
+ 		struct mlx5_core_mkey mkey;
+ 
+ 	} buff;
+ };
++>>>>>>> 48967ffdeb21 (net/mlx5: FW tracer, create trace buffer and copy strings database):drivers/net/ethernet/mellanox/mlx5/core/diag/fw_tracer.h
  
 -enum mlx5_fw_tracer_ownership_state {
 -	MLX5_FW_TRACER_RELEASE_OWNERSHIP,
 -	MLX5_FW_TRACER_ACQUIRE_OWNERSHIP,
 -};
 +	wqe  = mlx5_wq_cyc_get_wqe(wq, pi);
  
 -struct mlx5_fw_tracer *mlx5_fw_tracer_create(struct mlx5_core_dev *dev);
 -void mlx5_fw_tracer_destroy(struct mlx5_fw_tracer *tracer);
 +	mlx5e_notify_hw(wq, sq->pc, sq->uar_map, &wqe->ctrl);
 +}
  
  #endif
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/diag/fw_tracer.c
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/diag/fw_tracer.c
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/en/xdp.h
