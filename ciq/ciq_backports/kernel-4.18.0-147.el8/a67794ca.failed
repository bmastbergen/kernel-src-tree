Revert "KVM: Eliminate extra function calls in kvm_get_dirty_log_protect()"

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-147.el8
commit-author Lan Tianyu <Tianyu.Lan@microsoft.com>
commit a67794cafbc4594debf53dbe4e2a7708426f492e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-147.el8/a67794ca.failed

The value of "dirty_bitmap[i]" is already check before setting its value
to mask. The following check of "mask" is redundant. The check of "mask" was
introduced by commit 58d2930f4ee3 ("KVM: Eliminate extra function calls in
kvm_get_dirty_log_protect()"), revert it.

	Signed-off-by: Lan Tianyu <Tianyu.Lan@microsoft.com>
	Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
(cherry picked from commit a67794cafbc4594debf53dbe4e2a7708426f492e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	virt/kvm/kvm_main.c
diff --cc virt/kvm/kvm_main.c
index 6ff83aa3908f,276af92ace6c..000000000000
--- a/virt/kvm/kvm_main.c
+++ b/virt/kvm/kvm_main.c
@@@ -1179,25 -1178,33 +1179,28 @@@ int kvm_get_dirty_log_protect(struct kv
  		return -ENOENT;
  
  	n = kvm_dirty_bitmap_bytes(memslot);
 +
 +	dirty_bitmap_buffer = kvm_second_dirty_bitmap(memslot);
 +	memset(dirty_bitmap_buffer, 0, n);
 +
 +	spin_lock(&kvm->mmu_lock);
  	*flush = false;
 -	if (kvm->manual_dirty_log_protect) {
 -		/*
 -		 * Unlike kvm_get_dirty_log, we always return false in *flush,
 -		 * because no flush is needed until KVM_CLEAR_DIRTY_LOG.  There
 -		 * is some code duplication between this function and
 -		 * kvm_get_dirty_log, but hopefully all architecture
 -		 * transition to kvm_get_dirty_log_protect and kvm_get_dirty_log
 -		 * can be eliminated.
 -		 */
 -		dirty_bitmap_buffer = dirty_bitmap;
 -	} else {
 -		dirty_bitmap_buffer = kvm_second_dirty_bitmap(memslot);
 -		memset(dirty_bitmap_buffer, 0, n);
 +	for (i = 0; i < n / sizeof(long); i++) {
 +		unsigned long mask;
 +		gfn_t offset;
  
 -		spin_lock(&kvm->mmu_lock);
 -		for (i = 0; i < n / sizeof(long); i++) {
 -			unsigned long mask;
 -			gfn_t offset;
 +		if (!dirty_bitmap[i])
 +			continue;
  
 -			if (!dirty_bitmap[i])
 -				continue;
 +		*flush = true;
  
 -			*flush = true;
 -			mask = xchg(&dirty_bitmap[i], 0);
 -			dirty_bitmap_buffer[i] = mask;
 +		mask = xchg(&dirty_bitmap[i], 0);
 +		dirty_bitmap_buffer[i] = mask;
  
++<<<<<<< HEAD
 +		if (mask) {
++=======
++>>>>>>> a67794cafbc4 (Revert "KVM: Eliminate extra function calls in kvm_get_dirty_log_protect()")
  			offset = i * BITS_PER_LONG;
  			kvm_arch_mmu_enable_log_dirty_pt_masked(kvm, memslot,
  								offset, mask);
* Unmerged path virt/kvm/kvm_main.c
