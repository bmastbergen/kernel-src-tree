net/mlx5e: Force CHECKSUM_UNNECESSARY for short ethernet frames

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-147.el8
commit-author Cong Wang <xiyou.wangcong@gmail.com>
commit e8c8b53ccaff568fef4c13a6ccaf08bf241aa01a
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-147.el8/e8c8b53c.failed

When an ethernet frame is padded to meet the minimum ethernet frame
size, the padding octets are not covered by the hardware checksum.
Fortunately the padding octets are usually zero's, which don't affect
checksum. However, we have a switch which pads non-zero octets, this
causes kernel hardware checksum fault repeatedly.

Prior to:
commit '88078d98d1bb ("net: pskb_trim_rcsum() and CHECKSUM_COMPLETE ...")'
skb checksum was forced to be CHECKSUM_NONE when padding is detected.
After it, we need to keep skb->csum updated, like what we do for RXFCS.
However, fixing up CHECKSUM_COMPLETE requires to verify and parse IP
headers, it is not worthy the effort as the packets are so small that
CHECKSUM_COMPLETE can't save anything.

Fixes: 88078d98d1bb ("net: pskb_trim_rcsum() and CHECKSUM_COMPLETE are friends"),
	Cc: Eric Dumazet <edumazet@google.com>
	Cc: Tariq Toukan <tariqt@mellanox.com>
	Cc: Nikola Ciprich <nikola.ciprich@linuxbox.cz>
	Signed-off-by: Cong Wang <xiyou.wangcong@gmail.com>
	Signed-off-by: Saeed Mahameed <saeedm@mellanox.com>
(cherry picked from commit e8c8b53ccaff568fef4c13a6ccaf08bf241aa01a)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlx5/core/en_rx.c
diff --cc drivers/net/ethernet/mellanox/mlx5/core/en_rx.c
index 8f74227d20ff,f86e4804e83e..000000000000
--- a/drivers/net/ethernet/mellanox/mlx5/core/en_rx.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/en_rx.c
@@@ -751,6 -753,20 +753,23 @@@ static inline void mlx5e_handle_csum(st
  		return;
  	}
  
++<<<<<<< HEAD
++=======
+ 	if (unlikely(test_bit(MLX5E_RQ_STATE_NO_CSUM_COMPLETE, &rq->state)))
+ 		goto csum_unnecessary;
+ 
+ 	/* CQE csum doesn't cover padding octets in short ethernet
+ 	 * frames. And the pad field is appended prior to calculating
+ 	 * and appending the FCS field.
+ 	 *
+ 	 * Detecting these padded frames requires to verify and parse
+ 	 * IP headers, so we simply force all those small frames to be
+ 	 * CHECKSUM_UNNECESSARY even if they are not padded.
+ 	 */
+ 	if (short_frame(skb->len))
+ 		goto csum_unnecessary;
+ 
++>>>>>>> e8c8b53ccaff (net/mlx5e: Force CHECKSUM_UNNECESSARY for short ethernet frames)
  	if (likely(is_last_ethertype_ip(skb, &network_depth, &proto))) {
  		if (unlikely(get_ip_proto(skb, network_depth, proto) == IPPROTO_SCTP))
  			goto csum_unnecessary;
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/en_rx.c
