s390/purgatory: Reduce purgatory size

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-147.el8
commit-author Philipp Rudo <prudo@linux.ibm.com>
commit 61f3f8fc223524692aaa87cf46d95ca3015e83a9
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-147.el8/61f3f8fc.failed

The purgatory is compiled into the vmlinux and keept in memory all the time
during runtime. Thus any section not needed to load the purgatory
unnecessarily bloats up its foot print in file- and memorysize. Reduce the
purgatory size by stripping the unneeded sections from the purgatory.

This reduces the purgatories size by ~33%.

	Signed-off-by: Philipp Rudo <prudo@linux.ibm.com>
	Signed-off-by: Martin Schwidefsky <schwidefsky@de.ibm.com>
(cherry picked from commit 61f3f8fc223524692aaa87cf46d95ca3015e83a9)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/s390/purgatory/Makefile
diff --cc arch/s390/purgatory/Makefile
index 8d61218a71aa,175ff6c71735..000000000000
--- a/arch/s390/purgatory/Makefile
+++ b/arch/s390/purgatory/Makefile
@@@ -25,12 -23,19 +23,23 @@@ KBUILD_CFLAGS += -c -MD -Os -m64 -msoft
  KBUILD_CFLAGS += $(call cc-option,-fno-PIE)
  KBUILD_AFLAGS := $(filter-out -DCC_USING_EXPOLINE,$(KBUILD_AFLAGS))
  
- $(obj)/purgatory.ro: $(PURGATORY_OBJS) FORCE
+ LDFLAGS_purgatory := -r --no-undefined -nostdlib -z nodefaultlib -T
+ $(obj)/purgatory: $(obj)/purgatory.lds $(PURGATORY_OBJS) FORCE
  		$(call if_changed,ld)
  
++<<<<<<< HEAD
 +CMD_BIN2C = $(objtree)/scripts/basic/bin2c
++=======
+ OBJCOPYFLAGS_purgatory.ro := -O elf64-s390
+ OBJCOPYFLAGS_purgatory.ro += --remove-section='*debug*'
+ OBJCOPYFLAGS_purgatory.ro += --remove-section='.comment'
+ OBJCOPYFLAGS_purgatory.ro += --remove-section='.note.*'
+ $(obj)/purgatory.ro: $(obj)/purgatory FORCE
+ 		$(call if_changed,objcopy)
+ 
++>>>>>>> 61f3f8fc2235 (s390/purgatory: Reduce purgatory size)
  quiet_cmd_bin2c = BIN2C   $@
 -      cmd_bin2c = $(objtree)/scripts/bin2c kexec_purgatory < $< > $@
 +      cmd_bin2c = $(CMD_BIN2C) kexec_purgatory < $< > $@
  
  $(obj)/kexec-purgatory.c: $(obj)/purgatory.ro FORCE
  	$(call if_changed,bin2c)
* Unmerged path arch/s390/purgatory/Makefile
diff --git a/arch/s390/purgatory/purgatory.lds.S b/arch/s390/purgatory/purgatory.lds.S
new file mode 100644
index 000000000000..482eb4fbcef1
--- /dev/null
+++ b/arch/s390/purgatory/purgatory.lds.S
@@ -0,0 +1,54 @@
+/* SPDX-License-Identifier: GPL-2.0 */
+
+#include <asm-generic/vmlinux.lds.h>
+
+OUTPUT_FORMAT("elf64-s390", "elf64-s390", "elf64-s390")
+OUTPUT_ARCH(s390:64-bit)
+
+ENTRY(purgatory_start)
+
+SECTIONS
+{
+	. = 0;
+	.head.text : {
+		_head = . ;
+		HEAD_TEXT
+		_ehead = . ;
+	}
+	.text :	{
+		_text = .;	/* Text */
+		*(.text)
+		*(.text.*)
+		_etext = . ;
+	}
+	.rodata : {
+		_rodata = . ;
+		*(.rodata)	 /* read-only data */
+		*(.rodata.*)
+		_erodata = . ;
+	}
+	.data :	{
+		_data = . ;
+		*(.data)
+		*(.data.*)
+		_edata = . ;
+	}
+
+	. = ALIGN(256);
+	.bss : {
+		_bss = . ;
+		*(.bss)
+		*(.bss.*)
+		*(COMMON)
+		. = ALIGN(8);	/* For convenience during zeroing */
+		_ebss = .;
+	}
+	_end = .;
+
+	/* Sections to be discarded */
+	/DISCARD/ : {
+		*(.eh_frame)
+		*(*__ksymtab*)
+		*(___kcrctab*)
+	}
+}
