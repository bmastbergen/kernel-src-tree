arm64: Don't trap host pointer auth use to EL2

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-147.el8
commit-author Mark Rutland <mark.rutland@arm.com>
commit b3669b1e1c09890d61109a1a8ece2c5b66804714
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-147.el8/b3669b1e.failed

To allow EL0 (and/or EL1) to use pointer authentication functionality,
we must ensure that pointer authentication instructions and accesses to
pointer authentication keys are not trapped to EL2.

This patch ensures that HCR_EL2 is configured appropriately when the
kernel is booted at EL2. For non-VHE kernels we set HCR_EL2.{API,APK},
ensuring that EL1 can access keys and permit EL0 use of instructions.
For VHE kernels host EL0 (TGE && E2H) is unaffected by these settings,
and it doesn't matter how we configure HCR_EL2.{API,APK}, so we don't
bother setting them.

This does not enable support for KVM guests, since KVM manages HCR_EL2
itself when running VMs.

	Reviewed-by: Richard Henderson <richard.henderson@linaro.org>
	Signed-off-by: Mark Rutland <mark.rutland@arm.com>
	Signed-off-by: Kristina Martsenko <kristina.martsenko@arm.com>
	Acked-by: Christoffer Dall <christoffer.dall@arm.com>
	Cc: Catalin Marinas <catalin.marinas@arm.com>
	Cc: Marc Zyngier <marc.zyngier@arm.com>
	Cc: Will Deacon <will.deacon@arm.com>
	Cc: kvmarm@lists.cs.columbia.edu
	Signed-off-by: Will Deacon <will.deacon@arm.com>
(cherry picked from commit b3669b1e1c09890d61109a1a8ece2c5b66804714)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/arm64/include/asm/kvm_arm.h
diff --cc arch/arm64/include/asm/kvm_arm.h
index 55cfa090d1b5,f9123fe8fcf3..000000000000
--- a/arch/arm64/include/asm/kvm_arm.h
+++ b/arch/arm64/include/asm/kvm_arm.h
@@@ -23,6 -23,9 +23,12 @@@
  #include <asm/types.h>
  
  /* Hyp Configuration Register (HCR) bits */
++<<<<<<< HEAD
++=======
+ #define HCR_FWB		(UL(1) << 46)
+ #define HCR_API		(UL(1) << 41)
+ #define HCR_APK		(UL(1) << 40)
++>>>>>>> b3669b1e1c09 (arm64: Don't trap host pointer auth use to EL2)
  #define HCR_TEA		(UL(1) << 37)
  #define HCR_TERR	(UL(1) << 36)
  #define HCR_TLOR	(UL(1) << 35)
* Unmerged path arch/arm64/include/asm/kvm_arm.h
