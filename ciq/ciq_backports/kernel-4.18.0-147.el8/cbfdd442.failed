IB/uverbs: Add helper to get array size from ptr attribute

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-147.el8
commit-author Moni Shoua <monis@mellanox.com>
commit cbfdd442c43eab8c62bf2ea5127511cd39e9046d
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-147.el8/cbfdd442.failed

When the parser of an ioctl command has the knowledge that a ptr attribute
in a bundle represents an array of structures, it is useful for it to know
the number of elements in the array. This is done by dividing the
attribute length with the element size.

	Signed-off-by: Moni Shoua <monis@mellanox.com>
	Reviewed-by: Guy Levi <guyle@mellanox.com>
	Signed-off-by: Leon Romanovsky <leonro@mellanox.com>
	Signed-off-by: Jason Gunthorpe <jgg@mellanox.com>
(cherry picked from commit cbfdd442c43eab8c62bf2ea5127511cd39e9046d)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/hw/mlx5/flow.c
#	include/rdma/uverbs_ioctl.h
diff --cc include/rdma/uverbs_ioctl.h
index 90a4947ff548,bf07cd6336d3..000000000000
--- a/include/rdma/uverbs_ioctl.h
+++ b/include/rdma/uverbs_ioctl.h
@@@ -451,25 -719,51 +451,61 @@@ uverbs_attr_get_len(const struct uverbs
  	return attr->ptr_attr.len;
  }
  
++<<<<<<< HEAD
 +static inline int uverbs_copy_to(const struct uverbs_attr_bundle *attrs_bundle,
 +				 size_t idx, const void *from, size_t size)
++=======
+ /*
+  * uverbs_attr_ptr_get_array_size() - Get array size pointer by a ptr
+  * attribute.
+  * @attrs: The attribute bundle
+  * @idx: The ID of the attribute
+  * @elem_size: The size of the element in the array
+  */
+ static inline int
+ uverbs_attr_ptr_get_array_size(struct uverbs_attr_bundle *attrs, u16 idx,
+ 			       size_t elem_size)
+ {
+ 	int size = uverbs_attr_get_len(attrs, idx);
+ 
+ 	if (size < 0)
+ 		return size;
+ 
+ 	if (size % elem_size)
+ 		return -EINVAL;
+ 
+ 	return size / elem_size;
+ }
+ 
+ /**
+  * uverbs_attr_get_uobjs_arr() - Provides array's properties for attribute for
+  * UVERBS_ATTR_TYPE_IDRS_ARRAY.
+  * @arr: Returned pointer to array of pointers for uobjects or NULL if
+  *       the attribute isn't provided.
+  *
+  * Return: The array length or 0 if no attribute was provided.
+  */
+ static inline int uverbs_attr_get_uobjs_arr(
+ 	const struct uverbs_attr_bundle *attrs_bundle, u16 attr_idx,
+ 	struct ib_uobject ***arr)
++>>>>>>> cbfdd442c43e (IB/uverbs: Add helper to get array size from ptr attribute)
  {
 -	const struct uverbs_attr *attr =
 -			uverbs_attr_get(attrs_bundle, attr_idx);
 +	const struct uverbs_attr *attr = uverbs_attr_get(attrs_bundle, idx);
 +	u16 flags;
 +	size_t min_size;
  
 -	if (IS_ERR(attr)) {
 -		*arr = NULL;
 -		return 0;
 -	}
 +	if (IS_ERR(attr))
 +		return PTR_ERR(attr);
  
 -	*arr = attr->objs_arr_attr.uobjects;
 +	min_size = min_t(size_t, attr->ptr_attr.len, size);
 +	if (copy_to_user(u64_to_user_ptr(attr->ptr_attr.data), from, min_size))
 +		return -EFAULT;
 +
 +	flags = attr->ptr_attr.flags | UVERBS_ATTR_F_VALID_OUTPUT;
 +	if (put_user(flags, &attr->uattr->flags))
 +		return -EFAULT;
  
 -	return attr->objs_arr_attr.len;
 +	return 0;
  }
  
  static inline bool uverbs_attr_ptr_is_inline(const struct uverbs_attr *attr)
* Unmerged path drivers/infiniband/hw/mlx5/flow.c
* Unmerged path drivers/infiniband/hw/mlx5/flow.c
* Unmerged path include/rdma/uverbs_ioctl.h
