crypto: caam - Forbid 2-key 3DES in FIPS mode

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-147.el8
commit-author Herbert Xu <herbert@gondor.apana.org.au>
commit 1b52c40919e60cbc65af6b15ed5cdda0b3775f54
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-147.el8/1b52c409.failed

This patch forbids the use of 2-key 3DES (K1 == K3) in FIPS mode.

	Signed-off-by: Herbert Xu <herbert@gondor.apana.org.au>
	Reviewed-by: Horia GeantÄƒ <horia.geanta@nxp.com>
	Tested-by: Iuliana Prodan <iuliana.prodan@nxp.com>
	Signed-off-by: Herbert Xu <herbert@gondor.apana.org.au>
(cherry picked from commit 1b52c40919e60cbc65af6b15ed5cdda0b3775f54)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/crypto/caam/caamalg_qi.c
#	drivers/crypto/caam/caamalg_qi2.c
diff --cc drivers/crypto/caam/caamalg_qi.c
index 6e61cc93c2b0,70af211d2d01..000000000000
--- a/drivers/crypto/caam/caamalg_qi.c
+++ b/drivers/crypto/caam/caamalg_qi.c
@@@ -671,10 -700,17 +704,22 @@@ badkey
  	return -EINVAL;
  }
  
++<<<<<<< HEAD
 +static int xts_ablkcipher_setkey(struct crypto_ablkcipher *ablkcipher,
 +				 const u8 *key, unsigned int keylen)
++=======
+ static int des3_skcipher_setkey(struct crypto_skcipher *skcipher,
+ 				const u8 *key, unsigned int keylen)
+ {
+ 	return unlikely(des3_verify_key(skcipher, key)) ?:
+ 	       skcipher_setkey(skcipher, key, keylen);
+ }
+ 
+ static int xts_skcipher_setkey(struct crypto_skcipher *skcipher, const u8 *key,
+ 			       unsigned int keylen)
++>>>>>>> 1b52c40919e6 (crypto: caam - Forbid 2-key 3DES in FIPS mode)
  {
 -	struct caam_ctx *ctx = crypto_skcipher_ctx(skcipher);
 +	struct caam_ctx *ctx = crypto_ablkcipher_ctx(ablkcipher);
  	struct device *jrdev = ctx->jrdev;
  	int ret = 0;
  
@@@ -1573,19 -1413,18 +1618,31 @@@ static struct caam_alg_template driver_
  			.max_keysize = AES_MAX_KEY_SIZE,
  			.ivsize = AES_BLOCK_SIZE,
  		},
 -		.caam.class1_alg_type = OP_ALG_ALGSEL_AES | OP_ALG_AAI_CBC,
 +		.class1_alg_type = OP_ALG_ALGSEL_AES | OP_ALG_AAI_CBC,
  	},
  	{
++<<<<<<< HEAD
 +		.name = "cbc(des3_ede)",
 +		.driver_name = "cbc-3des-caam-qi",
 +		.blocksize = DES3_EDE_BLOCK_SIZE,
 +		.type = CRYPTO_ALG_TYPE_GIVCIPHER,
 +		.template_ablkcipher = {
 +			.setkey = ablkcipher_setkey,
 +			.encrypt = ablkcipher_encrypt,
 +			.decrypt = ablkcipher_decrypt,
 +			.givencrypt = ablkcipher_givencrypt,
 +			.geniv = "<built-in>",
++=======
+ 		.skcipher = {
+ 			.base = {
+ 				.cra_name = "cbc(des3_ede)",
+ 				.cra_driver_name = "cbc-3des-caam-qi",
+ 				.cra_blocksize = DES3_EDE_BLOCK_SIZE,
+ 			},
+ 			.setkey = des3_skcipher_setkey,
+ 			.encrypt = skcipher_encrypt,
+ 			.decrypt = skcipher_decrypt,
++>>>>>>> 1b52c40919e6 (crypto: caam - Forbid 2-key 3DES in FIPS mode)
  			.min_keysize = DES3_EDE_KEY_SIZE,
  			.max_keysize = DES3_EDE_KEY_SIZE,
  			.ivsize = DES3_EDE_BLOCK_SIZE,
* Unmerged path drivers/crypto/caam/caamalg_qi2.c
diff --git a/drivers/crypto/caam/caamalg.c b/drivers/crypto/caam/caamalg.c
index d67667970f7e..00f298134128 100644
--- a/drivers/crypto/caam/caamalg.c
+++ b/drivers/crypto/caam/caamalg.c
@@ -578,6 +578,39 @@ static int aead_setkey(struct crypto_aead *aead,
 	return -EINVAL;
 }
 
+static int des3_aead_setkey(struct crypto_aead *aead, const u8 *key,
+			    unsigned int keylen)
+{
+	struct crypto_authenc_keys keys;
+	u32 flags;
+	int err;
+
+	err = crypto_authenc_extractkeys(&keys, key, keylen);
+	if (unlikely(err))
+		goto badkey;
+
+	err = -EINVAL;
+	if (keys.enckeylen != DES3_EDE_KEY_SIZE)
+		goto badkey;
+
+	flags = crypto_aead_get_flags(aead);
+	err = __des3_verify_key(&flags, keys.enckey);
+	if (unlikely(err)) {
+		crypto_aead_set_flags(aead, flags);
+		goto out;
+	}
+
+	err = aead_setkey(aead, key, keylen);
+
+out:
+	memzero_explicit(&keys, sizeof(keys));
+	return err;
+
+badkey:
+	crypto_aead_set_flags(aead, CRYPTO_TFM_RES_BAD_KEY_LEN);
+	goto out;
+}
+
 static int gcm_setkey(struct crypto_aead *aead,
 		      const u8 *key, unsigned int keylen)
 {
@@ -2413,7 +2446,7 @@ static struct caam_aead_alg driver_aeads[] = {
 						   "cbc-des3_ede-caam",
 				.cra_blocksize = DES3_EDE_BLOCK_SIZE,
 			},
-			.setkey = aead_setkey,
+			.setkey = des3_aead_setkey,
 			.setauthsize = aead_setauthsize,
 			.encrypt = aead_encrypt,
 			.decrypt = aead_decrypt,
@@ -2435,7 +2468,7 @@ static struct caam_aead_alg driver_aeads[] = {
 						   "cbc-des3_ede-caam",
 				.cra_blocksize = DES3_EDE_BLOCK_SIZE,
 			},
-			.setkey = aead_setkey,
+			.setkey = des3_aead_setkey,
 			.setauthsize = aead_setauthsize,
 			.encrypt = aead_encrypt,
 			.decrypt = aead_decrypt,
@@ -2458,7 +2491,7 @@ static struct caam_aead_alg driver_aeads[] = {
 						   "cbc-des3_ede-caam",
 				.cra_blocksize = DES3_EDE_BLOCK_SIZE,
 			},
-			.setkey = aead_setkey,
+			.setkey = des3_aead_setkey,
 			.setauthsize = aead_setauthsize,
 			.encrypt = aead_encrypt,
 			.decrypt = aead_decrypt,
@@ -2481,7 +2514,7 @@ static struct caam_aead_alg driver_aeads[] = {
 						   "cbc-des3_ede-caam",
 				.cra_blocksize = DES3_EDE_BLOCK_SIZE,
 			},
-			.setkey = aead_setkey,
+			.setkey = des3_aead_setkey,
 			.setauthsize = aead_setauthsize,
 			.encrypt = aead_encrypt,
 			.decrypt = aead_decrypt,
@@ -2504,7 +2537,7 @@ static struct caam_aead_alg driver_aeads[] = {
 						   "cbc-des3_ede-caam",
 				.cra_blocksize = DES3_EDE_BLOCK_SIZE,
 			},
-			.setkey = aead_setkey,
+			.setkey = des3_aead_setkey,
 			.setauthsize = aead_setauthsize,
 			.encrypt = aead_encrypt,
 			.decrypt = aead_decrypt,
@@ -2527,7 +2560,7 @@ static struct caam_aead_alg driver_aeads[] = {
 						   "cbc-des3_ede-caam",
 				.cra_blocksize = DES3_EDE_BLOCK_SIZE,
 			},
-			.setkey = aead_setkey,
+			.setkey = des3_aead_setkey,
 			.setauthsize = aead_setauthsize,
 			.encrypt = aead_encrypt,
 			.decrypt = aead_decrypt,
@@ -2550,7 +2583,7 @@ static struct caam_aead_alg driver_aeads[] = {
 						   "cbc-des3_ede-caam",
 				.cra_blocksize = DES3_EDE_BLOCK_SIZE,
 			},
-			.setkey = aead_setkey,
+			.setkey = des3_aead_setkey,
 			.setauthsize = aead_setauthsize,
 			.encrypt = aead_encrypt,
 			.decrypt = aead_decrypt,
@@ -2573,7 +2606,7 @@ static struct caam_aead_alg driver_aeads[] = {
 						   "cbc-des3_ede-caam",
 				.cra_blocksize = DES3_EDE_BLOCK_SIZE,
 			},
-			.setkey = aead_setkey,
+			.setkey = des3_aead_setkey,
 			.setauthsize = aead_setauthsize,
 			.encrypt = aead_encrypt,
 			.decrypt = aead_decrypt,
@@ -2596,7 +2629,7 @@ static struct caam_aead_alg driver_aeads[] = {
 						   "cbc-des3_ede-caam",
 				.cra_blocksize = DES3_EDE_BLOCK_SIZE,
 			},
-			.setkey = aead_setkey,
+			.setkey = des3_aead_setkey,
 			.setauthsize = aead_setauthsize,
 			.encrypt = aead_encrypt,
 			.decrypt = aead_decrypt,
@@ -2619,7 +2652,7 @@ static struct caam_aead_alg driver_aeads[] = {
 						   "cbc-des3_ede-caam",
 				.cra_blocksize = DES3_EDE_BLOCK_SIZE,
 			},
-			.setkey = aead_setkey,
+			.setkey = des3_aead_setkey,
 			.setauthsize = aead_setauthsize,
 			.encrypt = aead_encrypt,
 			.decrypt = aead_decrypt,
@@ -2642,7 +2675,7 @@ static struct caam_aead_alg driver_aeads[] = {
 						   "cbc-des3_ede-caam",
 				.cra_blocksize = DES3_EDE_BLOCK_SIZE,
 			},
-			.setkey = aead_setkey,
+			.setkey = des3_aead_setkey,
 			.setauthsize = aead_setauthsize,
 			.encrypt = aead_encrypt,
 			.decrypt = aead_decrypt,
@@ -2665,7 +2698,7 @@ static struct caam_aead_alg driver_aeads[] = {
 						   "cbc-des3_ede-caam",
 				.cra_blocksize = DES3_EDE_BLOCK_SIZE,
 			},
-			.setkey = aead_setkey,
+			.setkey = des3_aead_setkey,
 			.setauthsize = aead_setauthsize,
 			.encrypt = aead_encrypt,
 			.decrypt = aead_decrypt,
* Unmerged path drivers/crypto/caam/caamalg_qi.c
* Unmerged path drivers/crypto/caam/caamalg_qi2.c
