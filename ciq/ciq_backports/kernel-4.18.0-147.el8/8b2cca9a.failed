arm64: KVM: Force VHE for systems affected by erratum 1165522

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-147.el8
commit-author Marc Zyngier <marc.zyngier@arm.com>
commit 8b2cca9ade2c0f1d2ba94e39781e7306c918e544
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-147.el8/8b2cca9a.failed

In order to easily mitigate ARM erratum 1165522, we need to force
affected CPUs to run in VHE mode if using KVM.

	Reviewed-by: James Morse <james.morse@arm.com>
	Signed-off-by: Marc Zyngier <marc.zyngier@arm.com>
	Signed-off-by: Will Deacon <will.deacon@arm.com>
(cherry picked from commit 8b2cca9ade2c0f1d2ba94e39781e7306c918e544)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/arm64/include/asm/cpucaps.h
#	arch/arm64/kernel/cpu_errata.c
diff --cc arch/arm64/include/asm/cpucaps.h
index c0f5aa4ec4c9,62d8cd15fdf2..000000000000
--- a/arch/arm64/include/asm/cpucaps.h
+++ b/arch/arm64/include/asm/cpucaps.h
@@@ -49,9 -49,13 +49,20 @@@
  #define ARM64_HAS_CACHE_DIC			28
  #define ARM64_HW_DBM				29
  #define ARM64_SSBD				30
++<<<<<<< HEAD
 +#define ARM64_HAS_SB				31
 +#define ARM64_HAS_CNP				32
 +
 +#define ARM64_NCAPS				33
++=======
+ #define ARM64_MISMATCHED_CACHE_TYPE		31
+ #define ARM64_HAS_STAGE2_FWB			32
+ #define ARM64_HAS_CRC32				33
+ #define ARM64_SSBS				34
+ #define ARM64_WORKAROUND_1188873		35
+ #define ARM64_WORKAROUND_1165522		36
+ 
+ #define ARM64_NCAPS				37
++>>>>>>> 8b2cca9ade2c (arm64: KVM: Force VHE for systems affected by erratum 1165522)
  
  #endif /* __ASM_CPUCAPS_H */
diff --cc arch/arm64/kernel/cpu_errata.c
index 5d1fa928ea4b,476e738e6c46..000000000000
--- a/arch/arm64/kernel/cpu_errata.c
+++ b/arch/arm64/kernel/cpu_errata.c
@@@ -672,6 -732,22 +672,25 @@@ const struct arm64_cpu_capabilities arm
  		.matches = has_ssbd_mitigation,
  	},
  #endif
++<<<<<<< HEAD
++=======
+ #ifdef CONFIG_ARM64_ERRATUM_1188873
+ 	{
+ 		/* Cortex-A76 r0p0 to r2p0 */
+ 		.desc = "ARM erratum 1188873",
+ 		.capability = ARM64_WORKAROUND_1188873,
+ 		ERRATA_MIDR_RANGE(MIDR_CORTEX_A76, 0, 0, 2, 0),
+ 	},
+ #endif
+ #ifdef CONFIG_ARM64_ERRATUM_1165522
+ 	{
+ 		/* Cortex-A76 r0p0 to r2p0 */
+ 		.desc = "ARM erratum 1165522",
+ 		.capability = ARM64_WORKAROUND_1165522,
+ 		ERRATA_MIDR_RANGE(MIDR_CORTEX_A76, 0, 0, 2, 0),
+ 	},
+ #endif
++>>>>>>> 8b2cca9ade2c (arm64: KVM: Force VHE for systems affected by erratum 1165522)
  	{
  	}
  };
* Unmerged path arch/arm64/include/asm/cpucaps.h
diff --git a/arch/arm64/include/asm/kvm_host.h b/arch/arm64/include/asm/kvm_host.h
index dac092fa1fa8..7366969d1f99 100644
--- a/arch/arm64/include/asm/kvm_host.h
+++ b/arch/arm64/include/asm/kvm_host.h
@@ -421,6 +421,10 @@ static inline bool kvm_arch_requires_vhe(void)
 	if (system_supports_sve())
 		return true;
 
+	/* Some implementations have defects that confine them to VHE */
+	if (cpus_have_cap(ARM64_WORKAROUND_1165522))
+		return true;
+
 	return false;
 }
 
* Unmerged path arch/arm64/kernel/cpu_errata.c
