crypto: s390 - Forbid 2-key 3DES in FIPS mode

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-147.el8
commit-author Herbert Xu <herbert@gondor.apana.org.au>
commit 55902d8514483bd2c94f375b5259224520a1fd6b
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-147.el8/55902d85.failed

This patch forbids the use of 2-key 3DES (K1 == K3) in FIPS mode.

	Signed-off-by: Herbert Xu <herbert@gondor.apana.org.au>
(cherry picked from commit 55902d8514483bd2c94f375b5259224520a1fd6b)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/s390/crypto/des_s390.c
diff --cc arch/s390/crypto/des_s390.c
index 5346b5a80bb6,1f9ab24dc048..000000000000
--- a/arch/s390/crypto/des_s390.c
+++ b/arch/s390/crypto/des_s390.c
@@@ -224,24 -224,11 +224,31 @@@ static int des3_setkey(struct crypto_tf
  		       unsigned int key_len)
  {
  	struct s390_des_ctx *ctx = crypto_tfm_ctx(tfm);
+ 	int err;
  
++<<<<<<< HEAD
 +	if (!(crypto_memneq(key, &key[DES_KEY_SIZE], DES_KEY_SIZE) &&
 +	    crypto_memneq(&key[DES_KEY_SIZE], &key[DES_KEY_SIZE * 2],
 +			  DES_KEY_SIZE)) &&
 +	    (tfm->crt_flags & CRYPTO_TFM_REQ_WEAK_KEY)) {
 +		tfm->crt_flags |= CRYPTO_TFM_RES_WEAK_KEY;
 +		return -EINVAL;
 +	}
 +
 +	/* in fips mode, ensure k1 != k2 and k2 != k3 and k1 != k3 */
 +	if (fips_enabled &&
 +	    !(crypto_memneq(key, &key[DES_KEY_SIZE], DES_KEY_SIZE) &&
 +	      crypto_memneq(&key[DES_KEY_SIZE], &key[DES_KEY_SIZE * 2],
 +			    DES_KEY_SIZE) &&
 +	      crypto_memneq(key, &key[DES_KEY_SIZE * 2], DES_KEY_SIZE))) {
 +		tfm->crt_flags |= CRYPTO_TFM_RES_WEAK_KEY;
 +		return -EINVAL;
 +	}
++=======
+ 	err = __des3_verify_key(&tfm->crt_flags, key);
+ 	if (unlikely(err))
+ 		return err;
++>>>>>>> 55902d851448 (crypto: s390 - Forbid 2-key 3DES in FIPS mode)
  
  	memcpy(ctx->key, key, key_len);
  	return 0;
* Unmerged path arch/s390/crypto/des_s390.c
