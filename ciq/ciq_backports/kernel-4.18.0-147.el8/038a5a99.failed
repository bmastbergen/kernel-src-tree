vxlan: changelink: Postpone vxlan_config_apply()

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-147.el8
commit-author Petr Machata <petrm@mellanox.com>
commit 038a5a99e95214d0549401c74711152d9869ead3
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-147.el8/038a5a99.failed

When an FDB entry is vetoed, it is necessary to unroll the changes that
have already been done. To avoid having to unroll vxlan_config_apply(),
postpone the call after the point where the vetoing takes place. Since
the call can't fail, it doesn't necessitate any cleanups in the
preceding FDB update logic.

Correspondingly, move down the mod_timer() call as well.

References to *dst need to be replaced with references to conf.
Additionally, old_dst and old_age_interval are not necessary anymore,
and therefore drop them.

	Signed-off-by: Petr Machata <petrm@mellanox.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 038a5a99e95214d0549401c74711152d9869ead3)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/vxlan.c
diff --cc drivers/net/vxlan.c
index e5a81fc3b94d,51e10f47d4f1..000000000000
--- a/drivers/net/vxlan.c
+++ b/drivers/net/vxlan.c
@@@ -3633,32 -3806,27 +3628,40 @@@ static int vxlan_changelink(struct net_
  	if (err)
  		return err;
  
- 	vxlan_config_apply(dev, &conf, lowerdev, vxlan->net, true);
- 
- 	if (old_age_interval != vxlan->cfg.age_interval)
- 		mod_timer(&vxlan->age_timer, jiffies);
- 
  	/* handle default dst entry */
- 	if (!vxlan_addr_equal(&dst->remote_ip, &old_dst.remote_ip)) {
+ 	if (!vxlan_addr_equal(&conf.remote_ip, &dst->remote_ip)) {
  		spin_lock_bh(&vxlan->hash_lock);
- 		if (!vxlan_addr_any(&old_dst.remote_ip))
+ 		if (!vxlan_addr_any(&dst->remote_ip))
  			__vxlan_fdb_delete(vxlan, all_zeros_mac,
- 					   old_dst.remote_ip,
+ 					   dst->remote_ip,
  					   vxlan->cfg.dst_port,
++<<<<<<< HEAD
 +					   old_dst.remote_vni,
 +					   old_dst.remote_vni,
 +					   old_dst.remote_ifindex);
- 
- 		if (!vxlan_addr_any(&dst->remote_ip)) {
++=======
+ 					   dst->remote_vni,
+ 					   dst->remote_vni,
+ 					   dst->remote_ifindex,
+ 					   true);
++>>>>>>> 038a5a99e952 (vxlan: changelink: Postpone vxlan_config_apply())
+ 
+ 		if (!vxlan_addr_any(&conf.remote_ip)) {
  			err = vxlan_fdb_update(vxlan, all_zeros_mac,
- 					       &dst->remote_ip,
+ 					       &conf.remote_ip,
  					       NUD_REACHABLE | NUD_PERMANENT,
  					       NLM_F_APPEND | NLM_F_CREATE,
  					       vxlan->cfg.dst_port,
++<<<<<<< HEAD
 +					       dst->remote_vni,
 +					       dst->remote_vni,
 +					       dst->remote_ifindex,
 +					       NTF_SELF);
++=======
+ 					       conf.vni, conf.vni,
+ 					       conf.remote_ifindex,
+ 					       NTF_SELF, true);
++>>>>>>> 038a5a99e952 (vxlan: changelink: Postpone vxlan_config_apply())
  			if (err) {
  				spin_unlock_bh(&vxlan->hash_lock);
  				return err;
* Unmerged path drivers/net/vxlan.c
