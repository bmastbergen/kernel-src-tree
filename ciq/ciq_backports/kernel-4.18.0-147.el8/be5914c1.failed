RDMA/core: Delete RoCE GID in hw when corresponding IP is deleted

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-147.el8
commit-author Parav Pandit <parav@mellanox.com>
commit be5914c124bc3179536e5c4598f59aeb4b880517
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-147.el8/be5914c1.failed

Currently a RoCE GID entry is removed from the hardware when all
references to the GID entry drop to zero. This is a change in behavior
from before the fixed patch. The GID entry should be removed from the
hardware when GID entry deletion is requested. This allows the driver
terminate ongoing traffic through the RoCE GID.

While a GID is deleted from the hardware, GID slot in the software GID
cache is not freed. GID slot is freed once all references of such GID are
dropped. This continue to ensure that such GID slot of hardware is not
allocated to new GID entry allocation request. It is allocated once all
references to GID entry drop.

This approach allows drivers to put a tombestone of some kind on the HW
GID index to block the traffic.

Fixes: b150c3862d21 ("IB/core: Introduce GID entry reference counts")
	Signed-off-by: Parav Pandit <parav@mellanox.com>
	Reviewed-by: Mark Bloch <markb@mellanox.com>
	Signed-off-by: Leon Romanovsky <leonro@mellanox.com>
	Signed-off-by: Jason Gunthorpe <jgg@mellanox.com>
(cherry picked from commit be5914c124bc3179536e5c4598f59aeb4b880517)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/core/cache.c
diff --cc drivers/infiniband/core/cache.c
index 6b40347eed49,7b04590f307f..000000000000
--- a/drivers/infiniband/core/cache.c
+++ b/drivers/infiniband/core/cache.c
@@@ -212,14 -212,9 +212,17 @@@ static void free_gid_entry_locked(struc
  	u8 port_num = entry->attr.port_num;
  	struct ib_gid_table *table = rdma_gid_table(device, port_num);
  
 -	dev_dbg(&device->dev, "%s port=%d index=%d gid %pI6\n", __func__,
 -		port_num, entry->attr.index, entry->attr.gid.raw);
 +	pr_debug("%s device=%s port=%d index=%d gid %pI6\n", __func__,
 +		 device->name, port_num, entry->attr.index,
 +		 entry->attr.gid.raw);
  
++<<<<<<< HEAD
 +	if (rdma_cap_roce_gid_table(device, port_num) &&
 +	    entry->state != GID_TABLE_ENTRY_INVALID)
 +		device->del_gid(&entry->attr, &entry->context);
 +
++=======
++>>>>>>> be5914c124bc (RDMA/core: Delete RoCE GID in hw when corresponding IP is deleted)
  	write_lock_irq(&table->rwlock);
  
  	/*
* Unmerged path drivers/infiniband/core/cache.c
