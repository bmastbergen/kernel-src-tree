IB/mlx5: Enable DEVX on IB

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-147.el8
commit-author Yishai Hadas <yishaih@mellanox.com>
commit 3df6e0234aebc55888069997239fe2847d4cf152
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-147.el8/3df6e023.failed

IB has additional protections with SELinux that cannot be extended to the
DEVX domain. SELinux can restrict access to pkeys. The first version of
DEVX blocked IB entirely until this could be understood.

Since DEVX requires CAP_NET_RAW, it supersedes the SELinux restriction and
allows userspace to form arbitrary packets with arbitrary pkeys.

Thus we enable IB for DEVX when CAP_NET_RAW is given.

	Signed-off-by: Yishai Hadas <yishaih@mellanox.com>
	Signed-off-by: Leon Romanovsky <leonro@mellanox.com>
	Signed-off-by: Jason Gunthorpe <jgg@mellanox.com>
(cherry picked from commit 3df6e0234aebc55888069997239fe2847d4cf152)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/hw/mlx5/main.c
diff --cc drivers/infiniband/hw/mlx5/main.c
index f0ec543ce522,b3294a7e3ff9..000000000000
--- a/drivers/infiniband/hw/mlx5/main.c
+++ b/drivers/infiniband/hw/mlx5/main.c
@@@ -1720,22 -1758,18 +1720,29 @@@ static struct ib_ucontext *mlx5_ib_allo
  	context->ibucontext.invalidate_range = &mlx5_ib_invalidate_range;
  #endif
  
 +	err = mlx5_ib_alloc_transport_domain(dev, &context->tdn);
 +	if (err)
 +		goto out_uars;
 +
  	if (req.flags & MLX5_IB_ALLOC_UCTX_DEVX) {
++<<<<<<< HEAD
 +		/* Block DEVX on Infiniband as of SELinux */
 +		if (mlx5_ib_port_link_layer(ibdev, 1) != IB_LINK_LAYER_ETHERNET) {
 +			err = -EPERM;
 +			goto out_td;
 +		}
 +
 +		err = mlx5_ib_devx_create(dev, context);
 +		if (err)
 +			goto out_td;
++=======
+ 		err = mlx5_ib_devx_create(dev);
+ 		if (err < 0)
+ 			goto out_uars;
+ 		context->devx_uid = err;
++>>>>>>> 3df6e0234aeb (IB/mlx5: Enable DEVX on IB)
  	}
  
 -	err = mlx5_ib_alloc_transport_domain(dev, &context->tdn,
 -					     context->devx_uid);
 -	if (err)
 -		goto out_devx;
 -
  	if (MLX5_CAP_GEN(dev->mdev, dump_fill_mkey)) {
  		err = mlx5_cmd_dump_fill_mkey(dev->mdev, &dump_fill_mkey);
  		if (err)
* Unmerged path drivers/infiniband/hw/mlx5/main.c
