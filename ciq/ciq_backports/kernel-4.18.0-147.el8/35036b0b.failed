selftests: forwarding: mirror_gre_vlan_bridge_1q: Fix untagged test

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-147.el8
commit-author Petr Machata <petrm@mellanox.com>
commit 35036b0b09c4311e2879a3101cc61ccf6fd76ddf
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-147.el8/35036b0b.failed

The untagged egress test sets up mirroring to {,ip6}gretap such that the
underlay goes through a bridge. Then VLAN flags are manipulated to test
that the traffic leaves the bridge 802.1q-tagged or not, as appropriate.

However, when a neighbor expires at the time that the bridge VLAN is
configured as PVID and egress untagged, the following discovery process
can't finish, because the IP address on H3 is still at the VLAN-tagged
netdevice. This manifests by occasional failures where only several of
the 10 required packets get through.

Therefore, when reconfiguring the VLAN flags, move the IP address to the
appropriate device in the H3 VRF.

In addition to that, take this opportunity to embed an ASCII art diagram
to make the topology move obvious.

	Signed-off-by: Petr Machata <petrm@mellanox.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 35036b0b09c4311e2879a3101cc61ccf6fd76ddf)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/testing/selftests/net/forwarding/mirror_gre_vlan_bridge_1q.sh
diff --cc tools/testing/selftests/net/forwarding/mirror_gre_vlan_bridge_1q.sh
index a12274776116,43ee505f9f71..000000000000
--- a/tools/testing/selftests/net/forwarding/mirror_gre_vlan_bridge_1q.sh
+++ b/tools/testing/selftests/net/forwarding/mirror_gre_vlan_bridge_1q.sh
@@@ -28,6 -61,17 +61,20 @@@ source mirror_lib.s
  source mirror_gre_lib.sh
  source mirror_gre_topo_lib.sh
  
++<<<<<<< HEAD
++=======
+ require_command $ARPING
+ 
+ h3_addr_add_del()
+ {
+ 	local add_del=$1; shift
+ 	local dev=$1; shift
+ 
+ 	ip addr $add_del dev $dev 192.0.2.130/28
+ 	ip addr $add_del dev $dev 2001:db8:2::2/64
+ }
+ 
++>>>>>>> 35036b0b09c4 (selftests: forwarding: mirror_gre_vlan_bridge_1q: Fix untagged test)
  setup_prepare()
  {
  	h1=${NETIFS[p1]}
* Unmerged path tools/testing/selftests/net/forwarding/mirror_gre_vlan_bridge_1q.sh
