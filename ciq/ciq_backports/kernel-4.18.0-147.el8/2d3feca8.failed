bpf: btf: print map dump and lookup with btf info

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-147.el8
commit-author Okash Khawaja <osk@fb.com>
commit 2d3feca8c44f315624b7c0f5b8361e2f54405c12
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-147.el8/2d3feca8.failed

This patch augments the output of bpftool's map dump and map lookup
commands to print data along side btf info, if the correspondin btf
info is available. The outputs for each of  map dump and map lookup
commands are augmented in two ways:

1. when neither of -j and -p are supplied, btf-ful map data is printed
whose aim is human readability. This means no commitments for json- or
backward- compatibility.

2. when either -j or -p are supplied, a new json object named
"formatted" is added for each key-value pair. This object contains the
same data as the key-value pair, but with btf info. "formatted" object
promises json- and backward- compatibility. Below is a sample output.

$ bpftool map dump -p id 8
[{
        "key": ["0x0f","0x00","0x00","0x00"
        ],
        "value": ["0x03", "0x00", "0x00", "0x00", ...
        ],
        "formatted": {
                "key": 15,
                "value": {
                        "int_field":  3,
                        ...
                }
        }
}
]

This patch calls btf_dumper introduced in previous patch to accomplish
the above. Indeed, btf-ful info is only displayed if btf data for the
given map is available. Otherwise existing output is displayed as-is.

	Signed-off-by: Okash Khawaja <osk@fb.com>
	Acked-by: Martin KaFai Lau <kafai@fb.com>
	Reviewed-by: Jakub Kicinski <jakub.kicinski@netronome.com>
	Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
(cherry picked from commit 2d3feca8c44f315624b7c0f5b8361e2f54405c12)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/bpf/bpftool/map.c
diff --cc tools/bpf/bpftool/map.c
index 538986c08337,9c8191845585..000000000000
--- a/tools/bpf/bpftool/map.c
+++ b/tools/bpf/bpftool/map.c
@@@ -34,7 -34,7 +34,11 @@@
  #include <assert.h>
  #include <errno.h>
  #include <fcntl.h>
++<<<<<<< HEAD
 +#include <linux/kernel.h>
++=======
+ #include <linux/err.h>
++>>>>>>> 2d3feca8c44f (bpf: btf: print map dump and lookup with btf info)
  #include <stdbool.h>
  #include <stdio.h>
  #include <stdlib.h>
@@@ -160,11 -262,20 +267,21 @@@ static void print_entry_json(struct bpf
  		print_hex_data_json(key, info->key_size);
  		jsonw_name(json_wtr, "value");
  		print_hex_data_json(value, info->value_size);
+ 		if (btf) {
+ 			struct btf_dumper d = {
+ 				.btf = btf,
+ 				.jw = json_wtr,
+ 				.is_plain_text = false,
+ 			};
+ 
+ 			jsonw_name(json_wtr, "formatted");
+ 			do_dump_btf(&d, info, key, value);
+ 		}
  	} else {
 -		unsigned int i, n;
 +		unsigned int i, n, step;
  
  		n = get_possible_cpus();
 +		step = round_up(info->value_size, 8);
  
  		jsonw_name(json_wtr, "key");
  		print_hex_data_json(key, info->key_size);
* Unmerged path tools/bpf/bpftool/map.c
