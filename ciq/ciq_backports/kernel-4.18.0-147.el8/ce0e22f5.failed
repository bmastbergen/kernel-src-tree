drm/amdgpu: fix ring test failure issue during s3 in vce 3.0 (V2)

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-147.el8
commit-author Louis Li <Ching-shih.Li@amd.com>
commit ce0e22f5d886d1b56c7ab4347c45b9ac5fcc058d
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-147.el8/ce0e22f5.failed

[What]
vce ring test fails consistently during resume in s3 cycle, due to
mismatch read & write pointers.
On debug/analysis its found that rptr to be compared is not being
correctly updated/read, which leads to this failure.
Below is the failure signature:
	[drm:amdgpu_vce_ring_test_ring] *ERROR* amdgpu: ring 12 test failed
	[drm:amdgpu_device_ip_resume_phase2] *ERROR* resume of IP block <vce_v3_0> failed -110
	[drm:amdgpu_device_resume] *ERROR* amdgpu_device_ip_resume failed (-110).

[How]
fetch rptr appropriately, meaning move its read location further down
in the code flow.
With this patch applied the s3 failure is no more seen for >5k s3 cycles,
which otherwise is pretty consistent.

V2: remove reduntant fetch of rptr

	Signed-off-by: Louis Li <Ching-shih.Li@amd.com>
	Reviewed-by: Christian KÃ¶nig <christian.koenig@amd.com>
	Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
	Cc: stable@vger.kernel.org
(cherry picked from commit ce0e22f5d886d1b56c7ab4347c45b9ac5fcc058d)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/gpu/drm/amd/amdgpu/amdgpu_vce.c
diff --cc drivers/gpu/drm/amd/amdgpu/amdgpu_vce.c
index 23d960ec1cf2,f7189e22f6b7..000000000000
--- a/drivers/gpu/drm/amd/amdgpu/amdgpu_vce.c
+++ b/drivers/gpu/drm/amd/amdgpu/amdgpu_vce.c
@@@ -1074,11 -1081,11 +1074,17 @@@ int amdgpu_vce_ring_test_ring(struct am
  		return 0;
  
  	r = amdgpu_ring_alloc(ring, 16);
 -	if (r)
 +	if (r) {
 +		DRM_ERROR("amdgpu: vce failed to lock ring %d (%d).\n",
 +			  ring->idx, r);
  		return r;
++<<<<<<< HEAD
 +	}
++=======
+ 
+ 	rptr = amdgpu_ring_get_rptr(ring);
+ 
++>>>>>>> ce0e22f5d886 (drm/amdgpu: fix ring test failure issue during s3 in vce 3.0 (V2))
  	amdgpu_ring_write(ring, VCE_CMD_END);
  	amdgpu_ring_commit(ring);
  
* Unmerged path drivers/gpu/drm/amd/amdgpu/amdgpu_vce.c
