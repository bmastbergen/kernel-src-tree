net/mlx5: Rework handling of port module events

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-147.el8
commit-author Mikhael Goikhman <migo@mellanox.com>
commit c2fb3db22d35f01774d0547b1d8e5085df193646
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-147.el8/c2fb3db2.failed

Add explicit HW defined error values. For simplicity, keep counters for all
statuses starting from 0, although currently status=0 is not used.

Additionally, when HW signals an unexpected cable status, it is reported
now rather than ignored. And status counter is now updated on errors.

	Signed-off-by: Mikhael Goikhman <migo@mellanox.com>
	Signed-off-by: Saeed Mahameed <saeedm@mellanox.com>
(cherry picked from commit c2fb3db22d35f01774d0547b1d8e5085df193646)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlx5/core/events.c
#	drivers/net/ethernet/mellanox/mlx5/core/lib/mlx5.h
diff --cc drivers/net/ethernet/mellanox/mlx5/core/lib/mlx5.h
index 7550b1cc8c6a,af19fa61e9ef..000000000000
--- a/drivers/net/ethernet/mellanox/mlx5/core/lib/mlx5.h
+++ b/drivers/net/ethernet/mellanox/mlx5/core/lib/mlx5.h
@@@ -40,4 -42,36 +40,39 @@@ void mlx5_core_unreserve_gids(struct ml
  int  mlx5_core_reserved_gid_alloc(struct mlx5_core_dev *dev, int *gid_index);
  void mlx5_core_reserved_gid_free(struct mlx5_core_dev *dev, int gid_index);
  
++<<<<<<< HEAD
++=======
+ /* TODO move to lib/events.h */
+ 
+ #define PORT_MODULE_EVENT_MODULE_STATUS_MASK 0xF
+ #define PORT_MODULE_EVENT_ERROR_TYPE_MASK    0xF
+ 
+ enum port_module_event_status_type {
+ 	MLX5_MODULE_STATUS_PLUGGED   = 0x1,
+ 	MLX5_MODULE_STATUS_UNPLUGGED = 0x2,
+ 	MLX5_MODULE_STATUS_ERROR     = 0x3,
+ 	MLX5_MODULE_STATUS_NUM,
+ };
+ 
+ enum  port_module_event_error_type {
+ 	MLX5_MODULE_EVENT_ERROR_POWER_BUDGET_EXCEEDED    = 0x0,
+ 	MLX5_MODULE_EVENT_ERROR_LONG_RANGE_FOR_NON_MLNX  = 0x1,
+ 	MLX5_MODULE_EVENT_ERROR_BUS_STUCK                = 0x2,
+ 	MLX5_MODULE_EVENT_ERROR_NO_EEPROM_RETRY_TIMEOUT  = 0x3,
+ 	MLX5_MODULE_EVENT_ERROR_ENFORCE_PART_NUMBER_LIST = 0x4,
+ 	MLX5_MODULE_EVENT_ERROR_UNKNOWN_IDENTIFIER       = 0x5,
+ 	MLX5_MODULE_EVENT_ERROR_HIGH_TEMPERATURE         = 0x6,
+ 	MLX5_MODULE_EVENT_ERROR_BAD_CABLE                = 0x7,
+ 	MLX5_MODULE_EVENT_ERROR_NUM,
+ };
+ 
+ struct mlx5_pme_stats {
+ 	u64 status_counters[MLX5_MODULE_STATUS_NUM];
+ 	u64 error_counters[MLX5_MODULE_EVENT_ERROR_NUM];
+ };
+ 
+ void mlx5_get_pme_stats(struct mlx5_core_dev *dev, struct mlx5_pme_stats *stats);
+ int mlx5_notifier_call_chain(struct mlx5_events *events, unsigned int event, void *data);
+ 
++>>>>>>> c2fb3db22d35 (net/mlx5: Rework handling of port module events)
  #endif
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/events.c
diff --git a/drivers/net/ethernet/mellanox/mlx5/core/en_stats.c b/drivers/net/ethernet/mellanox/mlx5/core/en_stats.c
index ea79c0d400c1..34bc05b9fa68 100644
--- a/drivers/net/ethernet/mellanox/mlx5/core/en_stats.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/en_stats.c
@@ -1076,13 +1076,13 @@ static void mlx5e_grp_per_prio_update_stats(struct mlx5e_priv *priv)
 }
 
 static const struct counter_desc mlx5e_pme_status_desc[] = {
-	{ "module_unplug", 8 },
+	{ "module_unplug",       sizeof(u64) * MLX5_MODULE_STATUS_UNPLUGGED },
 };
 
 static const struct counter_desc mlx5e_pme_error_desc[] = {
-	{ "module_bus_stuck", 16 },       /* bus stuck (I2C or data shorted) */
-	{ "module_high_temp", 48 },       /* high temperature */
-	{ "module_bad_shorted", 56 },    /* bad or shorted cable/module */
+	{ "module_bus_stuck",    sizeof(u64) * MLX5_MODULE_EVENT_ERROR_BUS_STUCK },
+	{ "module_high_temp",    sizeof(u64) * MLX5_MODULE_EVENT_ERROR_HIGH_TEMPERATURE },
+	{ "module_bad_shorted",  sizeof(u64) * MLX5_MODULE_EVENT_ERROR_BAD_CABLE },
 };
 
 #define NUM_PME_STATUS_STATS		ARRAY_SIZE(mlx5e_pme_status_desc)
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/events.c
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/lib/mlx5.h
