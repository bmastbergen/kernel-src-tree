net/tls: Disable async decrytion for tls1.3

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-147.el8
Rebuild_CHGLOG: - [net] tls: Disable async decrytion for tls1.3 (Sabrina Dubroca) [1711821]
Rebuild_FUZZ: 95.12%
commit-author Vakul Garg <vakul.garg@nxp.com>
commit 8497ded2d16caabad1d9be7e7ec9b085e48ddfe4
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-147.el8/8497ded2.failed

Function tls_sw_recvmsg() dequeues multiple records from stream parser
and decrypts them. In case the decryption is done by async accelerator,
the records may get submitted for decryption while the previous ones may
not have been decryted yet. For tls1.3, the record type is known only
after decryption. Therefore, for tls1.3, tls_sw_recvmsg() may submit
records for decryption even if it gets 'handshake' records after 'data'
records. These intermediate 'handshake' records may do a key updation.
By the time new keys are given to ktls by userspace, it is possible that
ktls has already submitted some records i(which are encrypted with new
keys) for decryption using old keys. This would lead to decrypt failure.
Therefore, async decryption of records should be disabled for tls1.3.

Fixes: 130b392c6cd6b ("net: tls: Add tls 1.3 support")
	Signed-off-by: Vakul Garg <vakul.garg@nxp.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 8497ded2d16caabad1d9be7e7ec9b085e48ddfe4)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/tls/tls_sw.c
diff --cc net/tls/tls_sw.c
index 3f443983a6b3,fe8c287cbaa1..000000000000
--- a/net/tls/tls_sw.c
+++ b/net/tls/tls_sw.c
@@@ -1804,6 -2214,14 +1804,17 @@@ int tls_set_sw_offload(struct sock *sk
  		goto free_aead;
  
  	if (sw_ctx_rx) {
++<<<<<<< HEAD
++=======
+ 		tfm = crypto_aead_tfm(sw_ctx_rx->aead_recv);
+ 
+ 		if (crypto_info->version == TLS_1_3_VERSION)
+ 			sw_ctx_rx->async_capable = false;
+ 		else
+ 			sw_ctx_rx->async_capable =
+ 				tfm->__crt_alg->cra_flags & CRYPTO_ALG_ASYNC;
+ 
++>>>>>>> 8497ded2d16c (net/tls: Disable async decrytion for tls1.3)
  		/* Set up strparser */
  		memset(&cb, 0, sizeof(cb));
  		cb.rcv_msg = tls_queue;
* Unmerged path net/tls/tls_sw.c
