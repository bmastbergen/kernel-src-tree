net: mii: Fix autoneg in mii_lpa_to_linkmode_lpa_t()

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-147.el8
Rebuild_CHGLOG: - [include] mii: Fix autoneg in mii_lpa_to_linkmode_lpa_t() (Petr Oros) [1691676]
Rebuild_FUZZ: 94.95%
commit-author Andrew Lunn <andrew@lunn.ch>
commit 5f15eed245bc6d7c82d44f0ebcaf62071a9d55bd
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-147.el8/5f15eed2.failed

mii_adv_to_linkmode_adv_t() clears all bits before setting it needs to
set. This means the freshly set Autoneg gets cleared.

Change the order, and add comments about it clearing the old content
of the bitmap.

Fixes: c0ec3c273677 ("net: phy: Convert u32 phydev->lp_advertising to linkmode")
	Reported-by: Heiner Kallweit <hkallweit1@gmail.com>
	Signed-off-by: Andrew Lunn <andrew@lunn.ch>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 5f15eed245bc6d7c82d44f0ebcaf62071a9d55bd)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	include/linux/mii.h
diff --cc include/linux/mii.h
index b1ce53b7dcd6,57365224306c..000000000000
--- a/include/linux/mii.h
+++ b/include/linux/mii.h
@@@ -385,13 -405,32 +386,36 @@@ static inline void mii_adv_to_linkmode_
  }
  
  /**
 - * mii_lpa_to_linkmode_lpa_t
 - * @adv: value of the MII_LPA register
 + * ethtool_adv_to_lcl_adv_t
 + * @advertising:pointer to ethtool advertising
   *
++<<<<<<< HEAD
 + * A small helper function that translates ethtool advertising to LVL
++=======
+  * A small helper function that translates MII_LPA bits, when in
+  * 1000Base-T mode, to linkmode LP advertisement settings. Clears the
+  * old value of advertising
+  */
+ static inline void mii_lpa_to_linkmode_lpa_t(unsigned long *lp_advertising,
+ 					     u32 lpa)
+ {
+ 	mii_adv_to_linkmode_adv_t(lp_advertising, lpa);
+ 
+ 	if (lpa & LPA_LPACK)
+ 		linkmode_set_bit(ETHTOOL_LINK_MODE_Autoneg_BIT,
+ 				 lp_advertising);
+ 
+ }
+ 
+ /**
+  * linkmode_adv_to_lcl_adv_t
+  * @advertising:pointer to linkmode advertising
+  *
+  * A small helper function that translates linkmode advertising to LVL
++>>>>>>> 5f15eed245bc (net: mii: Fix autoneg in mii_lpa_to_linkmode_lpa_t())
   * pause capabilities.
   */
 -static inline u32 linkmode_adv_to_lcl_adv_t(unsigned long *advertising)
 +static inline u32 ethtool_adv_to_lcl_adv_t(u32 advertising)
  {
  	u32 lcl_adv = 0;
  
* Unmerged path include/linux/mii.h
