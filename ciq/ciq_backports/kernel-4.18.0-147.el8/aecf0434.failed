scsi: qla2xxx: Fix Remote port registration

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-147.el8
commit-author Quinn Tran <quinn.tran@cavium.com>
commit aecf043443d38bded9f57b272d97b2aea4cee616
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-147.el8/aecf0434.failed

	Signed-off-by: Quinn Tran <quinn.tran@cavium.com>
	Signed-off-by: Himanshu Madhani <himanshu.madhani@cavium.com>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit aecf043443d38bded9f57b272d97b2aea4cee616)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/qla2xxx/qla_init.c
diff --cc drivers/scsi/qla2xxx/qla_init.c
index 55688150ecd4,e7de6f149e34..000000000000
--- a/drivers/scsi/qla2xxx/qla_init.c
+++ b/drivers/scsi/qla2xxx/qla_init.c
@@@ -5071,18 -5283,23 +5071,38 @@@ qla2x00_update_fcport(scsi_qla_host_t *
  	ql_dbg(ql_dbg_disc, vha, 0x20ef, "%s %8phC\n",
  	    __func__, fcport->port_name);
  
++<<<<<<< HEAD
 +	if (IS_QLAFX00(vha->hw)) {
 +		qla2x00_set_fcport_state(fcport, FCS_ONLINE);
 +	} else {
 +		fcport->login_retry = 0;
 +		fcport->flags &= ~(FCF_LOGIN_NEEDED | FCF_ASYNC_SENT);
 +		fcport->disc_state = DSC_LOGIN_COMPLETE;
 +		fcport->deleted = 0;
 +		fcport->logout_on_delete = 1;
 +		qla2x00_set_fcport_state(fcport, FCS_ONLINE);
 +	}
 +
 +	qla2x00_set_fcport_state(fcport, FCS_ONLINE);
++=======
+ 	fcport->disc_state = DSC_UPD_FCPORT;
+ 	fcport->login_retry = vha->hw->login_retry_count;
+ 	fcport->flags &= ~(FCF_LOGIN_NEEDED | FCF_ASYNC_SENT);
+ 	fcport->deleted = 0;
+ 	fcport->logout_on_delete = 1;
+ 	fcport->login_retry = vha->hw->login_retry_count;
+ 	fcport->n2n_chip_reset = fcport->n2n_link_reset_cnt = 0;
+ 
+ 	switch (vha->hw->current_topology) {
+ 	case ISP_CFG_N:
+ 	case ISP_CFG_NL:
+ 		fcport->keep_nport_handle = 1;
+ 		break;
+ 	default:
+ 		break;
+ 	}
+ 
++>>>>>>> aecf043443d3 (scsi: qla2xxx: Fix Remote port registration)
  	qla2x00_iidma_fcport(vha, fcport);
  
  	if (fcport->fc4f_nvme) {
@@@ -5127,6 -5348,36 +5149,39 @@@
  			qla24xx_post_gpsc_work(vha, fcport);
  		}
  	}
++<<<<<<< HEAD
++=======
+ 
+ 	fcport->disc_state = DSC_LOGIN_COMPLETE;
+ }
+ 
+ void qla_register_fcport_fn(struct work_struct *work)
+ {
+ 	fc_port_t *fcport = container_of(work, struct fc_port, reg_work);
+ 	u32 rscn_gen = fcport->rscn_gen;
+ 	u16 data[2];
+ 
+ 	if (IS_SW_RESV_ADDR(fcport->d_id))
+ 		return;
+ 
+ 	qla2x00_update_fcport(fcport->vha, fcport);
+ 
+ 	if (rscn_gen != fcport->rscn_gen) {
+ 		/* RSCN(s) came in while registration */
+ 		switch (fcport->next_disc_state) {
+ 		case DSC_DELETE_PEND:
+ 			qlt_schedule_sess_for_deletion(fcport);
+ 			break;
+ 		case DSC_ADISC:
+ 			data[0] = data[1] = 0;
+ 			qla2x00_post_async_adisc_work(fcport->vha, fcport,
+ 			    data);
+ 			break;
+ 		default:
+ 			break;
+ 		}
+ 	}
++>>>>>>> aecf043443d3 (scsi: qla2xxx: Fix Remote port registration)
  }
  
  /*
* Unmerged path drivers/scsi/qla2xxx/qla_init.c
