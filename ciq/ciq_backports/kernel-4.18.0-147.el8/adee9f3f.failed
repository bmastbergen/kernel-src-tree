RDMA/core: Depend on device_add() to add device attributes

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-147.el8
commit-author Parav Pandit <parav@mellanox.com>
commit adee9f3f3bbb317c5469f84deba01eef4b86515b
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-147.el8/adee9f3f.failed

Instead of adding/removing device attribute files, depend on device_add()
which considers adding these device files based on NULL terminated
attributes group array.

	Signed-off-by: Parav Pandit <parav@mellanox.com>
	Reviewed-by: Daniel Jurgens <danielj@mellanox.com>
	Signed-off-by: Leon Romanovsky <leonro@mellanox.com>
	Signed-off-by: Jason Gunthorpe <jgg@mellanox.com>
(cherry picked from commit adee9f3f3bbb317c5469f84deba01eef4b86515b)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/core/sysfs.c
diff --cc drivers/infiniband/core/sysfs.c
index 504a65fbe8ef,185075af3ad6..000000000000
--- a/drivers/infiniband/core/sysfs.c
+++ b/drivers/infiniband/core/sysfs.c
@@@ -1362,10 -1355,8 +1360,15 @@@ err
  
  void ib_device_unregister_sysfs(struct ib_device *device)
  {
++<<<<<<< HEAD
 +	int i;
 +
 +	/* Hold device until ib_dealloc_device() */
 +	get_device(&device->dev);
++=======
+ 	/* Hold kobject until ib_dealloc_device() */
+ 	kobject_get(&device->dev.kobj);
++>>>>>>> adee9f3f3bbb (RDMA/core: Depend on device_add() to add device attributes)
  
  	free_port_list_attributes(device);
  
* Unmerged path drivers/infiniband/core/sysfs.c
diff --git a/include/rdma/ib_verbs.h b/include/rdma/ib_verbs.h
index 822d4354bdc8..69feb9ec6312 100644
--- a/include/rdma/ib_verbs.h
+++ b/include/rdma/ib_verbs.h
@@ -2553,6 +2553,9 @@ struct ib_device {
 
 	struct module               *owner;
 	struct device                dev;
+	/* First group for device attributes, NULL terminated array */
+	const struct attribute_group	*groups[2];
+
 	struct kobject               *ports_parent;
 	struct list_head             port_list;
 
