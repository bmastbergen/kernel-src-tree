s390/speculation: Support 'mitigations=' cmdline option

jira LE-1907
cve CVE-2019-11091
cve CVE-2018-12130
cve CVE-2018-12127
cve CVE-2018-12126
Rebuild_History Non-Buildable kernel-4.18.0-147.el8
commit-author Josh Poimboeuf <jpoimboe@redhat.com>
commit 0336e04a6520bdaefdb0769d2a70084fa52e81ed
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-147.el8/0336e04a.failed

Configure s390 runtime CPU speculation bug mitigations in accordance
with the 'mitigations=' cmdline option.  This affects Spectre v1 and
Spectre v2.

The default behavior is unchanged.

	Signed-off-by: Josh Poimboeuf <jpoimboe@redhat.com>
	Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
	Tested-by: Jiri Kosina <jkosina@suse.cz> (on x86)
	Reviewed-by: Jiri Kosina <jkosina@suse.cz>
	Cc: Borislav Petkov <bp@alien8.de>
	Cc: "H . Peter Anvin" <hpa@zytor.com>
	Cc: Andy Lutomirski <luto@kernel.org>
	Cc: Peter Zijlstra <peterz@infradead.org>
	Cc: Jiri Kosina <jikos@kernel.org>
	Cc: Waiman Long <longman@redhat.com>
	Cc: Andrea Arcangeli <aarcange@redhat.com>
	Cc: Jon Masters <jcm@redhat.com>
	Cc: Benjamin Herrenschmidt <benh@kernel.crashing.org>
	Cc: Paul Mackerras <paulus@samba.org>
	Cc: Michael Ellerman <mpe@ellerman.id.au>
	Cc: linuxppc-dev@lists.ozlabs.org
	Cc: Martin Schwidefsky <schwidefsky@de.ibm.com>
	Cc: Heiko Carstens <heiko.carstens@de.ibm.com>
	Cc: linux-s390@vger.kernel.org
	Cc: Catalin Marinas <catalin.marinas@arm.com>
	Cc: Will Deacon <will.deacon@arm.com>
	Cc: linux-arm-kernel@lists.infradead.org
	Cc: linux-arch@vger.kernel.org
	Cc: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
	Cc: Tyler Hicks <tyhicks@canonical.com>
	Cc: Linus Torvalds <torvalds@linux-foundation.org>
	Cc: Randy Dunlap <rdunlap@infradead.org>
	Cc: Steven Price <steven.price@arm.com>
	Cc: Phil Auld <pauld@redhat.com>
Link: https://lkml.kernel.org/r/e4a161805458a5ec88812aac0307ae3908a030fc.1555085500.git.jpoimboe@redhat.com

(cherry picked from commit 0336e04a6520bdaefdb0769d2a70084fa52e81ed)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	Documentation/admin-guide/kernel-parameters.txt
diff --cc Documentation/admin-guide/kernel-parameters.txt
index 6e44a230dfc6,1ae93872b79f..000000000000
--- a/Documentation/admin-guide/kernel-parameters.txt
+++ b/Documentation/admin-guide/kernel-parameters.txt
@@@ -2513,7 -2514,7 +2513,11 @@@
  			http://repo.or.cz/w/linux-2.6/mini2440.git
  
  	mitigations=
++<<<<<<< HEAD
 +			[X86] Control optional mitigations for CPU
++=======
+ 			[X86,PPC,S390] Control optional mitigations for CPU
++>>>>>>> 0336e04a6520 (s390/speculation: Support 'mitigations=' cmdline option)
  			vulnerabilities.  This is a set of curated,
  			arch-independent options, each of which is an
  			aggregation of existing arch-specific options.
@@@ -2522,10 -2523,12 +2526,17 @@@
  				Disable all optional CPU mitigations.  This
  				improves system performance, but it may also
  				expose users to several CPU vulnerabilities.
++<<<<<<< HEAD
 +				Equivalent to: nopti [X86]
 +					       nospectre_v2 [X86]
++=======
+ 				Equivalent to: nopti [X86,PPC]
+ 					       nospectre_v1 [PPC]
+ 					       nobp=0 [S390]
+ 					       nospectre_v2 [X86,PPC,S390]
++>>>>>>> 0336e04a6520 (s390/speculation: Support 'mitigations=' cmdline option)
  					       spectre_v2_user=off [X86]
 -					       spec_store_bypass_disable=off [X86,PPC]
 +					       spec_store_bypass_disable=off [X86]
  					       l1tf=off [X86]
  
  			auto (default)
* Unmerged path Documentation/admin-guide/kernel-parameters.txt
diff --git a/arch/s390/kernel/nospec-branch.c b/arch/s390/kernel/nospec-branch.c
index bdddaae96559..649135cbedd5 100644
--- a/arch/s390/kernel/nospec-branch.c
+++ b/arch/s390/kernel/nospec-branch.c
@@ -1,6 +1,7 @@
 // SPDX-License-Identifier: GPL-2.0
 #include <linux/module.h>
 #include <linux/device.h>
+#include <linux/cpu.h>
 #include <asm/nospec-branch.h>
 
 static int __init nobp_setup_early(char *str)
@@ -58,7 +59,7 @@ early_param("nospectre_v2", nospectre_v2_setup_early);
 
 void __init nospec_auto_detect(void)
 {
-	if (test_facility(156)) {
+	if (test_facility(156) || cpu_mitigations_off()) {
 		/*
 		 * The machine supports etokens.
 		 * Disable expolines and disable nobp.
