s390/kasan: double the stack size

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-147.el8
commit-author Vasily Gorbik <gor@linux.ibm.com>
commit 7fef92ccadd744492526d7749eebfe24dd8dcc48
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-147.el8/7fef92cc.failed

Kasan stack instrumentation pads stack variables with redzones, which
increases stack frames size significantly. Stack sizes are increased
from 16k to 32k in the code, as well as for the kernel stack overflow
detection option (CHECK_STACK).

	Reviewed-by: Martin Schwidefsky <schwidefsky@de.ibm.com>
	Signed-off-by: Vasily Gorbik <gor@linux.ibm.com>
	Signed-off-by: Martin Schwidefsky <schwidefsky@de.ibm.com>
(cherry picked from commit 7fef92ccadd744492526d7749eebfe24dd8dcc48)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/s390/include/asm/thread_info.h
diff --cc arch/s390/include/asm/thread_info.h
index 3c883c368eb0,79b40600f523..000000000000
--- a/arch/s390/include/asm/thread_info.h
+++ b/arch/s390/include/asm/thread_info.h
@@@ -11,13 -11,14 +11,20 @@@
  #include <linux/const.h>
  
  /*
 - * General size of kernel stacks
 + * Size of kernel stack for each process
   */
+ #ifdef CONFIG_KASAN
+ #define THREAD_SIZE_ORDER 3
+ #else
  #define THREAD_SIZE_ORDER 2
++<<<<<<< HEAD
 +#define ASYNC_ORDER  2
 +
++=======
+ #endif
++>>>>>>> 7fef92ccadd7 (s390/kasan: double the stack size)
  #define THREAD_SIZE (PAGE_SIZE << THREAD_SIZE_ORDER)
 +#define ASYNC_SIZE  (PAGE_SIZE << ASYNC_ORDER)
  
  #ifndef __ASSEMBLY__
  #include <asm/lowcore.h>
diff --git a/arch/s390/Makefile b/arch/s390/Makefile
index eee6703093c3..8e9287c50e74 100644
--- a/arch/s390/Makefile
+++ b/arch/s390/Makefile
@@ -27,7 +27,7 @@ KBUILD_CFLAGS_DECOMPRESSOR += $(call cc-option,-ffreestanding)
 KBUILD_CFLAGS_DECOMPRESSOR += $(if $(CONFIG_DEBUG_INFO),-g)
 KBUILD_CFLAGS_DECOMPRESSOR += $(if $(CONFIG_DEBUG_INFO_DWARF4), $(call cc-option, -gdwarf-4,))
 UTS_MACHINE	:= s390x
-STACK_SIZE	:= 16384
+STACK_SIZE	:= $(if $(CONFIG_KASAN),32768,16384)
 CHECKFLAGS	+= -D__s390__ -D__s390x__
 
 export LD_BFD
* Unmerged path arch/s390/include/asm/thread_info.h
