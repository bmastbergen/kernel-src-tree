net/mlx5e: Use the new mlx5 core notifier API

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-147.el8
commit-author Saeed Mahameed <saeedm@mellanox.com>
commit 7cffaddd39b438fab49863ea4602d6294a9d657f
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-147.el8/7cffaddd.failed

Remove the deprecated mlx5_interface->event mlx5e callback and use new
mlx5 notifier API to subscribe for mlx5 events, handle port change event
as received from FW rather than handling the mlx5 core processed port
change software version event.

	Signed-off-by: Saeed Mahameed <saeedm@mellanox.com>
(cherry picked from commit 7cffaddd39b438fab49863ea4602d6294a9d657f)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlx5/core/en_main.c
diff --cc drivers/net/ethernet/mellanox/mlx5/core/en_main.c
index 71d955c477f4,56bc41b1c31f..000000000000
--- a/drivers/net/ethernet/mellanox/mlx5/core/en_main.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/en_main.c
@@@ -323,8 -322,7 +326,12 @@@ static void mlx5e_enable_async_events(s
  
  static void mlx5e_disable_async_events(struct mlx5e_priv *priv)
  {
++<<<<<<< HEAD
 +	clear_bit(MLX5E_STATE_ASYNC_EVENTS_ENABLED, &priv->state);
 +	synchronize_irq(pci_irq_vector(priv->mdev->pdev, MLX5_EQ_VEC_ASYNC));
++=======
+ 	mlx5_notifier_unregister(priv->mdev, &priv->events_nb);
++>>>>>>> 7cffaddd39b4 (net/mlx5e: Use the new mlx5 core notifier API)
  }
  
  static inline void mlx5e_build_umr_wqe(struct mlx5e_rq *rq,
diff --git a/drivers/net/ethernet/mellanox/mlx5/core/en.h b/drivers/net/ethernet/mellanox/mlx5/core/en.h
index 3fb6dc222c97..b6d6cd86a2c2 100644
--- a/drivers/net/ethernet/mellanox/mlx5/core/en.h
+++ b/drivers/net/ethernet/mellanox/mlx5/core/en.h
@@ -628,7 +628,6 @@ struct mlx5e_channel_stats {
 } ____cacheline_aligned_in_smp;
 
 enum {
-	MLX5E_STATE_ASYNC_EVENTS_ENABLED,
 	MLX5E_STATE_OPENED,
 	MLX5E_STATE_DESTROYING,
 };
@@ -687,6 +686,8 @@ struct mlx5e_priv {
 	struct hwtstamp_config     tstamp;
 	u16                        q_counter;
 	u16                        drop_rq_q_counter;
+	struct notifier_block      events_nb;
+
 #ifdef CONFIG_MLX5_CORE_EN_DCB
 	struct mlx5e_dcbx          dcbx;
 #endif
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/en_main.c
