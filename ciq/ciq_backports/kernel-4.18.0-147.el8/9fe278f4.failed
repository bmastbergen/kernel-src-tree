scsi: qla2xxx: Move log messages before issuing command to firmware

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-147.el8
commit-author Giridhar Malavali <giridhar.malavali@cavium.com>
commit 9fe278f44b4bc06cc61e33b2af65f87d507d13d0
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-147.el8/9fe278f4.failed

There is a probability that the SRB structure might have been released by the
time the debug log message dereferences it.  This patch moved the log messages
before the command is issued to the firmware to prevent unknown behavior and
kernel crash

Fixes: 726b85487067 ("qla2xxx: Add framework for async fabric discovery")
	Cc: <stable@vger.kernel.org>
	Signed-off-by: Giridhar Malavali <giridhar.malavali@cavium.com>
	Reviewed-by: Ewan D. Milne <emilne@redhat.com>
	Signed-off-by: Himanshu Madhani <himanshu.madhani@cavium.com>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit 9fe278f44b4bc06cc61e33b2af65f87d507d13d0)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/qla2xxx/qla_init.c
diff --cc drivers/scsi/qla2xxx/qla_init.c
index 92877aa6a237,ea7951eb05ce..000000000000
--- a/drivers/scsi/qla2xxx/qla_init.c
+++ b/drivers/scsi/qla2xxx/qla_init.c
@@@ -221,13 -237,22 +221,22 @@@ qla2x00_async_login(struct scsi_qla_hos
  	qla2x00_init_timer(sp, qla2x00_get_async_timeout(vha) + 2);
  
  	sp->done = qla2x00_async_login_sp_done;
 -	if (N2N_TOPO(fcport->vha->hw) && fcport_is_bigger(fcport)) {
 -		lio->u.logio.flags |= SRB_LOGIN_PRLI_ONLY;
 -	} else {
 -		lio->u.logio.flags |= SRB_LOGIN_COND_PLOGI;
 +	lio->u.logio.flags |= SRB_LOGIN_COND_PLOGI;
  
 -		if (fcport->fc4f_nvme)
 -			lio->u.logio.flags |= SRB_LOGIN_SKIP_PRLI;
 -
 -	}
 +	if (fcport->fc4f_nvme)
 +		lio->u.logio.flags |= SRB_LOGIN_SKIP_PRLI;
  
++<<<<<<< HEAD
 +	if (data[1] & QLA_LOGIO_LOGIN_RETRIED)
 +		lio->u.logio.flags |= SRB_LOGIN_RETRIED;
++=======
+ 	ql_dbg(ql_dbg_disc, vha, 0x2072,
+ 	    "Async-login - %8phC hdl=%x, loopid=%x portid=%02x%02x%02x "
+ 		"retries=%d.\n", fcport->port_name, sp->handle, fcport->loop_id,
+ 	    fcport->d_id.b.domain, fcport->d_id.b.area, fcport->d_id.b.al_pa,
+ 	    fcport->login_retry);
+ 
++>>>>>>> 9fe278f44b4b (scsi: qla2xxx: Move log messages before issuing command to firmware)
  	rval = qla2x00_start_sp(sp);
  	if (rval != QLA_SUCCESS) {
  		fcport->flags |= FCF_LOGIN_NEEDED;
diff --git a/drivers/scsi/qla2xxx/qla_gs.c b/drivers/scsi/qla2xxx/qla_gs.c
index 756853faf7ec..3de86b711b59 100644
--- a/drivers/scsi/qla2xxx/qla_gs.c
+++ b/drivers/scsi/qla2xxx/qla_gs.c
@@ -3124,15 +3124,15 @@ int qla24xx_async_gpsc(scsi_qla_host_t *vha, fc_port_t *fcport)
 	sp->u.iocb_cmd.timeout = qla2x00_async_iocb_timeout;
 	sp->done = qla24xx_async_gpsc_sp_done;
 
-	rval = qla2x00_start_sp(sp);
-	if (rval != QLA_SUCCESS)
-		goto done_free_sp;
-
 	ql_dbg(ql_dbg_disc, vha, 0x205e,
 	    "Async-%s %8phC hdl=%x loopid=%x portid=%02x%02x%02x.\n",
 	    sp->name, fcport->port_name, sp->handle,
 	    fcport->loop_id, fcport->d_id.b.domain,
 	    fcport->d_id.b.area, fcport->d_id.b.al_pa);
+
+	rval = qla2x00_start_sp(sp);
+	if (rval != QLA_SUCCESS)
+		goto done_free_sp;
 	return rval;
 
 done_free_sp:
@@ -3421,13 +3421,14 @@ int qla24xx_async_gpnid(scsi_qla_host_t *vha, port_id_t *id)
 	sp->u.iocb_cmd.timeout = qla2x00_async_iocb_timeout;
 	sp->done = qla2x00_async_gpnid_sp_done;
 
+	ql_dbg(ql_dbg_disc, vha, 0x2067,
+	    "Async-%s hdl=%x ID %3phC.\n", sp->name,
+	    sp->handle, ct_req->req.port_id.port_id);
+
 	rval = qla2x00_start_sp(sp);
 	if (rval != QLA_SUCCESS)
 		goto done_free_sp;
 
-	ql_dbg(ql_dbg_disc, vha, 0x2067,
-	    "Async-%s hdl=%x ID %3phC.\n", sp->name,
-	    sp->handle, ct_req->req.port_id.port_id);
 	return rval;
 
 done_free_sp:
* Unmerged path drivers/scsi/qla2xxx/qla_init.c
