fanotify: return only user requested event types in event mask

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-147.el8
commit-author Matthew Bobrowski <mbobrowski@mbobrowski.org>
commit 2d10b23082a7eb8be508b3789f2e7250a88a5ddb
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-147.el8/2d10b230.failed

Modify fanotify_should_send_event() so that it now returns a mask for
an event that contains ONLY flags for the event types that have been
specifically requested by the user. Flags that may have been included
within the event mask, but have not been explicitly requested by the
user will not be present in the returned value.

As an example, given the situation where a user requests events of type
FAN_OPEN. Traditionally, the event mask returned within an event that
occurred on a filesystem object that has been marked for monitoring and is
opened, will only ever have the FAN_OPEN bit set. With the introduction of
the new flags like FAN_OPEN_EXEC, and perhaps any other future event
flags, there is a possibility of the returned event mask containing more
than a single bit set, despite having only requested the single event type.
Prior to these modifications performed to fanotify_should_send_event(), a
user would have received a bundled event mask containing flags FAN_OPEN
and FAN_OPEN_EXEC in the instance that a file was opened for execution via
execve(), for example. This means that a user would receive event types
in the returned event mask that have not been requested. This runs the
possibility of breaking existing systems and causing other unforeseen
issues.

To mitigate this possibility, fanotify_should_send_event() has been
modified to return the event mask containing ONLY event types explicitly
requested by the user. This means that we will NOT report events that the
user did no set a mask for, and we will NOT report events that the user
has set an ignore mask for.

The function name fanotify_should_send_event() has also been updated so
that it's more relevant to what it has been designed to do.

	Signed-off-by: Matthew Bobrowski <mbobrowski@mbobrowski.org>
	Reviewed-by: Amir Goldstein <amir73il@gmail.com>
	Signed-off-by: Jan Kara <jack@suse.cz>
(cherry picked from commit 2d10b23082a7eb8be508b3789f2e7250a88a5ddb)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/notify/fanotify/fanotify.c
diff --cc fs/notify/fanotify/fanotify.c
index cdce46db0d71,f4f8359bc597..000000000000
--- a/fs/notify/fanotify/fanotify.c
+++ b/fs/notify/fanotify/fanotify.c
@@@ -128,13 -135,10 +134,18 @@@ static u32 fanotify_group_event_mask(st
  
  	if (d_is_dir(path->dentry) &&
  	    !(marks_mask & FS_ISDIR & ~marks_ignored_mask))
- 		return false;
+ 		return 0;
  
++<<<<<<< HEAD
 +	if (event_mask & FAN_ALL_OUTGOING_EVENTS & marks_mask &
 +				 ~marks_ignored_mask)
 +		return true;
 +
 +	return false;
++=======
+ 	return event_mask & FANOTIFY_OUTGOING_EVENTS & marks_mask &
+ 		~marks_ignored_mask;
++>>>>>>> 2d10b23082a7 (fanotify: return only user requested event types in event mask)
  }
  
  struct fanotify_event_info *fanotify_alloc_event(struct fsnotify_group *group,
@@@ -199,7 -211,10 +210,14 @@@ static int fanotify_handle_event(struc
  	BUILD_BUG_ON(FAN_ACCESS_PERM != FS_ACCESS_PERM);
  	BUILD_BUG_ON(FAN_ONDIR != FS_ISDIR);
  
++<<<<<<< HEAD
 +	if (!fanotify_should_send_event(iter_info, mask, data, data_type))
++=======
+ 	BUILD_BUG_ON(HWEIGHT32(ALL_FANOTIFY_EVENT_BITS) != 10);
+ 
+ 	mask = fanotify_group_event_mask(iter_info, mask, data, data_type);
+ 	if (!mask)
++>>>>>>> 2d10b23082a7 (fanotify: return only user requested event types in event mask)
  		return 0;
  
  	pr_debug("%s: group=%p inode=%p mask=%x\n", __func__, group, inode,
* Unmerged path fs/notify/fanotify/fanotify.c
