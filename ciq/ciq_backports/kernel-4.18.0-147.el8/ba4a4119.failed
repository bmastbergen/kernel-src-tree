RDMA/mlx5: Add support for flow tag to raw create flow

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-147.el8
commit-author Mark Bloch <markb@mellanox.com>
commit ba4a41198324be2e6fbb06c270fdc8500c0e38de
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-147.el8/ba4a4119.failed

A user can provide a hint which will be attached to the packet and written
to the CQE on receive. This can be used as a way to offload operations
into the HW, for example parsing a packet which is a tunneled packet, and
if so, pass 0x1 as the hint. The software can use that hint to decapsulate
the packet and parse only the inner headers thus saving CPU cycles.

	Signed-off-by: Mark Bloch <markb@mellanox.com>
	Reviewed-by: Yishai Hadas <yishaih@mellanox.com>
	Signed-off-by: Leon Romanovsky <leonro@mellanox.com>
	Signed-off-by: Jason Gunthorpe <jgg@mellanox.com>
(cherry picked from commit ba4a41198324be2e6fbb06c270fdc8500c0e38de)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/hw/mlx5/flow.c
#	include/uapi/rdma/mlx5_user_ioctl_cmds.h
diff --cc include/uapi/rdma/mlx5_user_ioctl_cmds.h
index 8d285f4555cd,408e220034de..000000000000
--- a/include/uapi/rdma/mlx5_user_ioctl_cmds.h
+++ b/include/uapi/rdma/mlx5_user_ioctl_cmds.h
@@@ -67,11 -75,116 +67,83 @@@ enum mlx5_ib_devx_obj_destroy_attrs 
  enum mlx5_ib_devx_obj_methods {
  	MLX5_IB_METHOD_DEVX_OBJ_CREATE = (1U << UVERBS_ID_NS_SHIFT),
  	MLX5_IB_METHOD_DEVX_OBJ_DESTROY,
 -	MLX5_IB_METHOD_DEVX_OBJ_MODIFY,
 -	MLX5_IB_METHOD_DEVX_OBJ_QUERY,
 -};
 -
 -enum mlx5_ib_devx_umem_reg_attrs {
 -	MLX5_IB_ATTR_DEVX_UMEM_REG_HANDLE = (1U << UVERBS_ID_NS_SHIFT),
 -	MLX5_IB_ATTR_DEVX_UMEM_REG_ADDR,
 -	MLX5_IB_ATTR_DEVX_UMEM_REG_LEN,
 -	MLX5_IB_ATTR_DEVX_UMEM_REG_ACCESS,
 -	MLX5_IB_ATTR_DEVX_UMEM_REG_OUT_ID,
 -};
 -
 -enum mlx5_ib_devx_umem_dereg_attrs {
 -	MLX5_IB_ATTR_DEVX_UMEM_DEREG_HANDLE = (1U << UVERBS_ID_NS_SHIFT),
 -};
 -
 -enum mlx5_ib_devx_umem_methods {
 -	MLX5_IB_METHOD_DEVX_UMEM_REG = (1U << UVERBS_ID_NS_SHIFT),
 -	MLX5_IB_METHOD_DEVX_UMEM_DEREG,
  };
  
 -enum mlx5_ib_objects {
 +enum mlx5_ib_devx_objects {
  	MLX5_IB_OBJECT_DEVX = (1U << UVERBS_ID_NS_SHIFT),
  	MLX5_IB_OBJECT_DEVX_OBJ,
++<<<<<<< HEAD
++=======
+ 	MLX5_IB_OBJECT_DEVX_UMEM,
+ 	MLX5_IB_OBJECT_FLOW_MATCHER,
+ };
+ 
+ enum mlx5_ib_flow_matcher_create_attrs {
+ 	MLX5_IB_ATTR_FLOW_MATCHER_CREATE_HANDLE = (1U << UVERBS_ID_NS_SHIFT),
+ 	MLX5_IB_ATTR_FLOW_MATCHER_MATCH_MASK,
+ 	MLX5_IB_ATTR_FLOW_MATCHER_FLOW_TYPE,
+ 	MLX5_IB_ATTR_FLOW_MATCHER_MATCH_CRITERIA,
+ 	MLX5_IB_ATTR_FLOW_MATCHER_FLOW_FLAGS,
+ };
+ 
+ enum mlx5_ib_flow_matcher_destroy_attrs {
+ 	MLX5_IB_ATTR_FLOW_MATCHER_DESTROY_HANDLE = (1U << UVERBS_ID_NS_SHIFT),
+ };
+ 
+ enum mlx5_ib_flow_matcher_methods {
+ 	MLX5_IB_METHOD_FLOW_MATCHER_CREATE = (1U << UVERBS_ID_NS_SHIFT),
+ 	MLX5_IB_METHOD_FLOW_MATCHER_DESTROY,
+ };
+ 
+ #define MLX5_IB_DW_MATCH_PARAM 0x80
+ 
+ struct mlx5_ib_match_params {
+ 	__u32	match_params[MLX5_IB_DW_MATCH_PARAM];
+ };
+ 
+ enum mlx5_ib_flow_type {
+ 	MLX5_IB_FLOW_TYPE_NORMAL,
+ 	MLX5_IB_FLOW_TYPE_SNIFFER,
+ 	MLX5_IB_FLOW_TYPE_ALL_DEFAULT,
+ 	MLX5_IB_FLOW_TYPE_MC_DEFAULT,
+ };
+ 
+ enum mlx5_ib_create_flow_attrs {
+ 	MLX5_IB_ATTR_CREATE_FLOW_HANDLE = (1U << UVERBS_ID_NS_SHIFT),
+ 	MLX5_IB_ATTR_CREATE_FLOW_MATCH_VALUE,
+ 	MLX5_IB_ATTR_CREATE_FLOW_DEST_QP,
+ 	MLX5_IB_ATTR_CREATE_FLOW_DEST_DEVX,
+ 	MLX5_IB_ATTR_CREATE_FLOW_MATCHER,
+ 	MLX5_IB_ATTR_CREATE_FLOW_ARR_FLOW_ACTIONS,
+ 	MLX5_IB_ATTR_CREATE_FLOW_TAG,
+ };
+ 
+ enum mlx5_ib_destoy_flow_attrs {
+ 	MLX5_IB_ATTR_DESTROY_FLOW_HANDLE = (1U << UVERBS_ID_NS_SHIFT),
+ };
+ 
+ enum mlx5_ib_flow_methods {
+ 	MLX5_IB_METHOD_CREATE_FLOW = (1U << UVERBS_ID_NS_SHIFT),
+ 	MLX5_IB_METHOD_DESTROY_FLOW,
+ };
+ 
+ enum mlx5_ib_flow_action_methods {
+ 	MLX5_IB_METHOD_FLOW_ACTION_CREATE_MODIFY_HEADER = (1U << UVERBS_ID_NS_SHIFT),
+ 	MLX5_IB_METHOD_FLOW_ACTION_CREATE_PACKET_REFORMAT,
+ };
+ 
+ enum mlx5_ib_create_flow_action_create_modify_header_attrs {
+ 	MLX5_IB_ATTR_CREATE_MODIFY_HEADER_HANDLE = (1U << UVERBS_ID_NS_SHIFT),
+ 	MLX5_IB_ATTR_CREATE_MODIFY_HEADER_ACTIONS_PRM,
+ 	MLX5_IB_ATTR_CREATE_MODIFY_HEADER_FT_TYPE,
+ };
+ 
+ enum mlx5_ib_create_flow_action_create_packet_reformat_attrs {
+ 	MLX5_IB_ATTR_CREATE_PACKET_REFORMAT_HANDLE = (1U << UVERBS_ID_NS_SHIFT),
+ 	MLX5_IB_ATTR_CREATE_PACKET_REFORMAT_TYPE,
+ 	MLX5_IB_ATTR_CREATE_PACKET_REFORMAT_FT_TYPE,
+ 	MLX5_IB_ATTR_CREATE_PACKET_REFORMAT_DATA_BUF,
++>>>>>>> ba4a41198324 (RDMA/mlx5: Add support for flow tag to raw create flow)
  };
  
  #endif
* Unmerged path drivers/infiniband/hw/mlx5/flow.c
* Unmerged path drivers/infiniband/hw/mlx5/flow.c
* Unmerged path include/uapi/rdma/mlx5_user_ioctl_cmds.h
