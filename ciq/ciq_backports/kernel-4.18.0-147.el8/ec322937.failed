scsi: qla2xxx: Fix LUN discovery if loop id is not assigned yet by firmware

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-147.el8
commit-author Himanshu Madhani <hmadhani@marvell.com>
commit ec322937a7f152d68755dc8316523bf6f831b48f
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-147.el8/ec322937.failed

This patch fixes LUN discovery when loop ID is not yet assigned by the
firmware during driver load/sg_reset operations. Driver will now search for
new loop id before retrying login.

Fixes: 48acad099074 ("scsi: qla2xxx: Fix N2N link re-connect")
	Cc: stable@vger.kernel.org #4.19
	Signed-off-by: Himanshu Madhani <hmadhani@marvell.com>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit ec322937a7f152d68755dc8316523bf6f831b48f)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/qla2xxx/qla_init.c
diff --cc drivers/scsi/qla2xxx/qla_init.c
index efd0bc93edfd,c6c96533eef2..000000000000
--- a/drivers/scsi/qla2xxx/qla_init.c
+++ b/drivers/scsi/qla2xxx/qla_init.c
@@@ -575,37 -628,76 +575,66 @@@ static void qla24xx_handle_gnl_done_eve
  			fcport->login_pause = 1;
  		}
  
 -		switch (vha->hw->current_topology) {
 +		if  (fcport->fc4f_nvme)
 +			current_login_state = e->current_login_state >> 4;
 +		else
 +			current_login_state = e->current_login_state & 0xf;
 +
 +		switch (current_login_state) {
 +		case DSC_LS_PRLI_COMP:
 +			ql_dbg(ql_dbg_disc, vha, 0x20e4,
 +			    "%s %d %8phC post gpdb\n",
 +			    __func__, __LINE__, fcport->port_name);
 +
 +			if ((e->prli_svc_param_word_3[0] & BIT_4) == 0)
 +				fcport->port_type = FCT_INITIATOR;
 +			else
 +				fcport->port_type = FCT_TARGET;
 +
 +			data[0] = data[1] = 0;
 +			qla2x00_post_async_adisc_work(vha, fcport, data);
 +			break;
 +		case DSC_LS_PORT_UNAVAIL:
  		default:
++<<<<<<< HEAD
 +			if (fcport->loop_id == FC_NO_LOOP_ID) {
 +				qla2x00_find_new_loop_id(vha, fcport);
 +				fcport->fw_login_state = DSC_LS_PORT_UNAVAIL;
++=======
+ 			switch (current_login_state) {
+ 			case DSC_LS_PRLI_COMP:
+ 				ql_dbg(ql_dbg_disc + ql_dbg_verbose,
+ 				    vha, 0x20e4, "%s %d %8phC post gpdb\n",
+ 				    __func__, __LINE__, fcport->port_name);
+ 
+ 				if ((e->prli_svc_param_word_3[0] & BIT_4) == 0)
+ 					fcport->port_type = FCT_INITIATOR;
+ 				else
+ 					fcport->port_type = FCT_TARGET;
+ 				data[0] = data[1] = 0;
+ 				qla2x00_post_async_adisc_work(vha, fcport,
+ 				    data);
+ 				break;
+ 			case DSC_LS_PORT_UNAVAIL:
+ 			default:
+ 				if (fcport->loop_id == FC_NO_LOOP_ID) {
+ 					qla2x00_find_new_loop_id(vha, fcport);
+ 					fcport->fw_login_state =
+ 					    DSC_LS_PORT_UNAVAIL;
+ 				}
+ 				ql_dbg(ql_dbg_disc, vha, 0x20e5,
+ 				    "%s %d %8phC\n", __func__, __LINE__,
+ 				    fcport->port_name);
+ 				qla24xx_fcport_handle_login(vha, fcport);
+ 				break;
++>>>>>>> ec322937a7f1 (scsi: qla2xxx: Fix LUN discovery if loop id is not assigned yet by firmware)
  			}
 +			ql_dbg(ql_dbg_disc, vha, 0x20e5,
 +			    "%s %d %8phC\n",
 +			    __func__, __LINE__, fcport->port_name);
 +			qla24xx_fcport_handle_login(vha, fcport);
  			break;
 -		case ISP_CFG_N:
 -			fcport->fw_login_state = current_login_state;
 -			fcport->d_id = id;
 -			switch (current_login_state) {
 -			case DSC_LS_PRLI_COMP:
 -				if ((e->prli_svc_param_word_3[0] & BIT_4) == 0)
 -					fcport->port_type = FCT_INITIATOR;
 -				else
 -					fcport->port_type = FCT_TARGET;
 -
 -				data[0] = data[1] = 0;
 -				qla2x00_post_async_adisc_work(vha, fcport,
 -				    data);
 -				break;
 -			case DSC_LS_PLOGI_COMP:
 -				if (fcport_is_bigger(fcport)) {
 -					/* local adapter is smaller */
 -					if (fcport->loop_id != FC_NO_LOOP_ID)
 -						qla2x00_clear_loop_id(fcport);
 -
 -					fcport->loop_id = loop_id;
 -					qla24xx_fcport_handle_login(vha,
 -					    fcport);
 -					break;
 -				}
 -				/* fall through */
 -			default:
 -				if (fcport_is_smaller(fcport)) {
 -					/* local adapter is bigger */
 -					if (fcport->loop_id != FC_NO_LOOP_ID)
 -						qla2x00_clear_loop_id(fcport);
 -
 -					fcport->loop_id = loop_id;
 -					qla24xx_fcport_handle_login(vha,
 -					    fcport);
 -				}
 -				break;
 -			}
 -			break;
 -		} /* switch (ha->current_topology) */
 +		}
  	}
  
  	if (!found) {
* Unmerged path drivers/scsi/qla2xxx/qla_init.c
