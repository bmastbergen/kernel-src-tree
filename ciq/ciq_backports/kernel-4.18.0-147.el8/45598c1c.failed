vxlan: Mark user-added FDB entries

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-147.el8
commit-author Petr Machata <petrm@mellanox.com>
commit 45598c1cee69b9c7ce111fa634226ab335fafabe
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-147.el8/45598c1c.failed

The VXLAN driver needs to differentiate between FDB entries learned by
the VXLAN driver, and those added by the user. The latter ones shouldn't
be taken over by external learning events. This is in accordance with
bridge behavior.

Therefore, extend the flags bitfield to 16 bits and add a new private
NTF flag to mark the user-added entries.

This seems preferable to adding a dedicated boolean, because passing the
flag, unlike passing e.g. a true, makes it clear what the meaning of the
bit is.

	Signed-off-by: Petr Machata <petrm@mellanox.com>
	Signed-off-by: Ido Schimmel <idosch@mellanox.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 45598c1cee69b9c7ce111fa634226ab335fafabe)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/vxlan.c
diff --cc drivers/net/vxlan.c
index 3e15026af84d,9171c1f42fe9..000000000000
--- a/drivers/net/vxlan.c
+++ b/drivers/net/vxlan.c
@@@ -756,9 -764,10 +760,14 @@@ static int vxlan_fdb_update(struct vxla
  			    const u8 *mac, union vxlan_addr *ip,
  			    __u16 state, __u16 flags,
  			    __be16 port, __be32 src_vni, __be32 vni,
++<<<<<<< HEAD
 +			    __u32 ifindex, __u8 ndm_flags)
++=======
+ 			    __u32 ifindex, __u16 ndm_flags,
+ 			    bool swdev_notify)
++>>>>>>> 45598c1cee69 (vxlan: Mark user-added FDB entries)
  {
- 	__u8 fdb_flags = (ndm_flags & ~NTF_USE);
+ 	__u16 fdb_flags = (ndm_flags & ~NTF_USE);
  	struct vxlan_rdst *rd = NULL;
  	struct vxlan_fdb *f;
  	int notify = 0;
@@@ -968,7 -978,9 +977,13 @@@ static int vxlan_fdb_add(struct ndmsg *
  
  	spin_lock_bh(&vxlan->hash_lock);
  	err = vxlan_fdb_update(vxlan, addr, &ip, ndm->ndm_state, flags,
++<<<<<<< HEAD
 +			       port, src_vni, vni, ifindex, ndm->ndm_flags);
++=======
+ 			       port, src_vni, vni, ifindex,
+ 			       ndm->ndm_flags | NTF_VXLAN_ADDED_BY_USER,
+ 			       true);
++>>>>>>> 45598c1cee69 (vxlan: Mark user-added FDB entries)
  	spin_unlock_bh(&vxlan->hash_lock);
  
  	return err;
* Unmerged path drivers/net/vxlan.c
diff --git a/include/net/vxlan.h b/include/net/vxlan.h
index 03431c148e16..e9543e87d07b 100644
--- a/include/net/vxlan.h
+++ b/include/net/vxlan.h
@@ -420,6 +420,7 @@ struct switchdev_notifier_vxlan_fdb_info {
 	u8 eth_addr[ETH_ALEN];
 	__be32 vni;
 	bool offloaded;
+	bool added_by_user;
 };
 
 #if IS_ENABLED(CONFIG_VXLAN)
