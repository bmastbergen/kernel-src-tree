iwlwifi: mvm: disable TX-AMSDU on older NICs

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-147.el8
commit-author Johannes Berg <johannes.berg@intel.com>
commit cfb21b11b891b08b79be07be57c40a85bb926668
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-147.el8/cfb21b11.failed

On older NICs, we occasionally see issues with A-MSDU support,
where the commands in the FIFO get confused and then we see an
assert EDC because the next command in the FIFO isn't TX.

We've tried to isolate this issue and understand where it comes
from, but haven't found any errors in building the A-MSDU in
software.

At least for now, disable A-MSDU support on older hardware so
that users can use it again without fearing the assert.

This fixes https://bugzilla.kernel.org/show_bug.cgi?id=203315.

	Signed-off-by: Johannes Berg <johannes.berg@intel.com>
	Signed-off-by: Luca Coelho <luciano.coelho@intel.com>
	Signed-off-by: Johannes Berg <johannes.berg@intel.com>
(cherry picked from commit cfb21b11b891b08b79be07be57c40a85bb926668)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/wireless/intel/iwlwifi/mvm/mac80211.c
diff --cc drivers/net/wireless/intel/iwlwifi/mvm/mac80211.c
index 06c5bda3d481,99fa440bc639..000000000000
--- a/drivers/net/wireless/intel/iwlwifi/mvm/mac80211.c
+++ b/drivers/net/wireless/intel/iwlwifi/mvm/mac80211.c
@@@ -423,6 -471,23 +423,26 @@@ int iwl_mvm_mac_setup_register(struct i
  	ieee80211_hw_set(hw, SUPPORTS_AMSDU_IN_AMPDU);
  	ieee80211_hw_set(hw, NEEDS_UNIQUE_STA_ADDR);
  	ieee80211_hw_set(hw, DEAUTH_NEED_MGD_TX_PREP);
++<<<<<<< HEAD
++=======
+ 	ieee80211_hw_set(hw, SUPPORTS_VHT_EXT_NSS_BW);
+ 	ieee80211_hw_set(hw, BUFF_MMPDU_TXQ);
+ 	ieee80211_hw_set(hw, STA_MMPDU_TXQ);
+ 	/*
+ 	 * On older devices, enabling TX A-MSDU occasionally leads to
+ 	 * something getting messed up, the command read from the FIFO
+ 	 * gets out of sync and isn't a TX command, so that we have an
+ 	 * assert EDC.
+ 	 *
+ 	 * It's not clear where the bug is, but since we didn't used to
+ 	 * support A-MSDU until moving the mac80211 iTXQs, just leave it
+ 	 * for older devices. We also don't see this issue on any newer
+ 	 * devices.
+ 	 */
+ 	if (mvm->cfg->device_family >= IWL_DEVICE_FAMILY_9000)
+ 		ieee80211_hw_set(hw, TX_AMSDU);
+ 	ieee80211_hw_set(hw, TX_FRAG_LIST);
++>>>>>>> cfb21b11b891 (iwlwifi: mvm: disable TX-AMSDU on older NICs)
  
  	if (iwl_mvm_has_tlc_offload(mvm)) {
  		ieee80211_hw_set(hw, TX_AMPDU_SETUP_IN_HW);
* Unmerged path drivers/net/wireless/intel/iwlwifi/mvm/mac80211.c
