sctp: set stream ext to NULL after freeing it in sctp_stream_outq_migrate

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-147.el8
commit-author Xin Long <lucien.xin@gmail.com>
commit af98c5a78517c04adb5fd68bb64b1ad6fe3d473f
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-147.el8/af98c5a7.failed

In sctp_stream_init(), after sctp_stream_outq_migrate() freed the
surplus streams' ext, but sctp_stream_alloc_out() returns -ENOMEM,
stream->outcnt will not be set to 'outcnt'.

With the bigger value on stream->outcnt, when closing the assoc and
freeing its streams, the ext of those surplus streams will be freed
again since those stream exts were not set to NULL after freeing in
sctp_stream_outq_migrate(). Then the invalid-free issue reported by
syzbot would be triggered.

We fix it by simply setting them to NULL after freeing.

Fixes: 5bbbbe32a431 ("sctp: introduce stream scheduler foundations")
	Reported-by: syzbot+58e480e7b28f2d890bfd@syzkaller.appspotmail.com
	Signed-off-by: Xin Long <lucien.xin@gmail.com>
	Acked-by: Neil Horman <nhorman@tuxdriver.com>
	Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit af98c5a78517c04adb5fd68bb64b1ad6fe3d473f)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/sctp/stream.c
diff --cc net/sctp/stream.c
index c3c419b3f005,2936ed17bf9e..000000000000
--- a/net/sctp/stream.c
+++ b/net/sctp/stream.c
@@@ -84,8 -144,10 +84,15 @@@ static void sctp_stream_outq_migrate(st
  		}
  	}
  
++<<<<<<< HEAD
 +	for (i = outcnt; i < stream->outcnt; i++)
 +		kfree(stream->out[i].ext);
++=======
+ 	for (i = outcnt; i < stream->outcnt; i++) {
+ 		kfree(SCTP_SO(stream, i)->ext);
+ 		SCTP_SO(stream, i)->ext = NULL;
+ 	}
++>>>>>>> af98c5a78517 (sctp: set stream ext to NULL after freeing it in sctp_stream_outq_migrate)
  }
  
  static int sctp_stream_alloc_out(struct sctp_stream *stream, __u16 outcnt,
* Unmerged path net/sctp/stream.c
