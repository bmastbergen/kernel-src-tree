tools/power turbostat: consolidate duplicate model numbers

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-147.el8
commit-author Len Brown <len.brown@intel.com>
commit f5a4c76ad7de96d47baef3d8810a88b10d60ec82
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-147.el8/f5a4c76a.failed

Often a new processor gets a new model number, but from a turbostat
point of view, it is the same as a previous model.  Support duplicates
with 1-line updates, rather than error-prone scattering of model #'s.

	Signed-off-by: Len Brown <len.brown@intel.com>
(cherry picked from commit f5a4c76ad7de96d47baef3d8810a88b10d60ec82)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/power/x86/turbostat/turbostat.c
diff --cc tools/power/x86/turbostat/turbostat.c
index 83964f796edb,9327c0ddc3a5..000000000000
--- a/tools/power/x86/turbostat/turbostat.c
+++ b/tools/power/x86/turbostat/turbostat.c
@@@ -4166,15 -4155,12 +4131,12 @@@ int has_hsw_msrs(unsigned int family, u
  		return 0;
  
  	switch (model) {
- 	case INTEL_FAM6_HASWELL_ULT:	/* HSW */
+ 	case INTEL_FAM6_HASWELL_CORE:
  	case INTEL_FAM6_BROADWELL_CORE:	/* BDW */
  	case INTEL_FAM6_SKYLAKE_MOBILE:	/* SKL */
- 	case INTEL_FAM6_SKYLAKE_DESKTOP:	/* SKL */
- 	case INTEL_FAM6_KABYLAKE_MOBILE:	/* KBL */
- 	case INTEL_FAM6_KABYLAKE_DESKTOP:	/* KBL */
  	case INTEL_FAM6_CANNONLAKE_MOBILE:	/* CNL */
  	case INTEL_FAM6_ATOM_GOLDMONT:	/* BXT */
 -	case INTEL_FAM6_ATOM_GOLDMONT_PLUS:
 +	case INTEL_FAM6_ATOM_GEMINI_LAKE:
  		return 1;
  	}
  	return 0;
@@@ -4436,10 -4418,46 +4394,46 @@@ void decode_c6_demotion_policy_msr(void
  			base_cpu, msr, msr & (1 << 0) ? "EN" : "DIS");
  }
  
+ /*
+  * When models are the same, for the purpose of turbostat, reuse
+  */
+ unsigned int intel_model_duplicates(unsigned int model)
+ {
+ 
+ 	switch(model) {
+ 	case INTEL_FAM6_NEHALEM_EP:	/* Core i7, Xeon 5500 series - Bloomfield, Gainstown NHM-EP */
+ 	case INTEL_FAM6_NEHALEM:	/* Core i7 and i5 Processor - Clarksfield, Lynnfield, Jasper Forest */
+ 	case 0x1F:	/* Core i7 and i5 Processor - Nehalem */
+ 	case INTEL_FAM6_WESTMERE:	/* Westmere Client - Clarkdale, Arrandale */
+ 	case INTEL_FAM6_WESTMERE_EP:	/* Westmere EP - Gulftown */
+ 		return INTEL_FAM6_NEHALEM;
+ 
+ 	case INTEL_FAM6_NEHALEM_EX:	/* Nehalem-EX Xeon - Beckton */
+ 	case INTEL_FAM6_WESTMERE_EX:	/* Westmere-EX Xeon - Eagleton */
+ 		return INTEL_FAM6_NEHALEM_EX;
+ 
+ 	case INTEL_FAM6_XEON_PHI_KNM:
+ 		return INTEL_FAM6_XEON_PHI_KNL;
+ 
+ 	case INTEL_FAM6_HASWELL_ULT:
+ 		return INTEL_FAM6_HASWELL_CORE;
+ 
+ 	case INTEL_FAM6_BROADWELL_X:
+ 	case INTEL_FAM6_BROADWELL_XEON_D:	/* BDX-DE */
+ 		return INTEL_FAM6_BROADWELL_X;
+ 
+ 	case INTEL_FAM6_SKYLAKE_MOBILE:
+ 	case INTEL_FAM6_SKYLAKE_DESKTOP:
+ 	case INTEL_FAM6_KABYLAKE_MOBILE:
+ 	case INTEL_FAM6_KABYLAKE_DESKTOP:
+ 		return INTEL_FAM6_SKYLAKE_MOBILE;
+ 	}
+ 	return model;
+ }
  void process_cpuid()
  {
 -	unsigned int eax, ebx, ecx, edx;
 -	unsigned int fms, family, model, stepping, ecx_flags, edx_flags;
 +	unsigned int eax, ebx, ecx, edx, max_level, max_extended_level;
 +	unsigned int fms, family, model, stepping;
  	unsigned int has_turbo;
  
  	eax = ebx = ecx = edx = 0;
@@@ -4489,6 -4492,27 +4483,30 @@@
  	ebx = ecx = edx = 0;
  	__cpuid(0x80000000, max_extended_level, ebx, ecx, edx);
  
++<<<<<<< HEAD
++=======
+ 	if (!quiet) {
+ 		fprintf(outf, "0x%x CPUID levels; 0x%x xlevels; family:model:stepping 0x%x:%x:%x (%d:%d:%d)\n",
+ 			max_level, max_extended_level, family, model, stepping, family, model, stepping);
+ 		fprintf(outf, "CPUID(1): %s %s %s %s %s %s %s %s %s %s\n",
+ 			ecx_flags & (1 << 0) ? "SSE3" : "-",
+ 			ecx_flags & (1 << 3) ? "MONITOR" : "-",
+ 			ecx_flags & (1 << 6) ? "SMX" : "-",
+ 			ecx_flags & (1 << 7) ? "EIST" : "-",
+ 			ecx_flags & (1 << 8) ? "TM2" : "-",
+ 			edx_flags & (1 << 4) ? "TSC" : "-",
+ 			edx_flags & (1 << 5) ? "MSR" : "-",
+ 			edx_flags & (1 << 22) ? "ACPI-TM" : "-",
+ 			edx_flags & (1 << 28) ? "HT" : "-",
+ 			edx_flags & (1 << 29) ? "TM" : "-");
+ 	}
+ 	if (genuine_intel)
+ 		model = intel_model_duplicates(model);
+ 
+ 	if (!(edx_flags & (1 << 5)))
+ 		errx(1, "CPUID: no MSR");
+ 
++>>>>>>> f5a4c76ad7de (tools/power turbostat: consolidate duplicate model numbers)
  	if (max_extended_level >= 0x80000007) {
  
  		/*
@@@ -4576,12 -4600,9 +4594,9 @@@
  			if (crystal_hz == 0)
  				switch(model) {
  				case INTEL_FAM6_SKYLAKE_MOBILE:	/* SKL */
- 				case INTEL_FAM6_SKYLAKE_DESKTOP:	/* SKL */
- 				case INTEL_FAM6_KABYLAKE_MOBILE:	/* KBL */
- 				case INTEL_FAM6_KABYLAKE_DESKTOP:	/* KBL */
  					crystal_hz = 24000000;	/* 24.0 MHz */
  					break;
 -				case INTEL_FAM6_ATOM_GOLDMONT_X:	/* DNV */
 +				case INTEL_FAM6_ATOM_DENVERTON:	/* DNV */
  					crystal_hz = 25000000;	/* 25.0 MHz */
  					break;
  				case INTEL_FAM6_ATOM_GOLDMONT:	/* BXT */
* Unmerged path tools/power/x86/turbostat/turbostat.c
