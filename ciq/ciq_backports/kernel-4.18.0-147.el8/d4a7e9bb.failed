ipv6: Take rcu_read_lock in __inet6_bind for mapped addresses

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-147.el8
commit-author David Ahern <dsahern@gmail.com>
commit d4a7e9bb74b5aaf07b89f6531c080b1130bdf019
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-147.el8/d4a7e9bb.failed

I realized the last patch calls dev_get_by_index_rcu in a branch not
holding the rcu lock. Add the calls to rcu_read_lock and rcu_read_unlock.

Fixes: ec90ad334986 ("ipv6: Consider sk_bound_dev_if when binding a socket to a v4 mapped address")
	Signed-off-by: David Ahern <dsahern@gmail.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit d4a7e9bb74b5aaf07b89f6531c080b1130bdf019)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/ipv6/af_inet6.c
diff --cc net/ipv6/af_inet6.c
index 86a951f826be,d99753b5e39b..000000000000
--- a/net/ipv6/af_inet6.c
+++ b/net/ipv6/af_inet6.c
@@@ -319,11 -321,21 +319,29 @@@ static int __inet6_bind(struct sock *sk
  			goto out;
  		}
  
++<<<<<<< HEAD
 +		/* Reproduce AF_INET checks to make the bindings consistent */
 +		v4addr = addr->sin6_addr.s6_addr32[3];
 +		chk_addr_ret = inet_addr_type(net, v4addr);
 +		if (!net->ipv4.sysctl_ip_nonlocal_bind &&
 +		    !(inet->freebind || inet->transparent) &&
++=======
+ 		rcu_read_lock();
+ 		if (sk->sk_bound_dev_if) {
+ 			dev = dev_get_by_index_rcu(net, sk->sk_bound_dev_if);
+ 			if (!dev) {
+ 				err = -ENODEV;
+ 				goto out_unlock;
+ 			}
+ 		}
+ 
+ 		/* Reproduce AF_INET checks to make the bindings consistent */
+ 		v4addr = addr->sin6_addr.s6_addr32[3];
+ 		chk_addr_ret = inet_addr_type_dev_table(net, dev, v4addr);
+ 		rcu_read_unlock();
+ 
+ 		if (!inet_can_nonlocal_bind(net, inet) &&
++>>>>>>> d4a7e9bb74b5 (ipv6: Take rcu_read_lock in __inet6_bind for mapped addresses)
  		    v4addr != htonl(INADDR_ANY) &&
  		    chk_addr_ret != RTN_LOCAL &&
  		    chk_addr_ret != RTN_MULTICAST &&
* Unmerged path net/ipv6/af_inet6.c
