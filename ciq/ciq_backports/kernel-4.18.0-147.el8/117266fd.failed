iommu/vt-d: Check identity map for hot-added devices

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-147.el8
commit-author Lu Baolu <baolu.lu@linux.intel.com>
commit 117266fd59ddf46e98e36df09326d861738c6180
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-147.el8/117266fd.failed

The Intel IOMMU driver will put devices into a static identity
mapped domain during boot if the kernel parameter "iommu=pt" is
used. That means the IOMMU hardware will translate a DMA address
into the same memory address.

Unfortunately, hot-added devices are not subject to this. That
results in some devices not working properly after hot added. A
quick way to reproduce this issue is to boot a system with

    iommu=pt

and, remove then readd the pci device with

    echo 1 > /sys/bus/pci/devices/[pci_source_id]/remove
    echo 1 > /sys/bus/pci/rescan

You will find the identity mapped domain was replaced with a
normal domain.

	Cc: Ashok Raj <ashok.raj@intel.com>
	Cc: Jacob Pan <jacob.jun.pan@linux.intel.com>
	Cc: Fenghua Yu <fenghua.yu@intel.com>
	Cc: stable@vger.kernel.org
	Reported-by: Jis Ben <jisben@google.com>
	Signed-off-by: Lu Baolu <baolu.lu@linux.intel.com>
	Tested-by: James Dong <xmdong@google.com>
Fixes: 99dcadede42f ('intel-iommu: Support PCIe hot-plug')
	Signed-off-by: Joerg Roedel <jroedel@suse.de>
(cherry picked from commit 117266fd59ddf46e98e36df09326d861738c6180)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/iommu/intel-iommu.c
diff --cc drivers/iommu/intel-iommu.c
index 9b60c7914fb3,c30b73d41bf2..000000000000
--- a/drivers/iommu/intel-iommu.c
+++ b/drivers/iommu/intel-iommu.c
@@@ -4535,16 -4567,19 +4535,29 @@@ static int device_notifier(struct notif
  	if (iommu_dummy(dev))
  		return 0;
  
- 	if (action != BUS_NOTIFY_REMOVED_DEVICE)
- 		return 0;
+ 	if (action == BUS_NOTIFY_REMOVED_DEVICE) {
+ 		domain = find_domain(dev);
+ 		if (!domain)
+ 			return 0;
  
++<<<<<<< HEAD
 +	domain = find_domain(dev);
 +	if (!domain)
 +		return 0;
 +
 +	dmar_remove_one_dev_info(domain, dev);
 +	if (!domain_type_is_vm_or_si(domain) && list_empty(&domain->devices))
 +		domain_exit(domain);
++=======
+ 		dmar_remove_one_dev_info(dev);
+ 		if (!domain_type_is_vm_or_si(domain) &&
+ 		    list_empty(&domain->devices))
+ 			domain_exit(domain);
+ 	} else if (action == BUS_NOTIFY_ADD_DEVICE) {
+ 		if (iommu_should_identity_map(dev, 1))
+ 			domain_add_dev_info(si_domain, dev);
+ 	}
++>>>>>>> 117266fd59dd (iommu/vt-d: Check identity map for hot-added devices)
  
  	return 0;
  }
* Unmerged path drivers/iommu/intel-iommu.c
