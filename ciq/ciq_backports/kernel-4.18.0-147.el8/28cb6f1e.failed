bpf: tls_sw, init TLS ULP removes BPF proto hooks

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-147.el8
commit-author John Fastabend <john.fastabend@gmail.com>
commit 28cb6f1eaffdc5a6a9707cac55f4a43aa3fd7895
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-147.el8/28cb6f1e.failed

The existing code did not expect users would initialize the TLS ULP
without subsequently calling the TLS TX enabling socket option.
If the application tries to send data after the TLS ULP enable op
but before the TLS TX enable op the BPF sk_msg verdict program is
skipped. This patch resolves this by converting the ipv4 sock ops
to be calculated at init time the same way ipv6 ops are done. This
pulls in any changes to the sock ops structure that have been made
after the socket was created including the changes from adding the
socket to a sock{map|hash}.

This was discovered by running OpenSSL master branch which calls
the TLS ULP setsockopt early in TLS handshake but only enables
the TLS TX path once the handshake has completed. As a result the
datapath missed the initial handshake messages.

Fixes: 02c558b2d5d6 ("bpf: sockmap, support for msg_peek in sk_msg with redirect ingress")
	Signed-off-by: John Fastabend <john.fastabend@gmail.com>
	Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
(cherry picked from commit 28cb6f1eaffdc5a6a9707cac55f4a43aa3fd7895)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/tls/tls_main.c
diff --cc net/tls/tls_main.c
index a0dcca82c8b9,acff12999c06..000000000000
--- a/net/tls/tls_main.c
+++ b/net/tls/tls_main.c
@@@ -718,11 -733,6 +730,14 @@@ static struct tcp_ulp_ops tcp_tls_ulp_o
  
  static int __init tls_register(void)
  {
++<<<<<<< HEAD
 +	BUILD_BUG_ON(sizeof(union tls_crypto_context) >
 +		     RH_KABI_TLS_CRYPT_CONTEXT_SIZE);
 +
 +	build_protos(tls_prots[TLSV4], &tcp_prot);
 +
++=======
++>>>>>>> 28cb6f1eaffd (bpf: tls_sw, init TLS ULP removes BPF proto hooks)
  	tls_sw_proto_ops = inet_stream_ops;
  	tls_sw_proto_ops.splice_read = tls_sw_splice_read;
  
* Unmerged path net/tls/tls_main.c
