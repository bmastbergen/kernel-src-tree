drm/amd: fix fb references in async update

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-147.el8
commit-author Helen Koike <helen.koike@collabora.com>
commit 332af874db929f92931727bfe191b2c666438c81
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-147.el8/332af874.failed

Async update callbacks are expected to set the old_fb in the new_state
so prepare/cleanup framebuffers are balanced.

Calling drm_atomic_set_fb_for_plane() (which gets a reference of the new
fb and put the old fb) is not required, as it's taken care by
drm_mode_cursor_universal() when calling drm_atomic_helper_update_plane().

	Cc: <stable@vger.kernel.org> # v4.20+
Fixes: 674e78acae0d ("drm/amd/display: Add fast path for cursor plane updates")
	Suggested-by: Boris Brezillon <boris.brezillon@collabora.com>
	Signed-off-by: Helen Koike <helen.koike@collabora.com>
	Reviewed-by: Nicholas Kazlauskas <nicholas.kazlauskas@amd.com>
	Signed-off-by: Boris Brezillon <boris.brezillon@collabora.com>
Link: https://patchwork.freedesktop.org/patch/msgid/20190603165610.24614-3-helen.koike@collabora.com
(cherry picked from commit 332af874db929f92931727bfe191b2c666438c81)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.c
diff --cc drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.c
index d656073f676c,ab7c5c3004ee..000000000000
--- a/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.c
+++ b/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.c
@@@ -3171,6 -4206,46 +3171,49 @@@ static int dm_plane_atomic_check(struc
  	return -EINVAL;
  }
  
++<<<<<<< HEAD
++=======
+ static int dm_plane_atomic_async_check(struct drm_plane *plane,
+ 				       struct drm_plane_state *new_plane_state)
+ {
+ 	struct drm_plane_state *old_plane_state =
+ 		drm_atomic_get_old_plane_state(new_plane_state->state, plane);
+ 
+ 	/* Only support async updates on cursor planes. */
+ 	if (plane->type != DRM_PLANE_TYPE_CURSOR)
+ 		return -EINVAL;
+ 
+ 	/*
+ 	 * DRM calls prepare_fb and cleanup_fb on new_plane_state for
+ 	 * async commits so don't allow fb changes.
+ 	 */
+ 	if (old_plane_state->fb != new_plane_state->fb)
+ 		return -EINVAL;
+ 
+ 	return 0;
+ }
+ 
+ static void dm_plane_atomic_async_update(struct drm_plane *plane,
+ 					 struct drm_plane_state *new_state)
+ {
+ 	struct drm_plane_state *old_state =
+ 		drm_atomic_get_old_plane_state(new_state->state, plane);
+ 
+ 	swap(plane->state->fb, new_state->fb);
+ 
+ 	plane->state->src_x = new_state->src_x;
+ 	plane->state->src_y = new_state->src_y;
+ 	plane->state->src_w = new_state->src_w;
+ 	plane->state->src_h = new_state->src_h;
+ 	plane->state->crtc_x = new_state->crtc_x;
+ 	plane->state->crtc_y = new_state->crtc_y;
+ 	plane->state->crtc_w = new_state->crtc_w;
+ 	plane->state->crtc_h = new_state->crtc_h;
+ 
+ 	handle_cursor_update(plane, old_state);
+ }
+ 
++>>>>>>> 332af874db92 (drm/amd: fix fb references in async update)
  static const struct drm_plane_helper_funcs dm_plane_helper_funcs = {
  	.prepare_fb = dm_plane_helper_prepare_fb,
  	.cleanup_fb = dm_plane_helper_cleanup_fb,
* Unmerged path drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.c
