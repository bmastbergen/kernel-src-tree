nvme-rdma: Check remotely invalidated rkey matches our expected rkey

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
Rebuild_CHGLOG: - [nvme] rdma: Check remotely invalidated rkey matches our expected rkey (David Milburn) [1547273]
Rebuild_FUZZ: 96.18%
commit-author Sagi Grimberg <sagi@grimberg.me>
commit 3ef0279bb0031f67537bd8972899a6a23d3064d7
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/3ef0279b.failed

If we got a remote invalidation on a bogus rkey, this is a protocol error.
Fail the connection in this case.

	Signed-off-by: Sagi Grimberg <sagi@grimberg.me>
	Reviewed-by: Max Gurtovoy <maxg@mellanox.com>
	Signed-off-by: Christoph Hellwig <hch@lst.de>
(cherry picked from commit 3ef0279bb0031f67537bd8972899a6a23d3064d7)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/nvme/host/rdma.c
diff --cc drivers/nvme/host/rdma.c
index 073a7b113e99,3a952d458e7c..000000000000
--- a/drivers/nvme/host/rdma.c
+++ b/drivers/nvme/host/rdma.c
@@@ -1205,9 -1334,25 +1205,19 @@@ static int nvme_rdma_process_nvme_rsp(s
  	req->status = cqe->status;
  	req->result = cqe->result;
  
++<<<<<<< HEAD
 +	if ((wc->wc_flags & IB_WC_WITH_INVALIDATE) &&
 +	    wc->ex.invalidate_rkey == req->mr->rkey)
++=======
+ 	if (wc->wc_flags & IB_WC_WITH_INVALIDATE) {
+ 		if (unlikely(wc->ex.invalidate_rkey != req->mr->rkey)) {
+ 			dev_err(queue->ctrl->ctrl.device,
+ 				"Bogus remote invalidation for rkey %#x\n",
+ 				req->mr->rkey);
+ 			nvme_rdma_error_recovery(queue->ctrl);
+ 		}
++>>>>>>> 3ef0279bb003 (nvme-rdma: Check remotely invalidated rkey matches our expected rkey)
  		req->mr->need_inval = false;
 -	} else if (req->mr->need_inval) {
 -		ret = nvme_rdma_inv_rkey(queue, req);
 -		if (unlikely(ret < 0)) {
 -			dev_err(queue->ctrl->ctrl.device,
 -				"Queueing INV WR for rkey %#x failed (%d)\n",
 -				req->mr->rkey, ret);
 -			nvme_rdma_error_recovery(queue->ctrl);
 -		}
 -		/* the local invalidation completion will end the request */
 -		return 0;
 -	}
  
  	if (refcount_dec_and_test(&req->ref)) {
  		if (rq->tag == tag)
* Unmerged path drivers/nvme/host/rdma.c
