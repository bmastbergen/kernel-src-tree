Revert "qla2xxx: Fix incorrect tcm_qla2xxx_free_cmd use during TMR ABORT"

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
Rebuild_CHGLOG: - [scsi] qla2xxx: Revert "qla2xxx: Fix incorrect tcm_qla2xxx_free_cmd use during TMR ABORT" (Himanshu Madhani) [1547714]
Rebuild_FUZZ: 94.19%
commit-author Nicholas Bellinger <nab@linux-iscsi.org>
commit 55dd8cf2163e1866d9497c4f361d6ed42b3a192b
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/55dd8cf2.failed

This reverts commit 5f572526a18418258bfa137e3353656c25439500.

As reported by Pascal here:

http://www.spinics.net/lists/target-devel/msg15808.html

there still appears to be another issue related to this change
to drop the original bogus tcm_qla2xxx_free_cmd() usage from
tcm_qla2xxx_handle_data_work() and tcm_qla2xxx_aborted_task().

So revert this for now, until Pascal can verify with further
debug in place to understand what's going on.

	Reported-by: Pascal de Bruijn <p.debruijn@unilogic.nl>
	Cc: Pascal de Bruijn <p.debruijn@unilogic.nl>
	Cc: Himanshu Madhani <himanshu.madhani@cavium.com>
	Cc: Quinn Tran <quinn.tran@cavium.com>
	Cc: <stable@vger.kernel.org> # 3.10+
	Signed-off-by: Nicholas Bellinger <nab@linux-iscsi.org>
(cherry picked from commit 55dd8cf2163e1866d9497c4f361d6ed42b3a192b)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/qla2xxx/qla_target.c
#	drivers/scsi/qla2xxx/tcm_qla2xxx.c
diff --cc drivers/scsi/qla2xxx/qla_target.c
index 81866eb6821f,401e245477d4..000000000000
--- a/drivers/scsi/qla2xxx/qla_target.c
+++ b/drivers/scsi/qla2xxx/qla_target.c
@@@ -4173,7 -4078,7 +4173,11 @@@ static struct qla_tgt_cmd *qlt_get_tag(
  
  	cmd = &((struct qla_tgt_cmd *)se_sess->sess_cmd_map)[tag];
  	memset(cmd, 0, sizeof(struct qla_tgt_cmd));
++<<<<<<< HEAD
 +	cmd->cmd_type = TYPE_TGT_CMD;
++=======
+ 
++>>>>>>> 55dd8cf2163e (Revert "qla2xxx: Fix incorrect tcm_qla2xxx_free_cmd use during TMR ABORT")
  	memcpy(&cmd->atio, atio, sizeof(*atio));
  	cmd->state = QLA_TGT_STATE_NEW;
  	cmd->tgt = vha->vha_tgt.qla_tgt;
diff --cc drivers/scsi/qla2xxx/tcm_qla2xxx.c
index 09f5e5812e98,75aeb9fdfd06..000000000000
--- a/drivers/scsi/qla2xxx/tcm_qla2xxx.c
+++ b/drivers/scsi/qla2xxx/tcm_qla2xxx.c
@@@ -534,7 -520,7 +534,11 @@@ static void tcm_qla2xxx_handle_data_wor
  	}
  	spin_unlock_irqrestore(&cmd->cmd_lock, flags);
  
++<<<<<<< HEAD
 +	cmd->qpair->tgt_counters.qla_core_ret_ctio++;
++=======
+ 	cmd->vha->tgt_counters.qla_core_ret_ctio++;
++>>>>>>> 55dd8cf2163e (Revert "qla2xxx: Fix incorrect tcm_qla2xxx_free_cmd use during TMR ABORT")
  	if (!cmd->write_data_transferred) {
  		/*
  		 * Check if se_cmd has already been aborted via LUN_RESET, and
@@@ -777,7 -753,6 +781,10 @@@ static void tcm_qla2xxx_queue_tm_rsp(st
  	qlt_xmit_tm_rsp(mcmd);
  }
  
++<<<<<<< HEAD
 +
++=======
++>>>>>>> 55dd8cf2163e (Revert "qla2xxx: Fix incorrect tcm_qla2xxx_free_cmd use during TMR ABORT")
  #define DATA_WORK_NOT_FREE(_cmd) (_cmd->data_work && !_cmd->data_work_free)
  static void tcm_qla2xxx_aborted_task(struct se_cmd *se_cmd)
  {
* Unmerged path drivers/scsi/qla2xxx/qla_target.c
* Unmerged path drivers/scsi/qla2xxx/tcm_qla2xxx.c
