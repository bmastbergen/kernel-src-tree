crypto: algif_hash - Fix result clobbering in recvmsg

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
Rebuild_CHGLOG: - [crypto] algif_hash: Fix result clobbering in recvmsg (Bruno Eduardo de Oliveira Meneguele) [1548921]
Rebuild_FUZZ: 88.66%
commit-author Herbert Xu <herbert@gondor.apana.org.au>
commit 8acf7a106326eb94e143552de81f34308149121c
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/8acf7a10.failed

Recently an init call was added to hash_recvmsg so as to reset
the hash state in case a sendmsg call was never made.

Unfortunately this ended up clobbering the result if the previous
sendmsg was done with a MSG_MORE flag.  This patch fixes it by
excluding that case when we make the init call.

Fixes: a8348bca2944 ("algif_hash - Fix NULL hash crash with shash")
	Reported-by: Patrick Steinhardt <ps@pks.im>
	Signed-off-by: Herbert Xu <herbert@gondor.apana.org.au>
(cherry picked from commit 8acf7a106326eb94e143552de81f34308149121c)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	crypto/algif_hash.c
diff --cc crypto/algif_hash.c
index f3f31cd079cc,d19b09cdf284..000000000000
--- a/crypto/algif_hash.c
+++ b/crypto/algif_hash.c
@@@ -172,9 -207,23 +172,28 @@@ static int hash_recvmsg(struct kiocb *u
  		msg->msg_flags |= MSG_TRUNC;
  
  	lock_sock(sk);
++<<<<<<< HEAD
 +	if (ctx->more) {
++=======
+ 	result = ctx->result;
+ 	err = hash_alloc_result(sk, ctx);
+ 	if (err)
+ 		goto unlock;
+ 
+ 	ahash_request_set_crypt(&ctx->req, NULL, ctx->result, 0);
+ 
+ 	if (!result && !ctx->more) {
+ 		err = af_alg_wait_for_completion(
+ 				crypto_ahash_init(&ctx->req),
+ 				&ctx->completion);
+ 		if (err)
+ 			goto unlock;
+ 	}
+ 
+ 	if (!result || ctx->more) {
++>>>>>>> 8acf7a106326 (crypto: algif_hash - Fix result clobbering in recvmsg)
  		ctx->more = 0;
 +		ahash_request_set_crypt(&ctx->req, NULL, ctx->result, 0);
  		err = af_alg_wait_for_completion(crypto_ahash_final(&ctx->req),
  						 &ctx->completion);
  		if (err)
* Unmerged path crypto/algif_hash.c
