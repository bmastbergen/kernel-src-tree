qla2xxx: Fix incorrect tcm_qla2xxx_free_cmd use during TMR ABORT (v2)

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
commit-author Nicholas Bellinger <nab@linux-iscsi.org>
commit 6bcbb3174caa5f1ccc894f8ae077631659d5a629
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/6bcbb317.failed

This patch drops two incorrect usages of tcm_qla2xxx_free_cmd()
during TMR ABORT within tcm_qla2xxx_handle_data_work() and
tcm_qla2xxx_aborted_task(), which where attempting to dispatch
into workqueue context to do tcm_qla2xxx_complete_free() and
subsequently invoke transport_generic_free_cmd().

This is incorrect because during TMR ABORT target-core will
drop the outstanding se_cmd->cmd_kref references once it has
quiesced the se_cmd via transport_wait_for_tasks(), and in
the case of qla2xxx it should not attempt to do it's own
transport_generic_free_cmd() once the abort has occured.

As reported by Pascal, this was originally manifesting as a
BUG_ON(cmd->cmd_in_wq) in qlt_free_cmd() during TMR ABORT,
with a LIO backend that had sufficently high enough WRITE
latency to trigger a host side TMR ABORT_TASK.

(v2: Drop the qla_tgt_cmd->write_pending_abort_comp changes,
     as they will be addressed in a seperate series)

	Reported-by: Pascal de Bruijn <p.debruijn@unilogic.nl>
	Tested-by: Pascal de Bruijn <p.debruijn@unilogic.nl>
	Cc: Pascal de Bruijn <p.debruijn@unilogic.nl>
	Reported-by: Lukasz Engel <lukasz.engel@softax.pl>
	Cc: Lukasz Engel <lukasz.engel@softax.pl>
	Acked-by: Himanshu Madhani <himanshu.madhani@cavium.com>
	Cc: Quinn Tran <quinn.tran@cavium.com>
	Cc: <stable@vger.kernel.org> # 3.10+
	Signed-off-by: Nicholas Bellinger <nab@linux-iscsi.org>
(cherry picked from commit 6bcbb3174caa5f1ccc894f8ae077631659d5a629)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/qla2xxx/tcm_qla2xxx.c
diff --cc drivers/scsi/qla2xxx/tcm_qla2xxx.c
index 09f5e5812e98,3f82ea1b72dc..000000000000
--- a/drivers/scsi/qla2xxx/tcm_qla2xxx.c
+++ b/drivers/scsi/qla2xxx/tcm_qla2xxx.c
@@@ -777,8 -753,6 +765,11 @@@ static void tcm_qla2xxx_queue_tm_rsp(st
  	qlt_xmit_tm_rsp(mcmd);
  }
  
++<<<<<<< HEAD
 +
 +#define DATA_WORK_NOT_FREE(_cmd) (_cmd->data_work && !_cmd->data_work_free)
++=======
++>>>>>>> 6bcbb3174caa (qla2xxx: Fix incorrect tcm_qla2xxx_free_cmd use during TMR ABORT (v2))
  static void tcm_qla2xxx_aborted_task(struct se_cmd *se_cmd)
  {
  	struct qla_tgt_cmd *cmd = container_of(se_cmd,
* Unmerged path drivers/scsi/qla2xxx/tcm_qla2xxx.c
