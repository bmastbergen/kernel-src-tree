scsi: qla2xxx: Fix a recently introduced memory leak

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
Rebuild_CHGLOG: - [scsi] qla2xxx: Fix a recently introduced memory leak (Himanshu Madhani) [1547714]
Rebuild_FUZZ: 93.88%
commit-author Bart Van Assche <bart.vanassche@sandisk.com>
commit 27873de99f2fecca0f6b257316489ef2a1d86ffd
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/27873de9.failed

qla2x00_probe_one() allocates IRQs before it initializes rsp_q_map so
IRQs must be freed even if rsp_q_map allocation did not occur.  This was
detected by kmemleak.

Fixes: 4fa183455988 ("scsi: qla2xxx: Utilize pci_alloc_irq_vectors/pci_free_irq_vectors calls")
	Signed-off-by: Bart Van Assche <bart.vanassche@sandisk.com>
	Cc: Michael Hernandez <michael.hernandez@cavium.com>
	Cc: Himanshu Madhani <himanshu.madhani@cavium.com>
	Cc: Christoph Hellwig <hch@lst.de>
	Cc: <stable@vger.kernel.org>
	Reviewed-by: Christoph Hellwig <hch@lst.de>
Acked-By: Himanshu Madhani <himanshu.madhani@cavium.com>
	Reviewed-by: Johannes Thumshirn <jthumshirn@suse.de>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit 27873de99f2fecca0f6b257316489ef2a1d86ffd)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/qla2xxx/qla_isr.c
diff --cc drivers/scsi/qla2xxx/qla_isr.c
index 5b62f352b08f,3116bf390b06..000000000000
--- a/drivers/scsi/qla2xxx/qla_isr.c
+++ b/drivers/scsi/qla2xxx/qla_isr.c
@@@ -3481,16 -3237,28 +3481,38 @@@ qla2x00_free_irqs(scsi_qla_host_t *vha
  	 * from a probe failure context.
  	 */
  	if (!ha->rsp_q_map || !ha->rsp_q_map[0])
- 		return;
+ 		goto free_irqs;
  	rsp = ha->rsp_q_map[0];
  
++<<<<<<< HEAD
 +	if (ha->flags.msix_enabled)
 +		qla24xx_disable_msix(ha);
 +	else if (ha->flags.msi_enabled) {
 +		free_irq(ha->pdev->irq, rsp);
 +		pci_disable_msi(ha->pdev);
 +	} else
 +		free_irq(ha->pdev->irq, rsp);
++=======
+ 	if (ha->flags.msix_enabled) {
+ 		for (i = 0; i < ha->msix_count; i++) {
+ 			qentry = &ha->msix_entries[i];
+ 			if (qentry->have_irq) {
+ 				irq_set_affinity_notifier(qentry->vector, NULL);
+ 				free_irq(pci_irq_vector(ha->pdev, i), qentry->handle);
+ 			}
+ 		}
+ 		kfree(ha->msix_entries);
+ 		ha->msix_entries = NULL;
+ 		ha->flags.msix_enabled = 0;
+ 		ql_dbg(ql_dbg_init, vha, 0x0042,
+ 			"Disabled MSI-X.\n");
+ 	} else {
+ 		free_irq(pci_irq_vector(ha->pdev, 0), rsp);
+ 	}
+ 
+ free_irqs:
+ 	pci_free_irq_vectors(ha->pdev);
++>>>>>>> 27873de99f2f (scsi: qla2xxx: Fix a recently introduced memory leak)
  }
  
  int qla25xx_request_irq(struct qla_hw_data *ha, struct qla_qpair *qpair,
* Unmerged path drivers/scsi/qla2xxx/qla_isr.c
