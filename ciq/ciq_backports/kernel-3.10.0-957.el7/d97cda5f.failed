mlxsw: spectrum_router: Handle encap to demoted tunnels

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
commit-author Petr Machata <petrm@mellanox.com>
commit d97cda5f465bacc82659263a885703d73759ea04
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/d97cda5f.failed

Some tunnels that are offloadable on their own can nonetheless be
demoted to slow path if their local address is in conflict with that of
another tunnel. When a route is formed for such a tunnel,
mlxsw_sp_nexthop_ipip_init() fails to find the corresponding IPIP entry,
and that triggers a FIB abort.

Resolve the problem by not assuming that a tunnel for which
mlxsw_sp_ipip_ops.can_offload() holds also automatically has an IPIP
entry.

Fixes: af641713e97d ("mlxsw: spectrum_router: Onload conflicting tunnels")
	Signed-off-by: Petr Machata <petrm@mellanox.com>
	Reviewed-by: Ido Schimmel <idosch@mellanox.com>
	Signed-off-by: Jiri Pirko <jiri@mellanox.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit d97cda5f465bacc82659263a885703d73759ea04)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlxsw/spectrum_router.c
diff --cc drivers/net/ethernet/mellanox/mlxsw/spectrum_router.c
index edab76a34b3f,17e2153a8dc9..000000000000
--- a/drivers/net/ethernet/mellanox/mlxsw/spectrum_router.c
+++ b/drivers/net/ethernet/mellanox/mlxsw/spectrum_router.c
@@@ -3088,19 -3354,26 +3088,39 @@@ static void mlxsw_sp_nexthop_neigh_fini
  	neigh_release(n);
  }
  
++<<<<<<< HEAD
 +static int mlxsw_sp_nexthop_ipip_init(struct mlxsw_sp *mlxsw_sp,
 +				      struct mlxsw_sp_nexthop *nh,
 +				      struct net_device *ol_dev)
++=======
+ static bool mlxsw_sp_ipip_netdev_ul_up(struct net_device *ol_dev)
+ {
+ 	struct net_device *ul_dev = __mlxsw_sp_ipip_netdev_ul_dev_get(ol_dev);
+ 
+ 	return ul_dev ? (ul_dev->flags & IFF_UP) : true;
+ }
+ 
+ static void mlxsw_sp_nexthop_ipip_init(struct mlxsw_sp *mlxsw_sp,
+ 				       struct mlxsw_sp_nexthop *nh,
+ 				       struct mlxsw_sp_ipip_entry *ipip_entry)
++>>>>>>> d97cda5f465b (mlxsw: spectrum_router: Handle encap to demoted tunnels)
  {
 -	bool removing;
 -
  	if (!nh->nh_grp->gateway || nh->ipip_entry)
- 		return 0;
+ 		return;
  
++<<<<<<< HEAD
 +	nh->ipip_entry = mlxsw_sp_ipip_entry_find_by_ol_dev(mlxsw_sp, ol_dev);
 +	if (!nh->ipip_entry)
 +		return -ENOENT;
 +
 +	__mlxsw_sp_nexthop_neigh_update(nh, false);
 +	return 0;
++=======
+ 	nh->ipip_entry = ipip_entry;
+ 	removing = !mlxsw_sp_ipip_netdev_ul_up(ipip_entry->ol_dev);
+ 	__mlxsw_sp_nexthop_neigh_update(nh, removing);
+ 	mlxsw_sp_nexthop_rif_init(nh, &ipip_entry->ol_lb->common);
++>>>>>>> d97cda5f465b (mlxsw: spectrum_router: Handle encap to demoted tunnels)
  }
  
  static void mlxsw_sp_nexthop_ipip_fini(struct mlxsw_sp *mlxsw_sp,
* Unmerged path drivers/net/ethernet/mellanox/mlxsw/spectrum_router.c
