powerpc: Fix DSCR inheritance over fork()

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
commit-author Anton Blanchard <anton@samba.org>
commit db1231dcdb4dc6cdcbdef0babe641a9162c0dc98
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/db1231dc.failed

Two DSCR tests have a hack in them:

	/*
	 * XXX: Force a context switch out so that DSCR
	 * current value is copied into the thread struct
	 * which is required for the child to inherit the
	 * changed value.
	 */
	sleep(1);

We should not be working around this in the testcase, it is a kernel bug.
Fix it by copying the current DSCR to the child, instead of what we
had in the thread struct at last context switch.

	Signed-off-by: Anton Blanchard <anton@samba.org>
	Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
(cherry picked from commit db1231dcdb4dc6cdcbdef0babe641a9162c0dc98)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/testing/selftests/powerpc/dscr/dscr_inherit_exec_test.c
#	tools/testing/selftests/powerpc/dscr/dscr_inherit_test.c
* Unmerged path tools/testing/selftests/powerpc/dscr/dscr_inherit_exec_test.c
* Unmerged path tools/testing/selftests/powerpc/dscr/dscr_inherit_test.c
diff --git a/arch/powerpc/kernel/process.c b/arch/powerpc/kernel/process.c
index 73b045841fa9..790d79531d77 100644
--- a/arch/powerpc/kernel/process.c
+++ b/arch/powerpc/kernel/process.c
@@ -1206,7 +1206,7 @@ int copy_thread(unsigned long clone_flags, unsigned long usp,
 #ifdef CONFIG_PPC64 
 	if (cpu_has_feature(CPU_FTR_DSCR)) {
 		p->thread.dscr_inherit = current->thread.dscr_inherit;
-		p->thread.dscr = current->thread.dscr;
+		p->thread.dscr = mfspr(SPRN_DSCR);
 	}
 	if (cpu_has_feature(CPU_FTR_HAS_PPR))
 		p->thread.ppr = INIT_PPR;
* Unmerged path tools/testing/selftests/powerpc/dscr/dscr_inherit_exec_test.c
* Unmerged path tools/testing/selftests/powerpc/dscr/dscr_inherit_test.c
