scsi: qla2xxx: fix MSI-X vector affinity

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
Rebuild_CHGLOG: - [scsi] qla2xxx: fix MSI-X vector affinity (Himanshu Madhani) [1547714]
Rebuild_FUZZ: 91.89%
commit-author Christoph Hellwig <hch@lst.de>
commit 17e5fc58588b5e3df8220c90a9d8af55201d6b45
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/17e5fc58.failed

The first two or three vectors in qla2xxx adapter are global and not
associated with a specific queue.  They should not have IRQ affinity
assigned.

	Signed-off-by: Christoph Hellwig <hch@lst.de>
	Acked-by: Himanshu Madhani <himanshu.madhani@cavium.com>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit 17e5fc58588b5e3df8220c90a9d8af55201d6b45)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/qla2xxx/qla_isr.c
diff --cc drivers/scsi/qla2xxx/qla_isr.c
index 5b62f352b08f,e2ef303b2bcf..000000000000
--- a/drivers/scsi/qla2xxx/qla_isr.c
+++ b/drivers/scsi/qla2xxx/qla_isr.c
@@@ -3228,25 -3017,20 +3228,37 @@@ qla24xx_disable_msix(struct qla_hw_dat
  static int
  qla24xx_enable_msix(struct qla_hw_data *ha, struct rsp_que *rsp)
  {
- #define MIN_MSIX_COUNT	2
  	int i, ret;
 +	struct msix_entry *entries;
  	struct qla_msix_entry *qentry;
  	scsi_qla_host_t *vha = pci_get_drvdata(ha->pdev);
+ 	struct irq_affinity desc = {
+ 		.pre_vectors = QLA_BASE_VECTORS,
+ 	};
+ 
+ 	if (QLA_TGT_MODE_ENABLED() && IS_ATIO_MSIX_CAPABLE(ha))
+ 		desc.pre_vectors++;
+ 
+ 	ret = pci_alloc_irq_vectors_affinity(ha->pdev, QLA_BASE_VECTORS,
+ 			ha->msix_count, PCI_IRQ_MSIX | PCI_IRQ_AFFINITY,
+ 			&desc);
  
++<<<<<<< HEAD
 +	entries = kzalloc(sizeof(struct msix_entry) * ha->msix_count,
 +			GFP_KERNEL);
 +	if (!entries) {
 +		ql_log(ql_log_warn, vha, 0x00bc,
 +		    "Failed to allocate memory for msix_entry.\n");
 +		return -ENOMEM;
 +	}
 +
 +	for (i = 0; i < ha->msix_count; i++)
 +		entries[i].entry = i;
 +
 +	ret = pci_enable_msix_range(ha->pdev,
 +				    entries, MIN_MSIX_COUNT, ha->msix_count);
++=======
++>>>>>>> 17e5fc58588b (scsi: qla2xxx: fix MSI-X vector affinity)
  	if (ret < 0) {
  		ql_log(ql_log_fatal, vha, 0x00c7,
  		    "MSI-X: Failed to enable support, "
diff --git a/drivers/scsi/qla2xxx/qla_def.h b/drivers/scsi/qla2xxx/qla_def.h
index 70dffc916a3d..274264828b56 100644
--- a/drivers/scsi/qla2xxx/qla_def.h
+++ b/drivers/scsi/qla2xxx/qla_def.h
@@ -3019,7 +3019,7 @@ struct isp_operations {
 #define QLA_MSIX_FW_MODE(m)	(((m) & (BIT_7|BIT_8|BIT_9)) >> 7)
 #define QLA_MSIX_FW_MODE_1(m)	(QLA_MSIX_FW_MODE(m) == 1)
 
-#define QLA_MSIX_DEFAULT		0x00
+#define QLA_BASE_VECTORS	2 /* default + RSP */
 #define QLA_MSIX_RSP_Q			0x01
 #define QLA_ATIO_VECTOR		0x02
 #define QLA_MSIX_QPAIR_MULTIQ_RSP_Q	0x03
* Unmerged path drivers/scsi/qla2xxx/qla_isr.c
