iio: Fix error handling in iio_trigger_attach_poll_func

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
Rebuild_CHGLOG: - [iio] Fix error handling in iio_trigger_attach_poll_func (Tony Camuso) [1559170]
Rebuild_FUZZ: 95.24%
commit-author Crestez Dan Leonard <leonard.crestez@intel.com>
commit 99543823357966ac938d9a310947e731b67338e6
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/99543823.failed

When attaching a pollfunc iio_trigger_attach_poll_func will allocate a
virtual irq and call the driver's set_trigger_state function. Fix error
handling to undo previous steps if any fails.

In particular this fixes handling errors from a driver's
set_trigger_state function. When using triggered buffers a failure to
enable the trigger used to make the buffer unusable.

	Signed-off-by: Crestez Dan Leonard <leonard.crestez@intel.com>
	Cc: <Stable@vger.kernel.org>
	Signed-off-by: Jonathan Cameron <jic23@kernel.org>
(cherry picked from commit 99543823357966ac938d9a310947e731b67338e6)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/iio/industrialio-trigger.c
diff --cc drivers/iio/industrialio-trigger.c
index e962f3e11043,0c52dfe64977..000000000000
--- a/drivers/iio/industrialio-trigger.c
+++ b/drivers/iio/industrialio-trigger.c
@@@ -219,15 -220,14 +225,18 @@@ static int iio_trigger_attach_poll_func
  	ret = request_threaded_irq(pf->irq, pf->h, pf->thread,
  				   pf->type, pf->name,
  				   pf);
- 	if (ret < 0) {
- 		module_put(pf->indio_dev->info->driver_module);
- 		return ret;
- 	}
+ 	if (ret < 0)
+ 		goto out_put_irq;
  
++<<<<<<< HEAD
 +	if (trig->ops->set_trigger_state && notinuse) {
++=======
+ 	/* Enable trigger in driver */
+ 	if (trig->ops && trig->ops->set_trigger_state && notinuse) {
++>>>>>>> 995438233579 (iio: Fix error handling in iio_trigger_attach_poll_func)
  		ret = trig->ops->set_trigger_state(trig, true);
  		if (ret < 0)
- 			module_put(pf->indio_dev->info->driver_module);
+ 			goto out_free_irq;
  	}
  
  	return ret;
* Unmerged path drivers/iio/industrialio-trigger.c
