md/raid10: fix FailFast test for wrong device

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
Rebuild_CHGLOG: - [md] raid10: fix FailFast test for wrong device (Nigel Croxon) [1494474]
Rebuild_FUZZ: 96.55%
commit-author Guoqing Jiang <gqjiang@suse.com>
commit 1cdd1257949c85c5ddff8313fe3b1e39c5bee8b8
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/1cdd1257.failed

We need to test FailFast flag for replacement device here
since the set up for writing is for the replacement, so we
need fix it like:

- if (test_bit(FailFast, &conf->mirrors[d].rdev->flags))
+ if (test_bit(FailFast, &conf->mirrors[d].replacement->flags))

Since commit f90145f317ef ("md/raid10: add rcu protection
to rdev access in raid10_sync_request.") had added the rcu
protection for the part, so let's extend the range protected
by rcu and use rdev directly.

Fixes: 1919cbb ("md/raid10: add failfast handling for writes.")
	Reviewed-by: NeilBrown <neilb@suse.com>
	Signed-off-by: Guoqing Jiang <gqjiang@suse.com>
	Signed-off-by: Shaohua Li <shli@fb.com>
(cherry picked from commit 1cdd1257949c85c5ddff8313fe3b1e39c5bee8b8)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/md/raid10.c
diff --cc drivers/md/raid10.c
index 17d84aee79e2,305b0db5a293..000000000000
--- a/drivers/md/raid10.c
+++ b/drivers/md/raid10.c
@@@ -3447,12 -3293,11 +3447,19 @@@ static sector_t raid10_sync_request(str
  			atomic_inc(&r10_bio->remaining);
  			bio->bi_next = biolist;
  			biolist = bio;
 +			bio->bi_private = r10_bio;
  			bio->bi_end_io = end_sync_read;
++<<<<<<< HEAD
 +			bio->bi_rw = READ;
 +			if (test_bit(FailFast, &conf->mirrors[d].rdev->flags))
 +				bio->bi_rw |= MD_FAILFAST;
 +			bio->bi_sector = sector + rdev->data_offset;
++=======
+ 			bio_set_op_attrs(bio, REQ_OP_READ, 0);
+ 			if (test_bit(FailFast, &rdev->flags))
+ 				bio->bi_opf |= MD_FAILFAST;
+ 			bio->bi_iter.bi_sector = sector + rdev->data_offset;
++>>>>>>> 1cdd1257949c (md/raid10: fix FailFast test for wrong device)
  			bio->bi_bdev = rdev->bdev;
  			count++;
  
@@@ -3472,14 -3315,14 +3478,22 @@@
  			sector = r10_bio->devs[i].addr;
  			bio->bi_next = biolist;
  			biolist = bio;
 +			bio->bi_private = r10_bio;
  			bio->bi_end_io = end_sync_write;
++<<<<<<< HEAD
 +			bio->bi_rw = WRITE;
 +			if (test_bit(FailFast, &conf->mirrors[d].rdev->flags))
 +				bio->bi_rw |= MD_FAILFAST;
 +			bio->bi_sector = sector + rdev->data_offset;
++=======
+ 			bio_set_op_attrs(bio, REQ_OP_WRITE, 0);
+ 			if (test_bit(FailFast, &rdev->flags))
+ 				bio->bi_opf |= MD_FAILFAST;
+ 			bio->bi_iter.bi_sector = sector + rdev->data_offset;
++>>>>>>> 1cdd1257949c (md/raid10: fix FailFast test for wrong device)
  			bio->bi_bdev = rdev->bdev;
  			count++;
+ 			rcu_read_unlock();
  		}
  
  		if (count < 2) {
* Unmerged path drivers/md/raid10.c
