slab_common: fix the check for duplicate slab names

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
commit-author Mikulas Patocka <mpatocka@redhat.com>
commit 694617474e33b8603fc76e090ed7d09376514b1a
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/69461747.failed

The patch 3e374919b314f20e2a04f641ebc1093d758f66a4 is supposed to fix the
problem where kmem_cache_create incorrectly reports duplicate cache name
and fails. The problem is described in the header of that patch.

However, the patch doesn't really fix the problem because of these
reasons:

* the logic to test for debugging is reversed. It was intended to perform
  the check only if slub debugging is enabled (which implies that caches
  with the same parameters are not merged). Therefore, there should be
  #if !defined(CONFIG_SLUB) || defined(CONFIG_SLUB_DEBUG_ON)
  The current code has the condition reversed and performs the test if
  debugging is disabled.

* slub debugging may be enabled or disabled based on kernel command line,
  CONFIG_SLUB_DEBUG_ON is just the default settings. Therefore the test
  based on definition of CONFIG_SLUB_DEBUG_ON is unreliable.

This patch fixes the problem by removing the test
"!defined(CONFIG_SLUB_DEBUG_ON)". Therefore, duplicate names are never
checked if the SLUB allocator is used.

Note to stable kernel maintainers: when backporint this patch, please
backport also the patch 3e374919b314f20e2a04f641ebc1093d758f66a4.

	Acked-by: David Rientjes <rientjes@google.com>
	Acked-by: Christoph Lameter <cl@linux.com>
	Signed-off-by: Mikulas Patocka <mpatocka@redhat.com>
	Cc: stable@vger.kernel.org	# 3.6+
	Signed-off-by: Pekka Enberg <penberg@kernel.org>
(cherry picked from commit 694617474e33b8603fc76e090ed7d09376514b1a)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	mm/slab_common.c
diff --cc mm/slab_common.c
index d9eb94deb116,b810fba0095d..000000000000
--- a/mm/slab_common.c
+++ b/mm/slab_common.c
@@@ -55,14 -55,8 +55,19 @@@ static int kmem_cache_sanity_check(stru
  			continue;
  		}
  
++<<<<<<< HEAD
 +#if !defined(CONFIG_SLUB) || !defined(CONFIG_SLUB_DEBUG_ON)
 +		/*
 +		 * For simplicity, we won't check this in the list of memcg
 +		 * caches. We have control over memcg naming, and if there
 +		 * aren't duplicates in the global list, there won't be any
 +		 * duplicates in the memcg lists as well.
 +		 */
 +		if (!memcg && !strcmp(s->name, name)) {
++=======
+ #if !defined(CONFIG_SLUB)
+ 		if (!strcmp(s->name, name)) {
++>>>>>>> 694617474e33 (slab_common: fix the check for duplicate slab names)
  			pr_err("%s (%s): Cache name already exists.\n",
  			       __func__, name);
  			dump_stack();
* Unmerged path mm/slab_common.c
