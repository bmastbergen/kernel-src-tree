ASoC: Intel: Fix Kconfig with top-level selector

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
Rebuild_CHGLOG: - [sound] alsa: asoc: intel: Fix Kconfig with top-level selector (Jaroslav Kysela) [1535427]
Rebuild_FUZZ: 94.12%
commit-author Pierre-Louis Bossart <pierre-louis.bossart@linux.intel.com>
commit c6059879be298cccda52f77bf019a7a99eb13e78
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/c6059879.failed

Follow network example suggested by Linus, move Intel definitions
in if/endif block and clarify in help text which options distro
configurations should enable - everything except legacy Baytrail stuff and
NOCODEC (test only)

To avoid user confusion, machine drivers are handled with a submenu made
dependent on this top-level selector.

There should be no functionality change - except that sound capabilities
are restored when using older configs without any user selection.

Note that the SND_SOC_ACPI_INTEL_MATCH config is currently filtered
out by the top-level selector. This will change in the near future to
allow for this option to be selected by both SST and SOF drivers

(simplification with submenu for machine drivers by Vinod Koul)

Fixes: f6a118a800e3 ("ASoC: Intel: clarify Kconfig dependencies")
	Reported-by: Linus Torvalds <torvalds@linux-foundation.org>
	Signed-off-by: Pierre-Louis Bossart <pierre-louis.bossart@linux.intel.com>
	Signed-off-by: Vinod Koul <vinod.koul@intel.com>
	Reviewed-by: Andy Shevchenko <andriy.shevchenko@linux.intel.com>
	Signed-off-by: Mark Brown <broonie@kernel.org>
(cherry picked from commit c6059879be298cccda52f77bf019a7a99eb13e78)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	sound/soc/intel/Kconfig
#	sound/soc/intel/Makefile
#	sound/soc/intel/boards/Kconfig
diff --cc sound/soc/intel/Kconfig
index dbc80250ceab,b827d3b70095..000000000000
--- a/sound/soc/intel/Kconfig
+++ b/sound/soc/intel/Kconfig
@@@ -1,18 -1,18 +1,36 @@@
++<<<<<<< HEAD
 +config SND_MFLD_MACHINE
 +	tristate "SOC Machine Audio driver for Intel Medfield MID platform"
 +	depends on INTEL_SCU_IPC
 +	select SND_SOC_SN95031
 +	select SND_SST_ATOM_HIFI2_PLATFORM
 +	select SND_SST_IPC_PCI
 +	help
 +          This adds support for ASoC machine driver for Intel(R) MID Medfield platform
 +          used as alsa device in audio substem in Intel(R) MID devices
 +          Say Y if you have such a device.
 +          If unsure select "N".
 +
 +config SND_SST_ATOM_HIFI2_PLATFORM
 +	tristate
 +	select SND_SOC_COMPRESS
++=======
+ config SND_SOC_INTEL_SST_TOPLEVEL
+ 	bool "Intel ASoC SST drivers"
+ 	default y
+ 	depends on X86 || COMPILE_TEST
+ 	select SND_SOC_INTEL_MACH
+ 	help
+ 	  Intel ASoC SST Platform Drivers. If you have a Intel machine that
+ 	  has an audio controller with a DSP and I2S or DMIC port, then
+ 	  enable this option by saying Y
+ 
+ 	  Note that the answer to this question doesn't directly affect the
+ 	  kernel: saying N will just cause the configurator to skip all
+ 	  the questions about Intel SST drivers.
+ 
+ if SND_SOC_INTEL_SST_TOPLEVEL
++>>>>>>> c6059879be29 (ASoC: Intel: Fix Kconfig with top-level selector)
  
  config SND_SST_IPC
  	tristate
@@@ -39,283 -38,56 +57,331 @@@ config SND_SOC_INTEL_SST_FIRMWAR
  config SND_SOC_INTEL_SST_ACPI
  	tristate
  
++<<<<<<< HEAD
 +config SND_SOC_INTEL_SST_MATCH
 +	tristate
 +
 +config SND_SOC_INTEL_HASWELL
 +	tristate
++=======
+ config SND_SOC_INTEL_HASWELL
+ 	tristate "Intel ASoC SST driver for Haswell/Broadwell"
+ 	depends on SND_DMA_SGBUF
+ 	depends on DMADEVICES
++>>>>>>> c6059879be29 (ASoC: Intel: Fix Kconfig with top-level selector)
  	select SND_SOC_INTEL_SST
  	select SND_SOC_INTEL_SST_FIRMWARE
+ 	select SND_SOC_ACPI_INTEL_MATCH
+ 	help
+ 	  If you have a Intel Haswell or Broadwell platform connected to
+ 	  an I2S codec, then enable this option by saying Y or m. This is
+ 	  typically used for Chromebooks. This is a recommended option.
  
  config SND_SOC_INTEL_BAYTRAIL
++<<<<<<< HEAD
 +	tristate
++=======
+ 	tristate "Intel ASoC SST driver for Baytrail (legacy)"
+ 	depends on DMADEVICES
++>>>>>>> c6059879be29 (ASoC: Intel: Fix Kconfig with top-level selector)
  	select SND_SOC_INTEL_SST
  	select SND_SOC_INTEL_SST_FIRMWARE
+ 	select SND_SOC_ACPI_INTEL_MATCH
+ 	help
+ 	  If you have a Intel Baytrail platform connected to an I2S codec,
+ 	  then enable this option by saying Y or m. This was typically used
+ 	  for Baytrail Chromebooks but this option is now deprecated and is
+ 	  not recommended, use SND_SST_ATOM_HIFI2_PLATFORM instead.
  
++<<<<<<< HEAD
 +config SND_SOC_INTEL_HASWELL_MACH
 +	tristate "ASoC Audio DSP support for Intel Haswell Lynxpoint"
 +	depends on X86_INTEL_LPSS && I2C && I2C_DESIGNWARE_PLATFORM
 +	depends on DMADEVICES
 +	select SND_SOC_INTEL_HASWELL
 +	select SND_SOC_RT5640
 +	help
 +	  This adds support for the Lynxpoint Audio DSP on Intel(R) Haswell
 +	  Ultrabook platforms.
 +	  Say Y if you have such a device.
 +	  If unsure select "N".
 +
 +config SND_SOC_INTEL_BXT_DA7219_MAX98357A_MACH
 +	tristate "ASoC Audio driver for Broxton with DA7219 and MAX98357A in I2S Mode"
 +	depends on X86 && ACPI && I2C
 +	select SND_SOC_INTEL_SKYLAKE
 +	select SND_SOC_DA7219
 +	select SND_SOC_MAX98357A
 +	select SND_SOC_DMIC
 +	select SND_SOC_HDAC_HDMI
 +	select SND_HDA_DSP_LOADER
 +	help
 +	   This adds support for ASoC machine driver for Broxton-P platforms
 +	   with DA7219 + MAX98357A I2S audio codec.
 +	   Say Y if you have such a device.
 +	   If unsure select "N".
 +
 +config SND_SOC_INTEL_BXT_RT298_MACH
 +	tristate "ASoC Audio driver for Broxton with RT298 I2S mode"
 +	depends on X86 && ACPI && I2C
 +	select SND_SOC_INTEL_SKYLAKE
 +	select SND_SOC_RT298
 +	select SND_SOC_DMIC
 +	select SND_SOC_HDAC_HDMI
 +	select SND_HDA_DSP_LOADER
 +	help
 +	   This adds support for ASoC machine driver for Broxton platforms
 +	   with RT286 I2S audio codec.
 +	   Say Y if you have such a device.
 +	   If unsure select "N".
 +
 +config SND_SOC_INTEL_BYT_RT5640_MACH
 +	tristate "ASoC Audio driver for Intel Baytrail with RT5640 codec"
 +	depends on X86_INTEL_LPSS && I2C
 +	depends on DMADEVICES
 +	depends on SND_SST_IPC_ACPI = n
 +	select SND_SOC_INTEL_BAYTRAIL
 +	select SND_SOC_RT5640
 +	help
 +	  This adds audio driver for Intel Baytrail platform based boards
 +	  with the RT5640 audio codec. This driver is deprecated, use
 +	  SND_SOC_INTEL_BYTCR_RT5640_MACH instead for better functionality.
 +
 +config SND_SOC_INTEL_BYT_MAX98090_MACH
 +	tristate "ASoC Audio driver for Intel Baytrail with MAX98090 codec"
 +	depends on X86_INTEL_LPSS && I2C
 +	depends on DMADEVICES
 +	depends on SND_SST_IPC_ACPI = n
 +	select SND_SOC_INTEL_BAYTRAIL
 +	select SND_SOC_MAX98090
 +	help
 +	  This adds audio driver for Intel Baytrail platform based boards
 +	  with the MAX98090 audio codec.
 +
 +config SND_SOC_INTEL_BDW_RT5677_MACH
 +	tristate "ASoC Audio driver for Intel Broadwell with RT5677 codec"
 +	depends on X86_INTEL_LPSS && GPIOLIB && I2C
 +	depends on DMADEVICES
 +	select SND_SOC_INTEL_HASWELL
 +	select SND_SOC_RT5677
 +	help
 +	  This adds support for Intel Broadwell platform based boards with
 +	  the RT5677 audio codec.
 +
 +config SND_SOC_INTEL_BROADWELL_MACH
 +	tristate "ASoC Audio DSP support for Intel Broadwell Wildcatpoint"
 +	depends on X86_INTEL_LPSS && I2C && I2C_DESIGNWARE_PLATFORM
 +	depends on DMADEVICES
 +	select SND_SOC_INTEL_HASWELL
 +	select SND_SOC_RT286
 +	help
 +	  This adds support for the Wilcatpoint Audio DSP on Intel(R) Broadwell
 +	  Ultrabook platforms.
 +	  Say Y if you have such a device.
 +	  If unsure select "N".
 +
 +config SND_SOC_INTEL_BYTCR_RT5640_MACH
 +        tristate "ASoC Audio driver for Intel Baytrail and Baytrail-CR with RT5640 codec"
 +	depends on X86 && I2C && ACPI
 +	select SND_SOC_RT5640
 +	select SND_SST_ATOM_HIFI2_PLATFORM
 +	select SND_SST_IPC_ACPI
 +	select SND_SOC_INTEL_SST_MATCH if ACPI
 +	help
 +          This adds support for ASoC machine driver for Intel(R) Baytrail and Baytrail-CR
 +          platforms with RT5640 audio codec.
 +          Say Y if you have such a device.
 +          If unsure select "N".
 +
 +config SND_SOC_INTEL_BYTCR_RT5651_MACH
 +        tristate "ASoC Audio driver for Intel Baytrail and Baytrail-CR with RT5651 codec"
 +	depends on X86 && I2C && ACPI
 +	select SND_SOC_RT5651
 +	select SND_SST_ATOM_HIFI2_PLATFORM
 +	select SND_SST_IPC_ACPI
 +	select SND_SOC_INTEL_SST_MATCH if ACPI
 +	help
 +          This adds support for ASoC machine driver for Intel(R) Baytrail and Baytrail-CR
 +          platforms with RT5651 audio codec.
 +          Say Y if you have such a device.
 +          If unsure select "N".
 +
 +config SND_SOC_INTEL_CHT_BSW_RT5672_MACH
 +        tristate "ASoC Audio driver for Intel Cherrytrail & Braswell with RT5672 codec"
 +        depends on X86_INTEL_LPSS && I2C && ACPI
 +        select SND_SOC_RT5670
 +        select SND_SST_ATOM_HIFI2_PLATFORM
 +        select SND_SST_IPC_ACPI
 +	select SND_SOC_INTEL_SST_MATCH if ACPI
 +        help
 +          This adds support for ASoC machine driver for Intel(R) Cherrytrail & Braswell
 +          platforms with RT5672 audio codec.
 +          Say Y if you have such a device.
 +          If unsure select "N".
 +
 +config SND_SOC_INTEL_CHT_BSW_RT5645_MACH
 +	tristate "ASoC Audio driver for Intel Cherrytrail & Braswell with RT5645/5650 codec"
 +	depends on X86_INTEL_LPSS && I2C && ACPI
 +	select SND_SOC_RT5645
 +	select SND_SST_ATOM_HIFI2_PLATFORM
 +	select SND_SST_IPC_ACPI
 +	select SND_SOC_INTEL_SST_MATCH if ACPI
 +	help
 +	  This adds support for ASoC machine driver for Intel(R) Cherrytrail & Braswell
 +	  platforms with RT5645/5650 audio codec.
 +	  If unsure select "N".
 +
 +config SND_SOC_INTEL_CHT_BSW_MAX98090_TI_MACH
 +	tristate "ASoC Audio driver for Intel Cherrytrail & Braswell with MAX98090 & TI codec"
 +	depends on X86_INTEL_LPSS && I2C && ACPI
 +	select SND_SOC_MAX98090
 +	select SND_SOC_TS3A227E
 +	select SND_SST_ATOM_HIFI2_PLATFORM
 +	select SND_SST_IPC_ACPI
 +	select SND_SOC_INTEL_SST_MATCH if ACPI
 +	help
 +	  This adds support for ASoC machine driver for Intel(R) Cherrytrail & Braswell
 +	  platforms with MAX98090 audio codec it also can support TI jack chip as aux device.
 +	  If unsure select "N".
 +
 +config SND_SOC_INTEL_BYT_CHT_DA7213_MACH
 +	tristate "ASoC Audio driver for Intel Baytrail & Cherrytrail with DA7212/7213 codec"
 +	depends on X86_INTEL_LPSS && I2C && ACPI
 +	select SND_SOC_DA7213
 +	select SND_SST_ATOM_HIFI2_PLATFORM
 +	select SND_SST_IPC_ACPI
 +	select SND_SOC_INTEL_SST_MATCH if ACPI
 +	help
 +	  This adds support for ASoC machine driver for Intel(R) Baytrail & CherryTrail
 +	  platforms with DA7212/7213 audio codec.
 +	  If unsure select "N".
 +
 +config SND_SOC_INTEL_BYT_CHT_ES8316_MACH
 +	tristate "ASoC Audio driver for Intel Baytrail & Cherrytrail with ES8316 codec"
 +	depends on X86_INTEL_LPSS && I2C && ACPI
 +	select SND_SOC_ES8316
 +	select SND_SST_ATOM_HIFI2_PLATFORM
 +	select SND_SST_IPC_ACPI
 +	select SND_SOC_INTEL_SST_MATCH if ACPI
 +	help
 +	  This adds support for ASoC machine driver for Intel(R) Baytrail &
 +	  Cherrytrail platforms with ES8316 audio codec.
 +	  If unsure select "N".
 +
 +config SND_SOC_INTEL_BYT_CHT_NOCODEC_MACH
 +	tristate "ASoC Audio driver for Intel Baytrail & Cherrytrail platform with no codec (MinnowBoard MAX, Up)"
 +	depends on X86_INTEL_LPSS && I2C && ACPI
 +	select SND_SST_ATOM_HIFI2_PLATFORM
 +	select SND_SST_IPC_ACPI
 +	select SND_SOC_INTEL_SST_MATCH if ACPI
 +	help
 +	  This adds support for ASoC machine driver for the MinnowBoard Max or
 +	  Up boards and provides access to I2S signals on the Low-Speed
 +	  connector
 +	  If unsure select "N".
 +
 +config SND_SOC_INTEL_KBL_RT5663_MAX98927_MACH
 +	tristate "ASoC Audio driver for KBL with RT5663 and MAX98927 in I2S Mode"
 +	depends on X86_INTEL_LPSS && I2C
 +	select SND_SOC_INTEL_SST
 +	select SND_SOC_INTEL_SKYLAKE
 +	select SND_SOC_RT5663
 +	select SND_SOC_MAX98927
 +	select SND_SOC_DMIC
 +	select SND_SOC_HDAC_HDMI
 +	help
 +	  This adds support for ASoC Onboard Codec I2S machine driver. This will
 +	  create an alsa sound card for RT5663 + MAX98927.
 +	  Say Y if you have such a device.
 +	  If unsure select "N".
 +
 +config SND_SOC_INTEL_KBL_RT5663_RT5514_MAX98927_MACH
 +        tristate "ASoC Audio driver for KBL with RT5663, RT5514 and MAX98927 in I2S Mode"
 +        depends on X86_INTEL_LPSS && I2C && SPI
 +        select SND_SOC_INTEL_SST
 +        select SND_SOC_INTEL_SKYLAKE
 +        select SND_SOC_RT5663
 +        select SND_SOC_RT5514
 +        select SND_SOC_RT5514_SPI
 +        select SND_SOC_MAX98927
 +        select SND_SOC_HDAC_HDMI
 +        help
 +          This adds support for ASoC Onboard Codec I2S machine driver. This will
 +          create an alsa sound card for RT5663 + RT5514 + MAX98927.
 +          Say Y if you have such a device.
 +          If unsure select "N".
 +
 +config SND_SOC_INTEL_SKYLAKE_SSP_CLK
 +	tristate
 +
 +config SND_SOC_INTEL_SKYLAKE
 +	tristate
++=======
+ config SND_SST_ATOM_HIFI2_PLATFORM
+ 	tristate "Intel ASoC SST driver for HiFi2 platforms (*field, *trail)"
+ 	depends on X86
+ 	select SND_SOC_COMPRESS
+ 	select SND_SOC_ACPI_INTEL_MATCH
+ 
+ config SND_SOC_INTEL_SKYLAKE
+ 	tristate "Intel ASoC SST driver for SKL/BXT/KBL/GLK/CNL"
+ 	depends on PCI && ACPI
++>>>>>>> c6059879be29 (ASoC: Intel: Fix Kconfig with top-level selector)
  	select SND_HDA_EXT_CORE
  	select SND_HDA_DSP_LOADER
  	select SND_SOC_TOPOLOGY
  	select SND_SOC_INTEL_SST
+ 	select SND_SOC_ACPI_INTEL_MATCH
+ 	help
+ 	  If you have a Intel Skylake/Broxton/ApolloLake/KabyLake/
+ 	  GeminiLake or CannonLake platform with the DSP enabled in the BIOS
+ 	  then enable this option by saying Y or m.
+ 
+ config SND_SOC_ACPI_INTEL_MATCH
+ 	tristate
+ 	select SND_SOC_ACPI if ACPI
+ 	# this option controls the compilation of ACPI matching tables and
+ 	# helpers and is not meant to be selected by the user.
+ 
+ endif ## SND_SOC_INTEL_SST_TOPLEVEL
  
 -# ASoC codec drivers
 -source "sound/soc/intel/boards/Kconfig"
 +config SND_SOC_INTEL_SKL_RT286_MACH
 +	tristate "ASoC Audio driver for SKL with RT286 I2S mode"
 +	depends on X86 && ACPI && I2C
 +	select SND_SOC_INTEL_SKYLAKE
 +	select SND_SOC_RT286
 +	select SND_SOC_DMIC
 +	select SND_SOC_HDAC_HDMI
 +	help
 +	   This adds support for ASoC machine driver for Skylake platforms
 +	   with RT286 I2S audio codec.
 +	   Say Y if you have such a device.
 +	   If unsure select "N".
 +
 +config SND_SOC_INTEL_SKL_NAU88L25_SSM4567_MACH
 +	tristate "ASoC Audio driver for SKL with NAU88L25 and SSM4567 in I2S Mode"
 +	depends on X86_INTEL_LPSS && I2C
 +	select SND_SOC_INTEL_SKYLAKE
 +	select SND_SOC_NAU8825
 +	select SND_SOC_SSM4567
 +	select SND_SOC_DMIC
 +	select SND_SOC_HDAC_HDMI
 +	help
 +	  This adds support for ASoC Onboard Codec I2S machine driver. This will
 +	  create an alsa sound card for NAU88L25 + SSM4567.
 +	  Say Y if you have such a device.
 +	  If unsure select "N".
 +
 +config SND_SOC_INTEL_SKL_NAU88L25_MAX98357A_MACH
 +	tristate "ASoC Audio driver for SKL with NAU88L25 and MAX98357A in I2S Mode"
 +	depends on X86_INTEL_LPSS && I2C
 +	select SND_SOC_INTEL_SKYLAKE
 +	select SND_SOC_NAU8825
 +	select SND_SOC_MAX98357A
 +	select SND_SOC_DMIC
 +	select SND_SOC_HDAC_HDMI
 +	help
 +	  This adds support for ASoC Onboard Codec I2S machine driver. This will
 +	  create an alsa sound card for NAU88L25 + MAX98357A.
 +	  Say Y if you have such a device.
 +	  If unsure select "N".
diff --cc sound/soc/intel/Makefile
index cdd495f7ee2c,8160520fd74c..000000000000
--- a/sound/soc/intel/Makefile
+++ b/sound/soc/intel/Makefile
@@@ -1,5 -1,6 +1,9 @@@
 -# SPDX-License-Identifier: GPL-2.0
  # Core support
++<<<<<<< HEAD
 +obj-$(CONFIG_SND_SOC_INTEL_SST) += common/
++=======
+ obj-$(CONFIG_SND_SOC) += common/
++>>>>>>> c6059879be29 (ASoC: Intel: Fix Kconfig with top-level selector)
  
  # Platform Support
  obj-$(CONFIG_SND_SOC_INTEL_HASWELL) += haswell/
* Unmerged path sound/soc/intel/boards/Kconfig
* Unmerged path sound/soc/intel/Kconfig
* Unmerged path sound/soc/intel/Makefile
* Unmerged path sound/soc/intel/boards/Kconfig
