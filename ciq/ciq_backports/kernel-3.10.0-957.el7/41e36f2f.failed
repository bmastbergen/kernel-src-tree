platform/x86: dell-smbios: Link all dell-smbios-* modules together

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
Rebuild_CHGLOG: - [platform] x86: dell-smbios: Link all dell-smbios-* modules together (Jarod Wilson) [1517197]
Rebuild_FUZZ: 92.68%
commit-author Mario Limonciello <mario.limonciello@dell.com>
commit 41e36f2f85af758fd2f4be76112ebe649d07a801
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/41e36f2f.failed

Some race conditions were raised due to dell-smbios and its backends
not being ready by the time that a consumer would call one of the
exported methods.

To avoid this problem, guarantee that all initialization has been
done by linking them all together and running init for them all.

As part of this change the Kconfig needs to be adjusted so that
CONFIG_DELL_SMBIOS_SMM and CONFIG_DELL_SMBIOS_WMI are boolean
rather than modules.

CONFIG_DELL_SMBIOS is a visually selectable option again and both
CONFIG_DELL_SMBIOS_WMI and CONFIG_DELL_SMBIOS_SMM are optional.

	Signed-off-by: Mario Limonciello <mario.limonciello@dell.com>
[dvhart: Update prompt and help text for DELL_SMBIOS_* backends]
	Signed-off-by: Darren Hart (VMware) <dvhart@infradead.org>
(cherry picked from commit 41e36f2f85af758fd2f4be76112ebe649d07a801)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/platform/x86/Kconfig
#	drivers/platform/x86/Makefile
#	drivers/platform/x86/dell-smbios-smm.c
#	drivers/platform/x86/dell-smbios-wmi.c
#	drivers/platform/x86/dell-smbios.c
diff --cc drivers/platform/x86/Kconfig
index cd2842518f6d,e3f682c669f5..000000000000
--- a/drivers/platform/x86/Kconfig
+++ b/drivers/platform/x86/Kconfig
@@@ -79,26 -105,38 +79,57 @@@ config ASUS_LAPTO
  
  	  If you have an ACPI-compatible ASUS laptop, say Y or M here.
  
 +config CHROMEOS_LAPTOP
 +	tristate "Chrome OS Laptop"
 +	depends on I2C
 +	depends on DMI
 +	---help---
 +	  This driver instantiates i2c and smbus devices such as
 +	  light sensors and touchpads.
 +
 +	  If you have a supported Chromebook, choose Y or M here.
 +	  The module will be called chromeos_laptop.
 +
  config DELL_SMBIOS
++<<<<<<< HEAD
 +	tristate "Dell SMBIOS Support"
++=======
+ 	tristate "Dell SMBIOS driver"
+ 	---help---
+ 	This provides support for the Dell SMBIOS calling interface.
+ 	If you have a Dell computer you should enable this option.
+ 
+ 	Be sure to select at least one backend for it to work properly.
+ 
+ config DELL_SMBIOS_WMI
+ 	bool "Dell SMBIOS driver WMI backend"
+ 	depends on ACPI_WMI
+ 	select DELL_WMI_DESCRIPTOR
+ 	select DELL_SMBIOS
+ 	---help---
+ 	This provides an implementation for the Dell SMBIOS calling interface
+ 	communicated over ACPI-WMI.
+ 
+ 	If you have a Dell computer from >2007 you should say Y here.
+ 	If you aren't sure and this module doesn't work for your computer
+ 	it just won't load.
+ 
+ config DELL_SMBIOS_SMM
+ 	bool "Dell SMBIOS driver SMM backend"
++>>>>>>> 41e36f2f85af (platform/x86: dell-smbios: Link all dell-smbios-* modules together)
  	depends on DCDBAS
 -	select DELL_SMBIOS
 +	default n
  	---help---
 -	This provides an implementation for the Dell SMBIOS calling interface
 -	communicated over SMI/SMM.
 +	This module provides common functions for kernel modules using
 +	Dell SMBIOS.
  
++<<<<<<< HEAD
 +	If you have a Dell laptop, say Y or M here.
++=======
+ 	If you have a Dell computer from <=2017 you should say Y here.
+ 	If you aren't sure and this module doesn't work for your computer
+ 	it just won't load.
++>>>>>>> 41e36f2f85af (platform/x86: dell-smbios: Link all dell-smbios-* modules together)
  
  config DELL_LAPTOP
  	tristate "Dell Laptop Extras"
diff --cc drivers/platform/x86/Makefile
index 10e380206af4,2ba6cb795338..000000000000
--- a/drivers/platform/x86/Makefile
+++ b/drivers/platform/x86/Makefile
@@@ -11,9 -13,14 +11,15 @@@ obj-$(CONFIG_MSI_LAPTOP)	+= msi-laptop.
  obj-$(CONFIG_ACPI_CMPC)		+= classmate-laptop.o
  obj-$(CONFIG_COMPAL_LAPTOP)	+= compal-laptop.o
  obj-$(CONFIG_DELL_SMBIOS)	+= dell-smbios.o
++<<<<<<< HEAD
++=======
+ dell-smbios-objs		:= dell-smbios-base.o
+ dell-smbios-$(CONFIG_DELL_SMBIOS_WMI)	+= dell-smbios-wmi.o
+ dell-smbios-$(CONFIG_DELL_SMBIOS_SMM)	+= dell-smbios-smm.o
++>>>>>>> 41e36f2f85af (platform/x86: dell-smbios: Link all dell-smbios-* modules together)
  obj-$(CONFIG_DELL_LAPTOP)	+= dell-laptop.o
  obj-$(CONFIG_DELL_WMI)		+= dell-wmi.o
 -obj-$(CONFIG_DELL_WMI_DESCRIPTOR)	+= dell-wmi-descriptor.o
  obj-$(CONFIG_DELL_WMI_AIO)	+= dell-wmi-aio.o
 -obj-$(CONFIG_DELL_WMI_LED)	+= dell-wmi-led.o
  obj-$(CONFIG_DELL_SMO8800)	+= dell-smo8800.o
  obj-$(CONFIG_DELL_RBTN)		+= dell-rbtn.o
  obj-$(CONFIG_ACER_WMI)		+= acer-wmi.o
diff --cc drivers/platform/x86/dell-smbios.c
index 0fd8b868847b,5bcf8a18f785..000000000000
--- a/drivers/platform/x86/dell-smbios.c
+++ b/drivers/platform/x86/dell-smbios.c
@@@ -409,6 -625,9 +425,12 @@@ fail_buffer
  
  static void __exit dell_smbios_exit(void)
  {
++<<<<<<< HEAD:drivers/platform/x86/dell-smbios.c
++=======
+ 	exit_dell_smbios_wmi();
+ 	exit_dell_smbios_smm();
+ 	mutex_lock(&smbios_mutex);
++>>>>>>> 41e36f2f85af (platform/x86: dell-smbios: Link all dell-smbios-* modules together):drivers/platform/x86/dell-smbios-base.c
  	if (platform_device) {
  		free_group(platform_device);
  		platform_device_unregister(platform_device);
* Unmerged path drivers/platform/x86/dell-smbios-smm.c
* Unmerged path drivers/platform/x86/dell-smbios-wmi.c
* Unmerged path drivers/platform/x86/Kconfig
* Unmerged path drivers/platform/x86/Makefile
* Unmerged path drivers/platform/x86/dell-smbios-smm.c
* Unmerged path drivers/platform/x86/dell-smbios-wmi.c
* Unmerged path drivers/platform/x86/dell-smbios.c
diff --git a/drivers/platform/x86/dell-smbios.h b/drivers/platform/x86/dell-smbios.h
index 742dd8bd66b9..e9863cfa3c68 100644
--- a/drivers/platform/x86/dell-smbios.h
+++ b/drivers/platform/x86/dell-smbios.h
@@ -54,4 +54,29 @@ int dell_laptop_register_notifier(struct notifier_block *nb);
 int dell_laptop_unregister_notifier(struct notifier_block *nb);
 void dell_laptop_call_notifier(unsigned long action, void *data);
 
-#endif
+/* for the supported backends */
+#ifdef CONFIG_DELL_SMBIOS_WMI
+int init_dell_smbios_wmi(void);
+void exit_dell_smbios_wmi(void);
+#else /* CONFIG_DELL_SMBIOS_WMI */
+static inline int init_dell_smbios_wmi(void)
+{
+	return -ENODEV;
+}
+static inline void exit_dell_smbios_wmi(void)
+{}
+#endif /* CONFIG_DELL_SMBIOS_WMI */
+
+#ifdef CONFIG_DELL_SMBIOS_SMM
+int init_dell_smbios_smm(void);
+void exit_dell_smbios_smm(void);
+#else /* CONFIG_DELL_SMBIOS_SMM */
+static inline int init_dell_smbios_smm(void)
+{
+	return -ENODEV;
+}
+static inline void exit_dell_smbios_smm(void)
+{}
+#endif /* CONFIG_DELL_SMBIOS_SMM */
+
+#endif /* _DELL_SMBIOS_H_ */
