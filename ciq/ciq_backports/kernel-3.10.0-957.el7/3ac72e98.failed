drm/nouveau/gr/gf100-: virtualise init_ds_hww_esr_2

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
commit-author Ben Skeggs <bskeggs@redhat.com>
commit 3ac72e98b40ead6225eb38bcf78ec540357106c0
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/3ac72e98.failed

	Signed-off-by: Ben Skeggs <bskeggs@redhat.com>
(cherry picked from commit 3ac72e98b40ead6225eb38bcf78ec540357106c0)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/gpu/drm/nouveau/nvkm/engine/gr/gf100.c
#	drivers/gpu/drm/nouveau/nvkm/engine/gr/gf100.h
#	drivers/gpu/drm/nouveau/nvkm/engine/gr/gm200.c
#	drivers/gpu/drm/nouveau/nvkm/engine/gr/gp100.c
#	drivers/gpu/drm/nouveau/nvkm/engine/gr/gp102.c
#	drivers/gpu/drm/nouveau/nvkm/engine/gr/gp107.c
#	drivers/gpu/drm/nouveau/nvkm/engine/gr/gp10b.c
diff --cc drivers/gpu/drm/nouveau/nvkm/engine/gr/gf100.c
index 38a5ff7dd3aa,1f764df141bd..000000000000
--- a/drivers/gpu/drm/nouveau/nvkm/engine/gr/gf100.c
+++ b/drivers/gpu/drm/nouveau/nvkm/engine/gr/gf100.c
@@@ -1966,7 -2017,10 +1966,14 @@@ gf100_gr_init(struct gf100_gr *gr
  	nvkm_wr32(device, 0x40013c, 0xffffffff);
  	nvkm_wr32(device, 0x400124, 0x00000002);
  
++<<<<<<< HEAD
 +	nvkm_wr32(device, 0x409c24, 0x000f0000);
++=======
+ 	gr->func->init_fecs_exceptions(gr);
+ 	if (gr->func->init_ds_hww_esr_2)
+ 		gr->func->init_ds_hww_esr_2(gr);
+ 
++>>>>>>> 3ac72e98b40e (drm/nouveau/gr/gf100-: virtualise init_ds_hww_esr_2)
  	nvkm_wr32(device, 0x404000, 0xc0000000);
  	nvkm_wr32(device, 0x404600, 0xc0000000);
  	nvkm_wr32(device, 0x408030, 0xc0000000);
diff --cc drivers/gpu/drm/nouveau/nvkm/engine/gr/gf100.h
index a36e45a4a635,ff3e265925c5..000000000000
--- a/drivers/gpu/drm/nouveau/nvkm/engine/gr/gf100.h
+++ b/drivers/gpu/drm/nouveau/nvkm/engine/gr/gf100.h
@@@ -122,10 -122,17 +122,17 @@@ struct gf100_gr_func 
  	void (*dtor)(struct gf100_gr *);
  	int (*init)(struct gf100_gr *);
  	void (*init_gpc_mmu)(struct gf100_gr *);
 -	void (*init_r405a14)(struct gf100_gr *);
 -	void (*init_bios)(struct gf100_gr *);
 -	void (*init_vsc_stream_master)(struct gf100_gr *);
 -	void (*init_zcull)(struct gf100_gr *);
 -	void (*init_num_active_ltcs)(struct gf100_gr *);
  	void (*init_rop_active_fbps)(struct gf100_gr *);
++<<<<<<< HEAD
++=======
+ 	void (*init_bios_2)(struct gf100_gr *);
+ 	void (*init_swdx_pes_mask)(struct gf100_gr *);
+ 	void (*init_fecs_exceptions)(struct gf100_gr *);
+ 	void (*init_ds_hww_esr_2)(struct gf100_gr *);
++>>>>>>> 3ac72e98b40e (drm/nouveau/gr/gf100-: virtualise init_ds_hww_esr_2)
  	void (*init_ppc_exceptions)(struct gf100_gr *);
 +	void (*init_swdx_pes_mask)(struct gf100_gr *);
 +	void (*init_num_active_ltcs)(struct gf100_gr *);
  	void (*set_hww_esr_report_mask)(struct gf100_gr *);
  	const struct gf100_gr_pack *mmio;
  	struct {
@@@ -149,8 -164,9 +156,13 @@@ void gk104_gr_init_ppc_exceptions(struc
  
  int gk20a_gr_init(struct gf100_gr *);
  
 +int gm200_gr_init(struct gf100_gr *);
  int gm200_gr_rops(struct gf100_gr *);
++<<<<<<< HEAD
++=======
+ void gm200_gr_init_num_active_ltcs(struct gf100_gr *);
+ void gm200_gr_init_ds_hww_esr_2(struct gf100_gr *);
++>>>>>>> 3ac72e98b40e (drm/nouveau/gr/gf100-: virtualise init_ds_hww_esr_2)
  
  int gp100_gr_init(struct gf100_gr *);
  void gp100_gr_init_rop_active_fbps(struct gf100_gr *);
diff --cc drivers/gpu/drm/nouveau/nvkm/engine/gr/gm200.c
index 6435f1257572,b5994dca5d03..000000000000
--- a/drivers/gpu/drm/nouveau/nvkm/engine/gr/gm200.c
+++ b/drivers/gpu/drm/nouveau/nvkm/engine/gr/gm200.c
@@@ -39,6 -39,22 +39,25 @@@ gm200_gr_rops(struct gf100_gr *gr
  }
  
  void
++<<<<<<< HEAD
++=======
+ gm200_gr_init_ds_hww_esr_2(struct gf100_gr *gr)
+ {
+ 	struct nvkm_device *device = gr->base.engine.subdev.device;
+ 	nvkm_wr32(device, 0x405848, 0xc0000000);
+ 	nvkm_mask(device, 0x40584c, 0x00000001, 0x00000001);
+ }
+ 
+ void
+ gm200_gr_init_num_active_ltcs(struct gf100_gr *gr)
+ {
+ 	struct nvkm_device *device = gr->base.engine.subdev.device;
+ 	nvkm_wr32(device, GPC_BCAST(0x08ac), nvkm_rd32(device, 0x100800));
+ 	nvkm_wr32(device, GPC_BCAST(0x033c), nvkm_rd32(device, 0x100804));
+ }
+ 
+ void
++>>>>>>> 3ac72e98b40e (drm/nouveau/gr/gf100-: virtualise init_ds_hww_esr_2)
  gm200_gr_init_gpc_mmu(struct gf100_gr *gr)
  {
  	struct nvkm_device *device = gr->base.engine.subdev.device;
@@@ -113,9 -99,8 +132,14 @@@ gm200_gr_init(struct gf100_gr *gr
  	nvkm_wr32(device, 0x400100, 0xffffffff);
  	nvkm_wr32(device, 0x40013c, 0xffffffff);
  	nvkm_wr32(device, 0x400124, 0x00000002);
++<<<<<<< HEAD
 +	nvkm_wr32(device, 0x409c24, 0x000e0000);
 +	nvkm_wr32(device, 0x405848, 0xc0000000);
 +	nvkm_wr32(device, 0x40584c, 0x00000001);
++=======
+ 	gr->func->init_fecs_exceptions(gr);
+ 	gr->func->init_ds_hww_esr_2(gr);
++>>>>>>> 3ac72e98b40e (drm/nouveau/gr/gf100-: virtualise init_ds_hww_esr_2)
  	nvkm_wr32(device, 0x404000, 0xc0000000);
  	nvkm_wr32(device, 0x404600, 0xc0000000);
  	nvkm_wr32(device, 0x408030, 0xc0000000);
@@@ -210,7 -195,13 +234,12 @@@ static const struct gf100_gr_fun
  gm200_gr = {
  	.init = gm200_gr_init,
  	.init_gpc_mmu = gm200_gr_init_gpc_mmu,
 -	.init_bios = gm107_gr_init_bios,
 -	.init_vsc_stream_master = gk104_gr_init_vsc_stream_master,
 -	.init_zcull = gf117_gr_init_zcull,
 -	.init_num_active_ltcs = gm200_gr_init_num_active_ltcs,
  	.init_rop_active_fbps = gm200_gr_init_rop_active_fbps,
++<<<<<<< HEAD
++=======
+ 	.init_fecs_exceptions = gf100_gr_init_fecs_exceptions,
+ 	.init_ds_hww_esr_2 = gm200_gr_init_ds_hww_esr_2,
++>>>>>>> 3ac72e98b40e (drm/nouveau/gr/gf100-: virtualise init_ds_hww_esr_2)
  	.init_ppc_exceptions = gk104_gr_init_ppc_exceptions,
  	.rops = gm200_gr_rops,
  	.ppc_nr = 2,
diff --cc drivers/gpu/drm/nouveau/nvkm/engine/gr/gp100.c
index 867a5f7cc5bc,676f58a9acee..000000000000
--- a/drivers/gpu/drm/nouveau/nvkm/engine/gr/gp100.c
+++ b/drivers/gpu/drm/nouveau/nvkm/engine/gr/gp100.c
@@@ -100,9 -69,8 +100,14 @@@ gp100_gr_init(struct gf100_gr *gr
  	nvkm_wr32(device, 0x400100, 0xffffffff);
  	nvkm_wr32(device, 0x40013c, 0xffffffff);
  	nvkm_wr32(device, 0x400124, 0x00000002);
++<<<<<<< HEAD
 +	nvkm_wr32(device, 0x409c24, 0x000f0002);
 +	nvkm_wr32(device, 0x405848, 0xc0000000);
 +	nvkm_mask(device, 0x40584c, 0x00000000, 0x00000001);
++=======
+ 	gr->func->init_fecs_exceptions(gr);
+ 	gr->func->init_ds_hww_esr_2(gr);
++>>>>>>> 3ac72e98b40e (drm/nouveau/gr/gf100-: virtualise init_ds_hww_esr_2)
  	nvkm_wr32(device, 0x404000, 0xc0000000);
  	nvkm_wr32(device, 0x404600, 0xc0000000);
  	nvkm_wr32(device, 0x408030, 0xc0000000);
@@@ -160,9 -128,13 +165,14 @@@ static const struct gf100_gr_fun
  gp100_gr = {
  	.init = gp100_gr_init,
  	.init_gpc_mmu = gm200_gr_init_gpc_mmu,
 -	.init_vsc_stream_master = gk104_gr_init_vsc_stream_master,
 -	.init_zcull = gf117_gr_init_zcull,
 -	.init_num_active_ltcs = gm200_gr_init_num_active_ltcs,
  	.init_rop_active_fbps = gp100_gr_init_rop_active_fbps,
++<<<<<<< HEAD
++=======
+ 	.init_fecs_exceptions = gp100_gr_init_fecs_exceptions,
+ 	.init_ds_hww_esr_2 = gm200_gr_init_ds_hww_esr_2,
++>>>>>>> 3ac72e98b40e (drm/nouveau/gr/gf100-: virtualise init_ds_hww_esr_2)
  	.init_ppc_exceptions = gk104_gr_init_ppc_exceptions,
 +	.init_num_active_ltcs = gp100_gr_init_num_active_ltcs,
  	.rops = gm200_gr_rops,
  	.ppc_nr = 2,
  	.grctx = &gp100_grctx,
diff --cc drivers/gpu/drm/nouveau/nvkm/engine/gr/gp102.c
index 61e3a0b08559,3694687c85db..000000000000
--- a/drivers/gpu/drm/nouveau/nvkm/engine/gr/gp102.c
+++ b/drivers/gpu/drm/nouveau/nvkm/engine/gr/gp102.c
@@@ -44,10 -44,14 +44,16 @@@ static const struct gf100_gr_fun
  gp102_gr = {
  	.init = gp100_gr_init,
  	.init_gpc_mmu = gm200_gr_init_gpc_mmu,
 -	.init_vsc_stream_master = gk104_gr_init_vsc_stream_master,
 -	.init_zcull = gf117_gr_init_zcull,
 -	.init_num_active_ltcs = gm200_gr_init_num_active_ltcs,
  	.init_rop_active_fbps = gp100_gr_init_rop_active_fbps,
++<<<<<<< HEAD
++=======
+ 	.init_swdx_pes_mask = gp102_gr_init_swdx_pes_mask,
+ 	.init_fecs_exceptions = gp100_gr_init_fecs_exceptions,
+ 	.init_ds_hww_esr_2 = gm200_gr_init_ds_hww_esr_2,
++>>>>>>> 3ac72e98b40e (drm/nouveau/gr/gf100-: virtualise init_ds_hww_esr_2)
  	.init_ppc_exceptions = gk104_gr_init_ppc_exceptions,
 +	.init_swdx_pes_mask = gp102_gr_init_swdx_pes_mask,
 +	.init_num_active_ltcs = gp100_gr_init_num_active_ltcs,
  	.rops = gm200_gr_rops,
  	.ppc_nr = 3,
  	.grctx = &gp102_grctx,
diff --cc drivers/gpu/drm/nouveau/nvkm/engine/gr/gp107.c
index f7272323f694,c83ad01bad53..000000000000
--- a/drivers/gpu/drm/nouveau/nvkm/engine/gr/gp107.c
+++ b/drivers/gpu/drm/nouveau/nvkm/engine/gr/gp107.c
@@@ -30,10 -30,14 +30,16 @@@ static const struct gf100_gr_fun
  gp107_gr = {
  	.init = gp100_gr_init,
  	.init_gpc_mmu = gm200_gr_init_gpc_mmu,
 -	.init_vsc_stream_master = gk104_gr_init_vsc_stream_master,
 -	.init_zcull = gf117_gr_init_zcull,
 -	.init_num_active_ltcs = gm200_gr_init_num_active_ltcs,
  	.init_rop_active_fbps = gp100_gr_init_rop_active_fbps,
++<<<<<<< HEAD
++=======
+ 	.init_swdx_pes_mask = gp102_gr_init_swdx_pes_mask,
+ 	.init_fecs_exceptions = gp100_gr_init_fecs_exceptions,
+ 	.init_ds_hww_esr_2 = gm200_gr_init_ds_hww_esr_2,
++>>>>>>> 3ac72e98b40e (drm/nouveau/gr/gf100-: virtualise init_ds_hww_esr_2)
  	.init_ppc_exceptions = gk104_gr_init_ppc_exceptions,
 +	.init_swdx_pes_mask = gp102_gr_init_swdx_pes_mask,
 +	.init_num_active_ltcs = gp100_gr_init_num_active_ltcs,
  	.rops = gm200_gr_rops,
  	.ppc_nr = 1,
  	.grctx = &gp107_grctx,
diff --cc drivers/gpu/drm/nouveau/nvkm/engine/gr/gp10b.c
index 5f3d161a0842,8fef3b56cf8c..000000000000
--- a/drivers/gpu/drm/nouveau/nvkm/engine/gr/gp10b.c
+++ b/drivers/gpu/drm/nouveau/nvkm/engine/gr/gp10b.c
@@@ -37,9 -29,13 +37,14 @@@ static const struct gf100_gr_fun
  gp10b_gr = {
  	.init = gp100_gr_init,
  	.init_gpc_mmu = gm200_gr_init_gpc_mmu,
 -	.init_vsc_stream_master = gk104_gr_init_vsc_stream_master,
 -	.init_zcull = gf117_gr_init_zcull,
 -	.init_num_active_ltcs = gf100_gr_init_num_active_ltcs,
  	.init_rop_active_fbps = gp100_gr_init_rop_active_fbps,
++<<<<<<< HEAD
++=======
+ 	.init_fecs_exceptions = gp100_gr_init_fecs_exceptions,
+ 	.init_ds_hww_esr_2 = gm200_gr_init_ds_hww_esr_2,
++>>>>>>> 3ac72e98b40e (drm/nouveau/gr/gf100-: virtualise init_ds_hww_esr_2)
  	.init_ppc_exceptions = gk104_gr_init_ppc_exceptions,
 +	.init_num_active_ltcs = gp10b_gr_init_num_active_ltcs,
  	.rops = gm200_gr_rops,
  	.ppc_nr = 1,
  	.grctx = &gp102_grctx,
* Unmerged path drivers/gpu/drm/nouveau/nvkm/engine/gr/gf100.c
* Unmerged path drivers/gpu/drm/nouveau/nvkm/engine/gr/gf100.h
* Unmerged path drivers/gpu/drm/nouveau/nvkm/engine/gr/gm200.c
* Unmerged path drivers/gpu/drm/nouveau/nvkm/engine/gr/gp100.c
* Unmerged path drivers/gpu/drm/nouveau/nvkm/engine/gr/gp102.c
* Unmerged path drivers/gpu/drm/nouveau/nvkm/engine/gr/gp107.c
* Unmerged path drivers/gpu/drm/nouveau/nvkm/engine/gr/gp10b.c
