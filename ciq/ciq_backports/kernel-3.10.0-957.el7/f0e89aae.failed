scsi: target_core_user: fix double unlock

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
commit-author Mike Christie <mchristi@redhat.com>
commit f0e89aae609bebd430ce7a96d2f642917d89ca57
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/f0e89aae.failed

The caller of queue_cmd_ring grabs and releases the lock, so the
tcmu_setup_cmd_timer failure handling inside queue_cmd_ring should not call
mutex_unlock.

	Signed-off-by: Mike Christie <mchristi@redhat.com>
	Reviewed-by: Xiubo Li <xiubli@redhat.com>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit f0e89aae609bebd430ce7a96d2f642917d89ca57)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/target/target_core_user.c
diff --cc drivers/target/target_core_user.c
index 5534ef1b341c,fafe65fd37f4..000000000000
--- a/drivers/target/target_core_user.c
+++ b/drivers/target/target_core_user.c
@@@ -714,11 -1054,24 +714,24 @@@ tcmu_queue_cmd_ring(struct tcmu_cmd *tc
  
  	/* Handle BIDI commands */
  	iov_cnt = 0;
 -	if (se_cmd->se_cmd_flags & SCF_BIDI) {
 -		iov++;
 -		scatter_data_area(udev, tcmu_cmd, se_cmd->t_bidi_data_sg,
 -				  se_cmd->t_bidi_data_nents, &iov, &iov_cnt,
 -				  false);
 -	}
 +	alloc_and_scatter_data_area(udev, tcmu_cmd->data_bitmap,
 +		se_cmd->t_bidi_data_sg, se_cmd->t_bidi_data_nents, &iov,
 +		&iov_cnt, false);
  	entry->req.iov_bidi_cnt = iov_cnt;
  
++<<<<<<< HEAD
++=======
+ 	ret = tcmu_setup_cmd_timer(tcmu_cmd, udev->cmd_time_out,
+ 				   &udev->cmd_timer);
+ 	if (ret) {
+ 		tcmu_cmd_free_data(tcmu_cmd, tcmu_cmd->dbi_cnt);
+ 
+ 		*scsi_err = TCM_OUT_OF_RESOURCES;
+ 		return -1;
+ 	}
+ 	entry->hdr.cmd_id = tcmu_cmd->cmd_id;
+ 
++>>>>>>> f0e89aae609b (scsi: target_core_user: fix double unlock)
  	/*
  	 * Recalaulate the command's base size and size according
  	 * to the actual needs
* Unmerged path drivers/target/target_core_user.c
