x86/mm: Use encrypted access of boot related data with SEV

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
Rebuild_CHGLOG: - [x86] mm: Use encrypted access of boot related data with SEV (Gary Hook) [1361286]
Rebuild_FUZZ: 96.43%
commit-author Tom Lendacky <thomas.lendacky@amd.com>
commit 072f58c6ce29cf6cf429480fcd1b1e87d1d5ed18
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/072f58c6.failed

When Secure Encrypted Virtualization (SEV) is active, boot data (such as
EFI related data, setup data) is encrypted and needs to be accessed as
such when mapped. Update the architecture override in early_memremap to
keep the encryption attribute when mapping this data.

	Signed-off-by: Tom Lendacky <thomas.lendacky@amd.com>
	Signed-off-by: Brijesh Singh <brijesh.singh@amd.com>
	Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
	Reviewed-by: Borislav Petkov <bp@suse.de>
	Tested-by: Borislav Petkov <bp@suse.de>
	Cc: Laura Abbott <labbott@redhat.com>
	Cc: kvm@vger.kernel.org
	Cc: Matt Fleming <matt@codeblueprint.co.uk>
	Cc: Borislav Petkov <bp@alien8.de>
	Cc: Andy Lutomirski <luto@kernel.org>
	Cc: "Kirill A. Shutemov" <kirill.shutemov@linux.intel.com>
Link: https://lkml.kernel.org/r/20171020143059.3291-6-brijesh.singh@amd.com

(cherry picked from commit 072f58c6ce29cf6cf429480fcd1b1e87d1d5ed18)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/mm/ioremap.c
diff --cc arch/x86/mm/ioremap.c
index 30ab4df60805,52cc0f4ed494..000000000000
--- a/arch/x86/mm/ioremap.c
+++ b/arch/x86/mm/ioremap.c
@@@ -399,11 -457,16 +402,24 @@@ static bool memremap_should_map_decrypt
  
  	/* Check if the address is outside kernel usable area */
  	switch (e820__get_entry_type(phys_addr, phys_addr + size - 1)) {
++<<<<<<< HEAD
 +	case E820_RESERVED:
 +	case E820_ACPI:
 +	case E820_NVS:
 +	case E820_UNUSABLE:
 +	case E820_PRAM:
++=======
+ 	case E820_TYPE_RESERVED:
+ 	case E820_TYPE_ACPI:
+ 	case E820_TYPE_NVS:
+ 	case E820_TYPE_UNUSABLE:
+ 		/* For SEV, these areas are encrypted */
+ 		if (sev_active())
+ 			break;
+ 		/* Fallthrough */
+ 
+ 	case E820_TYPE_PRAM:
++>>>>>>> 072f58c6ce29 (x86/mm: Use encrypted access of boot related data with SEV)
  		return true;
  	default:
  		break;
* Unmerged path arch/x86/mm/ioremap.c
