s390: correct module section names for expoline code revert

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
Rebuild_CHGLOG: - [s390] correct module section names for expoline code revert (Hendrik Brueckner) [1583564]
Rebuild_FUZZ: 94.64%
commit-author Martin Schwidefsky <schwidefsky@de.ibm.com>
commit 6cf09958f32b9667bb3ebadf74367c791112771b
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/6cf09958.failed

The main linker script vmlinux.lds.S for the kernel image merges
the expoline code patch tables into two section ".nospec_call_table"
and ".nospec_return_table". This is *not* done for the modules,
there the sections retain their original names as generated by gcc:
".s390_indirect_call", ".s390_return_mem" and ".s390_return_reg".

The module_finalize code has to check for the compiler generated
section names, otherwise no code patching is done. This slows down
the module code in case of "spectre_v2=off".

	Cc: stable@vger.kernel.org # 4.16
Fixes: f19fbd5ed6 ("s390: introduce execute-trampolines for branches")
	Signed-off-by: Martin Schwidefsky <schwidefsky@de.ibm.com>
(cherry picked from commit 6cf09958f32b9667bb3ebadf74367c791112771b)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/s390/kernel/module.c
diff --cc arch/s390/kernel/module.c
index 5fb5da4560c2,0dc8ac8548ee..000000000000
--- a/arch/s390/kernel/module.c
+++ b/arch/s390/kernel/module.c
@@@ -453,7 -455,24 +453,29 @@@ int module_finalize(const Elf_Ehdr *hdr
  		}
  	}
  
++<<<<<<< HEAD
 +	vfree(me->arch.syminfo);
 +	me->arch.syminfo = NULL;
++=======
+ 	secstrings = (void *)hdr + sechdrs[hdr->e_shstrndx].sh_offset;
+ 	for (s = sechdrs; s < sechdrs + hdr->e_shnum; s++) {
+ 		aseg = (void *) s->sh_addr;
+ 		secname = secstrings + s->sh_name;
+ 
+ 		if (!strcmp(".altinstructions", secname))
+ 			/* patch .altinstructions */
+ 			apply_alternatives(aseg, aseg + s->sh_size);
+ 
+ 		if (IS_ENABLED(CONFIG_EXPOLINE) &&
+ 		    (!strncmp(".s390_indirect", secname, 14)))
+ 			nospec_revert(aseg, aseg + s->sh_size);
+ 
+ 		if (IS_ENABLED(CONFIG_EXPOLINE) &&
+ 		    (!strncmp(".s390_return", secname, 12)))
+ 			nospec_revert(aseg, aseg + s->sh_size);
+ 	}
+ 
+ 	jump_label_apply_nops(me);
++>>>>>>> 6cf09958f32b (s390: correct module section names for expoline code revert)
  	return 0;
  }
* Unmerged path arch/s390/kernel/module.c
