ixgbe: setup xdp_rxq_info

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
commit-author Jesper Dangaard Brouer <brouer@redhat.com>
commit 99ffc5ade4e8703c3bc56fa6bb8e25437da09ee9
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/99ffc5ad.failed

Driver hook points for xdp_rxq_info:
 * reg  : ixgbe_setup_rx_resources()
 * unreg: ixgbe_free_rx_resources()

Tested on actual hardware.

V2: Fix ixgbe_set_ringparam, clear xdp_rxq_info in temp_ring

	Cc: intel-wired-lan@lists.osuosl.org
	Cc: Jeff Kirsher <jeffrey.t.kirsher@intel.com>
	Cc: Alexander Duyck <alexander.duyck@gmail.com>
	Signed-off-by: Jesper Dangaard Brouer <brouer@redhat.com>
	Acked-by: John Fastabend <john.fastabend@gmail.com>
	Signed-off-by: Alexei Starovoitov <ast@kernel.org>
(cherry picked from commit 99ffc5ade4e8703c3bc56fa6bb8e25437da09ee9)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/intel/ixgbe/ixgbe_main.c
diff --cc drivers/net/ethernet/intel/ixgbe/ixgbe_main.c
index 68012d164c35,95aba975b391..000000000000
--- a/drivers/net/ethernet/intel/ixgbe/ixgbe_main.c
+++ b/drivers/net/ethernet/intel/ixgbe/ixgbe_main.c
@@@ -2203,6 -2317,10 +2203,13 @@@ static int ixgbe_clean_rx_irq(struct ix
  	unsigned int mss = 0;
  #endif /* IXGBE_FCOE */
  	u16 cleaned_count = ixgbe_desc_unused(rx_ring);
++<<<<<<< HEAD
++=======
+ 	bool xdp_xmit = false;
+ 	struct xdp_buff xdp;
+ 
+ 	xdp.rxq = &rx_ring->xdp_rxq;
++>>>>>>> 99ffc5ade4e8 (ixgbe: setup xdp_rxq_info)
  
  	while (likely(total_rx_packets < budget)) {
  		union ixgbe_adv_rx_desc *rx_desc;
@@@ -6272,6 -6446,13 +6279,16 @@@ int ixgbe_setup_rx_resources(struct ixg
  	rx_ring->next_to_clean = 0;
  	rx_ring->next_to_use = 0;
  
++<<<<<<< HEAD
++=======
+ 	/* XDP RX-queue info */
+ 	if (xdp_rxq_info_reg(&rx_ring->xdp_rxq, adapter->netdev,
+ 			     rx_ring->queue_index) < 0)
+ 		goto err;
+ 
+ 	rx_ring->xdp_prog = adapter->xdp_prog;
+ 
++>>>>>>> 99ffc5ade4e8 (ixgbe: setup xdp_rxq_info)
  	return 0;
  err:
  	vfree(rx_ring->rx_buffer_info);
@@@ -6363,6 -6547,8 +6380,11 @@@ void ixgbe_free_rx_resources(struct ixg
  {
  	ixgbe_clean_rx_ring(rx_ring);
  
++<<<<<<< HEAD
++=======
+ 	rx_ring->xdp_prog = NULL;
+ 	xdp_rxq_info_unreg(&rx_ring->xdp_rxq);
++>>>>>>> 99ffc5ade4e8 (ixgbe: setup xdp_rxq_info)
  	vfree(rx_ring->rx_buffer_info);
  	rx_ring->rx_buffer_info = NULL;
  
diff --git a/drivers/net/ethernet/intel/ixgbe/ixgbe.h b/drivers/net/ethernet/intel/ixgbe/ixgbe.h
index 8921cf91a9de..2607b6cc7e02 100644
--- a/drivers/net/ethernet/intel/ixgbe/ixgbe.h
+++ b/drivers/net/ethernet/intel/ixgbe/ixgbe.h
@@ -53,6 +53,7 @@
 #include <linux/dca.h>
 #endif
 
+#include <net/xdp.h>
 #include <net/busy_poll.h>
 
 /* common prefix used by pr_<> macros */
@@ -359,6 +360,7 @@ struct ixgbe_ring {
 		struct ixgbe_tx_queue_stats tx_stats;
 		struct ixgbe_rx_queue_stats rx_stats;
 	};
+	struct xdp_rxq_info xdp_rxq;
 } ____cacheline_internodealigned_in_smp;
 
 enum ixgbe_ring_f_enum {
diff --git a/drivers/net/ethernet/intel/ixgbe/ixgbe_ethtool.c b/drivers/net/ethernet/intel/ixgbe/ixgbe_ethtool.c
index c62cd6732e1d..ad93585be726 100644
--- a/drivers/net/ethernet/intel/ixgbe/ixgbe_ethtool.c
+++ b/drivers/net/ethernet/intel/ixgbe/ixgbe_ethtool.c
@@ -1131,6 +1131,10 @@ static int ixgbe_set_ringparam(struct net_device *netdev,
 			memcpy(&temp_ring[i], adapter->rx_ring[i],
 			       sizeof(struct ixgbe_ring));
 
+			/* Clear copied XDP RX-queue info */
+			memset(&temp_ring[i].xdp_rxq, 0,
+			       sizeof(temp_ring[i].xdp_rxq));
+
 			temp_ring[i].count = new_rx_count;
 			err = ixgbe_setup_rx_resources(&temp_ring[i]);
 			if (err) {
* Unmerged path drivers/net/ethernet/intel/ixgbe/ixgbe_main.c
