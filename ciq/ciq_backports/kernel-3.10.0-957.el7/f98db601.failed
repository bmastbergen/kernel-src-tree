sched/core: Add switch_mm_irqs_off() and use it in the scheduler

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
commit-author Andy Lutomirski <luto@kernel.org>
commit f98db6013c557c216da5038d9c52045be55cd039
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/f98db601.failed

By default, this is the same thing as switch_mm().

x86 will override it as an optimization.

	Signed-off-by: Andy Lutomirski <luto@kernel.org>
	Reviewed-by: Borislav Petkov <bp@suse.de>
	Cc: Borislav Petkov <bp@alien8.de>
	Cc: Linus Torvalds <torvalds@linux-foundation.org>
	Cc: Peter Zijlstra <peterz@infradead.org>
	Cc: Thomas Gleixner <tglx@linutronix.de>
Link: http://lkml.kernel.org/r/df401df47bdd6be3e389c6f1e3f5310d70e81b2c.1461688545.git.luto@kernel.org
	Signed-off-by: Ingo Molnar <mingo@kernel.org>
(cherry picked from commit f98db6013c557c216da5038d9c52045be55cd039)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	kernel/sched/core.c
diff --cc kernel/sched/core.c
index 0268f967b362,adcafda7ffc8..000000000000
--- a/kernel/sched/core.c
+++ b/kernel/sched/core.c
@@@ -6056,8 -5273,10 +6056,15 @@@ void idle_task_exit(void
  
  	BUG_ON(cpu_online(smp_processor_id()));
  
++<<<<<<< HEAD
 +	if (mm != &init_mm)
 +		switch_mm(mm, &init_mm, current);
++=======
+ 	if (mm != &init_mm) {
+ 		switch_mm_irqs_off(mm, &init_mm, current);
+ 		finish_arch_post_lock_switch();
+ 	}
++>>>>>>> f98db6013c55 (sched/core: Add switch_mm_irqs_off() and use it in the scheduler)
  	mmdrop(mm);
  }
  
diff --git a/include/linux/mmu_context.h b/include/linux/mmu_context.h
index 70fffeba7495..a4441784503b 100644
--- a/include/linux/mmu_context.h
+++ b/include/linux/mmu_context.h
@@ -1,9 +1,16 @@
 #ifndef _LINUX_MMU_CONTEXT_H
 #define _LINUX_MMU_CONTEXT_H
 
+#include <asm/mmu_context.h>
+
 struct mm_struct;
 
 void use_mm(struct mm_struct *mm);
 void unuse_mm(struct mm_struct *mm);
 
+/* Architectures that care about IRQ state in switch_mm can override this. */
+#ifndef switch_mm_irqs_off
+# define switch_mm_irqs_off switch_mm
+#endif
+
 #endif
* Unmerged path kernel/sched/core.c
