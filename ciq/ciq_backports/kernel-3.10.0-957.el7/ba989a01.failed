block: kyber: fix domain token leak during requeue

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
Rebuild_CHGLOG: - [block] kyber: fix domain token leak during requeue (Ming Lei) [1548238]
Rebuild_FUZZ: 92.47%
commit-author Ming Lei <ming.lei@redhat.com>
commit ba989a01469d027861e55c8f1121edadef757797
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/ba989a01.failed

When requeuing request, the domain token should have been freed
before re-inserting the request to io scheduler. Otherwise, the
assigned domain token will be leaked, and IO hang can be caused.

	Cc: Paolo Valente <paolo.valente@linaro.org>
	Cc: Omar Sandoval <osandov@fb.com>
	Cc: stable@vger.kernel.org
	Reviewed-by: Bart Van Assche <bart.vanassche@wdc.com>
	Signed-off-by: Ming Lei <ming.lei@redhat.com>
	Signed-off-by: Jens Axboe <axboe@kernel.dk>
(cherry picked from commit ba989a01469d027861e55c8f1121edadef757797)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	block/kyber-iosched.c
diff --cc block/kyber-iosched.c
index 236dd17397e2,0d6d25e32e1f..000000000000
--- a/block/kyber-iosched.c
+++ b/block/kyber-iosched.c
@@@ -824,19 -824,25 +824,40 @@@ static const struct blk_mq_debugfs_att
  #undef KYBER_HCTX_DOMAIN_ATTRS
  #endif
  
 +static struct elevator_mq_ops kyber_ops = {
 +	.init_sched = kyber_init_sched,
 +	.exit_sched = kyber_exit_sched,
 +	.init_hctx = kyber_init_hctx,
 +	.exit_hctx = kyber_exit_hctx,
 +	.get_request = kyber_get_request,
 +	.put_request = kyber_put_request,
 +	.completed_request = kyber_completed_request,
 +	.dispatch_request = kyber_dispatch_request,
 +	.has_work = kyber_has_work,
 +};
 +
  static struct elevator_type kyber_sched = {
++<<<<<<< HEAD
++=======
+ 	.ops.mq = {
+ 		.init_sched = kyber_init_sched,
+ 		.exit_sched = kyber_exit_sched,
+ 		.init_hctx = kyber_init_hctx,
+ 		.exit_hctx = kyber_exit_hctx,
+ 		.limit_depth = kyber_limit_depth,
+ 		.prepare_request = kyber_prepare_request,
+ 		.finish_request = kyber_finish_request,
+ 		.requeue_request = kyber_finish_request,
+ 		.completed_request = kyber_completed_request,
+ 		.dispatch_request = kyber_dispatch_request,
+ 		.has_work = kyber_has_work,
+ 	},
+ 	.uses_mq = true,
+ #ifdef CONFIG_BLK_DEBUG_FS
+ 	.queue_debugfs_attrs = kyber_queue_debugfs_attrs,
+ 	.hctx_debugfs_attrs = kyber_hctx_debugfs_attrs,
+ #endif
++>>>>>>> ba989a01469d (block: kyber: fix domain token leak during requeue)
  	.elevator_attrs = kyber_sched_attrs,
  	.elevator_name = "kyber",
  	.elevator_owner = THIS_MODULE,
* Unmerged path block/kyber-iosched.c
