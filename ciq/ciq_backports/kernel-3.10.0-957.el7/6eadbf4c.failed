xfs: BMAPX shouldn't barf on inline-format directories

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
commit-author Darrick J. Wong <darrick.wong@oracle.com>
commit 6eadbf4c8ba816c10d1c97bed9aa861d9fd17809
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/6eadbf4c.failed

When we're fulfilling a BMAPX request, jump out early if the data fork
is in local format.  This prevents us from hitting a debugging check in
bmapi_read and barfing errors back to userspace.  The on-disk extent
count check later isn't sufficient for IF_DELALLOC mode because da
extents are in memory and not on disk.

	Signed-off-by: Darrick J. Wong <darrick.wong@oracle.com>
	Reviewed-by: Brian Foster <bfoster@redhat.com>
	Reviewed-by: Christoph Hellwig <hch@lst.de>
(cherry picked from commit 6eadbf4c8ba816c10d1c97bed9aa861d9fd17809)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/xfs/xfs_bmap_util.c
diff --cc fs/xfs/xfs_bmap_util.c
index 20f90814b349,2e8851ee6759..000000000000
--- a/fs/xfs/xfs_bmap_util.c
+++ b/fs/xfs/xfs_bmap_util.c
@@@ -472,10 -568,27 +472,31 @@@ xfs_getbmap
  
  		prealloced = 0;
  		fixlen = 1LL << 32;
++<<<<<<< HEAD
 +	} else {
++=======
+ 		break;
+ 	case XFS_COW_FORK:
+ 		if (ip->i_cformat != XFS_DINODE_FMT_EXTENTS)
+ 			return -EINVAL;
+ 
+ 		if (xfs_get_cowextsz_hint(ip)) {
+ 			prealloced = 1;
+ 			fixlen = mp->m_super->s_maxbytes;
+ 		} else {
+ 			prealloced = 0;
+ 			fixlen = XFS_ISIZE(ip);
+ 		}
+ 		break;
+ 	default:
+ 		/* Local format data forks report no extents. */
+ 		if (ip->i_d.di_format == XFS_DINODE_FMT_LOCAL) {
+ 			bmv->bmv_entries = 0;
+ 			return 0;
+ 		}
++>>>>>>> 6eadbf4c8ba8 (xfs: BMAPX shouldn't barf on inline-format directories)
  		if (ip->i_d.di_format != XFS_DINODE_FMT_EXTENTS &&
- 		    ip->i_d.di_format != XFS_DINODE_FMT_BTREE &&
- 		    ip->i_d.di_format != XFS_DINODE_FMT_LOCAL)
+ 		    ip->i_d.di_format != XFS_DINODE_FMT_BTREE)
  			return -EINVAL;
  
  		if (xfs_get_extsz_hint(ip) ||
* Unmerged path fs/xfs/xfs_bmap_util.c
