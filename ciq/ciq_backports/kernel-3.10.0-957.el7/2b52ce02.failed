mlxsw: spectrum_router: Remove unnecessary prefix lengths from LPM tree

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
commit-author Ido Schimmel <idosch@mellanox.com>
commit 2b52ce02e1d17986ad7da8bc6e96c632dfa73219
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/2b52ce02.failed

In commit fc922bb0dd94 ("mlxsw: spectrum_router: Use one LPM tree for
all virtual routers") I tried to make sure only used prefix lengths are
present in the LPM tree shared between all virtual routers.

However, this optimization had to be removed in commit a69518cf0b4c
("mlxsw: spectrum_router: Avoid expensive lookup during route removal"),
since determining the used prefix lengths required us to traverse all
the active virtual routers, which could result in a hung task depending
on the number of VRFs and whether routes were removed due to abort or
not.

Re-introduce the optimization by moving the prefix usage accounting from
the virtual routers to the LPM tree, as this accounting is only used in
order to determine the tree's structure.

To make the sharing of the trees more explicit, the two trees (for IPv4
and IPv6) are stored in the shared router struct and upon the creation
of a virtual router it is immediately bound to both.

	Signed-off-by: Ido Schimmel <idosch@mellanox.com>
	Signed-off-by: Jiri Pirko <jiri@mellanox.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 2b52ce02e1d17986ad7da8bc6e96c632dfa73219)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlxsw/spectrum_router.c
diff --cc drivers/net/ethernet/mellanox/mlxsw/spectrum_router.c
index 57eda6adde04,91170d940268..000000000000
--- a/drivers/net/ethernet/mellanox/mlxsw/spectrum_router.c
+++ b/drivers/net/ethernet/mellanox/mlxsw/spectrum_router.c
@@@ -731,12 -792,14 +790,17 @@@ static struct mlxsw_sp_vr *mlxsw_sp_vr_
  	int err;
  
  	vr = mlxsw_sp_vr_find_unused(mlxsw_sp);
 -	if (!vr) {
 -		NL_SET_ERR_MSG(extack, "spectrum: Exceeded number of supported virtual routers");
 +	if (!vr)
  		return ERR_PTR(-EBUSY);
++<<<<<<< HEAD
 +	vr->fib4 = mlxsw_sp_fib_create(vr, MLXSW_SP_L3_PROTO_IPV4);
++=======
+ 	}
+ 	vr->fib4 = mlxsw_sp_fib_create(mlxsw_sp, vr, MLXSW_SP_L3_PROTO_IPV4);
++>>>>>>> 2b52ce02e1d1 (mlxsw: spectrum_router: Remove unnecessary prefix lengths from LPM tree)
  	if (IS_ERR(vr->fib4))
  		return ERR_CAST(vr->fib4);
- 	vr->fib6 = mlxsw_sp_fib_create(vr, MLXSW_SP_L3_PROTO_IPV6);
+ 	vr->fib6 = mlxsw_sp_fib_create(mlxsw_sp, vr, MLXSW_SP_L3_PROTO_IPV6);
  	if (IS_ERR(vr->fib6)) {
  		err = PTR_ERR(vr->fib6);
  		goto err_fib6_create;
* Unmerged path drivers/net/ethernet/mellanox/mlxsw/spectrum_router.c
