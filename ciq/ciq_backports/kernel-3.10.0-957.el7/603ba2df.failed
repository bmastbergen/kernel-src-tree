drm/atomic: Check old_plane_state->crtc in drm_atomic_helper_async_check()

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
commit-author Boris Brezillon <boris.brezillon@bootlin.com>
commit 603ba2dfb338b307aebe95fe344c479a59b3a175
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/603ba2df.failed

Async plane update is supposed to work only when updating the FB or FB
position of an already enabled plane. That does not apply to requests
where the plane was previously disabled or assigned to a different
CTRC.

Check old_plane_state->crtc value to make sure async plane update is
allowed.

Fixes: fef9df8b5945 ("drm/atomic: initial support for asynchronous plane update")
	Cc: <stable@vger.kernel.org>
	Signed-off-by: Boris Brezillon <boris.brezillon@bootlin.com>
	Reviewed-by: Eric Anholt <eric@anholt.net>
Link: https://patchwork.freedesktop.org/patch/msgid/20180724133215.31917-1-boris.brezillon@bootlin.com
(cherry picked from commit 603ba2dfb338b307aebe95fe344c479a59b3a175)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/gpu/drm/drm_atomic_helper.c
diff --cc drivers/gpu/drm/drm_atomic_helper.c
index 1f08d597b87a,ff858b890045..000000000000
--- a/drivers/gpu/drm/drm_atomic_helper.c
+++ b/drivers/gpu/drm/drm_atomic_helper.c
@@@ -1399,17 -1520,15 +1399,22 @@@ int drm_atomic_helper_async_check(struc
  			return -EINVAL;
  	}
  
 -	for_each_oldnew_plane_in_state(state, plane, old_plane_state, new_plane_state, i)
 +	for_each_new_plane_in_state(state, __plane, __plane_state, i) {
  		n_planes++;
 +		plane = __plane;
 +		plane_state = __plane_state;
 +	}
  
  	/* FIXME: we support only single plane updates for now */
 -	if (n_planes != 1)
 +	if (!plane || n_planes != 1)
  		return -EINVAL;
  
++<<<<<<< HEAD
 +	if (!plane_state->crtc)
++=======
+ 	if (!new_plane_state->crtc ||
+ 	    old_plane_state->crtc != new_plane_state->crtc)
++>>>>>>> 603ba2dfb338 (drm/atomic: Check old_plane_state->crtc in drm_atomic_helper_async_check())
  		return -EINVAL;
  
  	funcs = plane->helper_private;
* Unmerged path drivers/gpu/drm/drm_atomic_helper.c
