ixgbe: incorrect XDP ring accounting in ethtool tx_frame param

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
commit-author John Fastabend <john.fastabend@gmail.com>
commit 8e679021c5b9465ac5b0d7efd26baab9b10a2dbd
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/8e679021.failed

Changing the TX ring parameters with an XDP program attached may
cause the XDP queues to be cleared and the TX rings to be incorrectly
configured.

Fix by doing correct ring accounting in setup call.

Fixes: 33fdc82f0883 ("ixgbe: add support for XDP_TX action")
	Signed-off-by: John Fastabend <john.fastabend@gmail.com>
	Tested-by: Andrew Bowers <andrewx.bowers@intel.com>
	Signed-off-by: Jeff Kirsher <jeffrey.t.kirsher@intel.com>
(cherry picked from commit 8e679021c5b9465ac5b0d7efd26baab9b10a2dbd)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/intel/ixgbe/ixgbe_ethtool.c
diff --cc drivers/net/ethernet/intel/ixgbe/ixgbe_ethtool.c
index 96974a5d7ded,c3e7a8191128..000000000000
--- a/drivers/net/ethernet/intel/ixgbe/ixgbe_ethtool.c
+++ b/drivers/net/ethernet/intel/ixgbe/ixgbe_ethtool.c
@@@ -1082,7 -1085,8 +1082,12 @@@ static int ixgbe_set_ringparam(struct n
  	}
  
  	/* allocate temporary buffer to store rings in */
++<<<<<<< HEAD
 +	i = max_t(int, adapter->num_tx_queues, adapter->num_rx_queues);
++=======
+ 	i = max_t(int, adapter->num_tx_queues + adapter->num_xdp_queues,
+ 		  adapter->num_rx_queues);
++>>>>>>> 8e679021c5b9 (ixgbe: incorrect XDP ring accounting in ethtool tx_frame param)
  	temp_ring = vmalloc(i * sizeof(struct ixgbe_ring));
  
  	if (!temp_ring) {
@@@ -1114,12 -1118,33 +1119,39 @@@
  			}
  		}
  
++<<<<<<< HEAD
++=======
+ 		for (j = 0; j < adapter->num_xdp_queues; j++, i++) {
+ 			memcpy(&temp_ring[i], adapter->xdp_ring[j],
+ 			       sizeof(struct ixgbe_ring));
+ 
+ 			temp_ring[i].count = new_tx_count;
+ 			err = ixgbe_setup_tx_resources(&temp_ring[i]);
+ 			if (err) {
+ 				while (i) {
+ 					i--;
+ 					ixgbe_free_tx_resources(&temp_ring[i]);
+ 				}
+ 				goto err_setup;
+ 			}
+ 		}
+ 
++>>>>>>> 8e679021c5b9 (ixgbe: incorrect XDP ring accounting in ethtool tx_frame param)
  		for (i = 0; i < adapter->num_tx_queues; i++) {
  			ixgbe_free_tx_resources(adapter->tx_ring[i]);
  
  			memcpy(adapter->tx_ring[i], &temp_ring[i],
  			       sizeof(struct ixgbe_ring));
  		}
++<<<<<<< HEAD
++=======
+ 		for (j = 0; j < adapter->num_xdp_queues; j++, i++) {
+ 			ixgbe_free_tx_resources(adapter->xdp_ring[j]);
+ 
+ 			memcpy(adapter->xdp_ring[j], &temp_ring[i],
+ 			       sizeof(struct ixgbe_ring));
+ 		}
++>>>>>>> 8e679021c5b9 (ixgbe: incorrect XDP ring accounting in ethtool tx_frame param)
  
  		adapter->tx_ring_count = new_tx_count;
  	}
* Unmerged path drivers/net/ethernet/intel/ixgbe/ixgbe_ethtool.c
