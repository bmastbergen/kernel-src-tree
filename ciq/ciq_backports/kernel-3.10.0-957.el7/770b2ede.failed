usbip: Fix USB device hang due to wrong enabling of scatter-gather

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
commit-author Yuyang Du <yuyang.du@intel.com>
commit 770b2edece42fa55bbe7d4cbe53347a07b8968d4
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/770b2ede.failed

The previous USB3 SuperSpeed enabling patches mistakenly enabled
URB scatter-gather chaining, which is actually not supported by
the VHCI HCD. This patch fixes that.

Bugzilla: https://bugzilla.kernel.org/show_bug.cgi?id=197867
Fixes: 03cd00d538a6feb ("usbip: vhci-hcd: Set the vhci structure up to work")
	Reported-by: Juan Zea <juan.zea@qindel.com>
	Signed-off-by: Yuyang Du <yuyang.du@intel.com>
	Cc: stable <stable@vger.kernel.org>
	Acked-by: Shuah Khan <shuahkh@osg.samsung.com>
	Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
(cherry picked from commit 770b2edece42fa55bbe7d4cbe53347a07b8968d4)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/usb/usbip/vhci_hcd.c
diff --cc drivers/usb/usbip/vhci_hcd.c
index dbe084f98bb7,6b3278c4b72a..000000000000
--- a/drivers/usb/usbip/vhci_hcd.c
+++ b/drivers/usb/usbip/vhci_hcd.c
@@@ -954,13 -1098,22 +954,32 @@@ static int hcd_name_to_id(const char *n
  static int vhci_setup(struct usb_hcd *hcd)
  {
  	struct vhci *vhci = *((void **)dev_get_platdata(hcd->self.controller));
++<<<<<<< HEAD
 +	hcd->self.sg_tablesize = ~0;
 +
 +	vhci->vhci_hcd_hs = hcd_to_vhci_hcd(hcd);
 +	vhci->vhci_hcd_hs->vhci = vhci;
 +	hcd->speed = HCD_USB2;
 +	hcd->self.root_hub->speed = USB_SPEED_HIGH;
 +
++=======
+ 	if (usb_hcd_is_primary_hcd(hcd)) {
+ 		vhci->vhci_hcd_hs = hcd_to_vhci_hcd(hcd);
+ 		vhci->vhci_hcd_hs->vhci = vhci;
+ 		/*
+ 		 * Mark the first roothub as being USB 2.0.
+ 		 * The USB 3.0 roothub will be registered later by
+ 		 * vhci_hcd_probe()
+ 		 */
+ 		hcd->speed = HCD_USB2;
+ 		hcd->self.root_hub->speed = USB_SPEED_HIGH;
+ 	} else {
+ 		vhci->vhci_hcd_ss = hcd_to_vhci_hcd(hcd);
+ 		vhci->vhci_hcd_ss->vhci = vhci;
+ 		hcd->speed = HCD_USB3;
+ 		hcd->self.root_hub->speed = USB_SPEED_SUPER;
+ 	}
++>>>>>>> 770b2edece42 (usbip: Fix USB device hang due to wrong enabling of scatter-gather)
  	return 0;
  }
  
* Unmerged path drivers/usb/usbip/vhci_hcd.c
