bpf: split eBPF out of NET

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
commit-author Alexei Starovoitov <ast@plumgrid.com>
commit f89b7755f517cdbb755d7543eef986ee9d54e654
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/f89b7755.failed

introduce two configs:
- hidden CONFIG_BPF to select eBPF interpreter that classic socket filters
  depend on
- visible CONFIG_BPF_SYSCALL (default off) that tracing and sockets can use

that solves several problems:
- tracing and others that wish to use eBPF don't need to depend on NET.
  They can use BPF_SYSCALL to allow loading from userspace or select BPF
  to use it directly from kernel in NET-less configs.
- in 3.18 programs cannot be attached to events yet, so don't force it on
- when the rest of eBPF infra is there in 3.19+, it's still useful to
  switch it off to minimize kernel size

bloat-o-meter on x64 shows:
add/remove: 0/60 grow/shrink: 0/2 up/down: 0/-15601 (-15601)

tested with many different config combinations. Hopefully didn't miss anything.

	Signed-off-by: Alexei Starovoitov <ast@plumgrid.com>
	Acked-by: Daniel Borkmann <dborkman@redhat.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit f89b7755f517cdbb755d7543eef986ee9d54e654)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	kernel/Makefile
#	kernel/bpf/Makefile
#	kernel/bpf/core.c
#	net/Kconfig
diff --cc kernel/Makefile
index 2fb90fa3b53b,17ea6d4a9a24..000000000000
--- a/kernel/Makefile
+++ b/kernel/Makefile
@@@ -112,6 -86,7 +112,10 @@@ obj-$(CONFIG_RING_BUFFER) += trace
  obj-$(CONFIG_TRACEPOINTS) += trace/
  obj-$(CONFIG_IRQ_WORK) += irq_work.o
  obj-$(CONFIG_CPU_PM) += cpu_pm.o
++<<<<<<< HEAD
++=======
+ obj-$(CONFIG_BPF) += bpf/
++>>>>>>> f89b7755f517 (bpf: split eBPF out of NET)
  
  obj-$(CONFIG_PERF_EVENTS) += events/
  
diff --cc net/Kconfig
index 6019eecc5f21,99815b5454bf..000000000000
--- a/net/Kconfig
+++ b/net/Kconfig
@@@ -5,6 -5,8 +5,11 @@@
  menuconfig NET
  	bool "Networking support"
  	select NLATTR
++<<<<<<< HEAD
++=======
+ 	select GENERIC_NET_UTILS
+ 	select BPF
++>>>>>>> f89b7755f517 (bpf: split eBPF out of NET)
  	---help---
  	  Unless you really know what you are doing, you should say Y here.
  	  The reason is that some programs need kernel networking support even
* Unmerged path kernel/bpf/Makefile
* Unmerged path kernel/bpf/core.c
diff --git a/init/Kconfig b/init/Kconfig
index 598b4d05d99c..63ccaf7a7935 100644
--- a/init/Kconfig
+++ b/init/Kconfig
@@ -1273,6 +1273,10 @@ config SYSCTL_ARCH_UNALIGN_ALLOW
 config HAVE_PCSPKR_PLATFORM
 	bool
 
+# interpreter that classic socket filters depend on
+config BPF
+	bool
+
 menuconfig EXPERT
 	bool "Configure standard kernel features (expert users)"
 	# Unhide debug options, to make the on-by-default options visible
@@ -1425,6 +1429,16 @@ config EVENTFD
 
 	  If unsure, say Y.
 
+# syscall, maps, verifier
+config BPF_SYSCALL
+	bool "Enable bpf() system call" if EXPERT
+	select ANON_INODES
+	select BPF
+	default n
+	help
+	  Enable the bpf() system call that allows to manipulate eBPF
+	  programs and maps via file descriptors.
+
 config SHMEM
 	bool "Use full shmem filesystem" if EXPERT
 	default y
* Unmerged path kernel/Makefile
* Unmerged path kernel/bpf/Makefile
* Unmerged path kernel/bpf/core.c
* Unmerged path net/Kconfig
