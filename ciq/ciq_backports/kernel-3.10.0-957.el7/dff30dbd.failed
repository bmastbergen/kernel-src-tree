drm/nouveau/gr/gf100-: virtualise init_swdx_pes_mask

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
commit-author Ben Skeggs <bskeggs@redhat.com>
commit dff30dbd1d9336687ae1aa0b13e326c44f879c4e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/dff30dbd.failed

	Signed-off-by: Ben Skeggs <bskeggs@redhat.com>
(cherry picked from commit dff30dbd1d9336687ae1aa0b13e326c44f879c4e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/gpu/drm/nouveau/nvkm/engine/gr/gf100.c
#	drivers/gpu/drm/nouveau/nvkm/engine/gr/gf100.h
#	drivers/gpu/drm/nouveau/nvkm/engine/gr/gp102.c
#	drivers/gpu/drm/nouveau/nvkm/engine/gr/gp107.c
diff --cc drivers/gpu/drm/nouveau/nvkm/engine/gr/gf100.c
index 5d64fed84507,7ad6ea0533a4..000000000000
--- a/drivers/gpu/drm/nouveau/nvkm/engine/gr/gf100.c
+++ b/drivers/gpu/drm/nouveau/nvkm/engine/gr/gf100.c
@@@ -1945,20 -1962,47 +1945,41 @@@ gf100_gr_init(struct gf100_gr *gr
  	nvkm_wr32(device, GPC_BCAST(0x0988), data[2]);
  	nvkm_wr32(device, GPC_BCAST(0x098c), data[3]);
  
 -	nvkm_wr32(device, GPC_BCAST(0x1bd4), magicgpc918);
 -}
 -
 -void
 -gf100_gr_init_vsc_stream_master(struct gf100_gr *gr)
 -{
 -	struct nvkm_device *device = gr->base.engine.subdev.device;
 -	nvkm_mask(device, TPC_UNIT(0, 0, 0x05c), 0x00000001, 0x00000001);
 -}
 -
 -int
 -gf100_gr_init(struct gf100_gr *gr)
 -{
 -	struct nvkm_device *device = gr->base.engine.subdev.device;
 -	int gpc, tpc, rop;
 -
 -	gr->func->init_gpc_mmu(gr);
 +	for (gpc = 0; gpc < gr->gpc_nr; gpc++) {
 +		nvkm_wr32(device, GPC_UNIT(gpc, 0x0914),
 +			  gr->screen_tile_row_offset << 8 | gr->tpc_nr[gpc]);
 +		nvkm_wr32(device, GPC_UNIT(gpc, 0x0910), 0x00040000 |
 +							 gr->tpc_total);
 +		nvkm_wr32(device, GPC_UNIT(gpc, 0x0918), magicgpc918);
 +	}
  
 -	if (gr->fuc_sw_nonctx)
 -		gf100_gr_mmio(gr, gr->fuc_sw_nonctx);
 +	if (device->chipset != 0xd7)
 +		nvkm_wr32(device, GPC_BCAST(0x1bd4), magicgpc918);
  	else
 -		gf100_gr_mmio(gr, gr->func->mmio);
 +		nvkm_wr32(device, GPC_BCAST(0x3fd4), magicgpc918);
  
++<<<<<<< HEAD
 +	nvkm_wr32(device, GPC_BCAST(0x08ac), nvkm_rd32(device, 0x100800));
++=======
+ 	if (gr->func->init_r405a14)
+ 		gr->func->init_r405a14(gr);
+ 
+ 	if (gr->func->clkgate_pack)
+ 		nvkm_therm_clkgate_init(device->therm, gr->func->clkgate_pack);
+ 
+ 	if (gr->func->init_bios)
+ 		gr->func->init_bios(gr);
+ 
+ 	gr->func->init_vsc_stream_master(gr);
+ 	gr->func->init_zcull(gr);
+ 	gr->func->init_num_active_ltcs(gr);
+ 	if (gr->func->init_rop_active_fbps)
+ 		gr->func->init_rop_active_fbps(gr);
+ 	if (gr->func->init_bios_2)
+ 		gr->func->init_bios_2(gr);
+ 	if (gr->func->init_swdx_pes_mask)
+ 		gr->func->init_swdx_pes_mask(gr);
++>>>>>>> dff30dbd1d93 (drm/nouveau/gr/gf100-: virtualise init_swdx_pes_mask)
  
  	nvkm_wr32(device, 0x400500, 0x00010001);
  
diff --cc drivers/gpu/drm/nouveau/nvkm/engine/gr/gf100.h
index a36e45a4a635,858024ba1186..000000000000
--- a/drivers/gpu/drm/nouveau/nvkm/engine/gr/gf100.h
+++ b/drivers/gpu/drm/nouveau/nvkm/engine/gr/gf100.h
@@@ -122,10 -122,15 +122,16 @@@ struct gf100_gr_func 
  	void (*dtor)(struct gf100_gr *);
  	int (*init)(struct gf100_gr *);
  	void (*init_gpc_mmu)(struct gf100_gr *);
 -	void (*init_r405a14)(struct gf100_gr *);
 -	void (*init_bios)(struct gf100_gr *);
 -	void (*init_vsc_stream_master)(struct gf100_gr *);
 -	void (*init_zcull)(struct gf100_gr *);
 -	void (*init_num_active_ltcs)(struct gf100_gr *);
  	void (*init_rop_active_fbps)(struct gf100_gr *);
++<<<<<<< HEAD
 +	void (*init_ppc_exceptions)(struct gf100_gr *);
 +	void (*init_swdx_pes_mask)(struct gf100_gr *);
 +	void (*init_num_active_ltcs)(struct gf100_gr *);
++=======
+ 	void (*init_bios_2)(struct gf100_gr *);
+ 	void (*init_swdx_pes_mask)(struct gf100_gr *);
+ 	void (*init_ppc_exceptions)(struct gf100_gr *);
++>>>>>>> dff30dbd1d93 (drm/nouveau/gr/gf100-: virtualise init_swdx_pes_mask)
  	void (*set_hww_esr_report_mask)(struct gf100_gr *);
  	const struct gf100_gr_pack *mmio;
  	struct {
@@@ -155,7 -167,10 +161,9 @@@ int gm200_gr_rops(struct gf100_gr *)
  int gp100_gr_init(struct gf100_gr *);
  void gp100_gr_init_rop_active_fbps(struct gf100_gr *);
  
+ void gp102_gr_init_swdx_pes_mask(struct gf100_gr *);
+ 
  #define gf100_gr_chan(p) container_of((p), struct gf100_gr_chan, object)
 -#include <core/object.h>
  
  struct gf100_gr_chan {
  	struct nvkm_object object;
@@@ -302,8 -319,4 +310,11 @@@ extern const struct gf100_gr_init gm107
  void gm107_gr_init_bios(struct gf100_gr *);
  
  void gm200_gr_init_gpc_mmu(struct gf100_gr *);
++<<<<<<< HEAD
 +
 +void gp100_gr_init_num_active_ltcs(struct gf100_gr *gr);
 +
 +void gp102_gr_init_swdx_pes_mask(struct gf100_gr *);
++=======
++>>>>>>> dff30dbd1d93 (drm/nouveau/gr/gf100-: virtualise init_swdx_pes_mask)
  #endif
diff --cc drivers/gpu/drm/nouveau/nvkm/engine/gr/gp102.c
index 61e3a0b08559,860a78976980..000000000000
--- a/drivers/gpu/drm/nouveau/nvkm/engine/gr/gp102.c
+++ b/drivers/gpu/drm/nouveau/nvkm/engine/gr/gp102.c
@@@ -44,10 -44,12 +44,13 @@@ static const struct gf100_gr_fun
  gp102_gr = {
  	.init = gp100_gr_init,
  	.init_gpc_mmu = gm200_gr_init_gpc_mmu,
 -	.init_vsc_stream_master = gk104_gr_init_vsc_stream_master,
 -	.init_zcull = gf117_gr_init_zcull,
 -	.init_num_active_ltcs = gm200_gr_init_num_active_ltcs,
  	.init_rop_active_fbps = gp100_gr_init_rop_active_fbps,
- 	.init_ppc_exceptions = gk104_gr_init_ppc_exceptions,
  	.init_swdx_pes_mask = gp102_gr_init_swdx_pes_mask,
++<<<<<<< HEAD
 +	.init_num_active_ltcs = gp100_gr_init_num_active_ltcs,
++=======
+ 	.init_ppc_exceptions = gk104_gr_init_ppc_exceptions,
++>>>>>>> dff30dbd1d93 (drm/nouveau/gr/gf100-: virtualise init_swdx_pes_mask)
  	.rops = gm200_gr_rops,
  	.ppc_nr = 3,
  	.grctx = &gp102_grctx,
diff --cc drivers/gpu/drm/nouveau/nvkm/engine/gr/gp107.c
index f7272323f694,03f22646eb78..000000000000
--- a/drivers/gpu/drm/nouveau/nvkm/engine/gr/gp107.c
+++ b/drivers/gpu/drm/nouveau/nvkm/engine/gr/gp107.c
@@@ -30,10 -30,12 +30,13 @@@ static const struct gf100_gr_fun
  gp107_gr = {
  	.init = gp100_gr_init,
  	.init_gpc_mmu = gm200_gr_init_gpc_mmu,
 -	.init_vsc_stream_master = gk104_gr_init_vsc_stream_master,
 -	.init_zcull = gf117_gr_init_zcull,
 -	.init_num_active_ltcs = gm200_gr_init_num_active_ltcs,
  	.init_rop_active_fbps = gp100_gr_init_rop_active_fbps,
- 	.init_ppc_exceptions = gk104_gr_init_ppc_exceptions,
  	.init_swdx_pes_mask = gp102_gr_init_swdx_pes_mask,
++<<<<<<< HEAD
 +	.init_num_active_ltcs = gp100_gr_init_num_active_ltcs,
++=======
+ 	.init_ppc_exceptions = gk104_gr_init_ppc_exceptions,
++>>>>>>> dff30dbd1d93 (drm/nouveau/gr/gf100-: virtualise init_swdx_pes_mask)
  	.rops = gm200_gr_rops,
  	.ppc_nr = 1,
  	.grctx = &gp107_grctx,
* Unmerged path drivers/gpu/drm/nouveau/nvkm/engine/gr/gf100.c
* Unmerged path drivers/gpu/drm/nouveau/nvkm/engine/gr/gf100.h
* Unmerged path drivers/gpu/drm/nouveau/nvkm/engine/gr/gp102.c
* Unmerged path drivers/gpu/drm/nouveau/nvkm/engine/gr/gp107.c
