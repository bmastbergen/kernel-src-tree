vhost: correctly remove wait queue during poll failure

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
Rebuild_CHGLOG: - [vhost] correctly remove wait queue during poll failure (Hangbin Liu) [1551292]
Rebuild_FUZZ: 93.07%
commit-author Jason Wang <jasowang@redhat.com>
commit dc6455a71c7fc5117977e197f67f71b49f27baba
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/dc6455a7.failed

We tried to remove vq poll from wait queue, but do not check whether
or not it was in a list before. This will lead double free. Fixing
this by switching to use vhost_poll_stop() which zeros poll->wqh after
removing poll from waitqueue to make sure it won't be freed twice.

	Cc: Darren Kenny <darren.kenny@oracle.com>
	Reported-by: syzbot+c0272972b01b872e604a@syzkaller.appspotmail.com
Fixes: 2b8b328b61c79 ("vhost_net: handle polling errors when setting backend")
	Signed-off-by: Jason Wang <jasowang@redhat.com>
	Reviewed-by: Darren Kenny <darren.kenny@oracle.com>
	Acked-by: Michael S. Tsirkin <mst@redhat.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit dc6455a71c7fc5117977e197f67f71b49f27baba)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/vhost/vhost.c
diff --cc drivers/vhost/vhost.c
index 20459c56e529,5d5a9d9e66d3..000000000000
--- a/drivers/vhost/vhost.c
+++ b/drivers/vhost/vhost.c
@@@ -192,10 -210,9 +192,16 @@@ int vhost_poll_start(struct vhost_poll 
  
  	mask = file->f_op->poll(file, &poll->table);
  	if (mask)
++<<<<<<< HEAD
 +		vhost_poll_wakeup(&poll->wait, 0, 0, (void *)mask);
 +	if (mask & POLLERR) {
 +		if (poll->wqh)
 +			remove_wait_queue(poll->wqh, &poll->wait);
++=======
+ 		vhost_poll_wakeup(&poll->wait, 0, 0, poll_to_key(mask));
+ 	if (mask & EPOLLERR) {
+ 		vhost_poll_stop(poll);
++>>>>>>> dc6455a71c7f (vhost: correctly remove wait queue during poll failure)
  		ret = -EINVAL;
  	}
  
* Unmerged path drivers/vhost/vhost.c
