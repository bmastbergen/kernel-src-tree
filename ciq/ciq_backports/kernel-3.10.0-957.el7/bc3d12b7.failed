scsi: libfc: hold disc_mutex in fc_disc_stop_rports()

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
Rebuild_CHGLOG: - [scsi] libfc: hold disc_mutex in fc_disc_stop_rports() (Chris Leech) [1608481]
Rebuild_FUZZ: 94.00%
commit-author Hannes Reinecke <hare@suse.de>
commit bc3d12b75491c0e844a8a7ce05e84de8f7d94822
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/bc3d12b7.failed

fc_disc_stop_rports() is calling fc_rport_logoff(), which in turn is
acquiring the rport mutex. So we cannot use RCU list traversal here, but
rather need to hold the disc mutex to avoid list corruption while
traversing.

Fixes: a407c593398c ("scsi: libfc: Fixup disc_mutex handling")
	Signed-off-by: Hannes Reinecke <hare@suse.com>
	Reviewed-by: Johannes Thumshirn <jthumshirn@suse.de>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit bc3d12b75491c0e844a8a7ce05e84de8f7d94822)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/libfc/fc_disc.c
diff --cc drivers/scsi/libfc/fc_disc.c
index 4671901e6066,f969a71348ef..000000000000
--- a/drivers/scsi/libfc/fc_disc.c
+++ b/drivers/scsi/libfc/fc_disc.c
@@@ -63,19 -62,16 +63,20 @@@ static void fc_disc_restart(struct fc_d
   */
  static void fc_disc_stop_rports(struct fc_disc *disc)
  {
- 	struct fc_lport *lport;
  	struct fc_rport_priv *rdata;
  
++<<<<<<< HEAD
 +	lport = fc_disc_lport(disc);
++=======
+ 	lockdep_assert_held(&disc->disc_mutex);
++>>>>>>> bc3d12b75491 (scsi: libfc: hold disc_mutex in fc_disc_stop_rports())
  
- 	rcu_read_lock();
- 	list_for_each_entry_rcu(rdata, &disc->rports, peers) {
+ 	list_for_each_entry(rdata, &disc->rports, peers) {
  		if (kref_get_unless_zero(&rdata->kref)) {
 -			fc_rport_logoff(rdata);
 -			kref_put(&rdata->kref, fc_rport_destroy);
 +			lport->tt.rport_logoff(rdata);
 +			kref_put(&rdata->kref, lport->tt.rport_destroy);
  		}
  	}
- 	rcu_read_unlock();
  }
  
  /**
* Unmerged path drivers/scsi/libfc/fc_disc.c
