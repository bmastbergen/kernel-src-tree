cxgb4: free up resources of pf 0-3

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
commit-author Ganesh Goudar <ganeshgr@chelsio.com>
commit c4e43e14cd4617d57babc7a9f251bf3e9ad360a0
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/c4e43e14.failed

free pf 0-3 resources, commit baf5086840ab ("cxgb4:
restructure VF mgmt code") erroneously removed the
code which frees the pf 0-3 resources, causing the
probe of pf 0-3 to fail in case of driver reload.

Fixes: baf5086840ab ("cxgb4: restructure VF mgmt code")
	Signed-off-by: Ganesh Goudar <ganeshgr@chelsio.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit c4e43e14cd4617d57babc7a9f251bf3e9ad360a0)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/chelsio/cxgb4/cxgb4_main.c
diff --cc drivers/net/ethernet/chelsio/cxgb4/cxgb4_main.c
index 6ab9c774d010,7b452e85de2a..000000000000
--- a/drivers/net/ethernet/chelsio/cxgb4/cxgb4_main.c
+++ b/drivers/net/ethernet/chelsio/cxgb4/cxgb4_main.c
@@@ -4984,9 -4982,10 +4984,14 @@@ static int cxgb4_iov_configure(struct p
  
  	pcie_fw = readl(adap->regs + PCIE_FW_A);
  	/* Check if cxgb4 is the MASTER and fw is initialized */
- 	if (!(pcie_fw & PCIE_FW_INIT_F) ||
+ 	if (num_vfs &&
+ 	    (!(pcie_fw & PCIE_FW_INIT_F) ||
  	    !(pcie_fw & PCIE_FW_MASTER_VLD_F) ||
++<<<<<<< HEAD
 +	    PCIE_FW_MASTER_G(pcie_fw) != 4) {
++=======
+ 	    PCIE_FW_MASTER_G(pcie_fw) != CXGB4_UNIFIED_PF)) {
++>>>>>>> c4e43e14cd46 (cxgb4: free up resources of pf 0-3)
  		dev_warn(&pdev->dev,
  			 "cxgb4 driver needs to be MASTER to support SRIOV\n");
  		return -EOPNOTSUPP;
@@@ -5566,25 -5605,19 +5570,26 @@@ static void remove_one(struct pci_dev *
  	}
  #ifdef CONFIG_PCI_IOV
  	else {
 -		cxgb4_iov_configure(adapter->pdev, 0);
 +		if (adapter->port[0])
 +			unregister_netdev(adapter->port[0]);
 +		iounmap(adapter->regs);
 +		kfree(adapter->vfinfo);
 +		kfree(adapter->mbox_log);
 +		kfree(adapter);
 +		pci_disable_sriov(pdev);
 +		pci_release_regions(pdev);
  	}
  #endif
+ 	iounmap(adapter->regs);
+ 	pci_disable_pcie_error_reporting(pdev);
+ 	if ((adapter->flags & DEV_ENABLED)) {
+ 		pci_disable_device(pdev);
+ 		adapter->flags &= ~DEV_ENABLED;
+ 	}
+ 	pci_release_regions(pdev);
+ 	kfree(adapter->mbox_log);
+ 	synchronize_rcu();
+ 	kfree(adapter);
  }
  
  /* "Shutdown" quiesces the device, stopping Ingress Packet and Interrupt
* Unmerged path drivers/net/ethernet/chelsio/cxgb4/cxgb4_main.c
