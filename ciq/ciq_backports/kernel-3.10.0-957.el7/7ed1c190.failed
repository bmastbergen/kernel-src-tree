tools: fix cross-compile var clobbering

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
Rebuild_CHGLOG: - [tools] wmi: fix cross-compile var clobbering (Jarod Wilson) [1517197]
Rebuild_FUZZ: 89.47%
commit-author Martin Kelly <martin@martingkelly.com>
commit 7ed1c1901fe52e6c5828deb155920b44b0adabb1
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/7ed1c190.failed

Currently a number of Makefiles break when used with toolchains that
pass extra flags in CC and other cross-compile related variables (such
as --sysroot).

Thus we get this error when we use a toolchain that puts --sysroot in
the CC var:

  ~/src/linux/tools$ make iio
  [snip]
  iio_event_monitor.c:18:10: fatal error: unistd.h: No such file or directory
    #include <unistd.h>
             ^~~~~~~~~~

This occurs because we clobber several env vars related to
cross-compiling with lines like this:

  CC = $(CROSS_COMPILE)gcc

Although this will point to a valid cross-compiler, we lose any extra
flags that might exist in the CC variable, which can break toolchains
that rely on them (for example, those that use --sysroot).

This easily shows up using a Yocto SDK:

  $ . [snip]/sdk/environment-setup-cortexa8hf-neon-poky-linux-gnueabi

  $ echo $CC
  arm-poky-linux-gnueabi-gcc -march=armv7-a -mfpu=neon -mfloat-abi=hard
  -mcpu=cortex-a8
  --sysroot=[snip]/sdk/sysroots/cortexa8hf-neon-poky-linux-gnueabi

  $ echo $CROSS_COMPILE
  arm-poky-linux-gnueabi-

  $ echo ${CROSS_COMPILE}gcc
  krm-poky-linux-gnueabi-gcc

Although arm-poky-linux-gnueabi-gcc is a cross-compiler, we've lost the
--sysroot and other flags that enable us to find the right libraries to
link against, so we can't find unistd.h and other libraries and headers.
Normally with the --sysroot flag we would find unistd.h in the sdk
directory in the sysroot:

  $ find [snip]/sdk/sysroots -path '*/usr/include/unistd.h'
  [snip]/sdk/sysroots/cortexa8hf-neon-poky-linux-gnueabi/usr/include/unistd.h

The perf Makefile adds CC = $(CROSS_COMPILE)gcc if and only if CC is not
already set, and it compiles correctly with the above toolchain.

So, generalize the logic that perf uses in the common Makefile and
remove the manual CC = $(CROSS_COMPILE)gcc lines from each Makefile.

Note that this patch does not fix cross-compile for all the tools (some
have other bugs), but it does fix it for all except usb and acpi, which
still have other unrelated issues.

I tested both with and without the patch on native and cross-build and
there appear to be no regressions.

Link: http://lkml.kernel.org/r/20180107214028.23771-1-martin@martingkelly.com
	Signed-off-by: Martin Kelly <martin@martingkelly.com>
	Acked-by: Mark Brown <broonie@kernel.org>
	Cc: Tejun Heo <tj@kernel.org>
	Cc: Li Zefan <lizefan@huawei.com>
	Cc: Johannes Weiner <hannes@cmpxchg.org>
	Cc: Linus Walleij <linus.walleij@linaro.org>
	Cc: "K. Y. Srinivasan" <kys@microsoft.com>
	Cc: Haiyang Zhang <haiyangz@microsoft.com>
	Cc: Stephen Hemminger <sthemmin@microsoft.com>
	Cc: Jonathan Cameron <jic23@kernel.org>
	Cc: Pali Rohar <pali.rohar@gmail.com>
	Cc: Richard Purdie <rpurdie@rpsys.net>
	Cc: Jacek Anaszewski <jacek.anaszewski@gmail.com>
	Cc: Pavel Machek <pavel@ucw.cz>
	Cc: Peter Zijlstra <peterz@infradead.org>
	Cc: Ingo Molnar <mingo@redhat.com>
	Cc: Arnaldo Carvalho de Melo <acme@kernel.org>
	Cc: Robert Moore <robert.moore@intel.com>
	Cc: Lv Zheng <lv.zheng@intel.com>
	Cc: "Rafael J. Wysocki" <rafael.j.wysocki@intel.com>
	Cc: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
	Cc: Valentina Manea <valentina.manea.m@gmail.com>
	Cc: Shuah Khan <shuah@kernel.org>
	Cc: Mario Limonciello <mario.limonciello@dell.com>
	Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
	Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
(cherry picked from commit 7ed1c1901fe52e6c5828deb155920b44b0adabb1)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/gpio/Makefile
#	tools/hv/Makefile
#	tools/iio/Makefile
#	tools/laptop/freefall/Makefile
#	tools/leds/Makefile
#	tools/scripts/Makefile.include
#	tools/spi/Makefile
#	tools/wmi/Makefile
diff --cc tools/scripts/Makefile.include
index e75ef456b3dc,dd614463d4d6..000000000000
--- a/tools/scripts/Makefile.include
+++ b/tools/scripts/Makefile.include
@@@ -39,7 -40,27 +39,31 @@@ EXTRA_WARNINGS += -Wunde
  EXTRA_WARNINGS += -Wwrite-strings
  EXTRA_WARNINGS += -Wformat
  
++<<<<<<< HEAD
 +ifneq ($(CC), clang)
++=======
+ CC_NO_CLANG := $(shell $(CC) -dM -E -x c /dev/null | grep -Fq "__clang__"; echo $$?)
+ 
+ # Makefiles suck: This macro sets a default value of $(2) for the
+ # variable named by $(1), unless the variable has been set by
+ # environment or command line. This is necessary for CC and AR
+ # because make sets default values, so the simpler ?= approach
+ # won't work as expected.
+ define allow-override
+   $(if $(or $(findstring environment,$(origin $(1))),\
+             $(findstring command line,$(origin $(1)))),,\
+     $(eval $(1) = $(2)))
+ endef
+ 
+ # Allow setting various cross-compile vars or setting CROSS_COMPILE as a prefix.
+ $(call allow-override,CC,$(CROSS_COMPILE)gcc)
+ $(call allow-override,AR,$(CROSS_COMPILE)ar)
+ $(call allow-override,LD,$(CROSS_COMPILE)ld)
+ $(call allow-override,CXX,$(CROSS_COMPILE)g++)
+ $(call allow-override,STRIP,$(CROSS_COMPILE)strip)
+ 
+ ifeq ($(CC_NO_CLANG), 1)
++>>>>>>> 7ed1c1901fe5 (tools: fix cross-compile var clobbering)
  EXTRA_WARNINGS += -Wstrict-aliasing=3
  endif
  
* Unmerged path tools/gpio/Makefile
* Unmerged path tools/hv/Makefile
* Unmerged path tools/iio/Makefile
* Unmerged path tools/laptop/freefall/Makefile
* Unmerged path tools/leds/Makefile
* Unmerged path tools/spi/Makefile
* Unmerged path tools/wmi/Makefile
diff --git a/tools/cgroup/Makefile b/tools/cgroup/Makefile
index b4286196b763..18578fb7706a 100644
--- a/tools/cgroup/Makefile
+++ b/tools/cgroup/Makefile
@@ -1,6 +1,5 @@
 # Makefile for cgroup tools
 
-CC = $(CROSS_COMPILE)gcc
 CFLAGS = -Wall -Wextra
 
 all: cgroup_event_listener
* Unmerged path tools/gpio/Makefile
* Unmerged path tools/hv/Makefile
* Unmerged path tools/iio/Makefile
* Unmerged path tools/laptop/freefall/Makefile
* Unmerged path tools/leds/Makefile
diff --git a/tools/perf/Makefile.perf b/tools/perf/Makefile.perf
index 092c3b4c3da0..75186baa7635 100644
--- a/tools/perf/Makefile.perf
+++ b/tools/perf/Makefile.perf
@@ -137,12 +137,6 @@ define allow-override
     $(eval $(1) = $(2)))
 endef
 
-# Allow setting CC and AR and LD, or setting CROSS_COMPILE as a prefix.
-$(call allow-override,CC,$(CROSS_COMPILE)gcc)
-$(call allow-override,AR,$(CROSS_COMPILE)ar)
-$(call allow-override,LD,$(CROSS_COMPILE)ld)
-$(call allow-override,CXX,$(CROSS_COMPILE)g++)
-
 LD += $(EXTRA_LDFLAGS)
 
 HOSTCC  ?= gcc
diff --git a/tools/power/acpi/Makefile.config b/tools/power/acpi/Makefile.config
index a1883bbb0144..2cccbba64418 100644
--- a/tools/power/acpi/Makefile.config
+++ b/tools/power/acpi/Makefile.config
@@ -56,9 +56,6 @@ INSTALL_SCRIPT = ${INSTALL_PROGRAM}
 # to compile vs uClibc, that can be done here as well.
 CROSS = #/usr/i386-linux-uclibc/usr/bin/i386-uclibc-
 CROSS_COMPILE ?= $(CROSS)
-CC = $(CROSS_COMPILE)gcc
-LD = $(CROSS_COMPILE)gcc
-STRIP = $(CROSS_COMPILE)strip
 HOSTCC = gcc
 
 # check if compiler option is supported
* Unmerged path tools/scripts/Makefile.include
* Unmerged path tools/spi/Makefile
diff --git a/tools/usb/Makefile b/tools/usb/Makefile
index 396d6c44e9d7..ac3bc7d04ffd 100644
--- a/tools/usb/Makefile
+++ b/tools/usb/Makefile
@@ -1,6 +1,5 @@
 # Makefile for USB tools
 
-CC = $(CROSS_COMPILE)gcc
 PTHREAD_LIBS = -lpthread
 WARNINGS = -Wall -Wextra
 CFLAGS = $(WARNINGS) -g $(PTHREAD_LIBS) -I../include
diff --git a/tools/vm/Makefile b/tools/vm/Makefile
index c604f3ec628a..d3e02fc55fe4 100644
--- a/tools/vm/Makefile
+++ b/tools/vm/Makefile
@@ -5,7 +5,6 @@ TARGETS=page-types slabinfo
 LIB_DIR = ../lib/api
 LIBS = $(LIB_DIR)/libapi.a
 
-CC = $(CROSS_COMPILE)gcc
 CFLAGS = -Wall -Wextra -I../lib/
 LDFLAGS = $(LIBS)
 
* Unmerged path tools/wmi/Makefile
