drm/nouveau/fb/gp100-: disable address remapper

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
commit-author Ben Skeggs <bskeggs@redhat.com>
commit 2f958e8240be28acee26085ba1686b4321ba4306
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/2f958e82.failed

This was causing problems on a system with a large amount of RAM, where
display push buffers were being fetched incorrectly when placed in high
system memory addresses.

While this commit will resolve the issue on that particular system, the
issue will be avoided completely with another patch to more fully solve
problems with display and large amounts of system memory on Pascal.

It's still probably a good idea to disable this to prevent weird issues
in the future.

	Signed-off-by: Ben Skeggs <bskeggs@redhat.com>
(cherry picked from commit 2f958e8240be28acee26085ba1686b4321ba4306)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/gpu/drm/nouveau/nvkm/subdev/fb/base.c
#	drivers/gpu/drm/nouveau/nvkm/subdev/fb/priv.h
diff --cc drivers/gpu/drm/nouveau/nvkm/subdev/fb/base.c
index a7049c041594,434d2fc5bb1c..000000000000
--- a/drivers/gpu/drm/nouveau/nvkm/subdev/fb/base.c
+++ b/drivers/gpu/drm/nouveau/nvkm/subdev/fb/base.c
@@@ -135,8 -139,16 +135,21 @@@ nvkm_fb_init(struct nvkm_subdev *subdev
  
  	if (fb->func->init)
  		fb->func->init(fb);
++<<<<<<< HEAD
 +	if (fb->func->init_page)
 +		fb->func->init_page(fb);
++=======
+ 
+ 	if (fb->func->init_remapper)
+ 		fb->func->init_remapper(fb);
+ 
+ 	if (fb->func->init_page) {
+ 		ret = fb->func->init_page(fb);
+ 		if (WARN_ON(ret))
+ 			return ret;
+ 	}
+ 
++>>>>>>> 2f958e8240be (drm/nouveau/fb/gp100-: disable address remapper)
  	if (fb->func->init_unkn)
  		fb->func->init_unkn(fb);
  	return 0;
diff --cc drivers/gpu/drm/nouveau/nvkm/subdev/fb/priv.h
index e905d44fa1d5,1e4ad61c19e1..000000000000
--- a/drivers/gpu/drm/nouveau/nvkm/subdev/fb/priv.h
+++ b/drivers/gpu/drm/nouveau/nvkm/subdev/fb/priv.h
@@@ -6,9 -8,11 +6,14 @@@ struct nvkm_bios
  
  struct nvkm_fb_func {
  	void *(*dtor)(struct nvkm_fb *);
 -	u32 (*tags)(struct nvkm_fb *);
  	int (*oneinit)(struct nvkm_fb *);
  	void (*init)(struct nvkm_fb *);
++<<<<<<< HEAD
 +	void (*init_page)(struct nvkm_fb *);
++=======
+ 	void (*init_remapper)(struct nvkm_fb *);
+ 	int (*init_page)(struct nvkm_fb *);
++>>>>>>> 2f958e8240be (drm/nouveau/fb/gp100-: disable address remapper)
  	void (*init_unkn)(struct nvkm_fb *);
  	void (*intr)(struct nvkm_fb *);
  
@@@ -62,8 -66,10 +67,15 @@@ void nv46_fb_tile_init(struct nvkm_fb *
  		       u32 pitch, u32 flags, struct nvkm_fb_tile *);
  
  int gf100_fb_oneinit(struct nvkm_fb *);
 -int gf100_fb_init_page(struct nvkm_fb *);
 +void gf100_fb_init_page(struct nvkm_fb *);
 +bool gf100_fb_memtype_valid(struct nvkm_fb *, u32);
  
++<<<<<<< HEAD
 +void gm200_fb_init_page(struct nvkm_fb *);
++=======
+ int gm200_fb_init_page(struct nvkm_fb *);
+ 
+ void gp100_fb_init_remapper(struct nvkm_fb *);
+ void gp100_fb_init_unkn(struct nvkm_fb *);
++>>>>>>> 2f958e8240be (drm/nouveau/fb/gp100-: disable address remapper)
  #endif
* Unmerged path drivers/gpu/drm/nouveau/nvkm/subdev/fb/base.c
diff --git a/drivers/gpu/drm/nouveau/nvkm/subdev/fb/gp100.c b/drivers/gpu/drm/nouveau/nvkm/subdev/fb/gp100.c
index 45269a73d5d1..72497bc36131 100644
--- a/drivers/gpu/drm/nouveau/nvkm/subdev/fb/gp100.c
+++ b/drivers/gpu/drm/nouveau/nvkm/subdev/fb/gp100.c
@@ -36,6 +36,14 @@ gp100_fb_init_unkn(struct nvkm_fb *base)
 	nvkm_wr32(device, 0x1faccc, nvkm_rd32(device, 0x100ccc));
 }
 
+void
+gp100_fb_init_remapper(struct nvkm_fb *fb)
+{
+	struct nvkm_device *device = fb->subdev.device;
+	/* Disable address remapper. */
+	nvkm_mask(device, 0x100c14, 0x00040000, 0x00000000);
+}
+
 void
 gp100_fb_init(struct nvkm_fb *base)
 {
@@ -56,6 +64,7 @@ gp100_fb = {
 	.dtor = gf100_fb_dtor,
 	.oneinit = gf100_fb_oneinit,
 	.init = gp100_fb_init,
+	.init_remapper = gp100_fb_init_remapper,
 	.init_page = gm200_fb_init_page,
 	.init_unkn = gp100_fb_init_unkn,
 	.ram_new = gp100_ram_new,
diff --git a/drivers/gpu/drm/nouveau/nvkm/subdev/fb/gp102.c b/drivers/gpu/drm/nouveau/nvkm/subdev/fb/gp102.c
index 73b4ae1c73dc..e7627b4b2b72 100644
--- a/drivers/gpu/drm/nouveau/nvkm/subdev/fb/gp102.c
+++ b/drivers/gpu/drm/nouveau/nvkm/subdev/fb/gp102.c
@@ -31,6 +31,7 @@ gp102_fb = {
 	.dtor = gf100_fb_dtor,
 	.oneinit = gf100_fb_oneinit,
 	.init = gp100_fb_init,
+	.init_remapper = gp100_fb_init_remapper,
 	.init_page = gm200_fb_init_page,
 	.ram_new = gp100_ram_new,
 	.memtype_valid = gf100_fb_memtype_valid,
* Unmerged path drivers/gpu/drm/nouveau/nvkm/subdev/fb/priv.h
