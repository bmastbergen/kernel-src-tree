powerpc/rfi-flush: Always enable fallback flush on pseries

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
Rebuild_CHGLOG: - [powerpc] rfi-flush: Always enable fallback flush on pseries (Mauricio Oliveira) [1561785]
Rebuild_FUZZ: 92.59%
commit-author Michael Ellerman <mpe@ellerman.id.au>
commit 84749a58b6e382f109abf1e734bc4dd43c2c25bb
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/84749a58.failed

This ensures the fallback flush area is always allocated on pseries,
so in case a LPAR is migrated from a patched to an unpatched system,
it is possible to enable the fallback flush in the target system.

	Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
	Signed-off-by: Mauricio Faria de Oliveira <mauricfo@linux.vnet.ibm.com>
	Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
(cherry picked from commit 84749a58b6e382f109abf1e734bc4dd43c2c25bb)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/powerpc/platforms/pseries/setup.c
diff --cc arch/powerpc/platforms/pseries/setup.c
index 16f5e74be2ee,b20d1074acb9..000000000000
--- a/arch/powerpc/platforms/pseries/setup.c
+++ b/arch/powerpc/platforms/pseries/setup.c
@@@ -530,25 -467,19 +530,32 @@@ static void pSeries_setup_rfi_flush(voi
  
  	/* Enable by default */
  	enable = true;
+ 	types = L1D_FLUSH_FALLBACK;
  
 -	rc = plpar_get_cpu_characteristics(&result);
 +	rc = plpar_get_cpu_characteristics(&character, &behaviour);
  	if (rc == H_SUCCESS) {
++<<<<<<< HEAD
 +		types = L1D_FLUSH_NONE;
 +
 +		if (character & H_GET_CPU_CHAR_CHAR_MTTRIG2_L1_FLUSH)
++=======
+ 		if (result.character & H_CPU_CHAR_L1D_FLUSH_TRIG2)
++>>>>>>> 84749a58b6e3 (powerpc/rfi-flush: Always enable fallback flush on pseries)
  			types |= L1D_FLUSH_MTTRIG;
 -		if (result.character & H_CPU_CHAR_L1D_FLUSH_ORI30)
 +		if (character & H_GET_CPU_CHAR_CHAR_ORI30_L1_FLUSH)
  			types |= L1D_FLUSH_ORI;
  
++<<<<<<< HEAD
 +		/* Use fallback if nothing set in hcall */
 +		if (types == L1D_FLUSH_NONE)
 +			types = L1D_FLUSH_FALLBACK;
 +
 +		if (!(behaviour & H_GET_CPU_CHAR_BEHAV_L1_FLUSH_LOW_PRIV))
++=======
+ 		if ((!(result.behaviour & H_CPU_BEHAV_L1D_FLUSH_PR)) ||
+ 		    (!(result.behaviour & H_CPU_BEHAV_FAVOUR_SECURITY)))
++>>>>>>> 84749a58b6e3 (powerpc/rfi-flush: Always enable fallback flush on pseries)
  			enable = false;
- 	} else {
- 		/* Default to fallback if case hcall is not available */
- 		types = L1D_FLUSH_FALLBACK;
  	}
  
  	setup_rfi_flush(types, enable);
* Unmerged path arch/powerpc/platforms/pseries/setup.c
