xfs: Fix per-inode DAX flag inheritance

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
commit-author Lukas Czerner <lczerner@redhat.com>
commit 56bdf855e676f1f2ed7033f288f57dfd315725ba
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/56bdf855.failed

According to the commit that implemented per-inode DAX flag:
commit 58f88ca2df72 ("xfs: introduce per-inode DAX enablement")
the flag is supposed to act as "inherit flag".

Currently this only works in the situations where parent directory
already has a flag in di_flags set, otherwise inheritance does not
work. This is because setting the XFS_DIFLAG2_DAX flag is done in a
wrong branch designated for di_flags, not di_flags2.

Fix this by moving the code to branch designated for setting di_flags2,
which does test for flags in di_flags2.

Fixes: 58f88ca2df72 ("xfs: introduce per-inode DAX enablement")
	Signed-off-by: Lukas Czerner <lczerner@redhat.com>
	Reviewed-by: Darrick J. Wong <darrick.wong@oracle.com>
	Signed-off-by: Darrick J. Wong <darrick.wong@oracle.com>
(cherry picked from commit 56bdf855e676f1f2ed7033f288f57dfd315725ba)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/xfs/xfs_inode.c
diff --cc fs/xfs/xfs_inode.c
index 71c58a693e70,ff48f0096810..000000000000
--- a/fs/xfs/xfs_inode.c
+++ b/fs/xfs/xfs_inode.c
@@@ -891,12 -910,24 +890,27 @@@ xfs_ialloc
  				di_flags |= XFS_DIFLAG_NODEFRAG;
  			if (pip->i_d.di_flags & XFS_DIFLAG_FILESTREAM)
  				di_flags |= XFS_DIFLAG_FILESTREAM;
+ 
+ 			ip->i_d.di_flags |= di_flags;
+ 		}
++<<<<<<< HEAD
++=======
+ 		if (pip &&
+ 		    (pip->i_d.di_flags2 & XFS_DIFLAG2_ANY) &&
+ 		    pip->i_d.di_version == 3 &&
+ 		    ip->i_d.di_version == 3) {
+ 			uint64_t	di_flags2 = 0;
+ 
+ 			if (pip->i_d.di_flags2 & XFS_DIFLAG2_COWEXTSIZE) {
+ 				di_flags2 |= XFS_DIFLAG2_COWEXTSIZE;
+ 				ip->i_d.di_cowextsize = pip->i_d.di_cowextsize;
+ 			}
  			if (pip->i_d.di_flags2 & XFS_DIFLAG2_DAX)
  				di_flags2 |= XFS_DIFLAG2_DAX;
  
- 			ip->i_d.di_flags |= di_flags;
  			ip->i_d.di_flags2 |= di_flags2;
  		}
++>>>>>>> 56bdf855e676 (xfs: Fix per-inode DAX flag inheritance)
  		/* FALLTHROUGH */
  	case S_IFLNK:
  		ip->i_d.di_format = XFS_DINODE_FMT_EXTENTS;
* Unmerged path fs/xfs/xfs_inode.c
