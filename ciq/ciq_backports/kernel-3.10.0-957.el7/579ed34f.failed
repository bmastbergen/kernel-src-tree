RAID10: ignore discard error

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
commit-author Shaohua Li <shli@fb.com>
commit 579ed34f7b751b8add233cba4cf755258dbdd60a
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/579ed34f.failed

This is the counterpart of raid10 fix. If a write error occurs, raid10
will try to rewrite the bio in small chunk size. If the rewrite fails,
raid10 will record the error in bad block. narrow_write_error will
always use WRITE for the bio, but actually it could be a discard. Since
discard bio hasn't payload, write the bio will cause different issues.
But discard error isn't fatal, we can safely ignore it. This is what
this patch does.

This issue should exist since discard is added, but only exposed with
recent arbitrary bio size feature.

	Cc: Sitsofe Wheeler <sitsofe@gmail.com>
	Cc: stable@vger.kernel.org (v3.6)
	Signed-off-by: Shaohua Li <shli@fb.com>
(cherry picked from commit 579ed34f7b751b8add233cba4cf755258dbdd60a)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/md/raid10.c
diff --cc drivers/md/raid10.c
index a7df690704b8,39fddda2fef2..000000000000
--- a/drivers/md/raid10.c
+++ b/drivers/md/raid10.c
@@@ -450,7 -447,9 +450,13 @@@ static void raid10_end_write_request(st
  	struct r10conf *conf = r10_bio->mddev->private;
  	int slot, repl;
  	struct md_rdev *rdev = NULL;
++<<<<<<< HEAD
 +	struct bio *to_put = NULL;
++=======
+ 	bool discard_error;
+ 
+ 	discard_error = bio->bi_error && bio_op(bio) == REQ_OP_DISCARD;
++>>>>>>> 579ed34f7b75 (RAID10: ignore discard error)
  
  	dev = find_bio_disk(conf, r10_bio, bio, &slot, &repl);
  
@@@ -464,7 -463,7 +470,11 @@@
  	/*
  	 * this branch is our 'one mirror IO has finished' event handler:
  	 */
++<<<<<<< HEAD
 +	if (!uptodate) {
++=======
+ 	if (bio->bi_error && !discard_error) {
++>>>>>>> 579ed34f7b75 (RAID10: ignore discard error)
  		if (repl)
  			/* Never record new bad blocks to replacement,
  			 * just fail it.
* Unmerged path drivers/md/raid10.c
