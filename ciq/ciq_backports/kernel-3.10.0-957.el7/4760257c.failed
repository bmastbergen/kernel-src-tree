mmc: sdio: Keep card runtime resumed while adding function devices

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
Rebuild_CHGLOG: - [mmc] sdio: Keep card runtime resumed while adding function devices (Gopal Tiwari) [1456570]
Rebuild_FUZZ: 96.06%
commit-author Adrian Hunter <adrian.hunter@intel.com>
commit 4760257cb54e29e9a90e0ce849f4efcd67718816
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/4760257c.failed

Drivers core will runtime suspend a device with no driver. That means the
SDIO card will be runtime suspended as soon as it is added. It is then
runtime resumed to add each function. That is entirely pointless, so add
pm runtime get/put to keep the SDIO card runtime resumed until the function
devices have been added.

	Signed-off-by: Adrian Hunter <adrian.hunter@intel.com>
	Signed-off-by: Ulf Hansson <ulf.hansson@linaro.org>
(cherry picked from commit 4760257cb54e29e9a90e0ce849f4efcd67718816)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/mmc/core/sdio.c
diff --cc drivers/mmc/core/sdio.c
index 0d1065d412ea,cc43687ca241..000000000000
--- a/drivers/mmc/core/sdio.c
+++ b/drivers/mmc/core/sdio.c
@@@ -1156,16 -1168,17 +1165,25 @@@ int mmc_attach_sdio(struct mmc_host *ho
  	return 0;
  
  
 -remove:
 -	mmc_release_host(host);
  remove_added:
++<<<<<<< HEAD
 +	/* Remove without lock if the device has been added. */
++=======
+ 	/*
+ 	 * The devices are being deleted so it is not necessary to disable
+ 	 * runtime PM. Similarly we also don't pm_runtime_put() the SDIO card
+ 	 * because it needs to be active to remove any function devices that
+ 	 * were probed, and after that it gets deleted.
+ 	 */
++>>>>>>> 4760257cb54e (mmc: sdio: Keep card runtime resumed while adding function devices)
  	mmc_sdio_remove(host);
  	mmc_claim_host(host);
 +remove:
 +	/* And with lock if it hasn't been added. */
 +	mmc_release_host(host);
 +	if (host->card)
 +		mmc_sdio_remove(host);
 +	mmc_claim_host(host);
  err:
  	mmc_detach_bus(host);
  
* Unmerged path drivers/mmc/core/sdio.c
