mmc: block: blk-mq: Potential NULL deref on mmc_blk_alloc_req() failure

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
Rebuild_CHGLOG: - [mmc] block: blk-mq: Potential NULL deref on mmc_blk_alloc_req() failure (Gopal Tiwari) [1456570]
Rebuild_FUZZ: 96.35%
commit-author Dan Carpenter <dan.carpenter@oracle.com>
commit 2361bfb055f948eac6583fa3c75a014da84fe554
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/2361bfb0.failed

mmc_blk_alloc_req() is supposed to return error pointers but there is
one path where we forget to set the error code and accidentally return
NULL.  The callers are not expecting that and will have a NULL pointer
dereference.

Fixes: 41e3efd07d5a ("mmc: block: Simplify cleaning up the queue")
	Signed-off-by: Dan Carpenter <dan.carpenter@oracle.com>
	Acked-by: Adrian Hunter <adrian.hunter@intel.com>
	Signed-off-by: Ulf Hansson <ulf.hansson@linaro.org>
(cherry picked from commit 2361bfb055f948eac6583fa3c75a014da84fe554)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/mmc/core/block.c
diff --cc drivers/mmc/core/block.c
index f1d3365980df,654fc1ebd675..000000000000
--- a/drivers/mmc/core/block.c
+++ b/drivers/mmc/core/block.c
@@@ -1950,6 -2320,18 +1950,21 @@@ static struct mmc_blk_data *mmc_blk_all
  
  	md->queue.blkdata = md;
  
++<<<<<<< HEAD
++=======
+ 	/*
+ 	 * Keep an extra reference to the queue so that we can shutdown the
+ 	 * queue (i.e. call blk_cleanup_queue()) while there are still
+ 	 * references to the 'md'. The corresponding blk_put_queue() is in
+ 	 * mmc_blk_put().
+ 	 */
+ 	if (!blk_get_queue(md->queue.queue)) {
+ 		mmc_cleanup_queue(&md->queue);
+ 		ret = -ENODEV;
+ 		goto err_putdisk;
+ 	}
+ 
++>>>>>>> 2361bfb055f9 (mmc: block: blk-mq: Potential NULL deref on mmc_blk_alloc_req() failure)
  	md->disk->major	= MMC_BLOCK_MAJOR;
  	md->disk->first_minor = devidx * perdev_minors;
  	md->disk->fops = &mmc_bdops;
* Unmerged path drivers/mmc/core/block.c
