tools/power turbostat: if --num_iterations, print for specific number of iterations

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
Rebuild_CHGLOG: - [tools] power turbostat: if --num_iterations, print for specific number of iterations (Prarit Bhargava) [1454489]
Rebuild_FUZZ: 96.25%
commit-author Chen Yu <yu.c.chen@intel.com>
commit 023fe0ac975e4dff592ce90bbd12747dedf7c598
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/023fe0ac.failed

There's a use case during test to only print specific round of iterations
if --num_iterations is specified, for example, with this patch applied:

turbostat -i 5 -n 4
will capture 4 samples with 5 seconds interval.

[lenb: renamed to --num_iterations from --iterations]

	Reviewed-by: Rafael J. Wysocki <rafael.j.wysocki@intel.com>
	Signed-off-by: Chen Yu <yu.c.chen@intel.com>
	Reviewed-by: Artem Bityutskiy <artem.bityutskiy@linux.intel.com>
	Signed-off-by: Len Brown <len.brown@intel.com>
(cherry picked from commit 023fe0ac975e4dff592ce90bbd12747dedf7c598)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/power/x86/turbostat/turbostat.c
diff --cc tools/power/x86/turbostat/turbostat.c
index a69d2b176ddf,6910773e85a9..000000000000
--- a/tools/power/x86/turbostat/turbostat.c
+++ b/tools/power/x86/turbostat/turbostat.c
@@@ -51,8 -51,10 +51,9 @@@ int *fd_percpu
  struct timeval interval_tv = {5, 0};
  struct timespec interval_ts = {5, 0};
  struct timespec one_msec = {0, 1000000};
+ unsigned int num_iterations;
  unsigned int debug;
 -unsigned int quiet;
 -unsigned int shown;
 +unsigned int quiet = 1;
  unsigned int sums_need_wide_columns;
  unsigned int rapl_joules;
  unsigned int summary_only;
@@@ -5101,9 -5217,10 +5109,10 @@@ void cmdline(int argc, char **argv
  		{"add",		required_argument,	0, 'a'},
  		{"cpu",		required_argument,	0, 'c'},
  		{"Dump",	no_argument,		0, 'D'},
 -		{"debug",	no_argument,		0, 'd'},	/* internal, not documented */
 -		{"enable",	required_argument,	0, 'e'},
 +		{"debug",	no_argument,		0, 'd'},	 /* internal, not documented */
 +		{"verbose",	no_argument,		0, 'v'},
  		{"interval",	required_argument,	0, 'i'},
+ 		{"num_iterations",	required_argument,	0, 'n'},
  		{"help",	no_argument,		0, 'h'},
  		{"hide",	required_argument,	0, 'H'},	// meh, -h taken by --help
  		{"Joules",	no_argument,		0, 'J'},
@@@ -5119,7 -5236,7 +5128,11 @@@
  
  	progname = argv[0];
  
++<<<<<<< HEAD
 +	while ((opt = getopt_long_only(argc, argv, "+C:c:Ddvhi:JM:m:o:qST:V",
++=======
+ 	while ((opt = getopt_long_only(argc, argv, "+C:c:Dde:hi:Jn:o:qST:v",
++>>>>>>> 023fe0ac975e (tools/power turbostat: if --num_iterations, print for specific number of iterations)
  				long_options, &option_index)) != -1) {
  		switch (opt) {
  		case 'a':
@@@ -5171,8 -5296,26 +5184,17 @@@
  		case 'q':
  			quiet = 1;
  			break;
+ 		case 'n':
+ 			num_iterations = strtod(optarg, NULL);
+ 
+ 			if (num_iterations <= 0) {
+ 				fprintf(outf, "iterations %d should be positive number\n",
+ 					num_iterations);
+ 				exit(2);
+ 			}
+ 			break;
  		case 's':
 -			/*
 -			 * --show: show only those specified
 -			 *  The 1st invocation will clear and replace the enabled mask
 -			 *  subsequent invocations can add to it.
 -			 */
 -			if (shown == 0)
 -				bic_enabled = bic_lookup(optarg, SHOW_LIST);
 -			else
 -				bic_enabled |= bic_lookup(optarg, SHOW_LIST);
 -			shown = 1;
 +			parse_show_hide(optarg, SHOW_LIST);
  			break;
  		case 'S':
  			summary_only++;
diff --git a/tools/power/x86/turbostat/turbostat.8 b/tools/power/x86/turbostat/turbostat.8
index ff997f31a59a..8e16d38094a5 100644
--- a/tools/power/x86/turbostat/turbostat.8
+++ b/tools/power/x86/turbostat/turbostat.8
@@ -64,6 +64,8 @@ name as necessary to disambiguate it from others is necessary.  Note that option
 .PP
 \fB--interval seconds\fP overrides the default 5.0 second measurement interval.
 .PP
+\fB--num_iterations num\fP number of the measurement iterations.
+.PP
 \fB--out output_file\fP turbostat output is written to the specified output_file.
 The file is truncated if it already exists, and it is created if it does not exist.
 .PP
* Unmerged path tools/power/x86/turbostat/turbostat.c
