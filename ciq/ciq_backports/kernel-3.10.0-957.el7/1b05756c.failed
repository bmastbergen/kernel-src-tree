netfilter: ipset: Fix warn: integer overflows 'sizeof(*map) + size * set->dsize'

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
commit-author Jozsef Kadlecsik <kadlec@blackhole.kfki.hu>
commit 1b05756c48ea07ced9604ef01d11194d936da163
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/1b05756c.failed

Dan Carpenter reported that the static checker emits the warning

        net/netfilter/ipset/ip_set_list_set.c:600 init_list_set()
        warn: integer overflows 'sizeof(*map) + size * set->dsize'

Limit the maximal number of elements in list type of sets.

	Signed-off-by: Jozsef Kadlecsik <kadlec@blackhole.kfki.hu>
(cherry picked from commit 1b05756c48ea07ced9604ef01d11194d936da163)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/netfilter/ipset/ip_set_list_set.c
diff --cc net/netfilter/ipset/ip_set_list_set.c
index a9a97c07ecb4,f87adbad6076..000000000000
--- a/net/netfilter/ipset/ip_set_list_set.c
+++ b/net/netfilter/ipset/ip_set_list_set.c
@@@ -622,13 -597,13 +622,19 @@@ init_list_set(struct net *net, struct i
  	struct set_elem *e;
  	u32 i;
  
++<<<<<<< HEAD
 +	map = kzalloc(sizeof(*map) + size * dsize, GFP_KERNEL);
++=======
+ 	map = kzalloc(sizeof(*map) +
+ 		      min_t(u32, size, IP_SET_LIST_MAX_SIZE) * set->dsize,
+ 		      GFP_KERNEL);
++>>>>>>> 1b05756c48ea (netfilter: ipset: Fix warn: integer overflows 'sizeof(*map) + size * set->dsize')
  	if (!map)
 -		return false;
 +		return NULL;
  
  	map->size = size;
 +	map->dsize = dsize;
 +	map->timeout = timeout;
  	map->net = net;
  	set->data = map;
  
diff --git a/include/linux/netfilter/ipset/ip_set_list.h b/include/linux/netfilter/ipset/ip_set_list.h
index 68c2aea897f5..fe2622a00151 100644
--- a/include/linux/netfilter/ipset/ip_set_list.h
+++ b/include/linux/netfilter/ipset/ip_set_list.h
@@ -6,5 +6,6 @@
 
 #define IP_SET_LIST_DEFAULT_SIZE	8
 #define IP_SET_LIST_MIN_SIZE		4
+#define IP_SET_LIST_MAX_SIZE		65536
 
 #endif /* __IP_SET_LIST_H */
* Unmerged path net/netfilter/ipset/ip_set_list_set.c
