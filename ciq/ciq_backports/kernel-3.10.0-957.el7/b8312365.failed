i40e: always return all queue stat strings

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
commit-author Jacob Keller <jacob.e.keller@intel.com>
commit b8312365097ca854a03231bd58a284491aaa8ef7
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/b8312365.failed

The ethtool API for obtaining device statistics is not intended to allow
runtime changes in the number of statistics reported. It may *appear*
this way, as there is an ability to request the number of stats using
ethtool_get_set_count(). However, it is expected that this must always
return the same value for invocations of the same device.

If we don't satisfy this contract, and allow the number of stats to
change during run time, we could cause invalid memory accesses or report
the stat strings incorrectly. This is because the API for obtaining
stats is to (1) get the size, (2) get the strings and finally (3) get
the stats. Since these are each separate ethtool op commands, it is not
possible to maintain consistency by holding the RTNL lock over the whole
operation. This results in the potential for a race condition to occur
where the size changed between any of the 3 calls.

Avoid this issue by requiring that we always return the same value for
a given device. We can check any values which remain constant for the
life of the device, but must not report different sizes depending on
runtime attributes.

This patch specifically fixes the queue statistics to always return
every queue even if it's not currently in use.

	Signed-off-by: Jacob Keller <jacob.e.keller@intel.com>
	Tested-by: Andrew Bowers <andrewx.bowers@intel.com>
	Signed-off-by: Jeff Kirsher <jeffrey.t.kirsher@intel.com>
(cherry picked from commit b8312365097ca854a03231bd58a284491aaa8ef7)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/intel/i40e/i40e_ethtool.c
diff --cc drivers/net/ethernet/intel/i40e/i40e_ethtool.c
index 07042090c395,bacb01b63727..000000000000
--- a/drivers/net/ethernet/intel/i40e/i40e_ethtool.c
+++ b/drivers/net/ethernet/intel/i40e/i40e_ethtool.c
@@@ -1641,11 -1716,19 +1645,24 @@@ static void i40e_get_ethtool_stats(stru
  			    sizeof(u64)) ? *(u64 *)p : *(u32 *)p;
  	}
  	rcu_read_lock();
++<<<<<<< HEAD
 +	for (j = 0; j < vsi->num_queue_pairs; j++) {
 +		tx_ring = ACCESS_ONCE(vsi->tx_rings[j]);
- 
- 		if (!tx_ring)
++=======
+ 	for (j = 0; j < I40E_MAX_NUM_QUEUES(netdev) ; j++) {
+ 		tx_ring = READ_ONCE(vsi->tx_rings[j]);
++>>>>>>> b8312365097c (i40e: always return all queue stat strings)
+ 
+ 		if (!tx_ring) {
+ 			/* Bump the stat counter to skip these stats, and make
+ 			 * sure the memory is zero'd
+ 			 */
+ 			data[i++] = 0;
+ 			data[i++] = 0;
+ 			data[i++] = 0;
+ 			data[i++] = 0;
  			continue;
+ 		}
  
  		/* process Tx ring statistics */
  		do {
* Unmerged path drivers/net/ethernet/intel/i40e/i40e_ethtool.c
