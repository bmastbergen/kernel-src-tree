EDAC, skx_edac: Detect non-volatile DIMMs

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
Rebuild_CHGLOG: - [edac] skx_edac: Detect non-volatile DIMMs (Aristeu Rozanski) [1588177]
Rebuild_FUZZ: 92.11%
commit-author Tony Luck <tony.luck@intel.com>
commit 58ca9ac1463d07d24b9fa8befe065192abca6f76
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/58ca9ac1.failed

This just covers the topology function of the EDAC driver. We locate
which DIMM slots are populated with NVDIMMs and query the NFIT and
SMBIOS tables to get the size.

	Reviewed-by: Jean Delvare <jdelvare@suse.de>
	Signed-off-by: Tony Luck <tony.luck@intel.com>
	Cc: Aristeu Rozanski <aris@redhat.com>
	Cc: Dan Williams <dan.j.williams@intel.com>
	Cc: Len Brown <lenb@kernel.org>
	Cc: Mauro Carvalho Chehab <mchehab@kernel.org>
	Cc: Qiuxu Zhuo <qiuxu.zhuo@intel.com>
	Cc: "Rafael J. Wysocki" <rjw@rjwysocki.net>
	Cc: linux-acpi@vger.kernel.org
	Cc: linux-edac <linux-edac@vger.kernel.org>
	Cc: linux-nvdimm@lists.01.org
Link: http://lkml.kernel.org/r/20180312182430.10335-6-tony.luck@intel.com
	Signed-off-by: Borislav Petkov <bp@suse.de>
(cherry picked from commit 58ca9ac1463d07d24b9fa8befe065192abca6f76)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/edac/Kconfig
#	drivers/edac/skx_edac.c
diff --cc drivers/edac/Kconfig
index 53eb612d1b3a,07d569d32b90..000000000000
--- a/drivers/edac/Kconfig
+++ b/drivers/edac/Kconfig
@@@ -262,18 -231,36 +262,25 @@@ config EDAC_SBRIDG
  
  config EDAC_SKX
  	tristate "Intel Skylake server Integrated MC"
++<<<<<<< HEAD
 +	depends on EDAC_MM_EDAC && PCI && X86_64 && X86_MCE_INTEL
 +	depends on PCI_MMCONFIG
++=======
+ 	depends on PCI && X86_64 && X86_MCE_INTEL && PCI_MMCONFIG
+ 	select DMI
++>>>>>>> 58ca9ac1463d (EDAC, skx_edac: Detect non-volatile DIMMs)
  	help
  	  Support for error detection and correction the Intel
- 	  Skylake server Integrated Memory Controllers.
+ 	  Skylake server Integrated Memory Controllers. If your
+ 	  system has non-volatile DIMMs you should also manually
+ 	  select CONFIG_ACPI_NFIT.
  
 -config EDAC_PND2
 -	tristate "Intel Pondicherry2"
 -	depends on PCI && X86_64 && X86_MCE_INTEL
 -	help
 -	  Support for error detection and correction on the Intel
 -	  Pondicherry2 Integrated Memory Controller. This SoC IP is
 -	  first used on the Apollo Lake platform and Denverton
 -	  micro-server but may appear on others in the future.
 -
  config EDAC_MPC85XX
  	tristate "Freescale MPC83xx / MPC85xx"
 -	depends on FSL_SOC
 +	depends on EDAC_MM_EDAC && FSL_SOC && (PPC_83xx || PPC_85xx)
  	help
  	  Support for error detection and correction on the Freescale
 -	  MPC8349, MPC8560, MPC8540, MPC8548, T4240
 -
 -config EDAC_LAYERSCAPE
 -	tristate "Freescale Layerscape DDR"
 -	depends on ARCH_LAYERSCAPE || SOC_LS1021A
 -	help
 -	  Support for error detection and correction on Freescale memory
 -	  controllers on Layerscape SoCs.
 +	  MPC8349, MPC8560, MPC8540, MPC8548
  
  config EDAC_MV64X60
  	tristate "Marvell MV64x60"
diff --cc drivers/edac/skx_edac.c
index 88bf4e89553b,fae095162c01..000000000000
--- a/drivers/edac/skx_edac.c
+++ b/drivers/edac/skx_edac.c
@@@ -470,12 -524,16 +524,21 @@@ static int skx_register_mci(struct skx_
  
  	mci->ctl_name = kasprintf(GFP_KERNEL, "Skylake Socket#%d IMC#%d",
  				  imc->node_id, imc->lmc);
++<<<<<<< HEAD
 +	mci->mtype_cap = MEM_FLAG_DDR4;
++=======
+ 	if (!mci->ctl_name) {
+ 		rc = -ENOMEM;
+ 		goto fail0;
+ 	}
+ 
+ 	mci->mtype_cap = MEM_FLAG_DDR4 | MEM_FLAG_NVDIMM;
++>>>>>>> 58ca9ac1463d (EDAC, skx_edac: Detect non-volatile DIMMs)
  	mci->edac_ctl_cap = EDAC_FLAG_NONE;
  	mci->edac_cap = EDAC_FLAG_NONE;
 -	mci->mod_name = EDAC_MOD_STR;
 +	mci->mod_name = "skx_edac.c";
  	mci->dev_name = pci_name(imc->chan[0].cdev);
 +	mci->mod_ver = SKX_REVISION;
  	mci->ctl_page_to_phys = NULL;
  
  	rc = skx_get_dimm_config(mci);
* Unmerged path drivers/edac/Kconfig
* Unmerged path drivers/edac/skx_edac.c
