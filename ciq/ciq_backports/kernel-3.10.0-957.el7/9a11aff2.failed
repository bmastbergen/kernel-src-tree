net: aquantia: oops when shutdown on already stopped device

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
Rebuild_CHGLOG: - [netdrv] aquantia: oops when shutdown on already stopped device (David Arcari) [1570787]
Rebuild_FUZZ: 95.58%
commit-author Igor Russkikh <igor.russkikh@aquantia.com>
commit 9a11aff25fd43d5bd2660ababdc9f564b0ba183a
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/9a11aff2.failed

In case netdev is closed at the moment of pci shutdown, aq_nic_stop
gets called second time. napi_disable in that case hangs indefinitely.
In other case, if device was never opened at all, we get oops because
of null pointer access.

We should invoke aq_nic_stop conditionally, only if device is running
at the moment of shutdown.

	Reported-by: David Arcari <darcari@redhat.com>
Fixes: 90869ddfefeb ("net: aquantia: Implement pci shutdown callback")
	Signed-off-by: Igor Russkikh <igor.russkikh@aquantia.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 9a11aff25fd43d5bd2660ababdc9f564b0ba183a)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/aquantia/atlantic/aq_nic.c
diff --cc drivers/net/ethernet/aquantia/atlantic/aq_nic.c
index 06b1526703b5,32f6d2e24d66..000000000000
--- a/drivers/net/ethernet/aquantia/atlantic/aq_nic.c
+++ b/drivers/net/ethernet/aquantia/atlantic/aq_nic.c
@@@ -1054,3 -939,25 +1054,28 @@@ err_exit
  out:
  	return err;
  }
++<<<<<<< HEAD
++=======
+ 
+ void aq_nic_shutdown(struct aq_nic_s *self)
+ {
+ 	int err = 0;
+ 
+ 	if (!self->ndev)
+ 		return;
+ 
+ 	rtnl_lock();
+ 
+ 	netif_device_detach(self->ndev);
+ 
+ 	if (netif_running(self->ndev)) {
+ 		err = aq_nic_stop(self);
+ 		if (err < 0)
+ 			goto err_exit;
+ 	}
+ 	aq_nic_deinit(self);
+ 
+ err_exit:
+ 	rtnl_unlock();
 -}
++}
++>>>>>>> 9a11aff25fd4 (net: aquantia: oops when shutdown on already stopped device)
* Unmerged path drivers/net/ethernet/aquantia/atlantic/aq_nic.c
