selinux: fix bug in conditional rules handling

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
commit-author Stephen Smalley <sds@tycho.nsa.gov>
commit f3bef67992e8698897b584616535803887c4a73e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/f3bef679.failed

commit fa1aa143ac4a ("selinux: extended permissions for ioctls")
introduced a bug into the handling of conditional rules, skipping the
processing entirely when the caller does not provide an extended
permissions (xperms) structure.  Access checks from userspace using
/sys/fs/selinux/access do not include such a structure since that
interface does not presently expose extended permission information.
As a result, conditional rules were being ignored entirely on userspace
access requests, producing denials when access was allowed by
conditional rules in the policy.  Fix the bug by only skipping
computation of extended permissions in this situation, not the entire
conditional rules processing.

	Reported-by: Laurent Bigonville <bigon@debian.org>
	Signed-off-by: Stephen Smalley <sds@tycho.nsa.gov>
[PM: fixed long lines in patch description]
	Cc: stable@vger.kernel.org # 4.3
	Signed-off-by: Paul Moore <pmoore@redhat.com>
(cherry picked from commit f3bef67992e8698897b584616535803887c4a73e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	security/selinux/ss/conditional.c
diff --cc security/selinux/ss/conditional.c
index 377d148e7157,456e1a9bcfde..000000000000
--- a/security/selinux/ss/conditional.c
+++ b/security/selinux/ss/conditional.c
@@@ -639,10 -653,13 +639,17 @@@ void cond_compute_av(struct avtab *ctab
  			 * the '&' operand to ensure that all '0's in the mask
  			 * are retained (much unlike the allow and auditallow cases).
  			 */
 -			avd->auditdeny &= node->datum.u.data;
 +			avd->auditdeny &= node->datum.data;
  		if ((u16)(AVTAB_AUDITALLOW|AVTAB_ENABLED) ==
  		    (node->key.specified & (AVTAB_AUDITALLOW|AVTAB_ENABLED)))
++<<<<<<< HEAD
 +			avd->auditallow |= node->datum.data;
++=======
+ 			avd->auditallow |= node->datum.u.data;
+ 		if (xperms && (node->key.specified & AVTAB_ENABLED) &&
+ 				(node->key.specified & AVTAB_XPERMS))
+ 			services_compute_xperms_drivers(xperms, node);
++>>>>>>> f3bef67992e8 (selinux: fix bug in conditional rules handling)
  	}
  	return;
  }
* Unmerged path security/selinux/ss/conditional.c
