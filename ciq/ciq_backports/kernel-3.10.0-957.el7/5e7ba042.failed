qed: Fix reading stale configuration information

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
commit-author Denis Bolotin <denis.bolotin@cavium.com>
commit 5e7ba042fd05043416babace5a4a953e29cf2826
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/5e7ba042.failed

Configuration information read at driver load can become stale after it is
updated. Mark information as not valid and re-populate when this happens.

	Signed-off-by: Denis Bolotin <denis.bolotin@cavium.com>
	Signed-off-by: Ariel Elior <ariel.elior@cavium.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 5e7ba042fd05043416babace5a4a953e29cf2826)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/qlogic/qed/qed_mcp.c
diff --cc drivers/net/ethernet/qlogic/qed/qed_mcp.c
index 6f9927d1a501,9d9e533bccdc..000000000000
--- a/drivers/net/ethernet/qlogic/qed/qed_mcp.c
+++ b/drivers/net/ethernet/qlogic/qed/qed_mcp.c
@@@ -2578,10 -2584,10 +2584,17 @@@ int qed_mcp_nvm_info_populate(struct qe
  		goto err0;
  	}
  
++<<<<<<< HEAD
 +	nvm_info->image_att = kmalloc(nvm_info->num_images *
 +				      sizeof(struct bist_nvm_image_att),
 +				      GFP_KERNEL);
 +	if (!nvm_info->image_att) {
++=======
+ 	nvm_info.image_att = kmalloc_array(nvm_info.num_images,
+ 					   sizeof(struct bist_nvm_image_att),
+ 					   GFP_KERNEL);
+ 	if (!nvm_info.image_att) {
++>>>>>>> 5e7ba042fd05 (qed: Fix reading stale configuration information)
  		rc = -ENOMEM;
  		goto err0;
  	}
diff --git a/drivers/net/ethernet/qlogic/qed/qed.h b/drivers/net/ethernet/qlogic/qed/qed.h
index 00db3401b898..1dfaccd151f0 100644
--- a/drivers/net/ethernet/qlogic/qed/qed.h
+++ b/drivers/net/ethernet/qlogic/qed/qed.h
@@ -502,6 +502,7 @@ enum BAR_ID {
 struct qed_nvm_image_info {
 	u32 num_images;
 	struct bist_nvm_image_att *image_att;
+	bool valid;
 };
 
 #define DRV_MODULE_VERSION		      \
* Unmerged path drivers/net/ethernet/qlogic/qed/qed_mcp.c
