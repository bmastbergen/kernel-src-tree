scsi: qla2xxx: Fix n2n_ae flag to prevent dev_loss on PDB change

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
Rebuild_CHGLOG: - [scsi] qla2xxx: Fix n2n_ae flag to prevent dev_loss on PDB change (Himanshu Madhani) [1547714]
Rebuild_FUZZ: 95.08%
commit-author Darren Trapp <darren.trapp@cavium.com>
commit 1763c1fd76d8e26c5e6d5a3e415e7deeeda3c5da
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/1763c1fd.failed

On a port db changes, this patch will set n2n_ae flag for N2N
connection when requesting for Report ID Acquition MBX, instead
of Loop Initialization or point to point asynchronous events.

	Signed-off-by: Darren Trapp <darren.trapp@cavium.com>
	Signed-off-by: Himanshu Madhani <himanshu.madhani@cavium.com>
	Reviewed-by: Hannes Reinecke <hare@suse.com>
	Reviewed-by: Johannes Thumshirn <jthumshirn@suse.de>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit 1763c1fd76d8e26c5e6d5a3e415e7deeeda3c5da)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/qla2xxx/qla_def.h
#	drivers/scsi/qla2xxx/qla_isr.c
#	drivers/scsi/qla2xxx/qla_mbx.c
diff --cc drivers/scsi/qla2xxx/qla_def.h
index d0397ca42fad,cba749d27154..000000000000
--- a/drivers/scsi/qla2xxx/qla_def.h
+++ b/drivers/scsi/qla2xxx/qla_def.h
@@@ -4104,6 -4278,10 +4104,13 @@@ typedef struct scsi_qla_host 
  	uint8_t		port_name[WWN_SIZE];
  	uint8_t		fabric_node_name[WWN_SIZE];
  
++<<<<<<< HEAD
++=======
+ 	struct		nvme_fc_local_port *nvme_local_port;
+ 	struct completion nvme_del_done;
+ 	struct list_head nvme_rport_list;
+ 
++>>>>>>> 1763c1fd76d8 (scsi: qla2xxx: Fix n2n_ae flag to prevent dev_loss on PDB change)
  	uint16_t	fcoe_vlan_id;
  	uint16_t	fcoe_fcf_idx;
  	uint8_t		fcoe_vn_port_mac[6];
diff --cc drivers/scsi/qla2xxx/qla_isr.c
index 55510f69f284,913cd6cf5907..000000000000
--- a/drivers/scsi/qla2xxx/qla_isr.c
+++ b/drivers/scsi/qla2xxx/qla_isr.c
@@@ -813,7 -809,7 +812,11 @@@ skip_rio
  		break;
  
  	case MBA_LOOP_DOWN:		/* Loop Down Event */
++<<<<<<< HEAD
 +		ha->flags.n2n_ae = 0;
++=======
+ 		SAVE_TOPO(ha);
++>>>>>>> 1763c1fd76d8 (scsi: qla2xxx: Fix n2n_ae flag to prevent dev_loss on PDB change)
  		ha->flags.lip_ae = 0;
  		ha->current_topology = 0;
  
diff --cc drivers/scsi/qla2xxx/qla_mbx.c
index 5997303a0944,735079ba691c..000000000000
--- a/drivers/scsi/qla2xxx/qla_mbx.c
+++ b/drivers/scsi/qla2xxx/qla_mbx.c
@@@ -3679,7 -3770,42 +3680,42 @@@ qla24xx_report_id_acquisition(scsi_qla_
  			rptid_entry->vp_status,
  		    rptid_entry->port_id[2], rptid_entry->port_id[1],
  		    rptid_entry->port_id[0]);
 -		ql_dbg(ql_dbg_async, vha, 0x5075,
 -		   "Format 1: Remote WWPN %8phC.\n",
 -		   rptid_entry->u.f1.port_name);
  
++<<<<<<< HEAD
++=======
+ 		ql_dbg(ql_dbg_async, vha, 0x5075,
+ 		   "Format 1: WWPN %8phC.\n",
+ 		   vha->port_name);
+ 
+ 		/* N2N.  direct connect */
+ 		if (IS_QLA27XX(ha) &&
+ 		    ((rptid_entry->u.f1.flags>>1) & 0x7) == 2) {
+ 			/* if our portname is higher then initiate N2N login */
+ 			if (wwn_to_u64(vha->port_name) >
+ 			    wwn_to_u64(rptid_entry->u.f1.port_name)) {
+ 				// ??? qlt_update_host_map(vha, id);
+ 				vha->n2n_id = 0x1;
+ 				ql_dbg(ql_dbg_async, vha, 0x5075,
+ 				    "Format 1: Setting n2n_update_needed for id %d\n",
+ 				    vha->n2n_id);
+ 			} else {
+ 				ql_dbg(ql_dbg_async, vha, 0x5075,
+ 				    "Format 1: Remote login - Waiting for WWPN %8phC.\n",
+ 				    rptid_entry->u.f1.port_name);
+ 			}
+ 
+ 			memcpy(vha->n2n_port_name, rptid_entry->u.f1.port_name,
+ 			    WWN_SIZE);
+ 			set_bit(N2N_LOGIN_NEEDED, &vha->dpc_flags);
+ 			set_bit(REGISTER_FC4_NEEDED, &vha->dpc_flags);
+ 			set_bit(REGISTER_FDMI_NEEDED, &vha->dpc_flags);
+ 			ha->flags.n2n_ae = 1;
+ 			return;
+ 		}
+ 
+ 		ha->flags.gpsc_supported = 1;
+ 		ha->current_topology = ISP_CFG_F;
++>>>>>>> 1763c1fd76d8 (scsi: qla2xxx: Fix n2n_ae flag to prevent dev_loss on PDB change)
  		/* buffer to buffer credit flag */
  		vha->flags.bbcr_enable = (rptid_entry->u.f1.bbcr & 0xf) != 0;
  
* Unmerged path drivers/scsi/qla2xxx/qla_def.h
* Unmerged path drivers/scsi/qla2xxx/qla_isr.c
* Unmerged path drivers/scsi/qla2xxx/qla_mbx.c
