mlxsw: spectrum: Move netdevice NB to struct mlxsw_sp

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
commit-author Petr Machata <petrm@mellanox.com>
commit c30f5d012edf755959c44d71757fbf4648ad75a8
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/c30f5d01.failed

So far, all netdevice notifications that the driver cared about were
related to its own ports, and mlxsw_sp could be retrieved from the
netdevice's private data. For IP-in-IP offloading however, the driver
cares about events on foreign netdevices, and getting at mlxsw_sp or
router data structures from the handler is inconvenient.

Therefore move the netdevice notifier blocks from global scope to struct
mlxsw_sp to allow retrieval from the notifier block pointer itself.

	Signed-off-by: Petr Machata <petrm@mellanox.com>
	Reviewed-by: Ido Schimmel <idosch@mellanox.com>
	Signed-off-by: Jiri Pirko <jiri@mellanox.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit c30f5d012edf755959c44d71757fbf4648ad75a8)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlxsw/spectrum.c
diff --cc drivers/net/ethernet/mellanox/mlxsw/spectrum.c
index aa0e2cbb619f,83f9c2564f61..000000000000
--- a/drivers/net/ethernet/mellanox/mlxsw/spectrum.c
+++ b/drivers/net/ethernet/mellanox/mlxsw/spectrum.c
@@@ -4573,7 -4544,6 +4585,10 @@@ static int __init mlxsw_sp_module_init(
  {
  	int err;
  
++<<<<<<< HEAD
 +	register_netdevice_notifier_rh(&mlxsw_sp_netdevice_nb);
++=======
++>>>>>>> c30f5d012edf (mlxsw: spectrum: Move netdevice NB to struct mlxsw_sp)
  	register_inetaddr_notifier(&mlxsw_sp_inetaddr_nb);
  	register_inet6addr_notifier(&mlxsw_sp_inet6addr_nb);
  	register_netevent_notifier(&mlxsw_sp_router_netevent_nb);
@@@ -4594,7 -4564,6 +4609,10 @@@ err_core_driver_register
  	unregister_netevent_notifier(&mlxsw_sp_router_netevent_nb);
  	unregister_inet6addr_notifier(&mlxsw_sp_inet6addr_nb);
  	unregister_inetaddr_notifier(&mlxsw_sp_inetaddr_nb);
++<<<<<<< HEAD
 +	unregister_netdevice_notifier_rh(&mlxsw_sp_netdevice_nb);
++=======
++>>>>>>> c30f5d012edf (mlxsw: spectrum: Move netdevice NB to struct mlxsw_sp)
  	return err;
  }
  
@@@ -4605,7 -4574,6 +4623,10 @@@ static void __exit mlxsw_sp_module_exit
  	unregister_netevent_notifier(&mlxsw_sp_router_netevent_nb);
  	unregister_inet6addr_notifier(&mlxsw_sp_inet6addr_nb);
  	unregister_inetaddr_notifier(&mlxsw_sp_inetaddr_nb);
++<<<<<<< HEAD
 +	unregister_netdevice_notifier_rh(&mlxsw_sp_netdevice_nb);
++=======
++>>>>>>> c30f5d012edf (mlxsw: spectrum: Move netdevice NB to struct mlxsw_sp)
  }
  
  module_init(mlxsw_sp_module_init);
* Unmerged path drivers/net/ethernet/mellanox/mlxsw/spectrum.c
diff --git a/drivers/net/ethernet/mellanox/mlxsw/spectrum.h b/drivers/net/ethernet/mellanox/mlxsw/spectrum.h
index 8e45183dc9bb..e1a0157c0b94 100644
--- a/drivers/net/ethernet/mellanox/mlxsw/spectrum.h
+++ b/drivers/net/ethernet/mellanox/mlxsw/spectrum.h
@@ -161,6 +161,7 @@ struct mlxsw_sp {
 	struct {
 		DECLARE_BITMAP(usage, MLXSW_SP_KVD_LINEAR_SIZE);
 	} kvdl;
+	struct notifier_block netdevice_nb;
 
 	struct mlxsw_sp_counter_pool *counter_pool;
 	struct {
