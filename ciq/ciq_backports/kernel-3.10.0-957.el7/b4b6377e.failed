ASoC: Intel: bytcr_rt5651: Change defaults to enable jack-detect, analog mics

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
Rebuild_CHGLOG: - [sound] alsa: asoc: intel: bytcr_rt5651: Change defaults to enable jack-detect, analog mics (Jaroslav Kysela) [1535427]
Rebuild_FUZZ: 96.25%
commit-author Hans de Goede <hdegoede@redhat.com>
commit b4b6377e07727df8292539062d9a56e6bd83ba89
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/b4b6377e.failed

Change the default quirk settings to enable jack-detect, analog mics.

The old default input mapping of DMIC for non Bay Trail CR devices seems
like a poor default as I'm not aware of any Intel SST + rt5651 using
devices with a DMIC.

All Cherry Trail devices using the bytcr_rt5651 machine driver seem to be
modelled after BYT-CR devices, And the only non CR Bay Trail devices with
a rt5651 codec I'm aware of are the Minnow boards for which we already have
board specific quirks. So it seems better to me to use the BYT-CR defaults
everywhere.

This e.g. makes the Chuwi Hi8 Pro (CWI513) work ootb without needing a
quirk.

	Signed-off-by: Hans de Goede <hdegoede@redhat.com>
	Signed-off-by: Mark Brown <broonie@kernel.org>
(cherry picked from commit b4b6377e07727df8292539062d9a56e6bd83ba89)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	sound/soc/intel/boards/bytcr_rt5651.c
diff --cc sound/soc/intel/boards/bytcr_rt5651.c
index ab9dd9ad4647,6efd7c9e7407..000000000000
--- a/sound/soc/intel/boards/bytcr_rt5651.c
+++ b/sound/soc/intel/boards/bytcr_rt5651.c
@@@ -81,8 -85,12 +81,17 @@@ struct byt_rt5651_private 
  	struct snd_soc_jack jack;
  };
  
++<<<<<<< HEAD
 +static unsigned long byt_rt5651_quirk = BYT_RT5651_DMIC_MAP |
 +					BYT_RT5651_MCLK_EN;
++=======
+ /* Default: jack-detect on JD1_1, internal mic on in2, headsetmic on in3 */
+ static unsigned long byt_rt5651_quirk = BYT_RT5651_MCLK_EN |
+ 					BYT_RT5651_JD1_1 |
+ 					BYT_RT5651_OVCD_TH_2000UA |
+ 					BYT_RT5651_OVCD_SF_0P75 |
+ 					BYT_RT5651_IN2_HS_IN3_MAP;
++>>>>>>> b4b6377e0772 (ASoC: Intel: bytcr_rt5651: Change defaults to enable jack-detect, analog mics)
  
  static void log_quirks(struct device *dev)
  {
@@@ -647,12 -748,72 +656,72 @@@ static int snd_byt_rt5651_mc_probe(stru
  	}
  
  	/* fixup codec name based on HID */
 -	i2c_name = acpi_dev_get_first_match_name(mach->id, NULL, -1);
 -	if (!i2c_name) {
 -		dev_err(&pdev->dev, "Error cannot find '%s' dev\n", mach->id);
 -		return -ENODEV;
 -	}
 -	snprintf(byt_rt5651_codec_name, sizeof(byt_rt5651_codec_name),
 -		"%s%s", "i2c-", i2c_name);
 -	byt_rt5651_dais[dai_index].codec_name = byt_rt5651_codec_name;
 -
 +	i2c_name = sst_acpi_find_name_from_hid(mach->id);
 +	if (i2c_name) {
 +		snprintf(byt_rt5651_codec_name, sizeof(byt_rt5651_codec_name),
 +			"%s%s", "i2c-", i2c_name);
 +
++<<<<<<< HEAD
 +		byt_rt5651_dais[dai_index].codec_name = byt_rt5651_codec_name;
++=======
+ 	/*
+ 	 * swap SSP0 if bytcr is detected
+ 	 * (will be overridden if DMI quirk is detected)
+ 	 */
+ 	if (is_valleyview()) {
+ 		struct sst_platform_info *p_info = mach->pdata;
+ 		const struct sst_res_info *res_info = p_info->res_info;
+ 
+ 		if (res_info->acpi_ipc_irq_index == 0)
+ 			is_bytcr = true;
+ 	}
+ 
+ 	if (is_bytcr) {
+ 		/*
+ 		 * Baytrail CR platforms may have CHAN package in BIOS, try
+ 		 * to find relevant routing quirk based as done on Windows
+ 		 * platforms. We have to read the information directly from the
+ 		 * BIOS, at this stage the card is not created and the links
+ 		 * with the codec driver/pdata are non-existent
+ 		 */
+ 
+ 		struct acpi_chan_package chan_package;
+ 
+ 		/* format specified: 2 64-bit integers */
+ 		struct acpi_buffer format = {sizeof("NN"), "NN"};
+ 		struct acpi_buffer state = {0, NULL};
+ 		struct snd_soc_acpi_package_context pkg_ctx;
+ 		bool pkg_found = false;
+ 
+ 		state.length = sizeof(chan_package);
+ 		state.pointer = &chan_package;
+ 
+ 		pkg_ctx.name = "CHAN";
+ 		pkg_ctx.length = 2;
+ 		pkg_ctx.format = &format;
+ 		pkg_ctx.state = &state;
+ 		pkg_ctx.data_valid = false;
+ 
+ 		pkg_found = snd_soc_acpi_find_package_from_hid(mach->id,
+ 							       &pkg_ctx);
+ 		if (pkg_found) {
+ 			if (chan_package.aif_value == 1) {
+ 				dev_info(&pdev->dev, "BIOS Routing: AIF1 connected\n");
+ 				byt_rt5651_quirk |= BYT_RT5651_SSP0_AIF1;
+ 			} else  if (chan_package.aif_value == 2) {
+ 				dev_info(&pdev->dev, "BIOS Routing: AIF2 connected\n");
+ 				byt_rt5651_quirk |= BYT_RT5651_SSP0_AIF2;
+ 			} else {
+ 				dev_info(&pdev->dev, "BIOS Routing isn't valid, ignored\n");
+ 				pkg_found = false;
+ 			}
+ 		}
+ 
+ 		if (!pkg_found) {
+ 			/* no BIOS indications, assume SSP0-AIF2 connection */
+ 			byt_rt5651_quirk |= BYT_RT5651_SSP0_AIF2;
+ 		}
++>>>>>>> b4b6377e0772 (ASoC: Intel: bytcr_rt5651: Change defaults to enable jack-detect, analog mics)
  	}
  
  	/* check quirks before creating card */
* Unmerged path sound/soc/intel/boards/bytcr_rt5651.c
