perf/x86: Enable free running PEBS for REGS_USER/INTR

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
commit-author Andi Kleen <ak@linux.intel.com>
commit a47ba4d77e1236d214e5116b5631bc4c2d6e6369
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/a47ba4d7.failed

Currently free running PEBS is disabled when user or interrupt
registers are requested. Most of the registers are actually
available in the PEBS record and can be supported.

So we just need to check for the supported registers and then
allow it: it is all except for the segment register.

For user registers this only works when the counter is limited
to ring 3 only, so this also needs to be checked.

	Signed-off-by: Andi Kleen <ak@linux.intel.com>
	Signed-off-by: Peter Zijlstra (Intel) <peterz@infradead.org>
	Cc: Linus Torvalds <torvalds@linux-foundation.org>
	Cc: Peter Zijlstra <peterz@infradead.org>
	Cc: Thomas Gleixner <tglx@linutronix.de>
Link: http://lkml.kernel.org/r/20170831214630.21892-1-andi@firstfloor.org
	Signed-off-by: Ingo Molnar <mingo@kernel.org>
(cherry picked from commit a47ba4d77e1236d214e5116b5631bc4c2d6e6369)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/events/intel/core.c
#	arch/x86/events/perf_event.h
diff --cc arch/x86/events/intel/core.c
index 5aafb5e77243,cfd91a03304d..000000000000
--- a/arch/x86/events/intel/core.c
+++ b/arch/x86/events/intel/core.c
@@@ -2888,16 -2956,12 +2888,23 @@@ static unsigned long intel_pmu_free_run
  {
  	unsigned long flags = x86_pmu.free_running_flags;
  
 +	/*
 +	 * RHEL7 ommiting following upstream bit unset,
 +	 * because we dont support use_clockid yet.
 +	 *
 +
  	if (event->attr.use_clockid)
  		flags &= ~PERF_SAMPLE_TIME;
++<<<<<<< HEAD
 +
 +	*/
 +
++=======
+ 	if (!event->attr.exclude_kernel)
+ 		flags &= ~PERF_SAMPLE_REGS_USER;
+ 	if (event->attr.sample_regs_user & ~PEBS_REGS)
+ 		flags &= ~(PERF_SAMPLE_REGS_USER | PERF_SAMPLE_REGS_INTR);
++>>>>>>> a47ba4d77e12 (perf/x86: Enable free running PEBS for REGS_USER/INTR)
  	return flags;
  }
  
diff --cc arch/x86/events/perf_event.h
index 24270b406370,f7aaadf9331f..000000000000
--- a/arch/x86/events/perf_event.h
+++ b/arch/x86/events/perf_event.h
@@@ -90,7 -92,8 +91,12 @@@ struct amd_nb 
  	(PERF_SAMPLE_IP | PERF_SAMPLE_TID | PERF_SAMPLE_ADDR | \
  	PERF_SAMPLE_ID | PERF_SAMPLE_CPU | PERF_SAMPLE_STREAM_ID | \
  	PERF_SAMPLE_DATA_SRC | PERF_SAMPLE_IDENTIFIER | \
++<<<<<<< HEAD
 +	PERF_SAMPLE_TRANSACTION)
++=======
+ 	PERF_SAMPLE_TRANSACTION | PERF_SAMPLE_PHYS_ADDR | \
+ 	PERF_SAMPLE_REGS_INTR | PERF_SAMPLE_REGS_USER)
++>>>>>>> a47ba4d77e12 (perf/x86: Enable free running PEBS for REGS_USER/INTR)
  
  /*
   * A debug store configuration.
* Unmerged path arch/x86/events/intel/core.c
* Unmerged path arch/x86/events/perf_event.h
