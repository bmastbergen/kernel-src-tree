target/pscsi: Fix TYPE_TAPE + TYPE_MEDIMUM_CHANGER export

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
Rebuild_CHGLOG: - [target] pscsi: Fix TYPE_TAPE + TYPE_MEDIMUM_CHANGER export (Maurizio Lombardi) [1585081]
Rebuild_FUZZ: 93.46%
commit-author Nicholas Bellinger <nab@linux-iscsi.org>
commit a04e54f2c35823ca32d56afcd5cea5b783e2f51a
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/a04e54f2.failed

The following fixes a divide by zero OOPs with TYPE_TAPE
due to pscsi_tape_read_blocksize() failing causing a zero
sd->sector_size being propigated up via dev_attrib.hw_block_size.

It also fixes another long-standing bug where TYPE_TAPE and
TYPE_MEDIMUM_CHANGER where using pscsi_create_type_other(),
which does not call scsi_device_get() to take the device
reference.  Instead, rename pscsi_create_type_rom() to
pscsi_create_type_nondisk() and use it for all cases.

Finally, also drop a dump_stack() in pscsi_get_blocks() for
non TYPE_DISK, which in modern target-core can get invoked
via target_sense_desc_format() during CHECK_CONDITION.

	Reported-by: Malcolm Haak <insanemal@gmail.com>
	Cc: <stable@vger.kernel.org>
	Signed-off-by: Nicholas Bellinger <nab@linux-iscsi.org>
(cherry picked from commit a04e54f2c35823ca32d56afcd5cea5b783e2f51a)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/target/target_core_pscsi.c
diff --cc drivers/target/target_core_pscsi.c
index a162d3717925,44d92f23a3f0..000000000000
--- a/drivers/target/target_core_pscsi.c
+++ b/drivers/target/target_core_pscsi.c
@@@ -435,28 -437,6 +439,31 @@@ static int pscsi_create_type_nondisk(st
  	return 0;
  }
  
++<<<<<<< HEAD
 +/*
 + * Called with struct Scsi_Host->host_lock called.
 + */
 +static int pscsi_create_type_other(struct se_device *dev,
 +		struct scsi_device *sd)
 +	__releases(sh->host_lock)
 +{
 +	struct pscsi_hba_virt *phv = dev->se_hba->hba_ptr;
 +	struct Scsi_Host *sh = sd->host;
 +	int ret;
 +
 +	spin_unlock_irq(sh->host_lock);
 +	ret = pscsi_add_device_to_list(dev, sd);
 +	if (ret)
 +		return ret;
 +
 +	pr_debug("CORE_PSCSI[%d] - Added Type: %s for %d:%d:%d:%d\n",
 +		phv->phv_host_id, scsi_device_type(sd->type), sh->host_no,
 +		sd->channel, sd->id, sd->lun);
 +	return 0;
 +}
 +
++=======
++>>>>>>> a04e54f2c358 (target/pscsi: Fix TYPE_TAPE + TYPE_MEDIMUM_CHANGER export)
  static int pscsi_configure_device(struct se_device *dev)
  {
  	struct se_hba *hba = dev->se_hba;
* Unmerged path drivers/target/target_core_pscsi.c
