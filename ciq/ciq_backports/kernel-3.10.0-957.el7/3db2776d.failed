dm snapshot: improve performance by switching out_of_order_list to rbtree

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
commit-author David Jeffery <djeffery@redhat.com>
commit 3db2776d9fca45305e6c2065905d9a0e7b2c8212
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/3db2776d.failed

copy_complete()'s processing of out_of_order_list can result in
quadratic complexity in the worst case.  As such it was the source of
consuming too much cpu and the source of significant loss in
performance.

Fix this by converting out_of_order_list to an rbtree.  This improved
a dm-snapshot test copy workload from 32 seconds to 4 seconds.

	Signed-off-by: David Jeffery <djeffery@redhat.com>
	Signed-off-by: Mikulas Patocka <mpatocka@redhat.com>
	Tested-by: Brett Hull <bhull@redhat.com>
	Signed-off-by: Mike Snitzer <snitzer@redhat.com>
(cherry picked from commit 3db2776d9fca45305e6c2065905d9a0e7b2c8212)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/md/dm-snap.c
diff --cc drivers/md/dm-snap.c
index 2cc2e2ca8766,6f72ac7bbf9a..000000000000
--- a/drivers/md/dm-snap.c
+++ b/drivers/md/dm-snap.c
@@@ -85,9 -85,9 +85,9 @@@ struct dm_snapshot 
  	 * A list of pending exceptions that completed out of order.
  	 * Protected by kcopyd single-threaded callback.
  	 */
- 	struct list_head out_of_order_list;
+ 	struct rb_root out_of_order_tree;
  
 -	mempool_t pending_pool;
 +	mempool_t *pending_pool;
  
  	struct dm_exception_table pending;
  	struct dm_exception_table complete;
@@@ -1171,8 -1173,8 +1171,13 @@@ static int snapshot_ctr(struct dm_targe
  	atomic_set(&s->pending_exceptions_count, 0);
  	s->exception_start_sequence = 0;
  	s->exception_complete_sequence = 0;
++<<<<<<< HEAD
 +	INIT_LIST_HEAD(&s->out_of_order_list);
 +	init_rwsem(&s->lock);
++=======
+ 	s->out_of_order_tree = RB_ROOT;
+ 	mutex_init(&s->lock);
++>>>>>>> 3db2776d9fca (dm snapshot: improve performance by switching out_of_order_list to rbtree)
  	INIT_LIST_HEAD(&s->list);
  	spin_lock_init(&s->pe_lock);
  	s->state_bits = 0;
* Unmerged path drivers/md/dm-snap.c
