RDMA/cxgb4: Convert timers to use timer_setup()

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
commit-author Kees Cook <keescook@chromium.org>
commit a9346abed52f08e3e0ceb66d51f527ea11698d3c
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/a9346abe.failed

In preparation for unconditionally passing the struct timer_list pointer to
all timer callbacks, switch to using the new timer_setup() and from_timer()
to pass the timer pointer explicitly. Also removes an unused timer and
drops a redundant initialization.

	Cc: Steve Wise <swise@chelsio.com>
	Cc: Doug Ledford <dledford@redhat.com>
	Cc: Sean Hefty <sean.hefty@intel.com>
	Cc: Hal Rosenstock <hal.rosenstock@gmail.com>
	Cc: linux-rdma@vger.kernel.org
	Signed-off-by: Kees Cook <keescook@chromium.org>
	Acked-by: Steve Wise <swise@opengridcomputing.com>
	Signed-off-by: Doug Ledford <dledford@redhat.com>
(cherry picked from commit a9346abed52f08e3e0ceb66d51f527ea11698d3c)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/hw/cxgb4/cm.c
diff --cc drivers/infiniband/hw/cxgb4/cm.c
index 3bf683cc450e,fc981e68f0b2..000000000000
--- a/drivers/infiniband/hw/cxgb4/cm.c
+++ b/drivers/infiniband/hw/cxgb4/cm.c
@@@ -2104,9 -2098,8 +2102,14 @@@ static int c4iw_reconnect(struct c4iw_e
  	int iptype;
  	__u8 *ra;
  
++<<<<<<< HEAD
 +	pr_debug("qp %p cm_id %p\n", ep->com.qp, ep->com.cm_id);
 +	init_timer(&ep->timer);
 +	c4iw_init_wr_wait(ep->com.wr_waitp);
++=======
+ 	pr_debug("%s qp %p cm_id %p\n", __func__, ep->com.qp, ep->com.cm_id);
+ 	c4iw_init_wr_wait(&ep->com.wr_wait);
++>>>>>>> a9346abed52f (RDMA/cxgb4: Convert timers to use timer_setup())
  
  	/* When MPA revision is different on nodes, the node with MPA_rev=2
  	 * tries to reconnect with MPA_rev 1 for the same EP through
@@@ -2578,10 -2573,10 +2581,10 @@@ static int pass_accept_req(struct c4iw_
  	child_ep->dst = dst;
  	child_ep->hwtid = hwtid;
  
 -	pr_debug("%s tx_chan %u smac_idx %u rss_qid %u\n", __func__,
 +	pr_debug("tx_chan %u smac_idx %u rss_qid %u\n",
  		 child_ep->tx_chan, child_ep->smac_idx, child_ep->rss_qid);
  
- 	init_timer(&child_ep->timer);
+ 	timer_setup(&child_ep->timer, ep_timeout, 0);
  	cxgb4_insert_tid(t, child_ep, hwtid,
  			 child_ep->com.local_addr.ss_family);
  	insert_ep_tid(child_ep);
* Unmerged path drivers/infiniband/hw/cxgb4/cm.c
diff --git a/drivers/infiniband/hw/cxgb4/iw_cxgb4.h b/drivers/infiniband/hw/cxgb4/iw_cxgb4.h
index 9b87ba1e7c47..00d31f7f4804 100644
--- a/drivers/infiniband/hw/cxgb4/iw_cxgb4.h
+++ b/drivers/infiniband/hw/cxgb4/iw_cxgb4.h
@@ -543,7 +543,6 @@ struct c4iw_qp {
 	struct mutex mutex;
 	struct kref kref;
 	wait_queue_head_t wait;
-	struct timer_list timer;
 	int sq_sig_all;
 	struct work_struct free_work;
 	struct c4iw_ucontext *ucontext;
diff --git a/drivers/infiniband/hw/cxgb4/qp.c b/drivers/infiniband/hw/cxgb4/qp.c
index 73ff8e3ae9fc..ff43ba97977d 100644
--- a/drivers/infiniband/hw/cxgb4/qp.c
+++ b/drivers/infiniband/hw/cxgb4/qp.c
@@ -2006,7 +2006,6 @@ struct ib_qp *c4iw_create_qp(struct ib_pd *pd, struct ib_qp_init_attr *attrs,
 		qhp->ucontext = ucontext;
 	}
 	qhp->ibqp.qp_num = qhp->wq.sq.qid;
-	init_timer(&(qhp->timer));
 	INIT_LIST_HEAD(&qhp->db_fc_entry);
 	pr_debug("sq id %u size %u memsize %zu num_entries %u rq id %u size %u memsize %zu num_entries %u\n",
 		 qhp->wq.sq.qid, qhp->wq.sq.size, qhp->wq.sq.memsize,
