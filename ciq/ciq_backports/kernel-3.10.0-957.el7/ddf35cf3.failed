powerpc: Use barrier_nospec in copy_from_user()

jira LE-1907
cve CVE-2018-3693
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
Rebuild_CHGLOG: - [powerpc] Use barrier_nospec in copy_from_user() (Lauro Ramos Venancio) [1589035] {CVE-2018-3693}
Rebuild_FUZZ: 89.41%
commit-author Michael Ellerman <mpe@ellerman.id.au>
commit ddf35cf3764b5a182b178105f57515b42e2634f8
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/ddf35cf3.failed

Based on the x86 commit doing the same.

See commit 304ec1b05031 ("x86/uaccess: Use __uaccess_begin_nospec()
and uaccess_try_nospec") and b3bbfb3fb5d2 ("x86: Introduce
__uaccess_begin_nospec() and uaccess_try_nospec") for more detail.

In all cases we are ordering the load from the potentially
user-controlled pointer vs a previous branch based on an access_ok()
check or similar.

Base on a patch from Michal Suchanek.

	Signed-off-by: Michal Suchanek <msuchanek@suse.de>
	Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
(cherry picked from commit ddf35cf3764b5a182b178105f57515b42e2634f8)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/powerpc/include/asm/uaccess.h
diff --cc arch/powerpc/include/asm/uaccess.h
index 9485b43a7c00,468653ce844c..000000000000
--- a/arch/powerpc/include/asm/uaccess.h
+++ b/arch/powerpc/include/asm/uaccess.h
@@@ -295,9 -270,11 +296,15 @@@ do {								
  	unsigned long  __gu_val = 0;					\
  	const __typeof__(*(ptr)) __user *__gu_addr = (ptr);		\
  	might_fault();							\
- 	if (access_ok(VERIFY_READ, __gu_addr, (size)))			\
+ 	if (access_ok(VERIFY_READ, __gu_addr, (size))) {		\
+ 		barrier_nospec();					\
  		__get_user_size(__gu_val, __gu_addr, (size), __gu_err);	\
++<<<<<<< HEAD
 +	(x) = (__typeof__(*(ptr)))__gu_val;				\
++=======
+ 	}								\
+ 	(x) = (__force __typeof__(*(ptr)))__gu_val;				\
++>>>>>>> ddf35cf3764b (powerpc: Use barrier_nospec in copy_from_user())
  	__gu_err;							\
  })
  
@@@ -307,8 -284,9 +314,9 @@@
  	unsigned long __gu_val;					\
  	const __typeof__(*(ptr)) __user *__gu_addr = (ptr);	\
  	__chk_user_ptr(ptr);					\
+ 	barrier_nospec();					\
  	__get_user_size(__gu_val, __gu_addr, (size), __gu_err);	\
 -	(x) = (__force __typeof__(*(ptr)))__gu_val;			\
 +	(x) = (__typeof__(*(ptr)))__gu_val;			\
  	__gu_err;						\
  })
  
@@@ -387,6 -331,8 +399,11 @@@ static inline unsigned long __copy_from
  		if (ret == 0)
  			return 0;
  	}
++<<<<<<< HEAD
++=======
+ 
+ 	barrier_nospec();
++>>>>>>> ddf35cf3764b (powerpc: Use barrier_nospec in copy_from_user())
  	return __copy_tofrom_user((__force void __user *)to, from, n);
  }
  
* Unmerged path arch/powerpc/include/asm/uaccess.h
