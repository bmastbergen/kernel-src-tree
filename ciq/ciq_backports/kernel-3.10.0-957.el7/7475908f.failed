vmxnet3: increase default rx ring sizes

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
commit-author Shrikrishna Khare <skhare@vmware.com>
commit 7475908fbe5d9e669c40d9a4ceee6d4c4fedbbdc
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/7475908f.failed

There are several reasons for increasing the receive ring sizes:

1. The original ring size of 256 was chosen about 10 years ago when
vmxnet3 was first created. At that time, 10Gbps Ethernet was not prevalent
and servers were dominated by 1Gbps Ethernet. Now 10Gbps is common place,
and higher bandwidth links -- 25Gbps, 40Gbps, 50Gbps -- are starting
to appear. 256 Rx ring entries are simply not enough to keep up with
higher link speed when there is a burst of network frames coming from
these high speed links. Even with full MTU size frames, they are gone
in a short time. It is also more common to have a mix of frame sizes,
and more likely bi-modal distribution of frame sizes so the average frame
size is not close to full MTU. If we consider average frame size of 800B,
1024 frames that come in a burst takes ~0.65 ms to arrive at 10Gbps. With
256 entires, it takes ~0.16 ms to arrive at 10Gbps.  At 25Gbps or 40Gbps,
this time is reduced accordingly.

2. On a hypervisor where there are many VMs and CPU is over committed,
i.e. the number of VCPUs is more than the number of VCPUs, each PCPU is
in effect time shared between multiple VMs/VCPUs. The time granularity at
which this multiplexing occurs is typically coarser than between processes
on a guest OS. Trying to time slice more finely is not efficient, for
example, if memory cache is barely warmed up when switching from one VM
to another occurs. This CPU overcommit adds delay to when the driver
in a VM can service incoming packets. Whether CPU is over committed
really depends on customer workloads. For certain situations, it is very
common. For example, workloads of desktop VMs and product testing setups.
Consolidation and sharing is what drives efficiency of a customer setup
for such workloads. In these situations, the raw network bandwidth may
not be very high, but the delays between when a VM is running or not
running can also be relatively long.

	Signed-off-by: Shrikrishna Khare <skhare@vmware.com>
	Acked-by: Jin Heo <heoj@vmware.com>
	Acked-by: Guolin Yang <gyang@vmware.com>
	Acked-by: Boon Ang <bang@vmware.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 7475908fbe5d9e669c40d9a4ceee6d4c4fedbbdc)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/vmxnet3/vmxnet3_int.h
diff --cc drivers/net/vmxnet3/vmxnet3_int.h
index 090d124087d5,5ba222920e80..000000000000
--- a/drivers/net/vmxnet3/vmxnet3_int.h
+++ b/drivers/net/vmxnet3/vmxnet3_int.h
@@@ -69,10 -69,10 +69,17 @@@
  /*
   * Version numbers
   */
++<<<<<<< HEAD
 +#define VMXNET3_DRIVER_VERSION_STRING   "1.4.7.0-k"
 +
 +/* a 32-bit int, each byte encode a verion number in VMXNET3_DRIVER_VERSION */
 +#define VMXNET3_DRIVER_VERSION_NUM      0x01040700
++=======
+ #define VMXNET3_DRIVER_VERSION_STRING   "1.4.11.0-k"
+ 
+ /* a 32-bit int, each byte encode a verion number in VMXNET3_DRIVER_VERSION */
+ #define VMXNET3_DRIVER_VERSION_NUM      0x01040b00
++>>>>>>> 7475908fbe5d (vmxnet3: increase default rx ring sizes)
  
  #if defined(CONFIG_PCI_MSI)
  	/* RSS only makes sense if MSI-X is supported. */
@@@ -386,11 -409,18 +393,11 @@@ struct vmxnet3_adapter 
  #define VMXNET3_GET_ADDR_LO(dma)   ((u32)(dma))
  #define VMXNET3_GET_ADDR_HI(dma)   ((u32)(((u64)(dma)) >> 32))
  
 -#define VMXNET3_VERSION_GE_2(adapter) \
 -	(adapter->version >= VMXNET3_REV_2 + 1)
 -#define VMXNET3_VERSION_GE_3(adapter) \
 -	(adapter->version >= VMXNET3_REV_3 + 1)
 -
  /* must be a multiple of VMXNET3_RING_SIZE_ALIGN */
  #define VMXNET3_DEF_TX_RING_SIZE    512
- #define VMXNET3_DEF_RX_RING_SIZE    256
- #define VMXNET3_DEF_RX_RING2_SIZE   128
+ #define VMXNET3_DEF_RX_RING_SIZE    1024
+ #define VMXNET3_DEF_RX_RING2_SIZE   256
  
 -#define VMXNET3_DEF_RXDATA_DESC_SIZE 128
 -
  #define VMXNET3_MAX_ETH_HDR_SIZE    22
  #define VMXNET3_MAX_SKB_BUF_SIZE    (3*1024)
  
* Unmerged path drivers/net/vmxnet3/vmxnet3_int.h
