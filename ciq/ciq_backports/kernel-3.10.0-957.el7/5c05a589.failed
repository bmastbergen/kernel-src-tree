drm/nouveau/gr/gf100-: virtualise trap_mp

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
commit-author Ben Skeggs <bskeggs@redhat.com>
commit 5c05a589856ad5f79c22b0500340291c591c3050
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/5c05a589.failed

Required to support Volta.

	Signed-off-by: Ben Skeggs <bskeggs@redhat.com>
(cherry picked from commit 5c05a589856ad5f79c22b0500340291c591c3050)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/gpu/drm/nouveau/nvkm/engine/gr/gf100.c
#	drivers/gpu/drm/nouveau/nvkm/engine/gr/gf100.h
#	drivers/gpu/drm/nouveau/nvkm/engine/gr/gf104.c
#	drivers/gpu/drm/nouveau/nvkm/engine/gr/gf108.c
#	drivers/gpu/drm/nouveau/nvkm/engine/gr/gf110.c
#	drivers/gpu/drm/nouveau/nvkm/engine/gr/gf117.c
#	drivers/gpu/drm/nouveau/nvkm/engine/gr/gf119.c
#	drivers/gpu/drm/nouveau/nvkm/engine/gr/gk104.c
#	drivers/gpu/drm/nouveau/nvkm/engine/gr/gk110.c
#	drivers/gpu/drm/nouveau/nvkm/engine/gr/gk110b.c
#	drivers/gpu/drm/nouveau/nvkm/engine/gr/gk208.c
#	drivers/gpu/drm/nouveau/nvkm/engine/gr/gm107.c
#	drivers/gpu/drm/nouveau/nvkm/engine/gr/gm200.c
#	drivers/gpu/drm/nouveau/nvkm/engine/gr/gp100.c
#	drivers/gpu/drm/nouveau/nvkm/engine/gr/gp102.c
#	drivers/gpu/drm/nouveau/nvkm/engine/gr/gp107.c
#	drivers/gpu/drm/nouveau/nvkm/engine/gr/gp10b.c
diff --cc drivers/gpu/drm/nouveau/nvkm/engine/gr/gf100.c
index 7601140b0017,f05d9d4c6e5c..000000000000
--- a/drivers/gpu/drm/nouveau/nvkm/engine/gr/gf100.c
+++ b/drivers/gpu/drm/nouveau/nvkm/engine/gr/gf100.c
@@@ -2049,6 -2165,18 +2049,21 @@@ gf100_gr_gpccs_ucode = 
  static const struct gf100_gr_func
  gf100_gr = {
  	.init = gf100_gr_init,
++<<<<<<< HEAD
++=======
+ 	.init_gpc_mmu = gf100_gr_init_gpc_mmu,
+ 	.init_vsc_stream_master = gf100_gr_init_vsc_stream_master,
+ 	.init_zcull = gf100_gr_init_zcull,
+ 	.init_num_active_ltcs = gf100_gr_init_num_active_ltcs,
+ 	.init_fecs_exceptions = gf100_gr_init_fecs_exceptions,
+ 	.init_40601c = gf100_gr_init_40601c,
+ 	.init_419cc0 = gf100_gr_init_419cc0,
+ 	.init_419eb4 = gf100_gr_init_419eb4,
+ 	.init_tex_hww_esr = gf100_gr_init_tex_hww_esr,
+ 	.init_shader_exceptions = gf100_gr_init_shader_exceptions,
+ 	.init_400054 = gf100_gr_init_400054,
+ 	.trap_mp = gf100_gr_trap_mp,
++>>>>>>> 5c05a589856a (drm/nouveau/gr/gf100-: virtualise trap_mp)
  	.mmio = gf100_gr_pack_mmio,
  	.fecs.ucode = &gf100_gr_fecs_ucode,
  	.gpccs.ucode = &gf100_gr_gpccs_ucode,
diff --cc drivers/gpu/drm/nouveau/nvkm/engine/gr/gf100.h
index 55915c14de5f,c25b93a0cb03..000000000000
--- a/drivers/gpu/drm/nouveau/nvkm/engine/gr/gf100.h
+++ b/drivers/gpu/drm/nouveau/nvkm/engine/gr/gf100.h
@@@ -125,10 -125,27 +125,18 @@@ struct gf100_gr_func 
  	void (*dtor)(struct gf100_gr *);
  	int (*init)(struct gf100_gr *);
  	void (*init_gpc_mmu)(struct gf100_gr *);
 -	void (*init_r405a14)(struct gf100_gr *);
 -	void (*init_bios)(struct gf100_gr *);
 -	void (*init_vsc_stream_master)(struct gf100_gr *);
 -	void (*init_zcull)(struct gf100_gr *);
 -	void (*init_num_active_ltcs)(struct gf100_gr *);
  	void (*init_rop_active_fbps)(struct gf100_gr *);
 -	void (*init_bios_2)(struct gf100_gr *);
 -	void (*init_swdx_pes_mask)(struct gf100_gr *);
 -	void (*init_fecs_exceptions)(struct gf100_gr *);
 -	void (*init_ds_hww_esr_2)(struct gf100_gr *);
 -	void (*init_40601c)(struct gf100_gr *);
 -	void (*init_sked_hww_esr)(struct gf100_gr *);
 -	void (*init_419cc0)(struct gf100_gr *);
 -	void (*init_419eb4)(struct gf100_gr *);
 -	void (*init_419c9c)(struct gf100_gr *);
  	void (*init_ppc_exceptions)(struct gf100_gr *);
++<<<<<<< HEAD
 +	void (*init_swdx_pes_mask)(struct gf100_gr *);
 +	void (*init_num_active_ltcs)(struct gf100_gr *);
++=======
+ 	void (*init_tex_hww_esr)(struct gf100_gr *, int gpc, int tpc);
+ 	void (*init_504430)(struct gf100_gr *, int gpc, int tpc);
+ 	void (*init_shader_exceptions)(struct gf100_gr *, int gpc, int tpc);
+ 	void (*init_400054)(struct gf100_gr *);
+ 	void (*trap_mp)(struct gf100_gr *, int gpc, int tpc);
++>>>>>>> 5c05a589856a (drm/nouveau/gr/gf100-: virtualise trap_mp)
  	void (*set_hww_esr_report_mask)(struct gf100_gr *);
  	const struct gf100_gr_pack *mmio;
  	struct {
@@@ -258,6 -301,8 +266,11 @@@ extern const struct gf100_gr_init gf100
  extern const struct gf100_gr_init gf100_gr_init_be_0[];
  extern const struct gf100_gr_init gf100_gr_init_fe_1[];
  extern const struct gf100_gr_init gf100_gr_init_pe_1[];
++<<<<<<< HEAD
++=======
+ void gf100_gr_init_gpc_mmu(struct gf100_gr *);
+ void gf100_gr_trap_mp(struct gf100_gr *, int, int);
++>>>>>>> 5c05a589856a (drm/nouveau/gr/gf100-: virtualise trap_mp)
  
  extern const struct gf100_gr_init gf104_gr_init_ds_0[];
  extern const struct gf100_gr_init gf104_gr_init_tex_0[];
diff --cc drivers/gpu/drm/nouveau/nvkm/engine/gr/gf104.c
index d736dcd55ea2,df9cbed7ce50..000000000000
--- a/drivers/gpu/drm/nouveau/nvkm/engine/gr/gf104.c
+++ b/drivers/gpu/drm/nouveau/nvkm/engine/gr/gf104.c
@@@ -115,6 -115,18 +115,21 @@@ gf104_gr_pack_mmio[] = 
  static const struct gf100_gr_func
  gf104_gr = {
  	.init = gf100_gr_init,
++<<<<<<< HEAD
++=======
+ 	.init_gpc_mmu = gf100_gr_init_gpc_mmu,
+ 	.init_vsc_stream_master = gf100_gr_init_vsc_stream_master,
+ 	.init_zcull = gf100_gr_init_zcull,
+ 	.init_num_active_ltcs = gf100_gr_init_num_active_ltcs,
+ 	.init_fecs_exceptions = gf100_gr_init_fecs_exceptions,
+ 	.init_40601c = gf100_gr_init_40601c,
+ 	.init_419cc0 = gf100_gr_init_419cc0,
+ 	.init_419eb4 = gf100_gr_init_419eb4,
+ 	.init_tex_hww_esr = gf100_gr_init_tex_hww_esr,
+ 	.init_shader_exceptions = gf100_gr_init_shader_exceptions,
+ 	.init_400054 = gf100_gr_init_400054,
+ 	.trap_mp = gf100_gr_trap_mp,
++>>>>>>> 5c05a589856a (drm/nouveau/gr/gf100-: virtualise trap_mp)
  	.mmio = gf104_gr_pack_mmio,
  	.fecs.ucode = &gf100_gr_fecs_ucode,
  	.gpccs.ucode = &gf100_gr_gpccs_ucode,
diff --cc drivers/gpu/drm/nouveau/nvkm/engine/gr/gf108.c
index 2f0d24498427,8ffa0fd1134f..000000000000
--- a/drivers/gpu/drm/nouveau/nvkm/engine/gr/gf108.c
+++ b/drivers/gpu/drm/nouveau/nvkm/engine/gr/gf108.c
@@@ -106,6 -106,25 +106,22 @@@ gf108_gr_pack_mmio[] = 
  static const struct gf100_gr_func
  gf108_gr = {
  	.init = gf100_gr_init,
++<<<<<<< HEAD
++=======
+ 	.init_gpc_mmu = gf100_gr_init_gpc_mmu,
+ 	.init_r405a14 = gf108_gr_init_r405a14,
+ 	.init_vsc_stream_master = gf100_gr_init_vsc_stream_master,
+ 	.init_zcull = gf100_gr_init_zcull,
+ 	.init_num_active_ltcs = gf100_gr_init_num_active_ltcs,
+ 	.init_fecs_exceptions = gf100_gr_init_fecs_exceptions,
+ 	.init_40601c = gf100_gr_init_40601c,
+ 	.init_419cc0 = gf100_gr_init_419cc0,
+ 	.init_419eb4 = gf100_gr_init_419eb4,
+ 	.init_tex_hww_esr = gf100_gr_init_tex_hww_esr,
+ 	.init_shader_exceptions = gf100_gr_init_shader_exceptions,
+ 	.init_400054 = gf100_gr_init_400054,
+ 	.trap_mp = gf100_gr_trap_mp,
++>>>>>>> 5c05a589856a (drm/nouveau/gr/gf100-: virtualise trap_mp)
  	.mmio = gf108_gr_pack_mmio,
  	.fecs.ucode = &gf100_gr_fecs_ucode,
  	.gpccs.ucode = &gf100_gr_gpccs_ucode,
diff --cc drivers/gpu/drm/nouveau/nvkm/engine/gr/gf110.c
index d1d942eb86af,0d4293e3e4ea..000000000000
--- a/drivers/gpu/drm/nouveau/nvkm/engine/gr/gf110.c
+++ b/drivers/gpu/drm/nouveau/nvkm/engine/gr/gf110.c
@@@ -87,6 -87,18 +87,21 @@@ gf110_gr_pack_mmio[] = 
  static const struct gf100_gr_func
  gf110_gr = {
  	.init = gf100_gr_init,
++<<<<<<< HEAD
++=======
+ 	.init_gpc_mmu = gf100_gr_init_gpc_mmu,
+ 	.init_vsc_stream_master = gf100_gr_init_vsc_stream_master,
+ 	.init_zcull = gf100_gr_init_zcull,
+ 	.init_num_active_ltcs = gf100_gr_init_num_active_ltcs,
+ 	.init_fecs_exceptions = gf100_gr_init_fecs_exceptions,
+ 	.init_40601c = gf100_gr_init_40601c,
+ 	.init_419cc0 = gf100_gr_init_419cc0,
+ 	.init_419eb4 = gf100_gr_init_419eb4,
+ 	.init_tex_hww_esr = gf100_gr_init_tex_hww_esr,
+ 	.init_shader_exceptions = gf100_gr_init_shader_exceptions,
+ 	.init_400054 = gf100_gr_init_400054,
+ 	.trap_mp = gf100_gr_trap_mp,
++>>>>>>> 5c05a589856a (drm/nouveau/gr/gf100-: virtualise trap_mp)
  	.mmio = gf110_gr_pack_mmio,
  	.fecs.ucode = &gf100_gr_fecs_ucode,
  	.gpccs.ucode = &gf100_gr_gpccs_ucode,
diff --cc drivers/gpu/drm/nouveau/nvkm/engine/gr/gf117.c
index 0124e468086e,e3c1dbbfbf34..000000000000
--- a/drivers/gpu/drm/nouveau/nvkm/engine/gr/gf117.c
+++ b/drivers/gpu/drm/nouveau/nvkm/engine/gr/gf117.c
@@@ -123,6 -123,46 +123,21 @@@ gf117_gr_gpccs_ucode = 
  static const struct gf100_gr_func
  gf117_gr = {
  	.init = gf100_gr_init,
++<<<<<<< HEAD
++=======
+ 	.init_gpc_mmu = gf100_gr_init_gpc_mmu,
+ 	.init_vsc_stream_master = gf100_gr_init_vsc_stream_master,
+ 	.init_zcull = gf117_gr_init_zcull,
+ 	.init_num_active_ltcs = gf100_gr_init_num_active_ltcs,
+ 	.init_fecs_exceptions = gf100_gr_init_fecs_exceptions,
+ 	.init_40601c = gf100_gr_init_40601c,
+ 	.init_419cc0 = gf100_gr_init_419cc0,
+ 	.init_419eb4 = gf100_gr_init_419eb4,
+ 	.init_tex_hww_esr = gf100_gr_init_tex_hww_esr,
+ 	.init_shader_exceptions = gf100_gr_init_shader_exceptions,
+ 	.init_400054 = gf100_gr_init_400054,
+ 	.trap_mp = gf100_gr_trap_mp,
++>>>>>>> 5c05a589856a (drm/nouveau/gr/gf100-: virtualise trap_mp)
  	.mmio = gf117_gr_pack_mmio,
  	.fecs.ucode = &gf117_gr_fecs_ucode,
  	.gpccs.ucode = &gf117_gr_gpccs_ucode,
diff --cc drivers/gpu/drm/nouveau/nvkm/engine/gr/gf119.c
index 8d8e4cafe28f,1ed70b93a10a..000000000000
--- a/drivers/gpu/drm/nouveau/nvkm/engine/gr/gf119.c
+++ b/drivers/gpu/drm/nouveau/nvkm/engine/gr/gf119.c
@@@ -178,6 -178,18 +178,21 @@@ gf119_gr_pack_mmio[] = 
  static const struct gf100_gr_func
  gf119_gr = {
  	.init = gf100_gr_init,
++<<<<<<< HEAD
++=======
+ 	.init_gpc_mmu = gf100_gr_init_gpc_mmu,
+ 	.init_vsc_stream_master = gf100_gr_init_vsc_stream_master,
+ 	.init_zcull = gf100_gr_init_zcull,
+ 	.init_num_active_ltcs = gf100_gr_init_num_active_ltcs,
+ 	.init_fecs_exceptions = gf100_gr_init_fecs_exceptions,
+ 	.init_40601c = gf100_gr_init_40601c,
+ 	.init_419cc0 = gf100_gr_init_419cc0,
+ 	.init_419eb4 = gf100_gr_init_419eb4,
+ 	.init_tex_hww_esr = gf100_gr_init_tex_hww_esr,
+ 	.init_shader_exceptions = gf100_gr_init_shader_exceptions,
+ 	.init_400054 = gf100_gr_init_400054,
+ 	.trap_mp = gf100_gr_trap_mp,
++>>>>>>> 5c05a589856a (drm/nouveau/gr/gf100-: virtualise trap_mp)
  	.mmio = gf119_gr_pack_mmio,
  	.fecs.ucode = &gf100_gr_fecs_ucode,
  	.gpccs.ucode = &gf100_gr_gpccs_ucode,
diff --cc drivers/gpu/drm/nouveau/nvkm/engine/gr/gk104.c
index f9a17b27d5b8,86819ab7f9a4..000000000000
--- a/drivers/gpu/drm/nouveau/nvkm/engine/gr/gk104.c
+++ b/drivers/gpu/drm/nouveau/nvkm/engine/gr/gk104.c
@@@ -339,9 -448,21 +339,16 @@@ gk104_gr_gpccs_ucode = 
  
  static const struct gf100_gr_func
  gk104_gr = {
 -	.init = gf100_gr_init,
 -	.init_gpc_mmu = gf100_gr_init_gpc_mmu,
 -	.init_vsc_stream_master = gk104_gr_init_vsc_stream_master,
 -	.init_zcull = gf117_gr_init_zcull,
 -	.init_num_active_ltcs = gf100_gr_init_num_active_ltcs,
 +	.init = gk104_gr_init,
  	.init_rop_active_fbps = gk104_gr_init_rop_active_fbps,
 -	.init_fecs_exceptions = gk104_gr_init_fecs_exceptions,
 -	.init_sked_hww_esr = gk104_gr_init_sked_hww_esr,
 -	.init_419cc0 = gf100_gr_init_419cc0,
 -	.init_419eb4 = gf100_gr_init_419eb4,
  	.init_ppc_exceptions = gk104_gr_init_ppc_exceptions,
++<<<<<<< HEAD
++=======
+ 	.init_tex_hww_esr = gf100_gr_init_tex_hww_esr,
+ 	.init_shader_exceptions = gf100_gr_init_shader_exceptions,
+ 	.init_400054 = gf100_gr_init_400054,
+ 	.trap_mp = gf100_gr_trap_mp,
++>>>>>>> 5c05a589856a (drm/nouveau/gr/gf100-: virtualise trap_mp)
  	.mmio = gk104_gr_pack_mmio,
  	.fecs.ucode = &gk104_gr_fecs_ucode,
  	.gpccs.ucode = &gk104_gr_gpccs_ucode,
diff --cc drivers/gpu/drm/nouveau/nvkm/engine/gr/gk110.c
index f31b171a4102,e30d94ff23d7..000000000000
--- a/drivers/gpu/drm/nouveau/nvkm/engine/gr/gk110.c
+++ b/drivers/gpu/drm/nouveau/nvkm/engine/gr/gk110.c
@@@ -180,11 -334,37 +180,18 @@@ gk110_gr_gpccs_ucode = 
  	.data.size = sizeof(gk110_grgpc_data),
  };
  
 -void
 -gk110_gr_init_419eb4(struct gf100_gr *gr)
 -{
 -	struct nvkm_device *device = gr->base.engine.subdev.device;
 -	nvkm_mask(device, 0x419eb4, 0x00001000, 0x00001000);
 -	nvkm_mask(device, 0x419eb4, 0x00002000, 0x00002000);
 -	nvkm_mask(device, 0x419eb4, 0x00004000, 0x00004000);
 -	nvkm_mask(device, 0x419eb4, 0x00008000, 0x00008000);
 -	nvkm_mask(device, 0x419eb4, 0x00001000, 0x00000000);
 -	nvkm_mask(device, 0x419eb4, 0x00002000, 0x00000000);
 -	nvkm_mask(device, 0x419eb4, 0x00004000, 0x00000000);
 -	nvkm_mask(device, 0x419eb4, 0x00008000, 0x00000000);
 -}
 -
  static const struct gf100_gr_func
  gk110_gr = {
 -	.init = gf100_gr_init,
 -	.init_gpc_mmu = gf100_gr_init_gpc_mmu,
 -	.init_vsc_stream_master = gk104_gr_init_vsc_stream_master,
 -	.init_zcull = gf117_gr_init_zcull,
 -	.init_num_active_ltcs = gf100_gr_init_num_active_ltcs,
 +	.init = gk104_gr_init,
  	.init_rop_active_fbps = gk104_gr_init_rop_active_fbps,
 -	.init_fecs_exceptions = gf100_gr_init_fecs_exceptions,
 -	.init_sked_hww_esr = gk104_gr_init_sked_hww_esr,
 -	.init_419cc0 = gf100_gr_init_419cc0,
 -	.init_419eb4 = gk110_gr_init_419eb4,
  	.init_ppc_exceptions = gk104_gr_init_ppc_exceptions,
++<<<<<<< HEAD
++=======
+ 	.init_tex_hww_esr = gf100_gr_init_tex_hww_esr,
+ 	.init_shader_exceptions = gf100_gr_init_shader_exceptions,
+ 	.init_400054 = gf100_gr_init_400054,
+ 	.trap_mp = gf100_gr_trap_mp,
++>>>>>>> 5c05a589856a (drm/nouveau/gr/gf100-: virtualise trap_mp)
  	.mmio = gk110_gr_pack_mmio,
  	.fecs.ucode = &gk110_gr_fecs_ucode,
  	.gpccs.ucode = &gk110_gr_gpccs_ucode,
diff --cc drivers/gpu/drm/nouveau/nvkm/engine/gr/gk110b.c
index d76dd178007f,253b98181ac4..000000000000
--- a/drivers/gpu/drm/nouveau/nvkm/engine/gr/gk110b.c
+++ b/drivers/gpu/drm/nouveau/nvkm/engine/gr/gk110b.c
@@@ -102,9 -102,21 +102,16 @@@ gk110b_gr_pack_mmio[] = 
  
  static const struct gf100_gr_func
  gk110b_gr = {
 -	.init = gf100_gr_init,
 -	.init_gpc_mmu = gf100_gr_init_gpc_mmu,
 -	.init_vsc_stream_master = gk104_gr_init_vsc_stream_master,
 -	.init_zcull = gf117_gr_init_zcull,
 -	.init_num_active_ltcs = gf100_gr_init_num_active_ltcs,
 +	.init = gk104_gr_init,
  	.init_rop_active_fbps = gk104_gr_init_rop_active_fbps,
 -	.init_fecs_exceptions = gf100_gr_init_fecs_exceptions,
 -	.init_sked_hww_esr = gk104_gr_init_sked_hww_esr,
 -	.init_419cc0 = gf100_gr_init_419cc0,
 -	.init_419eb4 = gk110_gr_init_419eb4,
  	.init_ppc_exceptions = gk104_gr_init_ppc_exceptions,
++<<<<<<< HEAD
++=======
+ 	.init_tex_hww_esr = gf100_gr_init_tex_hww_esr,
+ 	.init_shader_exceptions = gf100_gr_init_shader_exceptions,
+ 	.init_400054 = gf100_gr_init_400054,
+ 	.trap_mp = gf100_gr_trap_mp,
++>>>>>>> 5c05a589856a (drm/nouveau/gr/gf100-: virtualise trap_mp)
  	.mmio = gk110b_gr_pack_mmio,
  	.fecs.ucode = &gk110_gr_fecs_ucode,
  	.gpccs.ucode = &gk110_gr_gpccs_ucode,
diff --cc drivers/gpu/drm/nouveau/nvkm/engine/gr/gk208.c
index 14bbe6ed02a9,702e9094c1c8..000000000000
--- a/drivers/gpu/drm/nouveau/nvkm/engine/gr/gk208.c
+++ b/drivers/gpu/drm/nouveau/nvkm/engine/gr/gk208.c
@@@ -161,9 -161,20 +161,16 @@@ gk208_gr_gpccs_ucode = 
  
  static const struct gf100_gr_func
  gk208_gr = {
 -	.init = gf100_gr_init,
 -	.init_gpc_mmu = gf100_gr_init_gpc_mmu,
 -	.init_vsc_stream_master = gk104_gr_init_vsc_stream_master,
 -	.init_zcull = gf117_gr_init_zcull,
 -	.init_num_active_ltcs = gf100_gr_init_num_active_ltcs,
 +	.init = gk104_gr_init,
  	.init_rop_active_fbps = gk104_gr_init_rop_active_fbps,
 -	.init_fecs_exceptions = gf100_gr_init_fecs_exceptions,
 -	.init_sked_hww_esr = gk104_gr_init_sked_hww_esr,
 -	.init_419cc0 = gf100_gr_init_419cc0,
  	.init_ppc_exceptions = gk104_gr_init_ppc_exceptions,
++<<<<<<< HEAD
++=======
+ 	.init_tex_hww_esr = gf100_gr_init_tex_hww_esr,
+ 	.init_shader_exceptions = gf100_gr_init_shader_exceptions,
+ 	.init_400054 = gf100_gr_init_400054,
+ 	.trap_mp = gf100_gr_trap_mp,
++>>>>>>> 5c05a589856a (drm/nouveau/gr/gf100-: virtualise trap_mp)
  	.mmio = gk208_gr_pack_mmio,
  	.fecs.ucode = &gk208_gr_fecs_ucode,
  	.gpccs.ucode = &gk208_gr_gpccs_ucode,
diff --cc drivers/gpu/drm/nouveau/nvkm/engine/gr/gm107.c
index 2c67fac576d1,d67bf9465baa..000000000000
--- a/drivers/gpu/drm/nouveau/nvkm/engine/gr/gm107.c
+++ b/drivers/gpu/drm/nouveau/nvkm/engine/gr/gm107.c
@@@ -441,9 -391,23 +441,17 @@@ gm107_gr_gpccs_ucode = 
  
  static const struct gf100_gr_func
  gm107_gr = {
 -	.init = gf100_gr_init,
 -	.init_gpc_mmu = gm107_gr_init_gpc_mmu,
 -	.init_bios = gm107_gr_init_bios,
 -	.init_vsc_stream_master = gk104_gr_init_vsc_stream_master,
 -	.init_zcull = gf117_gr_init_zcull,
 -	.init_num_active_ltcs = gf100_gr_init_num_active_ltcs,
 +	.init = gm107_gr_init,
  	.init_rop_active_fbps = gk104_gr_init_rop_active_fbps,
 -	.init_bios_2 = gm107_gr_init_bios_2,
 -	.init_fecs_exceptions = gf100_gr_init_fecs_exceptions,
 -	.init_sked_hww_esr = gk104_gr_init_sked_hww_esr,
 -	.init_419cc0 = gf100_gr_init_419cc0,
  	.init_ppc_exceptions = gk104_gr_init_ppc_exceptions,
++<<<<<<< HEAD
++=======
+ 	.init_tex_hww_esr = gf100_gr_init_tex_hww_esr,
+ 	.init_504430 = gm107_gr_init_504430,
+ 	.init_shader_exceptions = gm107_gr_init_shader_exceptions,
+ 	.init_400054 = gm107_gr_init_400054,
+ 	.trap_mp = gf100_gr_trap_mp,
++>>>>>>> 5c05a589856a (drm/nouveau/gr/gf100-: virtualise trap_mp)
  	.mmio = gm107_gr_pack_mmio,
  	.fecs.ucode = &gm107_gr_fecs_ucode,
  	.gpccs.ucode = &gm107_gr_gpccs_ucode,
diff --cc drivers/gpu/drm/nouveau/nvkm/engine/gr/gm200.c
index c5cca4279a00,03b255e9b812..000000000000
--- a/drivers/gpu/drm/nouveau/nvkm/engine/gr/gm200.c
+++ b/drivers/gpu/drm/nouveau/nvkm/engine/gr/gm200.c
@@@ -208,10 -117,23 +208,18 @@@ gm200_gr_new_(const struct gf100_gr_fun
  
  static const struct gf100_gr_func
  gm200_gr = {
 -	.init = gf100_gr_init,
 +	.init = gm200_gr_init,
  	.init_gpc_mmu = gm200_gr_init_gpc_mmu,
 -	.init_bios = gm107_gr_init_bios,
 -	.init_vsc_stream_master = gk104_gr_init_vsc_stream_master,
 -	.init_zcull = gf117_gr_init_zcull,
 -	.init_num_active_ltcs = gm200_gr_init_num_active_ltcs,
  	.init_rop_active_fbps = gm200_gr_init_rop_active_fbps,
 -	.init_fecs_exceptions = gf100_gr_init_fecs_exceptions,
 -	.init_ds_hww_esr_2 = gm200_gr_init_ds_hww_esr_2,
 -	.init_sked_hww_esr = gk104_gr_init_sked_hww_esr,
 -	.init_419cc0 = gf100_gr_init_419cc0,
  	.init_ppc_exceptions = gk104_gr_init_ppc_exceptions,
++<<<<<<< HEAD
++=======
+ 	.init_tex_hww_esr = gf100_gr_init_tex_hww_esr,
+ 	.init_504430 = gm107_gr_init_504430,
+ 	.init_shader_exceptions = gm107_gr_init_shader_exceptions,
+ 	.init_400054 = gm107_gr_init_400054,
+ 	.trap_mp = gf100_gr_trap_mp,
++>>>>>>> 5c05a589856a (drm/nouveau/gr/gf100-: virtualise trap_mp)
  	.rops = gm200_gr_rops,
  	.tpc_nr = 4,
  	.ppc_nr = 2,
diff --cc drivers/gpu/drm/nouveau/nvkm/engine/gr/gp100.c
index b87d86575036,e5f941f81e07..000000000000
--- a/drivers/gpu/drm/nouveau/nvkm/engine/gr/gp100.c
+++ b/drivers/gpu/drm/nouveau/nvkm/engine/gr/gp100.c
@@@ -158,11 -64,22 +158,18 @@@ gp100_gr_init(struct gf100_gr *gr
  
  static const struct gf100_gr_func
  gp100_gr = {
 -	.init = gf100_gr_init,
 +	.init = gp100_gr_init,
  	.init_gpc_mmu = gm200_gr_init_gpc_mmu,
 -	.init_vsc_stream_master = gk104_gr_init_vsc_stream_master,
 -	.init_zcull = gf117_gr_init_zcull,
 -	.init_num_active_ltcs = gm200_gr_init_num_active_ltcs,
  	.init_rop_active_fbps = gp100_gr_init_rop_active_fbps,
 -	.init_fecs_exceptions = gp100_gr_init_fecs_exceptions,
 -	.init_ds_hww_esr_2 = gm200_gr_init_ds_hww_esr_2,
 -	.init_sked_hww_esr = gk104_gr_init_sked_hww_esr,
 -	.init_419cc0 = gf100_gr_init_419cc0,
 -	.init_419c9c = gp100_gr_init_419c9c,
  	.init_ppc_exceptions = gk104_gr_init_ppc_exceptions,
++<<<<<<< HEAD
 +	.init_num_active_ltcs = gp100_gr_init_num_active_ltcs,
++=======
+ 	.init_tex_hww_esr = gf100_gr_init_tex_hww_esr,
+ 	.init_504430 = gm107_gr_init_504430,
+ 	.init_shader_exceptions = gp100_gr_init_shader_exceptions,
+ 	.trap_mp = gf100_gr_trap_mp,
++>>>>>>> 5c05a589856a (drm/nouveau/gr/gf100-: virtualise trap_mp)
  	.rops = gm200_gr_rops,
  	.gpc_nr = 6,
  	.tpc_nr = 5,
diff --cc drivers/gpu/drm/nouveau/nvkm/engine/gr/gp102.c
index 8d1b09b9c236,09e2665e4988..000000000000
--- a/drivers/gpu/drm/nouveau/nvkm/engine/gr/gp102.c
+++ b/drivers/gpu/drm/nouveau/nvkm/engine/gr/gp102.c
@@@ -42,12 -42,22 +42,19 @@@ gp102_gr_init_swdx_pes_mask(struct gf10
  
  static const struct gf100_gr_func
  gp102_gr = {
 -	.init = gf100_gr_init,
 +	.init = gp100_gr_init,
  	.init_gpc_mmu = gm200_gr_init_gpc_mmu,
 -	.init_vsc_stream_master = gk104_gr_init_vsc_stream_master,
 -	.init_zcull = gf117_gr_init_zcull,
 -	.init_num_active_ltcs = gm200_gr_init_num_active_ltcs,
  	.init_rop_active_fbps = gp100_gr_init_rop_active_fbps,
 -	.init_swdx_pes_mask = gp102_gr_init_swdx_pes_mask,
 -	.init_fecs_exceptions = gp100_gr_init_fecs_exceptions,
 -	.init_ds_hww_esr_2 = gm200_gr_init_ds_hww_esr_2,
 -	.init_sked_hww_esr = gk104_gr_init_sked_hww_esr,
 -	.init_419cc0 = gf100_gr_init_419cc0,
  	.init_ppc_exceptions = gk104_gr_init_ppc_exceptions,
++<<<<<<< HEAD
 +	.init_swdx_pes_mask = gp102_gr_init_swdx_pes_mask,
 +	.init_num_active_ltcs = gp100_gr_init_num_active_ltcs,
++=======
+ 	.init_tex_hww_esr = gf100_gr_init_tex_hww_esr,
+ 	.init_504430 = gm107_gr_init_504430,
+ 	.init_shader_exceptions = gp100_gr_init_shader_exceptions,
+ 	.trap_mp = gf100_gr_trap_mp,
++>>>>>>> 5c05a589856a (drm/nouveau/gr/gf100-: virtualise trap_mp)
  	.rops = gm200_gr_rops,
  	.gpc_nr = 6,
  	.tpc_nr = 5,
diff --cc drivers/gpu/drm/nouveau/nvkm/engine/gr/gp107.c
index 7ca037eda549,674385da3d43..000000000000
--- a/drivers/gpu/drm/nouveau/nvkm/engine/gr/gp107.c
+++ b/drivers/gpu/drm/nouveau/nvkm/engine/gr/gp107.c
@@@ -28,12 -28,22 +28,19 @@@
  
  static const struct gf100_gr_func
  gp107_gr = {
 -	.init = gf100_gr_init,
 +	.init = gp100_gr_init,
  	.init_gpc_mmu = gm200_gr_init_gpc_mmu,
 -	.init_vsc_stream_master = gk104_gr_init_vsc_stream_master,
 -	.init_zcull = gf117_gr_init_zcull,
 -	.init_num_active_ltcs = gm200_gr_init_num_active_ltcs,
  	.init_rop_active_fbps = gp100_gr_init_rop_active_fbps,
 -	.init_swdx_pes_mask = gp102_gr_init_swdx_pes_mask,
 -	.init_fecs_exceptions = gp100_gr_init_fecs_exceptions,
 -	.init_ds_hww_esr_2 = gm200_gr_init_ds_hww_esr_2,
 -	.init_sked_hww_esr = gk104_gr_init_sked_hww_esr,
 -	.init_419cc0 = gf100_gr_init_419cc0,
  	.init_ppc_exceptions = gk104_gr_init_ppc_exceptions,
++<<<<<<< HEAD
 +	.init_swdx_pes_mask = gp102_gr_init_swdx_pes_mask,
 +	.init_num_active_ltcs = gp100_gr_init_num_active_ltcs,
++=======
+ 	.init_tex_hww_esr = gf100_gr_init_tex_hww_esr,
+ 	.init_504430 = gm107_gr_init_504430,
+ 	.init_shader_exceptions = gp100_gr_init_shader_exceptions,
+ 	.trap_mp = gf100_gr_trap_mp,
++>>>>>>> 5c05a589856a (drm/nouveau/gr/gf100-: virtualise trap_mp)
  	.rops = gm200_gr_rops,
  	.gpc_nr = 2,
  	.tpc_nr = 3,
diff --cc drivers/gpu/drm/nouveau/nvkm/engine/gr/gp10b.c
index 775c4cfdeade,6103186a3724..000000000000
--- a/drivers/gpu/drm/nouveau/nvkm/engine/gr/gp10b.c
+++ b/drivers/gpu/drm/nouveau/nvkm/engine/gr/gp10b.c
@@@ -25,21 -25,23 +25,28 @@@
  
  #include <nvif/class.h>
  
 +static void
 +gp10b_gr_init_num_active_ltcs(struct gf100_gr *gr)
 +{
 +	struct nvkm_device *device = gr->base.engine.subdev.device;
 +
 +	nvkm_wr32(device, GPC_BCAST(0x08ac), nvkm_rd32(device, 0x100800));
 +}
 +
  static const struct gf100_gr_func
  gp10b_gr = {
 -	.init = gf100_gr_init,
 +	.init = gp100_gr_init,
  	.init_gpc_mmu = gm200_gr_init_gpc_mmu,
 -	.init_vsc_stream_master = gk104_gr_init_vsc_stream_master,
 -	.init_zcull = gf117_gr_init_zcull,
 -	.init_num_active_ltcs = gf100_gr_init_num_active_ltcs,
  	.init_rop_active_fbps = gp100_gr_init_rop_active_fbps,
 -	.init_fecs_exceptions = gp100_gr_init_fecs_exceptions,
 -	.init_ds_hww_esr_2 = gm200_gr_init_ds_hww_esr_2,
 -	.init_sked_hww_esr = gk104_gr_init_sked_hww_esr,
 -	.init_419cc0 = gf100_gr_init_419cc0,
  	.init_ppc_exceptions = gk104_gr_init_ppc_exceptions,
++<<<<<<< HEAD
 +	.init_num_active_ltcs = gp10b_gr_init_num_active_ltcs,
++=======
+ 	.init_tex_hww_esr = gf100_gr_init_tex_hww_esr,
+ 	.init_504430 = gm107_gr_init_504430,
+ 	.init_shader_exceptions = gp100_gr_init_shader_exceptions,
+ 	.trap_mp = gf100_gr_trap_mp,
++>>>>>>> 5c05a589856a (drm/nouveau/gr/gf100-: virtualise trap_mp)
  	.rops = gm200_gr_rops,
  	.gpc_nr = 1,
  	.tpc_nr = 2,
* Unmerged path drivers/gpu/drm/nouveau/nvkm/engine/gr/gf100.c
* Unmerged path drivers/gpu/drm/nouveau/nvkm/engine/gr/gf100.h
* Unmerged path drivers/gpu/drm/nouveau/nvkm/engine/gr/gf104.c
* Unmerged path drivers/gpu/drm/nouveau/nvkm/engine/gr/gf108.c
* Unmerged path drivers/gpu/drm/nouveau/nvkm/engine/gr/gf110.c
* Unmerged path drivers/gpu/drm/nouveau/nvkm/engine/gr/gf117.c
* Unmerged path drivers/gpu/drm/nouveau/nvkm/engine/gr/gf119.c
* Unmerged path drivers/gpu/drm/nouveau/nvkm/engine/gr/gk104.c
* Unmerged path drivers/gpu/drm/nouveau/nvkm/engine/gr/gk110.c
* Unmerged path drivers/gpu/drm/nouveau/nvkm/engine/gr/gk110b.c
* Unmerged path drivers/gpu/drm/nouveau/nvkm/engine/gr/gk208.c
diff --git a/drivers/gpu/drm/nouveau/nvkm/engine/gr/gk20a.c b/drivers/gpu/drm/nouveau/nvkm/engine/gr/gk20a.c
index de8b806b88fd..984b8ccc216c 100644
--- a/drivers/gpu/drm/nouveau/nvkm/engine/gr/gk20a.c
+++ b/drivers/gpu/drm/nouveau/nvkm/engine/gr/gk20a.c
@@ -312,6 +312,7 @@ static const struct gf100_gr_func
 gk20a_gr = {
 	.init = gk20a_gr_init,
 	.init_rop_active_fbps = gk104_gr_init_rop_active_fbps,
+	.trap_mp = gf100_gr_trap_mp,
 	.set_hww_esr_report_mask = gk20a_gr_set_hww_esr_report_mask,
 	.rops = gf100_gr_rops,
 	.ppc_nr = 1,
* Unmerged path drivers/gpu/drm/nouveau/nvkm/engine/gr/gm107.c
* Unmerged path drivers/gpu/drm/nouveau/nvkm/engine/gr/gm200.c
diff --git a/drivers/gpu/drm/nouveau/nvkm/engine/gr/gm20b.c b/drivers/gpu/drm/nouveau/nvkm/engine/gr/gm20b.c
index 69479af1d829..a1e601434f69 100644
--- a/drivers/gpu/drm/nouveau/nvkm/engine/gr/gm20b.c
+++ b/drivers/gpu/drm/nouveau/nvkm/engine/gr/gm20b.c
@@ -67,6 +67,7 @@ gm20b_gr = {
 	.init = gk20a_gr_init,
 	.init_gpc_mmu = gm20b_gr_init_gpc_mmu,
 	.init_rop_active_fbps = gk104_gr_init_rop_active_fbps,
+	.trap_mp = gf100_gr_trap_mp,
 	.set_hww_esr_report_mask = gm20b_gr_set_hww_esr_report_mask,
 	.rops = gm200_gr_rops,
 	.ppc_nr = 1,
* Unmerged path drivers/gpu/drm/nouveau/nvkm/engine/gr/gp100.c
* Unmerged path drivers/gpu/drm/nouveau/nvkm/engine/gr/gp102.c
diff --git a/drivers/gpu/drm/nouveau/nvkm/engine/gr/gp104.c b/drivers/gpu/drm/nouveau/nvkm/engine/gr/gp104.c
index 289d8b272b42..844fc9d63e5c 100644
--- a/drivers/gpu/drm/nouveau/nvkm/engine/gr/gp104.c
+++ b/drivers/gpu/drm/nouveau/nvkm/engine/gr/gp104.c
@@ -41,6 +41,7 @@ gp104_gr = {
 	.init_tex_hww_esr = gf100_gr_init_tex_hww_esr,
 	.init_504430 = gm107_gr_init_504430,
 	.init_shader_exceptions = gp100_gr_init_shader_exceptions,
+	.trap_mp = gf100_gr_trap_mp,
 	.rops = gm200_gr_rops,
 	.gpc_nr = 6,
 	.tpc_nr = 5,
* Unmerged path drivers/gpu/drm/nouveau/nvkm/engine/gr/gp107.c
* Unmerged path drivers/gpu/drm/nouveau/nvkm/engine/gr/gp10b.c
