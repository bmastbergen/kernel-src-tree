crypto: cryptd - Fix AEAD request context corruption

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
Rebuild_CHGLOG: - [crypto] cryptd: Fix AEAD request context corruption (Herbert Xu) [1579195]
Rebuild_FUZZ: 88.42%
commit-author Herbert Xu <herbert@gondor.apana.org.au>
commit ec9f2006fc020c58f32f01b9d68fdb5f7374ffce
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/ec9f2006.failed

The AEAD version of cryptd uses the same context for its own state
as well as that of the child.  In doing so it did not maintain the
proper ordering, thus resulting in potential state corruption where
the child will overwrite the state stored by cryptd.

This patch fixes and also sets the request size properly.

	Signed-off-by: Herbert Xu <herbert@gondor.apana.org.au>
(cherry picked from commit ec9f2006fc020c58f32f01b9d68fdb5f7374ffce)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	crypto/cryptd.c
diff --cc crypto/cryptd.c
index df8fd3fcc246,2f833dcc1711..000000000000
--- a/crypto/cryptd.c
+++ b/crypto/cryptd.c
@@@ -730,9 -757,10 +732,15 @@@ static int cryptd_aead_init_tfm(struct 
  	if (IS_ERR(cipher))
  		return PTR_ERR(cipher);
  
 +	crypto_aead_set_flags(cipher, CRYPTO_TFM_REQ_MAY_SLEEP);
  	ctx->child = cipher;
++<<<<<<< HEAD
 +	tfm->crt_aead.reqsize = sizeof(struct cryptd_aead_request_ctx);
++=======
+ 	crypto_aead_set_reqsize(
+ 		tfm, max((unsigned)sizeof(struct cryptd_aead_request_ctx),
+ 			 crypto_aead_reqsize(cipher)));
++>>>>>>> ec9f2006fc02 (crypto: cryptd - Fix AEAD request context corruption)
  	return 0;
  }
  
@@@ -747,10 -775,11 +755,18 @@@ static int cryptd_create_aead(struct cr
  			      struct cryptd_queue *queue)
  {
  	struct aead_instance_ctx *ctx;
++<<<<<<< HEAD
 +	struct crypto_instance *inst;
 +	struct crypto_alg *alg;
 +	u32 type = CRYPTO_ALG_TYPE_AEAD;
 +	u32 mask = CRYPTO_ALG_TYPE_MASK;
++=======
+ 	struct aead_instance *inst;
+ 	struct aead_alg *alg;
+ 	const char *name;
+ 	u32 type = 0;
+ 	u32 mask = CRYPTO_ALG_ASYNC;
++>>>>>>> ec9f2006fc02 (crypto: cryptd - Fix AEAD request context corruption)
  	int err;
  
  	cryptd_check_internal(tb, &type, &mask);
* Unmerged path crypto/cryptd.c
