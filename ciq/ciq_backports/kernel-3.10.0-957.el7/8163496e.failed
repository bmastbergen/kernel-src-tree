nfsd: don't advertise a SCSI layout for an unsupported request_queue

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
commit-author Benjamin Coddington <bcodding@redhat.com>
commit 8163496e78db100a6b5cfbdaece385686ae50129
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/8163496e.failed

Commit 30181faae37f ("nfsd: Check queue type before submitting a SCSI
request") did the work of ensuring that we don't send SCSI requests to a
request queue that won't support them, but that check is in the
GETDEVICEINFO path.  Let's not set the SCSI layout in fs_layout_type in the
first place, and then we'll have less clients sending GETDEVICEINFO for
non-SCSI request queues and less unnecessary WARN_ONs.

While we're in here, remove some outdated comments that refer to
"overwriting" layout seletion because commit 8a4c3926889e ("nfsd: allow
nfsd to advertise multiple layout types") changed things to no longer
overwrite the layout type.

	Signed-off-by: Benjamin Coddington <bcodding@redhat.com>
	Reviewed-by: Christoph Hellwig <hch@lst.de>
	Signed-off-by: J. Bruce Fields <bfields@redhat.com>
(cherry picked from commit 8163496e78db100a6b5cfbdaece385686ae50129)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/nfsd/nfs4layouts.c
diff --cc fs/nfsd/nfs4layouts.c
index ca549bdbc231,2b36aa037ce0..000000000000
--- a/fs/nfsd/nfs4layouts.c
+++ b/fs/nfsd/nfs4layouts.c
@@@ -127,23 -133,21 +127,34 @@@ void nfsd4_setup_layout_type(struct svc
  	if (!(exp->ex_flags & NFSEXP_PNFS))
  		return;
  
++<<<<<<< HEAD
 +	/*
 +	 * Check if the file system supports exporting a block-like layout.
 +	 * If the block device supports reservations prefer the SCSI layout,
 +	 * otherwise advertise the block layout.
 +	 */
++=======
+ #ifdef CONFIG_NFSD_FLEXFILELAYOUT
+ 	exp->ex_layout_types |= 1 << LAYOUT_FLEX_FILES;
+ #endif
++>>>>>>> 8163496e78db (nfsd: don't advertise a SCSI layout for an unsupported request_queue)
  #ifdef CONFIG_NFSD_BLOCKLAYOUT
  	if (sb->s_export_op->get_uuid &&
  	    sb->s_export_op->map_blocks &&
  	    sb->s_export_op->commit_blocks)
 -		exp->ex_layout_types |= 1 << LAYOUT_BLOCK_VOLUME;
 +		exp->ex_layout_type = LAYOUT_BLOCK_VOLUME;
  #endif
  #ifdef CONFIG_NFSD_SCSILAYOUT
- 	/* overwrite block layout selection if needed */
  	if (sb->s_export_op->map_blocks &&
  	    sb->s_export_op->commit_blocks &&
++<<<<<<< HEAD
 +	    sb->s_bdev && sb->s_bdev->bd_disk->fops->pr_ops)
 +		exp->ex_layout_type = LAYOUT_SCSI;
++=======
+ 	    sb->s_bdev && sb->s_bdev->bd_disk->fops->pr_ops &&
+ 		blk_queue_scsi_passthrough(sb->s_bdev->bd_disk->queue))
+ 		exp->ex_layout_types |= 1 << LAYOUT_SCSI;
++>>>>>>> 8163496e78db (nfsd: don't advertise a SCSI layout for an unsupported request_queue)
  #endif
  }
  
* Unmerged path fs/nfsd/nfs4layouts.c
