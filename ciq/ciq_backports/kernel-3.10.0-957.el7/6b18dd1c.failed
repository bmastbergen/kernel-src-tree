race of lockd inetaddr notifiers vs nlmsvc_rqst change

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
commit-author Vasily Averin <vvs@virtuozzo.com>
commit 6b18dd1c03e07262ea0866084856b2a3c5ba8d09
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/6b18dd1c.failed

lockd_inet[6]addr_event use nlmsvc_rqst without taken nlmsvc_mutex,
nlmsvc_rqst can be changed during execution of notifiers and crash the host.

Patch enables access to nlmsvc_rqst only when it was correctly initialized
and delays its cleanup until notifiers are no longer in use.

Note that nlmsvc_rqst can be temporally set to ERR_PTR, so the "if
(nlmsvc_rqst)" check in notifiers is insufficient on its own.

	Signed-off-by: Vasily Averin <vvs@virtuozzo.com>
	Tested-by: Scott Mayhew <smayhew@redhat.com>
	Signed-off-by: J. Bruce Fields <bfields@redhat.com>
(cherry picked from commit 6b18dd1c03e07262ea0866084856b2a3c5ba8d09)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/lockd/svc.c
diff --cc fs/lockd/svc.c
index f1a8d27f4592,9c36d614bf89..000000000000
--- a/fs/lockd/svc.c
+++ b/fs/lockd/svc.c
@@@ -57,7 -57,10 +57,14 @@@ static struct task_struct	*nlmsvc_task
  static struct svc_rqst		*nlmsvc_rqst;
  unsigned long			nlmsvc_timeout;
  
++<<<<<<< HEAD
 +int lockd_net_id;
++=======
+ atomic_t nlm_ntf_refcnt = ATOMIC_INIT(0);
+ DECLARE_WAIT_QUEUE_HEAD(nlm_ntf_wq);
+ 
+ unsigned int lockd_net_id;
++>>>>>>> 6b18dd1c03e0 (race of lockd inetaddr notifiers vs nlmsvc_rqst change)
  
  /*
   * These can be set at insmod time (useful for NFS as root filesystem),
* Unmerged path fs/lockd/svc.c
