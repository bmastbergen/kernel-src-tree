HID: wacom: Fix reporting of touch toggle (WACOM_HID_WD_MUTE_DEVICE) events

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
Rebuild_CHGLOG: - [hid] wacom: Fix reporting of touch toggle (WACOM_HID_WD_MUTE_DEVICE) events (Benjamin Tissoires) [1551776]
Rebuild_FUZZ: 96.55%
commit-author Jason Gerecke <killertofu@gmail.com>
commit 403c0f681c1964ff1db8c2fb8de8c4067779d081
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/403c0f68.failed

Touch toggle softkeys send a '1' while pressed and a '0' while released,
requring the kernel to keep track of wether touch should be enabled or
disabled. The code does not handle the state transitions properly,
however. If the key is pressed repeatedly, the following four states
of states are cycled through (assuming touch starts out enabled):

Press:   shared->is_touch_on => 0, SW_MUTE_DEVICE => 1
Release: shared->is_touch_on => 0, SW_MUTE_DEVICE => 1
Press:   shared->is_touch_on => 1, SW_MUTE_DEVICE => 0
Release: shared->is_touch_on => 1, SW_MUTE_DEVICE => 1

The hardware always properly enables/disables touch when the key is
pressed but applications that listen for SW_MUTE_DEVICE events to provide
feedback about the state will only ever show touch as being enabled while
the key is held, and only every-other time. This sequence occurs because
the fallthrough WACOM_HID_WD_TOUCHONOFF case is always handled, and it
uses the value of the *local* is_touch_on variable as the value to
report to userspace. The local value is equal to the shared value when
the button is pressed, but equal to zero when the button is released.

Reporting the shared value to userspace fixes this problem, but the
fallthrough case needs to update the shared value in an incompatible
way (which is why the local variable was introduced in the first place).
To work around this, we just handle both cases in a single block of code
and update the shared variable as appropriate.

Fixes: d793ff8187 ("HID: wacom: generic: support touch on/off softkey")
	Cc: <stable@vger.kernel.org> # v4.12+
	Signed-off-by: Jason Gerecke <jason.gerecke@wacom.com>
	Reviewed-by: Aaron Skomra <aaron.skomra@wacom.com>
	Tested-by: Aaron Skomra <aaron.skomra@wacom.com>
	Signed-off-by: Jiri Kosina <jkosina@suse.cz>
(cherry picked from commit 403c0f681c1964ff1db8c2fb8de8c4067779d081)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/hid/wacom_wac.c
diff --cc drivers/hid/wacom_wac.c
index f3c8d3c180d2,061e4d7a0647..000000000000
--- a/drivers/hid/wacom_wac.c
+++ b/drivers/hid/wacom_wac.c
@@@ -1917,8 -1921,9 +1917,12 @@@ static void wacom_wac_pad_event(struct 
  	struct wacom *wacom = hid_get_drvdata(hdev);
  	struct wacom_wac *wacom_wac = &wacom->wacom_wac;
  	struct input_dev *input = wacom_wac->pad_input;
 -	struct wacom_features *features = &wacom_wac->features;
  	unsigned equivalent_usage = wacom_equivalent_usage(usage->hid);
++<<<<<<< HEAD
 +	bool is_touch_on = value;
++=======
+ 	int i;
++>>>>>>> 403c0f681c19 (HID: wacom: Fix reporting of touch toggle (WACOM_HID_WD_MUTE_DEVICE) events)
  	bool do_report = false;
  
  	/*
* Unmerged path drivers/hid/wacom_wac.c
