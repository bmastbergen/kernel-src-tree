ceph: quota: don't allow cross-quota renames

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
commit-author Luis Henriques <lhenriques@suse.com>
commit cafe21a4fb3075fb2980caba8fdb533a1bdb52b0
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/cafe21a4.failed

This patch changes ceph_rename so that -EXDEV is returned if an attempt is
made to mv a file between two different dir trees with different quotas
setup.

	Signed-off-by: Luis Henriques <lhenriques@suse.com>
	Reviewed-by: "Yan, Zheng" <zyan@redhat.com>
	Signed-off-by: Ilya Dryomov <idryomov@gmail.com>
(cherry picked from commit cafe21a4fb3075fb2980caba8fdb533a1bdb52b0)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/ceph/quota.c
#	fs/ceph/super.h
diff --cc fs/ceph/super.h
index 2ea6359d8d08,eea6f70f3bf9..000000000000
--- a/fs/ceph/super.h
+++ b/fs/ceph/super.h
@@@ -1022,4 -1073,11 +1022,14 @@@ extern int lock_to_ceph_filelock(struc
  extern int ceph_fs_debugfs_init(struct ceph_fs_client *client);
  extern void ceph_fs_debugfs_cleanup(struct ceph_fs_client *client);
  
++<<<<<<< HEAD
++=======
+ /* quota.c */
+ extern void ceph_handle_quota(struct ceph_mds_client *mdsc,
+ 			      struct ceph_mds_session *session,
+ 			      struct ceph_msg *msg);
+ extern bool ceph_quota_is_max_files_exceeded(struct inode *inode);
+ extern bool ceph_quota_is_same_realm(struct inode *old, struct inode *new);
+ 
++>>>>>>> cafe21a4fb30 (ceph: quota: don't allow cross-quota renames)
  #endif /* _FS_CEPH_SUPER_H */
* Unmerged path fs/ceph/quota.c
diff --git a/fs/ceph/dir.c b/fs/ceph/dir.c
index 83040cdc8671..a788bff0d557 100644
--- a/fs/ceph/dir.c
+++ b/fs/ceph/dir.c
@@ -1102,6 +1102,11 @@ static int ceph_rename(struct inode *old_dir, struct dentry *old_dentry,
 		else
 			return -EROFS;
 	}
+	/* don't allow cross-quota renames */
+	if ((old_dir != new_dir) &&
+	    (!ceph_quota_is_same_realm(old_dir, new_dir)))
+		return -EXDEV;
+
 	dout("rename dir %p dentry %p to dir %p dentry %p\n",
 	     old_dir, old_dentry, new_dir, new_dentry);
 	req = ceph_mdsc_create_request(mdsc, op, USE_AUTH_MDS);
* Unmerged path fs/ceph/quota.c
* Unmerged path fs/ceph/super.h
