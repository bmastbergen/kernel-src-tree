ASoC: dmic: Add optional wakeup delay

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
Rebuild_CHGLOG: - [sound] alsa: asoc: dmic: Add optional wakeup delay (Jaroslav Kysela) [1535427]
Rebuild_FUZZ: 92.50%
commit-author Matthias Kaehlcke <mka@chromium.org>
commit 05c9b302eda71083840392d74ce62dd1e1f30621
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/05c9b302.failed

On some systems a delay is needed after switching on the clocks, to allow
the output to stabilize and avoid a popping noise at the beginning of
the recording. Add the optional device tree property 'wakeup-delay-ms'
and apply the specified delay after enabling the mic. A blocking delay
can't be applied in dmic_daiops_trigger() since the function is called
in atomic context. Instead use a DAPM event handler to set the enable
GPIO and apply the delay in the handler.

	Signed-off-by: Matthias Kaehlcke <mka@chromium.org>
	Reviewed-by: Peter Ujfalusi <peter.ujfalusi@ti.com>
	Signed-off-by: Mark Brown <broonie@kernel.org>
(cherry picked from commit 05c9b302eda71083840392d74ce62dd1e1f30621)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	Documentation/devicetree/bindings/sound/dmic.txt
#	sound/soc/codecs/dmic.c
diff --cc sound/soc/codecs/dmic.c
index b88a1ee66f80,bac5bbb2dd59..000000000000
--- a/sound/soc/codecs/dmic.c
+++ b/sound/soc/codecs/dmic.c
@@@ -68,19 -68,25 +68,34 @@@ static struct snd_soc_dai_driver dmic_d
  			| SNDRV_PCM_FMTBIT_S24_LE
  			| SNDRV_PCM_FMTBIT_S16_LE,
  	},
- 	.ops    = &dmic_dai_ops,
  };
  
 -static int dmic_component_probe(struct snd_soc_component *component)
 +static int dmic_codec_probe(struct snd_soc_codec *codec)
  {
- 	struct gpio_desc *dmic_en;
+ 	struct dmic *dmic;
  
++<<<<<<< HEAD
 +	dmic_en = devm_gpiod_get_optional(codec->dev,
 +					"dmicen", GPIOD_OUT_LOW);
 +	if (IS_ERR(dmic_en))
 +		return PTR_ERR(dmic_en);
 +
 +	snd_soc_codec_set_drvdata(codec, dmic_en);
++=======
+ 	dmic = devm_kzalloc(component->dev, sizeof(*dmic), GFP_KERNEL);
+ 	if (!dmic)
+ 		return -ENOMEM;
+ 
+ 	dmic->gpio_en = devm_gpiod_get_optional(component->dev,
+ 						"dmicen", GPIOD_OUT_LOW);
+ 	if (IS_ERR(dmic->gpio_en))
+ 		return PTR_ERR(dmic->gpio_en);
+ 
+ 	device_property_read_u32(component->dev, "wakeup-delay-ms",
+ 				 &dmic->wakeup_delay);
+ 
+ 	snd_soc_component_set_drvdata(component, dmic);
++>>>>>>> 05c9b302eda7 (ASoC: dmic: Add optional wakeup delay)
  
  	return 0;
  }
* Unmerged path Documentation/devicetree/bindings/sound/dmic.txt
* Unmerged path Documentation/devicetree/bindings/sound/dmic.txt
* Unmerged path sound/soc/codecs/dmic.c
