KVM: PPC: Book3s PR: Allow access to unprivileged MMCR2 register

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
Rebuild_CHGLOG: - [powerpc] kvm: book3s pr: Allow access to unprivileged MMCR2 register (Laurent Vivier) [1464913]
Rebuild_FUZZ: 95.93%
commit-author Thomas Huth <thuth@redhat.com>
commit fa73c3b25bd8d0d393dc6109a1dba3c2aef0451e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/fa73c3b2.failed

The MMCR2 register is available twice, one time with number 785
(privileged access), and one time with number 769 (unprivileged,
but it can be disabled completely). In former times, the Linux
kernel was using the unprivileged register 769 only, but since
commit 8dd75ccb571f3c92c ("powerpc: Use privileged SPR number
for MMCR2"), it uses the privileged register 785 instead.
The KVM-PR code then of course also switched to use the SPR 785,
but this is causing older guest kernels to crash, since these
kernels still access 769 instead. So to support older kernels
with KVM-PR again, we have to support register 769 in KVM-PR, too.

Fixes: 8dd75ccb571f3c92c48014b3dabd3d51a115ab41
	Cc: stable@vger.kernel.org # v3.10+
	Signed-off-by: Thomas Huth <thuth@redhat.com>
	Signed-off-by: Paul Mackerras <paulus@ozlabs.org>
(cherry picked from commit fa73c3b25bd8d0d393dc6109a1dba3c2aef0451e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/powerpc/include/asm/reg.h
diff --cc arch/powerpc/include/asm/reg.h
index 14ddfc588abe,978dada662ae..000000000000
--- a/arch/powerpc/include/asm/reg.h
+++ b/arch/powerpc/include/asm/reg.h
@@@ -704,7 -736,8 +704,12 @@@
  #define   MMCR0_FCWAIT	0x00000002UL /* freeze counter in WAIT state */
  #define   MMCR0_FCHV	0x00000001UL /* freeze conditions in hypervisor mode */
  #define SPRN_MMCR1	798
++<<<<<<< HEAD
 +#define SPRN_MMCR2	769
++=======
+ #define SPRN_MMCR2	785
+ #define SPRN_UMMCR2	769
++>>>>>>> fa73c3b25bd8 (KVM: PPC: Book3s PR: Allow access to unprivileged MMCR2 register)
  #define SPRN_MMCRA	0x312
  #define   MMCRA_SDSYNC	0x80000000UL /* SDAR synced with SIAR */
  #define   MMCRA_SDAR_DCACHE_MISS 0x40000000UL
* Unmerged path arch/powerpc/include/asm/reg.h
diff --git a/arch/powerpc/kvm/book3s_emulate.c b/arch/powerpc/kvm/book3s_emulate.c
index 7d9e4ed2e415..8359752b3efc 100644
--- a/arch/powerpc/kvm/book3s_emulate.c
+++ b/arch/powerpc/kvm/book3s_emulate.c
@@ -498,6 +498,7 @@ int kvmppc_core_emulate_mtspr_pr(struct kvm_vcpu *vcpu, int sprn, ulong spr_val)
 	case SPRN_MMCR0:
 	case SPRN_MMCR1:
 	case SPRN_MMCR2:
+	case SPRN_UMMCR2:
 #endif
 		break;
 unprivileged:
@@ -640,6 +641,7 @@ int kvmppc_core_emulate_mfspr_pr(struct kvm_vcpu *vcpu, int sprn, ulong *spr_val
 	case SPRN_MMCR0:
 	case SPRN_MMCR1:
 	case SPRN_MMCR2:
+	case SPRN_UMMCR2:
 	case SPRN_TIR:
 #endif
 		*spr_val = 0;
