mm: fix crashes from mbind() merging vmas

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
Rebuild_CHGLOG: - [mm] mempolicy: fix crashes from mbind() merging vmas (Rafael Aquini) [1588002]
Rebuild_FUZZ: 92.13%
commit-author Hugh Dickins <hughd@google.com>
commit d05f0cdcbe6388723f1900c549b4850360545201
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/d05f0cdc.failed

In v2.6.34 commit 9d8cebd4bcd7 ("mm: fix mbind vma merge problem")
introduced vma merging to mbind(), but it should have also changed the
convention of passing start vma from queue_pages_range() (formerly
check_range()) to new_vma_page(): vma merging may have already freed
that structure, resulting in BUG at mm/mempolicy.c:1738 and probably
worse crashes.

Fixes: 9d8cebd4bcd7 ("mm: fix mbind vma merge problem")
	Reported-by: Naoya Horiguchi <n-horiguchi@ah.jp.nec.com>
	Tested-by: Naoya Horiguchi <n-horiguchi@ah.jp.nec.com>
	Signed-off-by: Hugh Dickins <hughd@google.com>
	Acked-by: Christoph Lameter <cl@linux.com>
	Cc: KOSAKI Motohiro <kosaki.motohiro@jp.fujitsu.com>
	Cc: Minchan Kim <minchan.kim@gmail.com>
	Cc: <stable@vger.kernel.org>	[2.6.34+]
	Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
	Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
(cherry picked from commit d05f0cdcbe6388723f1900c549b4850360545201)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	mm/mempolicy.c
diff --cc mm/mempolicy.c
index ae289df8f426,eb58de19f815..000000000000
--- a/mm/mempolicy.c
+++ b/mm/mempolicy.c
@@@ -1301,9 -1278,8 +1296,14 @@@ static long do_mbind(unsigned long star
  
  		if (!list_empty(&pagelist)) {
  			WARN_ON_ONCE(flags & MPOL_MF_LAZY);
++<<<<<<< HEAD
 +			nr_failed = migrate_pages(&pagelist, new_vma_page,
 +					(unsigned long)vma,
 +					MIGRATE_SYNC, MR_MEMPOLICY_MBIND);
++=======
+ 			nr_failed = migrate_pages(&pagelist, new_page, NULL,
+ 				start, MIGRATE_SYNC, MR_MEMPOLICY_MBIND);
++>>>>>>> d05f0cdcbe63 (mm: fix crashes from mbind() merging vmas)
  			if (nr_failed)
  				putback_movable_pages(&pagelist);
  		}
* Unmerged path mm/mempolicy.c
