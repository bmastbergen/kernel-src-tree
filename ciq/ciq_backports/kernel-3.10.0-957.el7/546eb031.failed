libnvdimm, pmem: Do not flush power-fail protected CPU caches

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
commit-author Ross Zwisler <ross.zwisler@linux.intel.com>
commit 546eb0317cfa3c4f9e1d9ab892766d65d7f78fad
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/546eb031.failed

This commit:

5fdf8e5ba566 ("libnvdimm: re-enable deep flush for pmem devices via fsync()")

intended to make sure that deep flush was always available even on
platforms which support a power-fail protected CPU cache.  An unintended
side effect of this change was that we also lost the ability to skip
flushing CPU caches on those power-fail protected CPU cache.

Fix this by skipping the low level cache flushing in dax_flush() if we have
CPU caches which are power-fail protected.  The user can still override this
behavior by manually setting the write_cache state of a namespace.  See
libndctl's ndctl_namespace_write_cache_is_enabled(),
ndctl_namespace_enable_write_cache() and
ndctl_namespace_disable_write_cache() functions.

	Cc: <stable@vger.kernel.org>
Fixes: 5fdf8e5ba566 ("libnvdimm: re-enable deep flush for pmem devices via fsync()")
	Signed-off-by: Ross Zwisler <ross.zwisler@linux.intel.com>
	Signed-off-by: Dan Williams <dan.j.williams@intel.com>
(cherry picked from commit 546eb0317cfa3c4f9e1d9ab892766d65d7f78fad)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/nvdimm/region_devs.c
diff --cc drivers/nvdimm/region_devs.c
index ea6798d792b3,ec3543b83330..000000000000
--- a/drivers/nvdimm/region_devs.c
+++ b/drivers/nvdimm/region_devs.c
@@@ -1128,6 -1130,13 +1128,16 @@@ int nvdimm_has_flush(struct nd_region *
  }
  EXPORT_SYMBOL_GPL(nvdimm_has_flush);
  
++<<<<<<< HEAD
++=======
+ int nvdimm_has_cache(struct nd_region *nd_region)
+ {
+ 	return is_nd_pmem(&nd_region->dev) &&
+ 		!test_bit(ND_REGION_PERSIST_CACHE, &nd_region->flags);
+ }
+ EXPORT_SYMBOL_GPL(nvdimm_has_cache);
+ 
++>>>>>>> 546eb0317cfa (libnvdimm, pmem: Do not flush power-fail protected CPU caches)
  void __exit nd_region_devs_exit(void)
  {
  	ida_destroy(&region_ida);
* Unmerged path drivers/nvdimm/region_devs.c
