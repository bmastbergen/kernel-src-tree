virtio_blk: fix incorrect message when disk is resized

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
commit-author Stefan Hajnoczi <stefanha@redhat.com>
commit 1046d304900cf9d4b2c730c6860b8e03cc704377
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/1046d304.failed

The message printed on disk resize is incorrect.  The following is
printed when resizing to 2 GiB:

  $ truncate -s 1G test.img
  $ qemu -device virtio-blk-pci,logical_block_size=4096,...
  (qemu) block_resize drive1 2G

  virtio_blk virtio0: new size: 4194304 4096-byte logical blocks (17.2 GB/16.0 GiB)

The virtio_blk capacity config field is in 512-byte sector units
regardless of logical_block_size as per the VIRTIO specification.
Therefore the message should read:

  virtio_blk virtio0: new size: 524288 4096-byte logical blocks (2.15 GB/2.0 GiB)

Note that this only affects the printed message.  Thankfully the actual
block device has the correct size because the block layer expects
capacity in sectors.

	Signed-off-by: Stefan Hajnoczi <stefanha@redhat.com>
	Signed-off-by: Michael S. Tsirkin <mst@redhat.com>
(cherry picked from commit 1046d304900cf9d4b2c730c6860b8e03cc704377)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/block/virtio_blk.c
diff --cc drivers/block/virtio_blk.c
index 12e2f30eeaac,d3d5523862c2..000000000000
--- a/drivers/block/virtio_blk.c
+++ b/drivers/block/virtio_blk.c
@@@ -342,7 -381,8 +342,12 @@@ static void virtblk_config_changed_work
  	struct request_queue *q = vblk->disk->queue;
  	char cap_str_2[10], cap_str_10[10];
  	char *envp[] = { "RESIZE=1", NULL };
++<<<<<<< HEAD
 +	u64 capacity, size;
++=======
+ 	unsigned long long nblocks;
+ 	u64 capacity;
++>>>>>>> 1046d304900c (virtio_blk: fix incorrect message when disk is resized)
  
  	/* Host must always specify the capacity. */
  	virtio_cread(vdev, struct virtio_blk_config, capacity, &capacity);
@@@ -354,15 -394,19 +359,25 @@@
  		capacity = (sector_t)-1;
  	}
  
++<<<<<<< HEAD
 +	size = capacity * queue_logical_block_size(q);
 +	string_get_size(size, STRING_UNITS_2, cap_str_2, sizeof(cap_str_2));
 +	string_get_size(size, STRING_UNITS_10, cap_str_10, sizeof(cap_str_10));
++=======
+ 	nblocks = DIV_ROUND_UP_ULL(capacity, queue_logical_block_size(q) >> 9);
+ 
+ 	string_get_size(nblocks, queue_logical_block_size(q),
+ 			STRING_UNITS_2, cap_str_2, sizeof(cap_str_2));
+ 	string_get_size(nblocks, queue_logical_block_size(q),
+ 			STRING_UNITS_10, cap_str_10, sizeof(cap_str_10));
++>>>>>>> 1046d304900c (virtio_blk: fix incorrect message when disk is resized)
  
  	dev_notice(&vdev->dev,
- 		  "new size: %llu %d-byte logical blocks (%s/%s)\n",
- 		  (unsigned long long)capacity,
- 		  queue_logical_block_size(q),
- 		  cap_str_10, cap_str_2);
+ 		   "new size: %llu %d-byte logical blocks (%s/%s)\n",
+ 		   nblocks,
+ 		   queue_logical_block_size(q),
+ 		   cap_str_10,
+ 		   cap_str_2);
  
  	set_capacity(vblk->disk, capacity);
  	revalidate_disk(vblk->disk);
* Unmerged path drivers/block/virtio_blk.c
