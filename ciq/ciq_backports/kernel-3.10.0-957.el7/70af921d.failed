net: ipv6: Do not keep linklocal and loopback addresses

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
Rebuild_CHGLOG: - [net] ipv6: Do not keep linklocal and loopback addresses (Ivan Vecera) [1500871]
Rebuild_FUZZ: 95.24%
commit-author David Ahern <dsa@cumulusnetworks.com>
commit 70af921db6f8835f4b11c65731116560adb00c14
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/70af921d.failed

f1705ec197e7 added the option to retain user configured addresses on an
admin down. A comment to one of the later revisions suggested using the
IFA_F_PERMANENT flag rather than adding a user_managed boolean to the
ifaddr struct. A side effect of this change is that link local and
loopback addresses are also retained which is not part of the objective
of f1705ec197e7. Add check to drop those addresses.

Fixes: f1705ec197e7 ("net: ipv6: Make address flushing on ifdown optional")
	Signed-off-by: David Ahern <dsa@cumulusnetworks.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 70af921db6f8835f4b11c65731116560adb00c14)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/ipv6/addrconf.c
diff --cc net/ipv6/addrconf.c
index e92da293a901,23cec53b568a..000000000000
--- a/net/ipv6/addrconf.c
+++ b/net/ipv6/addrconf.c
@@@ -3291,12 -3503,19 +3297,24 @@@ static int addrconf_ifdown(struct net_d
  		struct hlist_head *h = &inet6_addr_lst[i];
  
  		spin_lock_bh(&addrconf_hash_lock);
 -restart:
 +	restart:
  		hlist_for_each_entry_rcu(ifa, h, addr_lst) {
  			if (ifa->idev == idev) {
 +				hlist_del_init_rcu(&ifa->addr_lst);
  				addrconf_del_dad_work(ifa);
++<<<<<<< HEAD
 +				goto restart;
++=======
+ 				/* combined flag + permanent flag decide if
+ 				 * address is retained on a down event
+ 				 */
+ 				if (!keep_addr ||
+ 				    !(ifa->flags & IFA_F_PERMANENT) ||
+ 				    addr_is_local(&ifa->addr)) {
+ 					hlist_del_init_rcu(&ifa->addr_lst);
+ 					goto restart;
+ 				}
++>>>>>>> 70af921db6f8 (net: ipv6: Do not keep linklocal and loopback addresses)
  			}
  		}
  		spin_unlock_bh(&addrconf_hash_lock);
@@@ -3330,18 -3549,33 +3348,37 @@@
  		write_lock_bh(&idev->lock);
  	}
  
 -	/* re-combine the user config with event to determine if permanent
 -	 * addresses are to be removed from the interface list
 -	 */
 -	keep_addr = (!how && _keep_addr > 0);
 -
 -	INIT_LIST_HEAD(&del_list);
 -	list_for_each_entry_safe(ifa, tmp, &idev->addr_list, if_list) {
 +	while (!list_empty(&idev->addr_list)) {
 +		ifa = list_first_entry(&idev->addr_list,
 +				       struct inet6_ifaddr, if_list);
  		addrconf_del_dad_work(ifa);
  
 +		list_del(&ifa->if_list);
 +
  		write_unlock_bh(&idev->lock);
 +
  		spin_lock_bh(&ifa->lock);
++<<<<<<< HEAD
 +		state = ifa->state;
 +		ifa->state = INET6_IFADDR_STATE_DEAD;
++=======
+ 
+ 		if (keep_addr && (ifa->flags & IFA_F_PERMANENT) &&
+ 		    !addr_is_local(&ifa->addr)) {
+ 			/* set state to skip the notifier below */
+ 			state = INET6_IFADDR_STATE_DEAD;
+ 			ifa->state = 0;
+ 			if (!(ifa->flags & IFA_F_NODAD))
+ 				ifa->flags |= IFA_F_TENTATIVE;
+ 		} else {
+ 			state = ifa->state;
+ 			ifa->state = INET6_IFADDR_STATE_DEAD;
+ 
+ 			list_del(&ifa->if_list);
+ 			list_add(&ifa->if_list, &del_list);
+ 		}
+ 
++>>>>>>> 70af921db6f8 (net: ipv6: Do not keep linklocal and loopback addresses)
  		spin_unlock_bh(&ifa->lock);
  
  		if (state != INET6_IFADDR_STATE_DEAD) {
* Unmerged path net/ipv6/addrconf.c
