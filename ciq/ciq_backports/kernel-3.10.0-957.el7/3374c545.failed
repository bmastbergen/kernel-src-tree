PCI: Account for all bridges on bus when distributing bus numbers

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
Rebuild_CHGLOG: - [pci] Account for all bridges on bus when distributing bus numbers (Jarod Wilson) [1495223]
Rebuild_FUZZ: 96.00%
commit-author Mika Westerberg <mika.westerberg@linux.intel.com>
commit 3374c545c27c5350b954d1ab03c880d5502e5eba
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/3374c545.failed

When distributing extra bus number space to hotplug bridges for future
extension, we don't account for the fact that there might be non-hotplug
bridges on the bus after the hotplug bridges.  For example:

  01:00.0 --+- 02:00.0 (HotPlug-) -- Thunderbolt host controller
            +- 02:01.0 (HotPlug+)
            \- 02:02.0 (HotPlug-) -- xHCI host controller

pci_scan_child_bus_extend() is supposed to distribute the remaining bus
numbers to the hotplug bridge at 02:01.0, but only after accounting for all
bridges on bus 02.  Since we don't check whether there's another
non-hotplug bridge after the hotplug bridge 02:01.0, it may not leave space
for the non-hotplug bridge:

  pci 0000:00:1b.0: PCI bridge to [bus 01-39]  (Root Port)
  pci 0000:01:00.0: PCI bridge to [bus 02-39]
  ...
  pci 0000:02:00.0: PCI bridge to [bus 03]
  pci 0000:02:01.0: PCI bridge to [bus 04]
  pci_bus 0000:04: [bus 04-39] extended by 0x35
  pci_bus 0000:04: bus scan returning with max=39
  pci_bus 0000:04: busn_res: [bus 04-39] end is updated to 39
  pci 0000:02:02.0: scanning [bus 00-00] behind bridge, pass 1
  pci_bus 0000:3a: scanning bus
  pci_bus 0000:3a: bus scan returning with max=3a
  pci_bus 0000:3a: busn_res: [bus 3a] end is updated to 3a
  pci_bus 0000:3a: [bus 3a] partially hidden behind bridge 0000:02 [bus 02-39]
  pci_bus 0000:3a: [bus 3a] partially hidden behind bridge 0000:01 [bus 01-39]
  pci_bus 0000:02: bus scan returning with max=3a
  pci_bus 0000:02: busn_res: [bus 02-39] end can not be updated to 3a

The resulting 'lspci -t' output looks like this:

  +-1b.0-[01-39]----00.0-[02-3a]--+-00.0-[03]----00.0
                             ^^   +-01.0-[04-39]--
                                  \-02.0-[3a]----00.0
                                          ^^
The xHCI host controller behind 02:02.0 is not usable because it would have
to be assigned bus 3a, which is not accessible through 00:1b.0.

To fix this, reserve at least one bus for each bridge while scanning
already configured bridges.  Then use this information in the second
scan to correct the available extra bus space for hotplug bridges.

After this change the 'lspci -t' output is what is expected:

  +-1b.0-[01-39]----00.0-[02-39]--+-00.0-[03]----00.0
                                  +-01.0-[04-38]--
                                  \-02.0-[39]----00.0

The xHCI controller is now on bus 39, where it is usable.

Fixes: 1c02ea810065 ("PCI: Distribute available buses to hotplug-capable bridges")
	Reported-by: Mario Limonciello <mario.limonciello@dell.com>
	Signed-off-by: Mika Westerberg <mika.westerberg@linux.intel.com>
[bhelgaas: changelog]
	Signed-off-by: Bjorn Helgaas <bhelgaas@google.com>
	Reviewed-by: Rafael J. Wysocki <rafael.j.wysocki@intel.com>
	Reviewed-by: Andy Shevchenko <andriy.shevchenko@linux.intel.com>
	Cc: stable@vger.kernel.org
(cherry picked from commit 3374c545c27c5350b954d1ab03c880d5502e5eba)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/pci/probe.c
diff --cc drivers/pci/probe.c
index 60cc4d4c4ea4,6d3cae0362c9..000000000000
--- a/drivers/pci/probe.c
+++ b/drivers/pci/probe.c
@@@ -2093,9 -2619,65 +2093,71 @@@ unsigned int pci_scan_child_bus(struct 
  		bus->is_added = 1;
  	}
  
++<<<<<<< HEAD
 +	for (pass = 0; pass < 2; pass++)
 +		for_each_pci_bridge(dev, bus)
 +			max = pci_scan_bridge(bus, dev, max, pass);
++=======
+ 	/*
+ 	 * Calculate how many hotplug bridges and normal bridges there
+ 	 * are on this bus. We will distribute the additional available
+ 	 * buses between hotplug bridges.
+ 	 */
+ 	for_each_pci_bridge(dev, bus) {
+ 		if (dev->is_hotplug_bridge)
+ 			hotplug_bridges++;
+ 		else
+ 			normal_bridges++;
+ 	}
+ 
+ 	/*
+ 	 * Scan bridges that are already configured. We don't touch them
+ 	 * unless they are misconfigured (which will be done in the second
+ 	 * scan below).
+ 	 */
+ 	for_each_pci_bridge(dev, bus) {
+ 		cmax = max;
+ 		max = pci_scan_bridge_extend(bus, dev, max, 0, 0);
+ 
+ 		/*
+ 		 * Reserve one bus for each bridge now to avoid extending
+ 		 * hotplug bridges too much during the second scan below.
+ 		 */
+ 		used_buses++;
+ 		if (cmax - max > 1)
+ 			used_buses += cmax - max - 1;
+ 	}
+ 
+ 	/* Scan bridges that need to be reconfigured */
+ 	for_each_pci_bridge(dev, bus) {
+ 		unsigned int buses = 0;
+ 
+ 		if (!hotplug_bridges && normal_bridges == 1) {
+ 
+ 			/*
+ 			 * There is only one bridge on the bus (upstream
+ 			 * port) so it gets all available buses which it
+ 			 * can then distribute to the possible hotplug
+ 			 * bridges below.
+ 			 */
+ 			buses = available_buses;
+ 		} else if (dev->is_hotplug_bridge) {
+ 
+ 			/*
+ 			 * Distribute the extra buses between hotplug
+ 			 * bridges if any.
+ 			 */
+ 			buses = available_buses / hotplug_bridges;
+ 			buses = min(buses, available_buses - used_buses + 1);
+ 		}
+ 
+ 		cmax = max;
+ 		max = pci_scan_bridge_extend(bus, dev, cmax, buses, 1);
+ 		/* One bus is already accounted so don't add it again */
+ 		if (max - cmax > 1)
+ 			used_buses += max - cmax - 1;
+ 	}
++>>>>>>> 3374c545c27c (PCI: Account for all bridges on bus when distributing bus numbers)
  
  	/*
  	 * Make sure a hotplug bridge has at least the minimum requested
* Unmerged path drivers/pci/probe.c
