iommu/iova: Add flush-queue data structures

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
Rebuild_CHGLOG: - [iommu] iova: Add flush-queue data structures (Jerry Snitselaar) [1519117]
Rebuild_FUZZ: 92.50%
commit-author Joerg Roedel <jroedel@suse.de>
commit 42f87e71c3df12d8f29ec1bb7b47772ffaeaf1ee
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/42f87e71.failed

This patch adds the basic data-structures to implement
flush-queues in the generic IOVA code. It also adds the
initialization and destroy routines for these data
structures.

The initialization routine is designed so that the use of
this feature is optional for the users of IOVA code.

	Signed-off-by: Joerg Roedel <jroedel@suse.de>
(cherry picked from commit 42f87e71c3df12d8f29ec1bb7b47772ffaeaf1ee)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/iommu/iova.c
#	include/linux/iova.h
diff --cc drivers/iommu/iova.c
index f106fd9782bf,b9f6ce02a1e1..000000000000
--- a/drivers/iommu/iova.c
+++ b/drivers/iommu/iova.c
@@@ -48,7 -49,9 +48,13 @@@ init_iova_domain(struct iova_domain *io
  	iovad->cached32_node = NULL;
  	iovad->granule = granule;
  	iovad->start_pfn = start_pfn;
++<<<<<<< HEAD
 +	iovad->dma_32bit_pfn = pfn_32bit;
++=======
+ 	iovad->dma_32bit_pfn = pfn_32bit + 1;
+ 	iovad->flush_cb = NULL;
+ 	iovad->fq = NULL;
++>>>>>>> 42f87e71c3df (iommu/iova: Add flush-queue data structures)
  	init_iova_rcaches(iovad);
  }
  EXPORT_SYMBOL_GPL(init_iova_domain);
diff --cc include/linux/iova.h
index f27bb2c62fca,8aa10896150e..000000000000
--- a/include/linux/iova.h
+++ b/include/linux/iova.h
@@@ -106,5 -141,102 +140,105 @@@ void put_iova_domain(struct iova_domai
  struct iova *split_and_remove_iova(struct iova_domain *iovad,
  	struct iova *iova, unsigned long pfn_lo, unsigned long pfn_hi);
  void free_cpu_cached_iovas(unsigned int cpu, struct iova_domain *iovad);
++<<<<<<< HEAD
++=======
+ #else
+ static inline int iova_cache_get(void)
+ {
+ 	return -ENOTSUPP;
+ }
+ 
+ static inline void iova_cache_put(void)
+ {
+ }
+ 
+ static inline struct iova *alloc_iova_mem(void)
+ {
+ 	return NULL;
+ }
+ 
+ static inline void free_iova_mem(struct iova *iova)
+ {
+ }
+ 
+ static inline void free_iova(struct iova_domain *iovad, unsigned long pfn)
+ {
+ }
+ 
+ static inline void __free_iova(struct iova_domain *iovad, struct iova *iova)
+ {
+ }
+ 
+ static inline struct iova *alloc_iova(struct iova_domain *iovad,
+ 				      unsigned long size,
+ 				      unsigned long limit_pfn,
+ 				      bool size_aligned)
+ {
+ 	return NULL;
+ }
+ 
+ static inline void free_iova_fast(struct iova_domain *iovad,
+ 				  unsigned long pfn,
+ 				  unsigned long size)
+ {
+ }
+ 
+ static inline unsigned long alloc_iova_fast(struct iova_domain *iovad,
+ 					    unsigned long size,
+ 					    unsigned long limit_pfn)
+ {
+ 	return 0;
+ }
+ 
+ static inline struct iova *reserve_iova(struct iova_domain *iovad,
+ 					unsigned long pfn_lo,
+ 					unsigned long pfn_hi)
+ {
+ 	return NULL;
+ }
+ 
+ static inline void copy_reserved_iova(struct iova_domain *from,
+ 				      struct iova_domain *to)
+ {
+ }
+ 
+ static inline void init_iova_domain(struct iova_domain *iovad,
+ 				    unsigned long granule,
+ 				    unsigned long start_pfn,
+ 				    unsigned long pfn_32bit)
+ {
+ }
+ 
+ static inline int init_iova_flush_queue(struct iova_domain *iovad,
+ 					iova_flush_cb flush_cb,
+ 					iova_entry_dtor entry_dtor)
+ {
+ 	return -ENODEV;
+ }
+ 
+ static inline struct iova *find_iova(struct iova_domain *iovad,
+ 				     unsigned long pfn)
+ {
+ 	return NULL;
+ }
+ 
+ static inline void put_iova_domain(struct iova_domain *iovad)
+ {
+ }
+ 
+ static inline struct iova *split_and_remove_iova(struct iova_domain *iovad,
+ 						 struct iova *iova,
+ 						 unsigned long pfn_lo,
+ 						 unsigned long pfn_hi)
+ {
+ 	return NULL;
+ }
+ 
+ static inline void free_cpu_cached_iovas(unsigned int cpu,
+ 					 struct iova_domain *iovad)
+ {
+ }
+ #endif
++>>>>>>> 42f87e71c3df (iommu/iova: Add flush-queue data structures)
  
  #endif
* Unmerged path drivers/iommu/iova.c
* Unmerged path include/linux/iova.h
