mmc: mmc_test: Disable Command Queue while mmc_test is used

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
Rebuild_CHGLOG: - [mmc] mmc_test: Disable Command Queue while mmc_test is used (Gopal Tiwari) [1549495]
Rebuild_FUZZ: 95.58%
commit-author Adrian Hunter <adrian.hunter@intel.com>
commit 9d4579a85c84340044b10ffa6cd576397f59dc93
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/9d4579a8.failed

Normal read and write commands may not be used while the command queue is
enabled. Disable the Command Queue when mmc_test is probed and re-enable it
when it is removed.

	Signed-off-by: Adrian Hunter <adrian.hunter@intel.com>
	Reviewed-by: Harjani Ritesh <riteshh@codeaurora.org>
	Reviewed-by: Linus Walleij <linus.walleij@linaro.org>
	Signed-off-by: Ulf Hansson <ulf.hansson@linaro.org>
(cherry picked from commit 9d4579a85c84340044b10ffa6cd576397f59dc93)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/mmc/core/mmc_test.c
#	include/linux/mmc/card.h
diff --cc drivers/mmc/core/mmc_test.c
index bd8eb9bfc153,fd1b4b8510b9..000000000000
--- a/drivers/mmc/core/mmc_test.c
+++ b/drivers/mmc/core/mmc_test.c
@@@ -22,6 -22,12 +22,15 @@@
  #include <linux/seq_file.h>
  #include <linux/module.h>
  
++<<<<<<< HEAD
++=======
+ #include "core.h"
+ #include "card.h"
+ #include "host.h"
+ #include "bus.h"
+ #include "mmc_ops.h"
+ 
++>>>>>>> 9d4579a85c84 (mmc: mmc_test: Disable Command Queue while mmc_test is used)
  #define RESULT_OK		0
  #define RESULT_FAIL		1
  #define RESULT_UNSUP_HOST	2
diff --cc include/linux/mmc/card.h
index e3f1031064a7,85b5f2bc8bb9..000000000000
--- a/include/linux/mmc/card.h
+++ b/include/linux/mmc/card.h
@@@ -276,6 -269,7 +276,10 @@@ struct mmc_card 
  #define MMC_QUIRK_TRIM_BROKEN	(1<<12)		/* Skip trim */
  #define MMC_QUIRK_BROKEN_HPI	(1<<13)		/* Disable broken HPI support */
  
++<<<<<<< HEAD
++=======
+ 	bool			reenable_cmdq;	/* Re-enable Command Queue */
++>>>>>>> 9d4579a85c84 (mmc: mmc_test: Disable Command Queue while mmc_test is used)
  
  	unsigned int		erase_size;	/* erase size in sectors */
   	unsigned int		erase_shift;	/* if erase unit is power 2 */
diff --git a/drivers/mmc/core/mmc.c b/drivers/mmc/core/mmc.c
index 3e6348da2f1e..e6a304c69b28 100644
--- a/drivers/mmc/core/mmc.c
+++ b/drivers/mmc/core/mmc.c
@@ -1777,6 +1777,13 @@ static int mmc_init_card(struct mmc_host *host, u32 ocr,
 		}
 	}
 
+	/*
+	 * In some cases (e.g. RPMB or mmc_test), the Command Queue must be
+	 * disabled for a time, so a flag is needed to indicate to re-enable the
+	 * Command Queue.
+	 */
+	card->reenable_cmdq = card->ext_csd.cmdq_en;
+
 	/*
 	 * The mandatory minimum values are defined for packed command.
 	 * read: 5, write: 3
* Unmerged path drivers/mmc/core/mmc_test.c
* Unmerged path include/linux/mmc/card.h
