xfs: remove prev argument to xfs_bmapi_reserve_delalloc

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
commit-author Christoph Hellwig <hch@lst.de>
commit 65c5f419788d623a0410eca1866134f5e4628594
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/65c5f419.failed

We can easily lookup the previous extent for the cases where we need it,
which saves the callers from looking it up for us later in the series.

	Signed-off-by: Christoph Hellwig <hch@lst.de>
	Reviewed-by: Brian Foster <bfoster@redhat.com>
	Signed-off-by: Dave Chinner <david@fromorbit.com>


(cherry picked from commit 65c5f419788d623a0410eca1866134f5e4628594)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/xfs/libxfs/xfs_bmap.h
#	fs/xfs/xfs_iomap.c
#	fs/xfs/xfs_reflink.c
diff --cc fs/xfs/libxfs/xfs_bmap.h
index b02804fe53c5,e3c2b5adf505..000000000000
--- a/fs/xfs/libxfs/xfs_bmap.h
+++ b/fs/xfs/libxfs/xfs_bmap.h
@@@ -201,8 -241,30 +201,36 @@@ struct xfs_bmbt_rec_host 
  	xfs_bmap_search_extents(struct xfs_inode *ip, xfs_fileoff_t bno,
  		int fork, int *eofp, xfs_extnum_t *lastxp,
  		struct xfs_bmbt_irec *gotp, struct xfs_bmbt_irec *prevp);
++<<<<<<< HEAD
 +int	xfs_bmapi_reserve_delalloc(struct xfs_inode *ip, xfs_fileoff_t aoff,
 +		xfs_filblks_t len, struct xfs_bmbt_irec *got,
 +		struct xfs_bmbt_irec *prev, xfs_extnum_t *lastx, int eof);
++=======
+ int	xfs_bmapi_reserve_delalloc(struct xfs_inode *ip, int whichfork,
+ 		xfs_fileoff_t aoff, xfs_filblks_t len,
+ 		struct xfs_bmbt_irec *got, xfs_extnum_t *lastx, int eof);
+ 
+ enum xfs_bmap_intent_type {
+ 	XFS_BMAP_MAP = 1,
+ 	XFS_BMAP_UNMAP,
+ };
+ 
+ struct xfs_bmap_intent {
+ 	struct list_head			bi_list;
+ 	enum xfs_bmap_intent_type		bi_type;
+ 	struct xfs_inode			*bi_owner;
+ 	int					bi_whichfork;
+ 	struct xfs_bmbt_irec			bi_bmap;
+ };
+ 
+ int	xfs_bmap_finish_one(struct xfs_trans *tp, struct xfs_defer_ops *dfops,
+ 		struct xfs_inode *ip, enum xfs_bmap_intent_type type,
+ 		int whichfork, xfs_fileoff_t startoff, xfs_fsblock_t startblock,
+ 		xfs_filblks_t blockcount, xfs_exntst_t state);
+ int	xfs_bmap_map_extent(struct xfs_mount *mp, struct xfs_defer_ops *dfops,
+ 		struct xfs_inode *ip, struct xfs_bmbt_irec *imap);
+ int	xfs_bmap_unmap_extent(struct xfs_mount *mp, struct xfs_defer_ops *dfops,
+ 		struct xfs_inode *ip, struct xfs_bmbt_irec *imap);
++>>>>>>> 65c5f419788d (xfs: remove prev argument to xfs_bmapi_reserve_delalloc)
  
  #endif	/* __XFS_BMAP_H__ */
diff --cc fs/xfs/xfs_iomap.c
index 6b763d8b96c1,59ffcac8a47d..000000000000
--- a/fs/xfs/xfs_iomap.c
+++ b/fs/xfs/xfs_iomap.c
@@@ -606,9 -621,8 +606,14 @@@ xfs_iomap_write_delay
  	}
  
  retry:
++<<<<<<< HEAD
 +	error = xfs_bmapi_reserve_delalloc(ip, offset_fsb,
 +			end_fsb - offset_fsb, &got,
 +			&prev, &idx, eof);
++=======
+ 	error = xfs_bmapi_reserve_delalloc(ip, XFS_DATA_FORK, offset_fsb,
+ 			end_fsb - offset_fsb, &got, &idx, eof);
++>>>>>>> 65c5f419788d (xfs: remove prev argument to xfs_bmapi_reserve_delalloc)
  	switch (error) {
  	case 0:
  		break;
* Unmerged path fs/xfs/xfs_reflink.c
diff --git a/fs/xfs/libxfs/xfs_bmap.c b/fs/xfs/libxfs/xfs_bmap.c
index 54c679c67045..4be3738a311e 100644
--- a/fs/xfs/libxfs/xfs_bmap.c
+++ b/fs/xfs/libxfs/xfs_bmap.c
@@ -4119,7 +4119,6 @@ xfs_bmapi_reserve_delalloc(
 	xfs_fileoff_t		aoff,
 	xfs_filblks_t		len,
 	struct xfs_bmbt_irec	*got,
-	struct xfs_bmbt_irec	*prev,
 	xfs_extnum_t		*lastx,
 	int			eof)
 {
@@ -4137,7 +4136,12 @@ xfs_bmapi_reserve_delalloc(
 	/* Figure out the extent size, adjust alen */
 	extsz = xfs_get_extsz_hint(ip);
 	if (extsz) {
-		error = xfs_bmap_extsize_align(mp, got, prev, extsz, rt, eof,
+		struct xfs_bmbt_irec	prev;
+
+		if (!xfs_iext_get_extent(ifp, *lastx - 1, &prev))
+			prev.br_startoff = NULLFILEOFF;
+
+		error = xfs_bmap_extsize_align(mp, got, &prev, extsz, rt, eof,
 					       1, 0, &aoff, &alen);
 		ASSERT(!error);
 	}
* Unmerged path fs/xfs/libxfs/xfs_bmap.h
* Unmerged path fs/xfs/xfs_iomap.c
* Unmerged path fs/xfs/xfs_reflink.c
