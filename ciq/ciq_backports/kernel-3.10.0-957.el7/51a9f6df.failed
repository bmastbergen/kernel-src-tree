drm/i915: Turn off g4x DP port in .post_disable()

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
commit-author Ville Syrj채l채 <ville.syrjala@linux.intel.com>
commit 51a9f6dfc00d35f927ecfaf6f0ae8ebaba39b3fe
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/51a9f6df.failed

While Bspec doesn't list a specific sequence for turning off the DP port
on g4x we are getting an underrun if the port is disabled in the
.disable() hook. Looks like the pipe stops when the port stops, and by
that time the plane disable may not have completed yet. Also the plane(s)
seem to end up in some wonky state when this happens as they also signal
another underrun immediately after we turn them back on during the next
enable sequence.

We could add a vblank wait in .disable() to avoid wedging the planes,
but I assume we're still tripping up the pipe in some way. So it seems
better to me to just follow the ILK+ sequence and turn off the DP port
in .post_disable() instead. This sequence doesn't seem to suffer from
this problem. Could be it was always the intended sequence for DP and
the gen4 bspec was just never updated to include it.

Originally we used the bad sequence even on ilk+, but I changed that
in commit 08aff3fe26ae ("drm/i915: Move DP port disable to post_disable
for pch platforms") as it was causing issues on those platforms as well.
I left out g4x then only because I didn't have the hardware to test it.
Now that I do it's fairly clear that the ilk+ sequence is also the
right choice for g4x.

v2: Fix whitespace fail (Jani)
    Mention the ilk+ commit (Jani)

	Cc: stable@vger.kernel.org
	Signed-off-by: Ville Syrj채l채 <ville.syrjala@linux.intel.com>
Link: https://patchwork.freedesktop.org/patch/msgid/20180613160553.11664-2-ville.syrjala@linux.intel.com
	Reviewed-by: Jani Nikula <jani.nikula@intel.com>
(cherry picked from commit 51a9f6dfc00d35f927ecfaf6f0ae8ebaba39b3fe)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/gpu/drm/i915/intel_dp.c
diff --cc drivers/gpu/drm/i915/intel_dp.c
index 533c6778522a,67875b00c8df..000000000000
--- a/drivers/gpu/drm/i915/intel_dp.c
+++ b/drivers/gpu/drm/i915/intel_dp.c
@@@ -2706,20 -2804,40 +2706,56 @@@ static void intel_disable_dp(struct int
  	intel_edp_backlight_off(old_conn_state);
  	intel_dp_sink_dpms(intel_dp, DRM_MODE_DPMS_OFF);
  	intel_edp_panel_off(intel_dp);
++<<<<<<< HEAD
 +
 +	/* disable the port before the pipe on g4x */
 +	if (INTEL_GEN(dev_priv) < 5)
 +		intel_dp_link_down(intel_dp);
 +}
 +
 +static void ilk_post_disable_dp(struct intel_encoder *encoder,
 +				struct intel_crtc_state *old_crtc_state,
 +				struct drm_connector_state *old_conn_state)
++=======
+ }
+ 
+ static void g4x_disable_dp(struct intel_encoder *encoder,
+ 			   const struct intel_crtc_state *old_crtc_state,
+ 			   const struct drm_connector_state *old_conn_state)
+ {
+ 	intel_disable_dp(encoder, old_crtc_state, old_conn_state);
+ }
+ 
+ static void vlv_disable_dp(struct intel_encoder *encoder,
+ 			   const struct intel_crtc_state *old_crtc_state,
+ 			   const struct drm_connector_state *old_conn_state)
+ {
+ 	struct intel_dp *intel_dp = enc_to_intel_dp(&encoder->base);
+ 
+ 	intel_psr_disable(intel_dp, old_crtc_state);
+ 
+ 	intel_disable_dp(encoder, old_crtc_state, old_conn_state);
+ }
+ 
+ static void g4x_post_disable_dp(struct intel_encoder *encoder,
+ 				const struct intel_crtc_state *old_crtc_state,
+ 				const struct drm_connector_state *old_conn_state)
++>>>>>>> 51a9f6dfc00d (drm/i915: Turn off g4x DP port in .post_disable())
  {
  	struct intel_dp *intel_dp = enc_to_intel_dp(&encoder->base);
 -	enum port port = encoder->port;
 +	enum port port = dp_to_dig_port(intel_dp)->port;
  
++<<<<<<< HEAD
 +	intel_dp_link_down(intel_dp);
++=======
+ 	/*
+ 	 * Bspec does not list a specific disable sequence for g4x DP.
+ 	 * Follow the ilk+ sequence (disable pipe before the port) for
+ 	 * g4x DP as it does not suffer from underruns like the normal
+ 	 * g4x modeset sequence (disable pipe after the port).
+ 	 */
+ 	intel_dp_link_down(encoder, old_crtc_state);
++>>>>>>> 51a9f6dfc00d (drm/i915: Turn off g4x DP port in .post_disable())
  
  	/* Only ilk+ has port A */
  	if (port == PORT_A)
@@@ -6167,11 -6455,10 +6203,16 @@@ bool intel_dp_init(struct drm_i915_priv
  	} else {
  		intel_encoder->pre_enable = g4x_pre_enable_dp;
  		intel_encoder->enable = g4x_enable_dp;
++<<<<<<< HEAD
 +		if (INTEL_GEN(dev_priv) >= 5)
 +			intel_encoder->post_disable = ilk_post_disable_dp;
++=======
+ 		intel_encoder->disable = g4x_disable_dp;
+ 		intel_encoder->post_disable = g4x_post_disable_dp;
++>>>>>>> 51a9f6dfc00d (drm/i915: Turn off g4x DP port in .post_disable())
  	}
  
 +	intel_dig_port->port = port;
  	intel_dig_port->dp.output_reg = output_reg;
  	intel_dig_port->max_lanes = 4;
  
* Unmerged path drivers/gpu/drm/i915/intel_dp.c
