x86/pti: Do not enable PTI on CPUs which are not vulnerable to Meltdown

jira LE-1907
cve CVE-2018-3639
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
Rebuild_CHGLOG: - [x86] pti: Do not enable PTI on CPUs which are not vulnerable to Meltdown (Waiman Long) [1584569] {CVE-2018-3639}
Rebuild_FUZZ: 97.10%
commit-author David Woodhouse <dwmw@amazon.co.uk>
commit fec9434a12f38d3aeafeb75711b71d8a1fdef621
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/fec9434a.failed

Also, for CPUs which don't speculate at all, don't report that they're
vulnerable to the Spectre variants either.

Leave the cpu_no_meltdown[] match table with just X86_VENDOR_AMD in it
for now, even though that could be done with a simple comparison, on the
assumption that we'll have more to add.

Based on suggestions from Dave Hansen and Alan Cox.

	Signed-off-by: David Woodhouse <dwmw@amazon.co.uk>
	Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
	Reviewed-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
	Reviewed-by: Borislav Petkov <bp@suse.de>
	Acked-by: Dave Hansen <dave.hansen@intel.com>
	Cc: gnomes@lxorguk.ukuu.org.uk
	Cc: ak@linux.intel.com
	Cc: ashok.raj@intel.com
	Cc: karahmed@amazon.de
	Cc: arjan@linux.intel.com
	Cc: torvalds@linux-foundation.org
	Cc: peterz@infradead.org
	Cc: bp@alien8.de
	Cc: pbonzini@redhat.com
	Cc: tim.c.chen@linux.intel.com
	Cc: gregkh@linux-foundation.org
Link: https://lkml.kernel.org/r/1516896855-7642-6-git-send-email-dwmw@amazon.co.uk

(cherry picked from commit fec9434a12f38d3aeafeb75711b71d8a1fdef621)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kernel/cpu/common.c
diff --cc arch/x86/kernel/cpu/common.c
index 49cb90f121df,970ee06dc8aa..000000000000
--- a/arch/x86/kernel/cpu/common.c
+++ b/arch/x86/kernel/cpu/common.c
@@@ -42,7 -47,8 +42,12 @@@
  #include <asm/pat.h>
  #include <asm/microcode.h>
  #include <asm/microcode_intel.h>
++<<<<<<< HEAD
 +#include <asm/kaiser.h>
++=======
+ #include <asm/intel-family.h>
+ #include <asm/cpu_device_id.h>
++>>>>>>> fec9434a12f3 (x86/pti: Do not enable PTI on CPUs which are not vulnerable to Meltdown)
  
  #ifdef CONFIG_X86_LOCAL_APIC
  #include <asm/uv/uv.h>
@@@ -878,29 -915,44 +918,38 @@@ static void __init early_identify_cpu(s
  	memset(&c->x86_capability, 0, sizeof c->x86_capability);
  	c->extended_cpuid_level = 0;
  
 -	/* cyrix could have cpuid enabled via c_identify()*/
 -	if (have_cpuid_p()) {
 -		cpu_detect(c);
 -		get_cpu_vendor(c);
 -		get_cpu_cap(c);
 -		setup_force_cpu_cap(X86_FEATURE_CPUID);
 -
 -		if (this_cpu->c_early_init)
 -			this_cpu->c_early_init(c);
 -
 -		c->cpu_index = 0;
 -		filter_cpuid_features(c, false);
 -
 -		if (this_cpu->c_bsp_init)
 -			this_cpu->c_bsp_init(c);
 -	} else {
 +	if (!have_cpuid_p())
  		identify_cpu_without_cpuid(c);
 -		setup_clear_cpu_cap(X86_FEATURE_CPUID);
 -	}
  
 -	setup_force_cpu_cap(X86_FEATURE_ALWAYS);
 +	/* cyrix could have cpuid enabled via c_identify()*/
 +	if (!have_cpuid_p())
 +		return;
 +
++<<<<<<< HEAD
 +	cpu_detect(c);
  
 +	get_cpu_vendor(c);
++=======
+ 	if (!x86_match_cpu(cpu_no_speculation)) {
+ 		if (cpu_vulnerable_to_meltdown(c))
+ 			setup_force_cpu_bug(X86_BUG_CPU_MELTDOWN);
+ 		setup_force_cpu_bug(X86_BUG_SPECTRE_V1);
+ 		setup_force_cpu_bug(X86_BUG_SPECTRE_V2);
+ 	}
++>>>>>>> fec9434a12f3 (x86/pti: Do not enable PTI on CPUs which are not vulnerable to Meltdown)
  
 -	fpu__init_system(c);
 +	get_cpu_cap(c);
  
 -#ifdef CONFIG_X86_32
 -	/*
 -	 * Regardless of whether PCID is enumerated, the SDM says
 -	 * that it can't be enabled in 32-bit mode.
 -	 */
 -	setup_clear_cpu_cap(X86_FEATURE_PCID);
 -#endif
 +	get_model_name(c); /* RHEL7: get default name for unsupported check */
 +
 +	if (this_cpu->c_early_init)
 +		this_cpu->c_early_init(c);
 +
 +	c->cpu_index = 0;
 +	filter_cpuid_features(c, false);
 +
 +	if (this_cpu->c_bsp_init)
 +		this_cpu->c_bsp_init(c);
  }
  
  void __init early_cpu_init(void)
* Unmerged path arch/x86/kernel/cpu/common.c
