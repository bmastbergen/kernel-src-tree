drm/nouveau/gr/gf100-: virtualise init_sked_hww_esr

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
commit-author Ben Skeggs <bskeggs@redhat.com>
commit 0a5b97304b9e2cd07c78a399c5395d5fb0118341
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/0a5b9730.failed

	Signed-off-by: Ben Skeggs <bskeggs@redhat.com>
(cherry picked from commit 0a5b97304b9e2cd07c78a399c5395d5fb0118341)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/gpu/drm/nouveau/nvkm/engine/gr/gf100.h
#	drivers/gpu/drm/nouveau/nvkm/engine/gr/gk104.c
#	drivers/gpu/drm/nouveau/nvkm/engine/gr/gk110.c
#	drivers/gpu/drm/nouveau/nvkm/engine/gr/gk110b.c
#	drivers/gpu/drm/nouveau/nvkm/engine/gr/gk208.c
#	drivers/gpu/drm/nouveau/nvkm/engine/gr/gm107.c
#	drivers/gpu/drm/nouveau/nvkm/engine/gr/gm200.c
#	drivers/gpu/drm/nouveau/nvkm/engine/gr/gp100.c
#	drivers/gpu/drm/nouveau/nvkm/engine/gr/gp102.c
#	drivers/gpu/drm/nouveau/nvkm/engine/gr/gp107.c
#	drivers/gpu/drm/nouveau/nvkm/engine/gr/gp10b.c
diff --cc drivers/gpu/drm/nouveau/nvkm/engine/gr/gf100.h
index a36e45a4a635,c292cf3bebb1..000000000000
--- a/drivers/gpu/drm/nouveau/nvkm/engine/gr/gf100.h
+++ b/drivers/gpu/drm/nouveau/nvkm/engine/gr/gf100.h
@@@ -122,10 -122,19 +122,19 @@@ struct gf100_gr_func 
  	void (*dtor)(struct gf100_gr *);
  	int (*init)(struct gf100_gr *);
  	void (*init_gpc_mmu)(struct gf100_gr *);
 -	void (*init_r405a14)(struct gf100_gr *);
 -	void (*init_bios)(struct gf100_gr *);
 -	void (*init_vsc_stream_master)(struct gf100_gr *);
 -	void (*init_zcull)(struct gf100_gr *);
 -	void (*init_num_active_ltcs)(struct gf100_gr *);
  	void (*init_rop_active_fbps)(struct gf100_gr *);
++<<<<<<< HEAD
++=======
+ 	void (*init_bios_2)(struct gf100_gr *);
+ 	void (*init_swdx_pes_mask)(struct gf100_gr *);
+ 	void (*init_fecs_exceptions)(struct gf100_gr *);
+ 	void (*init_ds_hww_esr_2)(struct gf100_gr *);
+ 	void (*init_40601c)(struct gf100_gr *);
+ 	void (*init_sked_hww_esr)(struct gf100_gr *);
++>>>>>>> 0a5b97304b9e (drm/nouveau/gr/gf100-: virtualise init_sked_hww_esr)
  	void (*init_ppc_exceptions)(struct gf100_gr *);
 +	void (*init_swdx_pes_mask)(struct gf100_gr *);
 +	void (*init_num_active_ltcs)(struct gf100_gr *);
  	void (*set_hww_esr_report_mask)(struct gf100_gr *);
  	const struct gf100_gr_pack *mmio;
  	struct {
@@@ -140,12 -149,22 +149,13 @@@
  	struct nvkm_sclass sclass[];
  };
  
 -int gf100_gr_rops(struct gf100_gr *);
  int gf100_gr_init(struct gf100_gr *);
 -void gf100_gr_init_vsc_stream_master(struct gf100_gr *);
 -void gf100_gr_init_zcull(struct gf100_gr *);
 -void gf100_gr_init_num_active_ltcs(struct gf100_gr *);
 -void gf100_gr_init_fecs_exceptions(struct gf100_gr *);
 -void gf100_gr_init_40601c(struct gf100_gr *);
 -
 -void gf117_gr_init_zcull(struct gf100_gr *);
 +int gf100_gr_rops(struct gf100_gr *);
  
  int gk104_gr_init(struct gf100_gr *);
 -void gk104_gr_init_vsc_stream_master(struct gf100_gr *);
  void gk104_gr_init_rop_active_fbps(struct gf100_gr *);
  void gk104_gr_init_ppc_exceptions(struct gf100_gr *);
+ void gk104_gr_init_sked_hww_esr(struct gf100_gr *);
  
  int gk20a_gr_init(struct gf100_gr *);
  
diff --cc drivers/gpu/drm/nouveau/nvkm/engine/gr/gk104.c
index 3ed06dea433e,6ba604edaf95..000000000000
--- a/drivers/gpu/drm/nouveau/nvkm/engine/gr/gk104.c
+++ b/drivers/gpu/drm/nouveau/nvkm/engine/gr/gk104.c
@@@ -179,6 -380,21 +179,24 @@@ gk104_gr_pack_mmio[] = 
   * PGRAPH engine/subdev functions
   ******************************************************************************/
  
++<<<<<<< HEAD
++=======
+ void
+ gk104_gr_init_sked_hww_esr(struct gf100_gr *gr)
+ {
+ 	nvkm_wr32(gr->base.engine.subdev.device, 0x407020, 0x40000000);
+ }
+ 
+ static void
+ gk104_gr_init_fecs_exceptions(struct gf100_gr *gr)
+ {
+ 	struct nvkm_device *device = gr->base.engine.subdev.device;
+ 	nvkm_wr32(device, 0x409ffc, 0x00000000);
+ 	nvkm_wr32(device, 0x409c14, 0x00003e3e);
+ 	nvkm_wr32(device, 0x409c24, 0x000f0001);
+ }
+ 
++>>>>>>> 0a5b97304b9e (drm/nouveau/gr/gf100-: virtualise init_sked_hww_esr)
  void
  gk104_gr_init_rop_active_fbps(struct gf100_gr *gr)
  {
@@@ -340,7 -527,13 +358,12 @@@ gk104_gr_gpccs_ucode = 
  static const struct gf100_gr_func
  gk104_gr = {
  	.init = gk104_gr_init,
 -	.init_gpc_mmu = gf100_gr_init_gpc_mmu,
 -	.init_vsc_stream_master = gk104_gr_init_vsc_stream_master,
 -	.init_zcull = gf117_gr_init_zcull,
 -	.init_num_active_ltcs = gf100_gr_init_num_active_ltcs,
  	.init_rop_active_fbps = gk104_gr_init_rop_active_fbps,
++<<<<<<< HEAD
++=======
+ 	.init_fecs_exceptions = gk104_gr_init_fecs_exceptions,
+ 	.init_sked_hww_esr = gk104_gr_init_sked_hww_esr,
++>>>>>>> 0a5b97304b9e (drm/nouveau/gr/gf100-: virtualise init_sked_hww_esr)
  	.init_ppc_exceptions = gk104_gr_init_ppc_exceptions,
  	.mmio = gk104_gr_pack_mmio,
  	.fecs.ucode = &gk104_gr_fecs_ucode,
diff --cc drivers/gpu/drm/nouveau/nvkm/engine/gr/gk110.c
index f31b171a4102,7a07d24cc227..000000000000
--- a/drivers/gpu/drm/nouveau/nvkm/engine/gr/gk110.c
+++ b/drivers/gpu/drm/nouveau/nvkm/engine/gr/gk110.c
@@@ -183,7 -337,13 +183,12 @@@ gk110_gr_gpccs_ucode = 
  static const struct gf100_gr_func
  gk110_gr = {
  	.init = gk104_gr_init,
 -	.init_gpc_mmu = gf100_gr_init_gpc_mmu,
 -	.init_vsc_stream_master = gk104_gr_init_vsc_stream_master,
 -	.init_zcull = gf117_gr_init_zcull,
 -	.init_num_active_ltcs = gf100_gr_init_num_active_ltcs,
  	.init_rop_active_fbps = gk104_gr_init_rop_active_fbps,
++<<<<<<< HEAD
++=======
+ 	.init_fecs_exceptions = gf100_gr_init_fecs_exceptions,
+ 	.init_sked_hww_esr = gk104_gr_init_sked_hww_esr,
++>>>>>>> 0a5b97304b9e (drm/nouveau/gr/gf100-: virtualise init_sked_hww_esr)
  	.init_ppc_exceptions = gk104_gr_init_ppc_exceptions,
  	.mmio = gk110_gr_pack_mmio,
  	.fecs.ucode = &gk110_gr_fecs_ucode,
diff --cc drivers/gpu/drm/nouveau/nvkm/engine/gr/gk110b.c
index d76dd178007f,1c9f59cde3d2..000000000000
--- a/drivers/gpu/drm/nouveau/nvkm/engine/gr/gk110b.c
+++ b/drivers/gpu/drm/nouveau/nvkm/engine/gr/gk110b.c
@@@ -103,7 -103,13 +103,12 @@@ gk110b_gr_pack_mmio[] = 
  static const struct gf100_gr_func
  gk110b_gr = {
  	.init = gk104_gr_init,
 -	.init_gpc_mmu = gf100_gr_init_gpc_mmu,
 -	.init_vsc_stream_master = gk104_gr_init_vsc_stream_master,
 -	.init_zcull = gf117_gr_init_zcull,
 -	.init_num_active_ltcs = gf100_gr_init_num_active_ltcs,
  	.init_rop_active_fbps = gk104_gr_init_rop_active_fbps,
++<<<<<<< HEAD
++=======
+ 	.init_fecs_exceptions = gf100_gr_init_fecs_exceptions,
+ 	.init_sked_hww_esr = gk104_gr_init_sked_hww_esr,
++>>>>>>> 0a5b97304b9e (drm/nouveau/gr/gf100-: virtualise init_sked_hww_esr)
  	.init_ppc_exceptions = gk104_gr_init_ppc_exceptions,
  	.mmio = gk110b_gr_pack_mmio,
  	.fecs.ucode = &gk110_gr_fecs_ucode,
diff --cc drivers/gpu/drm/nouveau/nvkm/engine/gr/gk208.c
index 14bbe6ed02a9,40c87242b54d..000000000000
--- a/drivers/gpu/drm/nouveau/nvkm/engine/gr/gk208.c
+++ b/drivers/gpu/drm/nouveau/nvkm/engine/gr/gk208.c
@@@ -162,7 -162,13 +162,12 @@@ gk208_gr_gpccs_ucode = 
  static const struct gf100_gr_func
  gk208_gr = {
  	.init = gk104_gr_init,
 -	.init_gpc_mmu = gf100_gr_init_gpc_mmu,
 -	.init_vsc_stream_master = gk104_gr_init_vsc_stream_master,
 -	.init_zcull = gf117_gr_init_zcull,
 -	.init_num_active_ltcs = gf100_gr_init_num_active_ltcs,
  	.init_rop_active_fbps = gk104_gr_init_rop_active_fbps,
++<<<<<<< HEAD
++=======
+ 	.init_fecs_exceptions = gf100_gr_init_fecs_exceptions,
+ 	.init_sked_hww_esr = gk104_gr_init_sked_hww_esr,
++>>>>>>> 0a5b97304b9e (drm/nouveau/gr/gf100-: virtualise init_sked_hww_esr)
  	.init_ppc_exceptions = gk104_gr_init_ppc_exceptions,
  	.mmio = gk208_gr_pack_mmio,
  	.fecs.ucode = &gk208_gr_fecs_ucode,
diff --cc drivers/gpu/drm/nouveau/nvkm/engine/gr/gm107.c
index 2c67fac576d1,3d180edbdcd7..000000000000
--- a/drivers/gpu/drm/nouveau/nvkm/engine/gr/gm107.c
+++ b/drivers/gpu/drm/nouveau/nvkm/engine/gr/gm107.c
@@@ -442,7 -448,15 +442,13 @@@ gm107_gr_gpccs_ucode = 
  static const struct gf100_gr_func
  gm107_gr = {
  	.init = gm107_gr_init,
 -	.init_gpc_mmu = gm107_gr_init_gpc_mmu,
 -	.init_bios = gm107_gr_init_bios,
 -	.init_vsc_stream_master = gk104_gr_init_vsc_stream_master,
 -	.init_zcull = gf117_gr_init_zcull,
 -	.init_num_active_ltcs = gf100_gr_init_num_active_ltcs,
  	.init_rop_active_fbps = gk104_gr_init_rop_active_fbps,
++<<<<<<< HEAD
++=======
+ 	.init_bios_2 = gm107_gr_init_bios_2,
+ 	.init_fecs_exceptions = gf100_gr_init_fecs_exceptions,
+ 	.init_sked_hww_esr = gk104_gr_init_sked_hww_esr,
++>>>>>>> 0a5b97304b9e (drm/nouveau/gr/gf100-: virtualise init_sked_hww_esr)
  	.init_ppc_exceptions = gk104_gr_init_ppc_exceptions,
  	.mmio = gm107_gr_pack_mmio,
  	.fecs.ucode = &gm107_gr_fecs_ucode,
diff --cc drivers/gpu/drm/nouveau/nvkm/engine/gr/gm200.c
index 6435f1257572,9436ab37aa9e..000000000000
--- a/drivers/gpu/drm/nouveau/nvkm/engine/gr/gm200.c
+++ b/drivers/gpu/drm/nouveau/nvkm/engine/gr/gm200.c
@@@ -210,7 -195,14 +210,13 @@@ static const struct gf100_gr_fun
  gm200_gr = {
  	.init = gm200_gr_init,
  	.init_gpc_mmu = gm200_gr_init_gpc_mmu,
 -	.init_bios = gm107_gr_init_bios,
 -	.init_vsc_stream_master = gk104_gr_init_vsc_stream_master,
 -	.init_zcull = gf117_gr_init_zcull,
 -	.init_num_active_ltcs = gm200_gr_init_num_active_ltcs,
  	.init_rop_active_fbps = gm200_gr_init_rop_active_fbps,
++<<<<<<< HEAD
++=======
+ 	.init_fecs_exceptions = gf100_gr_init_fecs_exceptions,
+ 	.init_ds_hww_esr_2 = gm200_gr_init_ds_hww_esr_2,
+ 	.init_sked_hww_esr = gk104_gr_init_sked_hww_esr,
++>>>>>>> 0a5b97304b9e (drm/nouveau/gr/gf100-: virtualise init_sked_hww_esr)
  	.init_ppc_exceptions = gk104_gr_init_ppc_exceptions,
  	.rops = gm200_gr_rops,
  	.ppc_nr = 2,
diff --cc drivers/gpu/drm/nouveau/nvkm/engine/gr/gp100.c
index 867a5f7cc5bc,72ea16ee842a..000000000000
--- a/drivers/gpu/drm/nouveau/nvkm/engine/gr/gp100.c
+++ b/drivers/gpu/drm/nouveau/nvkm/engine/gr/gp100.c
@@@ -160,9 -128,14 +160,15 @@@ static const struct gf100_gr_fun
  gp100_gr = {
  	.init = gp100_gr_init,
  	.init_gpc_mmu = gm200_gr_init_gpc_mmu,
 -	.init_vsc_stream_master = gk104_gr_init_vsc_stream_master,
 -	.init_zcull = gf117_gr_init_zcull,
 -	.init_num_active_ltcs = gm200_gr_init_num_active_ltcs,
  	.init_rop_active_fbps = gp100_gr_init_rop_active_fbps,
++<<<<<<< HEAD
++=======
+ 	.init_fecs_exceptions = gp100_gr_init_fecs_exceptions,
+ 	.init_ds_hww_esr_2 = gm200_gr_init_ds_hww_esr_2,
+ 	.init_sked_hww_esr = gk104_gr_init_sked_hww_esr,
++>>>>>>> 0a5b97304b9e (drm/nouveau/gr/gf100-: virtualise init_sked_hww_esr)
  	.init_ppc_exceptions = gk104_gr_init_ppc_exceptions,
 +	.init_num_active_ltcs = gp100_gr_init_num_active_ltcs,
  	.rops = gm200_gr_rops,
  	.ppc_nr = 2,
  	.grctx = &gp100_grctx,
diff --cc drivers/gpu/drm/nouveau/nvkm/engine/gr/gp102.c
index 61e3a0b08559,309815bef601..000000000000
--- a/drivers/gpu/drm/nouveau/nvkm/engine/gr/gp102.c
+++ b/drivers/gpu/drm/nouveau/nvkm/engine/gr/gp102.c
@@@ -44,10 -44,15 +44,17 @@@ static const struct gf100_gr_fun
  gp102_gr = {
  	.init = gp100_gr_init,
  	.init_gpc_mmu = gm200_gr_init_gpc_mmu,
 -	.init_vsc_stream_master = gk104_gr_init_vsc_stream_master,
 -	.init_zcull = gf117_gr_init_zcull,
 -	.init_num_active_ltcs = gm200_gr_init_num_active_ltcs,
  	.init_rop_active_fbps = gp100_gr_init_rop_active_fbps,
++<<<<<<< HEAD
++=======
+ 	.init_swdx_pes_mask = gp102_gr_init_swdx_pes_mask,
+ 	.init_fecs_exceptions = gp100_gr_init_fecs_exceptions,
+ 	.init_ds_hww_esr_2 = gm200_gr_init_ds_hww_esr_2,
+ 	.init_sked_hww_esr = gk104_gr_init_sked_hww_esr,
++>>>>>>> 0a5b97304b9e (drm/nouveau/gr/gf100-: virtualise init_sked_hww_esr)
  	.init_ppc_exceptions = gk104_gr_init_ppc_exceptions,
 +	.init_swdx_pes_mask = gp102_gr_init_swdx_pes_mask,
 +	.init_num_active_ltcs = gp100_gr_init_num_active_ltcs,
  	.rops = gm200_gr_rops,
  	.ppc_nr = 3,
  	.grctx = &gp102_grctx,
diff --cc drivers/gpu/drm/nouveau/nvkm/engine/gr/gp107.c
index f7272323f694,1ae9e7d991f9..000000000000
--- a/drivers/gpu/drm/nouveau/nvkm/engine/gr/gp107.c
+++ b/drivers/gpu/drm/nouveau/nvkm/engine/gr/gp107.c
@@@ -30,10 -30,15 +30,17 @@@ static const struct gf100_gr_fun
  gp107_gr = {
  	.init = gp100_gr_init,
  	.init_gpc_mmu = gm200_gr_init_gpc_mmu,
 -	.init_vsc_stream_master = gk104_gr_init_vsc_stream_master,
 -	.init_zcull = gf117_gr_init_zcull,
 -	.init_num_active_ltcs = gm200_gr_init_num_active_ltcs,
  	.init_rop_active_fbps = gp100_gr_init_rop_active_fbps,
++<<<<<<< HEAD
++=======
+ 	.init_swdx_pes_mask = gp102_gr_init_swdx_pes_mask,
+ 	.init_fecs_exceptions = gp100_gr_init_fecs_exceptions,
+ 	.init_ds_hww_esr_2 = gm200_gr_init_ds_hww_esr_2,
+ 	.init_sked_hww_esr = gk104_gr_init_sked_hww_esr,
++>>>>>>> 0a5b97304b9e (drm/nouveau/gr/gf100-: virtualise init_sked_hww_esr)
  	.init_ppc_exceptions = gk104_gr_init_ppc_exceptions,
 +	.init_swdx_pes_mask = gp102_gr_init_swdx_pes_mask,
 +	.init_num_active_ltcs = gp100_gr_init_num_active_ltcs,
  	.rops = gm200_gr_rops,
  	.ppc_nr = 1,
  	.grctx = &gp107_grctx,
diff --cc drivers/gpu/drm/nouveau/nvkm/engine/gr/gp10b.c
index 5f3d161a0842,68e212823063..000000000000
--- a/drivers/gpu/drm/nouveau/nvkm/engine/gr/gp10b.c
+++ b/drivers/gpu/drm/nouveau/nvkm/engine/gr/gp10b.c
@@@ -37,9 -29,14 +37,15 @@@ static const struct gf100_gr_fun
  gp10b_gr = {
  	.init = gp100_gr_init,
  	.init_gpc_mmu = gm200_gr_init_gpc_mmu,
 -	.init_vsc_stream_master = gk104_gr_init_vsc_stream_master,
 -	.init_zcull = gf117_gr_init_zcull,
 -	.init_num_active_ltcs = gf100_gr_init_num_active_ltcs,
  	.init_rop_active_fbps = gp100_gr_init_rop_active_fbps,
++<<<<<<< HEAD
++=======
+ 	.init_fecs_exceptions = gp100_gr_init_fecs_exceptions,
+ 	.init_ds_hww_esr_2 = gm200_gr_init_ds_hww_esr_2,
+ 	.init_sked_hww_esr = gk104_gr_init_sked_hww_esr,
++>>>>>>> 0a5b97304b9e (drm/nouveau/gr/gf100-: virtualise init_sked_hww_esr)
  	.init_ppc_exceptions = gk104_gr_init_ppc_exceptions,
 +	.init_num_active_ltcs = gp10b_gr_init_num_active_ltcs,
  	.rops = gm200_gr_rops,
  	.ppc_nr = 1,
  	.grctx = &gp102_grctx,
diff --git a/drivers/gpu/drm/nouveau/nvkm/engine/gr/gf100.c b/drivers/gpu/drm/nouveau/nvkm/engine/gr/gf100.c
index 38a5ff7dd3aa..0ac04c942501 100644
--- a/drivers/gpu/drm/nouveau/nvkm/engine/gr/gf100.c
+++ b/drivers/gpu/drm/nouveau/nvkm/engine/gr/gf100.c
@@ -1973,6 +1973,10 @@ gf100_gr_init(struct gf100_gr *gr)
 	nvkm_wr32(device, 0x40601c, 0xc0000000);
 	nvkm_wr32(device, 0x404490, 0xc0000000);
 	nvkm_wr32(device, 0x406018, 0xc0000000);
+
+	if (gr->func->init_sked_hww_esr)
+		gr->func->init_sked_hww_esr(gr);
+
 	nvkm_wr32(device, 0x405840, 0xc0000000);
 	nvkm_wr32(device, 0x405844, 0x00ffffff);
 	nvkm_mask(device, 0x419cc0, 0x00000008, 0x00000008);
* Unmerged path drivers/gpu/drm/nouveau/nvkm/engine/gr/gf100.h
* Unmerged path drivers/gpu/drm/nouveau/nvkm/engine/gr/gk104.c
* Unmerged path drivers/gpu/drm/nouveau/nvkm/engine/gr/gk110.c
* Unmerged path drivers/gpu/drm/nouveau/nvkm/engine/gr/gk110b.c
* Unmerged path drivers/gpu/drm/nouveau/nvkm/engine/gr/gk208.c
* Unmerged path drivers/gpu/drm/nouveau/nvkm/engine/gr/gm107.c
* Unmerged path drivers/gpu/drm/nouveau/nvkm/engine/gr/gm200.c
* Unmerged path drivers/gpu/drm/nouveau/nvkm/engine/gr/gp100.c
* Unmerged path drivers/gpu/drm/nouveau/nvkm/engine/gr/gp102.c
* Unmerged path drivers/gpu/drm/nouveau/nvkm/engine/gr/gp107.c
* Unmerged path drivers/gpu/drm/nouveau/nvkm/engine/gr/gp10b.c
