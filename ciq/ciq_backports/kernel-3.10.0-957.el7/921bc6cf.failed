powerpc/rfi-flush: Call setup_rfi_flush() after LPM migration

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
Rebuild_CHGLOG: - [powerpc] rfi-flush: Call setup_rfi_flush() after LPM migration (Mauricio Oliveira) [1561785]
Rebuild_FUZZ: 92.98%
commit-author Michael Ellerman <mpe@ellerman.id.au>
commit 921bc6cf807ceb2ab8005319cf39f33494d6b100
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/921bc6cf.failed

We might have migrated to a machine that uses a different flush type,
or doesn't need flushing at all.

	Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
	Signed-off-by: Mauricio Faria de Oliveira <mauricfo@linux.vnet.ibm.com>
	Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
(cherry picked from commit 921bc6cf807ceb2ab8005319cf39f33494d6b100)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/powerpc/platforms/pseries/setup.c
diff --cc arch/powerpc/platforms/pseries/setup.c
index 16f5e74be2ee,f34f9081ec60..000000000000
--- a/arch/powerpc/platforms/pseries/setup.c
+++ b/arch/powerpc/platforms/pseries/setup.c
@@@ -501,32 -456,15 +501,36 @@@ static void __init find_and_init_phbs(v
  	 * PCI_PROBE_ONLY and PCI_REASSIGN_ALL_BUS can be set via properties
  	 * in chosen.
  	 */
 -	of_pci_check_probe_only();
 +	if (of_chosen) {
 +		const int *prop;
 +
 +		prop = of_get_property(of_chosen,
 +				"linux,pci-probe-only", NULL);
 +		if (prop) {
 +			if (*prop)
 +				pci_add_flags(PCI_PROBE_ONLY);
 +			else
 +				pci_clear_flags(PCI_PROBE_ONLY);
 +		}
 +
 +#ifdef CONFIG_PPC32 /* Will be made generic soon */
 +		prop = of_get_property(of_chosen,
 +				"linux,pci-assign-all-buses", NULL);
 +		if (prop && *prop)
 +			pci_add_flags(PCI_REASSIGN_ALL_BUS);
 +#endif /* CONFIG_PPC32 */
 +	}
  }
  
++<<<<<<< HEAD
 +static void pSeries_setup_rfi_flush(void)
++=======
+ void pseries_setup_rfi_flush(void)
++>>>>>>> 921bc6cf807c (powerpc/rfi-flush: Call setup_rfi_flush() after LPM migration)
  {
 -	struct h_cpu_char_result result;
 +	unsigned long character, behaviour, rc;
  	enum l1d_flush_type types;
  	bool enable;
 -	long rc;
  
  	/* Enable by default */
  	enable = true;
diff --git a/arch/powerpc/platforms/pseries/mobility.c b/arch/powerpc/platforms/pseries/mobility.c
index cb8be37ab91f..4aae6326aebf 100644
--- a/arch/powerpc/platforms/pseries/mobility.c
+++ b/arch/powerpc/platforms/pseries/mobility.c
@@ -311,6 +311,9 @@ void post_mobility_fixup(void)
 		printk(KERN_ERR "Post-mobility device tree update "
 			"failed: %d\n", rc);
 
+	/* Possibly switch to a new RFI flush type */
+	pseries_setup_rfi_flush();
+
 	return;
 }
 
diff --git a/arch/powerpc/platforms/pseries/pseries.h b/arch/powerpc/platforms/pseries/pseries.h
index a8678d0c3fa3..b595e25c32d6 100644
--- a/arch/powerpc/platforms/pseries/pseries.h
+++ b/arch/powerpc/platforms/pseries/pseries.h
@@ -85,4 +85,6 @@ unsigned long pseries_memory_block_size(void);
 
 int dlpar_workqueue_init(void);
 
+void pseries_setup_rfi_flush(void);
+
 #endif /* _PSERIES_PSERIES_H */
* Unmerged path arch/powerpc/platforms/pseries/setup.c
