xfs: fix multi-AG deadlock in xfs_bunmapi

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
commit-author Christoph Hellwig <hch@lst.de>
commit 5b094d6dac0451ad89b1dc088395c7b399b7e9e8
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/5b094d6d.failed

Just like in the allocator we must avoid touching multiple AGs out of
order when freeing blocks, as freeing still locks the AGF and can cause
the same AB-BA deadlocks as in the allocation path.

	Signed-off-by: Christoph Hellwig <hch@lst.de>
	Reported-by: Nikolay Borisov <n.borisov.lkml@gmail.com>
	Reviewed-by: Darrick J. Wong <darrick.wong@oracle.com>
	Signed-off-by: Darrick J. Wong <darrick.wong@oracle.com>
(cherry picked from commit 5b094d6dac0451ad89b1dc088395c7b399b7e9e8)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/xfs/libxfs/xfs_bmap.c
diff --cc fs/xfs/libxfs/xfs_bmap.c
index 738c9b2d2ddc,c09c16b1ad3b..000000000000
--- a/fs/xfs/libxfs/xfs_bmap.c
+++ b/fs/xfs/libxfs/xfs_bmap.c
@@@ -5071,6 -5434,8 +5071,11 @@@ __xfs_bunmapi
  	int			whichfork;	/* data or attribute fork */
  	xfs_fsblock_t		sum;
  	xfs_filblks_t		len = *rlen;	/* length to unmap in file */
++<<<<<<< HEAD
++=======
+ 	xfs_fileoff_t		max_len;
+ 	xfs_agnumber_t		prev_agno = NULLAGNUMBER, agno;
++>>>>>>> 5b094d6dac04 (xfs: fix multi-AG deadlock in xfs_bunmapi)
  
  	trace_xfs_bunmap(ip, bno, len, flags, _RET_IP_);
  
* Unmerged path fs/xfs/libxfs/xfs_bmap.c
