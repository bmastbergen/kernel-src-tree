drm/nouveau/disp/nv50-: add channel interfaces to determine the user area

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
commit-author Ben Skeggs <bskeggs@redhat.com>
commit 4a8621a24a8f68ecba6e59dccad2b252fa90ba59
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/4a8621a2.failed

This will be required to support Volta.

	Signed-off-by: Ben Skeggs <bskeggs@redhat.com>
(cherry picked from commit 4a8621a24a8f68ecba6e59dccad2b252fa90ba59)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/gpu/drm/nouveau/nvkm/engine/disp/channv50.c
#	drivers/gpu/drm/nouveau/nvkm/engine/disp/channv50.h
diff --cc drivers/gpu/drm/nouveau/nvkm/engine/disp/channv50.c
index badbd62b90c7,8e79aa5f52e6..000000000000
--- a/drivers/gpu/drm/nouveau/nvkm/engine/disp/channv50.c
+++ b/drivers/gpu/drm/nouveau/nvkm/engine/disp/channv50.c
@@@ -191,14 -199,14 +198,21 @@@ nv50_disp_chan_ntfy(struct nvkm_object 
  }
  
  static int
 -nv50_disp_chan_map(struct nvkm_object *object, void *argv, u32 argc,
 -		   enum nvkm_object_map *type, u64 *addr, u64 *size)
 +nv50_disp_chan_map(struct nvkm_object *object, u64 *addr, u32 *size)
  {
  	struct nv50_disp_chan *chan = nv50_disp_chan(object);
++<<<<<<< HEAD
 +	struct nv50_disp *disp = chan->disp;
 +	struct nvkm_device *device = disp->base.engine.subdev.device;
 +	*addr = device->func->resource_addr(device, 0) +
 +		0x640000 + (chan->chid.user * 0x1000);
 +	*size = 0x001000;
++=======
+ 	struct nvkm_device *device = chan->disp->base.engine.subdev.device;
+ 	const u64 base = device->func->resource_addr(device, 0);
+ 	*type = NVKM_OBJECT_MAP_IO;
+ 	*addr = base + chan->func->user(chan, size);
++>>>>>>> 4a8621a24a8f (drm/nouveau/disp/nv50-: add channel interfaces to determine the user area)
  	return 0;
  }
  
diff --cc drivers/gpu/drm/nouveau/nvkm/engine/disp/channv50.h
index 57ef0de1c7e7,75ae181da0e8..000000000000
--- a/drivers/gpu/drm/nouveau/nvkm/engine/disp/channv50.h
+++ b/drivers/gpu/drm/nouveau/nvkm/engine/disp/channv50.h
@@@ -20,33 -21,37 +20,39 @@@ struct nv50_disp_chan 
  };
  
  struct nv50_disp_chan_func {
 +	void *(*dtor)(struct nv50_disp_chan *);
  	int (*init)(struct nv50_disp_chan *);
  	void (*fini)(struct nv50_disp_chan *);
++<<<<<<< HEAD
 +	int (*child_get)(struct nv50_disp_chan *, int index,
 +			 struct nvkm_oclass *);
 +	int (*child_new)(struct nv50_disp_chan *, const struct nvkm_oclass *,
 +			 void *data, u32 size, struct nvkm_object **);
++=======
+ 	u64 (*user)(struct nv50_disp_chan *, u64 *size);
+ 	int (*bind)(struct nv50_disp_chan *, struct nvkm_object *, u32 handle);
++>>>>>>> 4a8621a24a8f (drm/nouveau/disp/nv50-: add channel interfaces to determine the user area)
  };
  
 -int nv50_disp_chan_new_(const struct nv50_disp_chan_func *,
 +int nv50_disp_chan_ctor(const struct nv50_disp_chan_func *,
  			const struct nv50_disp_chan_mthd *,
  			struct nv50_disp *, int ctrl, int user, int head,
 -			const struct nvkm_oclass *, struct nvkm_object **);
 -int nv50_disp_dmac_new_(const struct nv50_disp_chan_func *,
 +			const struct nvkm_oclass *, struct nv50_disp_chan *);
 +int nv50_disp_chan_new_(const struct nv50_disp_chan_func *,
  			const struct nv50_disp_chan_mthd *,
 -			struct nv50_disp *, int chid, int head, u64 push,
 +			struct nv50_disp *, int ctrl, int user, int head,
  			const struct nvkm_oclass *, struct nvkm_object **);
  
+ u64 nv50_disp_chan_user(struct nv50_disp_chan *, u64 *);
  extern const struct nv50_disp_chan_func nv50_disp_pioc_func;
 -extern const struct nv50_disp_chan_func nv50_disp_dmac_func;
 -int nv50_disp_dmac_bind(struct nv50_disp_chan *, struct nvkm_object *, u32);
 -extern const struct nv50_disp_chan_func nv50_disp_core_func;
 -
  extern const struct nv50_disp_chan_func gf119_disp_pioc_func;
 -extern const struct nv50_disp_chan_func gf119_disp_dmac_func;
 -void gf119_disp_dmac_fini(struct nv50_disp_chan *);
 -int gf119_disp_dmac_bind(struct nv50_disp_chan *, struct nvkm_object *, u32);
 -extern const struct nv50_disp_chan_func gf119_disp_core_func;
 -void gf119_disp_core_fini(struct nv50_disp_chan *);
  
 -extern const struct nv50_disp_chan_func gp102_disp_dmac_func;
 +extern const struct nvkm_event_func nv50_disp_chan_uevent;
 +int  nv50_disp_chan_uevent_ctor(struct nvkm_object *, void *, u32,
 +				struct nvkm_notify *);
 +void nv50_disp_chan_uevent_send(struct nv50_disp *, int);
 +
 +extern const struct nvkm_event_func gf119_disp_chan_uevent;
  
  int nv50_disp_curs_new_(const struct nv50_disp_chan_func *,
  			struct nv50_disp *, int ctrl, int user,
* Unmerged path drivers/gpu/drm/nouveau/nvkm/engine/disp/channv50.c
* Unmerged path drivers/gpu/drm/nouveau/nvkm/engine/disp/channv50.h
diff --git a/drivers/gpu/drm/nouveau/nvkm/engine/disp/coregf119.c b/drivers/gpu/drm/nouveau/nvkm/engine/disp/coregf119.c
index 9e48cc3625b5..ec058b8101fc 100644
--- a/drivers/gpu/drm/nouveau/nvkm/engine/disp/coregf119.c
+++ b/drivers/gpu/drm/nouveau/nvkm/engine/disp/coregf119.c
@@ -224,6 +224,7 @@ const struct nv50_disp_dmac_func
 gf119_disp_core_func = {
 	.init = gf119_disp_core_init,
 	.fini = gf119_disp_core_fini,
+	.user = nv50_disp_chan_user,
 	.bind = gf119_disp_dmac_bind,
 };
 
diff --git a/drivers/gpu/drm/nouveau/nvkm/engine/disp/coregp102.c b/drivers/gpu/drm/nouveau/nvkm/engine/disp/coregp102.c
index 3ec353e90b3e..95a34c9bc4bb 100644
--- a/drivers/gpu/drm/nouveau/nvkm/engine/disp/coregp102.c
+++ b/drivers/gpu/drm/nouveau/nvkm/engine/disp/coregp102.c
@@ -60,6 +60,7 @@ static const struct nv50_disp_dmac_func
 gp102_disp_core_func = {
 	.init = gp102_disp_core_init,
 	.fini = gf119_disp_core_fini,
+	.user = nv50_disp_chan_user,
 	.bind = gf119_disp_dmac_bind,
 };
 
diff --git a/drivers/gpu/drm/nouveau/nvkm/engine/disp/corenv50.c b/drivers/gpu/drm/nouveau/nvkm/engine/disp/corenv50.c
index 8cdcf5b590e7..ce3fb09e7205 100644
--- a/drivers/gpu/drm/nouveau/nvkm/engine/disp/corenv50.c
+++ b/drivers/gpu/drm/nouveau/nvkm/engine/disp/corenv50.c
@@ -226,6 +226,7 @@ const struct nv50_disp_dmac_func
 nv50_disp_core_func = {
 	.init = nv50_disp_core_init,
 	.fini = nv50_disp_core_fini,
+	.user = nv50_disp_chan_user,
 	.bind = nv50_disp_dmac_bind,
 };
 
diff --git a/drivers/gpu/drm/nouveau/nvkm/engine/disp/dmacgf119.c b/drivers/gpu/drm/nouveau/nvkm/engine/disp/dmacgf119.c
index b73bcc38a259..4678cbd61c7c 100644
--- a/drivers/gpu/drm/nouveau/nvkm/engine/disp/dmacgf119.c
+++ b/drivers/gpu/drm/nouveau/nvkm/engine/disp/dmacgf119.c
@@ -98,5 +98,6 @@ const struct nv50_disp_dmac_func
 gf119_disp_dmac_func = {
 	.init = gf119_disp_dmac_init,
 	.fini = gf119_disp_dmac_fini,
+	.user = nv50_disp_chan_user,
 	.bind = gf119_disp_dmac_bind,
 };
diff --git a/drivers/gpu/drm/nouveau/nvkm/engine/disp/dmacgp102.c b/drivers/gpu/drm/nouveau/nvkm/engine/disp/dmacgp102.c
index 62e9b8430791..401cbe542caf 100644
--- a/drivers/gpu/drm/nouveau/nvkm/engine/disp/dmacgp102.c
+++ b/drivers/gpu/drm/nouveau/nvkm/engine/disp/dmacgp102.c
@@ -63,5 +63,6 @@ const struct nv50_disp_dmac_func
 gp102_disp_dmac_func = {
 	.init = gp102_disp_dmac_init,
 	.fini = gf119_disp_dmac_fini,
+	.user = nv50_disp_chan_user,
 	.bind = gf119_disp_dmac_bind,
 };
diff --git a/drivers/gpu/drm/nouveau/nvkm/engine/disp/dmacnv50.c b/drivers/gpu/drm/nouveau/nvkm/engine/disp/dmacnv50.c
index d081947d0689..66732701c362 100644
--- a/drivers/gpu/drm/nouveau/nvkm/engine/disp/dmacnv50.c
+++ b/drivers/gpu/drm/nouveau/nvkm/engine/disp/dmacnv50.c
@@ -244,5 +244,6 @@ const struct nv50_disp_dmac_func
 nv50_disp_dmac_func = {
 	.init = nv50_disp_dmac_init,
 	.fini = nv50_disp_dmac_fini,
+	.user = nv50_disp_chan_user,
 	.bind = nv50_disp_dmac_bind,
 };
diff --git a/drivers/gpu/drm/nouveau/nvkm/engine/disp/piocgf119.c b/drivers/gpu/drm/nouveau/nvkm/engine/disp/piocgf119.c
index 7b1e9bf75abd..5970e40f4d69 100644
--- a/drivers/gpu/drm/nouveau/nvkm/engine/disp/piocgf119.c
+++ b/drivers/gpu/drm/nouveau/nvkm/engine/disp/piocgf119.c
@@ -80,4 +80,5 @@ const struct nv50_disp_chan_func
 gf119_disp_pioc_func = {
 	.init = gf119_disp_pioc_init,
 	.fini = gf119_disp_pioc_fini,
+	.user = nv50_disp_chan_user,
 };
diff --git a/drivers/gpu/drm/nouveau/nvkm/engine/disp/piocnv50.c b/drivers/gpu/drm/nouveau/nvkm/engine/disp/piocnv50.c
index 60c20123d84f..0a76bda4ef2a 100644
--- a/drivers/gpu/drm/nouveau/nvkm/engine/disp/piocnv50.c
+++ b/drivers/gpu/drm/nouveau/nvkm/engine/disp/piocnv50.c
@@ -82,4 +82,5 @@ const struct nv50_disp_chan_func
 nv50_disp_pioc_func = {
 	.init = nv50_disp_pioc_init,
 	.fini = nv50_disp_pioc_fini,
+	.user = nv50_disp_chan_user,
 };
