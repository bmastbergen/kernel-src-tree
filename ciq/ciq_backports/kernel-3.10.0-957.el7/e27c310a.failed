ptrace,x86: Make user_64bit_mode() available to 32-bit builds

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
Rebuild_CHGLOG: - [x86] ptrace, x86: Make user_64bit_mode() available to 32-bit builds (Gopal Tiwari) [1456572]
Rebuild_FUZZ: 99.19%
commit-author Ricardo Neri <ricardo.neri-calderon@linux.intel.com>
commit e27c310af5c05cf876d9cad006928076c27f54d4
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/e27c310a.failed

In its current form, user_64bit_mode() can only be used when CONFIG_X86_64
is selected. This implies that code built with CONFIG_X86_64=n cannot use
it. If a piece of code needs to be built for both CONFIG_X86_64=y and
CONFIG_X86_64=n and wants to use this function, it needs to wrap it in
an #ifdef/#endif; potentially, in multiple places.

This can be easily avoided with a single #ifdef/#endif pair within
user_64bit_mode() itself.

	Suggested-by: Borislav Petkov <bp@suse.de>
	Signed-off-by: Ricardo Neri <ricardo.neri-calderon@linux.intel.com>
	Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
	Reviewed-by: Borislav Petkov <bp@suse.de>
	Cc: "Michael S. Tsirkin" <mst@redhat.com>
	Cc: Peter Zijlstra <peterz@infradead.org>
	Cc: Dave Hansen <dave.hansen@linux.intel.com>
	Cc: ricardo.neri@intel.com
	Cc: Adrian Hunter <adrian.hunter@intel.com>
	Cc: Paul Gortmaker <paul.gortmaker@windriver.com>
	Cc: Huang Rui <ray.huang@amd.com>
	Cc: Qiaowei Ren <qiaowei.ren@intel.com>
	Cc: Shuah Khan <shuah@kernel.org>
	Cc: Kees Cook <keescook@chromium.org>
	Cc: Jonathan Corbet <corbet@lwn.net>
	Cc: Jiri Slaby <jslaby@suse.cz>
	Cc: Dmitry Vyukov <dvyukov@google.com>
	Cc: "Ravi V. Shankar" <ravi.v.shankar@intel.com>
	Cc: Chris Metcalf <cmetcalf@mellanox.com>
	Cc: Brian Gerst <brgerst@gmail.com>
	Cc: Arnaldo Carvalho de Melo <acme@redhat.com>
	Cc: Andy Lutomirski <luto@kernel.org>
	Cc: Colin Ian King <colin.king@canonical.com>
	Cc: Chen Yucong <slaoub@gmail.com>
	Cc: Adam Buchbinder <adam.buchbinder@gmail.com>
	Cc: Vlastimil Babka <vbabka@suse.cz>
	Cc: Lorenzo Stoakes <lstoakes@gmail.com>
	Cc: Masami Hiramatsu <mhiramat@kernel.org>
	Cc: Paolo Bonzini <pbonzini@redhat.com>
	Cc: Andrew Morton <akpm@linux-foundation.org>
	Cc: Thomas Garnier <thgarnie@google.com>
Link: https://lkml.kernel.org/r/1509135945-13762-4-git-send-email-ricardo.neri-calderon@linux.intel.com

(cherry picked from commit e27c310af5c05cf876d9cad006928076c27f54d4)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/include/asm/ptrace.h
diff --cc arch/x86/include/asm/ptrace.h
index 6205f0c434db,e2afbf689309..000000000000
--- a/arch/x86/include/asm/ptrace.h
+++ b/arch/x86/include/asm/ptrace.h
@@@ -131,14 -148,14 +131,23 @@@ static inline bool user_64bit_mode(stru
  	/* Headers are too twisted for this to go in paravirt.h. */
  	return regs->cs == __USER_CS || regs->cs == pv_info.extra_user_64bit_cs;
  #endif
+ #else /* !CONFIG_X86_64 */
+ 	return false;
+ #endif
  }
  
++<<<<<<< HEAD
 +#define current_user_stack_pointer()	this_cpu_read(old_rsp)
 +/* ia32 vs. x32 difference */
 +#define compat_user_stack_pointer()	\
 +	(test_thread_flag(TIF_IA32) 	\
 +	 ? current_pt_regs()->sp 	\
 +	 : this_cpu_read(old_rsp))
++=======
+ #ifdef CONFIG_X86_64
+ #define current_user_stack_pointer()	current_pt_regs()->sp
+ #define compat_user_stack_pointer()	current_pt_regs()->sp
++>>>>>>> e27c310af5c0 (ptrace,x86: Make user_64bit_mode() available to 32-bit builds)
  #endif
  
  #ifdef CONFIG_X86_32
* Unmerged path arch/x86/include/asm/ptrace.h
