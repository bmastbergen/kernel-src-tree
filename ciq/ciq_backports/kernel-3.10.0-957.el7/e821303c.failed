iw_cxgb4: Use dsgl by default

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
commit-author Ganesh Goudar <ganeshgr@chelsio.com>
commit e821303c428eedcc20746224d590b11c7000a7e5
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/e821303c.failed

Enable the use of dsgl by default and determine whether dsgl is
supported from lld info.

	Signed-off-by: Steve Wise <swise@opengridcomputing.com>
	Signed-off-by: Bharat Potnuri <bharat@chelsio.com>
	Signed-off-by: Ganesh Goudar <ganeshgr@chelsio.com>
	Signed-off-by: Doug Ledford <dledford@redhat.com>
(cherry picked from commit e821303c428eedcc20746224d590b11c7000a7e5)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/hw/cxgb4/mem.c
diff --cc drivers/infiniband/hw/cxgb4/mem.c
index adf07f8eb6e2,19dc548e1b73..000000000000
--- a/drivers/infiniband/hw/cxgb4/mem.c
+++ b/drivers/infiniband/hw/cxgb4/mem.c
@@@ -233,33 -229,23 +233,51 @@@ out
   * If data is NULL, clear len byte of memory to zero.
   */
  static int write_adapter_mem(struct c4iw_rdev *rdev, u32 addr, u32 len,
 -			     void *data, struct sk_buff *skb)
 +			     void *data, struct sk_buff *skb,
 +			     struct c4iw_wr_wait *wr_waitp)
  {
++<<<<<<< HEAD
 +	int ret;
 +
 +	if (!is_t5(rdev->lldi.adapter_type) || !use_dsgl) {
 +		ret = _c4iw_write_mem_inline(rdev, addr, len, data, skb,
 +					      wr_waitp);
 +		goto out;
 +	}
 +
 +	if (len <= inline_threshold) {
 +		ret = _c4iw_write_mem_inline(rdev, addr, len, data, skb,
 +					      wr_waitp);
 +		goto out;
 +	}
 +
 +	ret = _c4iw_write_mem_dma(rdev, addr, len, data, skb, wr_waitp);
 +	if (ret) {
 +		pr_warn_ratelimited("%s: dma map failure (non fatal)\n",
 +				    pci_name(rdev->lldi.pdev));
 +		ret = _c4iw_write_mem_inline(rdev, addr, len, data, skb,
 +					      wr_waitp);
 +	}
 +out:
 +	return ret;
 +
++=======
+ 	if (rdev->lldi.ulptx_memwrite_dsgl && use_dsgl) {
+ 		if (len > inline_threshold) {
+ 			if (_c4iw_write_mem_dma(rdev, addr, len, data, skb)) {
+ 				pr_warn_ratelimited("%s: dma map failure (non fatal)\n",
+ 						    pci_name(rdev->lldi.pdev));
+ 				return _c4iw_write_mem_inline(rdev, addr, len,
+ 							      data, skb);
+ 			} else {
+ 				return 0;
+ 			}
+ 		} else
+ 			return _c4iw_write_mem_inline(rdev, addr,
+ 						      len, data, skb);
+ 	} else
+ 		return _c4iw_write_mem_inline(rdev, addr, len, data, skb);
++>>>>>>> e821303c428e (iw_cxgb4: Use dsgl by default)
  }
  
  /*
* Unmerged path drivers/infiniband/hw/cxgb4/mem.c
