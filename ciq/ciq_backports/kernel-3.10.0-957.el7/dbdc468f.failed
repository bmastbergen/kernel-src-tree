cpupower : Fix cpupower working when cpu0 is offline

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
Rebuild_CHGLOG: - [tools] cpupower: Fix cpupower working when cpu0 is offline (Gustavo Duarte) [1545301]
Rebuild_FUZZ: 99.03%
commit-author Abhishek Goel <huntbag@linux.vnet.ibm.com>
commit dbdc468f35ee827cab2753caa1c660bdb832243a
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/dbdc468f.failed

cpuidle_monitor used to assume that cpu0 is always online which is not
a valid assumption on POWER machines. This patch fixes this by getting
the cpu on which the current thread is running, instead of always using
cpu0 for monitoring which may not be online.

	Signed-off-by: Abhishek Goel <huntbag@linux.vnet.ibm.com>
	Signed-off-by: Shuah Khan <shuahkh@osg.samsung.com>
(cherry picked from commit dbdc468f35ee827cab2753caa1c660bdb832243a)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/power/cpupower/utils/idle_monitor/cpuidle_sysfs.c
diff --cc tools/power/cpupower/utils/idle_monitor/cpuidle_sysfs.c
index bcd22a1a3970,5b3205f16217..000000000000
--- a/tools/power/cpupower/utils/idle_monitor/cpuidle_sysfs.c
+++ b/tools/power/cpupower/utils/idle_monitor/cpuidle_sysfs.c
@@@ -130,15 -130,18 +130,26 @@@ static struct cpuidle_monitor *cpuidle_
  {
  	int num;
  	char *tmp;
+ 	int this_cpu;
+ 
+ 	this_cpu = sched_getcpu();
  
  	/* Assume idle state count is the same for all CPUs */
++<<<<<<< HEAD
 +	cpuidle_sysfs_monitor.hw_states_num = sysfs_get_idlestate_count(0);
++=======
+ 	cpuidle_sysfs_monitor.hw_states_num = cpuidle_state_count(this_cpu);
++>>>>>>> dbdc468f35ee (cpupower : Fix cpupower working when cpu0 is offline)
  
  	if (cpuidle_sysfs_monitor.hw_states_num <= 0)
  		return NULL;
  
  	for (num = 0; num < cpuidle_sysfs_monitor.hw_states_num; num++) {
++<<<<<<< HEAD
 +		tmp = sysfs_get_idlestate_name(0, num);
++=======
+ 		tmp = cpuidle_state_name(this_cpu, num);
++>>>>>>> dbdc468f35ee (cpupower : Fix cpupower working when cpu0 is offline)
  		if (tmp == NULL)
  			continue;
  
@@@ -146,7 -149,7 +157,11 @@@
  		strncpy(cpuidle_cstates[num].name, tmp, CSTATE_NAME_LEN - 1);
  		free(tmp);
  
++<<<<<<< HEAD
 +		tmp = sysfs_get_idlestate_desc(0, num);
++=======
+ 		tmp = cpuidle_state_desc(this_cpu, num);
++>>>>>>> dbdc468f35ee (cpupower : Fix cpupower working when cpu0 is offline)
  		if (tmp == NULL)
  			continue;
  		strncpy(cpuidle_cstates[num].desc, tmp,	CSTATE_DESC_LEN - 1);
* Unmerged path tools/power/cpupower/utils/idle_monitor/cpuidle_sysfs.c
