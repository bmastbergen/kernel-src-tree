drm/nouveau/gem: attach fences to VMAs to track GPU usage

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
commit-author Ben Skeggs <bskeggs@redhat.com>
commit 0db912af8f5ad4fa4dc08a9c8e411a10953c5403
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/0db912af.failed

An upcoming patch will use these to fix issues related to the deferred
unmapping of GEM objects.

	Signed-off-by: Ben Skeggs <bskeggs@redhat.com>
(cherry picked from commit 0db912af8f5ad4fa4dc08a9c8e411a10953c5403)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/gpu/drm/nouveau/nouveau_gem.c
#	drivers/gpu/drm/nouveau/nouveau_vmm.c
#	drivers/gpu/drm/nouveau/nouveau_vmm.h
diff --cc drivers/gpu/drm/nouveau/nouveau_gem.c
index 2170534101ca,2016d9eb338e..000000000000
--- a/drivers/gpu/drm/nouveau/nouveau_gem.c
+++ b/drivers/gpu/drm/nouveau/nouveau_gem.c
@@@ -104,13 -91,16 +104,18 @@@ out
  	return ret;
  }
  
 -struct nouveau_gem_object_unmap {
 -	struct nouveau_cli_work work;
 -	struct nouveau_vma *vma;
 -};
 -
  static void
 -nouveau_gem_object_delete(struct nouveau_vma *vma)
 +nouveau_gem_object_delete(void *data)
  {
++<<<<<<< HEAD
 +	struct nvkm_vma *vma = data;
 +	nvkm_vm_unmap(vma);
 +	nvkm_vm_put(vma);
 +	kfree(vma);
++=======
+ 	nouveau_fence_unref(&vma->fence);
+ 	nouveau_vma_del(&vma);
++>>>>>>> 0db912af8f5a (drm/nouveau/gem: attach fences to VMAs to track GPU usage)
  }
  
  static void
* Unmerged path drivers/gpu/drm/nouveau/nouveau_vmm.c
* Unmerged path drivers/gpu/drm/nouveau/nouveau_vmm.h
* Unmerged path drivers/gpu/drm/nouveau/nouveau_gem.c
* Unmerged path drivers/gpu/drm/nouveau/nouveau_vmm.c
* Unmerged path drivers/gpu/drm/nouveau/nouveau_vmm.h
