ipmi_si: Add device attrs for the things in proc

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
commit-author Corey Minyard <cminyard@mvista.com>
commit 3dd377b5b07707c1a37e9129b36eaa1a86ccf9cf
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/3dd377b5.failed

Create a device attribute for everything we show in proc, getting
ready for removing the proc stuff.

	Signed-off-by: Corey Minyard <cminyard@mvista.com>
(cherry picked from commit 3dd377b5b07707c1a37e9129b36eaa1a86ccf9cf)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/char/ipmi/ipmi_si_intf.c
diff --cc drivers/char/ipmi/ipmi_si_intf.c
index 72982bfaeaf1,6ce5b7c8cf93..000000000000
--- a/drivers/char/ipmi/ipmi_si_intf.c
+++ b/drivers/char/ipmi/ipmi_si_intf.c
@@@ -3611,27 -2169,28 +3697,36 @@@ static int try_smi_init(struct smi_inf
  				rv);
  			goto out_err;
  		}
 +		new_smi->dev_registered = 1;
  	}
  
+ 	dev_set_drvdata(new_smi->io.dev, new_smi);
+ 	rv = device_add_group(new_smi->io.dev, &ipmi_si_dev_attr_group);
+ 	if (rv) {
+ 		dev_err(new_smi->io.dev,
+ 			"Unable to add device attributes: error %d\n",
+ 			rv);
+ 		goto out_err_stop_timer;
+ 	}
+ 
  	rv = ipmi_register_smi(&handlers,
  			       new_smi,
 -			       new_smi->io.dev,
 -			       new_smi->io.slave_addr);
 +			       &new_smi->device_id,
 +			       new_smi->dev,
 +			       "bmc",
 +			       new_smi->slave_addr);
  	if (rv) {
 -		dev_err(new_smi->io.dev,
 -			"Unable to register device: error %d\n",
 +		dev_err(new_smi->dev, "Unable to register device: error %d\n",
  			rv);
- 		goto out_err_stop_timer;
+ 		goto out_err_remove_attrs;
  	}
  
 +	/* RHEL7-only - Init ipmi_shadow_smi_handlers
 +	 */
 +	shadow_handlers = ipmi_get_shadow_smi_handlers();
 +	shadow_handlers->set_need_watch = set_need_watch;
 +	shadow_handlers->flush_messages = flush_messages;
 +
  	rv = ipmi_smi_add_proc_entry(new_smi->intf, "type",
  				     &smi_type_proc_ops,
  				     new_smi);
@@@ -3860,8 -2373,8 +3959,13 @@@ static void cleanup_one_si(struct smi_i
  		}
  	}
  
++<<<<<<< HEAD
 +	if (to_clean->dev)
 +		dev_set_drvdata(to_clean->dev, NULL);
++=======
+ 	device_remove_group(to_clean->io.dev, &ipmi_si_dev_attr_group);
+ 	dev_set_drvdata(to_clean->io.dev, NULL);
++>>>>>>> 3dd377b5b077 (ipmi_si: Add device attrs for the things in proc)
  
  	list_del(&to_clean->link);
  
* Unmerged path drivers/char/ipmi/ipmi_si_intf.c
