ceph: voluntarily drop Lx cap for link/rename requests

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
commit-author Yan, Zheng <zyan@redhat.com>
commit d19a0b540182a742338d88f6501e4f29a30d7541
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/d19a0b54.failed

MDS need to xlock inode's linklock when handling link/rename requests.
Voluntarily dropping CEPH_CAP_AUTH_EXCL avoids a cap revoke message.

	Signed-off-by: "Yan, Zheng" <zyan@redhat.com>
	Signed-off-by: Ilya Dryomov <idryomov@gmail.com>
(cherry picked from commit d19a0b540182a742338d88f6501e4f29a30d7541)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/ceph/dir.c
diff --cc fs/ceph/dir.c
index 12a52251d6f7,aa2618f12cb7..000000000000
--- a/fs/ceph/dir.c
+++ b/fs/ceph/dir.c
@@@ -1118,9 -1096,9 +1118,15 @@@ static int ceph_rename(struct inode *ol
  	req->r_dentry_drop = CEPH_CAP_FILE_SHARED;
  	req->r_dentry_unless = CEPH_CAP_FILE_EXCL;
  	/* release LINK_RDCACHE on source inode (mds will lock it) */
++<<<<<<< HEAD
 +	req->r_old_inode_drop = CEPH_CAP_LINK_SHARED;
 +	if (new_dentry->d_inode)
 +		req->r_inode_drop = drop_caps_for_unlink(new_dentry->d_inode);
++=======
+ 	req->r_old_inode_drop = CEPH_CAP_LINK_SHARED | CEPH_CAP_LINK_EXCL;
+ 	if (d_really_is_positive(new_dentry))
+ 		req->r_inode_drop = drop_caps_for_unlink(d_inode(new_dentry));
++>>>>>>> d19a0b540182 (ceph: voluntarily drop Lx cap for link/rename requests)
  	err = ceph_mdsc_do_request(mdsc, old_dir, req);
  	if (!err && !req->r_reply_info.head->is_dentry) {
  		/*
* Unmerged path fs/ceph/dir.c
