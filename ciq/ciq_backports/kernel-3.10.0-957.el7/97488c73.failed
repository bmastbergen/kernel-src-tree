tcmu: Add a missing unlock on an error path

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
commit-author Dan Carpenter <dan.carpenter@oracle.com>
commit 97488c73190bb785cba818bf31e7361a27aded41
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/97488c73.failed

We added a new error path here but we forgot to drop the lock first
before returning.

Fixes: 0d44374c1aae ("tcmu: fix double se_cmd completion")
	Signed-off-by: Dan Carpenter <dan.carpenter@oracle.com>
	Signed-off-by: Nicholas Bellinger <nab@linux-iscsi.org>
(cherry picked from commit 97488c73190bb785cba818bf31e7361a27aded41)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/target/target_core_user.c
diff --cc drivers/target/target_core_user.c
index 3a9402c59df4,bf4fd40dde2b..000000000000
--- a/drivers/target/target_core_user.c
+++ b/drivers/target/target_core_user.c
@@@ -713,11 -869,30 +713,22 @@@ tcmu_queue_cmd_ring(struct tcmu_cmd *tc
  
  	/* Handle BIDI commands */
  	iov_cnt = 0;
 -	if (se_cmd->se_cmd_flags & SCF_BIDI) {
 -		iov++;
 -		ret = scatter_data_area(udev, tcmu_cmd,
 -					se_cmd->t_bidi_data_sg,
 -					se_cmd->t_bidi_data_nents,
 -					&iov, &iov_cnt, false);
 -		if (ret) {
 -			tcmu_cmd_free_data(tcmu_cmd, tcmu_cmd->dbi_cnt);
 -			mutex_unlock(&udev->cmdr_lock);
 -
 -			pr_err("tcmu: alloc and scatter bidi data failed\n");
 -			return TCM_LOGICAL_UNIT_COMMUNICATION_FAILURE;
 -		}
 -	}
 +	alloc_and_scatter_data_area(udev, tcmu_cmd->data_bitmap,
 +		se_cmd->t_bidi_data_sg, se_cmd->t_bidi_data_nents, &iov,
 +		&iov_cnt, false);
  	entry->req.iov_bidi_cnt = iov_cnt;
  
++<<<<<<< HEAD
++=======
+ 	ret = tcmu_setup_cmd_timer(tcmu_cmd);
+ 	if (ret) {
+ 		tcmu_cmd_free_data(tcmu_cmd, tcmu_cmd->dbi_cnt);
+ 		mutex_unlock(&udev->cmdr_lock);
+ 		return TCM_OUT_OF_RESOURCES;
+ 	}
+ 	entry->hdr.cmd_id = tcmu_cmd->cmd_id;
+ 
++>>>>>>> 97488c73190b (tcmu: Add a missing unlock on an error path)
  	/*
  	 * Recalaulate the command's base size and size according
  	 * to the actual needs
* Unmerged path drivers/target/target_core_user.c
