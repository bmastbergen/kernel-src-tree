perf/x86/intel: Plug memory leak in intel_pmu_init()

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
commit-author Thomas Gleixner <tglx@linutronix.de>
commit 7ad1437d6ace0e450a6c1167720608ad660b191d
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/7ad1437d.failed

A recent commit introduced an extra merge_attr() call in the skylake
branch, which causes a memory leak.

Store the pointer to the extra allocated memory and free it at the end of
the function.

Fixes: a5df70c354c2 ("perf/x86: Only show format attributes when supported")
	Reported-by: Tommi Rantala <tommi.t.rantala@nokia.com>
	Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
	Cc: Andi Kleen <ak@linux.intel.com>
(cherry picked from commit 7ad1437d6ace0e450a6c1167720608ad660b191d)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/events/intel/core.c
diff --cc arch/x86/events/intel/core.c
index 5aafb5e77243,731153a4681e..000000000000
--- a/arch/x86/events/intel/core.c
+++ b/arch/x86/events/intel/core.c
@@@ -3710,6 -3856,7 +3712,10 @@@ __init int intel_pmu_init(void
  	unsigned int unused;
  	struct extra_reg *er;
  	int version, i;
++<<<<<<< HEAD
++=======
+ 	char *name;
++>>>>>>> 7ad1437d6ace (perf/x86/intel: Plug memory leak in intel_pmu_init())
  
  	if (!cpu_has(&boot_cpu_data, X86_FEATURE_ARCH_PERFMON)) {
  		switch (boot_cpu_data.x86) {
@@@ -4112,10 -4292,11 +4118,18 @@@
  
  		x86_pmu.hw_config = hsw_hw_config;
  		x86_pmu.get_event_constraints = hsw_get_event_constraints;
++<<<<<<< HEAD
 +		x86_pmu.format_attrs = merge_attr(intel_arch3_formats_attr,
 +						  skl_format_attr);
 +		WARN_ON(!x86_pmu.format_attrs);
 +		x86_pmu.cpu_events = hsw_events_attrs;
++=======
+ 		extra_attr = boot_cpu_has(X86_FEATURE_RTM) ?
+ 			hsw_format_attr : nhm_format_attr;
+ 		extra_attr = merge_attr(extra_attr, skl_format_attr);
+ 		to_free = extra_attr;
+ 		x86_pmu.cpu_events = get_hsw_events_attrs();
++>>>>>>> 7ad1437d6ace (perf/x86/intel: Plug memory leak in intel_pmu_init())
  		intel_pmu_pebs_data_source_skl(
  			boot_cpu_data.x86_model == INTEL_FAM6_SKYLAKE_X);
  		pr_cont("Skylake events, ");
* Unmerged path arch/x86/events/intel/core.c
