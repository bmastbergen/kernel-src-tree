net: sched: store net pointer in block and introduce qdisc_net helper

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
Rebuild_CHGLOG: - [net] sched: store net pointer in block and introduce qdisc_net helper (Ivan Vecera) [1572720]
Rebuild_FUZZ: 96.24%
commit-author Jiri Pirko <jiri@mellanox.com>
commit 855319becbcffec6988a4e781a861b69a71c5b58
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/855319be.failed

Store net pointer in the block structure. Along the way, introduce
qdisc_net helper which allows to easily obtain net pointer for
qdisc instance.

	Signed-off-by: Jiri Pirko <jiri@mellanox.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 855319becbcffec6988a4e781a861b69a71c5b58)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	include/net/sch_generic.h
#	net/sched/cls_api.c
diff --cc include/net/sch_generic.h
index 00754093559f,9b2cb91dc0d9..000000000000
--- a/include/net/sch_generic.h
+++ b/include/net/sch_generic.h
@@@ -286,6 -270,8 +286,11 @@@ struct tcf_chain 
  
  struct tcf_block {
  	struct list_head chain_list;
++<<<<<<< HEAD
++=======
+ 	struct net *net;
+ 	struct Qdisc *q;
++>>>>>>> 855319becbcf (net: sched: store net pointer in block and introduce qdisc_net helper)
  };
  
  static inline void qdisc_cb_private_validate(const struct sk_buff *skb, int sz)
diff --cc net/sched/cls_api.c
index 3b8cc4dc4e82,856003caa3bb..000000000000
--- a/net/sched/cls_api.c
+++ b/net/sched/cls_api.c
@@@ -271,6 -257,8 +271,11 @@@ int tcf_block_get(struct tcf_block **p_
  		goto err_chain_create;
  	}
  	tcf_chain_filter_chain_ptr_set(chain, p_filter_chain);
++<<<<<<< HEAD
++=======
+ 	block->net = qdisc_net(q);
+ 	block->q = q;
++>>>>>>> 855319becbcf (net: sched: store net pointer in block and introduce qdisc_net helper)
  	*p_block = block;
  	return 0;
  
diff --git a/include/net/pkt_sched.h b/include/net/pkt_sched.h
index 259bc191ba59..2d234af15f3e 100644
--- a/include/net/pkt_sched.h
+++ b/include/net/pkt_sched.h
@@ -4,7 +4,9 @@
 #include <linux/jiffies.h>
 #include <linux/ktime.h>
 #include <linux/if_vlan.h>
+#include <linux/netdevice.h>
 #include <net/sch_generic.h>
+#include <net/net_namespace.h>
 #include <uapi/linux/pkt_sched.h>
 
 #define DEFAULT_TX_QUEUE_LEN	1000
@@ -146,4 +148,9 @@ static inline bool is_classid_clsact_egress(u32 classid)
 	       TC_H_MIN(classid) == TC_H_MIN(TC_H_MIN_EGRESS);
 }
 
+static inline struct net *qdisc_net(struct Qdisc *q)
+{
+	return dev_net(q->dev_queue->dev);
+}
+
 #endif
* Unmerged path include/net/sch_generic.h
* Unmerged path net/sched/cls_api.c
