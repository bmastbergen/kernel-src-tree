drm/nouveau/gr/gf100-: insert some WFIs during gr init

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
commit-author Ben Skeggs <bskeggs@redhat.com>
commit 6c46d01f25bcf74608d09645c27c35c3f3940ebe
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/6c46d01f.failed

Inserted wait-for-gr-idle in the places it seems that RM does it, seems
to prevent some random mmio timeouts on Quadro GV100.

	Signed-off-by: Ben Skeggs <bskeggs@redhat.com>
(cherry picked from commit 6c46d01f25bcf74608d09645c27c35c3f3940ebe)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/gpu/drm/nouveau/nvkm/engine/gr/ctxgf100.c
#	drivers/gpu/drm/nouveau/nvkm/engine/gr/gf100.c
diff --cc drivers/gpu/drm/nouveau/nvkm/engine/gr/ctxgf100.c
index 25207b19a53d,e813a3f8ea93..000000000000
--- a/drivers/gpu/drm/nouveau/nvkm/engine/gr/ctxgf100.c
+++ b/drivers/gpu/drm/nouveau/nvkm/engine/gr/ctxgf100.c
@@@ -1420,6 -1398,9 +1422,12 @@@ gf100_grctx_generate_main(struct gf100_
  
  	gf100_grctx_generate_floorsweep(gr);
  
++<<<<<<< HEAD
++=======
+ 	gf100_gr_wait_idle(gr);
+ 
+ 	if (grctx->r400088) grctx->r400088(gr, false);
++>>>>>>> 6c46d01f25bc (drm/nouveau/gr/gf100-: insert some WFIs during gr init)
  	if (gr->fuc_bundle)
  		gf100_gr_icmd(gr, gr->fuc_bundle);
  	else
diff --cc drivers/gpu/drm/nouveau/nvkm/engine/gr/gf100.c
index 6ca9a01b8988,70d3d41e616c..000000000000
--- a/drivers/gpu/drm/nouveau/nvkm/engine/gr/gf100.c
+++ b/drivers/gpu/drm/nouveau/nvkm/engine/gr/gf100.c
@@@ -1960,12 -2097,52 +1960,35 @@@ gf100_gr_init(struct gf100_gr *gr
  		nvkm_wr32(device, GPC_UNIT(gpc, 0x0918), magicgpc918);
  	}
  
 -	nvkm_wr32(device, GPC_BCAST(0x1bd4), magicgpc918);
 -}
 -
 -void
 -gf100_gr_init_vsc_stream_master(struct gf100_gr *gr)
 -{
 -	struct nvkm_device *device = gr->base.engine.subdev.device;
 -	nvkm_mask(device, TPC_UNIT(0, 0, 0x05c), 0x00000001, 0x00000001);
 -}
 -
 -int
 -gf100_gr_init(struct gf100_gr *gr)
 -{
 -	struct nvkm_device *device = gr->base.engine.subdev.device;
 -	int gpc, tpc, rop;
 -
 -	if (gr->func->init_419bd8)
 -		gr->func->init_419bd8(gr);
 -
 -	gr->func->init_gpc_mmu(gr);
 -
 -	if (gr->fuc_sw_nonctx)
 -		gf100_gr_mmio(gr, gr->fuc_sw_nonctx);
 +	if (device->chipset != 0xd7)
 +		nvkm_wr32(device, GPC_BCAST(0x1bd4), magicgpc918);
  	else
 -		gf100_gr_mmio(gr, gr->func->mmio);
 +		nvkm_wr32(device, GPC_BCAST(0x3fd4), magicgpc918);
  
++<<<<<<< HEAD
 +	nvkm_wr32(device, GPC_BCAST(0x08ac), nvkm_rd32(device, 0x100800));
++=======
+ 	gf100_gr_wait_idle(gr);
+ 
+ 	if (gr->func->init_r405a14)
+ 		gr->func->init_r405a14(gr);
+ 
+ 	if (gr->func->clkgate_pack)
+ 		nvkm_therm_clkgate_init(device->therm, gr->func->clkgate_pack);
+ 
+ 	if (gr->func->init_bios)
+ 		gr->func->init_bios(gr);
+ 
+ 	gr->func->init_vsc_stream_master(gr);
+ 	gr->func->init_zcull(gr);
+ 	gr->func->init_num_active_ltcs(gr);
+ 	if (gr->func->init_rop_active_fbps)
+ 		gr->func->init_rop_active_fbps(gr);
+ 	if (gr->func->init_bios_2)
+ 		gr->func->init_bios_2(gr);
+ 	if (gr->func->init_swdx_pes_mask)
+ 		gr->func->init_swdx_pes_mask(gr);
++>>>>>>> 6c46d01f25bc (drm/nouveau/gr/gf100-: insert some WFIs during gr init)
  
  	nvkm_wr32(device, 0x400500, 0x00010001);
  
* Unmerged path drivers/gpu/drm/nouveau/nvkm/engine/gr/ctxgf100.c
* Unmerged path drivers/gpu/drm/nouveau/nvkm/engine/gr/gf100.c
