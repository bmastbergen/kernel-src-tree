drm/amdgpu: GPU vs CPU page size fixes in amdgpu_vm_bo_split_mapping

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
commit-author Michel Dänzer <michel.daenzer@amd.com>
commit 38e624a18f9a05b8c894409be6b14709a7206c7c
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/38e624a1.failed

start / last / max_entries are numbers of GPU pages, pfn / count are
numbers of CPU pages. Convert between them accordingly.

Fixes badness on systems with > 4K page size.

	Cc: stable@vger.kernel.org
Bugzilla: https://bugs.freedesktop.org/106258
	Reported-by: Matt Corallo <freedesktop@bluematt.me>
	Tested-by: foxbat@ruin.net
	Reviewed-by: Alex Deucher <alexander.deucher@amd.com>
	Reviewed-by: Christian König <christian.koenig@amd.com>
	Signed-off-by: Michel Dänzer <michel.daenzer@amd.com>
	Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
(cherry picked from commit 38e624a18f9a05b8c894409be6b14709a7206c7c)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/gpu/drm/amd/amdgpu/amdgpu_vm.c
diff --cc drivers/gpu/drm/amd/amdgpu/amdgpu_vm.c
index 77cd633dafce,edf16b2b957a..000000000000
--- a/drivers/gpu/drm/amd/amdgpu/amdgpu_vm.c
+++ b/drivers/gpu/drm/amd/amdgpu/amdgpu_vm.c
@@@ -1683,16 -1460,34 +1683,37 @@@ static int amdgpu_vm_bo_split_mapping(s
  		}
  
  		if (pages_addr) {
 -			uint64_t count;
 -
  			max_entries = min(max_entries, 16ull * 1024ull);
++<<<<<<< HEAD
 +			addr = 0;
++=======
+ 			for (count = 1;
+ 			     count < max_entries / (PAGE_SIZE / AMDGPU_GPU_PAGE_SIZE);
+ 			     ++count) {
+ 				uint64_t idx = pfn + count;
+ 
+ 				if (pages_addr[idx] !=
+ 				    (pages_addr[idx - 1] + PAGE_SIZE))
+ 					break;
+ 			}
+ 
+ 			if (count < min_linear_pages) {
+ 				addr = pfn << PAGE_SHIFT;
+ 				dma_addr = pages_addr;
+ 			} else {
+ 				addr = pages_addr[pfn];
+ 				max_entries = count * (PAGE_SIZE / AMDGPU_GPU_PAGE_SIZE);
+ 			}
+ 
++>>>>>>> 38e624a18f9a (drm/amdgpu: GPU vs CPU page size fixes in amdgpu_vm_bo_split_mapping)
  		} else if (flags & AMDGPU_PTE_VALID) {
  			addr += adev->vm_manager.vram_base_offset;
 -			addr += pfn << PAGE_SHIFT;
  		}
 +		addr += pfn << PAGE_SHIFT;
  
  		last = min((uint64_t)mapping->last, start + max_entries - 1);
 -		r = amdgpu_vm_bo_update_mapping(adev, exclusive, dma_addr, vm,
 +		r = amdgpu_vm_bo_update_mapping(adev, exclusive,
 +						src, pages_addr, vm,
  						start, last, flags, addr,
  						fence);
  		if (r)
* Unmerged path drivers/gpu/drm/amd/amdgpu/amdgpu_vm.c
