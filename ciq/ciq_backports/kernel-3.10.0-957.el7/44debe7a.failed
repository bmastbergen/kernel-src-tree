vgacon: dummy implementation for vgacon_text_force

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
commit-author Daniel Vetter <daniel.vetter@ffwll.ch>
commit 44debe7a123cc760fc90ccbe253210798c917fa7
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/44debe7a.failed

This allows us to ditch a ton of ugly #ifdefs from a bunch of drm modeset
drivers.

v2: Make the dummy function actually return a sane value, spotted by
Ville.

v3: Because the patch is still in limbo there's no more drivers to
convert, noticed by Emil.

v4: Rebase once more, because hooray. I'll just go ahead an apply this
one later on to drm-misc.

	Cc: Emil Velikov <emil.l.velikov@gmail.com>
	Cc: Ville Syrjälä <ville.syrjala@linux.intel.com>
	Cc: Andrew Morton <akpm@linux-foundation.org>
	Cc: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
	Reviewed-by: Emil Velikov <emil.l.velikov@gmail.com>
	Reviewed-by: Alex Deucher <alexander.deucher@amd.com>
	Signed-off-by: Daniel Vetter <daniel.vetter@ffwll.ch>
(cherry picked from commit 44debe7a123cc760fc90ccbe253210798c917fa7)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/gpu/drm/amd/amdgpu/amdgpu_drv.c
#	drivers/gpu/drm/i915/i915_drv.c
diff --cc drivers/gpu/drm/amd/amdgpu/amdgpu_drv.c
index 0f16986ec5bc,fba20bd59cfa..000000000000
--- a/drivers/gpu/drm/amd/amdgpu/amdgpu_drv.c
+++ b/drivers/gpu/drm/amd/amdgpu/amdgpu_drv.c
@@@ -873,24 -537,8 +873,27 @@@ static struct pci_driver amdgpu_kms_pci
  	.driver.pm = &amdgpu_pm_ops,
  };
  
 +
 +
  static int __init amdgpu_init(void)
  {
++<<<<<<< HEAD
 +	int r;
 +
 +	r = amdgpu_sync_init();
 +	if (r)
 +		goto error_sync;
 +
 +	r = amdgpu_fence_slab_init();
 +	if (r)
 +		goto error_fence;
 +
 +	r = amd_sched_fence_slab_init();
 +	if (r)
 +		goto error_sched;
 +
++=======
++>>>>>>> 44debe7a123c (vgacon: dummy implementation for vgacon_text_force)
  	if (vgacon_text_force()) {
  		DRM_ERROR("VGACON disables amdgpu kernel modesetting.\n");
  		return -EINVAL;
diff --cc drivers/gpu/drm/i915/i915_drv.c
index e4132b8a7224,8a62690e6513..000000000000
--- a/drivers/gpu/drm/i915/i915_drv.c
+++ b/drivers/gpu/drm/i915/i915_drv.c
@@@ -2779,6 -1729,55 +2779,61 @@@ static struct drm_driver driver = 
  	.patchlevel = DRIVER_PATCHLEVEL,
  };
  
++<<<<<<< HEAD
 +#if IS_ENABLED(CONFIG_DRM_I915_SELFTEST)
 +#include "selftests/mock_drm.c"
 +#endif
++=======
+ static struct pci_driver i915_pci_driver = {
+ 	.name = DRIVER_NAME,
+ 	.id_table = pciidlist,
+ 	.probe = i915_pci_probe,
+ 	.remove = i915_pci_remove,
+ 	.driver.pm = &i915_pm_ops,
+ };
+ 
+ static int __init i915_init(void)
+ {
+ 	driver.num_ioctls = i915_max_ioctl;
+ 
+ 	/*
+ 	 * Enable KMS by default, unless explicitly overriden by
+ 	 * either the i915.modeset prarameter or by the
+ 	 * vga_text_mode_force boot option.
+ 	 */
+ 
+ 	if (i915.modeset == 0)
+ 		driver.driver_features &= ~DRIVER_MODESET;
+ 
+ 	if (vgacon_text_force() && i915.modeset == -1)
+ 		driver.driver_features &= ~DRIVER_MODESET;
+ 
+ 	if (!(driver.driver_features & DRIVER_MODESET)) {
+ 		/* Silently fail loading to not upset userspace. */
+ 		DRM_DEBUG_DRIVER("KMS and UMS disabled.\n");
+ 		return 0;
+ 	}
+ 
+ 	if (i915.nuclear_pageflip)
+ 		driver.driver_features |= DRIVER_ATOMIC;
+ 
+ 	return drm_pci_init(&driver, &i915_pci_driver);
+ }
+ 
+ static void __exit i915_exit(void)
+ {
+ 	if (!(driver.driver_features & DRIVER_MODESET))
+ 		return; /* Never loaded a driver. */
+ 
+ 	drm_pci_exit(&driver, &i915_pci_driver);
+ }
+ 
+ module_init(i915_init);
+ module_exit(i915_exit);
+ 
+ MODULE_AUTHOR("Tungsten Graphics, Inc.");
+ MODULE_AUTHOR("Intel Corporation");
+ 
+ MODULE_DESCRIPTION(DRIVER_DESC);
+ MODULE_LICENSE("GPL and additional rights");
++>>>>>>> 44debe7a123c (vgacon: dummy implementation for vgacon_text_force)
* Unmerged path drivers/gpu/drm/amd/amdgpu/amdgpu_drv.c
* Unmerged path drivers/gpu/drm/i915/i915_drv.c
diff --git a/include/linux/console.h b/include/linux/console.h
index 5332f88f043b..ef4f24372f11 100644
--- a/include/linux/console.h
+++ b/include/linux/console.h
@@ -206,6 +206,8 @@ void vcs_remove_sysfs(int index);
 
 #ifdef CONFIG_VGA_CONSOLE
 extern bool vgacon_text_force(void);
+#else
+static inline bool vgacon_text_force(void) { return false; }
 #endif
 
 #endif /* _LINUX_CONSOLE_H */
