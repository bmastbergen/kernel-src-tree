perf events parse: Use just one parse events state struct

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
commit-author Arnaldo Carvalho de Melo <acme@redhat.com>
commit d17d0878f456c8227345b6c76b918ec068fa0abd
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/d17d0878.failed

Andi reported problems when parse errors were detected with vendor
events (json), because in the yyparse/parse_events_parse function we
dereferenced the _data parameter to two different structs, with
different layouts, which ended up making parse_events_evlist->error to
point to random stack addresses.

Fix it by making _data to always be struct parse_events_state, changing
the only place where 'struct parse_events_term' was used in
parse_events.y.

	Reported-by: Andi Kleen <ak@linux.intel.com>
	Cc: Adrian Hunter <adrian.hunter@intel.com>
	Cc: David Ahern <dsahern@gmail.com>
	Cc: Jiri Olsa <jolsa@kernel.org>
	Cc: Namhyung Kim <namhyung@kernel.org>
	Cc: Wang Nan <wangnan0@huawei.com>
Link: http://lkml.kernel.org/n/tip-bc27lshz823hxl8n9nkelcgh@git.kernel.org
Fixes: 90e2b22dee90 ("perf/tool: Add support to reuse event grammar to parse out terms")
	Signed-off-by: Arnaldo Carvalho de Melo <acme@redhat.com>
(cherry picked from commit d17d0878f456c8227345b6c76b918ec068fa0abd)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/perf/util/parse-events.h
diff --cc tools/perf/util/parse-events.h
index 43b505fd3102,2a3617937894..000000000000
--- a/tools/perf/util/parse-events.h
+++ b/tools/perf/util/parse-events.h
@@@ -103,10 -113,8 +103,15 @@@ struct parse_events_evlist 
  	int			   idx;
  	int			   nr_groups;
  	struct parse_events_error *error;
++<<<<<<< HEAD
 +};
 +
 +struct parse_events_terms {
 +	struct list_head *terms;
++=======
+ 	struct perf_evlist	  *evlist;
+ 	struct list_head	  *terms;
++>>>>>>> d17d0878f456 (perf events parse: Use just one parse events state struct)
  };
  
  void parse_events__shrink_config_terms(void);
diff --git a/tools/perf/util/parse-events.c b/tools/perf/util/parse-events.c
index eb476984ddca..2483f9c8c992 100644
--- a/tools/perf/util/parse-events.c
+++ b/tools/perf/util/parse-events.c
@@ -1422,7 +1422,7 @@ static int parse_events__scanner(const char *str, void *data, int start_token)
  */
 int parse_events_terms(struct list_head *terms, const char *str)
 {
-	struct parse_events_terms data = {
+	struct parse_events_state data = {
 		.terms = NULL,
 	};
 	int ret;
* Unmerged path tools/perf/util/parse-events.h
diff --git a/tools/perf/util/parse-events.y b/tools/perf/util/parse-events.y
index 945e22e508d8..34dbf2a3758c 100644
--- a/tools/perf/util/parse-events.y
+++ b/tools/perf/util/parse-events.y
@@ -460,7 +460,7 @@ opt_event_config:
 
 start_terms: event_config
 {
-	struct parse_events_terms *data = _data;
+	struct parse_events_state *data = _data;
 	data->terms = $1;
 }
 
