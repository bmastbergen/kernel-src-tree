drm/nouveau/gr/gf100-: virtualise init_rop_active_fbps

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
commit-author Ben Skeggs <bskeggs@redhat.com>
commit 429412e231a27d48cb492dc1c647e857677240b3
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/429412e2.failed

	Signed-off-by: Ben Skeggs <bskeggs@redhat.com>
(cherry picked from commit 429412e231a27d48cb492dc1c647e857677240b3)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/gpu/drm/nouveau/nvkm/engine/gr/gf100.c
diff --cc drivers/gpu/drm/nouveau/nvkm/engine/gr/gf100.c
index 5d64fed84507,6912eaa5a90a..000000000000
--- a/drivers/gpu/drm/nouveau/nvkm/engine/gr/gf100.c
+++ b/drivers/gpu/drm/nouveau/nvkm/engine/gr/gf100.c
@@@ -1945,20 -1962,43 +1945,37 @@@ gf100_gr_init(struct gf100_gr *gr
  	nvkm_wr32(device, GPC_BCAST(0x0988), data[2]);
  	nvkm_wr32(device, GPC_BCAST(0x098c), data[3]);
  
 -	nvkm_wr32(device, GPC_BCAST(0x1bd4), magicgpc918);
 -}
 -
 -void
 -gf100_gr_init_vsc_stream_master(struct gf100_gr *gr)
 -{
 -	struct nvkm_device *device = gr->base.engine.subdev.device;
 -	nvkm_mask(device, TPC_UNIT(0, 0, 0x05c), 0x00000001, 0x00000001);
 -}
 -
 -int
 -gf100_gr_init(struct gf100_gr *gr)
 -{
 -	struct nvkm_device *device = gr->base.engine.subdev.device;
 -	int gpc, tpc, rop;
 -
 -	gr->func->init_gpc_mmu(gr);
 +	for (gpc = 0; gpc < gr->gpc_nr; gpc++) {
 +		nvkm_wr32(device, GPC_UNIT(gpc, 0x0914),
 +			  gr->screen_tile_row_offset << 8 | gr->tpc_nr[gpc]);
 +		nvkm_wr32(device, GPC_UNIT(gpc, 0x0910), 0x00040000 |
 +							 gr->tpc_total);
 +		nvkm_wr32(device, GPC_UNIT(gpc, 0x0918), magicgpc918);
 +	}
  
 -	if (gr->fuc_sw_nonctx)
 -		gf100_gr_mmio(gr, gr->fuc_sw_nonctx);
 +	if (device->chipset != 0xd7)
 +		nvkm_wr32(device, GPC_BCAST(0x1bd4), magicgpc918);
  	else
 -		gf100_gr_mmio(gr, gr->func->mmio);
 +		nvkm_wr32(device, GPC_BCAST(0x3fd4), magicgpc918);
  
++<<<<<<< HEAD
 +	nvkm_wr32(device, GPC_BCAST(0x08ac), nvkm_rd32(device, 0x100800));
++=======
+ 	if (gr->func->init_r405a14)
+ 		gr->func->init_r405a14(gr);
+ 
+ 	if (gr->func->clkgate_pack)
+ 		nvkm_therm_clkgate_init(device->therm, gr->func->clkgate_pack);
+ 
+ 	if (gr->func->init_bios)
+ 		gr->func->init_bios(gr);
+ 
+ 	gr->func->init_vsc_stream_master(gr);
+ 	gr->func->init_zcull(gr);
+ 	gr->func->init_num_active_ltcs(gr);
+ 	if (gr->func->init_rop_active_fbps)
+ 		gr->func->init_rop_active_fbps(gr);
++>>>>>>> 429412e231a2 (drm/nouveau/gr/gf100-: virtualise init_rop_active_fbps)
  
  	nvkm_wr32(device, 0x400500, 0x00010001);
  
* Unmerged path drivers/gpu/drm/nouveau/nvkm/engine/gr/gf100.c
