scsi: qla2xxx: Remove FC_NO_LOOP_ID for FCP and FC-NVMe Discovery

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
Rebuild_CHGLOG: - [scsi] qla2xxx: Remove FC_NO_LOOP_ID for FCP and FC-NVMe Discovery (Himanshu Madhani) [1547714]
Rebuild_FUZZ: 95.16%
commit-author Himanshu Madhani <himanshu.madhani@cavium.com>
commit 14bc1dff74277408f08661d03e785710a46e0699
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/14bc1dff.failed

Commit 7d64c39e64310 fixed regression of FCP discovery when Nport Handle
is in-use and relogin is triggered. However, during FCP and FC-NVMe
discovery this resulted into only discovering NVMe LUNs.

This patch fixes issue where FCP and FC-NVMe protocol is used on same
port where assigning FC_NO_LOOP_ID will result into discovery failure
for FCP LUNs.

Fixes: a084fd68e1d26 ("scsi: qla2xxx: Fix re-login for Nport Handle in use")
	Signed-off-by: Himanshu Madhani <himanshu.madhani@cavium.com>
	Reviewed-by: Hannes Reinecke <hare@suse.com>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit 14bc1dff74277408f08661d03e785710a46e0699)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/qla2xxx/qla_init.c
diff --cc drivers/scsi/qla2xxx/qla_init.c
index 12e11bcce844,8d7fab3cd01d..000000000000
--- a/drivers/scsi/qla2xxx/qla_init.c
+++ b/drivers/scsi/qla2xxx/qla_init.c
@@@ -1342,13 -1706,27 +1342,37 @@@ qla24xx_handle_plogi_done_event(struct 
  		 * force a relogin attempt via implicit LOGO, PLOGI, and PRLI
  		 * requests.
  		 */
++<<<<<<< HEAD
 +		ql_dbg(ql_dbg_disc, vha, 0x20ea,
 +		    "%s %d %8phC post gpdb\n",
 +		    __func__, __LINE__, ea->fcport->port_name);
 +		ea->fcport->chip_reset = vha->hw->base_qpair->chip_reset;
 +		ea->fcport->logout_on_delete = 1;
 +		ea->fcport->send_els_logo = 0;
 +		qla24xx_post_gpdb_work(vha, ea->fcport, 0);
++=======
+ 		if (ea->fcport->fc4f_nvme) {
+ 			ql_dbg(ql_dbg_disc, vha, 0x2117,
+ 				"%s %d %8phC post prli\n",
+ 				__func__, __LINE__, ea->fcport->port_name);
+ 			qla24xx_post_prli_work(vha, ea->fcport);
+ 		} else {
+ 			ql_dbg(ql_dbg_disc, vha, 0x20ea,
+ 			    "%s %d %8phC LoopID 0x%x in use with %06x. post gnl\n",
+ 			    __func__, __LINE__, ea->fcport->port_name,
+ 			    ea->fcport->loop_id, ea->fcport->d_id.b24);
+ 
+ 			set_bit(ea->fcport->loop_id, vha->hw->loop_id_map);
+ 			spin_lock_irqsave(&vha->hw->tgt.sess_lock, flags);
+ 			ea->fcport->chip_reset = vha->hw->base_qpair->chip_reset;
+ 			ea->fcport->logout_on_delete = 1;
+ 			ea->fcport->send_els_logo = 0;
+ 			ea->fcport->fw_login_state = DSC_LS_PRLI_COMP;
+ 			spin_unlock_irqrestore(&vha->hw->tgt.sess_lock, flags);
+ 
+ 			qla24xx_post_gpdb_work(vha, ea->fcport, 0);
+ 		}
++>>>>>>> 14bc1dff7427 (scsi: qla2xxx: Remove FC_NO_LOOP_ID for FCP and FC-NVMe Discovery)
  		break;
  	case MBS_COMMAND_ERROR:
  		ql_dbg(ql_dbg_disc, vha, 0x20eb, "%s %d %8phC cmd error %x\n",
* Unmerged path drivers/scsi/qla2xxx/qla_init.c
