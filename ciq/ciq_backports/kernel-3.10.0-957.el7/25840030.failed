s390/setup: enable display support for KVM guest

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
Rebuild_CHGLOG: - [s390] setup: enable display support for KVM guest (Thomas Huth) [1570090]
Rebuild_FUZZ: 94.51%
commit-author Farhan Ali <alifm@linux.vnet.ibm.com>
commit 258400304225a219a2d98f29fe957df98789a843
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/25840030.failed

The S390 architecture does not support any graphics hardware,
but with the latest support for Virtio GPU in Linux and Virtio
GPU emulation in QEMU, it's possible to enable graphics for
S390 using the Virtio GPU device.

To enable display we need to enable the Linux Virtual Terminal (VT)
layer for S390. But the VT subsystem initializes quite early
at boot so we need a dummy console driver till the Virtio GPU
driver is initialized and we can run the framebuffer console.

The framebuffer console over a Virtio GPU device can be run
in combination with the serial SCLP console (default on S390).
The SCLP console can still be accessed by management applications
(eg: via Libvirt's virsh console).

	Signed-off-by: Farhan Ali <alifm@linux.vnet.ibm.com>
	Acked-by: Christian Borntraeger <borntraeger@de.ibm.com>
	Reviewed-by: Thomas Huth <thuth@redhat.com>
Message-Id: <e23b61f4f599ba23881727a1e8880e9d60cc6a48.1519315352.git.alifm@linux.vnet.ibm.com>
	Signed-off-by: Christian Borntraeger <borntraeger@de.ibm.com>
	Acked-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
(cherry picked from commit 258400304225a219a2d98f29fe957df98789a843)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/video/console/Kconfig
diff --cc drivers/video/console/Kconfig
index 84f04d9461a9,b9c2c916247e..000000000000
--- a/drivers/video/console/Kconfig
+++ b/drivers/video/console/Kconfig
@@@ -6,9 -6,10 +6,14 @@@ menu "Console display driver support
  
  config VGA_CONSOLE
  	bool "VGA text console" if EXPERT || !X86
 -	depends on !4xx && !PPC_8xx && !SPARC && !M68K && !PARISC && !FRV && \
 +	depends on !4xx && !8xx && !SPARC && !M68K && !PARISC && !FRV && \
  		!SUPERH && !BLACKFIN && !AVR32 && !MN10300 && !CRIS && \
++<<<<<<< HEAD
 +		(!ARM || ARCH_FOOTBRIDGE || ARCH_INTEGRATOR || ARCH_NETWINDER)
++=======
+ 		(!ARM || ARCH_FOOTBRIDGE || ARCH_INTEGRATOR || ARCH_NETWINDER) && \
+ 		!ARM64 && !ARC && !MICROBLAZE && !OPENRISC && HAS_IOMEM && !S390
++>>>>>>> 258400304225 (s390/setup: enable display support for KVM guest)
  	default y
  	help
  	  Saying Y here will allow you to use Linux in text mode through a
diff --git a/arch/s390/kernel/setup.c b/arch/s390/kernel/setup.c
index d6e8e87b465f..de2dfa199d42 100644
--- a/arch/s390/kernel/setup.c
+++ b/arch/s390/kernel/setup.c
@@ -212,6 +212,8 @@ static void __init conmode_default(void)
 		SET_CONSOLE_SCLP;
 #endif
 	}
+	if (IS_ENABLED(CONFIG_VT) && IS_ENABLED(CONFIG_DUMMY_CONSOLE))
+		conswitchp = &dummy_con;
 }
 
 #ifdef CONFIG_ZFCPDUMP
diff --git a/drivers/tty/Kconfig b/drivers/tty/Kconfig
index 978db344bda0..5c463e825cf8 100644
--- a/drivers/tty/Kconfig
+++ b/drivers/tty/Kconfig
@@ -11,7 +11,7 @@ if TTY
 
 config VT
 	bool "Virtual terminal" if EXPERT
-	depends on !S390 && !UML
+	depends on !UML
 	select INPUT
 	default y
 	---help---
* Unmerged path drivers/video/console/Kconfig
