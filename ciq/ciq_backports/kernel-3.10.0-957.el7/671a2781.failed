security: add ioctl specific auditing to lsm_audit

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-957.el7
Rebuild_CHGLOG: - [security] add ioctl specific auditing to lsm_audit (Paul Moore) [1518352]
Rebuild_FUZZ: 88.89%
commit-author Jeff Vander Stoep <jeffv@google.com>
commit 671a2781ff01abf4fdc8904881fc3abd3a8279af
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-957.el7/671a2781.failed

Add information about ioctl calls to the LSM audit data. Log the
file path and command number.

	Signed-off-by: Jeff Vander Stoep <jeffv@google.com>
	Acked-by: Nick Kralevich <nnk@google.com>
[PM: subject line tweak]
	Signed-off-by: Paul Moore <pmoore@redhat.com>
(cherry picked from commit 671a2781ff01abf4fdc8904881fc3abd3a8279af)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	include/linux/lsm_audit.h
diff --cc include/linux/lsm_audit.h
index a8706e4a9bb8,ffb9c9da4f39..000000000000
--- a/include/linux/lsm_audit.h
+++ b/include/linux/lsm_audit.h
@@@ -41,14 -40,9 +41,20 @@@ struct lsm_network_audit 
  	} fam;
  };
  
++<<<<<<< HEAD
 +struct lsm_ibpkey_audit {
 +	u64	subnet_prefix;
 +	u16	pkey;
 +};
 +
 +struct lsm_ibendport_audit {
 +	char	dev_name[IB_DEVICE_NAME_MAX];
 +	u8	port;
++=======
+ struct lsm_ioctlop_audit {
+ 	struct path path;
+ 	u16 cmd;
++>>>>>>> 671a2781ff01 (security: add ioctl specific auditing to lsm_audit)
  };
  
  /* Auxiliary data to use in generating the audit record. */
@@@ -64,9 -58,7 +70,13 @@@ struct common_audit_data 
  #define LSM_AUDIT_DATA_KMOD	8
  #define LSM_AUDIT_DATA_INODE	9
  #define LSM_AUDIT_DATA_DENTRY	10
++<<<<<<< HEAD
 +#define LSM_AUDIT_DATA_FILE	11
 +#define LSM_AUDIT_DATA_IBPKEY	13
 +#define LSM_AUDIT_DATA_IBENDPORT 14
++=======
+ #define LSM_AUDIT_DATA_IOCTL_OP	11
++>>>>>>> 671a2781ff01 (security: add ioctl specific auditing to lsm_audit)
  	union 	{
  		struct path path;
  		struct dentry *dentry;
@@@ -82,9 -74,7 +92,13 @@@
  		} key_struct;
  #endif
  		char *kmod_name;
++<<<<<<< HEAD
 +		struct file *file;
 +		struct lsm_ibpkey_audit *ibpkey;
 +		struct lsm_ibendport_audit *ibendport;
++=======
+ 		struct lsm_ioctlop_audit *op;
++>>>>>>> 671a2781ff01 (security: add ioctl specific auditing to lsm_audit)
  	} u;
  	/* this union contains LSM specific data */
  	union {
* Unmerged path include/linux/lsm_audit.h
diff --git a/security/lsm_audit.c b/security/lsm_audit.c
index 240d4a832c91..c4f34fb60a6d 100644
--- a/security/lsm_audit.c
+++ b/security/lsm_audit.c
@@ -258,6 +258,21 @@ static void dump_common_audit_data(struct audit_buffer *ab,
 		}
 		break;
 	}
+	case LSM_AUDIT_DATA_IOCTL_OP: {
+		struct inode *inode;
+
+		audit_log_d_path(ab, " path=", &a->u.op->path);
+
+		inode = a->u.op->path.dentry->d_inode;
+		if (inode) {
+			audit_log_format(ab, " dev=");
+			audit_log_untrustedstring(ab, inode->i_sb->s_id);
+			audit_log_format(ab, " ino=%lu", inode->i_ino);
+		}
+
+		audit_log_format(ab, " ioctlcmd=%hx", a->u.op->cmd);
+		break;
+	}
 	case LSM_AUDIT_DATA_DENTRY: {
 		struct inode *inode;
 
