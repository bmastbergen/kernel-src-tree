fbcon: set_con2fb_map needs to set con2fb_map!

jira LE-1907
cve CVE-2023-38409
Rebuild_History Non-Buildable kernel-3.10.0-1160.118.1.el7
commit-author Daniel Vetter <daniel.vetter@ffwll.ch>
commit fffb0b52d5258554c645c966c6cbef7de50b851d
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-1160.118.1.el7/fffb0b52.failed

I got really badly confused in d443d9386472 ("fbcon: move more common
code into fb_open()") because we set the con2fb_map before the failure
points, which didn't look good.

But in trying to fix that I moved the assignment into the wrong path -
we need to do it for _all_ vc we take over, not just the first one
(which additionally requires the call to con2fb_acquire_newinfo).

I've figured this out because of a KASAN bug report, where the
fbcon_registered_fb and fbcon_display arrays went out of sync in
fbcon_mode_deleted() because the con2fb_map pointed at the old
fb_info, but the modes and everything was updated for the new one.

	Signed-off-by: Daniel Vetter <daniel.vetter@intel.com>
	Reviewed-by: Javier Martinez Canillas <javierm@redhat.com>
	Acked-by: Helge Deller <deller@gmx.de>
	Tested-by: Xingyuan Mo <hdthky0@gmail.com>
Fixes: d443d9386472 ("fbcon: move more common code into fb_open()")
	Reported-by: Xingyuan Mo <hdthky0@gmail.com>
	Cc: Thomas Zimmermann <tzimmermann@suse.de>
	Cc: Sam Ravnborg <sam@ravnborg.org>
	Cc: Xingyuan Mo <hdthky0@gmail.com>
	Cc: Thomas Zimmermann <tzimmermann@suse.de>
	Cc: Helge Deller <deller@gmx.de>
	Cc: <stable@vger.kernel.org> # v5.19+
(cherry picked from commit fffb0b52d5258554c645c966c6cbef7de50b851d)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/video/console/fbcon.c
diff --cc drivers/video/console/fbcon.c
index 61444db26a01,eb565a10e5cd..000000000000
--- a/drivers/video/console/fbcon.c
+++ b/drivers/video/console/fbcon.c
@@@ -863,14 -839,17 +863,21 @@@ static int set_con2fb_map(int unit, in
  	}
  
  	if (oldidx != -1)
 -		oldinfo = fbcon_registered_fb[oldidx];
 +		oldinfo = registered_fb[oldidx];
  
 -	if (!search_fb_in_map(newidx)) {
 -		err = con2fb_acquire_newinfo(vc, info, unit);
 -		if (err)
 -			return err;
 +	found = search_fb_in_map(newidx);
 +
 +	con2fb_map[unit] = newidx;
 +	if (!err && !found)
 + 		err = con2fb_acquire_newinfo(vc, info, unit, oldidx);
  
++<<<<<<< HEAD:drivers/video/console/fbcon.c
++=======
+ 		fbcon_add_cursor_work(info);
+ 	}
++>>>>>>> fffb0b52d525 (fbcon: set_con2fb_map needs to set con2fb_map!):drivers/video/fbdev/core/fbcon.c
+ 
+ 	con2fb_map[unit] = newidx;
  
  	/*
  	 * If old fb is not mapped to any of the consoles,
* Unmerged path drivers/video/console/fbcon.c
